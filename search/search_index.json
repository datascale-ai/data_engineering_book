{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"\u300a\u5927\u6a21\u578b\u6570\u636e\u5de5\u7a0b\uff1a\u67b6\u6784\u3001\u7b97\u6cd5\u53ca\u9879\u76ee\u5b9e\u6218\u300b","text":"<p>(Large Model Data Engineering: A Practical Guide from Pre-training to Multimodal Alignment)*</p>"},{"location":"#_2","title":"\u5168\u4e66\u76ee\u5f55\u6982\u89c8","text":"<ul> <li>\u7b2c\u4e00\u90e8\u5206\uff1a\u57fa\u7840\u8bbe\u65bd\u4e0e\u6838\u5fc3\u7406\u5ff5 (\u6784\u5efa\u6570\u636e\u5e95\u5ea7)</li> <li>\u7b2c\u4e8c\u90e8\u5206\uff1a\u6587\u672c\u9884\u8bad\u7ec3\u6570\u636e\u5de5\u7a0b (\u6e05\u6d17\u4e0e\u53bb\u566a)</li> <li>\u7b2c\u4e09\u90e8\u5206\uff1a\u591a\u6a21\u6001\u6570\u636e\u5de5\u7a0b (\u56fe\u6587\u3001\u89c6\u9891\u4e0e\u97f3\u9891)</li> <li>\u7b2c\u56db\u90e8\u5206\uff1a\u5bf9\u9f50\u4e0e\u5408\u6210\u6570\u636e\u5de5\u7a0b (\u6307\u4ee4\u4e0e\u8d28\u91cf)</li> <li>\u7b2c\u4e94\u90e8\u5206\uff1a\u5e94\u7528\u7ea7\u6570\u636e\u5de5\u7a0b (RAG\u4e0eAgent)</li> <li>\u7b2c\u516d\u90e8\u5206\uff1a\u5b9e\u6218\u9879\u76ee\u96c6 (Capstone Projects) (\u7aef\u5230\u7aef\u4ee3\u7801\u5b9e\u73b0)</li> </ul>"},{"location":"#_3","title":"\u8be6\u7ec6\u5927\u7eb2\u5185\u5bb9","text":""},{"location":"#_4","title":"\u7b2c\u4e00\u90e8\u5206\uff1a\u57fa\u7840\u8bbe\u65bd\u4e0e\u6838\u5fc3\u7406\u5ff5","text":"<p>\u76ee\u6807\uff1a \u5efa\u7acb Data-Centric AI \u7684\u8ba4\u77e5\uff0c\u5b8c\u6210\u9ad8\u6027\u80fd\u6570\u636e\u5904\u7406\u73af\u5883\u7684\u642d\u5efa\u3002</p>"},{"location":"#1","title":"\u7b2c1\u7ae0\uff1a\u5927\u6a21\u578b\u65f6\u4ee3\u7684\u6570\u636e\u53d8\u9769","text":"<ul> <li>1_1 Scaling Laws \u7684\u542f\u793a\uff1a \u6570\u636e\u8d28\u91cf &gt; \u6570\u91cf\uff0c\u4ece\u201c\u5927\u6570\u636e\u201d\u5230\u201c\u9ad8\u8d28\u91cf\u6570\u636e\u201d\u7684\u8303\u5f0f\u8f6c\u79fb\u3002</li> <li>1_2 LLM \u6570\u636e\u5168\u751f\u547d\u5468\u671f\uff1a \u9884\u8bad\u7ec3(Pre-train) \\(\\rightarrow\\) \u5fae\u8c03(SFT) \\(\\rightarrow\\) \u5f3a\u5316\u5b66\u4e60(RLHF) \\(\\rightarrow\\) \u68c0\u7d22\u589e\u5f3a(RAG)\u3002</li> <li>1_3 \u6311\u6218\u4e0e\u673a\u9047\uff1a \u5f02\u6784\u591a\u6a21\u6001\u3001\u7248\u6743\u5408\u89c4\u4e0e\u7b97\u529b\u6210\u672c\u7684\u535a\u5f08\u3002</li> </ul>"},{"location":"#2","title":"\u7b2c2\u7ae0\uff1a\u6570\u636e\u57fa\u7840\u8bbe\u65bd\u9009\u578b","text":"<ul> <li>2_1 \u73b0\u4ee3\u6570\u636e\u6808 (Modern Data Stack)\uff1a</li> <li>\u5b58\u50a8\uff1a\u5bf9\u8c61\u5b58\u50a8 (S3/MinIO) vs \u6570\u636e\u6e56 (Iceberg/Hudi)\u3002</li> <li>\u8ba1\u7b97\uff1aSpark (\u4f20\u7edf\u9738\u4e3b) vs Ray Data (AI\u539f\u751f\u8ba1\u7b97\u6846\u67b6)\u3002</li> <li>2_2 \u6570\u636e\u683c\u5f0f\u4e0eI/O\u4f18\u5316\uff1a</li> <li>Parquet vs JSONL vs WebDataset (\u591a\u6a21\u6001\u573a\u666f)\u3002</li> <li>\u538b\u7f29\u7b97\u6cd5\u4e0e\u8bfb\u53d6\u6027\u80fd\u4f18\u5316\u3002</li> <li>2_3 \u6570\u636e\u7248\u672c\u63a7\u5236 (DataOps)\uff1a \u4f7f\u7528 DVC \u548c LakeFS \u7ba1\u7406 PB \u7ea7\u6570\u636e\u96c6\u3002</li> </ul>"},{"location":"#text-pre-training","title":"\u7b2c\u4e8c\u90e8\u5206\uff1a\u6587\u672c\u9884\u8bad\u7ec3\u6570\u636e\u5de5\u7a0b (Text Pre-training)","text":"<p>\u76ee\u6807\uff1a \u5904\u7406\u6d77\u91cf\u65e0\u7ed3\u6784\u6587\u672c\uff0c\u6784\u5efa\u6a21\u578b\u7684\u8bed\u8a00\u8ba4\u77e5\u57fa\u5ea7\u3002</p>"},{"location":"#3","title":"\u7b2c3\u7ae0\uff1a\u6570\u636e\u83b7\u53d6\u4e0e\u91c7\u96c6","text":"<ul> <li>3_1 \u5f00\u6e90\u6570\u636e\u96c6\u89e3\u6784\uff1a Common Crawl, C4, RefinedWeb, The Pile \u6df1\u5ea6\u5256\u6790\u3002</li> <li>3_2 \u9ad8\u6027\u80fd\u722c\u866b\u7cfb\u7edf\uff1a <code>Trafilatura</code> \u89e3\u6790\u5e93\u5e94\u7528\u4e0e\u5206\u5e03\u5f0f\u722c\u866b\u67b6\u6784\u8bbe\u8ba1\u3002</li> <li>3_3 \u7279\u79cd\u6570\u636e\u83b7\u53d6\uff1a \u4ee3\u7801 (GitHub)\u3001\u8bba\u6587 (ArXiv/S2ORC)\u3001\u4e66\u7c4d\u6570\u636e\u7684\u63d0\u53d6\u7b56\u7565\u3002</li> </ul>"},{"location":"#4-cleaning-deduplication","title":"\u7b2c4\u7ae0\uff1a\u6e05\u6d17\u4e0e\u53bb\u566a (Cleaning &amp; Deduplication)","text":"<ul> <li>4_1 \u542f\u53d1\u5f0f\u8fc7\u6ee4\u89c4\u5219\uff1a \u8bed\u8a00\u8bc6\u522b (FastText)\u3001\u56f0\u60d1\u5ea6 (Perplexity) \u8fc7\u6ee4\u3001\u957f\u5ea6\u4e0e\u6807\u70b9\u5206\u5e03\u3002</li> <li>4_2 \u5927\u89c4\u6a21\u53bb\u91cd\u6280\u672f\uff1a</li> <li>\u6a21\u7cca\u53bb\u91cd (Fuzzy Deduplication)\uff1a MinHash LSH \u7b97\u6cd5\u539f\u7406\u4e0e\u5206\u5e03\u5f0f\u5b9e\u73b0\u3002</li> <li>\u6587\u6863\u5185\u53bb\u91cd\uff1a \u6d88\u9664\u91cd\u590d\u6bb5\u843d\u4e0e\u5bfc\u822a\u680f\u3002</li> <li>4_3 \u9690\u79c1\u6e05\u6d17 (PII Removal)\uff1a \u4f7f\u7528 Presidio \u8bc6\u522b\u5e76\u63a9\u76d6 Email\u3001IP\u3001\u7535\u8bdd\u3001\u5730\u5740\u3002</li> </ul>"},{"location":"#5-tokenization","title":"\u7b2c5\u7ae0\uff1a\u5206\u8bcd\u4e0e\u5e8f\u5217\u5316 (Tokenization)","text":"<ul> <li>5_1 \u5206\u8bcd\u5668\u539f\u7406\uff1a BPE, WordPiece, Unigram \u53ca\u5176\u5bf9\u6a21\u578b\u6027\u80fd\u7684\u5f71\u54cd\u3002</li> <li>5_2 \u9ad8\u6548\u8bcd\u8868\u6784\u5efa\uff1a \u5982\u4f55\u4e3a\u7279\u5b9a\u9886\u57df\uff08\u5982\u533b\u7597\u3001\u6cd5\u5f8b\uff09\u6269\u5145\u8bcd\u8868\u3002</li> <li>5_3 \u6570\u636e\u6df7\u5408 (Data Mixing)\uff1a \u52a8\u6001\u91c7\u6837\u7b56\u7565\u4e0e Curriculum Learning (\u8bfe\u7a0b\u5b66\u4e60) \u6570\u636e\u6392\u5e03\u3002</li> </ul>"},{"location":"#multimodal-data-engineering","title":"\u7b2c\u4e09\u90e8\u5206\uff1a\u591a\u6a21\u6001\u6570\u636e\u5de5\u7a0b (Multimodal Data Engineering)","text":"<p>\u76ee\u6807\uff1a \u5904\u7406\u56fe\u50cf\u3001\u89c6\u9891\u4e0e\u97f3\u9891\uff0c\u652f\u6301 GPT-4V/Sora \u7c7b\u6a21\u578b\u7684\u8bad\u7ec3\u3002</p>"},{"location":"#6-image-text-pairs","title":"\u7b2c6\u7ae0\uff1a\u56fe\u6587\u5bf9\u6570\u636e\u5904\u7406 (Image-Text Pairs)","text":"<ul> <li>6_1 \u6570\u636e\u8303\u5f0f\uff1a \u56fe\u6587\u5bf9 (LAION-5B) vs \u4ea4\u9519\u6587\u6863 (OBELICS/MMC4)\u3002</li> <li>6_2 \u56fe\u50cf\u83b7\u53d6\u4e0e\u9884\u5904\u7406\uff1a</li> <li><code>img2dataset</code> \u9ad8\u5e76\u53d1\u4e0b\u8f7d\u5b9e\u6218\u3002</li> <li>GPU \u52a0\u901f\u89e3\u7801\u4e0e\u53d8\u6362 (NVIDIA DALI)\u3002</li> <li>6_3 \u591a\u6a21\u6001\u6e05\u6d17\u6d41\u6c34\u7ebf\uff1a</li> <li>\u7f8e\u5b66\u8bc4\u5206 (Aesthetics)\uff1a \u4f7f\u7528 CLIP-Score \u7b5b\u9009\u9ad8\u7f8e\u611f\u56fe\u7247\u3002</li> <li>\u56fe\u6587\u5bf9\u9f50\u8fc7\u6ee4\uff1a \u5254\u9664\u63cf\u8ff0\u4e0e\u56fe\u7247\u4e0d\u7b26\u7684\u6837\u672c\u3002</li> <li>\u5b89\u5168\u6027\u68c0\u6d4b\uff1a NSFW \u4e0e\u6c34\u5370\u8bc6\u522b\u3002</li> </ul>"},{"location":"#7-recaptioning","title":"\u7b2c7\u7ae0\uff1a\u6570\u636e\u91cd\u63cf\u8ff0 (Recaptioning)","text":"<ul> <li>7_1 Alt-text \u7684\u5c40\u9650\u6027\uff1a \u4e3a\u4ec0\u4e48\u539f\u59cb\u7f51\u9875\u63cf\u8ff0\u4e0d\u53ef\u7528\uff1f</li> <li>7_2 \u5408\u6210\u63cf\u8ff0\u5de5\u5382\uff1a</li> <li>\u5229\u7528 BLIP-2 / LLaVA / CogVLM \u91cd\u65b0\u751f\u6210\u8be6\u7ec6 Caption\u3002</li> <li>Prompt \u7b56\u7565\uff1a \u63a7\u5236\u751f\u6210\u63cf\u8ff0\u7684\u9897\u7c92\u5ea6\uff08\u7b80\u7565 vs \u8be6\u5c3d\uff09\u3002</li> <li>7_3 OCR \u589e\u5f3a\uff1a \u63d0\u53d6\u56fe\u4e2d\u6587\u5b57\u5e76\u878d\u5408\u8fdb\u6587\u672c\u63cf\u8ff0\uff08\u5bf9\u6587\u6863\u7406\u89e3\u81f3\u5173\u91cd\u8981\uff09\u3002</li> </ul>"},{"location":"#8","title":"\u7b2c8\u7ae0\uff1a\u89c6\u9891\u4e0e\u97f3\u9891\u6570\u636e","text":"<ul> <li>8_1 \u89c6\u9891\u5904\u7406\u6d41\u6c34\u7ebf\uff1a \u573a\u666f\u5207\u5206 (Scene Detection) \u4e0e\u5173\u952e\u5e27\u63d0\u53d6\u7b56\u7565\u3002</li> <li>8_2 \u89c6\u9891 Tokenization\uff1a \u89c6\u9891\u538b\u7f29\u4e0e\u79bb\u6563\u5316\u8868\u793a\u3002</li> <li>8_3 \u97f3\u9891\u5bf9\u9f50\uff1a \u4f7f\u7528 Whisper \u8fdb\u884c\u5927\u89c4\u6a21 ASR \u53ca Force Alignment (\u65f6\u95f4\u6233\u5bf9\u9f50)\u3002</li> </ul>"},{"location":"#alignment-synthetic-data","title":"\u7b2c\u56db\u90e8\u5206\uff1a\u5bf9\u9f50\u4e0e\u5408\u6210\u6570\u636e\u5de5\u7a0b (Alignment &amp; Synthetic Data)","text":"<p>\u76ee\u6807\uff1a \u8ba9\u6a21\u578b\u542c\u61c2\u6307\u4ee4\uff0c\u5e76\u7a81\u7834\u4eba\u7c7b\u6570\u636e\u7684\u74f6\u9888\u3002</p>"},{"location":"#9-sft-data","title":"\u7b2c9\u7ae0\uff1a\u6307\u4ee4\u5fae\u8c03\u6570\u636e (SFT Data)","text":"<ul> <li>9_1 Prompt Engineering \u4e3a\u6570\u636e\u751f\u4ea7\u670d\u52a1\uff1a \u7f16\u5199\u9ad8\u9c81\u68d2\u6027\u7684 System Prompt\u3002</li> <li>9_2 \u81ea\u52a8\u5316\u6784\u9020\u65b9\u6cd5\uff1a</li> <li>Self-Instruct\uff1a \u5229\u7528\u5f3a\u6a21\u578b\u751f\u6210\u6307\u4ee4\u3002</li> <li>Evol-Instruct\uff1a \u6307\u4ee4\u590d\u6742\u5ea6\u7684\u8fdb\u5316\u7b56\u7565\u3002</li> <li>9_3 \u601d\u7ef4\u94fe (CoT) \u6570\u636e\uff1a \u6784\u9020 Step-by-Step \u7684\u63a8\u7406\u6837\u672c\u3002</li> </ul>"},{"location":"#10-synthetic-data","title":"\u7b2c10\u7ae0\uff1a\u5408\u6210\u6570\u636e (Synthetic Data)","text":"<ul> <li>10_1 \u6559\u79d1\u4e66\u7ea7\u6570\u636e (Textbooks Are All You Need)\uff1a \u5408\u6210\u9ad8\u8d28\u91cf\u9886\u57df\u77e5\u8bc6\u3002</li> <li>10_2 \u4ee3\u7801\u4e0e\u6570\u5b66\u5408\u6210\uff1a</li> <li>PoT (Program of Thought)\uff1a \u751f\u6210\u4ee3\u7801\u5e76\u6267\u884c\uff0c\u4ee5\u6267\u884c\u7ed3\u679c\u9a8c\u8bc1\u6570\u636e\u6b63\u786e\u6027\u3002</li> <li>10_3 \u591a\u6a21\u6001\u6307\u4ee4\u5408\u6210\uff1a \u5229\u7528 GPT-4o \u6784\u9020\u57fa\u4e8e\u56fe\u50cf\u7684\u590d\u6742\u63a8\u7406\u95ee\u7b54\u3002</li> </ul>"},{"location":"#11-rlhfdpo","title":"\u7b2c11\u7ae0\uff1a\u4eba\u7c7b\u504f\u597d\u6570\u636e (RLHF/DPO)","text":"<ul> <li>11_1 \u504f\u597d\u6570\u636e\u683c\u5f0f\uff1a Chosen vs Rejected \u6837\u672c\u5bf9\u6784\u5efa\u3002</li> <li>11_2 \u6807\u6ce8\u5e73\u53f0\u4e0e\u8d28\u68c0\uff1a \u4f17\u5305\u7ba1\u7406\u4e0e IAA (\u6807\u6ce8\u4e00\u81f4\u6027) \u5206\u6790\u3002</li> <li>11_3 RLAIF (AI Feedback)\uff1a \u4f7f\u7528 LLM \u4ee3\u66ff\u4eba\u7c7b\u8fdb\u884c\u504f\u597d\u6253\u5206\u3002</li> </ul>"},{"location":"#rag-agent","title":"\u7b2c\u4e94\u90e8\u5206\uff1a\u5e94\u7528\u7ea7\u6570\u636e\u5de5\u7a0b (RAG &amp; Agent)","text":"<p>\u76ee\u6807\uff1a \u9762\u5411\u4f01\u4e1a\u843d\u5730\uff0c\u89e3\u51b3\u5916\u90e8\u77e5\u8bc6\u5e93\u7684\u89e3\u6790\u4e0e\u68c0\u7d22\u3002</p>"},{"location":"#12rag","title":"\u7b2c12\u7ae0\uff1aRAG \u6570\u636e\u6d41\u6c34\u7ebf","text":"<ul> <li>12_1 \u6587\u6863\u6df1\u5ea6\u89e3\u6790\uff1a</li> <li>\u590d\u6742 PDF \u5904\u7406\uff1a\u8868\u683c\u8fd8\u539f\u3001\u591a\u680f\u8bc6\u522b (<code>Unstructured</code>, <code>LlamaParse</code>).</li> <li>12_2 \u5207\u7247\u7b56\u7565 (Chunking)\uff1a \u8bed\u4e49\u5207\u7247\u3001\u9012\u5f52\u5207\u7247\u4e0e\u7236\u5b50\u7d22\u5f15 (Parent-Child Indexing)\u3002</li> <li>12_3 \u5411\u91cf\u5316\u4e0e\u5b58\u50a8\uff1a Embedding \u6a21\u578b\u5fae\u8c03\u4e0e\u5411\u91cf\u6570\u636e\u5e93\u4f18\u5316\u3002</li> </ul>"},{"location":"#13-rag","title":"\u7b2c13\u7ae0\uff1a\u591a\u6a21\u6001 RAG","text":"<ul> <li>13_1 \u8de8\u6a21\u6001\u68c0\u7d22\uff1a \u4f7f\u7528 CLIP/SigLIP \u5b9e\u73b0\u201c\u4ee5\u6587\u641c\u56fe\u201d\u4e0e\u201c\u4ee5\u56fe\u641c\u6587\u201d\u3002</li> <li>13_2 ColPali \u67b6\u6784\u5b9e\u6218\uff1a \u57fa\u4e8e\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\u7684\u6587\u6863\u68c0\u7d22\uff08\u8df3\u8fc7 OCR\uff0c\u76f4\u63a5\u7406\u89e3\u6587\u6863\u56fe\u50cf\uff09\u3002</li> </ul>"},{"location":"#capstone-projects","title":"\u7b2c\u516d\u90e8\u5206\uff1a\u5b9e\u6218\u9879\u76ee\u96c6 (Capstone Projects)","text":"<p>\u76ee\u6807\uff1a \u901a\u8fc7 5 \u4e2a\u7aef\u5230\u7aef\u9879\u76ee\uff0c\u4e32\u8054\u5168\u4e66\u6280\u672f\u70b9\uff0c\u63d0\u4f9b\u53ef\u8fd0\u884c\u7684\u4ee3\u7801\u5e93\u3002</p>"},{"location":"#mini-c4","title":"\u9879\u76ee\u4e00\uff1a\u6784\u5efa\u201cMini-C4\u201d\u9884\u8bad\u7ec3\u96c6","text":"<ul> <li>\u573a\u666f\uff1a \u4ece Common Crawl \u539f\u59cb\u6570\u636e (WARC) \u5230\u9ad8\u8d28\u91cf Parquet \u6570\u636e\u3002</li> <li>\u6838\u5fc3\u6280\u672f\uff1a Trafilatura \u89e3\u6790\u3001Spark/Ray \u5206\u5e03\u5f0f MinHash \u53bb\u91cd\u3001KenLM \u8d28\u91cf\u8fc7\u6ee4\u3002</li> <li>\u8f93\u51fa\uff1a \u6e05\u6d17\u540e\u7684\u7eaf\u6587\u672c\u8bed\u6599\u5e93\u4e0e\u5904\u7406 Pipeline\u3002</li> </ul>"},{"location":"#sft","title":"\u9879\u76ee\u4e8c\uff1a\u5782\u76f4\u9886\u57df\u4e13\u5bb6 SFT (\u6cd5\u5f8b/\u533b\u7597)","text":"<ul> <li>\u573a\u666f\uff1a \u57fa\u4e8e\u975e\u7ed3\u6784\u5316 PDF \u6587\u6863\u6784\u5efa\u884c\u4e1a\u4e13\u5bb6\u5fae\u8c03\u6570\u636e\u3002</li> <li>\u6838\u5fc3\u6280\u672f\uff1a Self-Instruct \u6784\u9020\u6307\u4ee4\u3001CoT \u63a8\u7406\u589e\u5f3a\u3001\u6570\u636e\u591a\u6837\u6027\u5e73\u8861\u3002</li> <li>\u8f93\u51fa\uff1a <code>domain_expert.jsonl</code> \u6307\u4ee4\u5fae\u8c03\u96c6\u3002</li> </ul>"},{"location":"#llava","title":"\u9879\u76ee\u4e09\uff1a\u6784\u5efa LLaVA \u591a\u6a21\u6001\u6307\u4ee4\u96c6","text":"<ul> <li>\u573a\u666f\uff1a \u8bad\u7ec3\u4e00\u4e2a\u80fd\u770b\u61c2\u56fe\u7247\u7684\u591a\u6a21\u6001\u6a21\u578b\u3002</li> <li>\u6838\u5fc3\u6280\u672f\uff1a \u4f7f\u7528 GPT-4o API \u751f\u6210\u591a\u8f6e\u56fe\u6587\u5bf9\u8bdd\u3001Bounding Box \u6570\u636e\u5bf9\u9f50\u3001\u591a\u56fe\u4ea4\u9519\u683c\u5f0f\u5904\u7406\u3002</li> <li>\u8f93\u51fa\uff1a \u5305\u542b\u89c6\u89c9\u6307\u4ee4\u7684\u56fe\u6587\u6570\u636e\u96c6\u3002</li> </ul>"},{"location":"#_5","title":"\u9879\u76ee\u56db\uff1a\u5408\u6210\u6570\u5b66/\u4ee3\u7801\u6559\u79d1\u4e66","text":"<ul> <li>\u573a\u666f\uff1a \u63d0\u5347\u5c0f\u6a21\u578b\u7684\u903b\u8f91\u63a8\u7406\u80fd\u529b\u3002</li> <li>\u6838\u5fc3\u6280\u672f\uff1a Evol-Instruct \u8fdb\u5316\u7b56\u7565\u3001Python \u4ee3\u7801\u6267\u884c\u6c99\u7bb1 (Sandbox) \u9a8c\u8bc1\u3001PoT \u6570\u636e\u683c\u5f0f\u5316\u3002</li> <li>\u8f93\u51fa\uff1a \u7ecf\u8fc7\u9a8c\u8bc1\u7684\u9ad8\u8d28\u91cf\u5408\u6210\u63a8\u7406\u6570\u636e\u96c6\u3002</li> </ul>"},{"location":"#rag","title":"\u9879\u76ee\u4e94\uff1a\u591a\u6a21\u6001 RAG \u4f01\u4e1a\u8d22\u62a5\u52a9\u624b","text":"<ul> <li>\u573a\u666f\uff1a \u68c0\u7d22\u5e76\u56de\u7b54\u5305\u542b\u590d\u6742\u56fe\u8868\u7684\u5e74\u5ea6\u8d22\u62a5\u95ee\u9898\u3002</li> <li>\u6838\u5fc3\u6280\u672f\uff1a PDF \u8868\u683c\u4e0e\u56fe\u8868\u89e3\u6790\u3001\u591a\u8def\u53ec\u56de (\u6df7\u5408\u68c0\u7d22)\u3001ColPali \u89c6\u89c9\u68c0\u7d22\u5e94\u7528\u3002</li> <li>\u8f93\u51fa\uff1a \u4e00\u4e2a\u652f\u6301\u56fe\u8868\u95ee\u7b54\u7684 RAG \u77e5\u8bc6\u5e93\u7cfb\u7edf\u3002</li> </ul>"},{"location":"#_6","title":"\u9644\u5f55","text":"<ul> <li>\u9644\u5f55 A\uff1a \u5e38\u7528\u5de5\u5177\u901f\u67e5 (Hugging Face Datasets, LangChain, Ray Data)\u3002</li> <li>\u9644\u5f55 B\uff1a \u6570\u636e\u5408\u89c4\u81ea\u67e5\u6e05\u5355 (\u7248\u6743\u3001GDPR\u3001\u673a\u5668\u4eba\u534f\u8bae)\u3002</li> <li>\u9644\u5f55 C\uff1a \u7b97\u529b\u6210\u672c\u4f30\u7b97\u8868 (\u4e0d\u540c\u89c4\u6a21\u6570\u636e\u6e05\u6d17\u7684 GPU/CPU \u6d88\u8017\u53c2\u8003)\u3002</li> </ul>"},{"location":"chapter1/1_1_data_change/","title":"\u7b2c1\u7ae0\uff1a\u5927\u6a21\u578b\u65f6\u4ee3\u7684\u6570\u636e\u53d8\u9769","text":""},{"location":"chapter1/1_1_data_change/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5927\u6a21\u578b\uff08Large Language Models, LLMs\uff09\u7684\u5d1b\u8d77\u6539\u53d8\u4e86\u4eba\u5de5\u667a\u80fd\u7684\u8303\u5f0f\u3002\u7136\u800c\uff0c\u6a21\u578b\u67b6\u6784\u7684\u521b\u65b0\u5df2\u8d8b\u4e8e\u6536\u655b\uff0c\u771f\u6b63\u51b3\u5b9a\u6a21\u578b\u80fd\u529b\u4e0a\u9650\u7684\u662f\u6570\u636e\u8d28\u91cf\u3002\u672c\u7ae0\u5c06\u4ece Scaling Laws \u51fa\u53d1\uff0c\u5efa\u7acb\"\u6570\u636e\u5373\u6838\u5fc3\u8d44\u4ea7\"\u7684\u8ba4\u77e5\uff0c\u7cfb\u7edf\u6027\u5730\u4ecb\u7ecd LLM \u6570\u636e\u5168\u751f\u547d\u5468\u671f\uff0c\u5e76\u6df1\u5165\u63a2\u8ba8\u5f02\u6784\u591a\u6a21\u6001\u3001\u7248\u6743\u5408\u89c4\u4e0e\u7b97\u529b\u6210\u672c\u7b49\u73b0\u5b9e\u6311\u6218\u3002</p>"},{"location":"chapter1/1_1_data_change/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u4f60\u662f\u4e00\u5bb6 AI \u521b\u4e1a\u516c\u53f8\u7684\u6570\u636e\u8d1f\u8d23\u4eba\u3002\u56e2\u961f\u521a\u521a\u82b1\u8d39\u4e09\u4e2a\u6708\u65f6\u95f4\uff0c\u4ece\u516c\u7f51\u722c\u53d6\u4e86 50TB \u7684\u4e2d\u6587\u8bed\u6599\uff0c\u4fe1\u5fc3\u6ee1\u6ee1\u5730\u5f00\u59cb\u9884\u8bad\u7ec3\u4e00\u4e2a 7B \u53c2\u6570\u7684\u57fa\u5ea7\u6a21\u578b\u3002</p> <p>\u7136\u800c\uff0c\u8bad\u7ec3\u4e24\u5468\u540e\uff0cLoss \u66f2\u7ebf\u5728\u67d0\u4e2a\u70b9\u7a81\u7136\"\u8eba\u5e73\"\uff0c\u6a21\u578b\u8f93\u51fa\u5145\u65a5\u7740\u5e7f\u544a\u6587\u6848\u3001\u91cd\u590d\u7684 SEO \u5783\u573e\uff0c\u751a\u81f3\u8fd8\u80fd\u80cc\u8bf5\u51fa\u67d0\u4e9b\u7f51\u7ad9\u7684\u7528\u6237\u534f\u8bae\u3002\u590d\u76d8\u4f1a\u8bae\u4e0a\uff0c\u8d44\u6df1\u5de5\u7a0b\u5e08\u629b\u51fa\u4e86\u4e00\u4e2a\u5c16\u9510\u7684\u95ee\u9898\uff1a\"\u6211\u4eec\u82b1\u4e86 100 \u4e07\u7b97\u529b\u8d39\u8bad\u7ec3\u7684\uff0c\u5230\u5e95\u662f\u4e00\u4e2a\u8bed\u8a00\u6a21\u578b\uff0c\u8fd8\u662f\u4e00\u4e2a\u4e92\u8054\u7f51\u5783\u573e\u7684\u538b\u7f29\u7d22\u5f15\uff1f\"</p> <p>\u8fd9\u4e2a\u573a\u666f\u5e76\u975e\u675c\u64b0\u3002OpenAI\u3001Google\u3001Meta \u7b49\u9876\u7ea7\u5b9e\u9a8c\u5ba4\u65e9\u5df2\u8fbe\u6210\u5171\u8bc6\uff1a\u5728\u6a21\u578b\u67b6\u6784\u8d8b\u540c\u7684\u4eca\u5929\uff0c\u6570\u636e\u8d28\u91cf\u662f\u51b3\u5b9a\u6a21\u578b\u667a\u80fd\u4e0a\u9650\u7684\u6838\u5fc3\u53d8\u91cf\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_1-scaling-laws","title":"1_1 Scaling Laws \u7684\u542f\u793a\uff1a\u4ece\"\u5927\u6570\u636e\"\u5230\"\u9ad8\u8d28\u91cf\u6570\u636e\"\u7684\u8303\u5f0f\u8f6c\u79fb","text":""},{"location":"chapter1/1_1_data_change/#1_11-scaling-laws","title":"1_1.1 \u4ec0\u4e48\u662f Scaling Laws\uff1f","text":"<p>2020 \u5e74\uff0cOpenAI \u53d1\u8868\u4e86\u91cc\u7a0b\u7891\u5f0f\u7684\u8bba\u6587\u300aScaling Laws for Neural Language Models\u300b\uff0c\u63ed\u793a\u4e86\u4e00\u4e2a\u7b80\u6d01\u800c\u6df1\u523b\u7684\u89c4\u5f8b\uff1a\u6a21\u578b\u6027\u80fd\uff08\u4ee5 Loss \u8861\u91cf\uff09\u4e0e\u4e09\u4e2a\u6838\u5fc3\u56e0\u7d20\u5448\u5e42\u5f8b\u5173\u7cfb\uff08Power Law\uff09\u2014\u2014\u6a21\u578b\u53c2\u6570\u91cf \\(N\\)\u3001\u6570\u636e\u96c6\u5927\u5c0f \\(D\\)\u3001\u4ee5\u53ca\u8ba1\u7b97\u91cf \\(C\\)\u3002</p> \\[ L(N, D, C) \\approx \\left(\\frac{N_c}{N}\\right)^{\\alpha_N} + \\left(\\frac{D_c}{D}\\right)^{\\alpha_D} + \\left(\\frac{C_c}{C}\\right)^{\\alpha_C} \\] <p>\u5176\u4e2d \\(L\\) \u4e3a\u6a21\u578b\u7684\u4ea4\u53c9\u71b5\u635f\u5931\uff0c\\(N_c, D_c, C_c\\) \u4e3a\u5e38\u6570\uff0c\\(\\alpha\\) \u4e3a\u5e42\u5f8b\u6307\u6570\u3002\u901a\u4fd7\u5730\u7406\u89e3\uff0c\u60f3\u8ba9\u6a21\u578b\u66f4\u806a\u660e\uff0c\u8981\u4e48\u589e\u5927\u6a21\u578b\u89c4\u6a21\u3001\u8981\u4e48\u589e\u52a0\u6570\u636e\u91cf\u3001\u8981\u4e48\u6295\u5165\u66f4\u591a\u7b97\u529b\u3002\u8fd9\u4e09\u8005\u76f8\u4e92\u5236\u7ea6\uff0c\u5f62\u6210\u4e86\u5927\u6a21\u578b\u65f6\u4ee3\u7684\"\u4e0d\u53ef\u80fd\u4e09\u89d2\"\u3002</p> <p>\u8fd9\u4e00\u53d1\u73b0\u5728\u5b66\u672f\u754c\u548c\u5de5\u4e1a\u754c\u5f15\u53d1\u4e86\u5de8\u5927\u7684\u9707\u52a8\u3002\u5728\u6b64\u4e4b\u524d\uff0c\u6df1\u5ea6\u5b66\u4e60\u7684\u53d1\u5c55\u66f4\u50cf\u662f\u4e00\u95e8\"\u70bc\u91d1\u672f\"\u2014\u2014\u7814\u7a76\u8005\u4eec\u51ed\u501f\u76f4\u89c9\u548c\u7ecf\u9a8c\u8c03\u6574\u6a21\u578b\u7ed3\u6784\uff0c\u671f\u671b\u5076\u7136\u53d1\u73b0\u6027\u80fd\u7a81\u7834\u3002Scaling Laws \u7684\u51fa\u73b0\uff0c\u7b2c\u4e00\u6b21\u5c06\u5927\u6a21\u578b\u8bad\u7ec3\u4ece\u827a\u672f\u63a8\u5411\u4e86\u5de5\u7a0b\u79d1\u5b66\uff0c\u4f7f\u5f97\u4f01\u4e1a\u53ef\u4ee5\u57fa\u4e8e\u7cbe\u786e\u7684\u6570\u5b66\u6a21\u578b\u6765\u89c4\u5212\u8d44\u6e90\u6295\u5165\u548c\u9884\u671f\u4ea7\u51fa\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_12","title":"1_1.2 \u6570\u636e\u8d28\u91cf\u7684\"\u9690\u85cf\u53d8\u91cf\"","text":"<p>\u7136\u800c\uff0c\u539f\u59cb Scaling Laws \u5b58\u5728\u4e00\u4e2a\u81f4\u547d\u76f2\u70b9\uff1a\u5b83\u5047\u8bbe\u6240\u6709\u6570\u636e\u7684\"\u8d28\u91cf\"\u662f\u5747\u5300\u7684\u3002\u8fd9\u4e2a\u5047\u8bbe\u5728\u73b0\u5b9e\u4e2d\u663e\u7136\u4e0d\u6210\u7acb\u3002\u4e92\u8054\u7f51\u4e0a\u7684\u6587\u672c\u8d28\u91cf\u53c2\u5dee\u4e0d\u9f50\uff0c\u4ece\u7cbe\u5fc3\u64b0\u5199\u7684\u5b66\u672f\u8bba\u6587\u5230\u5145\u65a5\u7740\u9519\u522b\u5b57\u7684\u5783\u573e\u8bc4\u8bba\uff0c\u6570\u636e\u4e4b\u95f4\u7684\u4ef7\u503c\u5dee\u5f02\u53ef\u80fd\u9ad8\u8fbe\u6570\u4e2a\u6570\u91cf\u7ea7\u3002</p> <p>2022 \u5e74\uff0cDeepMind \u7684 Chinchilla \u8bba\u6587\u6253\u7834\u4e86\u8fd9\u4e00\u5047\u8bbe\u3002\u7814\u7a76\u56e2\u961f\u8fdb\u884c\u4e86\u4e00\u9879\u5927\u89c4\u6a21\u5b9e\u9a8c\uff1a\u5728\u76f8\u540c\u7684\u8ba1\u7b97\u9884\u7b97\u4e0b\uff0c\u6bd4\u8f83\u4e0d\u540c\u6a21\u578b\u89c4\u6a21\u4e0e\u6570\u636e\u91cf\u914d\u6bd4\u7684\u6548\u679c\u3002\u7ed3\u679c\u4ee4\u4e1a\u754c\u5927\u5403\u4e00\u60ca\u2014\u2014\u4e00\u4e2a\u53c2\u6570\u91cf\u4ec5\u4e3a Gopher \u6a21\u578b\u56db\u5206\u4e4b\u4e00\u7684 Chinchilla\uff0870B \u53c2\u6570\uff09\uff0c\u901a\u8fc7\u4f7f\u7528\u56db\u500d\u7684\u9ad8\u8d28\u91cf\u8bad\u7ec3\u6570\u636e\uff081_4T tokens\uff09\uff0c\u5728\u51e0\u4e4e\u6240\u6709\u8bc4\u6d4b\u4efb\u52a1\u4e0a\u90fd\u8d85\u8d8a\u4e86 280B \u53c2\u6570\u7684 Gopher\u3002</p> \u6a21\u578b \u53c2\u6570\u91cf \u8bad\u7ec3 Token \u6570 \u6700\u7ec8\u6027\u80fd Gopher 280B 300B tokens \u57fa\u51c6 Chinchilla 70B 1_4T tokens \u8d85\u8d8a Gopher <p>\u8fd9\u9879\u7814\u7a76\u63ed\u793a\u4e86\u4e00\u4e2a\u88ab\u957f\u671f\u5ffd\u89c6\u7684\u4e8b\u5b9e\uff1a\u8fc7\u53bb\u4e1a\u754c\u4e25\u91cd\"\u8fc7\u62df\u5408\"\u4e8e\u6a21\u578b\u89c4\u6a21\uff0c\u800c\u4f4e\u4f30\u4e86\u6570\u636e\u91cf\u7684\u91cd\u8981\u6027\u3002Chinchilla \u8bba\u6587\u7ed9\u51fa\u7684\"\u6700\u4f18\u914d\u6bd4\"\u5efa\u8bae\u662f\uff1a\u6bcf\u589e\u52a0 1 \u4e2a\u53c2\u6570\uff0c\u5e94\u914d\u5957\u7ea6 20 \u4e2a Token \u7684\u8bad\u7ec3\u6570\u636e\u3002\u8fd9\u610f\u5473\u7740\u8bad\u7ec3\u4e00\u4e2a 7B \u6a21\u578b\uff0c\u7406\u8bba\u4e0a\u9700\u8981\u7ea6 140B Token \u7684\u9ad8\u8d28\u91cf\u8bed\u6599\u2014\u2014\u8fd9\u4e2a\u6570\u5b57\u8fdc\u8fdc\u8d85\u51fa\u4e86\u8bb8\u591a\u56e2\u961f\u6700\u521d\u7684\u9884\u671f\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_13-vs-phi","title":"1_1.3 \u8d28\u91cf vs \u6570\u91cf\uff1aPhi \u7cfb\u5217\u7684\u6781\u7aef\u5b9e\u9a8c","text":"<p>\u5982\u679c\u8bf4 Chinchilla \u8bc1\u660e\u4e86\"\u6570\u636e\u91cf\u88ab\u4f4e\u4f30\"\uff0c\u90a3\u4e48\u5fae\u8f6f\u7684 Phi \u7cfb\u5217\u6a21\u578b\u5219\u8bc1\u660e\u4e86\u4e00\u4e2a\u66f4\u52a0\u6fc0\u8fdb\u7684\u89c2\u70b9\uff1a\u6570\u636e\u8d28\u91cf\u53ef\u4ee5\u98a0\u8986\u89c4\u6a21\u5b9a\u5f8b\u3002</p> <p>2023 \u5e74\uff0c\u5fae\u8f6f\u7814\u7a76\u9662\u53d1\u5e03\u4e86 Phi-1 \u6a21\u578b\u3002\u8fd9\u662f\u4e00\u4e2a\u4ec5\u6709 1_3B \u53c2\u6570\u7684\"\u5c0f\"\u6a21\u578b\uff0c\u8bad\u7ec3\u6570\u636e\u4ec5\u4f7f\u7528\u4e86 7B Token\u2014\u2014\u4e0e\u5f53\u65f6\u52a8\u8f84\u6570\u767e B \u751a\u81f3 T \u7ea7\u522b\u7684\u4e3b\u6d41\u505a\u6cd5\u5f62\u6210\u9c9c\u660e\u5bf9\u6bd4\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u770b\u4f3c\"\u8425\u517b\u4e0d\u826f\"\u7684\u6a21\u578b\uff0c\u5728\u4ee3\u7801\u751f\u6210\u4efb\u52a1\u4e0a\u5374\u8d85\u8d8a\u4e86\u53c2\u6570\u91cf\u662f\u5176\u5341\u500d\u7684\u7ade\u4e89\u5bf9\u624b\u3002</p> <p>Phi-1 \u7684\u79d8\u5bc6\u6b66\u5668\u4e0d\u662f\u6d77\u91cf\u722c\u866b\u6570\u636e\uff0c\u800c\u662f\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u3001\u5177\u6709\u6559\u5b66\u610f\u4e49\u7684\u5408\u6210\u6570\u636e\u3002\u7814\u7a76\u8005\u4f7f\u7528 GPT-4 \u751f\u6210\u4e86\u5927\u91cf\u7ed3\u6784\u6e05\u6670\u3001\u5faa\u5e8f\u6e10\u8fdb\u7684\u7f16\u7a0b\u6559\u7a0b\uff0c\u4ece\u57fa\u7840\u8bed\u6cd5\u5230\u9ad8\u7ea7\u7b97\u6cd5\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u5b8c\u6574\u7684\"\u4eba\u9020\u6559\u79d1\u4e66\"\u3002\u8fd9\u4e9b\u5408\u6210\u6570\u636e\u5177\u6709\u771f\u5b9e\u7f51\u7edc\u6570\u636e\u96be\u4ee5\u6bd4\u62df\u7684\u4f18\u52bf\uff1a\u6ca1\u6709\u566a\u58f0\u3001\u6ca1\u6709\u9519\u8bef\u3001\u903b\u8f91\u6e05\u6670\u3001\u96be\u5ea6\u9012\u8fdb\u3002\u7528\u8fd9\u4e9b\"\u4eba\u9020\u6559\u79d1\u4e66\"\u8bad\u7ec3\u7684\u5c0f\u6a21\u578b\uff0c\u5728\u89e3\u51b3\u5b9e\u9645\u7f16\u7a0b\u95ee\u9898\u65f6\u8868\u73b0\u51fa\u4e86\u60ca\u4eba\u7684\u80fd\u529b\u3002</p> <p></p> <p>\u56fe1-1\uff1a\u6570\u636e\u8d28\u91cf\u4e0e\u6a21\u578b\u6027\u80fd\u5173\u7cfb \u2014\u2014 \u4f4e\u8d28\u91cf\u6570\u636e\uff08\u566a\u58f040%\uff09\u7ecf\u8fc7\u6e05\u6d17\u540e\u8f6c\u5316\u4e3a\u9ad8\u8d28\u91cf\u6570\u636e\uff08\u566a\u58f05%\uff09</p> <p>Phi \u7cfb\u5217\u7684\u6210\u529f\u5f15\u53d1\u4e86\u4e1a\u754c\u5bf9\"\u5408\u6210\u6570\u636e\"\u7684\u70ed\u70c8\u8ba8\u8bba\u3002\u5982\u679c\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u5408\u6210\u6570\u636e\u53ef\u4ee5\u4ea7\u751f\u5982\u6b64\u4f18\u5f02\u7684\u6548\u679c\uff0c\u90a3\u4e48\u4f20\u7edf\u7684\"\u722c\u866b-\u6e05\u6d17-\u8bad\u7ec3\"\u8303\u5f0f\u662f\u5426\u9700\u8981\u88ab\u98a0\u8986\uff1f\u6211\u4eec\u5c06\u5728\u7b2c\u4e03\u7ae0\u8be6\u7ec6\u63a2\u8ba8\u5408\u6210\u6570\u636e\u7684\u65b9\u6cd5\u8bba\u548c\u6700\u4f73\u5b9e\u8df5\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_14","title":"1_1.4 \u6570\u636e\u5de5\u7a0b\u5e08\u7684\u6838\u5fc3\u4f7f\u547d","text":"<p>\u7efc\u5408\u4ee5\u4e0a\u7814\u7a76\uff0c\u6211\u4eec\u53ef\u4ee5\u63d0\u70bc\u51fa\u5927\u6a21\u578b\u65f6\u4ee3\u6570\u636e\u5de5\u7a0b\u5e08\u7684\u6838\u5fc3\u4f7f\u547d\u3002\u4f20\u7edf\u89c2\u5ff5\u8ba4\u4e3a\"\u6570\u636e\u8d8a\u591a\u8d8a\u597d\"\uff0c\u65b0\u8303\u5f0f\u5219\u5f3a\u8c03\u6570\u636e\u8d28\u91cf\u51b3\u5b9a\u6027\u80fd\u4e0a\u9650\uff0c\u566a\u58f0\u6570\u636e\u4e0d\u4ec5\u65e0\u76ca\u53cd\u800c\u53ef\u80fd\u6709\u5bb3\u3002\u8fc7\u53bb\u4eba\u4eec\u76f8\u4fe1\"\u6a21\u578b\u67b6\u6784\u662f\u6838\u5fc3\u7ade\u4e89\u529b\"\uff0c\u800c\u4eca\u5929\u67b6\u6784\u5df2\u8d8b\u4e8e\u8d8b\u540c\uff0c\u6570\u636e\u6210\u4e3a\u5dee\u5f02\u5316\u7684\u5173\u952e\u3002\u66fe\u7ecf\"\u6e05\u6d17\u662f\u9884\u5904\u7406\u7684\u5c0f\u73af\u8282\"\u7684\u770b\u6cd5\u5df2\u7ecf\u8fc7\u65f6\uff0c\u73b0\u5728\u6570\u636e\u6e05\u6d17\u88ab\u89c6\u4e3a\u6a21\u578b\u8bad\u7ec3\u6210\u529f\u7684\u57fa\u77f3\u3002\u540c\u6837\uff0c\"\u4eba\u5de5\u6807\u6ce8\u4e0d\u53ef\u66ff\u4ee3\"\u7684\u4f20\u7edf\u8ba4\u77e5\u4e5f\u88ab\u6253\u7834\uff0c\u9ad8\u8d28\u91cf\u5408\u6210\u6570\u636e\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\u53ef\u4ee5\u8d85\u8d8a\u771f\u5b9e\u6570\u636e\u3002</p> <p>\u9700\u8981\u7279\u522b\u5f3a\u8c03\u7684\u662f\uff0c\u4e0d\u5e94\u5c06\"\u8d28\u91cf\u5927\u4e8e\u6570\u91cf\"\u8bef\u8bfb\u4e3a\"\u53ea\u8981\u8d28\u91cf\u4e0d\u8981\u6570\u91cf\"\u3002Scaling Laws \u4f9d\u7136\u6709\u6548\uff0c\u53ea\u662f\u5728\u540c\u7b49\u7b97\u529b\u9884\u7b97\u4e0b\uff0c\u5e94\u4f18\u5148\u6295\u8d44\u4e8e\u6570\u636e\u8d28\u91cf\u3002\u4e00\u4e2a\u6781\u7aef\u7684\u4f8b\u5b50\uff1a\u7528 100 \u6761\u5b8c\u7f8e\u6570\u636e\u8bad\u7ec3\u7684\u6a21\u578b\uff0c\u6c38\u8fdc\u4e0d\u53ef\u80fd\u8d85\u8d8a\u7528 1T \u9ad8\u8d28\u91cf\u6570\u636e\u8bad\u7ec3\u7684\u6a21\u578b\u3002\u8d28\u91cf\u548c\u6570\u91cf\u5e76\u975e\u5bf9\u7acb\u5173\u7cfb\uff0c\u800c\u662f\u9700\u8981\u5728\u5b9e\u9645\u7ea6\u675f\u6761\u4ef6\u4e0b\u5bfb\u6c42\u6700\u4f18\u5e73\u8861\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_2-llm","title":"1_2 LLM \u6570\u636e\u5168\u751f\u547d\u5468\u671f","text":"<p>\u4e00\u4e2a\u5927\u8bed\u8a00\u6a21\u578b\u4ece\"\u8bde\u751f\"\u5230\"\u4e0a\u5c97\"\uff0c\u9700\u8981\u7ecf\u5386\u591a\u4e2a\u9636\u6bb5\u7684\u8bad\u7ec3\uff0c\u6bcf\u4e2a\u9636\u6bb5\u5bf9\u6570\u636e\u7684\u9700\u6c42\u622a\u7136\u4e0d\u540c\u3002\u7406\u89e3\u8fd9\u4e2a\u5168\u751f\u547d\u5468\u671f\uff0c\u662f\u6210\u4e3a\u5408\u683c\u6570\u636e\u5de5\u7a0b\u5e08\u7684\u7b2c\u4e00\u6b65\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_21-pre-train-sft-rlhf-rag","title":"1_2.1 \u56db\u9636\u6bb5\u8303\u5f0f\uff1aPre-train \u2192 SFT \u2192 RLHF \u2192 RAG","text":"<p>\u56fe1-2\uff1aLLM \u8bad\u7ec3\u6570\u636e\u6d41\u6c34\u7ebf \u2014\u2014 \u4ece TB \u7ea7\u9884\u8bad\u7ec3\u5230 KB \u7ea7 RAG\uff0c\u6570\u636e\u91cf\u9012\u51cf\u4f46\u8d28\u91cf\u8981\u6c42\u9012\u589e</p> <p>\u9884\u8bad\u7ec3\u9636\u6bb5\uff08Pre-training\uff09 \u662f\u5927\u6a21\u578b\u751f\u547d\u7684\u8d77\u70b9\u3002\u5728\u8fd9\u4e2a\u9636\u6bb5\uff0c\u6a21\u578b\u9700\u8981\u4ece\u6d77\u91cf\u7684\u65e0\u6807\u7b7e\u6587\u672c\u4e2d\u5b66\u4e60\u8bed\u8a00\u7684\u672c\u8d28\u2014\u2014\u8bed\u6cd5\u7ed3\u6784\u3001\u5e38\u8bc6\u77e5\u8bc6\u3001\u4e16\u754c\u8fd0\u4f5c\u7684\u89c4\u5f8b\u3002\u9884\u8bad\u7ec3\u6570\u636e\u7684\u89c4\u6a21\u901a\u5e38\u5728 TB \u7ea7\u522b\uff0c\u5305\u542b\u6570\u4e07\u4ebf\u4e2a Token\uff0c\u6765\u6e90\u6db5\u76d6\u7f51\u9875\u3001\u4e66\u7c4d\u3001\u4ee3\u7801\u3001\u5b66\u672f\u8bba\u6587\u7b49\u5404\u7c7b\u6587\u672c\u3002\u8fd9\u4e2a\u9636\u6bb5\u7684\u6838\u5fc3\u6311\u6218\u5728\u4e8e\u53bb\u91cd\u3001\u53bb\u566a\u3001\u8d28\u91cf\u8fc7\u6ee4\u4ee5\u53ca\u591a\u6837\u6027\u5e73\u8861\u3002\u5178\u578b\u7684\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u5305\u62ec Common Crawl\u3001The Pile \u548c RefinedWeb\u3002</p> <p>\u76d1\u7763\u5fae\u8c03\u9636\u6bb5\uff08Supervised Fine-Tuning, SFT\uff09 \u662f\u6a21\u578b\u5b66\u4e60\"\u9075\u5faa\u6307\u4ee4\"\u7684\u5173\u952e\u65f6\u671f\u3002\u7ecf\u8fc7\u9884\u8bad\u7ec3\u7684\u6a21\u578b\u867d\u7136\u5177\u5907\u4e86\u5f3a\u5927\u7684\u8bed\u8a00\u7406\u89e3\u80fd\u529b\uff0c\u4f46\u5e76\u4e0d\u77e5\u9053\u5982\u4f55\u4e0e\u4eba\u7c7b\u8fdb\u884c\u6709\u6548\u5bf9\u8bdd\u3002SFT \u9636\u6bb5\u901a\u8fc7\u6210\u5bf9\u7684\u6307\u4ee4-\u56de\u590d\u6570\u636e\uff0c\u6559\u4f1a\u6a21\u578b\u7406\u89e3\u7528\u6237\u610f\u56fe\u5e76\u7ed9\u51fa\u6709\u5e2e\u52a9\u7684\u56de\u590d\u3002\u8fd9\u4e2a\u9636\u6bb5\u7684\u6570\u636e\u89c4\u6a21\u964d\u81f3 GB \u7ea7\u522b\uff0c\u5305\u542b\u6570\u5341\u4e07\u5230\u6570\u767e\u4e07\u6761\u7cbe\u5fc3\u6784\u9020\u7684\u5bf9\u8bdd\u6837\u672c\u3002\u5173\u952e\u6311\u6218\u5728\u4e8e\u4fdd\u8bc1\u6307\u4ee4\u7684\u591a\u6837\u6027\u3001\u56de\u590d\u7684\u8d28\u91cf\u4ee5\u53ca\u683c\u5f0f\u7684\u89c4\u8303\u6027\u3002Alpaca\u3001ShareGPT\u3001OpenAssistant \u662f\u8fd9\u4e2a\u9636\u6bb5\u5e38\u7528\u7684\u6570\u636e\u96c6\u3002</p> <p>\u57fa\u4e8e\u4eba\u7c7b\u53cd\u9988\u7684\u5f3a\u5316\u5b66\u4e60\u9636\u6bb5\uff08RLHF/DPO\uff09 \u81f4\u529b\u4e8e\u8ba9\u6a21\u578b\u7684\u8f93\u51fa\u66f4\u52a0\"\u5bf9\u9f50\"\u4eba\u7c7b\u504f\u597d\u3002\u6240\u8c13\u5bf9\u9f50\uff0c\u6307\u7684\u662f\u8ba9\u6a21\u578b\u53d8\u5f97\u66f4\u5b89\u5168\uff08\u4e0d\u4ea7\u751f\u6709\u5bb3\u5185\u5bb9\uff09\u3001\u66f4\u6709\u5e2e\u52a9\uff08\u771f\u6b63\u89e3\u51b3\u7528\u6237\u95ee\u9898\uff09\u3001\u66f4\u8bda\u5b9e\uff08\u4e0d\u7f16\u9020\u4e8b\u5b9e\uff09\u3002\u8fd9\u4e2a\u9636\u6bb5\u4f7f\u7528\u7684\u662f\u504f\u597d\u5bf9\u6bd4\u6570\u636e\uff0c\u5373\u4eba\u7c7b\u6807\u6ce8\u8005\u5728\u4e24\u4e2a\u5019\u9009\u56de\u590d\u4e2d\u9009\u62e9\u66f4\u597d\u7684\u90a3\u4e2a\u3002\u6570\u636e\u89c4\u6a21\u8fdb\u4e00\u6b65\u7f29\u51cf\u5230\u6570\u4e07\u81f3\u6570\u5341\u4e07\u6761\uff0c\u4f46\u5bf9\u6807\u6ce8\u8d28\u91cf\u7684\u8981\u6c42\u6781\u9ad8\u3002\u6807\u6ce8\u8005\u4e00\u81f4\u6027\uff08Inter-Annotator Agreement\uff09\u3001\u504f\u597d\u4fe1\u53f7\u7684\u51c6\u786e\u6027\u3001\u6837\u672c\u5206\u5e03\u7684\u8986\u76d6\u5ea6\u90fd\u662f\u9700\u8981\u7cbe\u5fc3\u628a\u63a7\u7684\u8981\u7d20\u3002</p> <p>\u68c0\u7d22\u589e\u5f3a\u751f\u6210\u9636\u6bb5\uff08Retrieval-Augmented Generation, RAG\uff09 \u89e3\u51b3\u7684\u662f\u6a21\u578b\u77e5\u8bc6\u66f4\u65b0\u548c\u5e7b\u89c9\u95ee\u9898\u3002\u65e0\u8bba\u9884\u8bad\u7ec3\u591a\u4e48\u5145\u5206\uff0c\u6a21\u578b\u7684\u77e5\u8bc6\u90fd\u6709\u622a\u6b62\u65e5\u671f\uff0c\u4e14\u65e0\u6cd5\u5b8c\u5168\u907f\u514d\"\u4e00\u672c\u6b63\u7ecf\u5730\u80e1\u8bf4\u516b\u9053\"\u3002RAG \u901a\u8fc7\u8ba9\u6a21\u578b\"\u67e5\u9605\u5916\u90e8\u8d44\u6599\"\u7684\u65b9\u5f0f\uff0c\u5c06\u4f01\u4e1a\u77e5\u8bc6\u5e93\u3001\u6700\u65b0\u6587\u6863\u7b49\u5916\u90e8\u4fe1\u606f\u6ce8\u5165\u5230\u751f\u6210\u8fc7\u7a0b\u4e2d\u3002\u8fd9\u4e2a\u9636\u6bb5\u7684\u6570\u636e\u6765\u6e90\u901a\u5e38\u662f\u4f01\u4e1a\u79c1\u6709\u7684\uff0c\u5305\u62ec PDF \u6587\u6863\u3001\u6570\u636e\u5e93\u8bb0\u5f55\u3001\u7f51\u9875\u5185\u5bb9\u7b49\u7ed3\u6784\u5316\u6216\u534a\u7ed3\u6784\u5316\u6570\u636e\u3002\u5173\u952e\u6311\u6218\u5728\u4e8e\u6587\u6863\u89e3\u6790\u3001\u8bed\u4e49\u5207\u7247\u3001\u5411\u91cf\u5316\u4ee5\u53ca\u68c0\u7d22\u51c6\u786e\u6027\u7684\u4f18\u5316\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_22","title":"1_2.2 \u6570\u636e\u6d41\u7684\"\u6f0f\u6597\u6a21\u578b\"","text":"<p>\u7406\u89e3\u6570\u636e\u751f\u547d\u5468\u671f\u7684\u53e6\u4e00\u4e2a\u89c6\u89d2\u662f\"\u6f0f\u6597\u6a21\u578b\"\u3002\u4ece\u539f\u59cb\u7f51\u9875\u6570\u636e\u5230\u6700\u7ec8\u53ef\u7528\u4e8e\u8bad\u7ec3\u7684\u9ad8\u8d28\u91cf\u8bed\u6599\uff0c\u6570\u636e\u91cf\u4f1a\u7ecf\u5386\u6025\u5267\u7684\u7f29\u51cf\u3002</p> <p></p> <p>\u56fe1-3\uff1a\u6570\u636e\u8fc7\u6ee4\u6f0f\u6597 \u2014\u2014 \u4ece 100PB \u539f\u59cb\u6570\u636e\u5230 10GB SFT \u6570\u636e\uff0c\u4fdd\u7559\u7387\u4ec5 0_00001%</p> <p>\u4ee5\u4e00\u4e2a\u5178\u578b\u7684\u9884\u8bad\u7ec3\u6570\u636e\u5904\u7406\u6d41\u7a0b\u4e3a\u4f8b\uff1a\u5047\u8bbe\u6211\u4eec\u4ece Common Crawl \u83b7\u53d6\u4e86 100PB \u7684\u539f\u59cb\u7f51\u9875\u6570\u636e\u3002\u7ecf\u8fc7 URL \u53bb\u91cd\u548c\u5b8c\u5168\u76f8\u540c\u5185\u5bb9\u7684\u53bb\u91cd\u540e\uff0c\u6570\u636e\u91cf\u53ef\u80fd\u964d\u81f3 30PB\uff08\u4fdd\u7559\u7387 30%\uff09\u3002\u63a5\u4e0b\u6765\u8fdb\u884c\u8bed\u8a00\u8bc6\u522b\u548c\u8d28\u91cf\u8fc7\u6ee4\u2014\u2014\u79fb\u9664\u975e\u76ee\u6807\u8bed\u8a00\u3001\u8272\u60c5\u66b4\u529b\u3001\u6781\u77ed\u6587\u672c\u3001\u4e71\u7801\u7b49\u2014\u2014\u6570\u636e\u91cf\u8fdb\u4e00\u6b65\u964d\u81f3 5PB\uff08\u4fdd\u7559\u7387 5%\uff09\u3002\u7136\u540e\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u8d28\u91cf\u8bc4\u4f30\uff0c\u4f7f\u7528\u56f0\u60d1\u5ea6\u3001\u91cd\u590d\u7387\u3001\u4fe1\u606f\u5bc6\u5ea6\u7b49\u6307\u6807\u7b5b\u9009\uff0c\u6700\u7ec8\u7684\u9884\u8bad\u7ec3\u8bed\u6599\u53ef\u80fd\u53ea\u6709 1PB\uff08\u4fdd\u7559\u7387 1%\uff09\u3002\u800c\u5982\u679c\u8fd8\u9700\u8981\u4ece\u4e2d\u62bd\u53d6\u6216\u6784\u9020 SFT \u6570\u636e\uff0c\u6700\u7ec8\u4ea7\u51fa\u53ef\u80fd\u4ec5\u6709 10GB\u2014\u2014\u76f8\u5bf9\u4e8e\u539f\u59cb\u6570\u636e\uff0c\u4fdd\u7559\u7387\u4f4e\u81f3\u5341\u4e07\u5206\u4e4b\u4e00\u3002</p> <p>\u5728\u5b9e\u9645\u5de5\u7a0b\u4e2d\uff0c\u7406\u89e3\u8fd9\u4e2a\u6bd4\u4f8b\u81f3\u5173\u91cd\u8981\u3002\u5b83\u76f4\u63a5\u5f71\u54cd\u722c\u53d6\u89c4\u6a21\u7684\u89c4\u5212\u3001\u5b58\u50a8\u6210\u672c\u7684\u9884\u7b97\u3001\u5904\u7406\u6d41\u6c34\u7ebf\u7684\u8bbe\u8ba1\u3002\u8bb8\u591a\u56e2\u961f\u5728\u9879\u76ee\u521d\u671f\u4f4e\u4f30\u4e86\u8fd9\u4e2a\"\u635f\u8017\u7387\"\uff0c\u5bfc\u81f4\u6570\u636e\u50a8\u5907\u4e0d\u8db3\uff0c\u4e0d\u5f97\u4e0d\u4e2d\u9014\u8fd4\u5de5\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_3","title":"1_3 \u6311\u6218\u4e0e\u673a\u9047\uff1a\u5f02\u6784\u591a\u6a21\u6001\u3001\u7248\u6743\u5408\u89c4\u4e0e\u7b97\u529b\u6210\u672c\u7684\u535a\u5f08","text":""},{"location":"chapter1/1_1_data_change/#1_31","title":"1_3.1 \u6311\u6218\u4e00\uff1a\u5f02\u6784\u591a\u6a21\u6001\u6570\u636e\u7684\u5904\u7406\u590d\u6742\u6027","text":"<p>\u968f\u7740 GPT-4V\u3001Gemini\u3001Sora \u7b49\u591a\u6a21\u6001\u6a21\u578b\u7684\u6d8c\u73b0\uff0c\u6570\u636e\u5de5\u7a0b\u7684\u590d\u6742\u5ea6\u5448\u6307\u6570\u7ea7\u4e0a\u5347\u3002\u7eaf\u6587\u672c\u65f6\u4ee3\uff0c\u6240\u6709\u6570\u636e\u90fd\u662f\u7edf\u4e00\u7684 UTF-8 \u7f16\u7801\u5b57\u7b26\u4e32\uff0c\u5904\u7406\u5de5\u5177\u94fe\u6210\u719f\u4e14\u6807\u51c6\u5316\u3002\u800c\u591a\u6a21\u6001\u65f6\u4ee3\uff0c\u6570\u636e\u683c\u5f0f\u7206\u70b8\u5f0f\u589e\u957f\uff1a\u56fe\u7247\u6709 JPEG\u3001PNG\u3001WebP\uff1b\u89c6\u9891\u6709 MP4\u3001AVI\u3001MKV\uff1b\u97f3\u9891\u6709 WAV\u3001MP3\u3001FLAC\uff1b\u6587\u6863\u6709 PDF\u3001Word\u3001HTML\u3002\u6bcf\u79cd\u683c\u5f0f\u90fd\u6709\u5176\u72ec\u7279\u7684\u89e3\u6790\u65b9\u5f0f\u548c\u8d28\u91cf\u8bc4\u4f30\u6807\u51c6\u3002</p> \u7ef4\u5ea6 \u7eaf\u6587\u672c\u65f6\u4ee3 \u591a\u6a21\u6001\u65f6\u4ee3 \u6570\u636e\u683c\u5f0f \u7edf\u4e00\u7684 UTF-8 \u6587\u672c \u56fe\u7247\u3001\u89c6\u9891\u3001\u97f3\u9891\u3001\u6587\u6863\u3001\u7f51\u9875\u7b49\u591a\u79cd\u683c\u5f0f \u5b58\u50a8\u9700\u6c42 TB \u7ea7 PB \u7ea7\uff08\u56fe\u7247/\u89c6\u9891\u5360\u4e3b\u5bfc\uff09 \u5bf9\u9f50\u96be\u5ea6 \u65e0\uff08\u7eaf\u6587\u672c\u65e0\u9700\u5bf9\u9f50\uff09 \u6781\u9ad8\uff08\u56fe\u6587\u5bf9\u9f50\u3001\u97f3\u89c6\u9891\u540c\u6b65\u3001\u8de8\u6a21\u6001\u8bed\u4e49\u4e00\u81f4\u6027\uff09 \u6e05\u6d17\u5de5\u5177\u94fe \u6210\u719f\uff08FastText\u3001KenLM\uff09 \u788e\u7247\u5316\uff08\u6bcf\u79cd\u6a21\u6001\u90fd\u6709\u72ec\u7acb\u5de5\u5177\u94fe\uff09 \u8d28\u91cf\u8bc4\u4f30 \u56f0\u60d1\u5ea6\u3001\u53bb\u91cd\u7387 \u7f8e\u5b66\u8bc4\u5206\u3001CLIP-Score\u3001OCR \u51c6\u786e\u7387\u3001ASR \u9519\u8bef\u7387\u7b49 <p>\u66f4\u68d8\u624b\u7684\u662f\u8de8\u6a21\u6001\u5bf9\u9f50\u95ee\u9898\u3002\u4e00\u5f20\u56fe\u7247\u914d\u4e00\u6bb5\u63cf\u8ff0\u6587\u5b57\uff0c\u5982\u4f55\u786e\u4fdd\u6587\u5b57\u51c6\u786e\u63cf\u8ff0\u4e86\u56fe\u7247\u5185\u5bb9\uff1f\u4e00\u6bb5\u89c6\u9891\u4e2d\u7684\u8bed\u97f3\u548c\u753b\u9762\u5982\u4f55\u7cbe\u786e\u540c\u6b65\uff1f\u8fd9\u4e9b\u5bf9\u9f50\u95ee\u9898\u5728\u7eaf\u6587\u672c\u65f6\u4ee3\u6839\u672c\u4e0d\u5b58\u5728\uff0c\u5374\u662f\u591a\u6a21\u6001\u6570\u636e\u5de5\u7a0b\u7684\u6838\u5fc3\u96be\u9898\u3002</p> <p></p> <p>\u56fe1-4\uff1a\u591a\u6a21\u6001\u6570\u636e\u5904\u7406\u590d\u6742\u5ea6 \u2014\u2014 \u7ebf\u6761\u7c97\u7ec6\u8868\u793a\u5904\u7406\u96be\u5ea6\uff0c\u89c6\u9891(5/5)\u548cPDF(4/5)\u6700\u590d\u6742</p> <p>\u4ece\u5de5\u7a0b\u5b9e\u8df5\u7684\u89d2\u5ea6\uff0c\u591a\u6a21\u6001\u6570\u636e\u5904\u7406\u9700\u8981\u6a21\u5757\u5316\u8bbe\u8ba1\u2014\u2014\u6bcf\u79cd\u6a21\u6001\u72ec\u7acb\u5904\u7406\u540e\u518d\u8fdb\u884c\u8de8\u6a21\u6001\u5bf9\u9f50\u3002\u540c\u65f6\uff0c\u5e94\u4f18\u5148\u6295\u8d44\u4e8e\u7edf\u4e00\u7684\u6570\u636e\u683c\u5f0f\u6807\u51c6\uff0c\u5982 WebDataset\u3001TFDS \u7b49\uff0c\u4ee5\u964d\u4f4e\u4e0b\u6e38\u5904\u7406\u7684\u590d\u6742\u5ea6\u3002\u5efa\u7acb\u6a21\u6001\u611f\u77e5\u7684\u8d28\u91cf\u8bc4\u4f30\u4f53\u7cfb\u4e5f\u81f3\u5173\u91cd\u8981\uff1a\u56fe\u7247\u9700\u8981\u7f8e\u5b66\u8bc4\u5206\u548c CLIP \u76f8\u4f3c\u5ea6\uff0c\u8bed\u97f3\u9700\u8981 ASR \u51c6\u786e\u7387\u548c\u8bf4\u8bdd\u4eba\u5206\u79bb\u8d28\u91cf\uff0cPDF \u9700\u8981 OCR \u51c6\u786e\u7387\u548c\u7248\u9762\u5206\u6790\u7cbe\u5ea6\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_32","title":"1_3.2 \u6311\u6218\u4e8c\uff1a\u7248\u6743\u5408\u89c4\u7684\u7070\u8272\u5730\u5e26","text":"<p>\u5927\u6a21\u578b\u8bad\u7ec3\u6570\u636e\u7684\u7248\u6743\u95ee\u9898\uff0c\u5df2\u4ece\u6280\u672f\u8ba8\u8bba\u6f14\u53d8\u4e3a\u6cd5\u5f8b\u6218\u573a\u30022023 \u5e74\uff0cGetty Images \u8d77\u8bc9 Stability AI\uff0c\u6307\u63a7\u5176\u672a\u7ecf\u6388\u6743\u4f7f\u7528\u6570\u767e\u4e07\u5f20\u7248\u6743\u56fe\u7247\u8bad\u7ec3 Stable Diffusion\u30022024 \u5e74\uff0c\u300a\u7ebd\u7ea6\u65f6\u62a5\u300b\u8d77\u8bc9 OpenAI \u548c Microsoft\uff0c\u6307\u63a7 GPT \u6a21\u578b\u4fb5\u72af\u7248\u6743\u3002\u591a\u56fd\u76d1\u7ba1\u673a\u6784\u5f00\u59cb\u8981\u6c42 AI \u516c\u53f8\u62ab\u9732\u8bad\u7ec3\u6570\u636e\u6765\u6e90\u3002</p> <p>\u8fd9\u4e9b\u6cd5\u5f8b\u8bc9\u8bbc\u7684\u7ed3\u679c\u5c06\u6df1\u523b\u5f71\u54cd AI \u884c\u4e1a\u7684\u53d1\u5c55\u8d70\u5411\uff0c\u4f46\u5bf9\u4e8e\u6570\u636e\u5de5\u7a0b\u5e08\u800c\u8a00\uff0c\u7b49\u5f85\u5c18\u57c3\u843d\u5b9a\u663e\u7136\u4e0d\u662f\u660e\u667a\u4e4b\u4e3e\u3002\u5f53\u524d\u7684\u5408\u89c4\u7b56\u7565\u53ef\u4ee5\u4ece\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\u7740\u624b\uff1a\u9996\u5148\u662f\u6765\u6e90\u8ffd\u6eaf\uff0c\u4e3a\u6bcf\u6761\u8bad\u7ec3\u6570\u636e\u8bb0\u5f55\u5b8c\u6574\u7684\u6765\u6e90\u5143\u4fe1\u606f\uff0c\u5305\u62ec URL\u3001\u6293\u53d6\u65f6\u95f4\u3001\u539f\u59cb\u7248\u6743\u58f0\u660e\u7b49\uff1b\u5176\u6b21\u662f\u8bb8\u53ef\u8bc1\u8fc7\u6ee4\uff0c\u4f18\u5148\u4f7f\u7528\u660e\u786e\u5141\u8bb8 AI \u8bad\u7ec3\u4f7f\u7528\u7684\u6570\u636e\uff0c\u5982 CC0\u3001CC-BY \u7b49\u5f00\u653e\u8bb8\u53ef\u8bc1\u7684\u5185\u5bb9\uff1b\u7b2c\u4e09\u662f\u9075\u5b88 robots.txt \u534f\u8bae\uff0c\u5c0a\u91cd\u7f51\u7ad9\u6240\u6709\u8005\u7684\u722c\u866b\u9650\u5236\u58f0\u660e\uff1b\u6700\u540e\u662f\u6570\u636e\u8131\u654f\uff0c\u5bf9\u6d89\u53ca\u4e2a\u4eba\u9690\u79c1\u7684\u5185\u5bb9\u8fdb\u884c\u533f\u540d\u5316\u6216\u5220\u9664\u5904\u7406\u3002</p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\"Fair Use\"\uff08\u5408\u7406\u4f7f\u7528\uff09\u5728 AI \u8bad\u7ec3\u573a\u666f\u4e0b\u7684\u8fb9\u754c\u4ecd\u4e0d\u660e\u786e\uff0c\u5404\u56fd\u6cd5\u5f8b\u7684\u9002\u7528\u6807\u51c6\u4e5f\u5b58\u5728\u5dee\u5f02\u3002\u56e0\u6b64\uff0c\u5efa\u8bae\u5728\u6570\u636e\u7ba1\u7ebf\u4e2d\u9884\u7559\u7248\u6743\u8fc7\u6ee4\u7684\u63a5\u53e3\uff0c\u4ee5\u4fbf\u5728\u6cd5\u5f8b\u73af\u5883\u660e\u786e\u540e\u80fd\u591f\u5feb\u901f\u8c03\u6574\u6570\u636e\u5904\u7406\u7b56\u7565\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_33","title":"1_3.3 \u6311\u6218\u4e09\uff1a\u7b97\u529b\u6210\u672c\u7684\"\u9690\u5f62\u6740\u624b\"","text":"<p>\u6570\u636e\u5904\u7406\u7684\u7b97\u529b\u6210\u672c\u5e38\u88ab\u4e25\u91cd\u4f4e\u4f30\u3002\u8bb8\u591a\u56e2\u961f\u5728\u9884\u7b97\u6a21\u578b\u8bad\u7ec3\u8d39\u7528\u65f6\uff0c\u53ea\u8ba1\u7b97 GPU \u8bad\u7ec3\u65f6\u95f4\uff0c\u5374\u5ffd\u7565\u4e86\u6570\u636e\u9884\u5904\u7406\u53ef\u80fd\u6d88\u8017\u540c\u7b49\u751a\u81f3\u66f4\u591a\u7684\u8d44\u6e90\u3002</p> <p>\u8003\u8651\u4e00\u4e2a\u5b9e\u9645\u573a\u666f\uff1a\u5904\u7406 10TB \u7684\u539f\u59cb\u7f51\u9875\u6570\u636e\u3002\u5047\u8bbe\u5e73\u5747\u6bcf\u6761\u6570\u636e\u9700\u8981\u7ecf\u8fc7 HTML \u89e3\u6790\u3001\u6587\u672c\u63d0\u53d6\u3001\u8bed\u8a00\u8bc6\u522b\u3001\u8d28\u91cf\u8bc4\u5206\u3001\u53bb\u91cd\u68c0\u67e5\u7b49\u4e94\u4e2a\u6b65\u9aa4\u3002\u6bcf\u4e2a\u6b65\u9aa4\u5355\u6761\u5904\u7406\u8017\u65f6 100 \u6beb\u79d2\uff08\u5df2\u7ecf\u662f\u76f8\u5f53\u5feb\u7684\u901f\u5ea6\uff09\u3002\u90a3\u4e48\u603b\u5904\u7406\u65f6\u95f4\u7ea6\u4e3a\uff1a10TB \u00f7 10KB/\u6761 \u00d7 0_5 \u79d2/\u6761 \u2248 150 \u4e07 GPU \u5c0f\u65f6\u3002\u6309\u7167\u4e91\u670d\u52a1\u5546\u7684\u5b9a\u4ef7\uff0c\u8fd9\u53ef\u80fd\u610f\u5473\u7740\u6570\u5341\u4e07\u7f8e\u5143\u7684\u6210\u672c\u2014\u2014\u4e0e\u6a21\u578b\u8bad\u7ec3\u672c\u8eab\u7684\u8d39\u7528\u76f8\u5f53\u3002</p> \u573a\u666f \u8bad\u7ec3\u6570\u636e\u91cf \u8bad\u7ec3\u6210\u672c\uff08A100 \u5c0f\u65f6\uff09 \u6a21\u578b\u6027\u80fd \u4e0d\u53bb\u91cd\uff0c\u76f4\u63a5\u8bad\u7ec3 10T Token 10,000 \u5c0f\u65f6 \u57fa\u51c6\uff08\u542b\u91cd\u590d\u5bfc\u81f4\u7684\"\u590d\u8bfb\u673a\"\u95ee\u9898\uff09 \u53bb\u91cd\u540e\u8bad\u7ec3 7T Token 7,000 \u5c0f\u65f6 \u9ad8\u4e8e\u57fa\u51c6\uff08\u91cd\u590d\u6570\u636e\u4f1a\u964d\u4f4e\u5b66\u4e60\u6548\u7387\uff09 \u51c0\u6536\u76ca - \u8282\u7701 3,000 \u5c0f\u65f6 + \u66f4\u597d\u7684\u6a21\u578b - <p>\u7136\u800c\uff0c\u6362\u4e00\u4e2a\u89d2\u5ea6\u770b\uff0c\u6570\u636e\u5de5\u7a0b\u7684\u6295\u8d44\u56de\u62a5\u7387\u53ef\u80fd\u6781\u9ad8\u3002\u4e0a\u8868\u5c55\u793a\u4e86\u4e00\u4e2a\u7b80\u5316\u7684\u6848\u4f8b\uff1a\u901a\u8fc7\u6295\u5165\u4e00\u5b9a\u8d44\u6e90\u8fdb\u884c\u6570\u636e\u53bb\u91cd\uff0c\u4e0d\u4ec5\u8282\u7701\u4e86 30% \u7684\u8bad\u7ec3\u6210\u672c\uff0c\u8fd8\u83b7\u5f97\u4e86\u66f4\u597d\u7684\u6a21\u578b\u6027\u80fd\u3002\u8fd9\u5c31\u662f\u6570\u636e\u5de5\u7a0b\u7684\"\u6760\u6746\u6548\u5e94\"\u2014\u2014\u5728\u5f53\u524d\u7b97\u529b\u4ef7\u683c\u4e0b\uff08A100 \u7ea6 $2/\u5c0f\u65f6\uff09\uff0c1 \u5c0f\u65f6\u6570\u636e\u5904\u7406\u5de5\u4f5c\u5982\u679c\u80fd\u51cf\u5c11 10 \u5c0f\u65f6\u65e0\u6548\u8bad\u7ec3\uff0c\u5c31\u662f 20 \u500d\u7684\u6295\u8d44\u56de\u62a5\u7387\u3002</p> <p></p> <p>\u56fe1-5\uff1a\u6570\u636e\u8d28\u91cf\u4e0e\u8bad\u7ec3\u6548\u7387\u5173\u7cfb \u2014\u2014 \u7eff\u8272\u66f2\u7ebf\uff08\u7cbe\u9009\u6570\u636e\uff09\u6548\u7387\u6700\u9ad8\uff0c30-70%\u8d28\u91cf\u533a\u95f4 ROI \u6700\u5927</p>"},{"location":"chapter1/1_1_data_change/#1_34","title":"1_3.4 \u673a\u9047\uff1a\u4e09\u5927\u8d8b\u52bf\u6b63\u5728\u964d\u4f4e\u95e8\u69db","text":"<p>\u5c3d\u7ba1\u6311\u6218\u91cd\u91cd\uff0c\u4f46\u5bf9\u4e8e\u6570\u636e\u5de5\u7a0b\u5e08\u800c\u8a00\uff0c\u5f53\u4e0b\u6b63\u662f\u5165\u573a\u7684\u9ec4\u91d1\u65f6\u671f\u3002\u4e09\u5927\u8d8b\u52bf\u6b63\u5728\u663e\u8457\u964d\u4f4e\u5927\u6a21\u578b\u6570\u636e\u5de5\u7a0b\u7684\u95e8\u69db\u3002</p> <p>\u7b2c\u4e00\u4e2a\u8d8b\u52bf\u662f\u5f00\u6e90\u9ad8\u8d28\u91cf\u6570\u636e\u96c6\u7684\u6d8c\u73b0\u3002\u533a\u522b\u4e8e\u65e9\u671f\u5c01\u95ed\u7684\u5546\u4e1a\u6570\u636e\uff0c\u8fd1\u5e74\u6765\u6d8c\u73b0\u4e86\u5927\u91cf\u9ad8\u8d28\u91cf\u7684\u5f00\u6e90\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u3002HuggingFace \u7684 FineWeb \u63d0\u4f9b\u4e86\u7ecf\u8fc7\u7cbe\u5fc3\u6e05\u6d17\u7684 15T Token \u82f1\u6587\u7f51\u9875\u6570\u636e\u3002RedPajama \u5f00\u6e90\u4e86 LLaMA \u8bad\u7ec3\u6570\u636e\u7684\u5b8c\u6574\u590d\u73b0\u7248\u672c\u3002DCLM \u5219\u63d0\u4f9b\u4e86\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u4f18\u5316\u7684\u6570\u636e\u96c6\u3002\u8fd9\u4e9b\u5f00\u6e90\u6570\u636e\u96c6\u5927\u5927\u964d\u4f4e\u4e86\u4e2d\u5c0f\u56e2\u961f\u6784\u5efa\u9884\u8bad\u7ec3\u8bed\u6599\u7684\u6210\u672c\uff0c\u4f7f\u5f97\u539f\u672c\u53ea\u6709\u5927\u5382\u624d\u80fd\u4f01\u53ca\u7684\u8d44\u6e90\u53d8\u5f97\u89e6\u624b\u53ef\u53ca\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u8d8b\u52bf\u662f AI \u539f\u751f\u6570\u636e\u5de5\u5177\u7684\u6210\u719f\u3002\u4f20\u7edf\u7684\u5927\u6570\u636e\u5de5\u5177\uff08\u5982 Hadoop\u3001Spark\uff09\u867d\u7136\u6210\u719f\uff0c\u4f46\u5e76\u975e\u4e3a AI \u8bad\u7ec3\u573a\u666f\u8bbe\u8ba1\u3002\u8fd1\u5e74\u6765\uff0c\u4e00\u6279\u4e13\u4e3a LLM \u6570\u636e\u5de5\u7a0b\u6253\u9020\u7684\u5de5\u5177\u5f00\u59cb\u6210\u719f\u3002\u963f\u91cc\u5df4\u5df4\u7684 Data-Juicer \u63d0\u4f9b\u4e86\u6a21\u5757\u5316\u7684\u6570\u636e\u5904\u7406\u6d41\u6c34\u7ebf\uff0c\u5305\u542b\u6570\u5341\u79cd\u5f00\u7bb1\u5373\u7528\u7684\u6e05\u6d17\u7b97\u5b50\u3002Dolma \u662f Allen AI \u5f00\u53d1\u7684\u5927\u89c4\u6a21\u6587\u672c\u5904\u7406\u5de5\u5177\u5305\uff0c\u4e13\u95e8\u9488\u5bf9\u9884\u8bad\u7ec3\u6570\u636e\u4f18\u5316\u3002\u8fd9\u4e9b\u5de5\u5177\u7684\u51fa\u73b0\uff0c\u4f7f\u5f97\u6570\u636e\u5de5\u7a0b\u5e08\u53ef\u4ee5\u7ad9\u5728\u5de8\u4eba\u7684\u80a9\u8180\u4e0a\uff0c\u65e0\u9700\u4ece\u96f6\u5f00\u59cb\u9020\u8f6e\u5b50\u3002</p> <p>\u7b2c\u4e09\u4e2a\u8d8b\u52bf\u662f\u5408\u6210\u6570\u636e\u7684\u4e3b\u6d41\u5316\u3002\u5982\u524d\u6240\u8ff0\uff0c\u5fae\u8f6f Phi \u7cfb\u5217\u7684\u6210\u529f\u8bc1\u660e\u4e86\u5408\u6210\u6570\u636e\u7684\u5de8\u5927\u6f5c\u529b\u3002\u5982\u4eca\uff0c\u4f7f\u7528 GPT-4\u3001Claude \u7b49\u5f3a\u5927\u6a21\u578b\u751f\u6210\u8bad\u7ec3\u6570\u636e\u5df2\u6210\u4e3a\u884c\u4e1a\u5e38\u6001\u3002\u8fd9\u79cd\"\u4ee5\u5f3a\u5e26\u5f31\"\u7684\u7b56\u7565\uff0c\u4f7f\u5f97\u9ad8\u8d28\u91cf\u6570\u636e\u7684\u83b7\u53d6\u4e0d\u518d\u5b8c\u5168\u4f9d\u8d56\u4eba\u5de5\u6807\u6ce8\uff0c\u5927\u5927\u52a0\u901f\u4e86\u6570\u636e\u51c6\u5907\u7684\u6548\u7387\u3002\u7136\u800c\uff0c\u5408\u6210\u6570\u636e\u4e5f\u5e26\u6765\u4e86\u65b0\u7684\u6311\u6218\uff1a\u5982\u4f55\u907f\u514d\u6a21\u578b\u584c\u7f29\uff08Model Collapse\uff09\uff1f\u5982\u4f55\u4fdd\u8bc1\u6570\u636e\u7684\u591a\u6837\u6027\uff1f\u8fd9\u4e9b\u95ee\u9898\u6211\u4eec\u5c06\u5728\u540e\u7eed\u7ae0\u8282\u8be6\u7ec6\u63a2\u8ba8\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_4","title":"1_4 \u5e38\u89c1\u8bef\u533a\u4e0e\u907f\u5751\u6307\u5357","text":"<p>\u5728\u8fdb\u5165\u5177\u4f53\u7684\u6280\u672f\u5b9e\u8df5\u4e4b\u524d\uff0c\u6709\u5fc5\u8981\u5148\u6f84\u6e05\u51e0\u4e2a\u5e38\u89c1\u7684\u8ba4\u77e5\u8bef\u533a\u3002\u8fd9\u4e9b\u8bef\u533a\u8f7b\u5219\u5bfc\u81f4\u8d44\u6e90\u6d6a\u8d39\uff0c\u91cd\u5219\u5bfc\u81f4\u9879\u76ee\u5931\u8d25\u3002</p>"},{"location":"chapter1/1_1_data_change/#_3","title":"\u8bef\u533a\u4e00\uff1a\"\u6570\u636e\u91cf\u8d8a\u5927\u8d8a\u597d\"","text":"<p>\u8fd9\u662f\u6700\u5e38\u89c1\u4e5f\u662f\u5371\u5bb3\u6700\u5927\u7684\u8bef\u533a\u3002\u8bb8\u591a\u56e2\u961f\u5728\u9879\u76ee\u542f\u52a8\u65f6\uff0c\u7b2c\u4e00\u53cd\u5e94\u5c31\u662f\"\u722c\u53d6\u5c3d\u53ef\u80fd\u591a\u7684\u6570\u636e\"\u3002\u7136\u800c\uff0c\u5982\u524d\u6240\u8ff0\uff0c\u539f\u59cb\u6570\u636e\u7684\u4fdd\u7559\u7387\u901a\u5e38\u53ea\u6709 5-20%\u3002\u76f2\u76ee\u8ffd\u6c42\u6570\u636e\u91cf\uff0c\u610f\u5473\u7740 80% \u4ee5\u4e0a\u7684\u722c\u53d6\u3001\u5b58\u50a8\u3001\u521d\u6b65\u5904\u7406\u6210\u672c\u90fd\u662f\u6d6a\u8d39\u3002\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u5982\u679c\u540e\u7eed\u7684\u8d28\u91cf\u8fc7\u6ee4\u4e0d\u591f\u4e25\u683c\uff0c\u4f4e\u8d28\u91cf\u6570\u636e\u6df7\u5165\u8bad\u7ec3\u96c6\uff0c\u53ef\u80fd\u4f1a\u5bf9\u6a21\u578b\u6027\u80fd\u4ea7\u751f\u8d1f\u9762\u5f71\u54cd\u3002</p> <p>\u6b63\u786e\u7684\u505a\u6cd5\u662f\uff1a\u5148\u7528\u5c0f\u89c4\u6a21\u6570\u636e\u9a8c\u8bc1\u6574\u4e2a\u5904\u7406\u6d41\u6c34\u7ebf\u7684\u6709\u6548\u6027\uff0c\u786e\u8ba4\u8d28\u91cf\u6807\u51c6\u548c\u8fc7\u6ee4\u7b56\u7565\u540e\uff0c\u518d\u8fdb\u884c\u5927\u89c4\u6a21\u6570\u636e\u91c7\u96c6\u3002\"\u5148\u8d28\u91cf\u3001\u540e\u6570\u91cf\"\u5e94\u8be5\u6210\u4e3a\u6570\u636e\u5de5\u7a0b\u7684\u57fa\u672c\u539f\u5219\u3002</p>"},{"location":"chapter1/1_1_data_change/#_4","title":"\u8bef\u533a\u4e8c\uff1a\"\u4e00\u6b21\u6027\u5904\u7406\u5b8c\u6240\u6709\u6570\u636e\"","text":"<p>\u6570\u636e\u5904\u7406\u662f\u4e00\u4e2a\u8fed\u4ee3\u7684\u8fc7\u7a0b\uff0c\u800c\u975e\u4e00\u6b21\u6027\u7684\u4efb\u52a1\u3002\u6a21\u578b\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u4f1a\u66b4\u9732\u6570\u636e\u95ee\u9898\uff08\u5982\u67d0\u7c7b\u6837\u672c\u8fc7\u591a\u5bfc\u81f4\u504f\u89c1\uff09\uff0c\u8bc4\u6d4b\u7ed3\u679c\u4f1a\u6307\u5bfc\u6570\u636e\u7b5b\u9009\u7b56\u7565\uff08\u5982\u9700\u8981\u589e\u5f3a\u67d0\u9886\u57df\u6570\u636e\uff09\uff0c\u6cd5\u5f8b\u5408\u89c4\u8981\u6c42\u53ef\u80fd\u53d1\u751f\u53d8\u5316\uff08\u5982\u9700\u8981\u79fb\u9664\u67d0\u4e9b\u6765\u6e90\u7684\u6570\u636e\uff09\u3002</p> <p>\u56e0\u6b64\uff0c\u6570\u636e\u5904\u7406\u6d41\u6c34\u7ebf\u5fc5\u987b\u8bbe\u8ba1\u4e3a\u53ef\u91cd\u590d\u6267\u884c\u3001\u53ef\u589e\u91cf\u66f4\u65b0\u3001\u53ef\u56de\u6eda\u7248\u672c\u3002\u7b2c\u4e8c\u7ae0\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 DVC\u3001LakeFS \u7b49\u5de5\u5177\u5b9e\u73b0\u6570\u636e\u7248\u672c\u63a7\u5236\u3002</p>"},{"location":"chapter1/1_1_data_change/#_5","title":"\u8bef\u533a\u4e09\uff1a\"\u53ea\u5173\u6ce8\u9884\u8bad\u7ec3\u6570\u636e\"","text":"<p>\u9884\u8bad\u7ec3\u6570\u636e\u786e\u5b9e\u662f LLM \u7684\u57fa\u7840\uff0c\u4f46\u5ffd\u89c6\u540e\u7eed\u9636\u6bb5\u7684\u6570\u636e\u540c\u6837\u5371\u9669\u3002\u4e00\u4e2a\u5728\u5927\u89c4\u6a21\u8bed\u6599\u4e0a\u9884\u8bad\u7ec3\u826f\u597d\u7684\u57fa\u5ea7\u6a21\u578b\uff0c\u5982\u679c SFT \u6570\u636e\u8d28\u91cf\u4f4e\u52a3\uff0c\u6700\u7ec8\u4ea7\u51fa\u7684\u5bf9\u8bdd\u6a21\u578b\u53ef\u80fd\u8868\u73b0\u5e73\u5e73\u3002\u540c\u6837\uff0cRLHF \u9636\u6bb5\u7684\u504f\u597d\u6570\u636e\u5982\u679c\u6807\u6ce8\u4e0d\u4e00\u81f4\uff0c\u53ef\u80fd\u5bfc\u81f4\u6a21\u578b\u884c\u4e3a\u4e0d\u7a33\u5b9a\u3002</p> <p>\u5168\u751f\u547d\u5468\u671f\u7684\u6570\u636e\u8d28\u91cf\u7ba1\u7406\u540c\u7b49\u91cd\u8981\u3002\u9884\u8bad\u7ec3\u3001SFT\u3001RLHF\u3001RAG \u56db\u4e2a\u9636\u6bb5\u7684\u6570\u636e\u5e94\u8be5\u6709\u5404\u81ea\u7684\u8d28\u91cf\u6807\u51c6\u548c\u8bc4\u4f30\u4f53\u7cfb\u3002</p>"},{"location":"chapter1/1_1_data_change/#_6","title":"\u8bef\u533a\u56db\uff1a\"\u5f00\u6e90\u6570\u636e\u62ff\u6765\u5373\u7528\"","text":"<p>\u5f00\u6e90\u6570\u636e\u96c6\u6781\u5927\u5730\u964d\u4f4e\u4e86\u5165\u95e8\u95e8\u69db\uff0c\u4f46\u76f4\u63a5\u4f7f\u7528\u5f00\u6e90\u6570\u636e\u800c\u4e0d\u8fdb\u884c\u4e8c\u6b21\u5ba1\u67e5\u662f\u5371\u9669\u7684\u3002\u5f00\u6e90\u6570\u636e\u96c6\u53ef\u80fd\u5b58\u5728\u4ee5\u4e0b\u95ee\u9898\uff1a\u8fc7\u65f6\uff08\u6293\u53d6\u65f6\u95f4\u8f83\u65e9\uff0c\u4e0d\u5305\u542b\u6700\u65b0\u77e5\u8bc6\uff09\u3001\u504f\u89c1\uff08\u6570\u636e\u5206\u5e03\u4e0d\u5747\u5300\uff09\u3001\u566a\u58f0\uff08\u90e8\u5206\u6837\u672c\u8d28\u91cf\u4e0d\u8fbe\u6807\uff09\u3001\u7248\u6743\u98ce\u9669\uff08\u8bb8\u53ef\u8bc1\u4e0d\u660e\u786e\uff09\u3002</p> <p>\u6b63\u786e\u7684\u505a\u6cd5\u662f\u5c06\u5f00\u6e90\u6570\u636e\u89c6\u4e3a\"\u539f\u6750\u6599\"\u800c\u975e\"\u6210\u54c1\"\u3002\u6839\u636e\u81ea\u8eab\u4efb\u52a1\u9700\u6c42\u8fdb\u884c\u4e8c\u6b21\u8fc7\u6ee4\u3001\u589e\u5f3a\u548c\u5e73\u8861\uff0c\u624d\u80fd\u53d1\u6325\u5f00\u6e90\u6570\u636e\u7684\u6700\u5927\u4ef7\u503c\u3002</p>"},{"location":"chapter1/1_1_data_change/#1_5","title":"1_5 \u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u4ece Scaling Laws \u51fa\u53d1\uff0c\u7cfb\u7edf\u8bba\u8ff0\u4e86\u5927\u6a21\u578b\u65f6\u4ee3\u6570\u636e\u5de5\u7a0b\u7684\u6838\u5fc3\u7406\u5ff5\u3002\u6211\u4eec\u9996\u5148\u63a2\u8ba8\u4e86\"\u8d28\u91cf\u4f18\u4e8e\u6570\u91cf\"\u7684\u8303\u5f0f\u8f6c\u79fb\uff0c\u4ece Chinchilla \u7684\u6700\u4f18\u914d\u6bd4\u5230 Phi \u7cfb\u5217\u7684\u6781\u7aef\u5b9e\u9a8c\uff0c\u8bba\u8bc1\u4e86\u9ad8\u8d28\u91cf\u6570\u636e\u5bf9\u4e8e\u6a21\u578b\u6027\u80fd\u7684\u51b3\u5b9a\u6027\u4f5c\u7528\u3002</p> <p>\u968f\u540e\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86 LLM \u6570\u636e\u5168\u751f\u547d\u5468\u671f\u7684\u56db\u4e2a\u9636\u6bb5\uff1a\u9884\u8bad\u7ec3\u3001SFT\u3001RLHF \u548c RAG\u3002\u6bcf\u4e2a\u9636\u6bb5\u7684\u6570\u636e\u9700\u6c42\u622a\u7136\u4e0d\u540c\uff0c\u4ece TB \u7ea7\u7684\u65e0\u6807\u7b7e\u6587\u672c\u5230\u6570\u4e07\u6761\u7684\u504f\u597d\u5bf9\u6bd4\u6570\u636e\uff0c\u6570\u636e\u91cf\u9012\u51cf\u4f46\u8d28\u91cf\u8981\u6c42\u9012\u589e\u3002\u7406\u89e3\u8fd9\u4e2a\"\u6f0f\u6597\u6a21\u578b\"\u662f\u89c4\u5212\u6570\u636e\u8d44\u6e90\u7684\u57fa\u7840\u3002</p> <p>\u5728\u6311\u6218\u4e0e\u673a\u9047\u90e8\u5206\uff0c\u6211\u4eec\u5256\u6790\u4e86\u591a\u6a21\u6001\u590d\u6742\u6027\u3001\u7248\u6743\u5408\u89c4\u548c\u7b97\u529b\u6210\u672c\u4e09\u5927\u73b0\u5b9e\u95ee\u9898\uff0c\u540c\u65f6\u4e5f\u770b\u5230\u4e86\u5f00\u6e90\u6570\u636e\u96c6\u3001AI \u539f\u751f\u5de5\u5177\u548c\u5408\u6210\u6570\u636e\u4e09\u5927\u8d8b\u52bf\u5e26\u6765\u7684\u673a\u9047\u3002</p> <p>\u6700\u540e\uff0c\u901a\u8fc7\u6f84\u6e05\u56db\u4e2a\u5e38\u89c1\u8bef\u533a\uff0c\u6211\u4eec\u4e3a\u8bfb\u8005\u5efa\u7acb\u4e86\u6b63\u786e\u7684\u6570\u636e\u5de5\u7a0b\u601d\u7ef4\u6a21\u5f0f\uff1a\u5148\u8d28\u91cf\u540e\u6570\u91cf\u3001\u8fed\u4ee3\u800c\u975e\u4e00\u6b21\u6027\u3001\u5168\u5468\u671f\u7ba1\u7406\u3001\u5f00\u6e90\u6570\u636e\u4e8c\u6b21\u52a0\u5de5\u3002</p> <p></p> <p>\u56fe1-6\uff1a\u7b2c1\u7ae0\u77e5\u8bc6\u7ed3\u6784 \u2014\u2014 \u6db5\u76d6 Scaling Laws\u3001\u6570\u636e\u751f\u547d\u5468\u671f\u3001\u6311\u6218\u4e0e\u673a\u9047\u56db\u5927\u4e3b\u9898</p>"},{"location":"chapter1/1_1_data_change/#_7","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u6838\u5fc3\u8bba\u6587</p> <p>Kaplan \u7b49\u4eba\u4e8e 2020 \u5e74\u53d1\u8868\u7684 Scaling Laws for Neural Language Models \u662f\u7406\u89e3\u5927\u6a21\u578b\u8d44\u6e90\u914d\u7f6e\u7684\u5960\u57fa\u4e4b\u4f5c\u3002\u8fd9\u7bc7\u6765\u81ea OpenAI \u7684\u8bba\u6587\u9996\u6b21\u7cfb\u7edf\u6027\u5730\u63ed\u793a\u4e86\u6a21\u578b\u89c4\u6a21\u3001\u6570\u636e\u91cf\u548c\u8ba1\u7b97\u91cf\u4e4b\u95f4\u7684\u5e42\u5f8b\u5173\u7cfb\uff0c\u4e3a\u540e\u7eed\u7684\u5927\u6a21\u578b\u7814\u53d1\u63d0\u4f9b\u4e86\u7406\u8bba\u6307\u5bfc\u3002</p> <p>Hoffmann \u7b49\u4eba\u4e8e 2022 \u5e74\u53d1\u8868\u7684 Training Compute-Optimal Large Language Models\uff08\u5373 Chinchilla \u8bba\u6587\uff09\u6765\u81ea DeepMind\uff0c\u6307\u51fa\u4e86\u4e1a\u754c\u666e\u904d\u5b58\u5728\u7684\"\u8fc7\u5ea6\u53c2\u6570\u5316\"\u95ee\u9898\uff0c\u7ed9\u51fa\u4e86\u8ba1\u7b97\u6700\u4f18\u7684\u6a21\u578b-\u6570\u636e\u914d\u6bd4\u5efa\u8bae\u3002</p> <p>Gunasekar \u7b49\u4eba\u4e8e 2023 \u5e74\u53d1\u8868\u7684 Textbooks Are All You Need \u6765\u81ea\u5fae\u8f6f\u7814\u7a76\u9662\uff0c\u662f Phi \u7cfb\u5217\u7684\u5f00\u5c71\u4e4b\u4f5c\uff0c\u8bc1\u660e\u4e86\u9ad8\u8d28\u91cf\u5408\u6210\u6570\u636e\u53ef\u4ee5\u8ba9\u5c0f\u6a21\u578b\u5ab2\u7f8e\u5927\u6a21\u578b\u7684\u8868\u73b0\u3002</p> <p>\u5f00\u6e90\u6570\u636e\u96c6</p> <p>Penedo \u7b49\u4eba\u53d1\u5e03\u7684 FineWeb \u662f HuggingFace \u5f00\u6e90\u7684\u5927\u89c4\u6a21\u9ad8\u8d28\u91cf\u82f1\u6587\u7f51\u9875\u6570\u636e\u96c6\uff0c\u5305\u542b\u7ea6 15T Token\uff0c\u53ef\u4f5c\u4e3a\u9884\u8bad\u7ec3\u7684\u57fa\u7840\u8bed\u6599\u3002Together AI \u53d1\u5e03\u7684 RedPajama \u662f LLaMA \u8bad\u7ec3\u6570\u636e\u7684\u5f00\u6e90\u590d\u73b0\u7248\u672c\uff0c\u5bf9\u4e8e\u60f3\u8981\u590d\u73b0 LLaMA \u8bad\u7ec3\u8fc7\u7a0b\u7684\u56e2\u961f\u5177\u6709\u91cd\u8981\u53c2\u8003\u4ef7\u503c\u3002</p>"},{"location":"chapter1/1_1_data_change/#_8","title":"\u4e0b\u4e00\u7ae0\u9884\u544a","text":"<p>\u5728\u4e0b\u4e00\u7ae0\u300a\u6570\u636e\u57fa\u7840\u8bbe\u65bd\u9009\u578b\u300b\u4e2d\uff0c\u6211\u4eec\u5c06\u4ece\u7406\u5ff5\u5c42\u9762\u8fdb\u5165\u5de5\u7a0b\u5c42\u9762\u3002\u4f60\u5c06\u5b66\u4e60\u5982\u4f55\u9009\u62e9\u5408\u9002\u7684\u5b58\u50a8\u65b9\u6848\uff08S3 vs MinIO\uff09\u3001\u8ba1\u7b97\u6846\u67b6\uff08Spark vs Ray\uff09\u3001\u6570\u636e\u683c\u5f0f\uff08Parquet vs JSONL vs WebDataset\uff09\u4ee5\u53ca\u7248\u672c\u63a7\u5236\u5de5\u5177\uff08DVC vs LakeFS\uff09\u3002</p> <p>\u5e26\u7740\u8fd9\u4e2a\u95ee\u9898\u8fdb\u5165\u4e0b\u4e00\u7ae0\uff1a\u5728\u8d44\u6e90\u6709\u9650\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u4f55\u8bbe\u8ba1\u4e00\u5957\u65e2\u80fd\u652f\u6301\u5f53\u524d\u9700\u6c42\u3001\u53c8\u80fd\u5e73\u6ed1\u6269\u5c55\u7684\u6570\u636e\u57fa\u7840\u8bbe\u65bd\uff1f</p>"},{"location":"chapter1/1_2_data_infra/","title":"\u7b2c2\u7ae0\uff1a\u6570\u636e\u57fa\u7840\u8bbe\u65bd\u9009\u578b","text":""},{"location":"chapter1/1_2_data_infra/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5de5\u6b32\u5584\u5176\u4e8b\uff0c\u5fc5\u5148\u5229\u5176\u5668\u3002\u5728\u5904\u7406 TB \u7ea7\u751a\u81f3 PB \u7ea7\u7684 LLM \u8bad\u7ec3\u6570\u636e\u4e4b\u524d\uff0c\u9009\u62e9\u6b63\u786e\u7684\u57fa\u7840\u8bbe\u65bd\u662f\u51b3\u5b9a\u9879\u76ee\u6210\u8d25\u7684\u7b2c\u4e00\u6b65\u3002\u672c\u7ae0\u5c06\u4ece\u5b58\u50a8\u3001\u8ba1\u7b97\u3001\u683c\u5f0f\u3001\u7248\u672c\u63a7\u5236\u56db\u4e2a\u7ef4\u5ea6\uff0c\u7cfb\u7edf\u6027\u5730\u4ecb\u7ecd\u73b0\u4ee3\u6570\u636e\u6808\u7684\u6280\u672f\u9009\u578b\uff0c\u5e2e\u52a9\u8bfb\u8005\u5efa\u7acb\u4e00\u5957\u9ad8\u6548\u3001\u53ef\u6269\u5c55\u3001\u53ef\u590d\u73b0\u7684\u6570\u636e\u5904\u7406\u5e73\u53f0\u3002</p>"},{"location":"chapter1/1_2_data_infra/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u4f60\u521a\u52a0\u5165\u4e00\u5bb6 AI \u521d\u521b\u516c\u53f8\uff0c\u8d1f\u8d23\u642d\u5efa LLM \u9884\u8bad\u7ec3\u6570\u636e\u5904\u7406\u5e73\u53f0\u3002\u56e2\u961f\u7684\u73b0\u72b6\u4ee4\u4eba\u62c5\u5fe7\uff1a\u6570\u636e\u6563\u843d\u5728 50 \u53f0\u673a\u5668\u7684\u672c\u5730\u786c\u76d8\u4e0a\uff0c\u683c\u5f0f\u4e94\u82b1\u516b\u95e8\uff0c\u5305\u62ec <code>.txt</code>\u3001<code>.json</code>\u3001<code>.csv</code>\u3001<code>.parquet</code> \u7b49\u5404\u79cd\u7c7b\u578b\u3002\u6bcf\u6b21\u5904\u7406\u6570\u636e\uff0c\u90fd\u8981\u624b\u52a8\u7f16\u5199 Python \u811a\u672c\uff0c\u5728\u5355\u673a\u4e0a\u8fd0\u884c\u4e09\u5929\u624d\u80fd\u8dd1\u5b8c\u3002\u4e0a\u5468\u6709\u4eba\u4e0d\u5c0f\u5fc3\u8986\u76d6\u4e86\u4e00\u4e2a\u5173\u952e\u6570\u636e\u96c6\uff0c\u800c\u8fd9\u4efd\u6570\u636e\u6ca1\u6709\u4efb\u4f55\u5907\u4efd\u548c\u7248\u672c\u8bb0\u5f55\u3002\u8001\u677f\u95ee\u4f60\uff1a\"\u4e00\u4e2a\u6708\u540e\u6211\u4eec\u8981\u5f00\u59cb\u8bad\u7ec3\uff0c\u6570\u636e\u5e73\u53f0\u80fd\u4e0d\u80fd ready\uff1f\"</p> <p>\u4f60\u9762\u4e34\u7684\u7b2c\u4e00\u4e2a\u51b3\u7b56\u662f\uff1a\u662f\u7528\u56e2\u961f\u719f\u6089\u7684 Spark\uff0c\u8fd8\u662f\u8f6c\u5411\u53f7\u79f0\"AI \u539f\u751f\"\u7684 Ray\uff1f\u662f\u81ea\u5efa MinIO \u96c6\u7fa4\uff0c\u8fd8\u662f\u76f4\u63a5\u4e0a\u4e91\u7528 S3\uff1f\u8fd9\u4e9b\u95ee\u9898\u6ca1\u6709\"\u6807\u51c6\u7b54\u6848\"\uff0c\u4f46\u6709\u660e\u786e\u7684\u51b3\u7b56\u6846\u67b6\u3002\u672c\u7ae0\u5c06\u4e3a\u4f60\u63d0\u4f9b\u8fd9\u4e2a\u6846\u67b6\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_1-modern-data-stack","title":"2_1 \u73b0\u4ee3\u6570\u636e\u6808 (Modern Data Stack)","text":""},{"location":"chapter1/1_2_data_infra/#2_11","title":"2_1.1 \u4ec0\u4e48\u662f\u73b0\u4ee3\u6570\u636e\u6808\uff1f","text":"<p>\"\u73b0\u4ee3\u6570\u636e\u6808\"\uff08Modern Data Stack, MDS\uff09\u662f\u8fd1\u5e74\u6765\u6570\u636e\u5de5\u7a0b\u9886\u57df\u7684\u70ed\u95e8\u6982\u5ff5\uff0c\u6307\u7684\u662f\u4e00\u5957\u4e91\u539f\u751f\u3001\u6a21\u5757\u5316\u3001\u89e3\u8026\u5408\u7684\u6570\u636e\u57fa\u7840\u8bbe\u65bd\u7ec4\u5408\u3002\u4e0e\u4f20\u7edf\u7684\u4e00\u4f53\u5316\u6570\u636e\u5e73\u53f0\u76f8\u6bd4\uff0c\u73b0\u4ee3\u6570\u636e\u6808\u7684\u6838\u5fc3\u7406\u5ff5\u662f\u5c06\u5b58\u50a8\u3001\u8ba1\u7b97\u3001\u7f16\u6392\u7b49\u529f\u80fd\u62c6\u5206\u5230\u72ec\u7acb\u7684\u7ec4\u4ef6\u4e2d\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u72ec\u7acb\u66ff\u6362\u548c\u6269\u5c55\u3002</p> <p></p> <p>\u56fe2-1\uff1a\u73b0\u4ee3\u6570\u636e\u6808\u67b6\u6784 \u2014\u2014 \u4ece\u5b58\u50a8\u5c42\u5230\u5e94\u7528\u5c42\u76845\u5c42\u89e3\u8026\u67b6\u6784\uff0c\u6bcf\u5c42\u53ef\u72ec\u7acb\u66ff\u6362</p> <p>\u4f20\u7edf\u6570\u636e\u5e73\u53f0\u5f80\u5f80\u90e8\u7f72\u5728\u672c\u5730\u673a\u623f\uff0c\u91c7\u7528\u4e00\u4f53\u5316\u7cfb\u7edf\uff0c\u5b58\u50a8\u4e0e\u8ba1\u7b97\u7d27\u5bc6\u7ed1\u5b9a\u3002\u4ee5 Hadoop \u751f\u6001\u4e3a\u4f8b\uff0cHDFS \u4e0e MapReduce \u7684\u8026\u5408\u4f7f\u5f97\u66f4\u6362\u4efb\u4f55\u4e00\u4e2a\u7ec4\u4ef6\u90fd\u975e\u5e38\u56f0\u96be\u3002\u6570\u636e\u683c\u5f0f\u4e5f\u5e38\u5e38\u662f\u79c1\u6709\u7684\uff0c\u5bfc\u81f4\u4e25\u91cd\u7684\u5382\u5546\u9501\u5b9a\u95ee\u9898\u3002\u6269\u5c55\u65b9\u5f0f\u4ee5\u5782\u76f4\u6269\u5c55\u4e3a\u4e3b\uff0c\u5373\u901a\u8fc7\u8d2d\u4e70\u66f4\u5f3a\u5927\u7684\u5355\u673a\u6765\u63d0\u5347\u6027\u80fd\uff0c\u524d\u671f\u6295\u5165\u6210\u672c\u9ad8\u6602\u3002</p> \u7279\u5f81 \u4f20\u7edf\u65b9\u6848 \u73b0\u4ee3\u6570\u636e\u6808 \u90e8\u7f72\u6a21\u5f0f \u672c\u5730\u673a\u623f\uff0c\u4e00\u4f53\u5316\u7cfb\u7edf \u4e91\u539f\u751f\uff0c\u6309\u9700\u5f39\u6027\u4f38\u7f29 \u7ec4\u4ef6\u8026\u5408 \u5b58\u50a8\u8ba1\u7b97\u7ed1\u5b9a\uff08\u5982 HDFS + MapReduce\uff09 \u5b58\u50a8\u8ba1\u7b97\u5206\u79bb\uff0c\u5404\u5c42\u53ef\u72ec\u7acb\u66ff\u6362 \u6570\u636e\u683c\u5f0f \u79c1\u6709\u683c\u5f0f\u3001\u5382\u5546\u9501\u5b9a \u5f00\u653e\u683c\u5f0f\uff08Parquet\u3001ORC\uff09 \u6269\u5c55\u6027 \u5782\u76f4\u6269\u5c55\u4e3a\u4e3b \u6c34\u5e73\u6269\u5c55\uff0c\u8fd1\u4e4e\u65e0\u9650 \u6210\u672c\u6a21\u5f0f \u56fa\u5b9a\u6295\u5165\uff0c\u524d\u671f\u6210\u672c\u9ad8 \u6309\u7528\u91cf\u4ed8\u8d39\uff0c\u5f39\u6027\u6210\u672c <p>\u73b0\u4ee3\u6570\u636e\u6808\u7684\u51fa\u73b0\u6539\u53d8\u4e86\u8fd9\u4e00\u5c40\u9762\u3002\u4e91\u539f\u751f\u7684\u90e8\u7f72\u6a21\u5f0f\u5141\u8bb8\u6309\u9700\u5f39\u6027\u4f38\u7f29\uff0c\u5b58\u50a8\u4e0e\u8ba1\u7b97\u5b8c\u5168\u5206\u79bb\u4f7f\u5f97\u5404\u5c42\u53ef\u4ee5\u72ec\u7acb\u6f14\u8fdb\u3002\u5f00\u653e\u7684\u6570\u636e\u683c\u5f0f\uff08\u5982 Parquet\u3001ORC\uff09\u6d88\u9664\u4e86\u5382\u5546\u9501\u5b9a\u98ce\u9669\u3002\u6c34\u5e73\u6269\u5c55\u80fd\u529b\u4f7f\u5f97\u7cfb\u7edf\u53ef\u4ee5\u5904\u7406\u8fd1\u4e4e\u65e0\u9650\u7684\u6570\u636e\u91cf\uff0c\u800c\u6309\u7528\u91cf\u4ed8\u8d39\u7684\u6210\u672c\u6a21\u5f0f\u5219\u5927\u5927\u964d\u4f4e\u4e86\u9879\u76ee\u542f\u52a8\u7684\u95e8\u69db\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_12","title":"2_1.2 \u5b58\u50a8\u5c42\uff1a\u5bf9\u8c61\u5b58\u50a8\u4e0e\u6570\u636e\u6e56","text":"<p>\u5bf9\u8c61\u5b58\u50a8\u662f\u73b0\u4ee3\u6570\u636e\u5e73\u53f0\u7684\u4e8b\u5b9e\u6807\u51c6\u5e95\u5ea7\u3002\u65e0\u8bba\u662f AWS S3\u3001Google Cloud Storage\u3001Azure Blob\uff0c\u8fd8\u662f\u5f00\u6e90\u7684 MinIO\uff0c\u5b83\u4eec\u7684\u6838\u5fc3\u7406\u5ff5\u76f8\u540c\uff1a\u91c7\u7528\u6241\u5e73\u5316\u547d\u540d\u7a7a\u95f4\uff0c\u6ca1\u6709\u771f\u6b63\u7684\u76ee\u5f55\u5c42\u7ea7\uff0c\u53ea\u6709 <code>bucket/key</code> \u7684\u4e8c\u5143\u7ed3\u6784\uff1b\u7406\u8bba\u4e0a\u53ef\u5b58\u50a8\u65e0\u9650\u6570\u636e\uff1b\u63d0\u4f9b\u6781\u9ad8\u7684\u6570\u636e\u6301\u4e45\u6027\uff08S3 \u58f0\u79f0\u8fbe\u5230 11 \u4e2a 9\uff0c\u5373 99_999999999%\uff09\uff1b\u6309\u7167\u5b9e\u9645\u4f7f\u7528\u91cf\u8ba1\u8d39\uff0c\u65e0\u9700\u524d\u671f\u5927\u989d\u6295\u5165\u3002</p> <p>\u5728\u5177\u4f53\u9009\u578b\u65f6\uff0c\u9700\u8981\u8003\u8651\u90e8\u7f72\u6a21\u5f0f\u3001\u517c\u5bb9\u6027\u3001\u6210\u672c\u7b49\u591a\u4e2a\u56e0\u7d20\u3002AWS S3 \u662f\u516c\u6709\u4e91\u6258\u7ba1\u7684\u6807\u6746\u4ea7\u54c1\uff0c\u751f\u6001\u6700\u4e3a\u6210\u719f\uff0c\u9002\u5408\u7edd\u5927\u591a\u6570\u751f\u4ea7\u73af\u5883\u3002MinIO \u662f S3 \u517c\u5bb9\u7684\u5f00\u6e90\u66ff\u4ee3\u65b9\u6848\uff0c\u9002\u5408\u6709\u6570\u636e\u5408\u89c4\u8981\u6c42\u9700\u8981\u79c1\u6709\u90e8\u7f72\u7684\u573a\u666f\uff0c\u6216\u7528\u4e8e\u5f00\u53d1\u6d4b\u8bd5\u73af\u5883\u3002Google Cloud Storage \u548c Azure Blob \u5206\u522b\u9002\u5408\u5df2\u7ecf\u6df1\u5ea6\u4f7f\u7528 GCP \u6216 Azure \u751f\u6001\u7684\u7528\u6237\u3002</p> \u7279\u6027 AWS S3 MinIO Google GCS Azure Blob \u90e8\u7f72\u6a21\u5f0f \u516c\u6709\u4e91\u6258\u7ba1 \u81ea\u5efa/\u79c1\u6709\u4e91 \u516c\u6709\u4e91\u6258\u7ba1 \u516c\u6709\u4e91\u6258\u7ba1 S3 \u517c\u5bb9\u6027 \u539f\u751f 100% \u517c\u5bb9 \u9700\u9002\u914d\u5c42 \u9700\u9002\u914d\u5c42 \u51b7\u70ed\u5206\u5c42 Glacier Tiering Nearline/Coldline Cool/Archive \u6700\u4f4e\u6210\u672c $0_023/GB/\u6708 \u786c\u4ef6\u6210\u672c $0_020/GB/\u6708 $0_018/GB/\u6708 \u9002\u7528\u573a\u666f \u751f\u4ea7\u73af\u5883\u9996\u9009 \u79c1\u6709\u90e8\u7f72/\u5f00\u53d1\u6d4b\u8bd5 GCP \u751f\u6001\u7528\u6237 Azure \u751f\u6001\u7528\u6237 <p>\u5bf9\u8c61\u5b58\u50a8\u89e3\u51b3\u4e86\"\u5b58\u50a8\"\u95ee\u9898\uff0c\u4f46\u7f3a\u4e4f\u4e8b\u52a1\u6027\u548c\u5143\u6570\u636e\u7ba1\u7406\u80fd\u529b\u3002\u76f4\u63a5\u5728 S3 \u4e0a\u64cd\u4f5c Parquet \u6587\u4ef6\u4f1a\u9047\u5230\u8bf8\u591a\u56f0\u96be\uff1a\u65e0\u6cd5\u8fdb\u884c ACID \u4e8b\u52a1\uff0c\u5e76\u53d1\u5199\u5165\u53ef\u80fd\u635f\u574f\u6570\u636e\uff1b\u65e0\u6cd5\u9ad8\u6548\u67e5\u8be2\uff0c\u6bcf\u6b21\u90fd\u8981\u626b\u63cf\u6240\u6709\u6587\u4ef6\u7684\u5143\u6570\u636e\uff1b\u65e0\u6cd5\u8fdb\u884c\u65f6\u95f4\u65c5\u884c\uff0c\u4e00\u65e6\u6570\u636e\u88ab\u8986\u76d6\u5c31\u65e0\u6cd5\u56de\u6eda\u5230\u5386\u53f2\u7248\u672c\u3002</p> <p>\u6570\u636e\u6e56\u8868\u683c\u5f0f\uff08Table Format\uff09\u6b63\u662f\u4e3a\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u800c\u751f\u3002\u5b83\u5728\u5bf9\u8c61\u5b58\u50a8\u4e4b\u4e0a\u589e\u52a0\u4e86\u4e00\u5c42\u5143\u6570\u636e\u7ba1\u7406\uff0c\u63d0\u4f9b\u4e86\u6570\u636e\u4ed3\u5e93\u7ea7\u522b\u7684\u80fd\u529b\u3002Apache Iceberg\u3001Apache Hudi \u548c Delta Lake \u662f\u76ee\u524d\u6700\u4e3b\u6d41\u7684\u4e09\u79cd\u6570\u636e\u6e56\u683c\u5f0f\u3002</p> <p></p> <p>\u56fe2-2\uff1a\u6570\u636e\u6e56\u4ed3\u67b6\u6784 \u2014\u2014 \u8868\u683c\u5f0f\u5c42\u63d0\u4f9bACID\u4e8b\u52a1\u3001\u65f6\u95f4\u65c5\u884c\u3001Schema\u6f14\u8fdb\u7b49\u80fd\u529b</p> <p>Apache Iceberg \u7531 Netflix \u5f00\u53d1\u5e76\u8d21\u732e\u7ed9 Apache \u57fa\u91d1\u4f1a\uff0c\u6700\u5927\u7684\u4f18\u52bf\u662f\u5f15\u64ce\u4e2d\u7acb\u6027\u2014\u2014\u5b83\u53ef\u4ee5\u4e0e Spark\u3001Flink\u3001Trino\u3001Dremio\u3001DuckDB \u7b49\u591a\u79cd\u8ba1\u7b97\u5f15\u64ce\u826f\u597d\u914d\u5408\u3002\u5bf9\u4e8e LLM \u6570\u636e\u5de5\u7a0b\u573a\u666f\uff0cIceberg \u662f\u6700\u63a8\u8350\u7684\u9009\u62e9\u3002Apache Hudi \u7531 Uber \u5f00\u53d1\uff0c\u7279\u70b9\u662f\u5bf9\u6d41\u6279\u4e00\u4f53\u548c\u5b9e\u65f6\u66f4\u65b0\u7684\u652f\u6301\u8f83\u597d\uff0c\u5982\u679c\u6709\u5927\u91cf\u5b9e\u65f6\u66f4\u65b0\u9700\u6c42\uff08\u5982 RAG \u77e5\u8bc6\u5e93\u7684\u6301\u7eed\u66f4\u65b0\uff09\uff0c\u53ef\u4ee5\u8003\u8651 Hudi\u3002Delta Lake \u7531 Databricks \u5f00\u53d1\uff0c\u4e0e Spark \u7684\u96c6\u6210\u6700\u4e3a\u7d27\u5bc6\uff0c\u5982\u679c\u5df2\u7ecf\u6df1\u5ea6\u4f7f\u7528 Databricks \u751f\u6001\uff0c\u9009\u62e9 Delta Lake \u53ef\u4ee5\u83b7\u5f97\u6700\u4f73\u4f53\u9a8c\u3002</p> \u7279\u6027 Apache Iceberg Apache Hudi Delta Lake \u80cc\u540e\u5382\u5546 Netflix \u2192 Apache Uber \u2192 Apache Databricks \u5f00\u6e90\u7a0b\u5ea6 \u5b8c\u5168\u5f00\u6e90 \u5b8c\u5168\u5f00\u6e90 \u6838\u5fc3\u5f00\u6e90\uff0c\u90e8\u5206\u529f\u80fd\u5546\u4e1a \u5f15\u64ce\u517c\u5bb9\u6027 Spark, Flink, Trino, DuckDB Spark, Flink, Presto \u4e3b\u8981 Spark \u9002\u7528\u573a\u666f \u591a\u5f15\u64ce\u6df7\u7528\u3001\u5382\u5546\u4e2d\u7acb \u6d41\u6279\u4e00\u4f53\u3001\u5b9e\u65f6\u66f4\u65b0 Databricks \u751f\u6001\u7528\u6237 <p>\u5728\u5b9e\u9645\u9009\u578b\u65f6\uff0c\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u51b3\u7b56\u6811\u8fdb\u884c\uff1a\u9996\u5148\u5224\u65ad\u6570\u636e\u89c4\u6a21\u662f\u5426\u8d85\u8fc7 100TB\u3002\u5982\u679c\u8d85\u8fc7\uff0c\u8fdb\u4e00\u6b65\u8003\u8651\u662f\u5426\u9700\u8981 ACID \u4e8b\u52a1\u548c\u65f6\u95f4\u65c5\u884c\u80fd\u529b\u2014\u2014\u5982\u679c\u9700\u8981\uff0c\u4e14\u6709\u591a\u5f15\u64ce\u8bbf\u95ee\u9700\u6c42\uff0c\u63a8\u8350 Iceberg + S3\uff1b\u5982\u679c\u53ea\u7528 Spark\uff0c\u53ef\u4ee5\u9009\u62e9 Delta Lake \u6216 Hudi\u3002\u5982\u679c\u4e0d\u9700\u8981 ACID \u80fd\u529b\uff0c\u76f4\u63a5\u4f7f\u7528 S3/MinIO + Parquet \u5373\u53ef\u3002\u5bf9\u4e8e\u6570\u636e\u91cf\u5728 100TB \u4ee5\u4e0b\u7684\u573a\u666f\uff0c\u5982\u679c\u56e2\u961f\u89c4\u6a21\u8f83\u5c0f\uff08\u5c11\u4e8e 5 \u4eba\uff09\uff0c\u672c\u5730\u78c1\u76d8 + Parquet \u8db3\u4ee5\u6ee1\u8db3\u539f\u578b\u9a8c\u8bc1\u9700\u6c42\uff1b\u968f\u7740\u89c4\u6a21\u589e\u957f\uff0c\u518d\u9010\u6b65\u8fc1\u79fb\u5230 S3 + Parquet \u7684\u65b9\u6848\u3002</p> <p></p> <p>\u56fe2-3\uff1a\u5b58\u50a8\u5c42\u9009\u578b\u51b3\u7b56\u6811 \u2014\u2014 \u6839\u636e\u6570\u636e\u89c4\u6a21\u3001ACID\u9700\u6c42\u3001\u591a\u5f15\u64ce\u8bbf\u95ee\u7b49\u56e0\u7d20\u9009\u62e9\u6700\u4f73\u65b9\u6848</p>"},{"location":"chapter1/1_2_data_infra/#2_13-spark-vs-ray-data","title":"2_1.3 \u8ba1\u7b97\u5c42\uff1aSpark vs Ray Data","text":"<p>\u8fd9\u662f LLM \u6570\u636e\u5de5\u7a0b\u4e2d\u6700\u5e38\u89c1\u7684\"\u4e8c\u9009\u4e00\"\u96be\u9898\u3002\u4e24\u8005\u90fd\u662f\u5206\u5e03\u5f0f\u8ba1\u7b97\u6846\u67b6\uff0c\u4f46\u8bbe\u8ba1\u54f2\u5b66\u548c\u9002\u7528\u573a\u666f\u622a\u7136\u4e0d\u540c\u3002\u7406\u89e3\u5b83\u4eec\u7684\u5dee\u5f02\uff0c\u5bf9\u4e8e\u505a\u51fa\u6b63\u786e\u7684\u6280\u672f\u9009\u578b\u81f3\u5173\u91cd\u8981\u3002</p> <p>Apache Spark \u8bde\u751f\u4e8e 2009 \u5e74\u7684 Berkeley AMPLab\uff0c\u7ecf\u8fc7\u5341\u4e94\u5e74\u53d1\u5c55\uff0c\u5df2\u6210\u4e3a\u5927\u6570\u636e\u5904\u7406\u7684\"\u745e\u58eb\u519b\u5200\"\u3002Spark \u7684\u6838\u5fc3\u4f18\u52bf\u5728\u4e8e\u5176\u6210\u719f\u7a33\u5b9a\u2014\u2014\u7ecf\u8fc7 PB \u7ea7\u751f\u4ea7\u9a8c\u8bc1\uff0c\u6587\u6863\u548c\u793e\u533a\u8d44\u6e90\u6781\u5176\u4e30\u5bcc\u3002Spark SQL \u7684\u5b58\u5728\u4f7f\u5f97\u6570\u636e\u5206\u6790\u5e08\u4e5f\u80fd\u7f16\u5199\u5206\u5e03\u5f0f\u5904\u7406\u903b\u8f91\uff0c\u964d\u4f4e\u4e86\u4f7f\u7528\u95e8\u69db\u3002Structured Streaming \u652f\u6301\u5b9e\u65f6\u6570\u636e\u5904\u7406\uff0c\u5b9e\u73b0\u4e86\u6d41\u6279\u4e00\u4f53\u3002\u7136\u800c\uff0cSpark \u4e5f\u6709\u660e\u663e\u7684\u52a3\u52bf\uff1a\u7531\u4e8e\u6838\u5fc3\u662f JVM \u5b9e\u73b0\uff0cPython UDF \u9700\u8981\u8de8 JVM-Python \u5e8f\u5217\u5316\uff0c\u6027\u80fd\u635f\u8017\u8f83\u5927\uff1b\u5bf9 GPU \u548c PyTorch/TensorFlow \u7684\u96c6\u6210\u652f\u6301\u8f83\u5f31\uff0c\u4e0d\u591f\"AI \u539f\u751f\"\uff1b\u7b97\u5b50\u4e4b\u95f4\u5fc5\u987b\u7269\u5316\u4e2d\u95f4\u7ed3\u679c\uff0c\u5185\u5b58\u538b\u529b\u8f83\u5927\u3002</p> <p>Ray \u8bde\u751f\u4e8e 2017 \u5e74\u7684 Berkeley RISELab\uff0c\u6700\u521d\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u5f3a\u5316\u5b66\u4e60\u6846\u67b6\uff0c\u540e\u6f14\u53d8\u4e3a\u901a\u7528\u7684 AI \u5e94\u7528\u57fa\u7840\u8bbe\u65bd\u3002Ray Data \u662f\u5176\u6570\u636e\u5904\u7406\u6a21\u5757\uff0c\u4e13\u4e3a AI \u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u8ba1\u3002Ray Data \u7684\u6838\u5fc3\u4f18\u52bf\u5728\u4e8e Python \u539f\u751f\u2014\u2014\u6ca1\u6709 JVM \u5f00\u9500\uff0c\u4e0e PyTorch\u3001HuggingFace \u7b49 AI \u751f\u6001\u65e0\u7f1d\u96c6\u6210\u3002\u5b83\u5929\u7136\u652f\u6301\u6d41\u6c34\u7ebf\u5f0f\u6267\u884c\uff0c\u5185\u5b58\u6548\u7387\u9ad8\uff1b\u5185\u7f6e GPU \u8c03\u5ea6\uff0c\u8f7b\u677e\u8c03\u7528 CUDA \u7b97\u5b50\uff1bActor \u6a21\u578b\u9002\u5408\u6709\u72b6\u6001\u7684\u590d\u6742\u5904\u7406\uff0c\u5982\u9700\u8981\u52a0\u8f7d ML \u6a21\u578b\u7684\u63a8\u7406\u4efb\u52a1\u3002\u4e0d\u8fc7\uff0cRay \u76f8\u5bf9\u5e74\u8f7b\uff0c\u6587\u6863\u548c\u6700\u4f73\u5b9e\u8df5\u4e0d\u5982 Spark \u4e30\u5bcc\uff1bSQL \u652f\u6301\u8f83\u5f31\uff0c\u6ca1\u6709 Spark SQL \u90a3\u6837\u6210\u719f\u7684 SQL \u63a5\u53e3\uff1b\u4e0e\u4f20\u7edf\u5927\u6570\u636e\u751f\u6001\uff08Hive\u3001Iceberg\uff09\u7684\u96c6\u6210\u9700\u8981\u989d\u5916\u5de5\u4f5c\u3002</p> \u7ef4\u5ea6 Apache Spark Ray Data \u8bed\u8a00 Scala/Java \u6838\u5fc3\uff0cPython API Python \u539f\u751f \u8fd0\u884c\u65f6 JVM Python (Arrow-based) \u6570\u636e\u62bd\u8c61 DataFrame (\u6279\u5904\u7406\u601d\u7ef4) Dataset (\u6d41\u5904\u7406\u601d\u7ef4) GPU \u652f\u6301 \u9700\u8981 RAPIDS \u63d2\u4ef6 \u539f\u751f\u652f\u6301 PyTorch \u96c6\u6210 \u7e41\u7410 \u4e00\u7b49\u516c\u6c11 SQL \u652f\u6301 \u975e\u5e38\u6210\u719f \u6709\u9650 \u5178\u578b\u7528\u6237 \u4f20\u7edf\u5927\u6570\u636e\u56e2\u961f AI/ML \u56e2\u961f <p>\u4e3a\u4e86\u66f4\u76f4\u89c2\u5730\u7406\u89e3\u4e24\u8005\u7684\u5dee\u5f02\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e2a\u5177\u4f53\u7684\u4ee3\u7801\u5bf9\u6bd4\u3002\u5047\u8bbe\u4efb\u52a1\u662f\uff1a\u8bfb\u53d6 Parquet \u6587\u4ef6\uff0c\u8fc7\u6ee4\u77ed\u6587\u672c\uff0c\u8ba1\u7b97\u6587\u672c\u957f\u5ea6\uff0c\u4fdd\u5b58\u7ed3\u679c\u3002</p> <p>\u4f7f\u7528 Spark \u5b9e\u73b0\uff1a</p> <pre><code>from pyspark.sql import SparkSession\nfrom pyspark.sql.functions import length, col\n\n# \u521d\u59cb\u5316 Spark Session\nspark = SparkSession.builder \\\n    .appName(\"TextFilter\") \\\n    .config(\"spark.executor.memory\", \"8g\") \\\n    .getOrCreate()\n\n# \u8bfb\u53d6 \u2192 \u8fc7\u6ee4 \u2192 \u8ba1\u7b97 \u2192 \u4fdd\u5b58\ndf = spark.read.parquet(\"s3://my-bucket/raw_data/\")\ndf_filtered = df.filter(length(col(\"text\")) &gt; 100) \\\n                .withColumn(\"text_length\", length(col(\"text\")))\ndf_filtered.write.parquet(\"s3://my-bucket/processed_data/\")\n\nspark.stop()\n</code></pre> <p>\u4f7f\u7528 Ray Data \u5b9e\u73b0\uff1a</p> <pre><code>import ray\n\n# \u521d\u59cb\u5316 Ray\uff08\u81ea\u52a8\u68c0\u6d4b\u96c6\u7fa4\u8d44\u6e90\uff09\nray.init()\n\n# \u5b9a\u4e49\u5904\u7406\u51fd\u6570\ndef filter_and_compute(batch):\n    mask = batch[\"text\"].str.len() &gt; 100\n    filtered = batch[mask].copy()\n    filtered[\"text_length\"] = filtered[\"text\"].str.len()\n    return filtered\n\n# \u8bfb\u53d6 \u2192 \u5904\u7406 \u2192 \u4fdd\u5b58\uff08\u6d41\u6c34\u7ebf\u6267\u884c\uff09\nds = ray.data.read_parquet(\"s3://my-bucket/raw_data/\")\nds_processed = ds.map_batches(filter_and_compute, batch_format=\"pandas\")\nds_processed.write_parquet(\"s3://my-bucket/processed_data/\")\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cSpark \u9700\u8981\u663e\u5f0f\u914d\u7f6e Executor \u5185\u5b58\uff0c\u4f7f\u7528\u58f0\u660e\u5f0f DataFrame API\uff1b\u800c Ray \u81ea\u52a8\u53d1\u73b0\u8d44\u6e90\uff0c\u4f7f\u7528\u51fd\u6570\u5f0f <code>map_batches</code> \u63a5\u53e3\u3002Spark \u4e2d\u7684\u81ea\u5b9a\u4e49\u903b\u8f91\u9700\u8981\u5b9a\u4e49 UDF\uff0c\u5b58\u5728\u5e8f\u5217\u5316\u5f00\u9500\uff1bRay \u4e2d\u76f4\u63a5\u4f7f\u7528\u666e\u901a Python \u51fd\u6570\uff0c\u66f4\u52a0\u81ea\u7136\u3002</p> <p></p> <p>\u56fe2-4\uff1a\u8ba1\u7b97\u6846\u67b6\u9009\u578b\u51b3\u7b56\u6811 \u2014\u2014 Spark\u9002\u5408SQL/ETL\u573a\u666f\uff0cRay\u9002\u5408GPU/ML\u573a\u666f</p> <p>\u5728\u5b9e\u9645\u51b3\u7b56\u65f6\uff0c\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u903b\u8f91\u8fdb\u884c\uff1a\u5982\u679c\u6570\u636e\u5904\u7406\u9700\u8981\u4f7f\u7528 GPU\uff08\u5982\u8c03\u7528 BERT \u6a21\u578b\u8fdb\u884c\u8d28\u91cf\u8bc4\u5206\uff09\uff0cRay Data \u662f\u66f4\u81ea\u7136\u7684\u9009\u62e9\u3002\u5982\u679c\u6709\u5927\u91cf SQL \u548c BI \u67e5\u8be2\u9700\u6c42\uff0cSpark \u7684 SQL \u751f\u6001\u66f4\u4e3a\u6210\u719f\u3002\u5982\u679c\u5df2\u6709\u5927\u91cf Spark \u57fa\u7840\u8bbe\u65bd\u548c\u4ee3\u7801\u8d44\u4ea7\uff0c\u9700\u8981\u8bc4\u4f30\u8fc1\u79fb\u6210\u672c\u2014\u2014\u6210\u672c\u9ad8\u5219\u4fdd\u7559 Spark\uff0c\u6210\u672c\u4f4e\u53ef\u8003\u8651\u9010\u6b65\u5f15\u5165 Ray\u3002\u5982\u679c\u662f\u65b0\u9879\u76ee\uff0c\u56e2\u961f\u80cc\u666f\u662f\u51b3\u5b9a\u6027\u56e0\u7d20\uff1a\u4f20\u7edf\u5927\u6570\u636e\u56e2\u961f\u9009 Spark \u66f4\u5bb9\u6613\u4e0a\u624b\uff0cAI/ML \u56e2\u961f\u9009 Ray \u66f4\u52a0\u987a\u7545\u3002</p> <p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5728\u5b9e\u9645\u5927\u578b\u9879\u76ee\u4e2d\uff0cSpark \u548c Ray \u5f80\u5f80\u5171\u5b58\u800c\u975e\u4e92\u65a5\u3002\u4e00\u79cd\u5e38\u89c1\u7684\u6df7\u5408\u7b56\u7565\u662f\uff1aSpark \u8d1f\u8d23\u4e0e\u6570\u636e\u6e56/\u6570\u636e\u4ed3\u5e93\u7684\u4ea4\u4e92\uff0c\u5305\u62ec\u8bfb\u5199 Iceberg/Hive \u8868\u3001\u6267\u884c SQL \u5206\u6790\u7b49 ETL \u4efb\u52a1\uff1bRay Data \u8d1f\u8d23 ML \u5bc6\u96c6\u578b\u5904\u7406\uff0c\u5982\u8c03\u7528\u5927\u6a21\u578b\u8fdb\u884c\u63a8\u7406\u3001\u4f7f\u7528 GPU \u8fdb\u884c\u6279\u91cf\u5904\u7406\u3002\u4e24\u8005\u901a\u8fc7\u5171\u4eab\u7684\u5bf9\u8c61\u5b58\u50a8\uff08S3 \u4e0a\u7684 Parquet \u6587\u4ef6\uff09\u8fdb\u884c\u6570\u636e\u4ea4\u6362\uff0c\u5404\u53f8\u5176\u804c\uff0c\u76f8\u5f97\u76ca\u5f70\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_2-io","title":"2_2 \u6570\u636e\u683c\u5f0f\u4e0e I/O \u4f18\u5316","text":"<p>\u9009\u5bf9\u4e86\u5b58\u50a8\u548c\u8ba1\u7b97\uff0c\u63a5\u4e0b\u6765\u8981\u9009\u62e9\u6570\u636e\u7684\u5e8f\u5217\u5316\u683c\u5f0f\u3002\u683c\u5f0f\u9009\u62e9\u770b\u4f3c\u662f\u4e00\u4e2a\u6280\u672f\u7ec6\u8282\uff0c\u5b9e\u9645\u4e0a\u76f4\u63a5\u5f71\u54cd\u5b58\u50a8\u6210\u672c\u3001\u8bfb\u53d6\u901f\u5ea6\u548c\u5de5\u5177\u517c\u5bb9\u6027\u3002\u4e0d\u540c\u683c\u5f0f\u7684\u538b\u7f29\u7387\u5dee\u5f02\u53ef\u8fbe\u5341\u500d\u4e4b\u591a\uff0c\u5217\u5f0f\u4e0e\u884c\u5f0f\u683c\u5f0f\u7684\u67e5\u8be2\u6027\u80fd\u5dee\u5f02\u540c\u6837\u5de8\u5927\uff0c\u800c\u4e14\u5e76\u975e\u6240\u6709\u6846\u67b6\u90fd\u652f\u6301\u6240\u6709\u683c\u5f0f\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_21","title":"2_2.1 \u4e3b\u6d41\u6570\u636e\u683c\u5f0f\u5bf9\u6bd4","text":"<p>Parquet \u662f\u76ee\u524d\u5927\u89c4\u6a21\u7ed3\u6784\u5316\u6570\u636e\u7684\u4e8b\u5b9e\u6807\u51c6\u3002\u5b83\u91c7\u7528\u5217\u5f0f\u5b58\u50a8\uff0c\u76f8\u540c\u5217\u7684\u6570\u636e\u7269\u7406\u4e0a\u8fde\u7eed\u5b58\u653e\uff0c\u8fd9\u5e26\u6765\u4e24\u4e2a\u663e\u8457\u4f18\u52bf\uff1a\u4e00\u662f\u5229\u4e8e\u538b\u7f29\uff0c\u76f8\u540c\u7c7b\u578b\u7684\u6570\u636e\u805a\u96c6\u5728\u4e00\u8d77\u53ef\u4ee5\u83b7\u5f97\u66f4\u9ad8\u7684\u538b\u7f29\u7387\uff1b\u4e8c\u662f\u5229\u4e8e\u5411\u91cf\u5316\u8bfb\u53d6\uff0c\u67e5\u8be2\u7279\u5b9a\u5217\u65f6\u65e0\u9700\u626b\u63cf\u6574\u4e2a\u6587\u4ef6\u3002Parquet \u6587\u4ef6\u662f\u81ea\u63cf\u8ff0\u7684\uff0cSchema \u5d4c\u5165\u5728\u6587\u4ef6\u4e2d\uff0c\u65e0\u9700\u5916\u90e8\u5143\u6570\u636e\u5b9a\u4e49\u3002\u5b83\u8fd8\u652f\u6301\u5d4c\u5957\u7c7b\u578b\uff0c\u53ef\u4ee5\u5b58\u50a8\u7c7b\u4f3c JSON \u7684\u590d\u6742\u7ed3\u6784\uff0c\u5e76\u4e14\u5929\u7136\u652f\u6301\u76ee\u5f55\u5206\u533a\u3002Parquet \u662f\u9884\u8bad\u7ec3\u8bed\u6599\u5b58\u50a8\u7684\u9996\u9009\u683c\u5f0f\uff0c\u7279\u522b\u662f\u9700\u8981\u6309\u5217\u8fc7\u6ee4\u7684\u5206\u6790\u67e5\u8be2\u573a\u666f\uff0c\u4e0e Spark\u3001DuckDB\u3001Pandas \u7b49\u5de5\u5177\u90fd\u80fd\u826f\u597d\u914d\u5408\u3002</p> <p>JSONL\uff08JSON Lines\uff09\u662f\u53e6\u4e00\u79cd\u5e38\u89c1\u683c\u5f0f\uff0c\u6bcf\u884c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684 JSON \u5bf9\u8c61\u3002\u5b83\u7684\u6700\u5927\u4f18\u52bf\u662f\u4eba\u7c7b\u53ef\u8bfb\u2014\u2014\u53ef\u4ee5\u7528 <code>head</code>\u3001<code>cat</code> \u7b49\u547d\u4ee4\u76f4\u63a5\u67e5\u770b\u5185\u5bb9\u3002\u540c\u65f6\u5b83\u652f\u6301\u6d41\u5f0f\u5904\u7406\uff0c\u53ef\u4ee5\u9010\u884c\u8bfb\u53d6\u800c\u65e0\u9700\u52a0\u8f7d\u6574\u4e2a\u6587\u4ef6\u5230\u5185\u5b58\u3002Schema \u975e\u5e38\u7075\u6d3b\uff0c\u6bcf\u884c\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u5b57\u6bb5\u7ed3\u6784\u3002JSONL \u7279\u522b\u9002\u5408 SFT \u6307\u4ee4\u6570\u636e\uff0c\u56e0\u4e3a\u8fd9\u7c7b\u6570\u636e\u9700\u8981\u9891\u7e41\u4eba\u5de5\u67e5\u770b\u548c\u7f16\u8f91\u3002\u5b83\u4e5f\u5e38\u7528\u4e8e\u6570\u636e\u4ea4\u6362\u548c\u5c0f\u89c4\u6a21\u6570\u636e\u96c6\uff0810GB \u4ee5\u4e0b\uff09\u3002\u7136\u800c\uff0cJSONL \u7684\u52a3\u52bf\u4e5f\u5f88\u660e\u663e\uff1a\u65e0\u538b\u7f29\u65f6\u4f53\u79ef\u662f Parquet \u7684\u4e09\u5230\u4e94\u500d\uff0c\u8bfb\u53d6\u901f\u5ea6\u8f83\u6162\uff08\u9700\u8981\u89e3\u6790\u6bcf\u4e00\u884c\u7684 JSON \u5b57\u7b26\u4e32\uff09\u3002</p> <p>WebDataset \u662f NVIDIA \u4e3b\u5bfc\u5f00\u53d1\u7684\u683c\u5f0f\uff0c\u4e13\u4e3a\u56fe\u6587\u3001\u89c6\u9891\u7b49\u591a\u6a21\u6001\u6570\u636e\u8bbe\u8ba1\u3002\u5b83\u7684\u6838\u5fc3\u601d\u60f3\u662f\u5c06\u76f8\u5173\u6587\u4ef6\uff08\u5982\u4e00\u5f20\u56fe\u7247\u548c\u5bf9\u5e94\u7684\u63cf\u8ff0\u6587\u672c\uff09\u6253\u5305\u6210 TAR \u5f52\u6863\u3002\u8fd9\u79cd\u8bbe\u8ba1\u652f\u6301\u6d41\u5f0f\u8bfb\u53d6\uff0c\u65e0\u9700\u89e3\u538b\u5373\u53ef\u987a\u5e8f\u8bfb\u53d6\u5185\u5bb9\uff1b\u540c\u65f6\u5bf9\u5206\u5e03\u5f0f\u5904\u7406\u975e\u5e38\u53cb\u597d\uff0c\u6bcf\u4e2a TAR \u662f\u72ec\u7acb\u7684\u6570\u636e\u5206\u7247\u3002WebDataset \u662f LAION \u98ce\u683c\u56fe\u6587\u5bf9\u6570\u636e\u96c6\u548c\u89c6\u9891\u6570\u636e\u96c6\u7684\u6700\u4f73\u9009\u62e9\uff0c\u9002\u7528\u4e8e\u4efb\u4f55\u9700\u8981\u591a\u6587\u4ef6\u5173\u8054\u7684\u591a\u6a21\u6001\u6570\u636e\u3002</p> \u7279\u6027 Parquet JSONL WebDataset \u5b58\u50a8\u6548\u7387 \u9ad8\uff08\u5217\u5f0f\u538b\u7f29\uff09 \u4f4e\uff08\u6587\u672c\u5197\u4f59\u5927\uff09 \u4e2d\uff08\u65e0\u538b\u7f29\u4f46\u7d27\u51d1\uff09 \u8bfb\u53d6\u901f\u5ea6 \u5feb\uff08\u5411\u91cf\u5316\uff09 \u6162\uff08\u9010\u884c\u89e3\u6790\uff09 \u4e2d\uff08\u987a\u5e8f\u8bfb\u53d6\uff09 \u4eba\u7c7b\u53ef\u8bfb \u5426 \u662f \u5426 \u591a\u6a21\u6001\u652f\u6301 \u5f31\uff08\u9700\u7f16\u7801\uff09 \u5f31 \u5f3a\uff08\u539f\u751f\u652f\u6301\uff09 \u5178\u578b\u7528\u4f8b \u9884\u8bad\u7ec3\u6587\u672c\u8bed\u6599 SFT \u6307\u4ee4\u6570\u636e \u56fe\u6587\u5bf9\u3001\u89c6\u9891\u6570\u636e"},{"location":"chapter1/1_2_data_infra/#2_22","title":"2_2.2 \u538b\u7f29\u7b97\u6cd5\u9009\u578b","text":"<p>\u65e0\u8bba\u9009\u62e9\u4f55\u79cd\u683c\u5f0f\uff0c\u538b\u7f29\u7b97\u6cd5\u90fd\u4f1a\u663e\u8457\u5f71\u54cd\u5b58\u50a8\u6210\u672c\u548c\u8bfb\u53d6\u901f\u5ea6\u3002\u6b63\u786e\u7684\u538b\u7f29\u7b56\u7565\u9700\u8981\u5728\u7a7a\u95f4\u6548\u7387\u548c\u65f6\u95f4\u6548\u7387\u4e4b\u95f4\u627e\u5230\u5e73\u8861\u3002</p> <p>Snappy \u662f\u6700\u5e38\u7528\u7684\u9ed8\u8ba4\u9009\u62e9\u3002\u5b83\u7684\u538b\u7f29\u7387\u4e2d\u7b49\uff0c\u4f46\u538b\u7f29\u548c\u89e3\u538b\u901f\u5ea6\u90fd\u5f88\u5feb\uff0c\u9002\u5408\u8bfb\u5199\u5747\u8861\u7684\u573a\u666f\u3002LZ4 \u8ffd\u6c42\u6781\u81f4\u7684\u8bfb\u53d6\u901f\u5ea6\uff0c\u89e3\u538b\u6027\u80fd\u751a\u81f3\u6bd4 Snappy \u66f4\u5feb\uff0c\u538b\u7f29\u7387\u7565\u4f4e\uff0c\u9002\u5408\u5bf9\u8bfb\u53d6\u5ef6\u8fdf\u654f\u611f\u7684\u573a\u666f\u3002Zstandard\uff08ZSTD\uff09\u63d0\u4f9b\u6700\u9ad8\u7684\u538b\u7f29\u7387\uff0c\u5c24\u5176\u662f\u9ad8\u7ea7\u522b\uff08\u5982 level 19\uff09\u65f6\uff0c\u4f46\u538b\u7f29\u901f\u5ea6\u8f83\u6162\uff0c\u9002\u5408\u5b58\u50a8\u6210\u672c\u654f\u611f\u7684\u5f52\u6863\u573a\u666f\u3002Gzip \u662f\u517c\u5bb9\u6027\u6700\u597d\u7684\u9009\u62e9\uff0c\u51e0\u4e4e\u6240\u6709\u5de5\u5177\u90fd\u652f\u6301\uff0c\u9002\u5408\u9700\u8981\u4e0e\u5916\u90e8\u7cfb\u7edf\u4ea4\u6362\u6570\u636e\u7684\u573a\u666f\u3002</p> \u7b97\u6cd5 \u538b\u7f29\u7387 \u538b\u7f29\u901f\u5ea6 \u89e3\u538b\u901f\u5ea6 \u9002\u7528\u573a\u666f Snappy \u4e2d\u7b49 \u5feb \u5feb \u9ed8\u8ba4\u9009\u62e9\uff0c\u8bfb\u5199\u5747\u8861 LZ4 \u8f83\u4f4e \u6781\u5feb \u6781\u5feb \u6781\u81f4\u8bfb\u53d6\u901f\u5ea6 ZSTD \u9ad8 \u4e2d\u7b49 \u5feb \u5b58\u50a8\u6210\u672c\u654f\u611f Gzip \u9ad8 \u6162 \u4e2d\u7b49 \u517c\u5bb9\u6027\u8981\u6c42\u9ad8 <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u53ef\u4ee5\u91c7\u7528\u5206\u5c42\u7b56\u7565\uff1a\u51b7\u6570\u636e\uff08\u5f52\u6863\u5b58\u50a8\uff0c\u957f\u671f\u4e0d\u8bfb\u53d6\uff09\u4f7f\u7528 ZSTD level 19 \u4ee5\u83b7\u5f97\u6700\u5927\u538b\u7f29\u7387\uff1b\u70ed\u6570\u636e\uff08\u9891\u7e41\u8bfb\u53d6\u5904\u7406\uff09\u4f7f\u7528 Snappy \u6216 LZ4 \u4ee5\u51cf\u5c11\u89e3\u538b\u5f00\u9500\uff1b\u7f51\u7edc\u4f20\u8f93\u573a\u666f\u4f7f\u7528 ZSTD level 3\uff0c\u5728\u538b\u7f29\u7387\u548c\u901f\u5ea6\u4e4b\u95f4\u53d6\u5f97\u5e73\u8861\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_23-io","title":"2_2.3 I/O \u4f18\u5316\u5b9e\u6218\u6280\u5de7","text":"<p>\u5728\u5927\u89c4\u6a21\u6570\u636e\u5904\u7406\u4e2d\uff0cI/O \u5f80\u5f80\u662f\u6027\u80fd\u74f6\u9888\u3002\u4ee5\u4e0b\u4e09\u4e2a\u6280\u5de7\u53ef\u4ee5\u663e\u8457\u63d0\u5347 I/O \u6548\u7387\u3002</p> <p>\u5408\u7406\u8bbe\u7f6e\u6587\u4ef6\u5927\u5c0f\u662f\u7b2c\u4e00\u4e2a\u5173\u952e\u70b9\u3002\u5e38\u89c1\u7684\u9519\u8bef\u662f\u751f\u6210\u5927\u91cf\u5c0f\u6587\u4ef6\u2014\u2014\u4f8b\u5982 10 \u4e07\u4e2a 1MB \u7684\u6587\u4ef6\u3002\u8fd9\u4f1a\u5bfc\u81f4\u5143\u6570\u636e\u5f00\u9500\u5de8\u5927\uff0cS3 \u7684 ListObjects \u64cd\u4f5c\u53d8\u5f97\u6781\u6162\u3002\u6b63\u786e\u7684\u505a\u6cd5\u662f\u5c06\u6570\u636e\u5408\u5e76\u6210\u5c11\u91cf\u5927\u6587\u4ef6\uff0c\u6bcf\u4e2a Parquet \u6587\u4ef6\u7684\u5927\u5c0f\u5e94\u5728 128MB \u5230 1GB \u4e4b\u95f4\u3002\u592a\u5c0f\u4f1a\u5bfc\u81f4\u5143\u6570\u636e\u81a8\u80c0\u548c\u5e76\u884c\u5ea6\u4e0d\u8db3\uff0c\u592a\u5927\u4f1a\u5f71\u54cd\u4efb\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u3002</p> <pre><code># \u9519\u8bef\uff1a\u751f\u6210\u5927\u91cf\u5c0f\u6587\u4ef6\ndf.write.parquet(\"s3://bucket/data/\", maxRecordsPerFile=1000)\n\n# \u6b63\u786e\uff1a\u751f\u6210\u5c11\u91cf\u5927\u6587\u4ef6\uff08\u63a8\u8350 128MB - 1GB\uff09\ndf.coalesce(100).write.parquet(\"s3://bucket/data/\")\n</code></pre> <p>\u5206\u533a\u88c1\u526a\uff08Partition Pruning\uff09\u662f\u7b2c\u4e8c\u4e2a\u91cd\u8981\u6280\u5de7\u3002\u901a\u8fc7\u5728\u5199\u5165\u65f6\u6309\u7279\u5b9a\u5217\u8fdb\u884c\u5206\u533a\uff0c\u8bfb\u53d6\u65f6\u53ef\u4ee5\u53ea\u626b\u63cf\u9700\u8981\u7684\u5206\u533a\uff0c\u907f\u514d\u5168\u8868\u626b\u63cf\u3002\u5206\u533a\u5217\u5e94\u9009\u62e9\u4f4e\u57fa\u6570\uff08Cardinality\uff09\u7684\u5217\uff0c\u5982\u65e5\u671f\u3001\u8bed\u8a00\u3001\u6570\u636e\u6765\u6e90\uff1b\u5e94\u907f\u514d\u9ad8\u57fa\u6570\u5217\uff08\u5982\u7528\u6237 ID\uff09\uff0c\u5426\u5219\u4f1a\u4ea7\u751f\u6d77\u91cf\u5c0f\u76ee\u5f55\u3002</p> <pre><code># \u5199\u5165\u65f6\u6309\u65e5\u671f\u5206\u533a\ndf.write.partitionBy(\"date\").parquet(\"s3://bucket/data/\")\n\n# \u8bfb\u53d6\u65f6\u53ea\u626b\u63cf\u9700\u8981\u7684\u5206\u533a\nspark.read.parquet(\"s3://bucket/data/date=2024-01-01/\")\n</code></pre> <p>\u5217\u88c1\u526a\uff08Column Pruning\uff09\u662f\u7b2c\u4e09\u4e2a\u6280\u5de7\u3002\u5217\u5f0f\u5b58\u50a8\u7684\u6700\u5927\u4f18\u52bf\u5c31\u662f\u53ea\u8bfb\u53d6\u9700\u8981\u7684\u5217\u3002\u786e\u4fdd\u5728\u67e5\u8be2\u8bed\u53e5\u4e2d\u5c3d\u65e9\u8fdb\u884c\u5217\u9009\u62e9\uff0c\u907f\u514d\u5148\u8bfb\u53d6\u5168\u90e8\u5217\u518d\u8fc7\u6ee4\u3002</p> <pre><code># \u9519\u8bef\uff1a\u8bfb\u53d6\u5168\u90e8\u5217\ndf = spark.read.parquet(\"s3://bucket/data/\")  # \u5982\u679c\u6709 100 \u5217\uff0c\u5168\u90e8\u52a0\u8f7d\n\n# \u6b63\u786e\uff1a\u53ea\u8bfb\u53d6\u9700\u8981\u7684\u5217\ndf = spark.read.parquet(\"s3://bucket/data/\").select(\"text\", \"length\")\n</code></pre> <p></p> <p>\u56fe2-5\uff1aI/O\u4f18\u5316\u6548\u679c\u5bf9\u6bd4 \u2014\u2014 \u5206\u533a\u88c1\u526a+\u5217\u88c1\u526a\u53ef\u51cf\u5c1191%\u67e5\u8be2\u65f6\u95f4\u548c92%\u6570\u636e\u626b\u63cf\u91cf</p> <p>\u7efc\u5408\u4f7f\u7528\u8fd9\u4e09\u4e2a\u6280\u5de7\uff0c\u53ef\u4ee5\u5c06\u67e5\u8be2\u65f6\u95f4\u4ece 55 \u79d2\u964d\u4f4e\u5230 5 \u79d2\uff0c\u6570\u636e\u626b\u63cf\u91cf\u4ece 100GB \u964d\u4f4e\u5230 8GB\uff0c\u6548\u679c\u975e\u5e38\u663e\u8457\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_3-dataops","title":"2_3 \u6570\u636e\u7248\u672c\u63a7\u5236 (DataOps)","text":"<p>\u4ee3\u7801\u6709 Git\uff0c\u673a\u5668\u5b66\u4e60\u6a21\u578b\u6709 MLflow\uff0c\u90a3\u4e48 TB \u7ea7\u6570\u636e\u96c6\u5982\u4f55\u8fdb\u884c\u7248\u672c\u63a7\u5236\uff1f\u8fd9\u662f LLM \u6570\u636e\u5de5\u7a0b\u4e2d\u7ecf\u5e38\u88ab\u5ffd\u89c6\u4f46\u6781\u5176\u91cd\u8981\u7684\u95ee\u9898\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_31","title":"2_3.1 \u4e3a\u4ec0\u4e48\u6570\u636e\u9700\u8981\u7248\u672c\u63a7\u5236\uff1f","text":"<p>\u8003\u8651\u8fd9\u6837\u4e00\u4e2a\u573a\u666f\uff1a\u516d\u4e2a\u6708\u524d\u8bad\u7ec3\u7684\u6a21\u578b\u6548\u679c\u7279\u522b\u597d\uff0c\u8001\u677f\u8981\u6c42\u590d\u73b0\u3002\u4f60\u7ffb\u904d\u670d\u52a1\u5668\uff0c\u53d1\u73b0\u5f53\u65f6\u7684\u8bad\u7ec3\u6570\u636e\u5df2\u88ab\u6e05\u7406\u2014\u2014\"\u8c01\u8ba9\u4f60\u5220\u7684\uff1f\"\"\u5b83\u5360\u4e86 10TB \u554a\uff01\"\u6570\u636e\u5904\u7406\u811a\u672c\u5012\u662f\u8fd8\u5728\uff0c\u4f46\u4f9d\u8d56\u7684\u4e0a\u6e38\u6570\u636e\u4e5f\u53d8\u4e86\u3002\u91cd\u65b0\u8dd1\u4e00\u904d\u5904\u7406\u6d41\u7a0b\uff0c\u53d1\u73b0\u7ed3\u679c\u548c\u4e4b\u524d\u4e0d\u4e00\u6837\u3002\u7ed3\u8bba\uff1a\u65e0\u6cd5\u590d\u73b0\u3002</p> <p>\u8fd9\u4e2a\u573a\u666f\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u5c61\u89c1\u4e0d\u9c9c\u3002\u6570\u636e\u7248\u672c\u63a7\u5236\u6b63\u662f\u4e3a\u4e86\u89e3\u51b3\u8fd9\u7c7b\u95ee\u9898\u800c\u5b58\u5728\u3002\u5b83\u7684\u6838\u5fc3\u4ef7\u503c\u4f53\u73b0\u5728\u56db\u4e2a\u65b9\u9762\uff1a\u53ef\u590d\u73b0\u6027\u2014\u2014\u4efb\u610f\u65f6\u523b\u53ef\u4ee5\u7cbe\u786e\u8fd8\u539f\u5f53\u65f6\u7684\u6570\u636e\u72b6\u6001\uff1b\u53ef\u8ffd\u6eaf\u6027\u2014\u2014\u8ffd\u8e2a\u6570\u636e\u4ece\u539f\u59cb\u8f93\u5165\u5230\u6700\u7ec8\u8f93\u51fa\u7684\u5b8c\u6574\u94fe\u8def\uff1b\u534f\u4f5c\u5b89\u5168\u2014\u2014\u591a\u4eba\u540c\u65f6\u4fee\u6539\u6570\u636e\u4e0d\u4f1a\u4ea7\u751f\u51b2\u7a81\uff1b\u56de\u6eda\u80fd\u529b\u2014\u2014\u53d1\u73b0\u6570\u636e\u95ee\u9898\u65f6\u53ef\u4ee5\u5feb\u901f\u56de\u5230\u4e4b\u524d\u7684\u7248\u672c\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_32-dvc-vs-lakefs","title":"2_3.2 \u5de5\u5177\u9009\u578b\uff1aDVC vs LakeFS","text":"<p>\u76ee\u524d\u6700\u4e3b\u6d41\u7684\u4e24\u4e2a\u6570\u636e\u7248\u672c\u63a7\u5236\u5de5\u5177\u662f DVC \u548c LakeFS\uff0c\u5b83\u4eec\u7684\u8bbe\u8ba1\u54f2\u5b66\u622a\u7136\u4e0d\u540c\u3002</p> <p>DVC\uff08Data Version Control\uff09\u7684\u8bbe\u8ba1\u54f2\u5b66\u662f\"Git for Data\"\u2014\u2014\u8ba9\u6570\u636e\u7248\u672c\u63a7\u5236\u7684\u4f53\u9a8c\u5c3d\u53ef\u80fd\u63a5\u8fd1 Git\u3002\u5176\u5de5\u4f5c\u539f\u7406\u662f\uff1a\u6570\u636e\u6587\u4ef6\u672c\u8eab\u5b58\u50a8\u5728\u8fdc\u7a0b\u5b58\u50a8\uff08S3/GCS\uff09\uff0cGit \u4ed3\u5e93\u53ea\u4fdd\u5b58\u6570\u636e\u7684\u5143\u6570\u636e\u6587\u4ef6\uff08<code>.dvc</code> \u6587\u4ef6\uff09\uff0c\u901a\u8fc7 <code>dvc push/pull</code> \u547d\u4ee4\u540c\u6b65\u5b9e\u9645\u6570\u636e\u3002</p> <pre><code># \u521d\u59cb\u5316 DVC\ndvc init\n\n# \u5c06\u6570\u636e\u96c6\u7eb3\u5165\u7248\u672c\u63a7\u5236\ndvc add data/training_corpus.parquet\n# \u4f1a\u751f\u6210 data/training_corpus.parquet.dvc \u548c .gitignore\n\n# \u63d0\u4ea4\u5230 Git\ngit add data/training_corpus.parquet.dvc .gitignore\ngit commit -m \"Add training corpus v1\"\n\n# \u63a8\u9001\u6570\u636e\u5230\u8fdc\u7a0b\u5b58\u50a8\ndvc push\n\n# \u5207\u6362\u5230\u5386\u53f2\u7248\u672c\ngit checkout v1_0\ndvc checkout  # \u540c\u6b65\u5bf9\u5e94\u7248\u672c\u7684\u6570\u636e\n</code></pre> <p>DVC \u7684\u4f18\u52bf\u5728\u4e8e\u4e0e\u73b0\u6709 Git \u5de5\u4f5c\u6d41\u65e0\u7f1d\u96c6\u6210\uff0c\u5b66\u4e60\u66f2\u7ebf\u5e73\u7f13\uff0c\u652f\u6301 ML \u6d41\u6c34\u7ebf\u5b9a\u4e49\uff08\u901a\u8fc7 <code>dvc.yaml</code>\uff09\uff0c\u9002\u5408\u6587\u4ef6\u7ea7\u522b\u7684\u7248\u672c\u63a7\u5236\u573a\u666f\u3002\u5176\u52a3\u52bf\u662f\u6bcf\u4e2a\u6570\u636e\u96c6\u9700\u8981\u5355\u72ec\u7684 <code>.dvc</code> \u6587\u4ef6\u7ba1\u7406\uff0c\u4e0d\u652f\u6301\u7ec6\u7c92\u5ea6\u7684\"\u8868\u7ea7\"\u64cd\u4f5c\uff08\u5982\u56de\u6eda\u67d0\u4e2a\u5206\u533a\uff09\u3002</p> <p>LakeFS \u7684\u8bbe\u8ba1\u54f2\u5b66\u662f\"Git for Data Lake\"\u2014\u2014\u5728\u5bf9\u8c61\u5b58\u50a8\u4e4b\u4e0a\u63d0\u4f9b Git \u98ce\u683c\u7684\u5206\u652f\u548c\u63d0\u4ea4\u3002\u5176\u5de5\u4f5c\u539f\u7406\u662f\uff1aLakeFS \u4f5c\u4e3a\u5bf9\u8c61\u5b58\u50a8\u7684\u4ee3\u7406\u5c42\uff0c\u6240\u6709\u8bfb\u5199\u8bf7\u6c42\u901a\u8fc7 LakeFS \u7684 S3 \u7f51\u5173\uff0c\u7cfb\u7edf\u652f\u6301\u5206\u652f\uff08Branch\uff09\u3001\u63d0\u4ea4\uff08Commit\uff09\u3001\u5408\u5e76\uff08Merge\uff09\u7b49 Git \u98ce\u683c\u7684\u64cd\u4f5c\u3002</p> <pre><code># \u521b\u5efa\u5f00\u53d1\u5206\u652f\nlakectl branch create lakefs://repo/dev --source lakefs://repo/main\n\n# \u5728\u5f00\u53d1\u5206\u652f\u4e0a\u4fee\u6539\u6570\u636e\uff08\u901a\u8fc7 S3 \u534f\u8bae\uff09\naws s3 cp new_data.parquet s3://lakefs-repo/dev/data/\n\n# \u63d0\u4ea4\u66f4\u6539\nlakectl commit lakefs://repo/dev -m \"Add new training data\"\n\n# \u9a8c\u8bc1\u901a\u8fc7\u540e\u5408\u5e76\u5230\u4e3b\u5206\u652f\nlakectl merge lakefs://repo/dev lakefs://repo/main\n</code></pre> <p>LakeFS \u7684\u6838\u5fc3\u4f18\u52bf\u662f\u96f6\u62f7\u8d1d\u5206\u652f\u2014\u2014\u521b\u5efa\u5206\u652f\u4e0d\u590d\u5236\u6570\u636e\uff0c\u53ea\u8bb0\u5f55\u5143\u6570\u636e\uff0c\u8fd9\u5bf9\u4e8e TB \u7ea7\u6570\u636e\u6e56\u6765\u8bf4\u81f3\u5173\u91cd\u8981\u3002\u5b83\u5b8c\u5168 S3 \u517c\u5bb9\uff0c\u73b0\u6709\u5de5\u5177\uff08Spark/Ray\uff09\u65e0\u9700\u4fee\u6539\u5373\u53ef\u4f7f\u7528\u3002\u5176\u52a3\u52bf\u662f\u9700\u8981\u90e8\u7f72\u989d\u5916\u7684\u670d\u52a1\uff08LakeFS Server\uff09\uff0c\u5b66\u4e60\u66f2\u7ebf\u6bd4 DVC \u7565\u9661\u3002</p> \u7279\u6027 DVC LakeFS \u8bbe\u8ba1\u7406\u5ff5 Git \u7684\u6570\u636e\u6269\u5c55 \u5bf9\u8c61\u5b58\u50a8\u7684\u7248\u672c\u5c42 \u7c92\u5ea6 \u6587\u4ef6\u7ea7 \u5bf9\u8c61\u7ea7\uff08\u66f4\u7ec6\uff09 \u5206\u652f\u5f00\u9500 \u9700\u590d\u5236 .dvc \u6587\u4ef6 \u96f6\u62f7\u8d1d S3 \u517c\u5bb9 \u9700\u8981 dvc \u547d\u4ee4 \u539f\u751f S3 API \u90e8\u7f72\u590d\u6742\u5ea6 \u4f4e\uff08CLI \u5de5\u5177\uff09 \u4e2d\uff08\u9700\u8981\u670d\u52a1\u7aef\uff09 \u9002\u5408\u573a\u666f ML \u5b9e\u9a8c\u7ba1\u7406\u3001\u5c11\u91cf\u6570\u636e \u6570\u636e\u6e56\u7ba1\u7406\u3001\u5927\u89c4\u6a21\u6570\u636e <p></p> <p>\u56fe2-6\uff1aDVC vs LakeFS\u67b6\u6784\u5bf9\u6bd4 \u2014\u2014 DVC\u57fa\u4e8eGit\u7684\u6587\u4ef6\u7ea7\u7248\u672c\u63a7\u5236\uff0cLakeFS\u63d0\u4f9b\u96f6\u62f7\u8d1d\u5206\u652f\u7684\u5bf9\u8c61\u7ea7\u7248\u672c\u63a7\u5236</p> <p>\u9009\u578b\u5efa\u8bae\u975e\u5e38\u660e\u786e\uff1a\u5982\u679c\u6570\u636e\u91cf\u5728 1TB \u4ee5\u4e0b\uff0c\u56e2\u961f\u719f\u6089 Git \u5de5\u4f5c\u6d41\uff0c\u4e3b\u8981\u7528\u4e8e ML \u5b9e\u9a8c\u7ba1\u7406\uff0c\u9009\u62e9 DVC\uff1b\u5982\u679c\u6570\u636e\u91cf\u5728 TB \u7ea7\u4ee5\u4e0a\uff0c\u9700\u8981\u6570\u636e\u6e56\u7ea7\u522b\u7684\u7248\u672c\u63a7\u5236\uff0c\u6709\u591a\u4e2a\u56e2\u961f\u5e76\u884c\u64cd\u4f5c\uff0c\u9009\u62e9 LakeFS\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_33-data-lineage","title":"2_3.3 \u6570\u636e\u8840\u7f18\u8ffd\u8e2a (Data Lineage)","text":"<p>\u7248\u672c\u63a7\u5236\u89e3\u51b3\u4e86\"\u6570\u636e\u662f\u4ec0\u4e48\"\u7684\u95ee\u9898\uff0c\u8840\u7f18\u8ffd\u8e2a\u5219\u89e3\u51b3\u4e86\"\u6570\u636e\u4ece\u54ea\u6765\"\u7684\u95ee\u9898\u3002\u8840\u7f18\u8ffd\u8e2a\u8bb0\u5f55\u7684\u4fe1\u606f\u5305\u62ec\uff1a\u8fd9\u4efd\u6570\u636e\u662f\u7531\u54ea\u4e9b\u4e0a\u6e38\u6570\u636e\u5904\u7406\u5f97\u6765\u7684\uff1f\u4f7f\u7528\u4e86\u4ec0\u4e48\u5904\u7406\u811a\u672c\u548c\u53c2\u6570\uff1f\u4f55\u65f6\u3001\u7531\u8c01\u6267\u884c\u7684\u5904\u7406\uff1f</p> <p>\u5b9e\u73b0\u8840\u7f18\u8ffd\u8e2a\u6709\u591a\u79cd\u65b9\u6848\u3002\u5982\u679c\u4f7f\u7528 Spark\uff0c\u53ef\u4ee5\u901a\u8fc7 OpenLineage \u96c6\u6210\u83b7\u5f97\u81ea\u52a8\u5316\u7684\u8840\u7f18\u8ffd\u8e2a\u3002\u5982\u679c\u4f7f\u7528 Airflow \u7b49\u7f16\u6392\u5de5\u5177\uff0cMarquez \u662f\u4e00\u4e2a\u5f88\u597d\u7684\u9009\u62e9\u3002\u5bf9\u4e8e\u4f01\u4e1a\u7ea7\u6570\u636e\u6cbb\u7406\u9700\u6c42\uff0cDataHub \u548c Apache Atlas \u63d0\u4f9b\u4e86\u66f4\u5b8c\u5584\u7684\u529f\u80fd\u3002\u5bf9\u4e8e\u7b80\u5355\u573a\u666f\uff0c\u624b\u52a8\u57cb\u70b9\u751f\u6210\u5143\u6570\u636e\u6587\u4ef6\u4e5f\u662f\u4e00\u79cd\u8f7b\u91cf\u7ea7\u7684\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code>import json\nfrom datetime import datetime\n\nmetadata = {\n    \"version\": \"v2_0\",\n    \"created_at\": datetime.now().isoformat(),\n    \"created_by\": \"data-pipeline-v3_2\",\n    \"inputs\": [\n        {\"path\": \"s3://bucket/raw/crawl_2024_01.parquet\", \"version\": \"abc123\"},\n        {\"path\": \"s3://bucket/raw/crawl_2024_02.parquet\", \"version\": \"def456\"}\n    ],\n    \"processing\": {\n        \"script\": \"cleaning_pipeline.py\",\n        \"git_commit\": \"789xyz\",\n        \"params\": {\"min_length\": 100, \"dedup_threshold\": 0_9}\n    },\n    \"outputs\": [\n        {\"path\": \"s3://bucket/processed/clean_2024_q1.parquet\", \"records\": 1000000}\n    ]\n}\n\nwith open(\"clean_2024_q1.metadata.json\", \"w\") as f:\n    json.dump(metadata, f, indent=2)\n</code></pre>"},{"location":"chapter1/1_2_data_infra/#2_4","title":"2_4 \u5e38\u89c1\u9519\u8bef\u4e0e\u907f\u5751\u6307\u5357","text":"<p>\u5728\u57fa\u7840\u8bbe\u65bd\u9009\u578b\u8fc7\u7a0b\u4e2d\uff0c\u5373\u4f7f\u662f\u7ecf\u9a8c\u4e30\u5bcc\u7684\u5de5\u7a0b\u5e08\u4e5f\u5bb9\u6613\u72af\u4e00\u4e9b\u5178\u578b\u9519\u8bef\u3002\u8fd9\u91cc\u603b\u7ed3\u4e09\u4e2a\u6700\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u5e0c\u671b\u8bfb\u8005\u80fd\u591f\u5f15\u4ee5\u4e3a\u6212\u3002</p> <p>\u7b2c\u4e00\u4e2a\u5e38\u89c1\u9519\u8bef\u662f\u8fc7\u65e9\u4f18\u5316\u3001\u8fc7\u5ea6\u5de5\u7a0b\u3002 \u6709\u4e9b\u56e2\u961f\u89c4\u6a21\u53ea\u6709\u4e94\u4eba\uff0c\u6570\u636e\u91cf\u4ec5 500GB\uff0c\u5374\u642d\u5efa\u4e86 Spark \u96c6\u7fa4 + Iceberg + Airflow + LakeFS \u7684\"\u5168\u6808\"\u57fa\u7840\u8bbe\u65bd\u3002\u7ed3\u679c\u662f 80% \u7684\u65f6\u95f4\u82b1\u5728\u7ef4\u62a4\u57fa\u7840\u8bbe\u65bd\u4e0a\uff0c\u53ea\u6709 20% \u7684\u65f6\u95f4\u7528\u4e8e\u5b9e\u9645\u6570\u636e\u5904\u7406\u3002\u6b63\u786e\u7684\u505a\u6cd5\u662f\u4ece\u7b80\u5355\u5f00\u59cb\uff0c\u6309\u9700\u6f14\u8fdb\u3002500GB \u7684\u6570\u636e\u91cf\uff0c\u5355\u673a + Parquet + DVC \u5b8c\u5168\u591f\u7528\uff0c\u7b49\u6570\u636e\u91cf\u589e\u957f\u5230 10TB \u65f6\u518d\u8003\u8651\u5206\u5e03\u5f0f\u65b9\u6848\u4e5f\u4e0d\u8fdf\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u5e38\u89c1\u9519\u8bef\u662f\u76f2\u76ee\u8ffd\u65b0\u3001\u5ffd\u89c6\u751f\u6001\u3002 \u6709\u4e9b\u56e2\u961f\u770b\u4e86\u51e0\u7bc7\u535a\u5ba2\uff0c\u51b3\u5b9a\u629b\u5f03 Spark \u5168\u9762\u8f6c\u5411 Ray\uff0c\u7ed3\u679c\u53d1\u73b0\u516c\u53f8\u7684 Hive \u8868\u3001Iceberg \u8868\u5168\u90e8\u65e0\u6cd5\u76f4\u63a5\u8bfb\u53d6\u3002\u6700\u7ec8\u9700\u8981\u989d\u5916\u7f16\u5199\u5927\u91cf\u6570\u636e\u8f6c\u6362\u811a\u672c\uff0c\u589e\u52a0\u4e86\u6570\u636e\u4e00\u81f4\u6027\u98ce\u9669\u3002\u6b63\u786e\u7684\u505a\u6cd5\u662f\u5728\u505a\u6280\u672f\u9009\u578b\u524d\uff0c\u5145\u5206\u8bc4\u4f30\u73b0\u6709\u6570\u636e\u8d44\u4ea7\u548c\u4e0a\u4e0b\u6e38\u4f9d\u8d56\u3002\u6280\u672f\u9009\u578b\u4e0d\u662f\u5355\u70b9\u51b3\u7b56\uff0c\u800c\u662f\u7cfb\u7edf\u5de5\u7a0b\uff0c\u9700\u8981\u8003\u8651\u6574\u4f53\u751f\u6001\u7684\u517c\u5bb9\u6027\u3002</p> <p>\u7b2c\u4e09\u4e2a\u5e38\u89c1\u9519\u8bef\u662f\u5b58\u50a8\u6210\u672c\u4f18\u5316\u8fc7\u6fc0\u3002 \u6709\u4e9b\u56e2\u961f\u4e3a\u4e86\u8282\u7701\u5b58\u50a8\u8d39\u7528\uff0c\u628a\u6240\u6709\u6570\u636e\u538b\u7f29\u5230 ZSTD level 22\uff0c\u5e76\u5b58\u5165 S3 Glacier Deep Archive\u3002\u7ed3\u679c\u6bcf\u6b21\u9700\u8981\u8bfb\u53d6\u6570\u636e\uff0c\u8981\u7b49 12 \u5c0f\u65f6\u89e3\u51bb\uff0c\u89e3\u538b\u53c8\u8981 4 \u5c0f\u65f6\uff0c\u6a21\u578b\u8bad\u7ec3\u4e00\u6b21\u8981\u6392\u671f\u4e00\u5468\u3002\u6b63\u786e\u7684\u505a\u6cd5\u662f\u533a\u5206\u51b7\u70ed\u6570\u636e\u3002\u6d3b\u8dc3\u5904\u7406\u7684\u6570\u636e\u653e\u5728 S3 Standard + Snappy \u538b\u7f29\uff1b\u516d\u4e2a\u6708\u4ee5\u4e0a\u4e0d\u4f7f\u7528\u7684\u5f52\u6863\u6570\u636e\u518d\u653e\u5165 Glacier\u3002\u5b58\u50a8\u6210\u672c\u548c\u8bbf\u95ee\u6548\u7387\u9700\u8981\u627e\u5230\u5e73\u8861\u70b9\u3002</p>"},{"location":"chapter1/1_2_data_infra/#2_5","title":"2_5 \u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u7cfb\u7edf\u4ecb\u7ecd\u4e86 LLM \u6570\u636e\u5de5\u7a0b\u7684\u57fa\u7840\u8bbe\u65bd\u9009\u578b\uff0c\u6db5\u76d6\u5b58\u50a8\u3001\u8ba1\u7b97\u3001\u683c\u5f0f\u548c\u7248\u672c\u63a7\u5236\u56db\u4e2a\u6838\u5fc3\u7ef4\u5ea6\u3002</p> <p>\u5728\u5b58\u50a8\u9009\u578b\u65b9\u9762\uff0c\u5bf9\u8c61\u5b58\u50a8\uff08S3/MinIO\uff09\u662f\u73b0\u4ee3\u6570\u636e\u6808\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u6570\u636e\u6e56\u683c\u5f0f\uff08Iceberg/Hudi/Delta\uff09\u89e3\u51b3\u4e86 ACID \u4e8b\u52a1\u3001\u65f6\u95f4\u65c5\u884c\u7b49\u95ee\u9898\u3002\u5bf9\u4e8e LLM \u573a\u666f\uff0c\u63a8\u8350\u7ec4\u5408\u662f S3 + Iceberg\uff0c\u56e0\u4e3a Iceberg \u7684\u5f15\u64ce\u4e2d\u7acb\u6027\u6700\u597d\u3002</p> <p>\u5728\u8ba1\u7b97\u9009\u578b\u65b9\u9762\uff0cSpark \u4ee5\u5176\u6210\u719f\u7a33\u5b9a\u548c\u5f3a\u5927\u7684 SQL \u751f\u6001\u8457\u79f0\uff0c\u9002\u5408\u4f20\u7edf\u5927\u6570\u636e\u56e2\u961f\uff1bRay Data \u662f Python \u539f\u751f\u7684 AI \u53cb\u597d\u6846\u67b6\uff0c\u9002\u5408 ML/AI \u56e2\u961f\u3002\u4e24\u8005\u5e76\u4e0d\u4e92\u65a5\uff0c\u53ef\u4ee5\u6df7\u7528\uff1aSpark \u8d1f\u8d23 ETL\uff0cRay \u8d1f\u8d23 ML \u5904\u7406\u3002</p> <p>\u5728\u6570\u636e\u683c\u5f0f\u65b9\u9762\uff0cParquet \u662f\u7ed3\u6784\u5316\u6570\u636e\u7684\u9ed8\u8ba4\u9009\u62e9\uff0cJSONL \u9002\u5408\u9700\u8981\u4eba\u5de5\u67e5\u770b\u7684\u5c0f\u89c4\u6a21\u6570\u636e\uff0cWebDataset \u662f\u591a\u6a21\u6001\u6570\u636e\u7684\u6700\u4f73\u683c\u5f0f\u3002\u538b\u7f29\u7b97\u6cd5\u548c I/O \u4f18\u5316\u6280\u5de7\u53ef\u4ee5\u663e\u8457\u5f71\u54cd\u6027\u80fd\u548c\u6210\u672c\u3002</p> <p>\u5728\u7248\u672c\u63a7\u5236\u65b9\u9762\uff0cDVC \u8f7b\u91cf\u7ea7\u4e14\u4e0e Git \u7d27\u5bc6\u96c6\u6210\uff0c\u9002\u5408 ML \u5b9e\u9a8c\uff1bLakeFS \u63d0\u4f9b\u6570\u636e\u6e56\u7ea7\u522b\u7684\u7248\u672c\u63a7\u5236\uff0c\u9002\u5408\u5927\u89c4\u6a21\u751f\u4ea7\u73af\u5883\u3002</p> <p>\u8d2f\u7a7f\u59cb\u7ec8\u7684\u6838\u5fc3\u539f\u5219\u662f\uff1a\u4ece\u7b80\u5355\u5f00\u59cb\uff0c\u6309\u9700\u6f14\u8fdb\uff0c\u907f\u514d\u8fc7\u5ea6\u5de5\u7a0b\u3002\u6280\u672f\u9009\u578b\u5e94\u8be5\u670d\u52a1\u4e8e\u4e1a\u52a1\u76ee\u6807\uff0c\u800c\u975e\u4e3a\u4e86\u8ffd\u6c42\u6280\u672f\u5148\u8fdb\u6027\u3002</p> <p></p> <p>\u56fe2-7\uff1a\u6570\u636e\u57fa\u7840\u8bbe\u65bd\u9009\u578b\u901f\u67e5\u8868 \u2014\u2014 \u5b58\u50a8\u3001\u8868\u683c\u5f0f\u3001\u8ba1\u7b97\u3001\u7248\u672c\u63a7\u5236\u56db\u8c61\u9650\u51b3\u7b56\u6307\u5357</p>"},{"location":"chapter1/1_2_data_infra/#_3","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u5bf9\u4e8e\u5e0c\u671b\u6df1\u5165\u4e86\u89e3\u672c\u7ae0\u5185\u5bb9\u7684\u8bfb\u8005\uff0c\u4ee5\u4e0b\u8d44\u6e90\u503c\u5f97\u53c2\u8003\uff1a</p> <p>Ray Data \u5b98\u65b9\u6587\u6863\uff08docs.ray.io\uff09\u63d0\u4f9b\u4e86 Ray Data \u7684\u6700\u4f73\u5b9e\u8df5\u548c\u8be6\u7ec6 API \u8bf4\u660e\u3002Apache Iceberg \u5b98\u65b9\u6587\u6863\uff08iceberg.apache.org\uff09\u5305\u542b\u8868\u683c\u5f0f\u7684\u8be6\u7ec6\u89c4\u8303\u548c\u5404\u5f15\u64ce\u96c6\u6210\u6307\u5357\u3002DVC \u5b98\u65b9\u6559\u7a0b\uff08dvc.org/doc\uff09\u662f\u5feb\u901f\u5165\u95e8\u7684\u597d\u8d77\u70b9\u3002LakeFS \u5b98\u65b9\u6587\u6863\uff08docs.lakefs.io\uff09\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u67b6\u6784\u8bbe\u8ba1\u548c\u90e8\u7f72\u65b9\u6848\u3002</p> <p>Databricks \u53d1\u5e03\u7684\u6570\u636e\u6e56\u9009\u578b\u767d\u76ae\u4e66\u5bf9 Delta\u3001Iceberg\u3001Hudi \u4e09\u79cd\u683c\u5f0f\u8fdb\u884c\u4e86\u6df1\u5ea6\u5bf9\u6bd4\u5206\u6790\u3002Uber \u53d1\u8868\u7684\"Scaling MLOps at Uber\"\u4e00\u6587\u4ecb\u7ecd\u4e86\u5982\u4f55\u5728 PB \u7ea7\u89c4\u6a21\u7ba1\u7406 ML \u6570\u636e\u3002\u8fd9\u4e9b\u8d44\u6599\u53ef\u4ee5\u5e2e\u52a9\u8bfb\u8005\u5efa\u7acb\u66f4\u5168\u9762\u7684\u6280\u672f\u89c6\u91ce\u3002</p>"},{"location":"chapter1/1_2_data_infra/#_4","title":"\u4e0b\u4e00\u7ae0\u9884\u544a","text":"<p>\u5728\u4e0b\u4e00\u7ae0\u300a\u6570\u636e\u83b7\u53d6\u4e0e\u91c7\u96c6\u300b\u4e2d\uff0c\u6211\u4eec\u5c06\u6b63\u5f0f\u8fdb\u5165\u9884\u8bad\u7ec3\u6570\u636e\u7684\u5904\u7406\u6d41\u7a0b\u3002\u4f60\u5c06\u5b66\u4e60\u5982\u4f55\u83b7\u53d6\u548c\u89e3\u6790 Common Crawl\u3001The Pile \u7b49\u5f00\u6e90\u6570\u636e\u96c6\uff0c\u5982\u4f55\u4f7f\u7528 Trafilatura \u6784\u5efa\u9ad8\u6027\u80fd\u7f51\u9875\u89e3\u6790\u5668\uff0c\u4ee5\u53ca\u4ece GitHub\u3001ArXiv \u6293\u53d6\u4ee3\u7801\u548c\u8bba\u6587\u7684\u7279\u79cd\u7b56\u7565\u3002</p> <p>\u5e26\u7740\u8fd9\u4e2a\u95ee\u9898\u8fdb\u5165\u4e0b\u4e00\u7ae0\uff1aCommon Crawl \u6bcf\u6708\u65b0\u589e 3-5PB \u6570\u636e\uff0c\u4f60\u5982\u4f55\u4ece\u4e2d\u9ad8\u6548\u63d0\u53d6\u9700\u8981\u7684\u5185\u5bb9\uff1f</p>"},{"location":"chapter2/2_1_data_acquisition/","title":"\u7b2c3\u7ae0\uff1a\u6570\u636e\u83b7\u53d6\u4e0e\u91c7\u96c6","text":""},{"location":"chapter2/2_1_data_acquisition/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u9884\u8bad\u7ec3\u6570\u636e\u662f\u5927\u6a21\u578b\u7684\"\u71c3\u6599\"\uff0c\u5176\u8d28\u91cf\u548c\u89c4\u6a21\u76f4\u63a5\u51b3\u5b9a\u4e86\u6a21\u578b\u7684\u57fa\u7840\u80fd\u529b\u3002\u672c\u7ae0\u5c06\u6df1\u5165\u63a2\u8ba8\u9884\u8bad\u7ec3\u6570\u636e\u7684\u83b7\u53d6\u7b56\u7565\uff0c\u4ece Common Crawl \u7b49\u5f00\u6e90\u6570\u636e\u96c6\u7684\u89e3\u6784\u4e0e\u4f7f\u7528\uff0c\u5230\u9ad8\u6027\u80fd\u7f51\u9875\u722c\u866b\u7cfb\u7edf\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff0c\u518d\u5230\u4ee3\u7801\u3001\u8bba\u6587\u3001\u4e66\u7c4d\u7b49\u7279\u79cd\u6570\u636e\u7684\u83b7\u53d6\u6280\u5de7\u3002\u638c\u63e1\u8fd9\u4e9b\u5185\u5bb9\u540e\uff0c\u8bfb\u8005\u5c06\u5177\u5907\u6784\u5efa TB \u7ea7\u9884\u8bad\u7ec3\u8bed\u6599\u5e93\u7684\u80fd\u529b\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u4f60\u7684\u56e2\u961f\u51b3\u5b9a\u8bad\u7ec3\u4e00\u4e2a 7B \u53c2\u6570\u7684\u4e2d\u6587\u57fa\u5ea7\u6a21\u578b\u3002\u6309\u7167 Chinchilla \u7684\u6700\u4f18\u914d\u6bd4\uff0c\u8fd9\u9700\u8981\u7ea6 140B Token \u7684\u9ad8\u8d28\u91cf\u4e2d\u6587\u8bed\u6599\u2014\u2014\u6362\u7b97\u6210\u539f\u59cb\u6587\u672c\u5927\u7ea6\u662f 280TB\u3002\u53bb\u54ea\u91cc\u627e\u8fd9\u4e48\u591a\u6570\u636e\uff1f\u76f4\u63a5\u4ece\u7f51\u4e0a\u722c\u53d6\u663e\u7136\u4e0d\u73b0\u5b9e\uff0c\u4e00\u4e2a\u5c0f\u56e2\u961f\u4e0d\u53ef\u80fd\u5728\u77ed\u65f6\u95f4\u5185\u722c\u5b8c\u6574\u4e2a\u4e2d\u6587\u4e92\u8054\u7f51\u3002</p> <p>\u8fd9\u65f6\u6709\u4eba\u63d0\u8bae\u4f7f\u7528 Common Crawl\u2014\u2014\u8fd9\u662f\u4e00\u4e2a\u6bcf\u6708\u6293\u53d6\u6570\u5341\u4ebf\u7f51\u9875\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u7d2f\u8ba1\u6570\u636e\u91cf\u8d85\u8fc7 PB \u7ea7\u3002\u542c\u8d77\u6765\u662f\u5b8c\u7f8e\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4f46\u5f53\u4f60\u771f\u6b63\u4e0b\u8f7d\u4e00\u4e2a\u6708\u7684\u6570\u636e\u540e\uff0c\u53d1\u73b0\u539f\u59cb\u7684 WARC \u6587\u4ef6\u5b8c\u5168\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528\uff1a\u5145\u65a5\u7740 HTML \u6807\u7b7e\u3001JavaScript \u4ee3\u7801\u3001\u5bfc\u822a\u680f\u3001\u5e7f\u544a\uff0c\u771f\u6b63\u6709\u4ef7\u503c\u7684\u6b63\u6587\u5185\u5bb9\u53ef\u80fd\u4e0d\u5230 10%\u3002</p> <p>\u5982\u4f55\u4ece\u8fd9\u7247\"\u6570\u636e\u6cbc\u6cfd\"\u4e2d\u63d0\u53d6\u51fa\u53ef\u7528\u4e8e\u8bad\u7ec3\u7684\"\u9ec4\u91d1\u8bed\u6599\"\uff1f\u8fd9\u6b63\u662f\u672c\u7ae0\u8981\u89e3\u51b3\u7684\u6838\u5fc3\u95ee\u9898\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_1","title":"3_1 \u5f00\u6e90\u6570\u636e\u96c6\u89e3\u6784","text":"<p>\u5728\u52a8\u624b\u722c\u53d6\u6570\u636e\u4e4b\u524d\uff0c\u9996\u5148\u5e94\u8be5\u5145\u5206\u5229\u7528\u5df2\u6709\u7684\u5f00\u6e90\u6570\u636e\u96c6\u3002\u8fd9\u4e9b\u6570\u636e\u96c6\u7ecf\u8fc7\u793e\u533a\u7684\u7cbe\u5fc3\u5904\u7406\uff0c\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u9884\u8bad\u7ec3\u6570\u636e\u51c6\u5907\u7684\u65f6\u95f4\u548c\u6210\u672c\u3002\u7406\u89e3\u5b83\u4eec\u7684\u6784\u6210\u548c\u5904\u7406\u65b9\u6cd5\uff0c\u4e5f\u662f\u8bbe\u8ba1\u81ea\u5df1\u6570\u636e\u7ba1\u7ebf\u7684\u91cd\u8981\u53c2\u8003\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_11-common-crawl","title":"3_1.1 Common Crawl\uff1a\u4e92\u8054\u7f51\u7684\u5feb\u7167","text":"<p>Common Crawl \u662f\u4e00\u4e2a\u975e\u8425\u5229\u7ec4\u7ec7\uff0c\u81ea 2008 \u5e74\u8d77\u6301\u7eed\u6293\u53d6\u4e92\u8054\u7f51\u7f51\u9875\uff0c\u5e76\u514d\u8d39\u63d0\u4f9b\u7ed9\u7814\u7a76\u548c\u5546\u4e1a\u4f7f\u7528\u3002\u5b83\u662f\u76ee\u524d\u7edd\u5927\u591a\u6570\u5927\u89c4\u6a21\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u4e0a\u6e38\u6765\u6e90\uff0c\u65e0\u8bba\u662f GPT \u7cfb\u5217\u3001LLaMA \u8fd8\u662f\u56fd\u5185\u7684\u5404\u79cd\u5927\u6a21\u578b\uff0c\u90fd\u6216\u591a\u6216\u5c11\u5730\u4f7f\u7528\u4e86 Common Crawl \u7684\u6570\u636e\u3002</p> <p>Common Crawl \u7684\u6570\u636e\u4ee5\"\u6293\u53d6\u6279\u6b21\"\uff08Crawl\uff09\u4e3a\u5355\u4f4d\u7ec4\u7ec7\uff0c\u6bcf\u6708\u53d1\u5e03\u4e00\u4e2a\u65b0\u6279\u6b21\uff0c\u6bcf\u4e2a\u6279\u6b21\u5305\u542b\u6570\u5341\u4ebf\u4e2a\u7f51\u9875\u3002\u6570\u636e\u4ee5\u4e09\u79cd\u683c\u5f0f\u63d0\u4f9b\uff1aWARC\uff08Web ARChive\uff09\u6587\u4ef6\u5305\u542b\u539f\u59cb\u7684 HTTP \u54cd\u5e94\uff0c\u5305\u62ec\u54cd\u5e94\u5934\u548c\u5b8c\u6574\u7684 HTML \u5185\u5bb9\uff0c\u662f\u6700\u539f\u59cb\u4e5f\u6700\u5b8c\u6574\u7684\u683c\u5f0f\uff1bWAT \u6587\u4ef6\u662f WARC \u7684\u5143\u6570\u636e\u63d0\u53d6\u7248\u672c\uff0c\u5305\u542b URL\u3001\u54cd\u5e94\u5934\u3001\u94fe\u63a5\u5173\u7cfb\u7b49\u7ed3\u6784\u5316\u4fe1\u606f\uff1bWET \u6587\u4ef6\u662f\u7eaf\u6587\u672c\u63d0\u53d6\u7248\u672c\uff0c\u5df2\u7ecf\u53bb\u9664\u4e86 HTML \u6807\u7b7e\uff0c\u53ea\u4fdd\u7559\u6b63\u6587\u6587\u672c\u3002</p> \u683c\u5f0f \u5185\u5bb9 \u5355\u6708\u6570\u636e\u91cf \u9002\u7528\u573a\u666f WARC \u539f\u59cb HTTP \u54cd\u5e94 + HTML \u7ea6 80TB \u538b\u7f29 \u9700\u8981\u5b8c\u6574\u5185\u5bb9\u6216\u81ea\u5b9a\u4e49\u89e3\u6790 WAT \u7ed3\u6784\u5316\u5143\u6570\u636e \u7ea6 3TB \u538b\u7f29 URL \u5206\u6790\u3001\u94fe\u63a5\u56fe\u7814\u7a76 WET \u7eaf\u6587\u672c\u63d0\u53d6 \u7ea6 15TB \u538b\u7f29 \u5feb\u901f\u83b7\u53d6\u6587\u672c\u3001\u521d\u6b65\u5b9e\u9a8c <p></p> <p>\u56fe3-1\uff1aCommon Crawl \u6570\u636e\u6d41\u6c34\u7ebf \u2014\u2014 \u4ece\u4e92\u8054\u7f51\u6293\u53d6\u5230\u6e05\u6d01\u8bed\u6599\u7684\u5b8c\u6574\u5904\u7406\u6d41\u7a0b</p> <p>\u5bf9\u4e8e\u9884\u8bad\u7ec3\u6570\u636e\u5de5\u7a0b\u800c\u8a00\uff0cWARC \u548c WET \u662f\u6700\u5e38\u7528\u7684\u4e24\u79cd\u683c\u5f0f\u3002WET \u6587\u4ef6\u770b\u4f3c\u65b9\u4fbf\uff0c\u56e0\u4e3a\u5df2\u7ecf\u63d0\u53d6\u4e86\u7eaf\u6587\u672c\uff0c\u4f46\u5b9e\u9645\u4e0a Common Crawl \u7684\u9ed8\u8ba4\u6587\u672c\u63d0\u53d6\u8d28\u91cf\u8f83\u5dee\uff0c\u4f1a\u4fdd\u7559\u5927\u91cf\u566a\u58f0\uff08\u5982\u5bfc\u822a\u680f\u3001\u9875\u811a\u3001JavaScript \u6587\u672c\uff09\u3002\u56e0\u6b64\uff0c\u4e13\u4e1a\u7684\u6570\u636e\u5904\u7406\u6d41\u7a0b\u901a\u5e38\u4ece WARC \u6587\u4ef6\u5f00\u59cb\uff0c\u4f7f\u7528\u66f4\u9ad8\u8d28\u91cf\u7684\u89e3\u6790\u5668\uff08\u5982 Trafilatura\uff09\u91cd\u65b0\u63d0\u53d6\u6b63\u6587\u3002</p> <p>\u4f7f\u7528 Common Crawl \u6570\u636e\u9700\u8981\u6ce8\u610f\u51e0\u4e2a\u5173\u952e\u70b9\u3002\u9996\u5148\u662f\u7248\u672c\u9009\u62e9\uff1a\u6bcf\u6708\u7684\u6293\u53d6\u6279\u6b21\u8d28\u91cf\u7565\u6709\u5dee\u5f02\uff0c\u4e00\u822c\u5efa\u8bae\u4f7f\u7528\u8f83\u65b0\u7684\u7248\u672c\uff08\u5982 2023 \u5e74\u4ee5\u540e\u7684\u6279\u6b21\uff09\uff0c\u56e0\u4e3a Common Crawl \u6301\u7eed\u6539\u8fdb\u5176\u6293\u53d6\u7b56\u7565\u3002\u5176\u6b21\u662f\u8bed\u8a00\u8fc7\u6ee4\uff1aCommon Crawl \u4ee5\u82f1\u6587\u7f51\u9875\u4e3a\u4e3b\uff0c\u4e2d\u6587\u3001\u65e5\u6587\u7b49\u975e\u82f1\u8bed\u5185\u5bb9\u5360\u6bd4\u8f83\u4f4e\uff08\u901a\u5e38\u4e0d\u5230 10%\uff09\uff0c\u9700\u8981\u989d\u5916\u7684\u8bed\u8a00\u8bc6\u522b\u6b65\u9aa4\u8fdb\u884c\u7b5b\u9009\u3002\u6700\u540e\u662f\u6cd5\u5f8b\u5408\u89c4\uff1a\u867d\u7136 Common Crawl \u662f\u5f00\u653e\u6570\u636e\uff0c\u4f46\u5176\u4e2d\u6293\u53d6\u7684\u7f51\u9875\u5185\u5bb9\u53ef\u80fd\u6d89\u53ca\u7248\u6743\u95ee\u9898\uff0c\u4f7f\u7528\u65f6\u9700\u8981\u6839\u636e\u5f53\u5730\u6cd5\u5f8b\u8fdb\u884c\u8bc4\u4f30\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_12-refinedweb","title":"3_1.2 RefinedWeb\uff1a\u9ad8\u8d28\u91cf\u82f1\u6587\u8bed\u6599","text":"<p>RefinedWeb \u662f Falcon \u6a21\u578b\u56e2\u961f\uff08UAE \u7684 TII \u5b9e\u9a8c\u5ba4\uff09\u53d1\u5e03\u7684\u9ad8\u8d28\u91cf\u82f1\u6587\u9884\u8bad\u7ec3\u6570\u636e\u96c6\uff0c\u5305\u542b\u7ea6 5T Token\u3002\u4e0e\u76f4\u63a5\u4f7f\u7528 Common Crawl \u4e0d\u540c\uff0cRefinedWeb \u7ecf\u8fc7\u4e86\u4e25\u683c\u7684\u6e05\u6d17\u548c\u53bb\u91cd\u5904\u7406\uff0c\u88ab\u8ba4\u4e3a\u662f\u76ee\u524d\u516c\u5f00\u53ef\u7528\u7684\u6700\u9ad8\u8d28\u91cf\u82f1\u6587\u9884\u8bad\u7ec3\u8bed\u6599\u4e4b\u4e00\u3002</p> <p>RefinedWeb \u7684\u5904\u7406\u6d41\u7a0b\u5177\u6709\u5f88\u5f3a\u7684\u53c2\u8003\u4ef7\u503c\u3002\u5176\u6838\u5fc3\u6b65\u9aa4\u5305\u62ec\uff1aURL \u8fc7\u6ee4\uff08\u79fb\u9664\u6210\u4eba\u7f51\u7ad9\u3001\u5783\u573e\u7ad9\u70b9\u7b49\uff09\u3001\u6587\u672c\u63d0\u53d6\uff08\u4f7f\u7528 Trafilatura \u8fdb\u884c\u9ad8\u8d28\u91cf\u6b63\u6587\u63d0\u53d6\uff09\u3001\u8bed\u8a00\u8bc6\u522b\uff08\u4f7f\u7528 FastText \u4fdd\u7559\u82f1\u6587\u5185\u5bb9\uff09\u3001\u8d28\u91cf\u8fc7\u6ee4\uff08\u57fa\u4e8e\u542f\u53d1\u5f0f\u89c4\u5219\u79fb\u9664\u4f4e\u8d28\u91cf\u6587\u6863\uff09\u3001\u6a21\u7cca\u53bb\u91cd\uff08\u4f7f\u7528 MinHash LSH \u5728\u5927\u89c4\u6a21\u6570\u636e\u4e0a\u8fdb\u884c\u8fd1\u4f3c\u53bb\u91cd\uff09\u3002</p> <p>RefinedWeb \u8bba\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5b9e\u73b0\u7ec6\u8282\u548c\u6548\u679c\u8bc4\u4f30\uff0c\u662f\u5b66\u4e60\u9884\u8bad\u7ec3\u6570\u636e\u5904\u7406\u7684\u7edd\u4f73\u6559\u6750\u3002\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u867d\u7136 RefinedWeb \u516c\u5f00\u4e86\u6570\u636e\u96c6\u7684\u4e00\u4e2a\u5b50\u96c6\uff08\u7ea6 600B Token\uff09\uff0c\u4f46\u5b8c\u6574\u7248\u672c\u4ecd\u4fdd\u7559\u4e3a Falcon \u6a21\u578b\u7684\u72ec\u5bb6\u4f7f\u7528\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_13-the-pile","title":"3_1.3 The Pile\uff1a\u591a\u5143\u5316\u7684\u6570\u636e\u6df7\u5408","text":"<p>The Pile \u662f EleutherAI \u53d1\u5e03\u7684\u5f00\u6e90\u9884\u8bad\u7ec3\u6570\u636e\u96c6\uff0c\u89c4\u6a21\u7ea6 800GB\uff08\u89e3\u538b\u540e\uff09\uff0c\u5305\u542b\u7ea6 300B Token\u3002\u4e0e RefinedWeb \u4e13\u6ce8\u4e8e\u7f51\u9875\u6570\u636e\u4e0d\u540c\uff0cThe Pile \u7684\u8bbe\u8ba1\u7406\u5ff5\u662f\u591a\u5143\u5316\u2014\u2014\u5b83\u6df7\u5408\u4e86\u6765\u81ea 22 \u4e2a\u4e0d\u540c\u6765\u6e90\u7684\u6570\u636e\uff0c\u8986\u76d6\u7f51\u9875\u3001\u4e66\u7c4d\u3001\u4ee3\u7801\u3001\u8bba\u6587\u3001\u6cd5\u5f8b\u6587\u4ef6\u7b49\u591a\u4e2a\u9886\u57df\u3002</p> <p>The Pile \u7684\u6570\u636e\u6765\u6e90\u6784\u6210\u53cd\u6620\u4e86\u9884\u8bad\u7ec3\u6570\u636e\u591a\u6837\u6027\u7684\u91cd\u8981\u6027\u3002\u5176\u4e2d Pile-CC \u662f\u7ecf\u8fc7\u6e05\u6d17\u7684 Common Crawl \u5b50\u96c6\uff0c\u5360\u6bd4\u7ea6 50%\uff1bPubMed Central \u63d0\u4f9b\u751f\u7269\u533b\u5b66\u8bba\u6587\uff1bArXiv \u63d0\u4f9b\u79d1\u5b66\u9884\u5370\u672c\uff1bGitHub \u63d0\u4f9b\u5f00\u6e90\u4ee3\u7801\uff1bBooks3 \u63d0\u4f9b\u4e66\u7c4d\u6587\u672c\uff1bStackExchange \u63d0\u4f9b\u6280\u672f\u95ee\u7b54\uff1bWikipedia \u63d0\u4f9b\u767e\u79d1\u77e5\u8bc6\u3002\u8fd9\u79cd\u591a\u6765\u6e90\u6df7\u5408\u7b56\u7565\u88ab\u8bc1\u660e\u80fd\u591f\u63d0\u5347\u6a21\u578b\u5728\u5404\u7c7b\u4e0b\u6e38\u4efb\u52a1\u4e0a\u7684\u8868\u73b0\uff0c\u540e\u6765\u7684 LLaMA\u3001Mistral \u7b49\u6a21\u578b\u7684\u6570\u636e\u914d\u65b9\u90fd\u501f\u9274\u4e86\u7c7b\u4f3c\u7684\u601d\u8def\u3002</p> <p>\u7136\u800c\uff0cThe Pile \u5728\u6cd5\u5f8b\u5c42\u9762\u5b58\u5728\u4e89\u8bae\u3002\u5176\u4e2d\u7684 Books3 \u5b50\u96c6\u5305\u542b\u5927\u91cf\u7248\u6743\u4e66\u7c4d\uff0c\u5df2\u5f15\u53d1\u591a\u8d77\u8bc9\u8bbc\u3002\u5728\u4f7f\u7528 The Pile \u65f6\uff0c\u5efa\u8bae\u6839\u636e\u81ea\u8eab\u7684\u6cd5\u5f8b\u98ce\u9669\u627f\u53d7\u80fd\u529b\u8fdb\u884c\u8bc4\u4f30\uff0c\u6216\u8005\u9009\u62e9\u6027\u5730\u6392\u9664\u4e89\u8bae\u5b50\u96c6\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_14","title":"3_1.4 \u4e2d\u6587\u6570\u636e\u96c6\u6982\u89c8","text":"<p>\u5bf9\u4e8e\u8bad\u7ec3\u4e2d\u6587\u5927\u6a21\u578b\uff0c\u53ef\u7528\u7684\u5f00\u6e90\u6570\u636e\u96c6\u76f8\u5bf9\u8f83\u5c11\uff0c\u4f46\u8fd1\u5e74\u6765\u6709\u6240\u6539\u5584\u3002</p> <p>WuDaoCorpora \u662f\u667a\u6e90\u7814\u7a76\u9662\u53d1\u5e03\u7684\u5927\u89c4\u6a21\u4e2d\u6587\u8bed\u6599\u5e93\uff0c\u5305\u542b\u7ea6 3TB \u7684\u4e2d\u6587\u6587\u672c\uff0c\u6db5\u76d6\u767e\u79d1\u3001\u65b0\u95fb\u3001\u8bba\u575b\u3001\u95ee\u7b54\u7b49\u591a\u79cd\u6765\u6e90\u3002\u6570\u636e\u9700\u8981\u901a\u8fc7\u7533\u8bf7\u83b7\u53d6\uff0c\u4f7f\u7528\u65f6\u9700\u9075\u5b88\u76f8\u5173\u534f\u8bae\u3002ChineseCrawl \u662f\u4e2d\u6587\u7248\u7684 Common Crawl \u5b50\u96c6\u63d0\u53d6\uff0c\u6709\u591a\u4e2a\u793e\u533a\u7248\u672c\u53ef\u7528\u3002CLUECorpus \u662f CLUE \u57fa\u51c6\u56e2\u961f\u53d1\u5e03\u7684\u4e2d\u6587\u8bed\u6599\uff0c\u89c4\u6a21\u7ea6 100GB\uff0c\u9002\u5408\u4e2d\u5c0f\u89c4\u6a21\u5b9e\u9a8c\u3002</p> <p>\u76f8\u6bd4\u82f1\u6587\u6570\u636e\u96c6\u7684\u4e30\u5bcc\u7a0b\u5ea6\uff0c\u4e2d\u6587\u9884\u8bad\u7ec3\u6570\u636e\u4ecd\u7136\u662f\u4e00\u4e2a\"\u5356\u65b9\u5e02\u573a\"\u3002\u8fd9\u610f\u5473\u7740\u4e2d\u6587\u5927\u6a21\u578b\u56e2\u961f\u5f80\u5f80\u9700\u8981\u81ea\u884c\u4ece Common Crawl \u6216\u5176\u4ed6\u6765\u6e90\u83b7\u53d6\u548c\u5904\u7406\u4e2d\u6587\u6570\u636e\uff0c\u65e0\u6cd5\u5b8c\u5168\u4f9d\u8d56\u73b0\u6709\u5f00\u6e90\u6570\u636e\u96c6\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_2","title":"3_2 \u9ad8\u6027\u80fd\u7f51\u9875\u89e3\u6790","text":"<p>\u4ece Common Crawl \u6216\u81ea\u6709\u722c\u866b\u83b7\u53d6\u539f\u59cb HTML \u540e\uff0c\u4e0b\u4e00\u4e2a\u5173\u952e\u6b65\u9aa4\u662f\u4ece\u4e2d\u63d0\u53d6\u6b63\u6587\u6587\u672c\u3002\u8fd9\u770b\u4f3c\u7b80\u5355\uff0c\u5b9e\u9645\u4e0a\u662f\u6574\u4e2a\u6570\u636e\u7ba1\u7ebf\u4e2d\u6700\u5173\u952e\u7684\u73af\u8282\u4e4b\u4e00\u2014\u2014\u89e3\u6790\u8d28\u91cf\u76f4\u63a5\u51b3\u5b9a\u4e86\u6700\u7ec8\u8bed\u6599\u7684\u8d28\u91cf\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_21","title":"3_2.1 \u7f51\u9875\u89e3\u6790\u7684\u6311\u6218","text":"<p>\u73b0\u4ee3\u7f51\u9875\u8fdc\u6bd4\u8868\u9762\u770b\u8d77\u6765\u590d\u6742\u3002\u4e00\u4e2a\u5178\u578b\u7684\u7f51\u9875\u53ef\u80fd\u5305\u542b\uff1aHTML \u7ed3\u6784\u6807\u7b7e\u3001CSS \u6837\u5f0f\u5b9a\u4e49\u3001JavaScript \u4ee3\u7801\uff08\u5305\u62ec\u5185\u8054\u548c\u5916\u90e8\u5f15\u7528\uff09\u3001\u5bfc\u822a\u680f\u548c\u9875\u811a\u3001\u5e7f\u544a\u548c\u63a8\u5e7f\u5185\u5bb9\u3001\u8bc4\u8bba\u533a\u548c\u7528\u6237\u751f\u6210\u5185\u5bb9\u3001\u9875\u9762\u4fa7\u8fb9\u680f\u548c\u63a8\u8350\u5185\u5bb9\u3002\u800c\u6211\u4eec\u9700\u8981\u7684\u53ea\u662f\"\u6b63\u6587\"\u2014\u2014\u5373\u9875\u9762\u7684\u4e3b\u4f53\u5185\u5bb9\u90e8\u5206\u3002</p> <p>\u4f20\u7edf\u7684\u89e3\u6790\u65b9\u6cd5\uff08\u5982\u7b80\u5355\u5730\u53bb\u9664\u6240\u6709 HTML \u6807\u7b7e\uff09\u6548\u679c\u5f88\u5dee\uff0c\u56e0\u4e3a\u5b83\u65e0\u6cd5\u533a\u5206\u6b63\u6587\u548c\u566a\u58f0\u3002\u66f4\u9ad8\u7ea7\u7684\u65b9\u6cd5\u9700\u8981\u7406\u89e3\u7f51\u9875\u7684\u8bed\u4e49\u7ed3\u6784\uff0c\u8bc6\u522b\u54ea\u4e9b\u90e8\u5206\u662f\u771f\u6b63\u6709\u4ef7\u503c\u7684\u5185\u5bb9\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_22-trafilatura","title":"3_2.2 Trafilatura\uff1a\u5de5\u4e1a\u7ea7\u7684\u89e3\u6790\u5e93","text":"<p>Trafilatura \u662f\u76ee\u524d\u6700\u53d7\u63a8\u8350\u7684\u7f51\u9875\u6b63\u6587\u63d0\u53d6\u5e93\uff0c\u88ab RefinedWeb\u3001Dolma \u7b49\u4e3b\u6d41\u6570\u636e\u96c6\u91c7\u7528\u3002\u5b83\u7684\u6838\u5fc3\u4f18\u52bf\u5728\u4e8e\uff1a\u7cbe\u5fc3\u8c03\u4f18\u7684\u63d0\u53d6\u7b97\u6cd5\uff0c\u5728\u591a\u4e2a\u8bc4\u6d4b\u6570\u636e\u96c6\u4e0a\u8868\u73b0\u4f18\u5f02\uff1b\u826f\u597d\u7684\u591a\u8bed\u8a00\u652f\u6301\uff0c\u7279\u522b\u662f\u5bf9\u4e2d\u6587\u3001\u65e5\u6587\u7b49\u4e9a\u6d32\u8bed\u8a00\u7684\u5904\u7406\uff1b\u4e30\u5bcc\u7684\u914d\u7f6e\u9009\u9879\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u8c03\u6574\u63d0\u53d6\u7b56\u7565\uff1b\u5408\u7406\u7684\u6027\u80fd\u8868\u73b0\uff0c\u9002\u5408\u5927\u89c4\u6a21\u6570\u636e\u5904\u7406\u3002</p> <p>\u4f7f\u7528 Trafilatura \u7684\u57fa\u672c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>import trafilatura\n\n# \u4ece HTML \u4e2d\u63d0\u53d6\u6b63\u6587\ndef extract_content(html: str, url: str = None) -&gt; dict:\n    \"\"\"\n    \u4ece HTML \u63d0\u53d6\u6b63\u6587\u5185\u5bb9\n\n    Args:\n        html: \u539f\u59cb HTML \u5b57\u7b26\u4e32\n        url: \u53ef\u9009\u7684 URL\uff0c\u7528\u4e8e\u89e3\u6790\u76f8\u5bf9\u94fe\u63a5\n\n    Returns:\n        \u5305\u542b\u6b63\u6587\u548c\u5143\u6570\u636e\u7684\u5b57\u5178\n    \"\"\"\n    # \u6838\u5fc3\u63d0\u53d6\n    result = trafilatura.extract(\n        html,\n        url=url,\n        include_comments=False,    # \u6392\u9664\u8bc4\u8bba\u533a\n        include_tables=True,       # \u4fdd\u7559\u8868\u683c\u5185\u5bb9\n        no_fallback=False,         # \u5141\u8bb8\u4f7f\u7528\u5907\u9009\u7b97\u6cd5\n        favor_precision=True,      # \u4f18\u5148\u4fdd\u8bc1\u7cbe\u786e\u5ea6\n        output_format='txt'        # \u8f93\u51fa\u7eaf\u6587\u672c\n    )\n\n    # \u63d0\u53d6\u5143\u6570\u636e\n    metadata = trafilatura.extract_metadata(html)\n\n    return {\n        'text': result,\n        'title': metadata.title if metadata else None,\n        'author': metadata.author if metadata else None,\n        'date': metadata.date if metadata else None,\n        'url': url\n    }\n</code></pre> <p>Trafilatura \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u914d\u7f6e\u9009\u9879\uff0c\u4e0d\u540c\u7684\u53c2\u6570\u7ec4\u5408\u9002\u7528\u4e8e\u4e0d\u540c\u7684\u573a\u666f\u3002<code>include_comments</code> \u63a7\u5236\u662f\u5426\u4fdd\u7559\u9875\u9762\u8bc4\u8bba\u533a\u5185\u5bb9\uff0c\u5bf9\u4e8e\u8bba\u575b\u7c7b\u7f51\u7ad9\u53ef\u4ee5\u8bbe\u4e3a True\uff0c\u5bf9\u4e8e\u65b0\u95fb\u7f51\u7ad9\u901a\u5e38\u8bbe\u4e3a False\u3002<code>include_tables</code> \u63a7\u5236\u662f\u5426\u4fdd\u7559\u8868\u683c\uff0c\u5bf9\u4e8e\u6570\u636e\u7c7b\u9875\u9762\uff08\u5982 Wikipedia\uff09\u5e94\u8be5\u8bbe\u4e3a True\u3002<code>favor_precision</code> \u548c <code>favor_recall</code> \u662f\u4e00\u5bf9\u6743\u8861\u53c2\u6570\uff0c\u524d\u8005\u4f18\u5148\u4fdd\u8bc1\u63d0\u53d6\u5185\u5bb9\u7684\u51c6\u786e\u6027\uff08\u5b81\u53ef\u6f0f\u6389\u4e5f\u4e0d\u8981\u9519\u8bef\uff09\uff0c\u540e\u8005\u4f18\u5148\u4fdd\u8bc1\u63d0\u53d6\u7684\u5b8c\u6574\u6027\uff08\u5b81\u53ef\u6709\u566a\u58f0\u4e5f\u8981\u5b8c\u6574\uff09\u3002\u5bf9\u4e8e\u9884\u8bad\u7ec3\u6570\u636e\uff0c\u901a\u5e38\u9009\u62e9 <code>favor_precision=True</code>\uff0c\u56e0\u4e3a\u566a\u58f0\u6570\u636e\u5bf9\u6a21\u578b\u8bad\u7ec3\u6709\u5bb3\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_23","title":"3_2.3 \u5176\u4ed6\u89e3\u6790\u5de5\u5177\u5bf9\u6bd4","text":"<p>\u9664\u4e86 Trafilatura\uff0c\u8fd8\u6709\u51e0\u4e2a\u5e38\u7528\u7684\u7f51\u9875\u89e3\u6790\u5de5\u5177\uff0c\u5404\u6709\u7279\u70b9\u3002</p> <p>Readability \u6700\u521d\u7531 Mozilla \u5f00\u53d1\uff0c\u7528\u4e8e Firefox \u7684\u9605\u8bfb\u6a21\u5f0f\u3002\u5b83\u7684\u7b97\u6cd5\u76f8\u5bf9\u7b80\u5355\uff0c\u901f\u5ea6\u5feb\uff0c\u4f46\u5bf9\u590d\u6742\u9875\u9762\u7684\u5904\u7406\u6548\u679c\u4e00\u822c\u3002Python \u751f\u6001\u4e2d\u6709 readability-lxml \u7b49\u79fb\u690d\u7248\u672c\u3002</p> <p>Newspaper3k \u4e13\u95e8\u9488\u5bf9\u65b0\u95fb\u7f51\u7ad9\u4f18\u5316\uff0c\u80fd\u591f\u8f83\u597d\u5730\u63d0\u53d6\u6587\u7ae0\u6807\u9898\u3001\u6b63\u6587\u3001\u53d1\u5e03\u65e5\u671f\u3001\u4f5c\u8005\u7b49\u4fe1\u606f\u3002\u4f46\u5bf9\u975e\u65b0\u95fb\u7c7b\u7f51\u7ad9\u7684\u6548\u679c\u8f83\u5dee\uff0c\u4e14\u9879\u76ee\u7ef4\u62a4\u4e0d\u591f\u6d3b\u8dc3\u3002</p> <p>Justext \u662f\u4e00\u4e2a\u4e13\u6ce8\u4e8e\"\u6837\u677f\u6587\u672c\u53bb\u9664\"\uff08boilerplate removal\uff09\u7684\u5e93\uff0c\u7b97\u6cd5\u57fa\u4e8e\u6587\u672c\u5757\u7684\u94fe\u63a5\u5bc6\u5ea6\u548c\u6587\u672c\u5bc6\u5ea6\u3002\u5b83\u5728\u5b66\u672f\u7814\u7a76\u4e2d\u8f83\u5e38\u5f15\u7528\uff0c\u4f46\u5de5\u7a0b\u5b9e\u7528\u6027\u4e0d\u5982 Trafilatura\u3002</p> \u5de5\u5177 \u4f18\u52bf \u52a3\u52bf \u63a8\u8350\u573a\u666f Trafilatura \u7efc\u5408\u6548\u679c\u6700\u4f73\uff0c\u591a\u8bed\u8a00\u652f\u6301\u597d \u901f\u5ea6\u4e2d\u7b49 \u901a\u7528\u573a\u666f\uff0c\u9996\u9009 Readability \u901f\u5ea6\u5feb\uff0c\u7b97\u6cd5\u7b80\u5355 \u590d\u6742\u9875\u9762\u6548\u679c\u5dee \u5feb\u901f\u539f\u578b Newspaper3k \u65b0\u95fb\u7f51\u7ad9\u6548\u679c\u597d \u6cdb\u5316\u80fd\u529b\u5f31 \u65b0\u95fb\u8bed\u6599\u4e13\u9879 Justext \u5b66\u672f\u9a8c\u8bc1\u5145\u5206 \u5de5\u7a0b\u9002\u914d\u8f83\u5c11 \u7814\u7a76\u573a\u666f <p></p> <p>\u56fe3-2\uff1a\u7f51\u9875\u89e3\u6790\u5668\u8d28\u91cf\u5bf9\u6bd4 \u2014\u2014 Trafilatura \u5728 F1 \u5206\u6570\u4e0a\u9886\u5148\uff0c\u662f LLM \u6570\u636e\u5904\u7406\u7684\u9996\u9009\u5de5\u5177</p> <p>\u5728\u5b9e\u9645\u9879\u76ee\u4e2d\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u7b56\u7565\u662f\u4f7f\u7528 Trafilatura \u4f5c\u4e3a\u4e3b\u89e3\u6790\u5668\uff0c\u5f53\u63d0\u53d6\u7ed3\u679c\u4e3a\u7a7a\u6216\u8fc7\u77ed\u65f6\uff0c\u56de\u9000\u5230 Readability \u8fdb\u884c\u5c1d\u8bd5\u3002\u8fd9\u79cd\"\u4e3b\u5907\"\u7b56\u7565\u53ef\u4ee5\u63d0\u9ad8\u6574\u4f53\u7684\u63d0\u53d6\u6210\u529f\u7387\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_24","title":"3_2.4 \u5206\u5e03\u5f0f\u89e3\u6790\u67b6\u6784","text":"<p>\u5355\u673a\u5904\u7406\u80fd\u529b\u6709\u9650\uff0c\u9762\u5bf9 TB \u7ea7\u7684 WARC \u6587\u4ef6\uff0c\u9700\u8981\u6784\u5efa\u5206\u5e03\u5f0f\u89e3\u6790\u7cfb\u7edf\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u57fa\u4e8e Ray Data \u7684\u5206\u5e03\u5f0f\u89e3\u6790\u793a\u4f8b\uff1a</p> <pre><code>import ray\nimport trafilatura\nfrom warcio.archiveiterator import ArchiveIterator\nimport gzip\n\nray.init()\n\ndef parse_warc_record(record):\n    \"\"\"\u89e3\u6790\u5355\u6761 WARC \u8bb0\u5f55\"\"\"\n    if record.rec_type != 'response':\n        return None\n\n    url = record.rec_headers.get_header('WARC-Target-URI')\n    content_type = record.http_headers.get_header('Content-Type', '')\n\n    # \u53ea\u5904\u7406 HTML \u9875\u9762\n    if 'text/html' not in content_type:\n        return None\n\n    try:\n        html = record.content_stream().read().decode('utf-8', errors='ignore')\n        text = trafilatura.extract(html, url=url, favor_precision=True)\n\n        if text and len(text) &gt; 200:  # \u8fc7\u6ee4\u8fc7\u77ed\u7684\u5185\u5bb9\n            return {\n                'url': url,\n                'text': text,\n                'length': len(text)\n            }\n    except Exception as e:\n        return None\n\n    return None\n\ndef process_warc_file(warc_path: str):\n    \"\"\"\u5904\u7406\u5355\u4e2a WARC \u6587\u4ef6\"\"\"\n    results = []\n\n    with gzip.open(warc_path, 'rb') as f:\n        for record in ArchiveIterator(f):\n            result = parse_warc_record(record)\n            if result:\n                results.append(result)\n\n    return results\n\n# \u83b7\u53d6\u6240\u6709 WARC \u6587\u4ef6\u8def\u5f84\nwarc_files = [...]  # S3 \u6216\u672c\u5730\u8def\u5f84\u5217\u8868\n\n# \u5206\u5e03\u5f0f\u5e76\u884c\u5904\u7406\nds = ray.data.from_items(warc_files)\nds = ds.flat_map(process_warc_file)\n\n# \u4fdd\u5b58\u7ed3\u679c\nds.write_parquet(\"s3://bucket/parsed_data/\")\n</code></pre> <p>\u8fd9\u4e2a\u67b6\u6784\u7684\u5173\u952e\u8bbe\u8ba1\u70b9\u5305\u62ec\uff1a\u4f7f\u7528 Ray Data \u7684 <code>flat_map</code> \u7b97\u5b50\u5b9e\u73b0\u6587\u4ef6\u7ea7\u5e76\u884c\uff1b\u5728\u89e3\u6790\u51fd\u6570\u5185\u90e8\u8fdb\u884c\u9519\u8bef\u5904\u7406\uff0c\u907f\u514d\u5355\u6761\u6570\u636e\u7684\u5931\u8d25\u5f71\u54cd\u6574\u6279\u5904\u7406\uff1b\u901a\u8fc7 <code>len(text) &gt; 200</code> \u7b49\u6761\u4ef6\u8fdb\u884c\u65e9\u671f\u8fc7\u6ee4\uff0c\u51cf\u5c11\u4e0b\u6e38\u5904\u7406\u91cf\uff1b\u8f93\u51fa\u4e3a Parquet \u683c\u5f0f\uff0c\u4fbf\u4e8e\u540e\u7eed\u7684\u53bb\u91cd\u548c\u8fc7\u6ee4\u6b65\u9aa4\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_3","title":"3_3 \u7279\u79cd\u6570\u636e\u83b7\u53d6","text":"<p>\u9664\u4e86\u901a\u7528\u7684\u7f51\u9875\u6570\u636e\uff0c\u9884\u8bad\u7ec3\u8bed\u6599\u5e93\u901a\u5e38\u8fd8\u9700\u8981\u5305\u542b\u4ee3\u7801\u3001\u5b66\u672f\u8bba\u6587\u3001\u4e66\u7c4d\u7b49\u4e13\u95e8\u9886\u57df\u7684\u6570\u636e\u3002\u8fd9\u4e9b\"\u7279\u79cd\u6570\u636e\"\u7684\u83b7\u53d6\u548c\u5904\u7406\u6709\u5176\u72ec\u7279\u7684\u6311\u6218\u548c\u6280\u5de7\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_31-github-the-stack","title":"3_3.1 \u4ee3\u7801\u6570\u636e\uff1aGitHub \u4e0e The Stack","text":"<p>\u4ee3\u7801\u80fd\u529b\u662f\u73b0\u4ee3\u5927\u6a21\u578b\u7684\u6838\u5fc3\u7ade\u4e89\u529b\u4e4b\u4e00\uff0c\u800c\u9ad8\u8d28\u91cf\u4ee3\u7801\u6570\u636e\u7684\u83b7\u53d6\u662f\u5b9e\u73b0\u8fd9\u4e00\u80fd\u529b\u7684\u57fa\u7840\u3002\u76ee\u524d\u6700\u4e3b\u8981\u7684\u4ee3\u7801\u6570\u636e\u6765\u6e90\u662f GitHub\u3002</p> <p>\u76f4\u63a5\u4ece GitHub API \u83b7\u53d6\u4ee3\u7801\u662f\u53ef\u884c\u7684\uff0c\u4f46\u6548\u7387\u8f83\u4f4e\u4e14\u6709\u8bf7\u6c42\u9650\u5236\u3002\u66f4\u5e38\u89c1\u7684\u505a\u6cd5\u662f\u4f7f\u7528 GitHub \u7684\u516c\u5f00\u6570\u636e\u955c\u50cf\u3002Google BigQuery \u6258\u7ba1\u4e86 GitHub \u516c\u5f00\u4ed3\u5e93\u7684\u5b8c\u6574\u5feb\u7167\uff0c\u53ef\u4ee5\u4f7f\u7528 SQL \u8fdb\u884c\u67e5\u8be2\u548c\u5bfc\u51fa\u3002Software Heritage \u662f\u4e00\u4e2a\u81f4\u529b\u4e8e\u4fdd\u5b58\u4eba\u7c7b\u8f6f\u4ef6\u9057\u4ea7\u7684\u7ec4\u7ec7\uff0c\u7ef4\u62a4\u7740 GitHub \u7684\u5b8c\u6574\u5f52\u6863\u3002</p> <p>\u5bf9\u4e8e\u5927\u89c4\u6a21\u4ee3\u7801\u6570\u636e\u9700\u6c42\uff0c\u6700\u4fbf\u6377\u7684\u9009\u62e9\u662f\u4f7f\u7528 BigCode \u9879\u76ee\u53d1\u5e03\u7684 The Stack \u6570\u636e\u96c6\u3002\u8fd9\u4e2a\u6570\u636e\u96c6\u4ece GitHub \u722c\u53d6\u4e86\u8d85\u8fc7 300 \u79cd\u7f16\u7a0b\u8bed\u8a00\u7684\u4ee3\u7801\uff0c\u603b\u89c4\u6a21\u7ea6 3TB\u3002The Stack \u7684\u5904\u7406\u6d41\u7a0b\u5305\u62ec\uff1a\u57fa\u4e8e\u8bb8\u53ef\u8bc1\u8fc7\u6ee4\uff08\u53ea\u4fdd\u7559\u5f00\u6e90\u8bb8\u53ef\u8bc1\u5141\u8bb8\u4f7f\u7528\u7684\u4ee3\u7801\uff09\u3001\u53bb\u91cd\uff08\u79fb\u9664\u91cd\u590d\u7684\u6587\u4ef6\u548c\u4ee3\u7801\u7247\u6bb5\uff09\u3001PII \u6e05\u6d17\uff08\u79fb\u9664\u654f\u611f\u4fe1\u606f\uff09\u3002</p> <p>\u4f7f\u7528\u4ee3\u7801\u6570\u636e\u65f6\u9700\u8981\u7279\u522b\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <p>\u8bb8\u53ef\u8bc1\u5408\u89c4\u662f\u9996\u8981\u95ee\u9898\u3002\u4e0d\u540c\u7684\u5f00\u6e90\u8bb8\u53ef\u8bc1\u5bf9\u4ee3\u7801\u4f7f\u7528\u6709\u4e0d\u540c\u7684\u9650\u5236\u3002The Stack \u6570\u636e\u96c6\u63d0\u4f9b\u4e86\u8bb8\u53ef\u8bc1\u6807\u7b7e\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u8fdb\u884c\u7b5b\u9009\u3002\u5bf9\u4e8e\u5546\u4e1a\u6a21\u578b\u8bad\u7ec3\uff0c\u5efa\u8bae\u53ea\u4f7f\u7528 MIT\u3001Apache 2_0 \u7b49\u5bbd\u677e\u8bb8\u53ef\u8bc1\u7684\u4ee3\u7801\u3002</p> <p>\u4ee3\u7801\u8d28\u91cf\u5dee\u5f02\u5de8\u5927\u3002GitHub \u4e0a\u65e2\u6709 Linux \u5185\u6838\u8fd9\u6837\u7684\u9ad8\u8d28\u91cf\u9879\u76ee\uff0c\u4e5f\u6709\u5927\u91cf\u5b66\u751f\u4f5c\u4e1a\u548c\u4e2a\u4eba\u5b9e\u9a8c\u4ee3\u7801\u3002\u5e38\u7528\u7684\u8d28\u91cf\u8fc7\u6ee4\u7b56\u7565\u5305\u62ec\uff1a\u6309\u4ed3\u5e93 star \u6570\u7b5b\u9009\uff08\u4fdd\u7559 star &gt; 10 \u7684\u4ed3\u5e93\uff09\u3001\u6309\u6587\u4ef6\u957f\u5ea6\u8fc7\u6ee4\uff08\u79fb\u9664\u8fc7\u77ed\u6216\u8fc7\u957f\u7684\u6587\u4ef6\uff09\u3001\u57fa\u4e8e AST \u89e3\u6790\u68c0\u6d4b\u8bed\u6cd5\u9519\u8bef\u3002</p> <p>\u5904\u7406\u4ee3\u7801\u6570\u636e\u7684\u793a\u4f8b\uff1a</p> <pre><code>import ast\nfrom typing import Optional\n\ndef is_valid_python(code: str) -&gt; bool:\n    \"\"\"\u68c0\u67e5 Python \u4ee3\u7801\u662f\u5426\u8bed\u6cd5\u6b63\u786e\"\"\"\n    try:\n        ast.parse(code)\n        return True\n    except SyntaxError:\n        return False\n\ndef extract_functions(code: str) -&gt; list:\n    \"\"\"\u63d0\u53d6\u4ee3\u7801\u4e2d\u7684\u51fd\u6570\u5b9a\u4e49\"\"\"\n    try:\n        tree = ast.parse(code)\n        functions = []\n        for node in ast.walk(tree):\n            if isinstance(node, ast.FunctionDef):\n                functions.append(ast.unparse(node))\n        return functions\n    except:\n        return []\n\ndef filter_code_quality(code: str, \n                        min_lines: int = 10, \n                        max_lines: int = 1000,\n                        require_docstring: bool = True) -&gt; Optional[str]:\n    \"\"\"\u4ee3\u7801\u8d28\u91cf\u8fc7\u6ee4\"\"\"\n    lines = code.split('\\n')\n\n    # \u957f\u5ea6\u8fc7\u6ee4\n    if not (min_lines &lt;= len(lines) &lt;= max_lines):\n        return None\n\n    # \u8bed\u6cd5\u68c0\u67e5\n    if not is_valid_python(code):\n        return None\n\n    # Docstring \u68c0\u67e5\uff08\u53ef\u9009\uff09\n    if require_docstring and '\"\"\"' not in code and \"'''\" not in code:\n        return None\n\n    return code\n</code></pre>"},{"location":"chapter2/2_1_data_acquisition/#3_32-arxiv-s2orc","title":"3_3.2 \u5b66\u672f\u8bba\u6587\uff1aArXiv \u4e0e S2ORC","text":"<p>\u5b66\u672f\u8bba\u6587\u662f\u9ad8\u8d28\u91cf\u77e5\u8bc6\u7684\u91cd\u8981\u6765\u6e90\uff0c\u5bf9\u4e8e\u63d0\u5347\u6a21\u578b\u7684\u63a8\u7406\u80fd\u529b\u548c\u4e13\u4e1a\u77e5\u8bc6\u6c34\u5e73\u6709\u663e\u8457\u5e2e\u52a9\u3002</p> <p>ArXiv \u662f\u6700\u91cd\u8981\u7684\u5f00\u653e\u83b7\u53d6\u9884\u5370\u672c\u5e73\u53f0\uff0c\u6db5\u76d6\u7269\u7406\u3001\u6570\u5b66\u3001\u8ba1\u7b97\u673a\u79d1\u5b66\u3001\u751f\u7269\u5b66\u7b49\u9886\u57df\u7684\u5b66\u672f\u8bba\u6587\u3002ArXiv \u63d0\u4f9b\u6279\u91cf\u4e0b\u8f7d\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7\u5176 S3 \u6876\u83b7\u53d6 LaTeX \u6e90\u6587\u4ef6\u548c PDF\u3002LaTeX \u6e90\u6587\u4ef6\u662f\u66f4\u7406\u60f3\u7684\u6570\u636e\u6765\u6e90\uff0c\u56e0\u4e3a\u5b83\u4fdd\u7559\u4e86\u8bba\u6587\u7684\u7ed3\u6784\u4fe1\u606f\uff08\u7ae0\u8282\u3001\u516c\u5f0f\u3001\u5f15\u7528\u7b49\uff09\uff0c\u4e14\u662f\u7eaf\u6587\u672c\u683c\u5f0f\uff0c\u6613\u4e8e\u5904\u7406\u3002</p> <p>\u5904\u7406 ArXiv LaTeX \u6570\u636e\u7684\u4e3b\u8981\u6311\u6218\u5728\u4e8e LaTeX \u8bed\u6cd5\u7684\u590d\u6742\u6027\u3002\u4e00\u7bc7\u8bba\u6587\u53ef\u80fd\u5305\u542b\u6570\u5341\u4e2a <code>.tex</code> \u6587\u4ef6\uff0c\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u5b8f\u548c\u6837\u5f0f\u3002\u4e00\u4e2a\u5b9e\u7528\u7684\u7b80\u5316\u7b56\u7565\u662f\uff1a\u53ea\u63d0\u53d6\u4e3b\u6587\u4ef6\uff08\u901a\u5e38\u662f <code>main.tex</code> \u6216\u4e0e\u8bba\u6587\u6807\u9898\u76f8\u5173\u7684\u6587\u4ef6\uff09\uff0c\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u53bb\u9664\u56fe\u8868\u548c\u590d\u6742\u516c\u5f0f\u73af\u5883\uff0c\u4fdd\u7559\u6b63\u6587\u6587\u672c\u548c\u7b80\u5355\u7684\u6570\u5b66\u8868\u8fbe\u5f0f\u3002</p> <pre><code>import re\nimport tarfile\nfrom pathlib import Path\n\ndef extract_arxiv_text(latex_content: str) -&gt; str:\n    \"\"\"\u4ece LaTeX \u4e2d\u63d0\u53d6\u7eaf\u6587\u672c\"\"\"\n    text = latex_content\n\n    # \u79fb\u9664\u6ce8\u91ca\n    text = re.sub(r'%.*$', '', text, flags=re.MULTILINE)\n\n    # \u79fb\u9664\u56fe\u8868\u73af\u5883\n    text = re.sub(r'\\\\begin\\{figure\\}.*?\\\\end\\{figure\\}', '', text, flags=re.DOTALL)\n    text = re.sub(r'\\\\begin\\{table\\}.*?\\\\end\\{table\\}', '', text, flags=re.DOTALL)\n\n    # \u7b80\u5316\u5f15\u7528\n    text = re.sub(r'\\\\cite\\{[^}]+\\}', '[CITATION]', text)\n    text = re.sub(r'\\\\ref\\{[^}]+\\}', '[REF]', text)\n\n    # \u79fb\u9664\u5e38\u89c1\u7684\u547d\u4ee4\u4f46\u4fdd\u7559\u53c2\u6570\n    commands_to_strip = ['textbf', 'textit', 'emph', 'section', 'subsection', \n                         'paragraph', 'title', 'author']\n    for cmd in commands_to_strip:\n        text = re.sub(rf'\\\\{cmd}\\{{([^}}]+)\\}}', r'\\1', text)\n\n    # \u79fb\u9664\u5176\u4ed6\u547d\u4ee4\n    text = re.sub(r'\\\\[a-zA-Z]+(\\[[^\\]]*\\])?\\{[^}]*\\}', '', text)\n    text = re.sub(r'\\\\[a-zA-Z]+', '', text)\n\n    # \u6e05\u7406\u7a7a\u767d\n    text = re.sub(r'\\n\\s*\\n', '\\n\\n', text)\n    text = re.sub(r' +', ' ', text)\n\n    return text.strip()\n</code></pre> <p>Semantic Scholar Open Research Corpus (S2ORC) \u662f Allen AI \u53d1\u5e03\u7684\u5927\u89c4\u6a21\u5b66\u672f\u8bba\u6587\u6570\u636e\u96c6\uff0c\u5305\u542b\u8d85\u8fc7 80M \u7bc7\u8bba\u6587\u7684\u5143\u6570\u636e\u548c\u7ea6 8M \u7bc7\u8bba\u6587\u7684\u5168\u6587\u3002\u76f8\u6bd4 ArXiv\uff0cS2ORC \u8986\u76d6\u7684\u9886\u57df\u66f4\u5e7f\uff0c\u5305\u62ec PubMed\u3001ACL Anthology \u7b49\u591a\u4e2a\u6765\u6e90\u3002S2ORC \u7684\u5168\u6587\u5df2\u7ecf\u5904\u7406\u4e3a\u7ed3\u6784\u5316\u7684 JSON \u683c\u5f0f\uff0c\u7701\u53bb\u4e86 LaTeX/PDF \u89e3\u6790\u7684\u9ebb\u70e6\uff0c\u662f\u5feb\u901f\u83b7\u53d6\u8bba\u6587\u6570\u636e\u7684\u4fbf\u6377\u9009\u62e9\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_33","title":"3_3.3 \u4e66\u7c4d\u6570\u636e\uff1a\u7248\u6743\u4e0e\u66ff\u4ee3\u65b9\u6848","text":"<p>\u4e66\u7c4d\u662f\u9ad8\u8d28\u91cf\u957f\u6587\u672c\u7684\u91cd\u8981\u6765\u6e90\uff0c\u5bf9\u4e8e\u8bad\u7ec3\u6a21\u578b\u7684\u957f\u7a0b\u7406\u89e3\u80fd\u529b\u548c\u77e5\u8bc6\u6df1\u5ea6\u6709\u91cd\u8981\u4ef7\u503c\u3002\u7136\u800c\uff0c\u4e66\u7c4d\u6570\u636e\u7684\u7248\u6743\u95ee\u9898\u5c24\u4e3a\u654f\u611f\u3002</p> <p>The Pile \u4e2d\u7684 Books3 \u6570\u636e\u96c6\u5305\u542b\u7ea6 20 \u4e07\u672c\u4e66\u7c4d\uff0c\u6765\u81ea Bibliotik \u7b49\u6765\u6e90\u3002\u8fd9\u4e2a\u6570\u636e\u96c6\u5df2\u5f15\u53d1\u591a\u8d77\u7248\u6743\u8bc9\u8bbc\uff0c\u591a\u5bb6\u516c\u53f8\u56e0\u4f7f\u7528\u8be5\u6570\u636e\u96c6\u8bad\u7ec3\u6a21\u578b\u800c\u88ab\u8d77\u8bc9\u3002\u5728\u5f53\u524d\u7684\u6cd5\u5f8b\u73af\u5883\u4e0b\uff0c\u76f4\u63a5\u4f7f\u7528 Books3 \u5b58\u5728\u663e\u8457\u7684\u6cd5\u5f8b\u98ce\u9669\u3002</p> <p>\u5408\u89c4\u7684\u66ff\u4ee3\u65b9\u6848\u5305\u62ec\uff1a</p> <p></p> <p>\u56fe3-3\uff1a\u9884\u8bad\u7ec3\u6570\u636e\u6765\u6e90\u6df7\u5408 \u2014\u2014 \u591a\u6e90\u6df7\u5408\u7b56\u7565\u53ef\u63d0\u5347\u6a21\u578b\u7684\u7efc\u5408\u80fd\u529b</p> <p>Project Gutenberg \u662f\u4e00\u4e2a\u5fd7\u613f\u8005\u9879\u76ee\uff0c\u63d0\u4f9b\u7248\u6743\u8fc7\u671f\u7684\u7ecf\u5178\u4e66\u7c4d\u3002\u4e3b\u8981\u662f 1928 \u5e74\u524d\u51fa\u7248\u7684\u82f1\u6587\u4e66\u7c4d\uff0c\u7ea6 70,000 \u672c\u3002\u6570\u636e\u8d28\u91cf\u9ad8\uff0c\u4f46\u65f6\u4ee3\u8f83\u8fdc\uff0c\u73b0\u4ee3\u7528\u8bed\u8986\u76d6\u4e0d\u8db3\u3002</p> <p>Internet Archive \u7684 Open Library \u63d0\u4f9b\u53ef\u501f\u9605\u7684\u7535\u5b50\u4e66\u3002\u4f7f\u7528\u65f6\u9700\u8981\u9075\u5b88\u5176\u501f\u9605\u534f\u8bae\uff0c\u5927\u89c4\u6a21\u6279\u91cf\u83b7\u53d6\u53ef\u80fd\u8fdd\u53cd\u670d\u52a1\u6761\u6b3e\u3002</p> <p>\u7ef4\u57fa\u6587\u5e93\uff08Wikisource\uff09\u63d0\u4f9b\u516c\u5171\u9886\u57df\u7684\u6587\u5b66\u4f5c\u54c1\uff0c\u8986\u76d6\u591a\u79cd\u8bed\u8a00\uff0c\u5305\u62ec\u5927\u91cf\u4e2d\u6587\u53e4\u7c4d\u3002</p> <p>\u5b66\u672f\u6559\u6750\u548c\u5f00\u653e\u6559\u80b2\u8d44\u6e90\uff08OER\uff09\u5982 OpenStax \u63d0\u4f9b\u9ad8\u8d28\u91cf\u7684\u6559\u6750\u5185\u5bb9\uff0c\u9002\u5408\u7528\u4e8e\u6784\u5efa\u6559\u80b2\u7c7b\u9884\u8bad\u7ec3\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u5546\u4e1a\u6a21\u578b\u8bad\u7ec3\uff0c\u6700\u5b89\u5168\u7684\u7b56\u7565\u662f\u53ea\u4f7f\u7528\u660e\u786e\u83b7\u5f97\u6388\u6743\u6216\u5904\u4e8e\u516c\u5171\u9886\u57df\u7684\u4e66\u7c4d\u6570\u636e\u3002\u867d\u7136\u8fd9\u4f1a\u9650\u5236\u6570\u636e\u89c4\u6a21\uff0c\u4f46\u53ef\u4ee5\u907f\u514d\u6f5c\u5728\u7684\u6cd5\u5f8b\u98ce\u9669\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_34","title":"3_3.4 \u591a\u8bed\u8a00\u6570\u636e\u5e73\u8861","text":"<p>\u8bad\u7ec3\u591a\u8bed\u8a00\u6a21\u578b\u65f6\uff0c\u4e0d\u540c\u8bed\u8a00\u7684\u6570\u636e\u53ef\u7528\u6027\u5dee\u5f02\u5de8\u5927\u3002\u82f1\u8bed\u6570\u636e\u6700\u4e3a\u4e30\u5bcc\uff0c\u4e2d\u6587\u3001\u65e5\u6587\u3001\u5fb7\u6587\u7b49\u4e3b\u8981\u8bed\u8a00\u6b21\u4e4b\uff0c\u800c\u5c0f\u8bed\u79cd\u7684\u9ad8\u8d28\u91cf\u6570\u636e\u5219\u6781\u4e3a\u7a00\u7f3a\u3002</p> <p>\u6570\u636e\u4e0d\u5e73\u8861\u4f1a\u5bfc\u81f4\u6a21\u578b\u80fd\u529b\u7684\u4e0d\u5747\u8861\u3002\u5982\u679c\u7b80\u5355\u6309\u539f\u59cb\u6bd4\u4f8b\u6df7\u5408\uff0c\u82f1\u8bed\u5c06\u5360\u636e\u7edd\u5bf9\u4f18\u52bf\uff0c\u5c0f\u8bed\u79cd\u51e0\u4e4e\u5b66\u4e0d\u5230\u3002\u5e38\u89c1\u7684\u89e3\u51b3\u7b56\u7565\u5305\u62ec\uff1a</p> <p>\u4e0a\u91c7\u6837\u5c0f\u8bed\u79cd\u662f\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\uff0c\u901a\u8fc7\u91cd\u590d\u91c7\u6837\u63d0\u9ad8\u5c0f\u8bed\u79cd\u6570\u636e\u7684\u6743\u91cd\u3002\u4f46\u8fc7\u5ea6\u91cd\u590d\u53ef\u80fd\u5bfc\u81f4\u8fc7\u62df\u5408\u3002</p> <p>\u6e29\u5ea6\u91c7\u6837\u662f\u66f4\u7cbe\u7ec6\u7684\u65b9\u6cd5\u3002\u8bbe\u5b9a\u4e00\u4e2a\u6e29\u5ea6\u53c2\u6570 T\uff0c\u8bed\u8a00 L \u7684\u91c7\u6837\u6982\u7387\u4e3a \\(p_L \\propto n_L^{1/T}\\)\uff0c\u5176\u4e2d \\(n_L\\) \u662f\u8be5\u8bed\u8a00\u7684\u539f\u59cb\u6570\u636e\u91cf\u3002T=1 \u65f6\u9000\u5316\u4e3a\u539f\u59cb\u6bd4\u4f8b\uff0cT\u2192\u221e \u65f6\u63a5\u8fd1\u5747\u5300\u5206\u5e03\u3002LLaMA 2 \u4f7f\u7528\u4e86 T=0_3 \u5de6\u53f3\u7684\u6e29\u5ea6\u91c7\u6837\u3002</p> <p>\u8d28\u91cf\u4ee3\u66ff\u6570\u91cf\u7684\u601d\u8def\u4e5f\u503c\u5f97\u8003\u8651\u3002\u5bf9\u4e8e\u6570\u636e\u7a00\u7f3a\u7684\u5c0f\u8bed\u79cd\uff0c\u53ef\u4ee5\u4f7f\u7528\u7ffb\u8bd1\u6216\u5408\u6210\u7684\u65b9\u5f0f\u589e\u5f3a\u6570\u636e\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u7ffb\u8bd1\u8d28\u91cf\u548c\u7ffb\u8bd1\u8154\u95ee\u9898\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_4","title":"3_4 \u6570\u636e\u83b7\u53d6\u7684\u5de5\u7a0b\u5b9e\u8df5","text":"<p>\u5c06\u4e0a\u8ff0\u5404\u4e2a\u73af\u8282\u4e32\u8054\u8d77\u6765\uff0c\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u6570\u636e\u83b7\u53d6\u6d41\u6c34\u7ebf\uff0c\u9700\u8981\u8003\u8651\u5de5\u7a0b\u5c42\u9762\u7684\u8bf8\u591a\u7ec6\u8282\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_41","title":"3_4.1 \u722c\u866b\u67b6\u6784\u8bbe\u8ba1","text":"<p>\u5bf9\u4e8e\u9700\u8981\u81ea\u4e3b\u722c\u53d6\u6570\u636e\u7684\u573a\u666f\uff08\u800c\u975e\u4f7f\u7528 Common Crawl\uff09\uff0c\u5206\u5e03\u5f0f\u722c\u866b\u67b6\u6784\u7684\u8bbe\u8ba1\u81f3\u5173\u91cd\u8981\u3002\u4e00\u4e2a\u5178\u578b\u7684\u67b6\u6784\u5305\u62ec\u4ee5\u4e0b\u7ec4\u4ef6\uff1a</p> <p>URL \u7ba1\u7406\u5668\u8d1f\u8d23\u7ef4\u62a4\u5f85\u722c\u53d6 URL \u7684\u961f\u5217\uff0c\u8bb0\u5f55\u5df2\u722c\u53d6 URL \u7684\u72b6\u6001\uff0c\u5904\u7406 URL \u7684\u53bb\u91cd\u548c\u4f18\u5148\u7ea7\u6392\u5e8f\u3002\u5e38\u7528\u7684\u5b9e\u73b0\u65b9\u5f0f\u5305\u62ec Redis \u961f\u5217\u914d\u5408 Bloom Filter \u53bb\u91cd\u3002</p> <p></p> <p>\u56fe3-4\uff1a\u5206\u5e03\u5f0f\u7f51\u9875\u722c\u53d6\u7cfb\u7edf\u67b6\u6784 \u2014\u2014 URL\u7ba1\u7406\u5668\u3001\u4e0b\u8f7d\u5668\u96c6\u7fa4\u3001\u89e3\u6790\u5668\u4e0e\u5b58\u50a8\u5c42\u7684\u534f\u4f5c</p> <p>\u4e0b\u8f7d\u5668\u96c6\u7fa4\u8d1f\u8d23\u5b9e\u9645\u7684 HTTP \u8bf7\u6c42\u3002\u5173\u952e\u8003\u8651\u56e0\u7d20\u5305\u62ec\uff1a\u5e76\u53d1\u63a7\u5236\uff08\u907f\u514d\u5bf9\u76ee\u6807\u7f51\u7ad9\u9020\u6210\u8fc7\u5927\u538b\u529b\uff09\u3001\u4ee3\u7406\u6c60\u7ba1\u7406\uff08\u5e94\u5bf9\u53cd\u722c\u866b\u673a\u5236\uff09\u3001\u91cd\u8bd5\u7b56\u7565\uff08\u5904\u7406\u7f51\u7edc\u6ce2\u52a8\u548c\u4e34\u65f6\u6545\u969c\uff09\u3001robots.txt \u9075\u5b88\uff08\u5c0a\u91cd\u7f51\u7ad9\u7684\u722c\u866b\u89c4\u5219\uff09\u3002</p> <p>\u89e3\u6790\u5668\u8d1f\u8d23\u4ece\u4e0b\u8f7d\u7684 HTML \u4e2d\u63d0\u53d6\u6b63\u6587\u548c\u5143\u6570\u636e\uff0c\u8fd9\u90e8\u5206\u5728\u4e0a\u4e00\u8282\u5df2\u8be6\u7ec6\u8ba8\u8bba\u3002</p> <p>\u5b58\u50a8\u5c42\u8d1f\u8d23\u6301\u4e45\u5316\u722c\u53d6\u7ed3\u679c\u3002\u5bf9\u4e8e\u5927\u89c4\u6a21\u722c\u53d6\uff0c\u5efa\u8bae\u76f4\u63a5\u5199\u5165\u5bf9\u8c61\u5b58\u50a8\uff08S3/MinIO\uff09\uff0c\u91c7\u7528 WARC \u6216 Parquet \u683c\u5f0f\u3002</p> <pre><code># \u7b80\u5316\u7684\u722c\u866b\u793a\u4f8b\nimport asyncio\nimport aiohttp\nfrom urllib.parse import urlparse\nimport trafilatura\n\nclass SimpleCrawler:\n    def __init__(self, max_concurrent: int = 100):\n        self.max_concurrent = max_concurrent\n        self.semaphore = asyncio.Semaphore(max_concurrent)\n        self.visited = set()\n\n    async def fetch(self, session: aiohttp.ClientSession, url: str) -&gt; dict:\n        \"\"\"\u5f02\u6b65\u83b7\u53d6\u5e76\u89e3\u6790\u5355\u4e2a URL\"\"\"\n        if url in self.visited:\n            return None\n        self.visited.add(url)\n\n        async with self.semaphore:\n            try:\n                async with session.get(url, timeout=30) as response:\n                    if response.status != 200:\n                        return None\n                    html = await response.text()\n                    text = trafilatura.extract(html, url=url)\n                    return {'url': url, 'text': text} if text else None\n            except Exception:\n                return None\n\n    async def crawl(self, urls: list) -&gt; list:\n        \"\"\"\u6279\u91cf\u722c\u53d6 URL \u5217\u8868\"\"\"\n        async with aiohttp.ClientSession() as session:\n            tasks = [self.fetch(session, url) for url in urls]\n            results = await asyncio.gather(*tasks)\n            return [r for r in results if r is not None]\n</code></pre>"},{"location":"chapter2/2_1_data_acquisition/#3_42","title":"3_4.2 \u589e\u91cf\u66f4\u65b0\u7b56\u7565","text":"<p>\u9884\u8bad\u7ec3\u6570\u636e\u4e0d\u662f\u4e00\u6b21\u6027\u4efb\u52a1\u3002\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u9700\u8981\u6301\u7eed\u5438\u6536\u65b0\u6570\u636e\u4ee5\u4fdd\u6301\u6a21\u578b\u77e5\u8bc6\u7684\u65f6\u6548\u6027\u3002\u589e\u91cf\u66f4\u65b0\u7684\u5173\u952e\u6311\u6218\u5728\u4e8e\uff1a</p> <p>\u8bc6\u522b\u65b0\u6570\u636e\uff1a\u5bf9\u4e8e Common Crawl\uff0c\u6bcf\u6708\u53d1\u5e03\u65b0\u6279\u6b21\uff0c\u53ef\u4ee5\u76f4\u63a5\u5904\u7406\u65b0\u6279\u6b21\u3002\u5bf9\u4e8e\u81ea\u4e3b\u722c\u53d6\uff0c\u9700\u8981\u7ef4\u62a4\u66f4\u65b0\u65f6\u95f4\u6233\uff0c\u5b9a\u671f\u91cd\u65b0\u8bbf\u95ee\u5df2\u77e5 URL \u68c0\u67e5\u66f4\u65b0\u3002</p> <p>\u907f\u514d\u91cd\u590d\u5904\u7406\uff1a\u5df2\u7ecf\u5904\u7406\u8fc7\u7684\u6570\u636e\u4e0d\u5e94\u91cd\u590d\u8fdb\u5165\u6d41\u6c34\u7ebf\u3002\u53ef\u4ee5\u901a\u8fc7 URL \u6307\u7eb9\u3001\u5185\u5bb9\u54c8\u5e0c\u7b49\u65b9\u5f0f\u8fdb\u884c\u53bb\u91cd\u3002</p> <p>\u7248\u672c\u7ba1\u7406\uff1a\u6bcf\u4e2a\u5904\u7406\u6279\u6b21\u5e94\u8be5\u6709\u660e\u786e\u7684\u7248\u672c\u6807\u8bc6\uff0c\u4fbf\u4e8e\u8ffd\u6eaf\u548c\u56de\u6eda\u3002\u8fd9\u4e0e\u7b2c\u4e8c\u7ae0\u8ba8\u8bba\u7684\u6570\u636e\u7248\u672c\u63a7\u5236\uff08DVC/LakeFS\uff09\u7d27\u5bc6\u76f8\u5173\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_43","title":"3_4.3 \u8d28\u91cf\u76d1\u63a7\u4e0e\u53cd\u9988","text":"<p>\u6570\u636e\u83b7\u53d6\u6d41\u6c34\u7ebf\u9700\u8981\u5efa\u7acb\u5b8c\u5584\u7684\u8d28\u91cf\u76d1\u63a7\u673a\u5236\u3002\u5173\u952e\u7684\u76d1\u63a7\u6307\u6807\u5305\u62ec\uff1a</p> <p>\u4e0b\u8f7d\u6210\u529f\u7387\uff1a\u5931\u8d25\u8bf7\u6c42\u7684\u6bd4\u4f8b\u3002\u5982\u679c\u7a81\u7136\u5347\u9ad8\uff0c\u53ef\u80fd\u662f\u76ee\u6807\u7f51\u7ad9\u5c01\u7981\u4e86\u722c\u866b\u3002</p> <p>\u89e3\u6790\u6210\u529f\u7387\uff1a\u6210\u529f\u63d0\u53d6\u6b63\u6587\u7684\u6bd4\u4f8b\u3002\u5982\u679c\u964d\u4f4e\uff0c\u53ef\u80fd\u662f\u76ee\u6807\u7f51\u7ad9\u6539\u53d8\u4e86\u9875\u9762\u7ed3\u6784\u3002</p> <p>\u5e73\u5747\u6587\u6863\u957f\u5ea6\uff1a\u6b63\u6587\u7684\u5e73\u5747\u5b57\u7b26\u6570\u3002\u5f02\u5e38\u6ce2\u52a8\u53ef\u80fd\u8868\u793a\u89e3\u6790\u5668\u6709\u95ee\u9898\u3002</p> <p>\u8bed\u8a00\u5206\u5e03\uff1a\u5404\u8bed\u8a00\u6570\u636e\u7684\u6bd4\u4f8b\u3002\u786e\u4fdd\u7b26\u5408\u9884\u671f\u7684\u8bed\u8a00\u914d\u6bd4\u3002</p> <p>\u91cd\u590d\u7387\uff1a\u4e0e\u5386\u53f2\u6570\u636e\u7684\u91cd\u590d\u6bd4\u4f8b\u3002\u8fc7\u9ad8\u7684\u91cd\u590d\u7387\u610f\u5473\u7740\u65b0\u589e\u6570\u636e\u7684\u8fb9\u9645\u4ef7\u503c\u964d\u4f4e\u3002</p> <p>\u5efa\u8bae\u5c06\u8fd9\u4e9b\u6307\u6807\u96c6\u6210\u5230\u76d1\u63a7\u7cfb\u7edf\u4e2d\uff08\u5982 Prometheus + Grafana\uff09\uff0c\u8bbe\u7f6e\u544a\u8b66\u9608\u503c\uff0c\u53ca\u65f6\u53d1\u73b0\u548c\u5904\u7406\u5f02\u5e38\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_5","title":"3_5 \u5e38\u89c1\u9677\u9631\u4e0e\u6700\u4f73\u5b9e\u8df5","text":"<p>\u5728\u6570\u636e\u83b7\u53d6\u9636\u6bb5\uff0c\u6709\u51e0\u4e2a\u5e38\u89c1\u7684\u9677\u9631\u503c\u5f97\u8b66\u60d5\u3002</p> <p>\u7b2c\u4e00\u4e2a\u9677\u9631\u662f\u8fc7\u5ea6\u4f9d\u8d56\u5355\u4e00\u6570\u636e\u6e90\u3002 \u5982\u679c\u9884\u8bad\u7ec3\u6570\u636e\u5168\u90e8\u6765\u81ea Common Crawl\uff0c\u6a21\u578b\u53ef\u80fd\u4f1a\u7ee7\u627f\u7f51\u9875\u6570\u636e\u7684\u504f\u89c1\u548c\u566a\u58f0\u3002\u5408\u7406\u7684\u505a\u6cd5\u662f\u6df7\u5408\u591a\u79cd\u6765\u6e90\uff1a\u7f51\u9875\u6570\u636e\u63d0\u4f9b\u5e7f\u5ea6\uff0c\u4e66\u7c4d\u548c\u8bba\u6587\u63d0\u4f9b\u6df1\u5ea6\uff0c\u4ee3\u7801\u6570\u636e\u63d0\u4f9b\u903b\u8f91\u80fd\u529b\u3002The Pile \u5f0f\u7684\u591a\u6e90\u6df7\u5408\u7b56\u7565\u88ab\u8bc1\u660e\u662f\u6709\u6548\u7684\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u9677\u9631\u662f\u5ffd\u89c6\u6570\u636e\u7684\u65f6\u6548\u6027\u3002 Common Crawl \u7684\u5386\u53f2\u6279\u6b21\u867d\u7136\u91cf\u5927\uff0c\u4f46\u53ef\u80fd\u5305\u542b\u8fc7\u65f6\u4fe1\u606f\u3002\u5bf9\u4e8e\u9700\u8981\u65f6\u6548\u6027\u7684\u5e94\u7528\uff08\u5982\u65b0\u95fb\u3001\u65f6\u4e8b\uff09\uff0c\u5e94\u8be5\u4f18\u5148\u4f7f\u7528\u6700\u8fd1\u7684\u6570\u636e\u6279\u6b21\u3002\u540c\u65f6\uff0c\u8fc7\u8001\u7684\u6570\u636e\u53ef\u80fd\u5305\u542b\u5df2\u5931\u6548\u7684\u94fe\u63a5\u3001\u5df2\u66f4\u6b63\u7684\u9519\u8bef\u4fe1\u606f\u7b49\u3002</p> <p>\u7b2c\u4e09\u4e2a\u9677\u9631\u662f\u4f4e\u4f30\u5408\u89c4\u98ce\u9669\u3002 \u7248\u6743\u95ee\u9898\u3001\u9690\u79c1\u95ee\u9898\u3001robots.txt \u8fdd\u89c4\u7b49\uff0c\u53ef\u80fd\u5728\u9879\u76ee\u540e\u671f\u5f15\u53d1\u4e25\u91cd\u7684\u6cd5\u5f8b\u95ee\u9898\u3002\u6700\u4f73\u5b9e\u8df5\u662f\u5728\u6570\u636e\u83b7\u53d6\u9636\u6bb5\u5c31\u5efa\u7acb\u5b8c\u5584\u7684\u5143\u6570\u636e\u8bb0\u5f55\u2014\u2014\u8bb0\u5f55\u6bcf\u6761\u6570\u636e\u7684\u6765\u6e90 URL\u3001\u83b7\u53d6\u65f6\u95f4\u3001\u58f0\u79f0\u7684\u8bb8\u53ef\u8bc1\u7b49\u4fe1\u606f\uff0c\u4e3a\u65e5\u540e\u53ef\u80fd\u7684\u5ba1\u8ba1\u7559\u4e0b\u4f9d\u636e\u3002</p> <p>\u7b2c\u56db\u4e2a\u9677\u9631\u662f\u91cd\u91c7\u96c6\u8f7b\u5904\u7406\u3002 \u8bb8\u591a\u56e2\u961f\u82b1\u8d39\u5927\u91cf\u7cbe\u529b\u6269\u5927\u6570\u636e\u91c7\u96c6\u89c4\u6a21\uff0c\u5374\u5728\u89e3\u6790\u548c\u6e05\u6d17\u73af\u8282\u8349\u8349\u4e86\u4e8b\u3002\u6b63\u5982\u7b2c\u4e00\u7ae0\u6240\u8ff0\uff0c\u6570\u636e\u8d28\u91cf\u7684\u91cd\u8981\u6027\u8fdc\u8d85\u6570\u636e\u6570\u91cf\u3002\u5b81\u53ef\u5c11\u91c7\u96c6\u4e00\u4e9b\uff0c\u4e5f\u8981\u786e\u4fdd\u6bcf\u4efd\u6570\u636e\u7ecf\u8fc7\u4e25\u683c\u7684\u8d28\u91cf\u628a\u5173\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#3_6","title":"3_6 \u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u7cfb\u7edf\u4ecb\u7ecd\u4e86\u9884\u8bad\u7ec3\u6570\u636e\u83b7\u53d6\u7684\u65b9\u6cd5\u8bba\u548c\u5de5\u7a0b\u5b9e\u8df5\u3002</p> <p>\u5728\u5f00\u6e90\u6570\u636e\u96c6\u65b9\u9762\uff0cCommon Crawl \u662f\u6700\u91cd\u8981\u7684\u4e0a\u6e38\u6570\u636e\u6e90\uff0c\u63d0\u4f9b WARC\u3001WAT\u3001WET \u4e09\u79cd\u683c\u5f0f\u3002RefinedWeb \u548c The Pile \u662f\u7ecf\u8fc7\u7cbe\u5fc3\u5904\u7406\u7684\u9ad8\u8d28\u91cf\u6570\u636e\u96c6\uff0c\u5176\u5904\u7406\u65b9\u6cd5\u503c\u5f97\u5b66\u4e60\u501f\u9274\u3002\u4e2d\u6587\u6570\u636e\u96c6\u76f8\u5bf9\u7a00\u7f3a\uff0c\u5f80\u5f80\u9700\u8981\u81ea\u884c\u4ece Common Crawl \u63d0\u53d6\u3002</p> <p>\u5728\u7f51\u9875\u89e3\u6790\u65b9\u9762\uff0cTrafilatura \u662f\u76ee\u524d\u6700\u63a8\u8350\u7684\u5de5\u4e1a\u7ea7\u89e3\u6790\u5e93\uff0c\u80fd\u591f\u4ece\u590d\u6742\u7684 HTML \u4e2d\u51c6\u786e\u63d0\u53d6\u6b63\u6587\u5185\u5bb9\u3002\u5206\u5e03\u5f0f\u89e3\u6790\u67b6\u6784\uff08\u5982\u57fa\u4e8e Ray Data\uff09\u662f\u5904\u7406 TB \u7ea7\u6570\u636e\u7684\u5fc5\u8981\u624b\u6bb5\u3002</p> <p>\u5728\u7279\u79cd\u6570\u636e\u65b9\u9762\uff0c\u4ee3\u7801\u6570\u636e\u53ef\u901a\u8fc7 The Stack \u6216 GitHub BigQuery \u83b7\u53d6\uff0c\u9700\u6ce8\u610f\u8bb8\u53ef\u8bc1\u5408\u89c4\uff1b\u5b66\u672f\u8bba\u6587\u53ef\u901a\u8fc7 ArXiv \u548c S2ORC \u83b7\u53d6\uff1b\u4e66\u7c4d\u6570\u636e\u7684\u7248\u6743\u98ce\u9669\u8f83\u9ad8\uff0c\u5efa\u8bae\u4f7f\u7528\u516c\u5171\u9886\u57df\u8d44\u6e90\u3002\u591a\u8bed\u8a00\u6570\u636e\u9700\u8981\u901a\u8fc7\u6e29\u5ea6\u91c7\u6837\u7b49\u7b56\u7565\u8fdb\u884c\u5e73\u8861\u3002</p> <p>\u5728\u5de5\u7a0b\u5b9e\u8df5\u65b9\u9762\uff0c\u5b8c\u6574\u7684\u6570\u636e\u83b7\u53d6\u6d41\u6c34\u7ebf\u9700\u8981\u8003\u8651\u722c\u866b\u67b6\u6784\u8bbe\u8ba1\u3001\u589e\u91cf\u66f4\u65b0\u7b56\u7565\u548c\u8d28\u91cf\u76d1\u63a7\u673a\u5236\u3002\u6838\u5fc3\u539f\u5219\u662f\u591a\u6e90\u6df7\u5408\u3001\u8d28\u91cf\u4f18\u5148\u3001\u5408\u89c4\u5148\u884c\u3002</p> <p></p> <p>\u56fe3-5\uff1a\u7b2c3\u7ae0\u77e5\u8bc6\u7ed3\u6784 \u2014\u2014 \u6db5\u76d6\u5f00\u6e90\u6570\u636e\u96c6\u3001\u7f51\u9875\u89e3\u6790\u3001\u7279\u79cd\u6570\u636e\u3001\u5de5\u7a0b\u5b9e\u8df5\u56db\u5927\u4e3b\u9898</p>"},{"location":"chapter2/2_1_data_acquisition/#_3","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u5173\u4e8e\u9884\u8bad\u7ec3\u6570\u636e\u83b7\u53d6\u7684\u6df1\u5165\u5185\u5bb9\uff0c\u4ee5\u4e0b\u8d44\u6e90\u503c\u5f97\u53c2\u8003\uff1a</p> <p>Common Crawl \u5b98\u65b9\u6587\u6863\uff08commoncrawl.org/the-data\uff09\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u6570\u636e\u683c\u5f0f\u548c\u83b7\u53d6\u65b9\u5f0f\u3002RefinedWeb \u8bba\u6587\uff08Falcon LLM: A Large Language Model for High-Quality Web Data\uff09\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4ece Common Crawl \u6784\u5efa\u9ad8\u8d28\u91cf\u9884\u8bad\u7ec3\u96c6\u7684\u5b8c\u6574\u6d41\u7a0b\u3002The Pile \u8bba\u6587\uff08The Pile: An 800GB Dataset of Diverse Text for Language Modeling\uff09\u4ecb\u7ecd\u4e86\u591a\u6e90\u6df7\u5408\u7684\u6570\u636e\u6784\u5efa\u7b56\u7565\u3002Trafilatura \u6587\u6863\uff08trafilatura.readthedocs.io\uff09\u63d0\u4f9b\u4e86\u5168\u9762\u7684 API \u8bf4\u660e\u548c\u4f7f\u7528\u793a\u4f8b\u3002The Stack \u8bba\u6587\uff08StarCoder: May the Source Be with You!\uff09\u4ecb\u7ecd\u4e86\u5927\u89c4\u6a21\u4ee3\u7801\u6570\u636e\u96c6\u7684\u6784\u5efa\u65b9\u6cd5\u3002</p>"},{"location":"chapter2/2_1_data_acquisition/#_4","title":"\u4e0b\u4e00\u7ae0\u9884\u544a","text":"<p>\u83b7\u53d6\u539f\u59cb\u6570\u636e\u53ea\u662f\u7b2c\u4e00\u6b65\u3002\u5728\u4e0b\u4e00\u7ae0\u300a\u6e05\u6d17\u4e0e\u53bb\u566a\u300b\u4e2d\uff0c\u6211\u4eec\u5c06\u6df1\u5165\u63a2\u8ba8\u5982\u4f55\u4ece\u6d77\u91cf\u539f\u59cb\u6570\u636e\u4e2d\u7b5b\u9009\u51fa\u9ad8\u8d28\u91cf\u5185\u5bb9\u3002\u4f60\u5c06\u5b66\u4e60\u542f\u53d1\u5f0f\u8fc7\u6ee4\u89c4\u5219\uff08\u8bed\u8a00\u8bc6\u522b\u3001\u56f0\u60d1\u5ea6\u8fc7\u6ee4\u3001\u957f\u5ea6\u5206\u5e03\uff09\u3001\u5927\u89c4\u6a21\u53bb\u91cd\u6280\u672f\uff08MinHash LSH \u7684\u539f\u7406\u4e0e\u5206\u5e03\u5f0f\u5b9e\u73b0\uff09\uff0c\u4ee5\u53ca\u9690\u79c1\u6570\u636e\u6e05\u6d17\uff08PII \u8bc6\u522b\u4e0e\u79fb\u9664\uff09\u3002</p> <p>\u5e26\u7740\u8fd9\u4e2a\u95ee\u9898\u8fdb\u5165\u4e0b\u4e00\u7ae0\uff1a\u5982\u679c\u4e24\u7bc7\u6587\u6863\u6709 80% \u7684\u5185\u5bb9\u76f8\u540c\uff0c\u4f60\u5982\u4f55\u9ad8\u6548\u5730\u8bc6\u522b\u5e76\u5904\u7406\u5b83\u4eec\uff1f</p>"},{"location":"chapter2/2_2_cleaning_denoising/","title":"\u7b2c4\u7ae0\uff1a\u6e05\u6d17\u4e0e\u53bb\u566a","text":""},{"location":"chapter2/2_2_cleaning_denoising/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u4ece\u4e92\u8054\u7f51\u83b7\u53d6\u7684\u539f\u59cb\u6570\u636e\u5c31\u50cf\u672a\u7ecf\u52a0\u5de5\u7684\u77ff\u77f3\uff0c\u5176\u4e2d\u771f\u6b63\u6709\u4ef7\u503c\u7684\"\u7cbe\u77ff\"\u53ef\u80fd\u53ea\u5360\u5f88\u5c0f\u7684\u6bd4\u4f8b\u3002\u672c\u7ae0\u5c06\u6df1\u5165\u63a2\u8ba8\u9884\u8bad\u7ec3\u6570\u636e\u6e05\u6d17\u7684\u4e09\u5927\u6838\u5fc3\u6280\u672f\uff1a\u542f\u53d1\u5f0f\u8fc7\u6ee4\u89c4\u5219\u7528\u4e8e\u5254\u9664\u4f4e\u8d28\u91cf\u6587\u6863\uff0c\u5927\u89c4\u6a21\u53bb\u91cd\u6280\u672f\u7528\u4e8e\u6d88\u9664\u91cd\u590d\u5185\u5bb9\uff0c\u9690\u79c1\u6570\u636e\u6e05\u6d17\u7528\u4e8e\u4fdd\u62a4\u7528\u6237\u4fe1\u606f\u3002\u638c\u63e1\u8fd9\u4e9b\u6280\u672f\u540e\uff0c\u8bfb\u8005\u5c06\u80fd\u591f\u6784\u5efa\u5de5\u4e1a\u7ea7\u7684\u6570\u636e\u6e05\u6d17\u6d41\u6c34\u7ebf\uff0c\u5c06\u539f\u59cb\u7f51\u9875\u6570\u636e\u8f6c\u5316\u4e3a\u9ad8\u8d28\u91cf\u7684\u9884\u8bad\u7ec3\u8bed\u6599\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u7ecf\u8fc7\u4e0a\u4e00\u7ae0\u7684\u52aa\u529b\uff0c\u4f60\u7684\u56e2\u961f\u6210\u529f\u4ece Common Crawl \u63d0\u53d6\u4e86 50TB \u7684\u4e2d\u6587\u7f51\u9875\u6587\u672c\u3002\u7136\u800c\uff0c\u5f53\u4f60\u968f\u673a\u62bd\u6837\u67e5\u770b\u6570\u636e\u65f6\uff0c\u53d1\u73b0\u4e86\u5404\u79cd\u4ee4\u4eba\u5934\u75bc\u7684\u95ee\u9898\uff1a\u5927\u91cf\u9875\u9762\u53ea\u6709\u51e0\u4e2a\u5b57\u7684\u5bfc\u822a\u6587\u672c\uff0c\u5b8c\u5168\u6ca1\u6709\u5b9e\u8d28\u5185\u5bb9\uff1b\u6709\u4e9b\u9875\u9762\u5168\u662f JavaScript \u4ee3\u7801\u6216 CSS \u6837\u5f0f\u7684\u6b8b\u7559\uff1b\u67d0\u4e9b\u7f51\u7ad9\u7684\u5185\u5bb9\u88ab\u91cd\u590d\u722c\u53d6\u4e86\u6570\u767e\u6b21\uff1b\u8fd8\u6709\u5927\u91cf\u5e26\u6709\u7528\u6237\u90ae\u7bb1\u3001\u624b\u673a\u53f7\u7801\u7684\u654f\u611f\u4fe1\u606f\u3002</p> <p>\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u8bad\u7ec3\u5de5\u7a0b\u5e08\u544a\u8bc9\u4f60\uff0c\u4e0a\u6b21\u7528\u672a\u7ecf\u6e05\u6d17\u7684\u6570\u636e\u8bad\u7ec3\u7684\u6a21\u578b\u6709\u4e25\u91cd\u7684\"\u590d\u8bfb\u673a\"\u95ee\u9898\u2014\u2014\u6a21\u578b\u4f1a\u53cd\u590d\u8f93\u51fa\u76f8\u540c\u7684\u53e5\u5b50\uff0c\u751a\u81f3\u80fd\u591f\u80cc\u8bf5\u51fa\u67d0\u4e9b\u7f51\u7ad9\u7684\u5b8c\u6574\u5185\u5bb9\u3002\u8fd9\u663e\u7136\u662f\u6570\u636e\u91cd\u590d\u5bfc\u81f4\u7684\u3002</p> <p>\u5982\u4f55\u7cfb\u7edf\u6027\u5730\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff1f\u672c\u7ae0\u5c06\u7ed9\u51fa\u5b8c\u6574\u7684\u7b54\u6848\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_1","title":"4_1 \u542f\u53d1\u5f0f\u8fc7\u6ee4\u89c4\u5219","text":"<p>\u542f\u53d1\u5f0f\u8fc7\u6ee4\uff08Heuristic Filtering\uff09\u662f\u6570\u636e\u6e05\u6d17\u7684\u7b2c\u4e00\u9053\u9632\u7ebf\u3002\u5b83\u57fa\u4e8e\u4e00\u7cfb\u5217\u53ef\u91cf\u5316\u7684\u89c4\u5219\uff0c\u5feb\u901f\u7b5b\u9009\u51fa\u660e\u663e\u4f4e\u8d28\u91cf\u7684\u6587\u6863\u3002\u867d\u7136\u8fd9\u4e9b\u89c4\u5219\u770b\u8d77\u6765\u7b80\u5355\uff0c\u4f46\u5728\u5b9e\u8df5\u4e2d\u80fd\u591f\u8fc7\u6ee4\u6389\u5927\u90e8\u5206\u566a\u58f0\u6570\u636e\uff0c\u662f\u6027\u4ef7\u6bd4\u6781\u9ad8\u7684\u6e05\u6d17\u624b\u6bb5\u3002</p> <p></p> <p>\u56fe4-1\uff1a\u6570\u636e\u6e05\u6d17\u6d41\u6c34\u7ebf\u67b6\u6784 \u2014\u2014 \u4ece\u539f\u59cb\u6570\u636e\u5230\u6e05\u6d01\u8bed\u6599\u7684\u516b\u9636\u6bb5\u5904\u7406\u6d41\u7a0b</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_11","title":"4_1.1 \u8bed\u8a00\u8bc6\u522b","text":"<p>\u8bed\u8a00\u8bc6\u522b\u662f\u591a\u8bed\u8a00\u6570\u636e\u5904\u7406\u7684\u57fa\u7840\u6b65\u9aa4\u3002\u5bf9\u4e8e\u8bad\u7ec3\u4e2d\u6587\u6a21\u578b\u800c\u8a00\uff0c\u9996\u5148\u9700\u8981\u4ece Common Crawl \u7684\u6d77\u91cf\u6570\u636e\u4e2d\u7b5b\u9009\u51fa\u4e2d\u6587\u5185\u5bb9\uff0c\u8fd9\u5c31\u9700\u8981\u51c6\u786e\u7684\u8bed\u8a00\u8bc6\u522b\u80fd\u529b\u3002</p> <p>FastText \u8bed\u8a00\u8bc6\u522b\u5668\u662f\u76ee\u524d\u6700\u5e38\u7528\u7684\u5de5\u5177\u3002\u5b83\u7531 Facebook AI Research \u5f00\u53d1\uff0c\u9884\u8bad\u7ec3\u6a21\u578b\u652f\u6301 176 \u79cd\u8bed\u8a00\u7684\u8bc6\u522b\uff0c\u901f\u5ea6\u6781\u5feb\uff0c\u51c6\u786e\u7387\u4e5f\u76f8\u5f53\u9ad8\u3002FastText \u63d0\u4f9b\u4e24\u4e2a\u9884\u8bad\u7ec3\u6a21\u578b\uff1a<code>lid.176.bin</code> \u662f\u5b8c\u6574\u7248\u672c\uff0c\u51c6\u786e\u7387\u66f4\u9ad8\u4f46\u4f53\u79ef\u8f83\u5927\uff08\u7ea6 126MB\uff09\uff1b<code>lid.176.ftz</code> \u662f\u538b\u7f29\u7248\u672c\uff0c\u4f53\u79ef\u5c0f\uff08\u7ea6 917KB\uff09\u4f46\u51c6\u786e\u7387\u7565\u4f4e\u3002\u5bf9\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u5904\u7406\uff0c\u5efa\u8bae\u4f7f\u7528\u5b8c\u6574\u7248\u672c\u3002</p> <pre><code>import fasttext\n\n# \u52a0\u8f7d\u8bed\u8a00\u8bc6\u522b\u6a21\u578b\nlang_model = fasttext.load_model('lid.176.bin')\n\ndef detect_language(text: str, min_confidence: float = 0_8) -&gt; tuple:\n    \"\"\"\n    \u8bc6\u522b\u6587\u672c\u8bed\u8a00\n\n    Args:\n        text: \u5f85\u8bc6\u522b\u7684\u6587\u672c\n        min_confidence: \u6700\u4f4e\u7f6e\u4fe1\u5ea6\u9608\u503c\n\n    Returns:\n        (\u8bed\u8a00\u4ee3\u7801, \u7f6e\u4fe1\u5ea6) \u6216 (None, 0) \u5982\u679c\u7f6e\u4fe1\u5ea6\u4e0d\u8db3\n    \"\"\"\n    # \u9884\u5904\u7406\uff1a\u79fb\u9664\u6362\u884c\u7b26\uff0c\u622a\u53d6\u524d 1000 \u5b57\u7b26\n    text = text.replace('\\n', ' ')[:1000]\n\n    # \u9884\u6d4b\n    predictions = lang_model.predict(text, k=1)\n    lang = predictions[0][0].replace('__label__', '')\n    confidence = predictions[1][0]\n\n    if confidence &gt;= min_confidence:\n        return lang, confidence\n    return None, confidence\n\ndef filter_by_language(documents: list, target_lang: str = 'zh') -&gt; list:\n    \"\"\"\u8fc7\u6ee4\u6307\u5b9a\u8bed\u8a00\u7684\u6587\u6863\"\"\"\n    results = []\n    for doc in documents:\n        lang, conf = detect_language(doc['text'])\n        if lang == target_lang:\n            doc['detected_lang'] = lang\n            doc['lang_confidence'] = conf\n            results.append(doc)\n    return results\n</code></pre> <p>\u8bed\u8a00\u8bc6\u522b\u5728\u5b9e\u8df5\u4e2d\u4f1a\u9047\u5230\u4e00\u4e9b\u8fb9\u754c\u60c5\u51b5\u3002\u6df7\u5408\u8bed\u8a00\u7684\u6587\u6863\uff08\u5982\u4e2d\u82f1\u6587\u6df7\u6742\u7684\u6280\u672f\u535a\u5ba2\uff09\u53ef\u80fd\u88ab\u9519\u8bef\u5206\u7c7b\u3002\u77ed\u6587\u672c\u7684\u8bc6\u522b\u51c6\u786e\u7387\u8f83\u4f4e\uff0c\u5efa\u8bae\u5bf9\u957f\u5ea6\u4e0d\u8db3 50 \u5b57\u7b26\u7684\u6587\u672c\u8df3\u8fc7\u8bed\u8a00\u8fc7\u6ee4\u3002\u4ee3\u7801\u7247\u6bb5\u53ef\u80fd\u88ab\u8bc6\u522b\u4e3a\u5404\u79cd\u8bed\u8a00\uff0c\u9700\u8981\u7ed3\u5408\u5185\u5bb9\u7c7b\u578b\u8fdb\u884c\u5224\u65ad\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_12","title":"4_1.2 \u6587\u672c\u8d28\u91cf\u8bc4\u5206","text":"<p>\u8bed\u8a00\u8bc6\u522b\u53ea\u80fd\u786e\u4fdd\u6587\u6863\u662f\u76ee\u6807\u8bed\u8a00\uff0c\u4f46\u65e0\u6cd5\u5224\u65ad\u5185\u5bb9\u8d28\u91cf\u3002\u4e00\u6bb5\u8bed\u6cd5\u6b63\u786e\u7684\u5783\u573e\u5e7f\u544a\u548c\u4e00\u7bc7\u4f18\u8d28\u7684\u6280\u672f\u6587\u7ae0\uff0c\u5728\u8bed\u8a00\u8bc6\u522b\u4e0a\u53ef\u80fd\u5f97\u5230\u76f8\u540c\u7684\u5206\u6570\u3002\u8fd9\u5c31\u9700\u8981\u66f4\u7cbe\u7ec6\u7684\u8d28\u91cf\u8bc4\u4f30\u673a\u5236\u3002</p> <p>\u56f0\u60d1\u5ea6\uff08Perplexity\uff09\u8fc7\u6ee4\u662f\u4e00\u79cd\u57fa\u4e8e\u8bed\u8a00\u6a21\u578b\u7684\u8d28\u91cf\u8bc4\u4f30\u65b9\u6cd5\u3002\u56f0\u60d1\u5ea6\u8861\u91cf\u7684\u662f\u8bed\u8a00\u6a21\u578b\u5bf9\u6587\u672c\u7684\"\u60ca\u8bb6\u7a0b\u5ea6\"\u2014\u2014\u5982\u679c\u4e00\u6bb5\u6587\u672c\u4e0e\u6a21\u578b\u8bad\u7ec3\u6570\u636e\u7684\u5206\u5e03\u76f8\u4f3c\uff0c\u56f0\u60d1\u5ea6\u5c31\u4f4e\uff1b\u5982\u679c\u6587\u672c\u5305\u542b\u5927\u91cf\u566a\u58f0\u3001\u4e71\u7801\u6216\u4e0d\u81ea\u7136\u7684\u8868\u8fbe\uff0c\u56f0\u60d1\u5ea6\u5c31\u9ad8\u3002</p> <p>KenLM \u662f\u8ba1\u7b97\u56f0\u60d1\u5ea6\u6700\u5e38\u7528\u7684\u5de5\u5177\u3002\u5b83\u57fa\u4e8e n-gram \u8bed\u8a00\u6a21\u578b\uff0c\u901f\u5ea6\u6781\u5feb\uff0c\u9002\u5408\u5927\u89c4\u6a21\u6570\u636e\u5904\u7406\u3002</p> <pre><code>import kenlm\n\nclass PerplexityFilter:\n    def __init__(self, model_path: str, max_perplexity: float = 500):\n        \"\"\"\n        \u521d\u59cb\u5316\u56f0\u60d1\u5ea6\u8fc7\u6ee4\u5668\n\n        Args:\n            model_path: KenLM \u6a21\u578b\u8def\u5f84 (.arpa \u6216 .bin)\n            max_perplexity: \u56f0\u60d1\u5ea6\u9608\u503c\uff0c\u8d85\u8fc7\u6b64\u503c\u7684\u6587\u6863\u5c06\u88ab\u8fc7\u6ee4\n        \"\"\"\n        self.model = kenlm.Model(model_path)\n        self.max_perplexity = max_perplexity\n\n    def compute_perplexity(self, text: str) -&gt; float:\n        \"\"\"\u8ba1\u7b97\u6587\u672c\u7684\u56f0\u60d1\u5ea6\"\"\"\n        # KenLM \u8fd4\u56de\u7684\u662f log10 \u6982\u7387\n        log_prob = self.model.score(text, bos=True, eos=True)\n        # \u8f6c\u6362\u4e3a\u56f0\u60d1\u5ea6\n        num_words = len(text.split()) + 1  # +1 for EOS\n        perplexity = 10 ** (-log_prob / num_words)\n        return perplexity\n\n    def filter(self, documents: list) -&gt; list:\n        \"\"\"\u8fc7\u6ee4\u9ad8\u56f0\u60d1\u5ea6\u6587\u6863\"\"\"\n        results = []\n        for doc in documents:\n            ppl = self.compute_perplexity(doc['text'])\n            if ppl &lt;= self.max_perplexity:\n                doc['perplexity'] = ppl\n                results.append(doc)\n        return results\n</code></pre> <p>\u56f0\u60d1\u5ea6\u9608\u503c\u7684\u8bbe\u5b9a\u9700\u8981\u6839\u636e\u5177\u4f53\u6570\u636e\u8fdb\u884c\u8c03\u4f18\u3002\u4e00\u822c\u800c\u8a00\uff0c\u9ad8\u8d28\u91cf\u7684\u65b0\u95fb\u548c\u767e\u79d1\u6587\u672c\u56f0\u60d1\u5ea6\u5728 100-200 \u4e4b\u95f4\uff0c\u666e\u901a\u7f51\u9875\u5185\u5bb9\u5728 200-500 \u4e4b\u95f4\uff0c\u4f4e\u8d28\u91cf\u5185\u5bb9\uff08\u5982\u4e71\u7801\u3001\u673a\u5668\u7ffb\u8bd1\uff09\u901a\u5e38\u8d85\u8fc7 500\u3002\u5efa\u8bae\u5148\u5728\u5c0f\u89c4\u6a21\u6837\u672c\u4e0a\u5206\u6790\u56f0\u60d1\u5ea6\u5206\u5e03\uff0c\u518d\u786e\u5b9a\u5408\u9002\u7684\u9608\u503c\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_13","title":"4_1.3 \u542f\u53d1\u5f0f\u89c4\u5219\u96c6","text":"<p>\u9664\u4e86\u8bed\u8a00\u8bc6\u522b\u548c\u56f0\u60d1\u5ea6\u8fc7\u6ee4\uff0c\u8fd8\u6709\u4e00\u7cfb\u5217\u7b80\u5355\u4f46\u6709\u6548\u7684\u542f\u53d1\u5f0f\u89c4\u5219\uff0c\u53ef\u4ee5\u5feb\u901f\u5254\u9664\u660e\u663e\u7684\u4f4e\u8d28\u91cf\u5185\u5bb9\u3002\u8fd9\u4e9b\u89c4\u5219\u7684\u8bbe\u8ba1\u6765\u6e90\u4e8e\u5bf9\u5927\u91cf\u6570\u636e\u7684\u89c2\u5bdf\u548c\u7ecf\u9a8c\u603b\u7ed3\u3002</p> <p>\u957f\u5ea6\u8fc7\u6ee4\u662f\u6700\u57fa\u672c\u7684\u89c4\u5219\u3002\u8fc7\u77ed\u7684\u6587\u6863\uff08\u5982\u53ea\u6709\u51e0\u4e2a\u8bcd\u7684\u5bfc\u822a\u6587\u672c\uff09\u6ca1\u6709\u8bad\u7ec3\u4ef7\u503c\uff0c\u5e94\u8be5\u76f4\u63a5\u79fb\u9664\u3002\u8fc7\u957f\u7684\u6587\u6863\u53ef\u80fd\u9700\u8981\u622a\u65ad\u6216\u5206\u6bb5\u5904\u7406\u3002\u5178\u578b\u7684\u9608\u503c\u8bbe\u5b9a\u662f\uff1a\u6700\u5c0f\u957f\u5ea6 200 \u5b57\u7b26\u6216 50 \u8bcd\uff0c\u6700\u5927\u957f\u5ea6 100,000 \u5b57\u7b26\u3002</p> <p>\u7279\u6b8a\u5b57\u7b26\u6bd4\u4f8b\u53ef\u4ee5\u8bc6\u522b\u51fa\u5927\u91cf\u566a\u58f0\u5185\u5bb9\u3002\u5982\u679c\u4e00\u4e2a\u6587\u6863\u4e2d\u975e\u5b57\u6bcd\u6570\u5b57\u5b57\u7b26\u7684\u6bd4\u4f8b\u8fc7\u9ad8\uff0c\u5f88\u53ef\u80fd\u662f\u4ee3\u7801\u6b8b\u7559\u3001\u4e71\u7801\u6216\u683c\u5f0f\u9519\u8bef\u3002\u7c7b\u4f3c\u5730\uff0c\u6570\u5b57\u6bd4\u4f8b\u8fc7\u9ad8\u53ef\u80fd\u8868\u793a\u662f\u65e5\u5fd7\u6587\u4ef6\u6216\u6570\u636e\u8868\u683c\u3002</p> <p>\u91cd\u590d\u884c\u6bd4\u4f8b\u53ef\u4ee5\u68c0\u6d4b\u51fa\u6a21\u677f\u5316\u7684\u4f4e\u8d28\u91cf\u9875\u9762\u3002\u5982\u679c\u4e00\u4e2a\u6587\u6863\u4e2d\u6709\u5927\u91cf\u5b8c\u5168\u76f8\u540c\u7684\u884c\uff08\u5982\u5bfc\u822a\u680f\u5728\u9875\u9762\u591a\u5904\u91cd\u590d\uff09\uff0c\u8bf4\u660e\u5185\u5bb9\u8d28\u91cf\u8f83\u4f4e\u3002</p> <p>\u8bcd\u6c47\u591a\u6837\u6027\u8861\u91cf\u6587\u6863\u7684\u4fe1\u606f\u4e30\u5bcc\u7a0b\u5ea6\u3002\u4e00\u4e2a\u53ea\u4f7f\u7528 10 \u4e2a\u4e0d\u540c\u8bcd\u6c47\u7684\u6587\u6863\u663e\u7136\u4e0d\u5982\u4f7f\u7528 500 \u4e2a\u4e0d\u540c\u8bcd\u6c47\u7684\u6587\u6863\u6709\u4ef7\u503c\u3002\u5e38\u7528\u7684\u6307\u6807\u662f Type-Token Ratio\uff08TTR\uff09\uff0c\u5373\u552f\u4e00\u8bcd\u6570\u4e0e\u603b\u8bcd\u6570\u7684\u6bd4\u503c\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7efc\u5408\u7684\u542f\u53d1\u5f0f\u8fc7\u6ee4\u5668\u5b9e\u73b0\uff1a</p> <pre><code>import re\nfrom collections import Counter\n\nclass HeuristicFilter:\n    def __init__(self, config: dict = None):\n        \"\"\"\n        \u521d\u59cb\u5316\u542f\u53d1\u5f0f\u8fc7\u6ee4\u5668\n\n        \u9ed8\u8ba4\u914d\u7f6e\u9002\u7528\u4e8e\u4e2d\u6587\u9884\u8bad\u7ec3\u6570\u636e\n        \"\"\"\n        self.config = config or {\n            'min_length': 200,           # \u6700\u5c0f\u5b57\u7b26\u6570\n            'max_length': 100000,        # \u6700\u5927\u5b57\u7b26\u6570\n            'min_words': 50,             # \u6700\u5c0f\u8bcd\u6570\n            'max_special_ratio': 0_3,    # \u6700\u5927\u7279\u6b8a\u5b57\u7b26\u6bd4\u4f8b\n            'max_digit_ratio': 0_3,      # \u6700\u5927\u6570\u5b57\u6bd4\u4f8b\n            'max_duplicate_line_ratio': 0_3,  # \u6700\u5927\u91cd\u590d\u884c\u6bd4\u4f8b\n            'min_avg_word_length': 2,    # \u6700\u5c0f\u5e73\u5747\u8bcd\u957f\n            'max_avg_word_length': 20,   # \u6700\u5927\u5e73\u5747\u8bcd\u957f\n            'min_unique_word_ratio': 0_1 # \u6700\u5c0f\u8bcd\u6c47\u591a\u6837\u6027\n        }\n\n    def check_length(self, text: str) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u6587\u6863\u957f\u5ea6\"\"\"\n        length = len(text)\n        return self.config['min_length'] &lt;= length &lt;= self.config['max_length']\n\n    def check_special_chars(self, text: str) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u7279\u6b8a\u5b57\u7b26\u6bd4\u4f8b\"\"\"\n        if len(text) == 0:\n            return False\n        special = len(re.findall(r'[^\\w\\s]', text, re.UNICODE))\n        ratio = special / len(text)\n        return ratio &lt;= self.config['max_special_ratio']\n\n    def check_digit_ratio(self, text: str) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u6570\u5b57\u6bd4\u4f8b\"\"\"\n        if len(text) == 0:\n            return False\n        digits = len(re.findall(r'\\d', text))\n        ratio = digits / len(text)\n        return ratio &lt;= self.config['max_digit_ratio']\n\n    def check_duplicate_lines(self, text: str) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u91cd\u590d\u884c\u6bd4\u4f8b\"\"\"\n        lines = [line.strip() for line in text.split('\\n') if line.strip()]\n        if len(lines) == 0:\n            return False\n        unique_lines = len(set(lines))\n        duplicate_ratio = 1 - (unique_lines / len(lines))\n        return duplicate_ratio &lt;= self.config['max_duplicate_line_ratio']\n\n    def check_vocabulary_diversity(self, text: str) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u8bcd\u6c47\u591a\u6837\u6027\"\"\"\n        words = text.split()\n        if len(words) &lt; self.config['min_words']:\n            return False\n        unique_ratio = len(set(words)) / len(words)\n        return unique_ratio &gt;= self.config['min_unique_word_ratio']\n\n    def filter(self, text: str) -&gt; tuple:\n        \"\"\"\n        \u5e94\u7528\u6240\u6709\u8fc7\u6ee4\u89c4\u5219\n\n        Returns:\n            (\u662f\u5426\u901a\u8fc7, \u5931\u8d25\u539f\u56e0\u6216 None)\n        \"\"\"\n        checks = [\n            (self.check_length, 'length'),\n            (self.check_special_chars, 'special_chars'),\n            (self.check_digit_ratio, 'digit_ratio'),\n            (self.check_duplicate_lines, 'duplicate_lines'),\n            (self.check_vocabulary_diversity, 'vocabulary_diversity')\n        ]\n\n        for check_func, name in checks:\n            if not check_func(text):\n                return False, name\n\n        return True, None\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_14","title":"4_1.4 \u8d28\u91cf\u5206\u5c42\u7b56\u7565","text":"<p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5c06\u6570\u636e\u7b80\u5355\u5730\u4e8c\u5206\u4e3a\"\u4fdd\u7559\"\u548c\"\u4e22\u5f03\"\u5f80\u5f80\u8fc7\u4e8e\u7c97\u66b4\u3002\u66f4\u7cbe\u7ec6\u7684\u505a\u6cd5\u662f\u5bf9\u6570\u636e\u8fdb\u884c\u8d28\u91cf\u5206\u5c42\uff0c\u4e3a\u4e0d\u540c\u8d28\u91cf\u5c42\u7ea7\u7684\u6570\u636e\u8d4b\u4e88\u4e0d\u540c\u7684\u91c7\u6837\u6743\u91cd\u3002</p> <p>\u4e00\u79cd\u5e38\u89c1\u7684\u5206\u5c42\u7b56\u7565\u662f\uff1a\u5c06\u6570\u636e\u5206\u4e3a\u9ad8\u3001\u4e2d\u3001\u4f4e\u4e09\u4e2a\u8d28\u91cf\u5c42\u7ea7\u3002\u9ad8\u8d28\u91cf\u6570\u636e\uff08\u5982\u6765\u81ea\u6743\u5a01\u7f51\u7ad9\u3001\u901a\u8fc7\u6240\u6709\u542f\u53d1\u5f0f\u68c0\u67e5\u3001\u56f0\u60d1\u5ea6\u4f4e\uff09\u8d4b\u4e88\u8f83\u9ad8\u7684\u91c7\u6837\u6743\u91cd\uff1b\u4e2d\u7b49\u8d28\u91cf\u6570\u636e\u8d4b\u4e88\u6b63\u5e38\u6743\u91cd\uff1b\u4f4e\u8d28\u91cf\u4f46\u4ecd\u53ef\u63a5\u53d7\u7684\u6570\u636e\u8d4b\u4e88\u8f83\u4f4e\u6743\u91cd\u3002\u8fd9\u79cd\u7b56\u7565\u53ef\u4ee5\u5728\u4fdd\u8bc1\u6570\u636e\u591a\u6837\u6027\u7684\u540c\u65f6\uff0c\u8ba9\u9ad8\u8d28\u91cf\u6570\u636e\u5728\u8bad\u7ec3\u4e2d\u53d1\u6325\u66f4\u5927\u4f5c\u7528\u3002</p> <p>RefinedWeb \u7684\u8bba\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4ed6\u4eec\u7684\u5206\u5c42\u7b56\u7565\uff0c\u5c06\u6570\u636e\u5206\u4e3a\u4e94\u4e2a\u5c42\u7ea7\uff0c\u6bcf\u4e2a\u5c42\u7ea7\u4f7f\u7528\u4e0d\u540c\u7684\u8fc7\u6ee4\u9608\u503c\u3002\u8fd9\u79cd\u7cbe\u7ec6\u5316\u7684\u8d28\u91cf\u7ba1\u7406\u662f\u6784\u5efa\u9ad8\u8d28\u91cf\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u5173\u952e\u3002</p> <p></p> <p>\u56fe4-2\uff1a\u6570\u636e\u8d28\u91cf\u8fc7\u6ee4\u6f0f\u6597 \u2014\u2014 \u4ece100%\u539f\u59cb\u6570\u636e\u5230\u6700\u7ec84%\u6e05\u6d01\u8bed\u6599\u7684\u9010\u5c42\u8fc7\u6ee4\u8fc7\u7a0b</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_2","title":"4_2 \u5927\u89c4\u6a21\u53bb\u91cd","text":"<p>\u6570\u636e\u91cd\u590d\u662f\u9884\u8bad\u7ec3\u6570\u636e\u7684\u5927\u654c\u3002Common Crawl \u4e2d\uff0c\u540c\u4e00\u7bc7\u6587\u7ae0\u53ef\u80fd\u88ab\u591a\u4e2a\u7f51\u7ad9\u8f6c\u8f7d\uff0c\u540c\u4e00\u4e2a\u7f51\u9875\u53ef\u80fd\u5728\u4e0d\u540c\u6708\u4efd\u88ab\u53cd\u590d\u6293\u53d6\uff0c\u5bfc\u81f4\u5927\u91cf\u91cd\u590d\u5185\u5bb9\u3002\u7814\u7a76\u8868\u660e\uff0c\u672a\u7ecf\u53bb\u91cd\u7684\u6570\u636e\u4f1a\u5bfc\u81f4\u6a21\u578b\u8fc7\u62df\u5408\u4e8e\u91cd\u590d\u5185\u5bb9\uff0c\u4ea7\u751f\"\u590d\u8bfb\u673a\"\u73b0\u8c61\uff0c\u4e25\u91cd\u5f71\u54cd\u6a21\u578b\u8d28\u91cf\u3002</p> <p>\u53bb\u91cd\u53ef\u4ee5\u5206\u4e3a\u4e24\u4e2a\u5c42\u6b21\uff1a\u7cbe\u786e\u53bb\u91cd\uff08Exact Deduplication\uff09\u79fb\u9664\u5b8c\u5168\u76f8\u540c\u7684\u6587\u6863\uff1b\u6a21\u7cca\u53bb\u91cd\uff08Fuzzy Deduplication\uff09\u79fb\u9664\u9ad8\u5ea6\u76f8\u4f3c\u4f46\u4e0d\u5b8c\u5168\u76f8\u540c\u7684\u6587\u6863\uff08\u5982\u8f6c\u8f7d\u65f6\u7565\u6709\u4fee\u6539\u7684\u6587\u7ae0\uff09\u3002\u5728 TB \u7ea7\u6570\u636e\u4e0a\uff0c\u8fd9\u4e24\u79cd\u53bb\u91cd\u90fd\u9700\u8981\u9ad8\u6548\u7684\u7b97\u6cd5\u548c\u5206\u5e03\u5f0f\u5b9e\u73b0\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_21","title":"4_2.1 \u7cbe\u786e\u53bb\u91cd\uff1a\u54c8\u5e0c\u65b9\u6cd5","text":"<p>\u7cbe\u786e\u53bb\u91cd\u7684\u6838\u5fc3\u601d\u60f3\u662f\u4e3a\u6bcf\u4e2a\u6587\u6863\u8ba1\u7b97\u4e00\u4e2a\u6307\u7eb9\uff08fingerprint\uff09\uff0c\u76f8\u540c\u6307\u7eb9\u7684\u6587\u6863\u89c6\u4e3a\u91cd\u590d\u3002\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 MD5 \u6216 SHA256 \u7b49\u54c8\u5e0c\u51fd\u6570\u3002</p> <pre><code>import hashlib\n\ndef compute_hash(text: str) -&gt; str:\n    \"\"\"\u8ba1\u7b97\u6587\u672c\u7684 SHA256 \u54c8\u5e0c\"\"\"\n    return hashlib.sha256(text.encode('utf-8')).hexdigest()\n\ndef exact_dedup(documents: list) -&gt; list:\n    \"\"\"\u7cbe\u786e\u53bb\u91cd\uff1a\u4fdd\u7559\u6bcf\u4e2a\u54c8\u5e0c\u503c\u7684\u7b2c\u4e00\u4e2a\u6587\u6863\"\"\"\n    seen_hashes = set()\n    results = []\n\n    for doc in documents:\n        doc_hash = compute_hash(doc['text'])\n        if doc_hash not in seen_hashes:\n            seen_hashes.add(doc_hash)\n            doc['hash'] = doc_hash\n            results.append(doc)\n\n    return results\n</code></pre> <p>\u5bf9\u4e8e\u5206\u5e03\u5f0f\u573a\u666f\uff0c\u53ef\u4ee5\u4f7f\u7528 Spark \u6216 Ray \u8fdb\u884c\u5e76\u884c\u53bb\u91cd\uff1a</p> <pre><code>import ray\n\n@ray.remote\ndef compute_hashes_batch(documents: list) -&gt; list:\n    \"\"\"\u6279\u91cf\u8ba1\u7b97\u54c8\u5e0c\"\"\"\n    return [(compute_hash(doc['text']), doc) for doc in documents]\n\ndef distributed_exact_dedup(documents_path: str, output_path: str):\n    \"\"\"\u5206\u5e03\u5f0f\u7cbe\u786e\u53bb\u91cd\"\"\"\n    ds = ray.data.read_parquet(documents_path)\n\n    # \u8ba1\u7b97\u54c8\u5e0c\n    ds = ds.map(lambda doc: {**doc, 'hash': compute_hash(doc['text'])})\n\n    # \u6309\u54c8\u5e0c\u5206\u7ec4\uff0c\u6bcf\u7ec4\u4fdd\u7559\u7b2c\u4e00\u4e2a\n    ds = ds.groupby('hash').map_groups(lambda group: group.head(1))\n\n    # \u4fdd\u5b58\u7ed3\u679c\n    ds.write_parquet(output_path)\n</code></pre> <p>\u7cbe\u786e\u53bb\u91cd\u6548\u7387\u5f88\u9ad8\uff0c\u4f46\u53ea\u80fd\u5904\u7406\u5b8c\u5168\u76f8\u540c\u7684\u6587\u6863\u3002\u5bf9\u4e8e\u7565\u6709\u5dee\u5f02\u7684\u91cd\u590d\u5185\u5bb9\uff08\u5982\u540c\u4e00\u7bc7\u65b0\u95fb\u5728\u4e0d\u540c\u7f51\u7ad9\u7684\u8f6c\u8f7d\uff0c\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u9875\u7709\u9875\u811a\uff09\uff0c\u7cbe\u786e\u53bb\u91cd\u65e0\u80fd\u4e3a\u529b\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_22-minhash-lsh","title":"4_2.2 \u6a21\u7cca\u53bb\u91cd\uff1aMinHash LSH","text":"<p>\u6a21\u7cca\u53bb\u91cd\u7684\u76ee\u6807\u662f\u8bc6\u522b\"\u9ad8\u5ea6\u76f8\u4f3c\u4f46\u4e0d\u5b8c\u5168\u76f8\u540c\"\u7684\u6587\u6863\u3002\u8fd9\u662f\u4e00\u4e2a\u8ba1\u7b97\u590d\u6742\u5ea6\u5f88\u9ad8\u7684\u95ee\u9898\u2014\u2014\u6734\u7d20\u5730\u6bd4\u8f83\u4efb\u610f\u4e24\u4e2a\u6587\u6863\u9700\u8981 O(n\u00b2) \u7684\u65f6\u95f4\u590d\u6742\u5ea6\uff0c\u5bf9\u4e8e\u6570\u5341\u4ebf\u6587\u6863\u7684\u6570\u636e\u96c6\u5b8c\u5168\u4e0d\u53ef\u884c\u3002</p> <p>MinHash LSH\uff08Locality-Sensitive Hashing\uff09\u662f\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u7684\u6838\u5fc3\u7b97\u6cd5\u3002\u5b83\u7684\u57fa\u672c\u601d\u60f3\u662f\uff1a\u5148\u5c06\u6587\u6863\u8f6c\u6362\u4e3a n-gram \u96c6\u5408\uff0c\u7136\u540e\u4f7f\u7528 MinHash \u6280\u672f\u5c06\u96c6\u5408\u538b\u7f29\u4e3a\u56fa\u5b9a\u957f\u5ea6\u7684\u7b7e\u540d\uff0c\u6700\u540e\u4f7f\u7528 LSH \u5c06\u76f8\u4f3c\u7684\u7b7e\u540d\u805a\u96c6\u5230\u540c\u4e00\u4e2a\u6876\u4e2d\u3002\u53ea\u6709\u843d\u5165\u540c\u4e00\u4e2a\u6876\u7684\u6587\u6863\u5bf9\u624d\u9700\u8981\u8fdb\u884c\u7cbe\u7ec6\u6bd4\u8f83\uff0c\u5927\u5927\u51cf\u5c11\u4e86\u8ba1\u7b97\u91cf\u3002</p> <p>\u7406\u89e3 MinHash LSH \u9700\u8981\u5206\u4e09\u6b65\u6765\u770b\uff1a</p> <p>\u7b2c\u4e00\u6b65\u662f n-gram \u5206\u89e3\u3002 \u5c06\u6587\u6863\u89c6\u4e3a n-gram\uff08\u8fde\u7eed n \u4e2a\u5b57\u7b26\u6216\u8bcd\uff09\u7684\u96c6\u5408\u3002\u4f8b\u5982\uff0c\"\u5927\u6a21\u578b\u6570\u636e\" \u7684 3-gram \u96c6\u5408\u4e3a {\"\u5927\u6a21\u578b\", \"\u6a21\u578b\u6570\", \"\u578b\u6570\u636e\"}\u3002\u4f7f\u7528 n-gram \u800c\u975e\u6574\u4e2a\u6587\u6863\uff0c\u53ef\u4ee5\u66f4\u597d\u5730\u6355\u6349\u5c40\u90e8\u76f8\u4f3c\u6027\u3002</p> <p>\u7b2c\u4e8c\u6b65\u662f MinHash \u7b7e\u540d\u3002 MinHash \u662f\u4e00\u79cd\u5c06\u96c6\u5408\u538b\u7f29\u4e3a\u56fa\u5b9a\u957f\u5ea6\u7b7e\u540d\u7684\u6280\u672f\u3002\u4e24\u4e2a\u96c6\u5408\u7684 Jaccard \u76f8\u4f3c\u5ea6\u53ef\u4ee5\u901a\u8fc7\u5b83\u4eec MinHash \u7b7e\u540d\u7684\u5339\u914d\u7a0b\u5ea6\u6765\u8fd1\u4f3c\u4f30\u8ba1\u3002\u7b7e\u540d\u957f\u5ea6\u8d8a\u957f\uff0c\u4f30\u8ba1\u8d8a\u51c6\u786e\uff0c\u4f46\u5b58\u50a8\u548c\u8ba1\u7b97\u5f00\u9500\u4e5f\u8d8a\u5927\u3002</p> <p>\u7b2c\u4e09\u6b65\u662f LSH \u5206\u6876\u3002 \u5c06 MinHash \u7b7e\u540d\u5206\u6210\u82e5\u5e72\u4e2a band\uff0c\u6bcf\u4e2a band \u5305\u542b\u82e5\u5e72\u4e2a hash \u503c\u3002\u5982\u679c\u4e24\u4e2a\u6587\u6863\u5728\u4efb\u610f\u4e00\u4e2a band \u4e2d\u7684\u6240\u6709 hash \u503c\u90fd\u76f8\u540c\uff0c\u5219\u5b83\u4eec\u88ab\u653e\u5165\u540c\u4e00\u4e2a\u6876\u3002\u8c03\u6574 band \u7684\u6570\u91cf\u548c\u6bcf\u4e2a band \u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u63a7\u5236\u76f8\u4f3c\u5ea6\u9608\u503c\u548c\u53ec\u56de\u7387\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684 MinHash LSH \u5b9e\u73b0\uff1a</p> <p></p> <p>\u56fe4-3\uff1aMinHash LSH \u7b97\u6cd5\u4e09\u6b65\u9aa4 \u2014\u2014 N-gram\u5206\u89e3\u3001MinHash\u7b7e\u540d\u8ba1\u7b97\u3001LSH\u5206\u6876\uff0c\u5c06\u590d\u6742\u5ea6\u4eceO(n\u00b2)\u964d\u81f3O(n)</p> <pre><code>import hashlib\nimport struct\nfrom typing import Set, List, Tuple\nimport numpy as np\n\nclass MinHashLSH:\n    def __init__(self, \n                 num_hashes: int = 128,\n                 num_bands: int = 16,\n                 ngram_size: int = 5,\n                 threshold: float = 0_8):\n        \"\"\"\n        \u521d\u59cb\u5316 MinHash LSH\n\n        Args:\n            num_hashes: MinHash \u7b7e\u540d\u957f\u5ea6\n            num_bands: LSH band \u6570\u91cf\n            ngram_size: n-gram \u5927\u5c0f\n            threshold: \u76f8\u4f3c\u5ea6\u9608\u503c\uff08\u53c2\u8003\u503c\uff0c\u5b9e\u9645\u9608\u503c\u7531 band \u53c2\u6570\u51b3\u5b9a\uff09\n        \"\"\"\n        self.num_hashes = num_hashes\n        self.num_bands = num_bands\n        self.rows_per_band = num_hashes // num_bands\n        self.ngram_size = ngram_size\n\n        # \u751f\u6210\u54c8\u5e0c\u51fd\u6570\u7684\u968f\u673a\u53c2\u6570\n        self.hash_params = [\n            (np.random.randint(1, 2**31), np.random.randint(0, 2**31))\n            for _ in range(num_hashes)\n        ]\n\n        # LSH \u6876\n        self.buckets = [{} for _ in range(num_bands)]\n\n    def get_ngrams(self, text: str) -&gt; Set[str]:\n        \"\"\"\u63d0\u53d6 n-gram \u96c6\u5408\"\"\"\n        text = text.lower().replace(' ', '')\n        ngrams = set()\n        for i in range(len(text) - self.ngram_size + 1):\n            ngrams.add(text[i:i + self.ngram_size])\n        return ngrams\n\n    def compute_minhash(self, ngrams: Set[str]) -&gt; np.ndarray:\n        \"\"\"\u8ba1\u7b97 MinHash \u7b7e\u540d\"\"\"\n        signature = np.full(self.num_hashes, np.inf)\n\n        for ngram in ngrams:\n            # \u8ba1\u7b97 ngram \u7684\u57fa\u7840\u54c8\u5e0c\u503c\n            h = int(hashlib.md5(ngram.encode()).hexdigest(), 16)\n\n            # \u4f7f\u7528\u591a\u4e2a\u54c8\u5e0c\u51fd\u6570\n            for i, (a, b) in enumerate(self.hash_params):\n                hash_val = (a * h + b) % (2**31 - 1)\n                if hash_val &lt; signature[i]:\n                    signature[i] = hash_val\n\n        return signature.astype(np.uint32)\n\n    def get_bands(self, signature: np.ndarray) -&gt; List[str]:\n        \"\"\"\u5c06\u7b7e\u540d\u5206\u5272\u4e3a bands\"\"\"\n        bands = []\n        for i in range(self.num_bands):\n            start = i * self.rows_per_band\n            end = start + self.rows_per_band\n            band = signature[start:end]\n            band_hash = hashlib.md5(band.tobytes()).hexdigest()\n            bands.append(band_hash)\n        return bands\n\n    def insert(self, doc_id: str, text: str):\n        \"\"\"\u63d2\u5165\u6587\u6863\u5230 LSH \u7d22\u5f15\"\"\"\n        ngrams = self.get_ngrams(text)\n        if len(ngrams) == 0:\n            return\n\n        signature = self.compute_minhash(ngrams)\n        bands = self.get_bands(signature)\n\n        for band_idx, band_hash in enumerate(bands):\n            if band_hash not in self.buckets[band_idx]:\n                self.buckets[band_idx][band_hash] = []\n            self.buckets[band_idx][band_hash].append(doc_id)\n\n    def find_candidates(self, text: str) -&gt; Set[str]:\n        \"\"\"\u67e5\u627e\u5019\u9009\u76f8\u4f3c\u6587\u6863\"\"\"\n        ngrams = self.get_ngrams(text)\n        if len(ngrams) == 0:\n            return set()\n\n        signature = self.compute_minhash(ngrams)\n        bands = self.get_bands(signature)\n\n        candidates = set()\n        for band_idx, band_hash in enumerate(bands):\n            if band_hash in self.buckets[band_idx]:\n                candidates.update(self.buckets[band_idx][band_hash])\n\n        return candidates\n\ndef jaccard_similarity(set1: Set, set2: Set) -&gt; float:\n    \"\"\"\u8ba1\u7b97 Jaccard \u76f8\u4f3c\u5ea6\"\"\"\n    intersection = len(set1 &amp; set2)\n    union = len(set1 | set2)\n    return intersection / union if union &gt; 0 else 0\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_23","title":"4_2.3 \u5206\u5e03\u5f0f\u53bb\u91cd\u5b9e\u8df5","text":"<p>\u5728 TB \u7ea7\u6570\u636e\u4e0a\u8fd0\u884c MinHash LSH \u9700\u8981\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u5206\u5e03\u5f0f\u7b56\u7565\u3002\u4e00\u4e2a\u5178\u578b\u7684\u6d41\u7a0b\u5305\u62ec\uff1a</p> <p>\u9636\u6bb5\u4e00\uff1a\u7b7e\u540d\u8ba1\u7b97\u3002 \u5e76\u884c\u904d\u5386\u6240\u6709\u6587\u6863\uff0c\u4e3a\u6bcf\u4e2a\u6587\u6863\u8ba1\u7b97 MinHash \u7b7e\u540d\u3002\u8fd9\u4e00\u6b65\u662f\u5b8c\u5168\u5e76\u884c\u7684\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528\u5206\u5e03\u5f0f\u8ba1\u7b97\u8d44\u6e90\u3002</p> <p>\u9636\u6bb5\u4e8c\uff1aBand \u5206\u7ec4\u3002 \u5c06\u6bcf\u4e2a\u6587\u6863\u6309 band \u503c\u8fdb\u884c\u5206\u7ec4\u3002\u76f8\u540c band \u503c\u7684\u6587\u6863\u88ab\u5206\u914d\u5230\u540c\u4e00\u4e2a\u5206\u533a\uff0c\u4fbf\u4e8e\u540e\u7eed\u6bd4\u8f83\u3002</p> <p>\u9636\u6bb5\u4e09\uff1a\u7ec4\u5185\u53bb\u91cd\u3002 \u5728\u6bcf\u4e2a\u5206\u533a\u5185\uff0c\u5bf9\u5019\u9009\u91cd\u590d\u6587\u6863\u5bf9\u8fdb\u884c\u7cbe\u7ec6\u7684\u76f8\u4f3c\u5ea6\u8ba1\u7b97\uff0c\u786e\u5b9a\u771f\u6b63\u7684\u91cd\u590d\u5173\u7cfb\u3002</p> <p>\u9636\u6bb5\u56db\uff1a\u4f20\u9012\u95ed\u5305\u3002 \u5982\u679c\u6587\u6863 A \u4e0e B \u91cd\u590d\uff0cB \u4e0e C \u91cd\u590d\uff0c\u5219 A\u3001B\u3001C \u90fd\u5e94\u89c6\u4e3a\u4e00\u7ec4\u91cd\u590d\u3002\u9700\u8981\u8ba1\u7b97\u91cd\u590d\u5173\u7cfb\u7684\u4f20\u9012\u95ed\u5305\u3002</p> <p>\u9636\u6bb5\u4e94\uff1a\u9009\u62e9\u4fdd\u7559\u6587\u6863\u3002 \u5728\u6bcf\u7ec4\u91cd\u590d\u6587\u6863\u4e2d\u9009\u62e9\u4e00\u4e2a\u4ee3\u8868\uff08\u901a\u5e38\u9009\u62e9\u8d28\u91cf\u6700\u9ad8\u6216\u957f\u5ea6\u6700\u957f\u7684\uff09\u4fdd\u7559\uff0c\u5176\u4ed6\u5220\u9664\u3002</p> <pre><code>import ray\n\ndef distributed_fuzzy_dedup(input_path: str, output_path: str, \n                            threshold: float = 0_8):\n    \"\"\"\n    \u5206\u5e03\u5f0f\u6a21\u7cca\u53bb\u91cd\u6d41\u6c34\u7ebf\n    \"\"\"\n    # \u8bfb\u53d6\u6570\u636e\n    ds = ray.data.read_parquet(input_path)\n\n    # \u9636\u6bb5\u4e00\uff1a\u8ba1\u7b97 MinHash \u7b7e\u540d\n    def compute_signature(doc):\n        lsh = MinHashLSH()\n        ngrams = lsh.get_ngrams(doc['text'])\n        signature = lsh.compute_minhash(ngrams)\n        bands = lsh.get_bands(signature)\n        return {**doc, 'signature': signature.tolist(), 'bands': bands}\n\n    ds = ds.map(compute_signature)\n\n    # \u9636\u6bb5\u4e8c\uff1a\u6309 band \u503c\u5206\u7ec4\uff0c\u627e\u5019\u9009\u5bf9\n    # \uff08\u8fd9\u91cc\u7b80\u5316\u5904\u7406\uff0c\u5b9e\u9645\u5b9e\u73b0\u9700\u8981\u66f4\u590d\u6742\u7684\u5206\u7ec4\u903b\u8f91\uff09\n\n    # \u9636\u6bb5\u4e09&amp;\u56db\uff1a\u7ec4\u5185\u7cbe\u786e\u6bd4\u8f83\uff0c\u5efa\u7acb\u91cd\u590d\u5173\u7cfb\u56fe\n    # ...\n\n    # \u9636\u6bb5\u4e94\uff1a\u9009\u62e9\u4fdd\u7559\u6587\u6863\n    # ...\n\n    # \u4fdd\u5b58\u7ed3\u679c\n    ds.write_parquet(output_path)\n</code></pre> <p>\u5b9e\u9645\u5de5\u7a0b\u4e2d\uff0c\u63a8\u8350\u4f7f\u7528\u73b0\u6210\u7684\u5de5\u5177\u3002text-dedup \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6587\u672c\u53bb\u91cd\u5e93\uff0c\u5b9e\u73b0\u4e86\u591a\u79cd\u53bb\u91cd\u7b97\u6cd5\uff0c\u5305\u62ec MinHash LSH\u3001SimHash\u3001Suffix Array \u7b49\uff0c\u5e76\u63d0\u4f9b\u4e86 Spark \u548c Ray \u7684\u5206\u5e03\u5f0f\u5b9e\u73b0\u3002Dolma \u7684\u53bb\u91cd\u6a21\u5757\u4e5f\u662f\u4e00\u4e2a\u9ad8\u8d28\u91cf\u7684\u53c2\u8003\u5b9e\u73b0\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_24","title":"4_2.4 \u6587\u6863\u5185\u53bb\u91cd","text":"<p>\u9664\u4e86\u6587\u6863\u7ea7\u522b\u7684\u53bb\u91cd\uff0c\u8fd8\u9700\u8981\u5904\u7406\u6587\u6863\u5185\u90e8\u7684\u91cd\u590d\u5185\u5bb9\u3002\u5e38\u89c1\u7684\u60c5\u51b5\u5305\u62ec\uff1a\u7f51\u9875\u4e2d\u53cd\u590d\u51fa\u73b0\u7684\u5bfc\u822a\u680f\u3001\u9875\u7709\u9875\u811a\uff1b\u7531\u4e8e JavaScript \u6e32\u67d3\u95ee\u9898\u5bfc\u81f4\u7684\u5185\u5bb9\u91cd\u590d\uff1b\u67d0\u4e9b CMS \u7cfb\u7edf\u751f\u6210\u7684\u6a21\u677f\u5316\u91cd\u590d\u6bb5\u843d\u3002</p> <p>\u6587\u6863\u5185\u53bb\u91cd\u7684\u7b56\u7565\u76f8\u5bf9\u7b80\u5355\uff1a\u5c06\u6587\u6863\u6309\u6bb5\u843d\u6216\u56fa\u5b9a\u957f\u5ea6\u5206\u5757\uff0c\u8ba1\u7b97\u6bcf\u4e2a\u5757\u7684\u54c8\u5e0c\u503c\uff0c\u79fb\u9664\u91cd\u590d\u7684\u5757\u3002</p> <pre><code>def remove_duplicate_paragraphs(text: str, min_length: int = 50) -&gt; str:\n    \"\"\"\u79fb\u9664\u6587\u6863\u5185\u7684\u91cd\u590d\u6bb5\u843d\"\"\"\n    paragraphs = text.split('\\n\\n')\n    seen_hashes = set()\n    unique_paragraphs = []\n\n    for para in paragraphs:\n        para = para.strip()\n        if len(para) &lt; min_length:\n            unique_paragraphs.append(para)\n            continue\n\n        para_hash = hashlib.md5(para.encode()).hexdigest()\n        if para_hash not in seen_hashes:\n            seen_hashes.add(para_hash)\n            unique_paragraphs.append(para)\n\n    return '\\n\\n'.join(unique_paragraphs)\n\ndef remove_duplicate_ngrams(text: str, n: int = 10, threshold: int = 3) -&gt; str:\n    \"\"\"\u79fb\u9664\u6587\u6863\u5185\u9ad8\u9891\u91cd\u590d\u7684 n-gram\"\"\"\n    words = text.split()\n    ngram_counts = Counter()\n\n    # \u8ba1\u7b97 n-gram \u9891\u6b21\n    for i in range(len(words) - n + 1):\n        ngram = tuple(words[i:i + n])\n        ngram_counts[ngram] += 1\n\n    # \u6807\u8bb0\u9700\u8981\u79fb\u9664\u7684\u4f4d\u7f6e\n    remove_positions = set()\n    for i in range(len(words) - n + 1):\n        ngram = tuple(words[i:i + n])\n        if ngram_counts[ngram] &gt;= threshold:\n            # \u4fdd\u7559\u7b2c\u4e00\u6b21\u51fa\u73b0\uff0c\u79fb\u9664\u540e\u7eed\u91cd\u590d\n            for j in range(i + n, len(words) - n + 1):\n                if tuple(words[j:j + n]) == ngram:\n                    for k in range(j, min(j + n, len(words))):\n                        remove_positions.add(k)\n\n    # \u91cd\u5efa\u6587\u672c\n    result_words = [w for i, w in enumerate(words) if i not in remove_positions]\n    return ' '.join(result_words)\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_3-pii-removal","title":"4_3 \u9690\u79c1\u6570\u636e\u6e05\u6d17 (PII Removal)","text":"<p>\u9884\u8bad\u7ec3\u6570\u636e\u4e2d\u4e0d\u53ef\u907f\u514d\u5730\u5305\u542b\u4e2a\u4eba\u8eab\u4efd\u4fe1\u606f\uff08Personally Identifiable Information, PII\uff09\uff0c\u5982\u90ae\u7bb1\u5730\u5740\u3001\u7535\u8bdd\u53f7\u7801\u3001\u8eab\u4efd\u8bc1\u53f7\u3001\u94f6\u884c\u5361\u53f7\u3001\u5bb6\u5ead\u4f4f\u5740\u7b49\u3002\u5728\u6570\u636e\u5408\u89c4\u8981\u6c42\u65e5\u76ca\u4e25\u683c\u7684\u4eca\u5929\uff08\u5982 GDPR\u3001CCPA\u3001\u300a\u4e2a\u4eba\u4fe1\u606f\u4fdd\u62a4\u6cd5\u300b\uff09\uff0c\u6e05\u6d17 PII \u4e0d\u4ec5\u662f\u9053\u5fb7\u8d23\u4efb\uff0c\u4e5f\u662f\u6cd5\u5f8b\u4e49\u52a1\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_31-pii","title":"4_3.1 PII \u7684\u7c7b\u578b\u4e0e\u98ce\u9669","text":"<p>PII \u53ef\u4ee5\u5206\u4e3a\u76f4\u63a5\u6807\u8bc6\u7b26\u548c\u51c6\u6807\u8bc6\u7b26\u4e24\u7c7b\u3002\u76f4\u63a5\u6807\u8bc6\u7b26\u53ef\u4ee5\u5355\u72ec\u8bc6\u522b\u4e2a\u4eba\u8eab\u4efd\uff0c\u5982\u59d3\u540d\u3001\u8eab\u4efd\u8bc1\u53f7\u3001\u793e\u4f1a\u4fdd\u969c\u53f7\u3001\u7535\u8bdd\u53f7\u7801\u3001\u7535\u5b50\u90ae\u7bb1\u3002\u51c6\u6807\u8bc6\u7b26\u5355\u72ec\u96be\u4ee5\u8bc6\u522b\u4e2a\u4eba\uff0c\u4f46\u7ec4\u5408\u4f7f\u7528\u53ef\u80fd\u5bfc\u81f4\u8bc6\u522b\uff0c\u5982\u51fa\u751f\u65e5\u671f\u3001\u90ae\u653f\u7f16\u7801\u3001\u804c\u4e1a\u3001\u5de5\u4f5c\u5355\u4f4d\u3002</p> <p>\u5728\u9884\u8bad\u7ec3\u6570\u636e\u4e2d\u4fdd\u7559 PII \u5b58\u5728\u591a\u91cd\u98ce\u9669\u3002\u9996\u5148\u662f\u9690\u79c1\u6cc4\u9732\u98ce\u9669\uff1a\u6a21\u578b\u53ef\u80fd\"\u8bb0\u4f4f\"\u8bad\u7ec3\u6570\u636e\u4e2d\u7684\u654f\u611f\u4fe1\u606f\uff0c\u5728\u63a8\u7406\u65f6\u88ab\u6076\u610f\u63d0\u53d6\u3002\u5176\u6b21\u662f\u5408\u89c4\u98ce\u9669\uff1a\u8fdd\u53cd\u6570\u636e\u4fdd\u62a4\u6cd5\u89c4\u53ef\u80fd\u5bfc\u81f4\u5de8\u989d\u7f5a\u6b3e\u3002\u6700\u540e\u662f\u58f0\u8a89\u98ce\u9669\uff1a\u5982\u679c\u6a21\u578b\u8f93\u51fa\u4ed6\u4eba\u9690\u79c1\u4fe1\u606f\uff0c\u4f1a\u4e25\u91cd\u635f\u5bb3\u4f01\u4e1a\u5f62\u8c61\u3002</p> <p></p> <p>\u56fe4-4\uff1aPII\u7c7b\u578b\u4e0e\u98ce\u9669\u7b49\u7ea7 \u2014\u2014 \u76f4\u63a5\u6807\u8bc6\u7b26\uff08\u9ad8\u98ce\u9669\uff09\u4e0e\u51c6\u6807\u8bc6\u7b26\uff08\u4e2d\u98ce\u9669\uff09\u7684\u5206\u7c7b</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_32-microsoft-presidio","title":"4_3.2 Microsoft Presidio","text":"<p>Presidio \u662f\u5fae\u8f6f\u5f00\u6e90\u7684 PII \u8bc6\u522b\u548c\u533f\u540d\u5316\u5de5\u5177\u5305\uff0c\u652f\u6301\u591a\u79cd\u8bed\u8a00\u548c\u591a\u79cd PII \u7c7b\u578b\u3002\u5b83\u91c7\u7528\u6a21\u5757\u5316\u8bbe\u8ba1\uff0c\u5305\u542b\u4e24\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff1aAnalyzer \u8d1f\u8d23\u5728\u6587\u672c\u4e2d\u8bc6\u522b PII \u5b9e\u4f53\uff0cAnonymizer \u8d1f\u8d23\u5bf9\u8bc6\u522b\u51fa\u7684 PII \u8fdb\u884c\u5904\u7406\uff08\u5982\u66ff\u6362\u3001\u63a9\u7801\u3001\u5220\u9664\uff09\u3002</p> <pre><code>from presidio_analyzer import AnalyzerEngine\nfrom presidio_anonymizer import AnonymizerEngine\nfrom presidio_anonymizer.entities import OperatorConfig\n\n# \u521d\u59cb\u5316\u5f15\u64ce\nanalyzer = AnalyzerEngine()\nanonymizer = AnonymizerEngine()\n\ndef analyze_pii(text: str, language: str = 'en') -&gt; list:\n    \"\"\"\n    \u8bc6\u522b\u6587\u672c\u4e2d\u7684 PII\n\n    Returns:\n        PII \u5b9e\u4f53\u5217\u8868\uff0c\u5305\u542b\u7c7b\u578b\u3001\u4f4d\u7f6e\u548c\u7f6e\u4fe1\u5ea6\n    \"\"\"\n    results = analyzer.analyze(\n        text=text,\n        language=language,\n        entities=[\n            'EMAIL_ADDRESS', 'PHONE_NUMBER', 'CREDIT_CARD',\n            'IP_ADDRESS', 'PERSON', 'LOCATION', 'DATE_TIME'\n        ]\n    )\n    return results\n\ndef anonymize_pii(text: str, language: str = 'en') -&gt; str:\n    \"\"\"\n    \u533f\u540d\u5316\u6587\u672c\u4e2d\u7684 PII\n\n    \u5c06\u8bc6\u522b\u51fa\u7684 PII \u66ff\u6362\u4e3a\u5360\u4f4d\u7b26\n    \"\"\"\n    # \u5148\u8bc6\u522b\n    analyzer_results = analyzer.analyze(text=text, language=language)\n\n    # \u5b9a\u4e49\u533f\u540d\u5316\u7b56\u7565\n    operators = {\n        'EMAIL_ADDRESS': OperatorConfig('replace', {'new_value': '&lt;EMAIL&gt;'}),\n        'PHONE_NUMBER': OperatorConfig('replace', {'new_value': '&lt;PHONE&gt;'}),\n        'CREDIT_CARD': OperatorConfig('replace', {'new_value': '&lt;CREDIT_CARD&gt;'}),\n        'IP_ADDRESS': OperatorConfig('replace', {'new_value': '&lt;IP&gt;'}),\n        'PERSON': OperatorConfig('replace', {'new_value': '&lt;PERSON&gt;'}),\n        'LOCATION': OperatorConfig('replace', {'new_value': '&lt;LOCATION&gt;'}),\n        'DATE_TIME': OperatorConfig('keep', {})  # \u65e5\u671f\u65f6\u95f4\u901a\u5e38\u53ef\u4ee5\u4fdd\u7559\n    }\n\n    # \u533f\u540d\u5316\n    anonymized = anonymizer.anonymize(\n        text=text,\n        analyzer_results=analyzer_results,\n        operators=operators\n    )\n\n    return anonymized.text\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_33-pii","title":"4_3.3 \u4e2d\u6587 PII \u5904\u7406","text":"<p>Presidio \u5bf9\u4e2d\u6587\u7684\u652f\u6301\u76f8\u5bf9\u6709\u9650\u3002\u5bf9\u4e8e\u4e2d\u6587\u9884\u8bad\u7ec3\u6570\u636e\uff0c\u901a\u5e38\u9700\u8981\u8865\u5145\u57fa\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u89c4\u5219\u5339\u914d\u3002</p> <pre><code>import re\n\nclass ChinesePIIFilter:\n    \"\"\"\u4e2d\u6587 PII \u8fc7\u6ee4\u5668\"\"\"\n\n    patterns = {\n        'phone': [\n            r'1[3-9]\\d{9}',  # \u624b\u673a\u53f7\n            r'0\\d{2,3}-?\\d{7,8}',  # \u56fa\u5b9a\u7535\u8bdd\n        ],\n        'id_card': [\n            r'\\d{17}[\\dXx]',  # 18\u4f4d\u8eab\u4efd\u8bc1\n            r'\\d{15}',  # 15\u4f4d\u8eab\u4efd\u8bc1\n        ],\n        'email': [\n            r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}',\n        ],\n        'bank_card': [\n            r'\\d{16,19}',  # \u94f6\u884c\u5361\u53f7\uff08\u9700\u8981\u7ed3\u5408\u4e0a\u4e0b\u6587\u5224\u65ad\uff09\n        ],\n        'ip_address': [\n            r'\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}',\n        ],\n        'qq': [\n            r'[Qq][Qq][:\uff1a]?\\s*\\d{5,11}',\n            r'[Qq][:\uff1a]?\\s*\\d{5,11}',\n        ],\n        'wechat': [\n            r'[Vv][Xx][:\uff1a]?\\s*[a-zA-Z0-9_-]{6,20}',\n            r'\u5fae\u4fe1[:\uff1a]?\\s*[a-zA-Z0-9_-]{6,20}',\n        ],\n    }\n\n    def __init__(self):\n        self.compiled_patterns = {}\n        for pii_type, patterns in self.patterns.items():\n            self.compiled_patterns[pii_type] = [\n                re.compile(p) for p in patterns\n            ]\n\n    def find_pii(self, text: str) -&gt; list:\n        \"\"\"\u67e5\u627e\u6240\u6709 PII\"\"\"\n        findings = []\n        for pii_type, patterns in self.compiled_patterns.items():\n            for pattern in patterns:\n                for match in pattern.finditer(text):\n                    findings.append({\n                        'type': pii_type,\n                        'value': match.group(),\n                        'start': match.start(),\n                        'end': match.end()\n                    })\n        return findings\n\n    def anonymize(self, text: str) -&gt; str:\n        \"\"\"\u533f\u540d\u5316 PII\"\"\"\n        findings = self.find_pii(text)\n\n        # \u6309\u4f4d\u7f6e\u5012\u5e8f\u5904\u7406\uff0c\u907f\u514d\u66ff\u6362\u5f71\u54cd\u540e\u7eed\u4f4d\u7f6e\n        findings.sort(key=lambda x: x['start'], reverse=True)\n\n        for finding in findings:\n            placeholder = f\"&lt;{finding['type'].upper()}&gt;\"\n            text = text[:finding['start']] + placeholder + text[finding['end']:]\n\n        return text\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_34-pii","title":"4_3.4 PII \u5904\u7406\u7b56\u7565\u7684\u6743\u8861","text":"<p>PII \u5904\u7406\u9762\u4e34\u51c6\u786e\u7387\u4e0e\u53ec\u56de\u7387\u7684\u6743\u8861\u3002\u8fc7\u4e8e\u6fc0\u8fdb\u7684\u8fc7\u6ee4\u53ef\u80fd\u8bef\u4f24\u6b63\u5e38\u5185\u5bb9\uff08\u5982\u5c06\u666e\u901a\u6570\u5b57\u5e8f\u5217\u8bef\u5224\u4e3a\u7535\u8bdd\u53f7\u7801\uff09\uff0c\u8fc7\u4e8e\u4fdd\u5b88\u5219\u53ef\u80fd\u9057\u6f0f\u771f\u6b63\u7684\u654f\u611f\u4fe1\u606f\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5efa\u8bae\u91c7\u7528\u5206\u5c42\u7b56\u7565\u3002\u5bf9\u4e8e\u9ad8\u98ce\u9669 PII\uff08\u5982\u8eab\u4efd\u8bc1\u53f7\u3001\u94f6\u884c\u5361\u53f7\uff09\uff0c\u4f7f\u7528\u8f83\u4e25\u683c\u7684\u5339\u914d\u89c4\u5219\uff0c\u5b81\u53ef\u8bef\u5220\u4e5f\u4e0d\u9057\u6f0f\u3002\u5bf9\u4e8e\u4e2d\u98ce\u9669 PII\uff08\u5982\u7535\u8bdd\u53f7\u7801\u3001\u90ae\u7bb1\uff09\uff0c\u4f7f\u7528\u9002\u4e2d\u7684\u9608\u503c\uff0c\u5e73\u8861\u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u3002\u5bf9\u4e8e\u4f4e\u98ce\u9669\u4fe1\u606f\uff08\u5982\u65e5\u671f\u3001\u5730\u70b9\uff09\uff0c\u53ef\u4ee5\u6839\u636e\u5177\u4f53\u573a\u666f\u51b3\u5b9a\u662f\u5426\u5904\u7406\u3002</p> <p>\u53e6\u4e00\u4e2a\u91cd\u8981\u51b3\u7b56\u662f\u66ff\u6362\u7b56\u7565\u3002\u5e38\u89c1\u7684\u9009\u62e9\u5305\u62ec\uff1a\u5b8c\u5168\u5220\u9664\uff0c\u7b80\u5355\u4f46\u53ef\u80fd\u7834\u574f\u8bed\u53e5\u6d41\u7545\u6027\uff1b\u56fa\u5b9a\u5360\u4f4d\u7b26\u66ff\u6362\uff08\u5982 <code>&lt;EMAIL&gt;</code>\uff09\uff0c\u4fdd\u7559\u8bed\u4e49\u4fe1\u606f\u4f46\u53ef\u80fd\u5f15\u5165\u4e0d\u81ea\u7136\u7684\u6a21\u5f0f\uff1b\u968f\u673a\u751f\u6210\u66ff\u6362\uff08\u5982\u7528\u968f\u673a\u90ae\u7bb1\u66ff\u6362\u771f\u5b9e\u90ae\u7bb1\uff09\uff0c\u6700\u63a5\u8fd1\u539f\u59cb\u5206\u5e03\u4f46\u5b9e\u73b0\u590d\u6742\u3002\u5927\u591a\u6570\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u91c7\u7528\u5360\u4f4d\u7b26\u66ff\u6362\u7b56\u7565\uff0c\u4f5c\u4e3a\u51c6\u786e\u7387\u548c\u590d\u6742\u5ea6\u7684\u5e73\u8861\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_4","title":"4_4 \u5b8c\u6574\u6e05\u6d17\u6d41\u6c34\u7ebf","text":"<p>\u5c06\u524d\u9762\u4ecb\u7ecd\u7684\u5404\u4e2a\u7ec4\u4ef6\u4e32\u8054\u8d77\u6765\uff0c\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u6570\u636e\u6e05\u6d17\u6d41\u6c34\u7ebf\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_41","title":"4_4.1 \u6d41\u6c34\u7ebf\u67b6\u6784","text":"<p>\u4e00\u4e2a\u5de5\u4e1a\u7ea7\u7684\u6e05\u6d17\u6d41\u6c34\u7ebf\u901a\u5e38\u5305\u62ec\u4ee5\u4e0b\u9636\u6bb5\uff0c\u6309\u987a\u5e8f\u6267\u884c\uff1a</p> <p>\u9636\u6bb5\u4e00\uff1a\u683c\u5f0f\u6807\u51c6\u5316\u3002 \u5c06\u5404\u79cd\u6765\u6e90\u7684\u6570\u636e\u8f6c\u6362\u4e3a\u7edf\u4e00\u683c\u5f0f\uff0c\u5904\u7406\u7f16\u7801\u95ee\u9898\uff0c\u63d0\u53d6\u5fc5\u8981\u7684\u5143\u6570\u636e\u3002</p> <p>\u9636\u6bb5\u4e8c\uff1a\u8bed\u8a00\u8fc7\u6ee4\u3002 \u4f7f\u7528 FastText \u8bc6\u522b\u8bed\u8a00\uff0c\u4fdd\u7559\u76ee\u6807\u8bed\u8a00\u7684\u6587\u6863\u3002\u5bf9\u4e8e\u6df7\u5408\u8bed\u8a00\u6587\u6863\uff0c\u6839\u636e\u4e3b\u8981\u8bed\u8a00\u8fdb\u884c\u5206\u7c7b\u3002</p> <p>\u9636\u6bb5\u4e09\uff1a\u542f\u53d1\u5f0f\u8fc7\u6ee4\u3002 \u5e94\u7528\u957f\u5ea6\u3001\u7279\u6b8a\u5b57\u7b26\u3001\u91cd\u590d\u884c\u7b49\u542f\u53d1\u5f0f\u89c4\u5219\uff0c\u5feb\u901f\u8fc7\u6ee4\u660e\u663e\u7684\u4f4e\u8d28\u91cf\u5185\u5bb9\u3002</p> <p>\u9636\u6bb5\u56db\uff1a\u6587\u6863\u5185\u53bb\u91cd\u3002 \u79fb\u9664\u6587\u6863\u5185\u90e8\u7684\u91cd\u590d\u6bb5\u843d\u548c\u91cd\u590d n-gram\u3002</p> <p>\u9636\u6bb5\u4e94\uff1aPII \u6e05\u6d17\u3002 \u8bc6\u522b\u5e76\u533f\u540d\u5316\u654f\u611f\u4e2a\u4eba\u4fe1\u606f\u3002</p> <p>\u9636\u6bb5\u516d\uff1a\u8d28\u91cf\u8bc4\u5206\u3002 \u8ba1\u7b97\u56f0\u60d1\u5ea6\u7b49\u8d28\u91cf\u6307\u6807\uff0c\u4e3a\u540e\u7eed\u7684\u8d28\u91cf\u5206\u5c42\u63d0\u4f9b\u4f9d\u636e\u3002</p> <p>\u9636\u6bb5\u4e03\uff1a\u6587\u6863\u95f4\u53bb\u91cd\u3002 \u4f7f\u7528 MinHash LSH \u8fdb\u884c\u5927\u89c4\u6a21\u6a21\u7cca\u53bb\u91cd\uff0c\u79fb\u9664\u9ad8\u5ea6\u76f8\u4f3c\u7684\u6587\u6863\u3002</p> <p>\u9636\u6bb5\u516b\uff1a\u8d28\u91cf\u5206\u5c42\u4e0e\u91c7\u6837\u3002 \u6839\u636e\u8d28\u91cf\u8bc4\u5206\u5c06\u6570\u636e\u5206\u5c42\uff0c\u786e\u5b9a\u5404\u5c42\u7684\u91c7\u6837\u6743\u91cd\u3002</p> <pre><code>import ray\nfrom dataclasses import dataclass\nfrom typing import Optional\n\n@dataclass\nclass CleaningConfig:\n    \"\"\"\u6e05\u6d17\u914d\u7f6e\"\"\"\n    target_language: str = 'zh'\n    min_length: int = 200\n    max_length: int = 100000\n    max_perplexity: float = 500\n    dedup_threshold: float = 0_8\n    anonymize_pii: bool = True\n\nclass DataCleaningPipeline:\n    def __init__(self, config: CleaningConfig):\n        self.config = config\n        self.lang_filter = LanguageFilter(config.target_language)\n        self.heuristic_filter = HeuristicFilter()\n        self.perplexity_filter = PerplexityFilter(max_ppl=config.max_perplexity)\n        self.pii_filter = ChinesePIIFilter() if config.target_language == 'zh' else None\n        self.deduplicator = MinHashLSH(threshold=config.dedup_threshold)\n\n    def process_document(self, doc: dict) -&gt; Optional[dict]:\n        \"\"\"\u5904\u7406\u5355\u4e2a\u6587\u6863\"\"\"\n        text = doc.get('text', '')\n\n        # \u9636\u6bb5\u4e8c\uff1a\u8bed\u8a00\u8fc7\u6ee4\n        lang, conf = self.lang_filter.detect(text)\n        if lang != self.config.target_language:\n            return None\n\n        # \u9636\u6bb5\u4e09\uff1a\u542f\u53d1\u5f0f\u8fc7\u6ee4\n        passed, reason = self.heuristic_filter.filter(text)\n        if not passed:\n            return None\n\n        # \u9636\u6bb5\u56db\uff1a\u6587\u6863\u5185\u53bb\u91cd\n        text = remove_duplicate_paragraphs(text)\n\n        # \u9636\u6bb5\u4e94\uff1aPII \u6e05\u6d17\n        if self.config.anonymize_pii and self.pii_filter:\n            text = self.pii_filter.anonymize(text)\n\n        # \u9636\u6bb5\u516d\uff1a\u8d28\u91cf\u8bc4\u5206\n        perplexity = self.perplexity_filter.compute_perplexity(text)\n        if perplexity &gt; self.config.max_perplexity:\n            return None\n\n        return {\n            **doc,\n            'text': text,\n            'language': lang,\n            'lang_confidence': conf,\n            'perplexity': perplexity\n        }\n\n    def run(self, input_path: str, output_path: str):\n        \"\"\"\u8fd0\u884c\u5b8c\u6574\u6d41\u6c34\u7ebf\"\"\"\n        # \u8bfb\u53d6\u6570\u636e\n        ds = ray.data.read_parquet(input_path)\n\n        # \u9636\u6bb5\u4e00\u5230\u516d\uff1a\u5355\u6587\u6863\u5904\u7406\n        ds = ds.map(self.process_document)\n        ds = ds.filter(lambda x: x is not None)\n\n        # \u9636\u6bb5\u4e03\uff1a\u6587\u6863\u95f4\u53bb\u91cd\n        ds = self.deduplicator.deduplicate(ds)\n\n        # \u4fdd\u5b58\u7ed3\u679c\n        ds.write_parquet(output_path)\n</code></pre>"},{"location":"chapter2/2_2_cleaning_denoising/#4_42","title":"4_4.2 \u8d28\u91cf\u76d1\u63a7\u4e0e\u8fed\u4ee3","text":"<p>\u6e05\u6d17\u6d41\u6c34\u7ebf\u4e0d\u662f\u4e00\u6b21\u6027\u4efb\u52a1\uff0c\u800c\u662f\u9700\u8981\u6301\u7eed\u76d1\u63a7\u548c\u8fed\u4ee3\u4f18\u5316\u7684\u8fc7\u7a0b\u3002\u5efa\u8bae\u5efa\u7acb\u4ee5\u4e0b\u76d1\u63a7\u673a\u5236\uff1a</p> <p>\u8fc7\u6ee4\u7387\u76d1\u63a7\uff1a\u7edf\u8ba1\u6bcf\u4e2a\u9636\u6bb5\u7684\u8fc7\u6ee4\u7387\u3002\u5982\u679c\u67d0\u4e2a\u9636\u6bb5\u7a81\u7136\u8fc7\u6ee4\u6389\u5927\u91cf\u6570\u636e\uff0c\u53ef\u80fd\u662f\u9608\u503c\u8bbe\u7f6e\u4e0d\u5f53\u6216\u6570\u636e\u5206\u5e03\u53d1\u751f\u53d8\u5316\u3002</p> <p>\u6837\u672c\u62bd\u68c0\uff1a\u5b9a\u671f\u4eba\u5de5\u62bd\u68c0\u6e05\u6d17\u7ed3\u679c\uff0c\u8bc4\u4f30\u8fc7\u6ee4\u89c4\u5219\u7684\u51c6\u786e\u6027\u3002\u8bef\u5220\u7684\u597d\u6837\u672c\u548c\u6f0f\u5220\u7684\u574f\u6837\u672c\u90fd\u9700\u8981\u5173\u6ce8\u3002</p> <p>\u4e0b\u6e38\u53cd\u9988\uff1a\u6a21\u578b\u8bad\u7ec3\u540e\u7684\u8bc4\u6d4b\u7ed3\u679c\u662f\u6700\u7ec8\u7684\u8d28\u91cf\u9a8c\u8bc1\u3002\u5982\u679c\u6a21\u578b\u8868\u73b0\u4e0d\u4f73\uff0c\u9700\u8981\u56de\u6eaf\u5206\u6790\u6570\u636e\u662f\u5426\u5b58\u5728\u95ee\u9898\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#4_5","title":"4_5 \u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u7cfb\u7edf\u4ecb\u7ecd\u4e86\u9884\u8bad\u7ec3\u6570\u636e\u6e05\u6d17\u7684\u6838\u5fc3\u6280\u672f\u3002</p> <p>\u5728\u542f\u53d1\u5f0f\u8fc7\u6ee4\u65b9\u9762\uff0c\u8bed\u8a00\u8bc6\u522b\u4f7f\u7528 FastText \u5feb\u901f\u7b5b\u9009\u76ee\u6807\u8bed\u8a00\u6587\u6863\uff0c\u56f0\u60d1\u5ea6\u8fc7\u6ee4\u4f7f\u7528 KenLM \u8bc4\u4f30\u6587\u672c\u8d28\u91cf\uff0c\u542f\u53d1\u5f0f\u89c4\u5219\u96c6\u6db5\u76d6\u957f\u5ea6\u3001\u7279\u6b8a\u5b57\u7b26\u3001\u91cd\u590d\u884c\u3001\u8bcd\u6c47\u591a\u6837\u6027\u7b49\u591a\u4e2a\u7ef4\u5ea6\u3002\u8d28\u91cf\u5206\u5c42\u7b56\u7565\u5c06\u6570\u636e\u5212\u5206\u4e3a\u4e0d\u540c\u7b49\u7ea7\uff0c\u4e3a\u540e\u7eed\u91c7\u6837\u63d0\u4f9b\u4f9d\u636e\u3002</p> <p>\u5728\u5927\u89c4\u6a21\u53bb\u91cd\u65b9\u9762\uff0c\u7cbe\u786e\u53bb\u91cd\u4f7f\u7528\u54c8\u5e0c\u65b9\u6cd5\u5feb\u901f\u79fb\u9664\u5b8c\u5168\u76f8\u540c\u7684\u6587\u6863\uff0c\u6a21\u7cca\u53bb\u91cd\u4f7f\u7528 MinHash LSH \u7b97\u6cd5\u8bc6\u522b\u9ad8\u5ea6\u76f8\u4f3c\u7684\u5185\u5bb9\u3002\u5206\u5e03\u5f0f\u5b9e\u73b0\u662f\u5904\u7406 TB \u7ea7\u6570\u636e\u7684\u5fc5\u8981\u624b\u6bb5\u3002\u6587\u6863\u5185\u53bb\u91cd\u5904\u7406\u6bb5\u843d\u548c n-gram \u7ea7\u522b\u7684\u91cd\u590d\u3002</p> <p>\u5728\u9690\u79c1\u6e05\u6d17\u65b9\u9762\uff0cPII \u8bc6\u522b\u53ef\u4ee5\u4f7f\u7528 Presidio \u6216\u81ea\u5b9a\u4e49\u6b63\u5219\u89c4\u5219\uff0c\u533f\u540d\u5316\u7b56\u7565\u9700\u8981\u5728\u51c6\u786e\u7387\u548c\u4fe1\u606f\u4fdd\u7559\u4e4b\u95f4\u6743\u8861\u3002\u4e2d\u6587 PII \u5904\u7406\u9700\u8981\u7279\u522b\u8bbe\u8ba1\u7684\u89c4\u5219\u96c6\u3002</p> <p>\u5b8c\u6574\u7684\u6e05\u6d17\u6d41\u6c34\u7ebf\u5c06\u5404\u4e2a\u7ec4\u4ef6\u4e32\u8054\uff0c\u6309\u7167\u683c\u5f0f\u6807\u51c6\u5316\u3001\u8bed\u8a00\u8fc7\u6ee4\u3001\u542f\u53d1\u5f0f\u8fc7\u6ee4\u3001\u6587\u6863\u5185\u53bb\u91cd\u3001PII \u6e05\u6d17\u3001\u8d28\u91cf\u8bc4\u5206\u3001\u6587\u6863\u95f4\u53bb\u91cd\u3001\u8d28\u91cf\u5206\u5c42\u7684\u987a\u5e8f\u6267\u884c\u3002\u6301\u7eed\u7684\u8d28\u91cf\u76d1\u63a7\u548c\u8fed\u4ee3\u4f18\u5316\u662f\u4fdd\u8bc1\u6570\u636e\u8d28\u91cf\u7684\u5173\u952e\u3002</p> <p></p> <p>\u56fe4-5\uff1a\u7b2c4\u7ae0\u77e5\u8bc6\u7ed3\u6784 \u2014\u2014 \u542f\u53d1\u5f0f\u8fc7\u6ee4\u3001\u5927\u89c4\u6a21\u53bb\u91cd\u3001PII\u6e05\u6d17\u4e09\u5927\u6838\u5fc3\u4e3b\u9898</p>"},{"location":"chapter2/2_2_cleaning_denoising/#_3","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u5173\u4e8e\u6570\u636e\u6e05\u6d17\u7684\u6df1\u5165\u5185\u5bb9\uff0c\u4ee5\u4e0b\u8d44\u6e90\u503c\u5f97\u53c2\u8003\uff1a</p> <p>RefinedWeb \u8bba\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4ece Common Crawl \u6784\u5efa\u9ad8\u8d28\u91cf\u9884\u8bad\u7ec3\u96c6\u7684\u5b8c\u6574\u6e05\u6d17\u6d41\u7a0b\u3002Dolma \u6570\u636e\u96c6\u7684\u6280\u672f\u62a5\u544a\u4ecb\u7ecd\u4e86 Allen AI \u7684\u6e05\u6d17\u7b56\u7565\u548c\u5de5\u5177\u3002text-dedup \u5f00\u6e90\u5e93\uff08github.com/ChenghaoMou/text-dedup\uff09\u63d0\u4f9b\u4e86\u591a\u79cd\u53bb\u91cd\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002Microsoft Presidio \u6587\u6863\uff08microsoft.github.io/presidio\uff09\u662f PII \u5904\u7406\u7684\u6743\u5a01\u53c2\u8003\u3002CCNet \u8bba\u6587\u4ecb\u7ecd\u4e86 Facebook \u5904\u7406 Common Crawl \u6570\u636e\u7684\u65b9\u6cd5\uff0c\u7279\u522b\u662f\u56f0\u60d1\u5ea6\u8fc7\u6ee4\u7684\u7ec6\u8282\u3002</p>"},{"location":"chapter2/2_2_cleaning_denoising/#_4","title":"\u4e0b\u4e00\u7ae0\u9884\u544a","text":"<p>\u5728\u4e0b\u4e00\u7ae0\u300a\u5206\u8bcd\u4e0e\u5e8f\u5217\u5316\u300b\u4e2d\uff0c\u6211\u4eec\u5c06\u63a2\u8ba8\u9884\u8bad\u7ec3\u6570\u636e\u51c6\u5907\u7684\u6700\u540e\u4e00\u4e2a\u5173\u952e\u6b65\u9aa4\uff1a\u5982\u4f55\u5c06\u6e05\u6d17\u540e\u7684\u6587\u672c\u8f6c\u6362\u4e3a\u6a21\u578b\u53ef\u4ee5\u7406\u89e3\u7684 Token \u5e8f\u5217\u3002\u4f60\u5c06\u5b66\u4e60 BPE\u3001WordPiece\u3001Unigram \u7b49\u5206\u8bcd\u7b97\u6cd5\u7684\u539f\u7406\u4e0e\u9009\u62e9\uff0c\u5982\u4f55\u4e3a\u7279\u5b9a\u9886\u57df\u6269\u5145\u8bcd\u8868\uff0c\u4ee5\u53ca\u6570\u636e\u6df7\u5408\u4e0e\u8bfe\u7a0b\u5b66\u4e60\u7684\u91c7\u6837\u7b56\u7565\u3002</p> <p>\u5e26\u7740\u8fd9\u4e2a\u95ee\u9898\u8fdb\u5165\u4e0b\u4e00\u7ae0\uff1a\u5982\u679c\u4f60\u8981\u8bad\u7ec3\u4e00\u4e2a\u4e13\u95e8\u5904\u7406\u4ee3\u7801\u7684\u6a21\u578b\uff0c\u6807\u51c6\u7684 GPT-2 \u5206\u8bcd\u5668\u4f1a\u9047\u5230\u4ec0\u4e48\u95ee\u9898\uff1f</p>"},{"location":"chapter2/2_3_tokenization_serialization/","title":"\u7b2c5\u7ae0\uff1a\u5206\u8bcd\u4e0e\u5e8f\u5217\u5316","text":""},{"location":"chapter2/2_3_tokenization_serialization/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5206\u8bcd\uff08Tokenization\uff09\u662f\u8fde\u63a5\u539f\u59cb\u6587\u672c\u4e0e\u795e\u7ecf\u7f51\u7edc\u7684\u6865\u6881\u3002\u6e05\u6d17\u540e\u7684\u9ad8\u8d28\u91cf\u8bed\u6599\u9700\u8981\u8f6c\u6362\u4e3a\u6a21\u578b\u53ef\u4ee5\u7406\u89e3\u7684\u6570\u5b57\u5e8f\u5217\uff0c\u624d\u80fd\u8f93\u5165\u5230 Transformer \u4e2d\u8fdb\u884c\u8bad\u7ec3\u3002\u672c\u7ae0\u5c06\u6df1\u5165\u63a2\u8ba8\u5206\u8bcd\u5668\u7684\u5de5\u4f5c\u539f\u7406\uff0c\u5305\u62ec BPE\u3001WordPiece\u3001Unigram \u4e09\u5927\u4e3b\u6d41\u7b97\u6cd5\uff1b\u4ecb\u7ecd\u5982\u4f55\u4e3a\u7279\u5b9a\u9886\u57df\u6784\u5efa\u548c\u6269\u5145\u8bcd\u8868\uff1b\u6700\u540e\u8ba8\u8bba\u6570\u636e\u6df7\u5408\u4e0e\u8bfe\u7a0b\u5b66\u4e60\u7b56\u7565\uff0c\u8fd9\u4e9b\u7b56\u7565\u51b3\u5b9a\u4e86\u4e0d\u540c\u7c7b\u578b\u6570\u636e\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u7684\u5448\u73b0\u987a\u5e8f\u548c\u6bd4\u4f8b\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u4f60\u7684\u56e2\u961f\u6b63\u5728\u8bad\u7ec3\u4e00\u4e2a\u4e13\u95e8\u5904\u7406\u4ee3\u7801\u7684\u5927\u6a21\u578b\u3002\u4f7f\u7528\u6807\u51c6\u7684 GPT-2 \u5206\u8bcd\u5668\u8fdb\u884c\u521d\u6b65\u5b9e\u9a8c\u540e\uff0c\u53d1\u73b0\u4e86\u4e00\u4e2a\u5947\u602a\u7684\u73b0\u8c61\uff1a\u6a21\u578b\u751f\u6210\u7684\u4ee3\u7801\u7ecf\u5e38\u5728\u7f29\u8fdb\u5904\u51fa\u9519\uff0c\u628a\u56db\u4e2a\u7a7a\u683c\u62c6\u6210\u4e86\u591a\u4e2a\u4e0d\u540c\u7684 token\uff0c\u5bfc\u81f4\u7f29\u8fdb\u4e0d\u4e00\u81f4\u3002\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u4e00\u4e9b\u5e38\u89c1\u7684\u7f16\u7a0b\u5173\u952e\u5b57\uff08\u5982 <code>def</code>\u3001<code>return</code>\uff09\u88ab\u62c6\u5206\u6210\u4e86\u591a\u4e2a\u5b50\u8bcd\uff0c\u6a21\u578b\u9700\u8981\u989d\u5916\u7684\u4e0a\u4e0b\u6587\u624d\u80fd\u7406\u89e3\u5b83\u4eec\u7684\u542b\u4e49\u3002</p> <p>\u7ecf\u8fc7\u5206\u6790\uff0c\u4f60\u53d1\u73b0\u95ee\u9898\u51fa\u5728\u5206\u8bcd\u5668\u4e0a\u3002GPT-2 \u7684\u5206\u8bcd\u5668\u662f\u5728\u7f51\u9875\u6587\u672c\u4e0a\u8bad\u7ec3\u7684\uff0c\u5bf9\u4ee3\u7801\u7684\u7279\u6b8a\u7ed3\u6784\uff08\u5982\u7a7a\u767d\u7b26\u3001\u9a7c\u5cf0\u547d\u540d\u3001\u7279\u6b8a\u7b26\u53f7\uff09\u5904\u7406\u5f97\u5e76\u4e0d\u597d\u3002\u4e3a\u4ee3\u7801\u4efb\u52a1\u8bbe\u8ba1\u4e13\u95e8\u7684\u5206\u8bcd\u5668\uff0c\u6210\u4e3a\u4e86\u63d0\u5347\u6a21\u578b\u6027\u80fd\u7684\u5173\u952e\u4e00\u6b65\u3002</p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\uff1a\u5206\u8bcd\u5668\u7edd\u975e\u53ef\u4ee5\u5ffd\u89c6\u7684\"\u9884\u5904\u7406\u7ec6\u8282\"\uff0c\u5b83\u5bf9\u6a21\u578b\u7684\u80fd\u529b\u6709\u5b9e\u8d28\u6027\u7684\u5f71\u54cd\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_1","title":"5_1 \u5206\u8bcd\u5668\u539f\u7406","text":"<p>\u5206\u8bcd\u5668\u7684\u6838\u5fc3\u4efb\u52a1\u662f\u5c06\u8fde\u7eed\u7684\u6587\u672c\u5b57\u7b26\u4e32\u5207\u5206\u4e3a\u79bb\u6563\u7684 token \u5e8f\u5217\uff0c\u5e76\u5c06\u6bcf\u4e2a token \u6620\u5c04\u5230\u4e00\u4e2a\u6574\u6570 ID\u3002\u8fd9\u4e2a\u770b\u4f3c\u7b80\u5355\u7684\u4efb\u52a1\uff0c\u5b9e\u9645\u4e0a\u6d89\u53ca\u5230\u590d\u6742\u7684\u7b97\u6cd5\u8bbe\u8ba1\u548c\u5de5\u7a0b\u6743\u8861\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_11","title":"5_1.1 \u4e3a\u4ec0\u4e48\u9700\u8981\u5b50\u8bcd\u5206\u8bcd\uff1f","text":"<p>\u5728\u6df1\u5ea6\u5b66\u4e60\u65f6\u4ee3\u65e9\u671f\uff0c\u81ea\u7136\u8bed\u8a00\u5904\u7406\u901a\u5e38\u91c7\u7528\u8bcd\u7ea7\u522b\uff08Word-level\uff09\u6216\u5b57\u7b26\u7ea7\u522b\uff08Character-level\uff09\u7684\u5206\u8bcd\u65b9\u5f0f\u3002\u8bcd\u7ea7\u522b\u5206\u8bcd\u5c06\u6bcf\u4e2a\u5b8c\u6574\u7684\u5355\u8bcd\u89c6\u4e3a\u4e00\u4e2a token\uff0c\u4f18\u70b9\u662f\u8bed\u4e49\u6e05\u6670\uff0c\u7f3a\u70b9\u662f\u8bcd\u8868\u89c4\u6a21\u5e9e\u5927\uff08\u9700\u8981\u8986\u76d6\u6240\u6709\u53ef\u80fd\u51fa\u73b0\u7684\u5355\u8bcd\uff09\uff0c\u4e14\u65e0\u6cd5\u5904\u7406\u672a\u767b\u5f55\u8bcd\uff08Out-of-Vocabulary, OOV\uff09\u3002\u5b57\u7b26\u7ea7\u522b\u5206\u8bcd\u5c06\u6bcf\u4e2a\u5b57\u7b26\u89c6\u4e3a\u4e00\u4e2a token\uff0c\u4f18\u70b9\u662f\u8bcd\u8868\u6781\u5c0f\u4e14\u6ca1\u6709 OOV \u95ee\u9898\uff0c\u7f3a\u70b9\u662f\u5e8f\u5217\u8fc7\u957f\uff0c\u6a21\u578b\u96be\u4ee5\u6355\u6349\u957f\u7a0b\u4f9d\u8d56\u3002</p> <p>\u5b50\u8bcd\u5206\u8bcd\uff08Subword Tokenization\uff09\u662f\u4e00\u79cd\u6298\u4e2d\u65b9\u6848\u3002\u5b83\u5c06\u6587\u672c\u5207\u5206\u4e3a\u6bd4\u5355\u8bcd\u66f4\u5c0f\u3001\u6bd4\u5b57\u7b26\u66f4\u5927\u7684\u5355\u5143\u3002\u9ad8\u9891\u8bcd\u4fdd\u6301\u5b8c\u6574\uff0c\u4f4e\u9891\u8bcd\u5219\u88ab\u62c6\u5206\u4e3a\u66f4\u5c0f\u7684\u5b50\u8bcd\u5355\u5143\u3002\u4f8b\u5982\uff0c\"unhappiness\" \u53ef\u80fd\u88ab\u62c6\u5206\u4e3a \"un\" + \"happi\" + \"ness\"\u3002\u8fd9\u79cd\u65b9\u5f0f\u65e2\u63a7\u5236\u4e86\u8bcd\u8868\u89c4\u6a21\uff0c\u53c8\u4fdd\u7559\u4e86\u4e00\u5b9a\u7684\u8bed\u4e49\u4fe1\u606f\uff0c\u8fd8\u80fd\u901a\u8fc7\u5b50\u8bcd\u7ec4\u5408\u5904\u7406\u672a\u89c1\u8fc7\u7684\u8bcd\u6c47\u3002</p> <p></p> <p>\u56fe5-1\uff1a\u5206\u8bcd\u7c92\u5ea6\u5bf9\u6bd4 \u2014\u2014 \u8bcd\u7ea7\u522b\u3001\u5b57\u7b26\u7ea7\u522b\u4e0e\u5b50\u8bcd\u7ea7\u522b\u7684\u6743\u8861</p> <p>\u76ee\u524d\u4e3b\u6d41\u7684\u5927\u8bed\u8a00\u6a21\u578b\u51e0\u4e4e\u90fd\u91c7\u7528\u5b50\u8bcd\u5206\u8bcd\u3002GPT \u7cfb\u5217\u4f7f\u7528 BPE\uff0cBERT \u4f7f\u7528 WordPiece\uff0cT5 \u548c LLaMA \u4f7f\u7528 SentencePiece\uff08\u652f\u6301 BPE \u548c Unigram\uff09\u3002\u7406\u89e3\u8fd9\u4e9b\u7b97\u6cd5\u7684\u539f\u7406\uff0c\u662f\u8fdb\u884c\u5206\u8bcd\u5668\u5b9a\u5236\u548c\u4f18\u5316\u7684\u57fa\u7840\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_12-bpe","title":"5_1.2 BPE\uff1a\u5b57\u8282\u5bf9\u7f16\u7801","text":"<p>BPE\uff08Byte Pair Encoding\uff09\u6700\u521d\u662f\u4e00\u79cd\u6570\u636e\u538b\u7f29\u7b97\u6cd5\uff0c\u540e\u88ab Sennrich \u7b49\u4eba\u5728 2015 \u5e74\u5f15\u5165\u5230\u795e\u7ecf\u673a\u5668\u7ffb\u8bd1\u4e2d\uff0c\u6210\u4e3a\u6700\u5e7f\u6cdb\u4f7f\u7528\u7684\u5b50\u8bcd\u5206\u8bcd\u7b97\u6cd5\u3002</p> <p>BPE \u7684\u6838\u5fc3\u601d\u60f3\u975e\u5e38\u76f4\u89c2\uff1a\u4ece\u5b57\u7b26\u7ea7\u522b\u5f00\u59cb\uff0c\u53cd\u590d\u5408\u5e76\u51fa\u73b0\u9891\u7387\u6700\u9ad8\u7684\u76f8\u90bb token \u5bf9\uff0c\u76f4\u5230\u8fbe\u5230\u9884\u5b9a\u7684\u8bcd\u8868\u5927\u5c0f\u3002\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u5c06\u6240\u6709\u8bad\u7ec3\u6587\u672c\u62c6\u5206\u4e3a\u5b57\u7b26\u5e8f\u5217\uff0c\u6bcf\u4e2a\u5b57\u7b26\u4f5c\u4e3a\u521d\u59cb token</li> <li>\u7edf\u8ba1\u6240\u6709\u76f8\u90bb token \u5bf9\u7684\u51fa\u73b0\u9891\u7387</li> <li>\u5c06\u9891\u7387\u6700\u9ad8\u7684 token \u5bf9\u5408\u5e76\u4e3a\u4e00\u4e2a\u65b0 token</li> <li>\u91cd\u590d\u6b65\u9aa4 2-3\uff0c\u76f4\u5230\u8bcd\u8868\u8fbe\u5230\u76ee\u6807\u5927\u5c0f</li> </ol> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7b80\u5316\u7684 BPE \u8bad\u7ec3\u5b9e\u73b0\uff1a</p> <pre><code>from collections import Counter, defaultdict\n\ndef train_bpe(corpus: list, vocab_size: int) -&gt; dict:\n    \"\"\"\n    \u8bad\u7ec3 BPE \u5206\u8bcd\u5668\n\n    Args:\n        corpus: \u8bad\u7ec3\u8bed\u6599\u5217\u8868\n        vocab_size: \u76ee\u6807\u8bcd\u8868\u5927\u5c0f\n\n    Returns:\n        \u5408\u5e76\u89c4\u5219\u5b57\u5178\n    \"\"\"\n    # \u521d\u59cb\u5316\uff1a\u5c06\u6bcf\u4e2a\u8bcd\u62c6\u5206\u4e3a\u5b57\u7b26\uff0c\u5e76\u6dfb\u52a0\u8bcd\u5c3e\u6807\u8bb0\n    word_freqs = Counter()\n    for text in corpus:\n        for word in text.split():\n            # \u6dfb\u52a0\u8bcd\u5c3e\u6807\u8bb0 &lt;/w&gt; \u4ee5\u533a\u5206\u8bcd\u4e2d\u548c\u8bcd\u5c3e\u7684\u76f8\u540c\u5b57\u7b26\n            word_freqs[' '.join(list(word)) + ' &lt;/w&gt;'] += 1\n\n    merges = {}\n    vocab = set()\n\n    # \u521d\u59cb\u8bcd\u8868\u4e3a\u6240\u6709\u5b57\u7b26\n    for word in word_freqs:\n        for char in word.split():\n            vocab.add(char)\n\n    while len(vocab) &lt; vocab_size:\n        # \u7edf\u8ba1\u76f8\u90bb token \u5bf9\u9891\u7387\n        pair_freqs = defaultdict(int)\n        for word, freq in word_freqs.items():\n            tokens = word.split()\n            for i in range(len(tokens) - 1):\n                pair = (tokens[i], tokens[i + 1])\n                pair_freqs[pair] += freq\n\n        if not pair_freqs:\n            break\n\n        # \u627e\u5230\u9891\u7387\u6700\u9ad8\u7684 pair\n        best_pair = max(pair_freqs, key=pair_freqs.get)\n\n        # \u5408\u5e76\u8fd9\u4e2a pair\n        new_token = best_pair[0] + best_pair[1]\n        merges[best_pair] = new_token\n        vocab.add(new_token)\n\n        # \u66f4\u65b0\u8bcd\u9891\u8868\n        new_word_freqs = {}\n        for word, freq in word_freqs.items():\n            new_word = word.replace(\n                best_pair[0] + ' ' + best_pair[1], \n                new_token\n            )\n            new_word_freqs[new_word] = freq\n        word_freqs = new_word_freqs\n\n    return merges\n\ndef apply_bpe(text: str, merges: dict) -&gt; list:\n    \"\"\"\u5e94\u7528 BPE \u5206\u8bcd\"\"\"\n    tokens = list(text) + ['&lt;/w&gt;']\n\n    while True:\n        # \u627e\u5230\u53ef\u4ee5\u5408\u5e76\u7684 pair\n        pairs = [(tokens[i], tokens[i+1]) for i in range(len(tokens)-1)]\n        merge_pair = None\n        for pair in pairs:\n            if pair in merges:\n                merge_pair = pair\n                break\n\n        if merge_pair is None:\n            break\n\n        # \u6267\u884c\u5408\u5e76\n        new_tokens = []\n        i = 0\n        while i &lt; len(tokens):\n            if i &lt; len(tokens) - 1 and (tokens[i], tokens[i+1]) == merge_pair:\n                new_tokens.append(merges[merge_pair])\n                i += 2\n            else:\n                new_tokens.append(tokens[i])\n                i += 1\n        tokens = new_tokens\n\n    return tokens\n</code></pre> <p>BPE \u7684\u4e00\u4e2a\u91cd\u8981\u53d8\u4f53\u662f Byte-level BPE\uff0c\u7531 GPT-2 \u5f15\u5165\u3002\u4f20\u7edf BPE \u5728\u5b57\u7b26\u7ea7\u522b\u64cd\u4f5c\uff0c\u9700\u8981\u5904\u7406 Unicode \u7f16\u7801\u95ee\u9898\u3002Byte-level BPE \u76f4\u63a5\u5728\u5b57\u8282\u7ea7\u522b\u64cd\u4f5c\uff0c\u5c06\u6bcf\u4e2a\u5b57\u8282\u6620\u5c04\u5230\u4e00\u4e2a\u53ef\u6253\u5370\u5b57\u7b26\uff0c\u4ece\u800c\u907f\u514d\u4e86\u7f16\u7801\u95ee\u9898\uff0c\u4e14\u5929\u7136\u652f\u6301\u4efb\u4f55\u8bed\u8a00\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48 GPT \u7cfb\u5217\u6a21\u578b\u53ef\u4ee5\u5904\u7406\u4efb\u610f\u8bed\u8a00\u6587\u672c\u7684\u539f\u56e0\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_13-wordpiecebert","title":"5_1.3 WordPiece\uff1aBERT \u7684\u9009\u62e9","text":"<p>WordPiece \u662f Google \u4e3a BERT \u5f00\u53d1\u7684\u5206\u8bcd\u7b97\u6cd5\uff0c\u4e0e BPE \u975e\u5e38\u76f8\u4f3c\uff0c\u4e3b\u8981\u533a\u522b\u5728\u4e8e\u9009\u62e9\u5408\u5e76\u5bf9\u7684\u6807\u51c6\u3002</p> <p>BPE \u9009\u62e9\u51fa\u73b0\u9891\u7387\u6700\u9ad8\u7684 pair \u8fdb\u884c\u5408\u5e76\u3002WordPiece \u5219\u9009\u62e9\u80fd\u591f\u6700\u5927\u5316\u8bad\u7ec3\u6570\u636e\u4f3c\u7136\u7684 pair\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5bf9\u4e8e\u5019\u9009 pair (A, B)\uff0cWordPiece \u8ba1\u7b97\u5408\u5e76\u540e\u8bcd\u8868\u5bf9\u8bad\u7ec3\u6570\u636e\u7684\u8bed\u8a00\u6a21\u578b\u6982\u7387\u589e\u76ca\uff0c\u9009\u62e9\u589e\u76ca\u6700\u5927\u7684 pair \u8fdb\u884c\u5408\u5e76\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u8fd9\u610f\u5473\u7740 WordPiece \u503e\u5411\u4e8e\u5408\u5e76\u90a3\u4e9b\"\u5728\u4e00\u8d77\u51fa\u73b0\u7684\u6982\u7387\u8fdc\u9ad8\u4e8e\u72ec\u7acb\u51fa\u73b0\u6982\u7387\u4e4b\u79ef\"\u7684 pair\u3002\u8fd9\u4e2a\u6807\u51c6\u4f7f\u5f97 WordPiece \u5bf9\u4e8e\u4f4e\u9891\u4f46\u6709\u610f\u4e49\u7684\u6a21\u5f0f\u66f4\u52a0\u654f\u611f\u3002</p> <p>WordPiece \u7684\u53e6\u4e00\u4e2a\u7279\u70b9\u662f\u4f7f\u7528 <code>##</code> \u524d\u7f00\u6765\u6807\u8bc6\u975e\u8bcd\u9996\u7684\u5b50\u8bcd\u3002\u4f8b\u5982\uff0c\"playing\" \u53ef\u80fd\u88ab\u5206\u8bcd\u4e3a [\"play\", \"##ing\"]\u3002\u8fd9\u79cd\u8868\u793a\u65b9\u5f0f\u660e\u786e\u533a\u5206\u4e86\u5b50\u8bcd\u5728\u539f\u8bcd\u4e2d\u7684\u4f4d\u7f6e\uff0c\u6709\u52a9\u4e8e\u6a21\u578b\u7406\u89e3\u8bcd\u6c47\u7ed3\u6784\u3002</p> <pre><code># WordPiece \u5206\u8bcd\u793a\u4f8b\uff08\u4f7f\u7528 HuggingFace tokenizers\uff09\nfrom tokenizers import Tokenizer\nfrom tokenizers.models import WordPiece\nfrom tokenizers.trainers import WordPieceTrainer\nfrom tokenizers.pre_tokenizers import Whitespace\n\n# \u521d\u59cb\u5316 WordPiece \u5206\u8bcd\u5668\ntokenizer = Tokenizer(WordPiece(unk_token=\"[UNK]\"))\ntokenizer.pre_tokenizer = Whitespace()\n\n# \u8bad\u7ec3\ntrainer = WordPieceTrainer(\n    vocab_size=30000,\n    special_tokens=[\"[UNK]\", \"[CLS]\", \"[SEP]\", \"[PAD]\", \"[MASK]\"]\n)\ntokenizer.train(files=[\"corpus.txt\"], trainer=trainer)\n\n# \u4f7f\u7528\noutput = tokenizer.encode(\"unhappiness\")\nprint(output.tokens)  # ['un', '##happi', '##ness']\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_14-unigram","title":"5_1.4 Unigram\uff1a\u6982\u7387\u89c6\u89d2\u7684\u5206\u8bcd","text":"<p>Unigram \u5206\u8bcd\u7531 Kudo \u5728 2018 \u5e74\u63d0\u51fa\uff0c\u91c7\u7528\u4e86\u4e0e BPE/WordPiece \u5b8c\u5168\u4e0d\u540c\u7684\u601d\u8def\u3002BPE \u548c WordPiece \u90fd\u662f\u81ea\u5e95\u5411\u4e0a\u7684\u65b9\u6cd5\u2014\u2014\u4ece\u5c0f\u7684\u5355\u5143\u5f00\u59cb\uff0c\u9010\u6b65\u5408\u5e76\u6210\u5927\u7684\u5355\u5143\u3002Unigram \u5219\u662f\u81ea\u9876\u5411\u4e0b\u7684\u65b9\u6cd5\u2014\u2014\u4ece\u4e00\u4e2a\u5305\u542b\u6240\u6709\u53ef\u80fd\u5b50\u8bcd\u7684\u5927\u8bcd\u8868\u5f00\u59cb\uff0c\u9010\u6b65\u5220\u51cf\u5230\u76ee\u6807\u5927\u5c0f\u3002</p> <p>Unigram \u5c06\u5206\u8bcd\u5efa\u6a21\u4e3a\u4e00\u4e2a\u6982\u7387\u95ee\u9898\u3002\u7ed9\u5b9a\u8bcd\u8868 V \u548c\u6bcf\u4e2a token \u7684\u6982\u7387 P(t)\uff0c\u4e00\u4e2a\u6587\u672c\u7684\u5206\u8bcd\u7ed3\u679c\u662f\u4f7f\u5f97\u603b\u6982\u7387\u6700\u5927\u5316\u7684\u5207\u5206\u65b9\u5f0f\uff1a</p> \\[P(x_1, x_2, ..., x_n) = \\prod_{i=1}^{n} P(x_i)\\] <p>\u8bad\u7ec3\u8fc7\u7a0b\u4f7f\u7528 EM \u7b97\u6cd5\uff1aE \u6b65\u9aa4\u8ba1\u7b97\u5f53\u524d\u8bcd\u8868\u4e0b\u6bcf\u4e2a token \u7684\u671f\u671b\u51fa\u73b0\u6b21\u6570\uff0cM \u6b65\u9aa4\u66f4\u65b0 token \u6982\u7387\u3002\u7136\u540e\u5220\u9664\u90a3\u4e9b\u5220\u9664\u540e\u5bf9\u603b\u4f3c\u7136\u5f71\u54cd\u6700\u5c0f\u7684 token\uff0c\u76f4\u5230\u8fbe\u5230\u76ee\u6807\u8bcd\u8868\u5927\u5c0f\u3002</p> <p>Unigram \u7684\u4e00\u4e2a\u72ec\u7279\u4f18\u52bf\u662f\u5b83\u5929\u7136\u652f\u6301\u591a\u79cd\u5206\u8bcd\u7ed3\u679c\u7684\u6982\u7387\u5efa\u6a21\u3002\u5bf9\u4e8e\u4e00\u4e2a\u7ed9\u5b9a\u7684\u6587\u672c\uff0c\u53ef\u80fd\u5b58\u5728\u591a\u79cd\u5408\u6cd5\u7684\u5206\u8bcd\u65b9\u5f0f\uff0cUnigram \u53ef\u4ee5\u4e3a\u6bcf\u79cd\u65b9\u5f0f\u8d4b\u4e88\u4e00\u4e2a\u6982\u7387\u3002\u8fd9\u5728\u67d0\u4e9b\u5e94\u7528\u573a\u666f\uff08\u5982\u8bed\u97f3\u8bc6\u522b\u4e2d\u7684\u591a\u5047\u8bbe\u5904\u7406\uff09\u4e2d\u975e\u5e38\u6709\u7528\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_15","title":"5_1.5 \u4e09\u79cd\u7b97\u6cd5\u7684\u5bf9\u6bd4","text":"<p>\u4e09\u79cd\u4e3b\u6d41\u5b50\u8bcd\u5206\u8bcd\u7b97\u6cd5\u5404\u6709\u7279\u70b9\uff0c\u9009\u62e9\u65f6\u9700\u8981\u6839\u636e\u5177\u4f53\u573a\u666f\u6743\u8861\u3002</p> \u7b97\u6cd5 \u6838\u5fc3\u601d\u60f3 \u4f18\u52bf \u52a3\u52bf \u5178\u578b\u5e94\u7528 BPE \u81ea\u5e95\u5411\u4e0a\uff0c\u9891\u7387\u9a71\u52a8\u5408\u5e76 \u7b80\u5355\u76f4\u89c2\uff0c\u8bad\u7ec3\u5feb \u8d2a\u5fc3\u7b56\u7565\u53ef\u80fd\u975e\u6700\u4f18 GPT\u7cfb\u5217\u3001LLaMA WordPiece \u81ea\u5e95\u5411\u4e0a\uff0c\u4f3c\u7136\u9a71\u52a8\u5408\u5e76 \u5bf9\u4f4e\u9891\u6709\u610f\u4e49\u6a21\u5f0f\u654f\u611f \u8ba1\u7b97\u590d\u6742\u5ea6\u8f83\u9ad8 BERT\u3001DistilBERT Unigram \u81ea\u9876\u5411\u4e0b\uff0c\u6982\u7387\u5efa\u6a21 \u7406\u8bba\u4f18\u96c5\uff0c\u652f\u6301\u591a\u5206\u8bcd \u8bad\u7ec3\u8f83\u6162 T5\u3001mT5\u3001ALBERT <p></p> <p>\u56fe5-2\uff1aBPE\u3001WordPiece\u3001Unigram \u4e09\u79cd\u5206\u8bcd\u7b97\u6cd5\u7684\u5bf9\u6bd4</p> <p>\u5728\u5b9e\u9645\u5de5\u7a0b\u4e2d\uff0cSentencePiece \u662f\u6700\u5e38\u7528\u7684\u5206\u8bcd\u5de5\u5177\u5305\u3002\u5b83\u652f\u6301 BPE \u548c Unigram \u4e24\u79cd\u7b97\u6cd5\uff0c\u63d0\u4f9b\u4e86\u8bed\u8a00\u65e0\u5173\u7684\u9884\u5904\u7406\uff08\u4e0d\u4f9d\u8d56\u7a7a\u683c\u5206\u8bcd\uff09\uff0c\u5e76\u4e14\u4e0e\u4e3b\u6d41\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\u65e0\u7f1d\u96c6\u6210\u3002</p> <pre><code>import sentencepiece as spm\n\n# \u8bad\u7ec3 SentencePiece \u6a21\u578b\nspm.SentencePieceTrainer.train(\n    input='corpus.txt',\n    model_prefix='my_tokenizer',\n    vocab_size=32000,\n    model_type='bpe',  # \u6216 'unigram'\n    character_coverage=0_9995,\n    num_threads=16\n)\n\n# \u52a0\u8f7d\u548c\u4f7f\u7528\nsp = spm.SentencePieceProcessor(model_file='my_tokenizer.model')\ntokens = sp.encode('Hello, world!', out_type=str)\nprint(tokens)  # ['\u2581Hello', ',', '\u2581world', '!']\nids = sp.encode('Hello, world!')\nprint(ids)  # [1234, 56, 789, 10]\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_2","title":"5_2 \u8bcd\u8868\u8bbe\u8ba1\u4e0e\u6269\u5145","text":"<p>\u8bcd\u8868\uff08Vocabulary\uff09\u662f\u5206\u8bcd\u5668\u7684\u6838\u5fc3\u7ec4\u6210\u90e8\u5206\u3002\u8bcd\u8868\u7684\u5927\u5c0f\u3001\u8986\u76d6\u8303\u56f4\u548c\u7ed3\u6784\u76f4\u63a5\u5f71\u54cd\u6a21\u578b\u7684\u6027\u80fd\u548c\u6548\u7387\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_21","title":"5_2.1 \u8bcd\u8868\u5927\u5c0f\u7684\u6743\u8861","text":"<p>\u8bcd\u8868\u5927\u5c0f\u662f\u5206\u8bcd\u5668\u8bbe\u8ba1\u4e2d\u6700\u91cd\u8981\u7684\u8d85\u53c2\u6570\u4e4b\u4e00\u3002\u8f83\u5927\u7684\u8bcd\u8868\u610f\u5473\u7740\u66f4\u591a\u7684 token \u88ab\u4fdd\u7559\u4e3a\u5b8c\u6574\u5355\u5143\uff0c\u5e8f\u5217\u957f\u5ea6\u66f4\u77ed\uff0c\u4f46\u5d4c\u5165\u77e9\u9635\u66f4\u5927\uff0c\u53c2\u6570\u66f4\u591a\uff1b\u8f83\u5c0f\u7684\u8bcd\u8868\u610f\u5473\u7740\u66f4\u591a\u7684\u8bcd\u88ab\u62c6\u5206\u4e3a\u5b50\u8bcd\uff0c\u5e8f\u5217\u957f\u5ea6\u66f4\u957f\uff0c\u4f46\u6a21\u578b\u53c2\u6570\u66f4\u5c11\u3002</p> <p>\u4e3b\u6d41\u5927\u6a21\u578b\u7684\u8bcd\u8868\u5927\u5c0f\u901a\u5e38\u5728 32K \u5230 128K \u4e4b\u95f4\u3002GPT-2 \u4f7f\u7528 50,257 \u7684\u8bcd\u8868\uff0cLLaMA \u4f7f\u7528 32,000\uff0cGPT-4 \u636e\u62a5\u9053\u4f7f\u7528\u7ea6 100,000\u3002\u9009\u62e9\u8bcd\u8868\u5927\u5c0f\u65f6\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u56e0\u7d20\uff1a</p> <p>\u8ba1\u7b97\u6548\u7387\uff1a\u8bcd\u8868\u8d8a\u5927\uff0c\u5d4c\u5165\u5c42\u548c\u8f93\u51fa\u5c42\u7684\u53c2\u6570\u8d8a\u591a\u3002\u5bf9\u4e8e\u4e00\u4e2a d \u7ef4\u7684\u6a21\u578b\uff0c\u8bcd\u8868\u5927\u5c0f\u4e3a V \u65f6\uff0c\u5d4c\u5165\u77e9\u9635\u5305\u542b V \u00d7 d \u4e2a\u53c2\u6570\u3002\u5f53 V \u4ece 32K \u589e\u52a0\u5230 128K \u65f6\uff0c\u8fd9\u90e8\u5206\u53c2\u6570\u91cf\u589e\u52a0 4 \u500d\u3002</p> <p>\u5e8f\u5217\u957f\u5ea6\uff1a\u8bcd\u8868\u8d8a\u5927\uff0c\u5e73\u5747\u6bcf\u4e2a token \u8986\u76d6\u7684\u5b57\u7b26\u8d8a\u591a\uff0c\u540c\u6837\u7684\u6587\u672c\u88ab\u5206\u6210\u7684 token \u6570\u8d8a\u5c11\u3002\u8fd9\u5bf9\u4e8e\u5904\u7406\u957f\u6587\u6863\u5c24\u4e3a\u91cd\u8981\uff0c\u56e0\u4e3a Transformer \u7684\u8ba1\u7b97\u590d\u6742\u5ea6\u4e0e\u5e8f\u5217\u957f\u5ea6\u7684\u5e73\u65b9\u6210\u6b63\u6bd4\u3002</p> <p>\u7a00\u6709\u8bcd\u5904\u7406\uff1a\u8bcd\u8868\u8d8a\u5927\uff0c\u8d8a\u591a\u7684\u7a00\u6709\u8bcd\u53ef\u4ee5\u88ab\u4fdd\u7559\u4e3a\u5b8c\u6574 token\uff0c\u51cf\u5c11\u4e86 UNK \u548c\u8fc7\u5ea6\u5207\u5206\u7684\u95ee\u9898\u3002\u4f46\u8fd9\u4e5f\u610f\u5473\u7740\u7a00\u6709 token \u5728\u8bad\u7ec3\u4e2d\u89c1\u5230\u7684\u6837\u672c\u66f4\u5c11\uff0c\u53ef\u80fd\u5bfc\u81f4\u5d4c\u5165\u8d28\u91cf\u4e0d\u4f73\u3002</p> <pre><code># \u5206\u6790\u4e0d\u540c\u8bcd\u8868\u5927\u5c0f\u5bf9\u5e8f\u5217\u957f\u5ea6\u7684\u5f71\u54cd\ndef analyze_vocab_size_impact(text: str, vocab_sizes: list) -&gt; dict:\n    \"\"\"\u5206\u6790\u8bcd\u8868\u5927\u5c0f\u5bf9\u5206\u8bcd\u7ed3\u679c\u7684\u5f71\u54cd\"\"\"\n    import sentencepiece as spm\n\n    results = {}\n    for vocab_size in vocab_sizes:\n        # \u8bad\u7ec3\u4e0d\u540c\u8bcd\u8868\u5927\u5c0f\u7684\u5206\u8bcd\u5668\n        spm.SentencePieceTrainer.train(\n            input='corpus.txt',\n            model_prefix=f'tokenizer_{vocab_size}',\n            vocab_size=vocab_size,\n            model_type='bpe'\n        )\n\n        sp = spm.SentencePieceProcessor(model_file=f'tokenizer_{vocab_size}.model')\n        tokens = sp.encode(text)\n\n        results[vocab_size] = {\n            'num_tokens': len(tokens),\n            'chars_per_token': len(text) / len(tokens),\n            'compression_ratio': len(text.encode('utf-8')) / (len(tokens) * 2)\n        }\n\n    return results\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_22","title":"5_2.2 \u591a\u8bed\u8a00\u8bcd\u8868\u8bbe\u8ba1","text":"<p>\u8bad\u7ec3\u591a\u8bed\u8a00\u6a21\u578b\u65f6\uff0c\u8bcd\u8868\u8bbe\u8ba1\u9762\u4e34\u989d\u5916\u7684\u6311\u6218\uff1a\u5982\u4f55\u5728\u6709\u9650\u7684\u8bcd\u8868\u7a7a\u95f4\u4e2d\u5e73\u8861\u4e0d\u540c\u8bed\u8a00\u7684\u8986\u76d6\uff1f</p> <p>\u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\"\u8bcd\u8868\u8bc5\u5492\"\uff08Vocabulary Curse\uff09\u3002\u5982\u679c\u76f4\u63a5\u5728\u591a\u8bed\u8a00\u8bed\u6599\u4e0a\u8bad\u7ec3\u5206\u8bcd\u5668\uff0c\u9ad8\u8d44\u6e90\u8bed\u8a00\uff08\u5982\u82f1\u8bed\uff09\u4f1a\u5360\u636e\u5927\u90e8\u5206\u8bcd\u8868\u7a7a\u95f4\uff0c\u4f4e\u8d44\u6e90\u8bed\u8a00\u7684\u8986\u76d6\u4e25\u91cd\u4e0d\u8db3\u3002\u8fd9\u5bfc\u81f4\u4f4e\u8d44\u6e90\u8bed\u8a00\u7684\u6587\u672c\u88ab\u8fc7\u5ea6\u5207\u5206\uff0c\u5e8f\u5217\u957f\u5ea6\u81a8\u80c0\uff0c\u6a21\u578b\u6027\u80fd\u4e0b\u964d\u3002</p> <p>\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u7684\u5e38\u7528\u7b56\u7565\u5305\u62ec\uff1a</p> <p>\u8bed\u6599\u5e73\u8861\uff1a\u5728\u8bad\u7ec3\u5206\u8bcd\u5668\u4e4b\u524d\uff0c\u5bf9\u4e0d\u540c\u8bed\u8a00\u7684\u8bed\u6599\u8fdb\u884c\u4e0a\u91c7\u6837\u6216\u4e0b\u91c7\u6837\uff0c\u4f7f\u6bcf\u79cd\u8bed\u8a00\u7684\u6743\u91cd\u66f4\u52a0\u5747\u8861\u3002</p> <p>\u6e29\u5ea6\u91c7\u6837\uff1a\u7c7b\u4f3c\u4e8e\u6211\u4eec\u5728\u7b2c 3 \u7ae0\u8ba8\u8bba\u7684\u591a\u8bed\u8a00\u6570\u636e\u5e73\u8861\u7b56\u7565\uff0c\u4f7f\u7528\u6e29\u5ea6\u53c2\u6570\u63a7\u5236\u4e0d\u540c\u8bed\u8a00\u7684\u91c7\u6837\u6982\u7387\u3002</p> <p>\u8bed\u8a00\u7279\u5b9a\u7684\u5b57\u7b26\u8986\u76d6\uff1a\u786e\u4fdd\u6bcf\u79cd\u76ee\u6807\u8bed\u8a00\u7684\u57fa\u672c\u5b57\u7b26\u96c6\u90fd\u88ab\u7eb3\u5165\u8bcd\u8868\uff0c\u5373\u4f7f\u5b83\u4eec\u7684\u9891\u7387\u5f88\u4f4e\u3002SentencePiece \u63d0\u4f9b\u4e86 <code>character_coverage</code> \u53c2\u6570\u6765\u63a7\u5236\u8fd9\u4e00\u70b9\u3002</p> <pre><code># \u591a\u8bed\u8a00\u5206\u8bcd\u5668\u8bad\u7ec3\u793a\u4f8b\nimport sentencepiece as spm\n\n# \u4f7f\u7528\u5b57\u7b26\u8986\u76d6\u7387\u786e\u4fdd\u591a\u8bed\u8a00\u652f\u6301\nspm.SentencePieceTrainer.train(\n    input='multilingual_corpus.txt',\n    model_prefix='multilingual_tokenizer',\n    vocab_size=64000,\n    model_type='unigram',\n    character_coverage=0_9999,  # \u9ad8\u8986\u76d6\u7387\u786e\u4fdd\u7a00\u6709\u5b57\u7b26\u88ab\u5305\u542b\n    input_sentence_size=10000000,\n    shuffle_input_sentence=True,\n    # \u7279\u6b8a\u5904\u7406\u4e2d\u65e5\u97e9\u5b57\u7b26\n    byte_fallback=True  # \u672a\u77e5\u5b57\u7b26\u56de\u9000\u5230\u5b57\u8282\u7ea7\u522b\n)\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_23","title":"5_2.3 \u9886\u57df\u7279\u5b9a\u8bcd\u8868\u6269\u5145","text":"<p>\u5728\u5c06\u9884\u8bad\u7ec3\u6a21\u578b\u5e94\u7528\u4e8e\u7279\u5b9a\u9886\u57df\uff08\u5982\u533b\u7597\u3001\u6cd5\u5f8b\u3001\u4ee3\u7801\uff09\u65f6\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u5927\u91cf\u9886\u57df\u672f\u8bed\u88ab\u8fc7\u5ea6\u5207\u5206\u7684\u95ee\u9898\u3002\u8fd9\u4e0d\u4ec5\u589e\u52a0\u4e86\u5e8f\u5217\u957f\u5ea6\uff0c\u8fd8\u53ef\u80fd\u5f71\u54cd\u6a21\u578b\u5bf9\u4e13\u4e1a\u6982\u5ff5\u7684\u7406\u89e3\u3002</p> <p>\u8bcd\u8868\u6269\u5145\uff08Vocabulary Extension\uff09\u662f\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u7684\u6709\u6548\u624b\u6bb5\u3002\u57fa\u672c\u601d\u8def\u662f\uff1a\u5728\u4fdd\u7559\u539f\u6709\u8bcd\u8868\u7684\u57fa\u7840\u4e0a\uff0c\u6dfb\u52a0\u65b0\u7684\u9886\u57df\u7279\u5b9a token\u3002</p> <pre><code>from transformers import AutoTokenizer\n\ndef extend_tokenizer(base_tokenizer_name: str, \n                     domain_terms: list,\n                     output_dir: str) -&gt; None:\n    \"\"\"\n    \u6269\u5145\u9884\u8bad\u7ec3\u5206\u8bcd\u5668\u7684\u8bcd\u8868\n\n    Args:\n        base_tokenizer_name: \u57fa\u7840\u5206\u8bcd\u5668\u540d\u79f0\n        domain_terms: \u9886\u57df\u7279\u5b9a\u672f\u8bed\u5217\u8868\n        output_dir: \u8f93\u51fa\u76ee\u5f55\n    \"\"\"\n    # \u52a0\u8f7d\u57fa\u7840\u5206\u8bcd\u5668\n    tokenizer = AutoTokenizer.from_pretrained(base_tokenizer_name)\n\n    print(f\"\u539f\u59cb\u8bcd\u8868\u5927\u5c0f: {len(tokenizer)}\")\n\n    # \u8fc7\u6ee4\u5df2\u5b58\u5728\u7684 token\n    new_tokens = []\n    for term in domain_terms:\n        if term not in tokenizer.get_vocab():\n            new_tokens.append(term)\n\n    # \u6dfb\u52a0\u65b0 token\n    num_added = tokenizer.add_tokens(new_tokens)\n    print(f\"\u6dfb\u52a0\u4e86 {num_added} \u4e2a\u65b0 token\")\n    print(f\"\u65b0\u8bcd\u8868\u5927\u5c0f: {len(tokenizer)}\")\n\n    # \u4fdd\u5b58\u6269\u5145\u540e\u7684\u5206\u8bcd\u5668\n    tokenizer.save_pretrained(output_dir)\n\n    return tokenizer\n\n# \u793a\u4f8b\uff1a\u4e3a\u533b\u7597\u9886\u57df\u6269\u5145\u8bcd\u8868\nmedical_terms = [\n    '\u51a0\u72b6\u52a8\u8109',\n    '\u5fc3\u808c\u6897\u6b7b',\n    '\u52a8\u8109\u7ca5\u6837\u786c\u5316',\n    'COVID-19',\n    'mRNA\u75ab\u82d7',\n    '\u8ba1\u7b97\u673a\u65ad\u5c42\u626b\u63cf',\n    # ... \u66f4\u591a\u672f\u8bed\n]\n\ntokenizer = extend_tokenizer(\n    'meta-llama/Llama-2-7b',\n    medical_terms,\n    './medical_tokenizer'\n)\n</code></pre> <p>\u8bcd\u8868\u6269\u5145\u540e\uff0c\u9700\u8981\u540c\u6b65\u6269\u5c55\u6a21\u578b\u7684\u5d4c\u5165\u77e9\u9635\u3002\u65b0\u589e token \u7684\u5d4c\u5165\u901a\u5e38\u521d\u59cb\u5316\u4e3a\u968f\u673a\u503c\u6216\u73b0\u6709\u76f8\u5173 token \u7684\u5e73\u5747\u503c\uff0c\u7136\u540e\u901a\u8fc7\u7ee7\u7eed\u9884\u8bad\u7ec3\u6765\u5b66\u4e60\u6709\u610f\u4e49\u7684\u8868\u793a\u3002</p> <pre><code>from transformers import AutoModelForCausalLM\n\ndef resize_model_embeddings(model_name: str, \n                            tokenizer,\n                            output_dir: str) -&gt; None:\n    \"\"\"\u8c03\u6574\u6a21\u578b\u5d4c\u5165\u5c42\u5927\u5c0f\u4ee5\u5339\u914d\u6269\u5145\u540e\u7684\u8bcd\u8868\"\"\"\n    model = AutoModelForCausalLM.from_pretrained(model_name)\n\n    # \u8c03\u6574\u5d4c\u5165\u5c42\u5927\u5c0f\n    model.resize_token_embeddings(len(tokenizer))\n\n    # \u53ef\u9009\uff1a\u4f7f\u7528\u76f8\u4f3c token \u7684\u5747\u503c\u521d\u59cb\u5316\u65b0\u5d4c\u5165\n    # \u8fd9\u6bd4\u968f\u673a\u521d\u59cb\u5316\u901a\u5e38\u80fd\u5e26\u6765\u66f4\u597d\u7684\u6548\u679c\n\n    model.save_pretrained(output_dir)\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_24","title":"5_2.4 \u8bcd\u8868\u8bbe\u8ba1\u7684\u6700\u4f73\u5b9e\u8df5","text":"<p>\u57fa\u4e8e\u4e1a\u754c\u7684\u7ecf\u9a8c\uff0c\u4ee5\u4e0b\u662f\u8bcd\u8868\u8bbe\u8ba1\u7684\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5\uff1a</p> <p>\u4fdd\u7559\u8db3\u591f\u7684\u7279\u6b8a token \u4f4d\u7f6e\uff1a\u9884\u7559\u4e00\u4e9b token ID \u7528\u4e8e\u672a\u6765\u53ef\u80fd\u6dfb\u52a0\u7684\u7279\u6b8a token\uff08\u5982\u65b0\u7684\u63a7\u5236\u7b26\u3001\u9886\u57df\u6807\u8bb0\u7b49\uff09\u3002\u8bb8\u591a\u5206\u8bcd\u5668\u9884\u7559\u4e86 100-1000 \u4e2a\u4f4d\u7f6e\u3002</p> <p>\u786e\u4fdd\u6570\u5b57\u548c\u4ee3\u7801\u7b26\u53f7\u7684\u5408\u7406\u5207\u5206\uff1a\u6570\u5b57\u5728\u5f88\u591a\u4efb\u52a1\u4e2d\u5f88\u91cd\u8981\uff0c\u4f46\u6807\u51c6\u5206\u8bcd\u5668\u5f80\u5f80\u5bf9\u6570\u5b57\u5904\u7406\u4e0d\u4f73\u3002\u8003\u8651\u5c06\u5355\u4e2a\u6570\u5b57\u4f5c\u4e3a\u72ec\u7acb token\uff0c\u6216\u4f7f\u7528\u7279\u6b8a\u7684\u6570\u5b57\u7f16\u7801\u7b56\u7565\u3002</p> <p>\u6d4b\u8bd5\u8fb9\u754c\u60c5\u51b5\uff1a\u5728\u786e\u5b9a\u8bcd\u8868\u4e4b\u524d\uff0c\u6d4b\u8bd5\u5404\u79cd\u8fb9\u754c\u60c5\u51b5\uff1a\u8d85\u957f\u5355\u8bcd\u3001\u7279\u6b8a\u5b57\u7b26\u3001\u6df7\u5408\u8bed\u8a00\u6587\u672c\u3001\u4ee3\u7801\u7247\u6bb5\u7b49\u3002\u786e\u4fdd\u5206\u8bcd\u7ed3\u679c\u7b26\u5408\u9884\u671f\u3002</p> <p>\u6587\u6863\u5316\u8bcd\u8868\u51b3\u7b56\uff1a\u8bb0\u5f55\u8bcd\u8868\u5927\u5c0f\u3001\u8bad\u7ec3\u8bed\u6599\u3001\u7279\u6b8a token \u5217\u8868\u7b49\u4fe1\u606f\uff0c\u4fbf\u4e8e\u540e\u7eed\u7684\u6a21\u578b\u8fed\u4ee3\u548c\u95ee\u9898\u6392\u67e5\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_3","title":"5_3 \u6570\u636e\u6df7\u5408\u4e0e\u8bfe\u7a0b\u5b66\u4e60","text":"<p>\u786e\u5b9a\u4e86\u5206\u8bcd\u5668\u4e4b\u540e\uff0c\u4e0b\u4e00\u4e2a\u5173\u952e\u95ee\u9898\u662f\uff1a\u5982\u4f55\u7ec4\u7ec7\u548c\u5448\u73b0\u8bad\u7ec3\u6570\u636e\uff1f\u4e0d\u540c\u6765\u6e90\u3001\u4e0d\u540c\u8d28\u91cf\u7684\u6570\u636e\u5e94\u8be5\u4ee5\u600e\u6837\u7684\u6bd4\u4f8b\u6df7\u5408\uff1f\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6570\u636e\u7684\u987a\u5e8f\u662f\u5426\u91cd\u8981\uff1f</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_31","title":"5_3.1 \u6570\u636e\u6df7\u5408\u7b56\u7565","text":"<p>\u6b63\u5982\u6211\u4eec\u5728\u7b2c 3 \u7ae0\u8ba8\u8bba\u7684\uff0c\u9ad8\u8d28\u91cf\u7684\u9884\u8bad\u7ec3\u6570\u636e\u96c6\u901a\u5e38\u6df7\u5408\u4e86\u591a\u79cd\u6765\u6e90\uff1a\u7f51\u9875\u3001\u4e66\u7c4d\u3001\u4ee3\u7801\u3001\u8bba\u6587\u3001\u5bf9\u8bdd\u7b49\u3002\u6bcf\u79cd\u6765\u6e90\u7684\u6570\u636e\u91cf\u548c\u8d28\u91cf\u90fd\u4e0d\u540c\uff0c\u7b80\u5355\u5730\u6309\u539f\u59cb\u6bd4\u4f8b\u6df7\u5408\u5f80\u5f80\u4e0d\u662f\u6700\u4f18\u7684\u3002</p> <p>\u9759\u6001\u6df7\u5408\u662f\u6700\u7b80\u5355\u7684\u7b56\u7565\uff1a\u5728\u8bad\u7ec3\u5f00\u59cb\u524d\u786e\u5b9a\u5404\u6765\u6e90\u7684\u6df7\u5408\u6bd4\u4f8b\uff0c\u5c06\u6570\u636e\u6253\u4e71\u540e\u987a\u5e8f\u8bad\u7ec3\u3002\u8fd9\u79cd\u65b9\u6cd5\u7b80\u5355\u6613\u5b9e\u73b0\uff0c\u4f46\u7f3a\u4e4f\u7075\u6d3b\u6027\u3002</p> <pre><code># \u9759\u6001\u6570\u636e\u6df7\u5408\u793a\u4f8b\nimport random\n\ndef static_mix(data_sources: dict, target_size: int) -&gt; list:\n    \"\"\"\n    \u9759\u6001\u6df7\u5408\u591a\u4e2a\u6570\u636e\u6e90\n\n    Args:\n        data_sources: {source_name: (data_list, weight)}\n        target_size: \u76ee\u6807\u6570\u636e\u96c6\u5927\u5c0f\n\n    Returns:\n        \u6df7\u5408\u540e\u7684\u6570\u636e\u5217\u8868\n    \"\"\"\n    mixed_data = []\n\n    # \u8ba1\u7b97\u6bcf\u4e2a\u6765\u6e90\u7684\u91c7\u6837\u6570\u91cf\n    total_weight = sum(w for _, w in data_sources.values())\n\n    for source_name, (data, weight) in data_sources.items():\n        num_samples = int(target_size * weight / total_weight)\n\n        # \u5982\u679c\u6570\u636e\u4e0d\u8db3\uff0c\u91cd\u590d\u91c7\u6837\n        if len(data) &lt; num_samples:\n            sampled = random.choices(data, k=num_samples)\n        else:\n            sampled = random.sample(data, num_samples)\n\n        mixed_data.extend(sampled)\n\n    random.shuffle(mixed_data)\n    return mixed_data\n\n# \u4f7f\u7528\u793a\u4f8b\ndata_sources = {\n    'web': (web_data, 0_6),\n    'books': (book_data, 0_15),\n    'code': (code_data, 0_1),\n    'papers': (paper_data, 0_1),\n    'wikipedia': (wiki_data, 0_05)\n}\n\nmixed = static_mix(data_sources, target_size=1000000)\n</code></pre> <p></p> <p>\u56fe5-3\uff1a\u9759\u6001\u6df7\u5408\u4e0e\u52a8\u6001\u6df7\u5408\u7b56\u7565\u5bf9\u6bd4</p> <p>\u52a8\u6001\u6df7\u5408\u5141\u8bb8\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u8c03\u6574\u6df7\u5408\u6bd4\u4f8b\u3002\u4e00\u4e9b\u7814\u7a76\u8868\u660e\uff0c\u4e0d\u540c\u8bad\u7ec3\u9636\u6bb5\u7684\u6700\u4f18\u6570\u636e\u914d\u6bd4\u53ef\u80fd\u4e0d\u540c\u3002\u4f8b\u5982\uff0c\u8bad\u7ec3\u65e9\u671f\u4f7f\u7528\u66f4\u591a\u6837\u5316\u7684\u6570\u636e\u5e2e\u52a9\u6a21\u578b\u5efa\u7acb\u5e7f\u6cdb\u7684\u8bed\u8a00\u7406\u89e3\uff1b\u8bad\u7ec3\u540e\u671f\u589e\u52a0\u9ad8\u8d28\u91cf\u6570\u636e\u7684\u6bd4\u4f8b\u4ee5\u63d0\u5347\u6a21\u578b\u7684\u7cbe\u7ec6\u80fd\u529b\u3002</p> <pre><code>class DynamicDataMixer:\n    \"\"\"\u52a8\u6001\u6570\u636e\u6df7\u5408\u5668\"\"\"\n\n    def __init__(self, data_sources: dict, schedule: list):\n        \"\"\"\n        \u521d\u59cb\u5316\u52a8\u6001\u6df7\u5408\u5668\n\n        Args:\n            data_sources: \u6570\u636e\u6e90\u5b57\u5178\n            schedule: [(step_threshold, weights_dict), ...]\n                     \u5728\u4e0d\u540c\u8bad\u7ec3\u6b65\u6570\u4f7f\u7528\u4e0d\u540c\u7684\u6df7\u5408\u6743\u91cd\n        \"\"\"\n        self.data_sources = data_sources\n        self.schedule = sorted(schedule, key=lambda x: x[0])\n        self.current_step = 0\n\n    def get_weights(self) -&gt; dict:\n        \"\"\"\u83b7\u53d6\u5f53\u524d\u6b65\u6570\u5bf9\u5e94\u7684\u6743\u91cd\"\"\"\n        for step_threshold, weights in reversed(self.schedule):\n            if self.current_step &gt;= step_threshold:\n                return weights\n        return self.schedule[0][1]\n\n    def sample_batch(self, batch_size: int) -&gt; list:\n        \"\"\"\u91c7\u6837\u4e00\u4e2a batch\"\"\"\n        weights = self.get_weights()\n        batch = []\n\n        for source_name, weight in weights.items():\n            num_samples = int(batch_size * weight)\n            data = self.data_sources[source_name]\n            batch.extend(random.choices(data, k=num_samples))\n\n        random.shuffle(batch)\n        self.current_step += 1\n        return batch[:batch_size]\n\n# \u4f7f\u7528\u793a\u4f8b\uff1a\u8bad\u7ec3\u65e9\u671f\u5f3a\u8c03\u591a\u6837\u6027\uff0c\u540e\u671f\u5f3a\u8c03\u8d28\u91cf\nschedule = [\n    (0, {'web': 0_5, 'books': 0_2, 'code': 0_15, 'papers': 0_1, 'wiki': 0_05}),\n    (100000, {'web': 0_4, 'books': 0_25, 'code': 0_15, 'papers': 0_15, 'wiki': 0_05}),\n    (500000, {'web': 0_3, 'books': 0_3, 'code': 0_2, 'papers': 0_15, 'wiki': 0_05}),\n]\n\nmixer = DynamicDataMixer(data_sources, schedule)\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_32","title":"5_3.2 \u8bfe\u7a0b\u5b66\u4e60","text":"<p>\u8bfe\u7a0b\u5b66\u4e60\uff08Curriculum Learning\uff09\u662f\u4e00\u79cd\u53d7\u4eba\u7c7b\u5b66\u4e60\u8fc7\u7a0b\u542f\u53d1\u7684\u8bad\u7ec3\u7b56\u7565\u3002\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u5148\u8ba9\u6a21\u578b\u5b66\u4e60\"\u7b80\u5355\"\u7684\u6837\u672c\uff0c\u518d\u9010\u6e10\u8fc7\u6e21\u5230\"\u56f0\u96be\"\u7684\u6837\u672c\u3002\u8fd9\u79cd\u7b56\u7565\u5728\u591a\u9879\u7814\u7a76\u4e2d\u88ab\u8bc1\u660e\u53ef\u4ee5\u52a0\u901f\u6536\u655b\u5e76\u63d0\u5347\u6700\u7ec8\u6027\u80fd\u3002</p> <p>\u5728\u9884\u8bad\u7ec3\u573a\u666f\u4e0b\uff0c\"\u7b80\u5355\"\u548c\"\u56f0\u96be\"\u53ef\u4ee5\u6709\u591a\u79cd\u5b9a\u4e49\uff1a</p> <p>\u57fa\u4e8e\u957f\u5ea6\uff1a\u77ed\u6587\u672c\u901a\u5e38\u6bd4\u957f\u6587\u672c\u66f4\u5bb9\u6613\u5b66\u4e60\u3002\u8bfe\u7a0b\u53ef\u4ee5\u4ece\u77ed\u5e8f\u5217\u5f00\u59cb\uff0c\u9010\u6e10\u589e\u52a0\u5e8f\u5217\u957f\u5ea6\u3002</p> <p>\u57fa\u4e8e\u56f0\u60d1\u5ea6\uff1a\u56f0\u60d1\u5ea6\u4f4e\u7684\u6587\u672c\uff08\u8bed\u8a00\u6a21\u578b\u66f4\"\u719f\u6089\"\u7684\u6587\u672c\uff09\u53ef\u4ee5\u89c6\u4e3a\"\u7b80\u5355\"\u6837\u672c\u3002\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u9884\u8bad\u7ec3\u7684\u5c0f\u6a21\u578b\u8bc4\u4f30\u6837\u672c\u96be\u5ea6\uff0c\u7136\u540e\u6309\u96be\u5ea6\u6392\u5e8f\u5448\u73b0\u7ed9\u4e3b\u6a21\u578b\u3002</p> <p>\u57fa\u4e8e\u566a\u58f0\u6c34\u5e73\uff1a\u9ad8\u8d28\u91cf\u3001\u4f4e\u566a\u58f0\u7684\u6587\u672c\u5148\u5448\u73b0\uff0c\u7136\u540e\u9010\u6e10\u5f15\u5165\u8d28\u91cf\u8f83\u4f4e\u4f46\u53ef\u80fd\u5305\u542b\u72ec\u7279\u4fe1\u606f\u7684\u6587\u672c\u3002</p> <pre><code>import numpy as np\n\nclass CurriculumScheduler:\n    \"\"\"\u8bfe\u7a0b\u5b66\u4e60\u8c03\u5ea6\u5668\"\"\"\n\n    def __init__(self, \n                 data: list, \n                 difficulty_scores: list,\n                 total_steps: int,\n                 strategy: str = 'linear'):\n        \"\"\"\n        \u521d\u59cb\u5316\u8bfe\u7a0b\u8c03\u5ea6\u5668\n\n        Args:\n            data: \u6570\u636e\u5217\u8868\n            difficulty_scores: \u6bcf\u4e2a\u6837\u672c\u7684\u96be\u5ea6\u5206\u6570\uff08\u8d8a\u9ad8\u8d8a\u96be\uff09\n            total_steps: \u603b\u8bad\u7ec3\u6b65\u6570\n            strategy: \u8bfe\u7a0b\u7b56\u7565 ('linear', 'sqrt', 'exp')\n        \"\"\"\n        self.data = np.array(data)\n        self.difficulty_scores = np.array(difficulty_scores)\n        self.total_steps = total_steps\n        self.strategy = strategy\n\n        # \u6309\u96be\u5ea6\u6392\u5e8f\n        sorted_indices = np.argsort(self.difficulty_scores)\n        self.sorted_data = self.data[sorted_indices]\n        self.sorted_scores = self.difficulty_scores[sorted_indices]\n\n    def get_curriculum_fraction(self, current_step: int) -&gt; float:\n        \"\"\"\n        \u8ba1\u7b97\u5f53\u524d\u6b65\u6570\u5e94\u8be5\u4f7f\u7528\u7684\u6570\u636e\u6bd4\u4f8b\n\n        \u8fd4\u56de\u503c\u5728 [0, 1] \u4e4b\u95f4\uff0c\u8868\u793a\u4f7f\u7528\u6700\u7b80\u5355\u7684\u591a\u5c11\u6bd4\u4f8b\u7684\u6570\u636e\n        \"\"\"\n        progress = current_step / self.total_steps\n\n        if self.strategy == 'linear':\n            return progress\n        elif self.strategy == 'sqrt':\n            return np.sqrt(progress)\n        elif self.strategy == 'exp':\n            return 1 - np.exp(-3 * progress)\n        else:\n            return progress\n\n    def sample_batch(self, current_step: int, batch_size: int) -&gt; list:\n        \"\"\"\u6839\u636e\u5f53\u524d\u8fdb\u5ea6\u91c7\u6837 batch\"\"\"\n        fraction = self.get_curriculum_fraction(current_step)\n\n        # \u786e\u5b9a\u53ef\u7528\u6570\u636e\u8303\u56f4\n        available_size = max(int(len(self.sorted_data) * fraction), batch_size)\n        available_data = self.sorted_data[:available_size]\n\n        # \u4ece\u53ef\u7528\u8303\u56f4\u5185\u968f\u673a\u91c7\u6837\n        indices = np.random.choice(len(available_data), size=batch_size, replace=True)\n        return available_data[indices].tolist()\n</code></pre> <p></p> <p>\u56fe5-4\uff1a\u8bfe\u7a0b\u5b66\u4e60\u539f\u7406 \u2014\u2014 \u4ece\u7b80\u5355\u6837\u672c\u9010\u6e10\u8fc7\u6e21\u5230\u56f0\u96be\u6837\u672c</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_33","title":"5_3.3 \u6570\u636e\u91c7\u6837\u4e0e\u6279\u6b21\u6784\u5efa","text":"<p>\u5728\u5b9e\u9645\u8bad\u7ec3\u4e2d\uff0c\u6570\u636e\u7684\u7ec4\u7ec7\u65b9\u5f0f\u5bf9\u6548\u7387\u548c\u6548\u679c\u90fd\u6709\u5f71\u54cd\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u91cd\u8981\u7684\u5de5\u7a0b\u8003\u91cf\uff1a</p> <p>Pack \u6253\u5305\u7b56\u7565\uff1a\u4e3a\u4e86\u5145\u5206\u5229\u7528\u8ba1\u7b97\u8d44\u6e90\uff0c\u901a\u5e38\u5c06\u591a\u4e2a\u77ed\u5e8f\u5217\u6253\u5305\u5230\u4e00\u4e2a\u56fa\u5b9a\u957f\u5ea6\u7684\u5e8f\u5217\u4e2d\u3002\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11 padding \u5e26\u6765\u7684\u8ba1\u7b97\u6d6a\u8d39\u3002\u5173\u952e\u95ee\u9898\u662f\u5982\u4f55\u5904\u7406\u6253\u5305\u540e\u7684\u6ce8\u610f\u529b\u63a9\u7801\u2014\u2014\u4e0d\u540c\u6587\u6863\u4e4b\u95f4\u4e0d\u5e94\u8be5\u76f8\u4e92\u6ce8\u610f\u3002</p> <pre><code>def pack_sequences(sequences: list, max_length: int, eos_token_id: int) -&gt; list:\n    \"\"\"\n    \u5c06\u591a\u4e2a\u77ed\u5e8f\u5217\u6253\u5305\u5230\u56fa\u5b9a\u957f\u5ea6\n\n    Args:\n        sequences: token id \u5e8f\u5217\u5217\u8868\n        max_length: \u76ee\u6807\u5e8f\u5217\u957f\u5ea6\n        eos_token_id: \u5e8f\u5217\u7ed3\u675f\u7b26 ID\n\n    Returns:\n        \u6253\u5305\u540e\u7684\u5e8f\u5217\u5217\u8868\uff0c\u6bcf\u4e2a\u957f\u5ea6\u4e3a max_length\n    \"\"\"\n    packed = []\n    current_pack = []\n    current_length = 0\n\n    for seq in sequences:\n        seq_with_eos = seq + [eos_token_id]\n\n        if current_length + len(seq_with_eos) &lt;= max_length:\n            current_pack.extend(seq_with_eos)\n            current_length += len(seq_with_eos)\n        else:\n            # \u5f53\u524d pack \u5df2\u6ee1\uff0c\u5f00\u59cb\u65b0\u7684\n            if current_pack:\n                # padding \u5230 max_length\n                current_pack.extend([eos_token_id] * (max_length - current_length))\n                packed.append(current_pack)\n\n            current_pack = seq_with_eos\n            current_length = len(seq_with_eos)\n\n    # \u5904\u7406\u6700\u540e\u4e00\u4e2a pack\n    if current_pack:\n        current_pack.extend([eos_token_id] * (max_length - current_length))\n        packed.append(current_pack)\n\n    return packed\n</code></pre> <p>\u6587\u6863\u8fb9\u754c\u5904\u7406\uff1a\u5728\u6253\u5305\u5e8f\u5217\u65f6\uff0c\u9700\u8981\u521b\u5efa\u4e00\u4e2a\"\u6587\u6863\u8fb9\u754c\u63a9\u7801\"\uff0c\u786e\u4fdd\u6a21\u578b\u5728\u751f\u6210\u65f6\u4e0d\u4f1a\u8de8\u8d8a\u6587\u6863\u8fb9\u754c\u8fdb\u884c\u6ce8\u610f\u529b\u8ba1\u7b97\u3002</p> <p>\u6570\u636e\u52a0\u8f7d\u6548\u7387\uff1a\u5bf9\u4e8e TB \u7ea7\u6570\u636e\u96c6\uff0c\u6570\u636e\u52a0\u8f7d\u672c\u8eab\u53ef\u80fd\u6210\u4e3a\u74f6\u9888\u3002\u5e38\u7528\u7684\u4f18\u5316\u624b\u6bb5\u5305\u62ec\uff1a\u9884\u5904\u7406\u540e\u4ee5\u4e8c\u8fdb\u5236\u683c\u5f0f\u5b58\u50a8\uff08\u5982 numpy \u7684 memmap\uff09\u3001\u591a\u8fdb\u7a0b\u5e76\u884c\u52a0\u8f7d\u3001\u9884\u53d6\uff08prefetch\uff09\u4e0b\u4e00\u6279\u6570\u636e\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_34","title":"5_3.4 \u5e8f\u5217\u5316\u4e0e\u5b58\u50a8\u683c\u5f0f","text":"<p>\u5b8c\u6210\u5206\u8bcd\u540e\uff0c\u9700\u8981\u5c06 token \u5e8f\u5217\u4ee5\u9ad8\u6548\u7684\u683c\u5f0f\u5b58\u50a8\uff0c\u4ee5\u4fbf\u8bad\u7ec3\u65f6\u5feb\u901f\u8bfb\u53d6\u3002</p> <p>\u5e38\u89c1\u7684\u5b58\u50a8\u683c\u5f0f\u5305\u62ec\uff1a</p> <p>NumPy memmap\uff1a\u5c06 token ID \u5b58\u50a8\u4e3a numpy \u6570\u7ec4\uff0c\u4f7f\u7528\u5185\u5b58\u6620\u5c04\u8bbf\u95ee\u3002\u4f18\u70b9\u662f\u7b80\u5355\u76f4\u63a5\uff0c\u652f\u6301\u968f\u673a\u8bbf\u95ee\uff1b\u7f3a\u70b9\u662f\u4e0d\u652f\u6301\u538b\u7f29\uff0c\u5b58\u50a8\u7a7a\u95f4\u8f83\u5927\u3002</p> <pre><code>import numpy as np\n\ndef save_as_memmap(token_ids: list, output_path: str):\n    \"\"\"\u5c06 token ID \u5217\u8868\u4fdd\u5b58\u4e3a memmap \u683c\u5f0f\"\"\"\n    arr = np.array(token_ids, dtype=np.uint16)  # \u5047\u8bbe\u8bcd\u8868 &lt; 65536\n    fp = np.memmap(output_path, dtype='uint16', mode='w+', shape=arr.shape)\n    fp[:] = arr[:]\n    fp.flush()\n\ndef load_memmap(path: str, shape: tuple):\n    \"\"\"\u52a0\u8f7d memmap \u683c\u5f0f\u7684 token ID\"\"\"\n    return np.memmap(path, dtype='uint16', mode='r', shape=shape)\n</code></pre> <p>Arrow/Parquet\uff1a\u4f7f\u7528 Apache Arrow \u683c\u5f0f\u5b58\u50a8\uff0c\u652f\u6301\u538b\u7f29\u548c\u9ad8\u6548\u7684\u5217\u5f0f\u8bbf\u95ee\u3002HuggingFace Datasets \u5e93\u5185\u90e8\u4f7f\u7528\u8fd9\u79cd\u683c\u5f0f\u3002</p> <p>\u81ea\u5b9a\u4e49\u4e8c\u8fdb\u5236\u683c\u5f0f\uff1a\u4e00\u4e9b\u5927\u578b\u9879\u76ee\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u9488\u5bf9\u7279\u5b9a\u7684\u8bbf\u95ee\u6a21\u5f0f\u4f18\u5316\u3002\u4f8b\u5982 GPT-NeoX \u4f7f\u7528\u7684\u4e8c\u8fdb\u5236\u6253\u5305\u683c\u5f0f\u3002</p> <pre><code># \u4f7f\u7528 HuggingFace Datasets \u5904\u7406\u5206\u8bcd\u540e\u7684\u6570\u636e\nfrom datasets import Dataset\n\ndef tokenize_and_save(raw_data: list, tokenizer, output_dir: str):\n    \"\"\"\u5206\u8bcd\u5e76\u4fdd\u5b58\u4e3a Datasets \u683c\u5f0f\"\"\"\n\n    def tokenize_function(examples):\n        return tokenizer(\n            examples['text'],\n            truncation=True,\n            max_length=2048,\n            return_attention_mask=False\n        )\n\n    # \u521b\u5efa Dataset\n    ds = Dataset.from_dict({'text': raw_data})\n\n    # \u5206\u8bcd\n    tokenized_ds = ds.map(\n        tokenize_function,\n        batched=True,\n        num_proc=16,\n        remove_columns=['text']\n    )\n\n    # \u4fdd\u5b58\n    tokenized_ds.save_to_disk(output_dir)\n</code></pre>"},{"location":"chapter2/2_3_tokenization_serialization/#5_4","title":"5_4 \u5b8c\u6574\u7684\u6570\u636e\u51c6\u5907\u6d41\u6c34\u7ebf","text":"<p>\u5c06\u524d\u9762\u8ba8\u8bba\u7684\u5404\u4e2a\u6b65\u9aa4\u4e32\u8054\u8d77\u6765\uff0c\u6784\u5efa\u4e00\u4e2a\u4ece\u539f\u59cb\u6587\u672c\u5230\u8bad\u7ec3\u5c31\u7eea\u6570\u636e\u7684\u5b8c\u6574\u6d41\u6c34\u7ebf\u3002</p> <pre><code>from dataclasses import dataclass\nfrom typing import Optional\nimport sentencepiece as spm\n\n@dataclass\nclass DataPrepConfig:\n    \"\"\"\u6570\u636e\u51c6\u5907\u914d\u7f6e\"\"\"\n    # \u5206\u8bcd\u5668\u914d\u7f6e\n    tokenizer_path: str\n    max_seq_length: int = 2048\n\n    # \u6570\u636e\u6df7\u5408\u914d\u7f6e\n    mix_weights: dict = None  # {source: weight}\n\n    # \u8bfe\u7a0b\u5b66\u4e60\u914d\u7f6e\n    use_curriculum: bool = False\n    curriculum_strategy: str = 'linear'\n\n    # \u8f93\u51fa\u914d\u7f6e\n    pack_sequences: bool = True\n    output_format: str = 'arrow'  # 'arrow', 'memmap', 'jsonl'\n\nclass DataPreparationPipeline:\n    \"\"\"\u6570\u636e\u51c6\u5907\u6d41\u6c34\u7ebf\"\"\"\n\n    def __init__(self, config: DataPrepConfig):\n        self.config = config\n        self.tokenizer = spm.SentencePieceProcessor(model_file=config.tokenizer_path)\n\n    def tokenize_document(self, text: str) -&gt; list:\n        \"\"\"\u5206\u8bcd\u5355\u4e2a\u6587\u6863\"\"\"\n        return self.tokenizer.encode(text)\n\n    def process_source(self, source_path: str, source_name: str) -&gt; list:\n        \"\"\"\u5904\u7406\u5355\u4e2a\u6570\u636e\u6e90\"\"\"\n        documents = self.load_documents(source_path)\n\n        tokenized = []\n        for doc in documents:\n            tokens = self.tokenize_document(doc['text'])\n            if len(tokens) &gt; 10:  # \u8fc7\u6ee4\u8fc7\u77ed\u7684\u6587\u6863\n                tokenized.append({\n                    'input_ids': tokens,\n                    'source': source_name,\n                    'length': len(tokens)\n                })\n\n        return tokenized\n\n    def mix_sources(self, sources: dict) -&gt; list:\n        \"\"\"\u6df7\u5408\u591a\u4e2a\u6570\u636e\u6e90\"\"\"\n        mixed = []\n        weights = self.config.mix_weights or {s: 1_0 for s in sources}\n        total_weight = sum(weights.values())\n\n        # \u786e\u5b9a\u6bcf\u4e2a\u6765\u6e90\u7684\u91c7\u6837\u6570\n        total_samples = sum(len(data) for data in sources.values())\n\n        for source_name, data in sources.items():\n            weight = weights.get(source_name, 1_0) / total_weight\n            num_samples = int(total_samples * weight)\n\n            if len(data) &gt;= num_samples:\n                sampled = random.sample(data, num_samples)\n            else:\n                sampled = random.choices(data, k=num_samples)\n\n            mixed.extend(sampled)\n\n        random.shuffle(mixed)\n        return mixed\n\n    def pack_and_save(self, data: list, output_path: str):\n        \"\"\"\u6253\u5305\u5e76\u4fdd\u5b58\u6570\u636e\"\"\"\n        if self.config.pack_sequences:\n            sequences = [d['input_ids'] for d in data]\n            packed = pack_sequences(\n                sequences, \n                self.config.max_seq_length,\n                self.tokenizer.eos_id()\n            )\n        else:\n            packed = [d['input_ids'] for d in data]\n\n        # \u6839\u636e\u914d\u7f6e\u9009\u62e9\u8f93\u51fa\u683c\u5f0f\n        if self.config.output_format == 'arrow':\n            self.save_as_arrow(packed, output_path)\n        elif self.config.output_format == 'memmap':\n            self.save_as_memmap(packed, output_path)\n        else:\n            self.save_as_jsonl(packed, output_path)\n\n    def run(self, source_paths: dict, output_path: str):\n        \"\"\"\u8fd0\u884c\u5b8c\u6574\u6d41\u6c34\u7ebf\"\"\"\n        # 1. \u5904\u7406\u5404\u6570\u636e\u6e90\n        sources = {}\n        for source_name, path in source_paths.items():\n            print(f\"Processing {source_name}...\")\n            sources[source_name] = self.process_source(path, source_name)\n\n        # 2. \u6df7\u5408\u6570\u636e\n        print(\"Mixing data sources...\")\n        mixed = self.mix_sources(sources)\n\n        # 3. \u53ef\u9009\uff1a\u5e94\u7528\u8bfe\u7a0b\u5b66\u4e60\u6392\u5e8f\n        if self.config.use_curriculum:\n            print(\"Applying curriculum ordering...\")\n            mixed = self.apply_curriculum(mixed)\n\n        # 4. \u6253\u5305\u5e76\u4fdd\u5b58\n        print(\"Packing and saving...\")\n        self.pack_and_save(mixed, output_path)\n\n        print(f\"Done! Saved {len(mixed)} samples to {output_path}\")\n</code></pre> <p></p> <p>\u56fe5-5\uff1a\u4ece\u539f\u59cb\u6587\u672c\u5230\u8bad\u7ec3\u5c31\u7eea\u6570\u636e\u7684\u5b8c\u6574\u6d41\u6c34\u7ebf</p>"},{"location":"chapter2/2_3_tokenization_serialization/#5_5","title":"5_5 \u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u7cfb\u7edf\u4ecb\u7ecd\u4e86\u5206\u8bcd\u4e0e\u6570\u636e\u5e8f\u5217\u5316\u7684\u6838\u5fc3\u6280\u672f\u3002</p> <p>\u5728\u5206\u8bcd\u5668\u539f\u7406\u65b9\u9762\uff0c\u5b50\u8bcd\u5206\u8bcd\u662f\u5f53\u524d\u5927\u6a21\u578b\u7684\u4e3b\u6d41\u9009\u62e9\uff0c\u5728\u8bcd\u8868\u5927\u5c0f\u548c\u5e8f\u5217\u957f\u5ea6\u4e4b\u95f4\u53d6\u5f97\u4e86\u826f\u597d\u5e73\u8861\u3002BPE \u91c7\u7528\u9891\u7387\u9a71\u52a8\u7684\u81ea\u5e95\u5411\u4e0a\u5408\u5e76\u7b56\u7565\uff0c\u7b80\u5355\u9ad8\u6548\uff1bWordPiece \u4f7f\u7528\u4f3c\u7136\u9a71\u52a8\u7684\u5408\u5e76\u6807\u51c6\uff0c\u5bf9\u4f4e\u9891\u6709\u610f\u4e49\u6a21\u5f0f\u66f4\u654f\u611f\uff1bUnigram \u91c7\u7528\u81ea\u9876\u5411\u4e0b\u7684\u6982\u7387\u5efa\u6a21\u65b9\u6cd5\uff0c\u7406\u8bba\u4e0a\u66f4\u4f18\u96c5\u3002SentencePiece \u662f\u6700\u5e38\u7528\u7684\u5de5\u5177\u5305\uff0c\u652f\u6301\u591a\u79cd\u7b97\u6cd5\u548c\u8bed\u8a00\u65e0\u5173\u7684\u5904\u7406\u3002</p> <p>\u5728\u8bcd\u8868\u8bbe\u8ba1\u65b9\u9762\uff0c\u8bcd\u8868\u5927\u5c0f\u9700\u8981\u5728\u8ba1\u7b97\u6548\u7387\u3001\u5e8f\u5217\u957f\u5ea6\u548c\u7a00\u6709\u8bcd\u5904\u7406\u4e4b\u95f4\u6743\u8861\uff0c\u4e3b\u6d41\u6a21\u578b\u901a\u5e38\u4f7f\u7528 32K-128K \u7684\u8bcd\u8868\u3002\u591a\u8bed\u8a00\u8bcd\u8868\u8bbe\u8ba1\u9700\u8981\u5e73\u8861\u4e0d\u540c\u8bed\u8a00\u7684\u8986\u76d6\uff0c\u907f\u514d\"\u8bcd\u8868\u8bc5\u5492\"\u3002\u9886\u57df\u7279\u5b9a\u8bcd\u8868\u6269\u5145\u53ef\u4ee5\u6539\u5584\u4e13\u4e1a\u672f\u8bed\u7684\u5904\u7406\uff0c\u4f46\u9700\u8981\u914d\u5408\u6a21\u578b\u5d4c\u5165\u5c42\u7684\u6269\u5c55\u3002</p> <p>\u5728\u6570\u636e\u6df7\u5408\u65b9\u9762\uff0c\u9759\u6001\u6df7\u5408\u7b80\u5355\u76f4\u63a5\uff0c\u52a8\u6001\u6df7\u5408\u5141\u8bb8\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u8c03\u6574\u914d\u6bd4\u3002\u8bfe\u7a0b\u5b66\u4e60\u7b56\u7565\u4ece\u7b80\u5355\u6837\u672c\u5f00\u59cb\u3001\u9010\u6e10\u8fc7\u6e21\u5230\u56f0\u96be\u6837\u672c\uff0c\u53ef\u4ee5\u52a0\u901f\u6536\u655b\u5e76\u63d0\u5347\u6027\u80fd\u3002\u6570\u636e\u6253\u5305\u548c\u9ad8\u6548\u7684\u5b58\u50a8\u683c\u5f0f\u5bf9\u4e8e\u5927\u89c4\u6a21\u8bad\u7ec3\u81f3\u5173\u91cd\u8981\u3002</p> <p></p> <p>\u56fe5-6\uff1a\u7b2c5\u7ae0\u77e5\u8bc6\u7ed3\u6784 \u2014\u2014 \u5206\u8bcd\u7b97\u6cd5\u3001\u8bcd\u8868\u8bbe\u8ba1\u3001\u6570\u636e\u7ec4\u7ec7\u4e09\u5927\u4e3b\u9898</p>"},{"location":"chapter2/2_3_tokenization_serialization/#_3","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u5173\u4e8e\u5206\u8bcd\u4e0e\u6570\u636e\u5e8f\u5217\u5316\u7684\u6df1\u5165\u5185\u5bb9\uff0c\u4ee5\u4e0b\u8d44\u6e90\u503c\u5f97\u53c2\u8003\uff1a</p> <p>SentencePiece \u8bba\u6587\uff08Kudo and Richardson, 2018\uff09\u4ecb\u7ecd\u4e86\u8bed\u8a00\u65e0\u5173\u7684\u5b50\u8bcd\u5206\u8bcd\u65b9\u6cd5\u3002BPE \u8bba\u6587\uff08Sennrich et al., 2015\uff09\u662f\u5c06 BPE \u5f15\u5165 NLP \u7684\u5f00\u521b\u6027\u5de5\u4f5c\u3002Unigram \u8bba\u6587\uff08Kudo, 2018\uff09\u63d0\u4f9b\u4e86\u5b50\u8bcd\u5206\u8bcd\u7684\u6982\u7387\u89c6\u89d2\u3002HuggingFace Tokenizers \u5e93\u6587\u6863\uff08huggingface.co/docs/tokenizers\uff09\u662f\u5b9e\u8df5\u5c42\u9762\u7684\u6743\u5a01\u53c2\u8003\u3002\u5173\u4e8e\u8bfe\u7a0b\u5b66\u4e60\uff0cBengio \u7b49\u4eba\u7684\u7efc\u8ff0\u8bba\u6587\u63d0\u4f9b\u4e86\u5168\u9762\u7684\u7406\u8bba\u6846\u67b6\u3002</p>"},{"location":"chapter2/2_3_tokenization_serialization/#_4","title":"\u4e0b\u4e00\u7ae0\u9884\u544a","text":"<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5b8c\u6210\u4e86\u6587\u672c\u9884\u8bad\u7ec3\u6570\u636e\u5de5\u7a0b\u7684\u5168\u90e8\u5185\u5bb9\u3002\u5728\u4e0b\u4e00\u7ae0\u300a\u56fe\u6587\u5bf9\u6570\u636e\u5904\u7406\u300b\u4e2d\uff0c\u6211\u4eec\u5c06\u8fdb\u5165\u591a\u6a21\u6001\u6570\u636e\u5de5\u7a0b\u7684\u9886\u57df\u3002\u4f60\u5c06\u5b66\u4e60\u5982\u4f55\u5904\u7406 LAION-5B \u98ce\u683c\u7684\u56fe\u6587\u914d\u5bf9\u6570\u636e\uff0c\u5982\u4f55\u4f7f\u7528 img2dataset \u8fdb\u884c\u9ad8\u5e76\u53d1\u56fe\u50cf\u4e0b\u8f7d\uff0c\u4ee5\u53ca\u5982\u4f55\u6784\u5efa\u591a\u6a21\u6001\u6570\u636e\u6e05\u6d17\u6d41\u6c34\u7ebf\u3002</p> <p>\u5e26\u7740\u8fd9\u4e2a\u95ee\u9898\u8fdb\u5165\u4e0b\u4e00\u7ae0\uff1a\u4e00\u5f20\u56fe\u7247\u7684\"\u8d28\u91cf\"\u5e94\u8be5\u5982\u4f55\u5b9a\u4e49\uff1f\u9664\u4e86\u5206\u8fa8\u7387\u548c\u6e05\u6670\u5ea6\uff0c\u8fd8\u6709\u54ea\u4e9b\u7ef4\u5ea6\u9700\u8981\u8003\u8651\uff1f</p>"},{"location":"chapter3/3_1/","title":"\u7b2c6\u7ae0\uff1a\u56fe\u6587\u5bf9\u6570\u636e\u5904\u7406","text":""},{"location":"chapter3/3_1/#6-image-text-pairs","title":"\u7b2c6\u7ae0\uff1a\u56fe\u6587\u5bf9\u6570\u636e\u5904\u7406 (Image-Text Pairs)","text":""},{"location":"chapter3/3_1/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5728\u6784\u5efa\u4e0b\u4e00\u4ee3\u57fa\u7840\u6a21\u578b\uff08Foundation Models\uff09\u7684\u5f81\u9014\u4e2d\uff0c\u6570\u636e\u5de5\u7a0b\u7684\u91cd\u5fc3\u5df2\u4ece\u5355\u7eaf\u7684\u6587\u672c\u6e05\u6d17\u8f6c\u5411\u4e86\u5bf9\u7269\u7406\u4e16\u754c\u591a\u7ef4\u4fe1\u53f7\u7684\u6355\u83b7\u3001\u5bf9\u9f50\u4e0e\u91cd\u6784\u3002\u5982\u679c\u8bf4\u8bed\u8a00\u6a21\u578b\u7684\u6570\u636e\u5de5\u7a0b\u662f\u5173\u4e8e\u201c\u53bb\u566a\u201d\uff0c\u90a3\u4e48\u591a\u6a21\u6001\u6570\u636e\u5de5\u7a0b\u5219\u662f\u5173\u4e8e\u201c\u5173\u8054\u201d\u4e0e\u201c\u5bf9\u9f50\u201d\u3002\u968f\u7740 GPT-4V\u3001Gemini \u548c Sora \u7684\u6a2a\u7a7a\u51fa\u4e16\uff0c\u6211\u4eec\u610f\u8bc6\u5230\u5355\u4e00\u6a21\u6001\u7684\u6570\u636e\u5df2\u65e0\u6cd5\u6ee1\u8db3\u6a21\u578b\u5bf9\u4e16\u754c\u8ba4\u77e5\u7684\u6e34\u671b\u3002</p> <p>\u672c\u7ae0\u5c06\u6df1\u5165\u5256\u6790\u6784\u5efa\u4ebf\u7ea7\u591a\u6a21\u6001\u6570\u636e\u96c6\u7684\u5b8c\u6574\u5de5\u7a0b\u94fe\u8def\u3002\u8fd9\u4e0d\u4ec5\u4ec5\u662f\u5199\u51e0\u4e2a\u811a\u672c\u4e0b\u8f7d\u56fe\u7247\u90a3\u4e48\u7b80\u5355\uff0c\u5b83\u662f\u4e00\u573a\u6d89\u53ca\u7f51\u7edc\u534f\u8bae\u3001\u5206\u5e03\u5f0f\u5b58\u50a8\u3001\u5f02\u6784\u8ba1\u7b97\u548c\u7f8e\u5b66\u8bc4\u4f30\u7684\u7efc\u5408\u6218\u5f79\u3002\u6211\u4eec\u5c06\u63a2\u8ba8\u6570\u636e\u8303\u5f0f\u7684\u5e95\u5c42\u903b\u8f91\uff0c\u89e3\u6790\u5982\u4f55\u5229\u7528\u5206\u5e03\u5f0f\u8ba1\u7b97\u6846\u67b6\u89e3\u51b3\u6d77\u91cf\u56fe\u7247\u7684\u9ad8\u5e76\u53d1\u83b7\u53d6\u96be\u9898\uff0c\u5e76\u5229\u7528 GPU \u786c\u4ef6\u52a0\u901f\u6280\u672f\u7a81\u7834\u56fe\u50cf\u9884\u5904\u7406\u7684 I/O \u74f6\u9888\u3002\u6b64\u5916\uff0c\u6211\u4eec\u5c06\u6784\u5efa\u4e00\u5957\u57fa\u4e8e\u8bed\u4e49\u548c\u7f8e\u5b66\u7684\u81ea\u52a8\u5316\u6e05\u6d17\u95ed\u73af\uff0c\u786e\u4fdd\u8f93\u5165\u6a21\u578b\u7684\u6570\u636e\u517c\u5177\u76f8\u5173\u6027\u4e0e\u5b89\u5168\u6027\u3002</p> <p>\u5b66\u4e60\u76ee\u6807 (Learning Objectives)\uff1a * \u6df1\u5ea6\u7406\u89e3 LAION-5B\uff08\u56fe\u6587\u5bf9\uff09\u4e0e OBELICS\uff08\u4ea4\u9519\u6587\u6863\uff09\u8303\u5f0f\u7684\u8bad\u7ec3\u6536\u76ca\u4e0e\u5de5\u7a0b\u6311\u6218\uff0c\u638c\u63e1\u6df7\u5408\u6570\u636e\u7b56\u7565\u7684\u8bbe\u8ba1\u65b9\u6cd5\u3002 * \u80fd\u591f\u7f16\u5199\u57fa\u4e8e PySpark \u548c Ray Data \u7684\u5206\u5e03\u5f0f\u4e0b\u8f7d\u5668\uff0c\u5904\u7406 DNS \u74f6\u9888\u4e0e\u957f\u5c3e\u5ef6\u8fdf\uff0c\u5b9e\u73b0 10,000+ img/s \u7684\u541e\u5410\u91cf\u3002 * \u7cbe\u901a NVIDIA DALI \u7684\u6d41\u6c34\u7ebf\u8bbe\u8ba1\uff0c\u89e3\u51b3 CPU \u89e3\u7801\u74f6\u9888\uff0c\u5229\u7528 GPU Direct \u601d\u60f3\u4f18\u5316\u6570\u636e\u52a0\u8f7d\u3002 * \u6784\u5efa\u5305\u542b CLIP \u8bed\u4e49\u8fc7\u6ee4\u3001\u7f8e\u5b66\u8bc4\u5206\u53ca\u5b89\u5168\u68c0\u6d4b\u7684\u591a\u7ea7\u6e05\u6d17\u6f0f\u6597\uff0c\u5e76\u638c\u63e1\u9488\u5bf9\u4e0d\u540c\u4e1a\u52a1\u573a\u666f\u7684\u9608\u503c\u8c03\u4f18\u7b56\u7565\u3002</p> <p>\u573a\u666f\u5f15\u5165\uff1a</p> <p>\u201c\u8bbe\u60f3\u8fd9\u6837\u4e00\u4e2a\u573a\u666f\uff1a\u6211\u4eec\u7684\u722c\u866b\u56e2\u961f\u521a\u521a\u4ece Common Crawl \u4e2d\u63d0\u53d6\u4e86 20 \u4ebf\u4e2a\u539f\u59cb URL\uff0c\u5b58\u50a8\u5728\u6570\u5343\u4e2a Parquet \u6587\u4ef6\u4e2d\u3002\u4f60\u7684\u4efb\u52a1\u662f\u5728\u4e24\u5468\u5185\u5c06\u8fd9\u4e9b\u6570\u636e\u8f6c\u5316\u4e3a\u53ef\u4f9b GPT-4V \u9884\u8bad\u7ec3\u7684\u9ad8\u8d28\u91cf\u6570\u636e\u96c6\u3002\u5f53\u4f60\u5c1d\u8bd5\u7528\u4f20\u7edf\u7684 Python requests \u5e93\u5355\u673a\u4e0b\u8f7d\u65f6\uff0c\u53d1\u73b0\u9884\u4f30\u8017\u65f6\u7adf\u7136\u9ad8\u8fbe 15 \u5e74\u2014\u2014\u8fd9\u662f\u5178\u578b\u7684\u7f51\u7edc I/O \u963b\u585e\u95ee\u9898\u3002\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u521d\u6b65\u91c7\u6837\u663e\u793a\uff0c\u4e0b\u8f7d\u7684\u56fe\u7247\u4e2d\u6709 30% \u662f\u7535\u5546\u5e7f\u544a\u56fe\uff08\u5145\u6ee1\u566a\u70b9\uff09\uff0c15% \u5e26\u6709\u4e25\u91cd\u7684\u6c34\u5370\uff0c\u751a\u81f3\u8fd8\u6709\u4e25\u91cd\u7684 NSFW \u5185\u5bb9\u3002\u5982\u679c\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u6570\u636e\uff0c\u4e0d\u4ec5\u4f1a\u6d6a\u8d39\u6570\u767e\u4e07\u7f8e\u5143\u7684\u7b97\u529b\uff0c\u8bad\u7ec3\u51fa\u7684\u6a21\u578b\u8fd8\u53ef\u80fd\u56e0\u4e3a\u751f\u6210\u8fdd\u89c4\u5185\u5bb9\u800c\u9762\u4e34\u6cd5\u5f8b\u98ce\u9669\u3002\u6211\u4eec\u9700\u8981\u4e00\u5957\u5de5\u4e1a\u7ea7\u7684\u3001\u9ad8\u541e\u5410\u7684\u3001\u667a\u80fd\u7684\u6570\u636e\u5de5\u7a0b\u65b9\u6848\u6765\u5e94\u5bf9\u8fd9\u4e00\u6311\u6218\u3002\u201d</p>"},{"location":"chapter3/3_1/#6_1-laion-5b-vs-obelicsmmc4","title":"6_1 \u6570\u636e\u8303\u5f0f\uff1a\u56fe\u6587\u5bf9 (LAION-5B) vs \u4ea4\u9519\u6587\u6863 (OBELICS/MMC4)","text":"<p>\u5728\u8bbe\u8ba1\u6570\u636e\u7ba1\u9053\u4e4b\u524d\uff0c\u6211\u4eec\u7684\u9996\u8981\u804c\u8d23\u662f\u660e\u786e\u6570\u636e\u7684\u7ec4\u7ec7\u5f62\u5f0f\u3002\u8fd9\u4e0d\u4ec5\u5173\u4e4e\u5b58\u50a8\u7ed3\u6784\uff0c\u66f4\u76f4\u63a5\u51b3\u5b9a\u4e86\u4e0b\u6e38\u6a21\u578b\u7684\u8bad\u7ec3\u76ee\u6807\uff08Objective\uff09\u548c\u6d8c\u73b0\u80fd\u529b\uff08Emergent Capabilities\uff09\u3002\u4e0d\u540c\u7684\u6570\u636e\u5f62\u6001\uff0c\u672c\u8d28\u4e0a\u662f\u5bf9\u201c\u77e5\u8bc6\u5982\u4f55\u5b58\u5728\u4e8e\u4e16\u754c\u4e2d\u201d\u7684\u4e0d\u540c\u62bd\u8c61\u3002</p>"},{"location":"chapter3/3_1/#6_11","title":"6_1.1 \u6838\u5fc3\u6982\u5ff5\u4e0e\u539f\u7406","text":"<p>\u56fe\u6587\u5bf9 (Image-Text Pairs) \u662f\u591a\u6a21\u6001\u5b66\u4e60\u7684\u57fa\u77f3\uff0c\u4ee5 CLIP\u3001ALIGN \u548c LAION-5B \u4e3a\u4ee3\u8868\u3002 * \u7406\u8bba\u89e3\u6790\uff1a\u8fd9\u79cd\u8303\u5f0f\u5047\u8bbe\u56fe\u50cf \\(I\\) \u548c\u6587\u672c \\(T\\) \u4e4b\u95f4\u5b58\u5728\u5f3a\u8bed\u4e49\u5173\u8054\uff0c\u4e14\u8fd9\u79cd\u5173\u8054\u662f\u72ec\u7acb\u7684\u3001\u539f\u5b50\u7684\u3002\u8bad\u7ec3\u76ee\u6807\u901a\u5e38\u662f\u6700\u5927\u5316 \\(I\\) \u548c \\(T\\) \u5728\u5171\u4eab\u5d4c\u5165\u7a7a\u95f4\u4e2d\u7684\u4f59\u5f26\u76f8\u4f3c\u5ea6\uff08Contrastive Learning\uff09\u3002\u5b83\u7684\u4f18\u52bf\u5728\u4e8e\u6781\u9ad8\u7684\u201c\u4fe1\u566a\u6bd4\u201d\u63d0\u70bc\u6f5c\u529b\uff0c\u901a\u8fc7\u5bf9\u6bd4\u5b66\u4e60\uff0c\u6a21\u578b\u80fd\u5b66\u4f1a\u7269\u4f53\u4e0e\u8bcd\u6c47\u7684\u76f4\u63a5\u6620\u5c04\u3002 * \u5de5\u7a0b\u89c6\u89d2\uff1a\u6570\u636e\u7ed3\u6784\u7b80\u5355\uff0c\u901a\u5e38\u8868\u793a\u4e3a <code>(url, caption, metadata)</code> \u7684\u6241\u5e73\u5316\u8bb0\u5f55\u3002\u8fd9\u79cd\u6570\u636e\u6781\u6613\u4e8e\u5206\u7247\uff08Sharding\uff09\u548c\u968f\u673a\u6253\u6563\uff08Shuffle\uff09\u3002\u5728\u8bad\u7ec3\u65f6\uff0c\u7531\u4e8e\u6837\u672c\u95f4\u76f8\u4e92\u72ec\u7acb\uff0c\u6211\u4eec\u53ef\u4ee5\u8f7b\u6613\u5730\u5b9e\u73b0 Global Batch Shuffling\uff0c\u4ece\u800c\u63d0\u5347\u5bf9\u6bd4\u5b66\u4e60\u7684\u6548\u679c\u3002</p> <p>\u4ea4\u9519\u6587\u6863 (Interleaved Image-Text Documents) \u662f\u65b0\u4e00\u4ee3\u591a\u6a21\u6001\u5927\u6a21\u578b\uff08\u5982 Flamingo, GPT-4V, MM1\uff09\u7684\u5173\u952e\u71c3\u6599\uff0c\u4ee5 OBELICS \u548c MMC4 \u4e3a\u4ee3\u8868\u3002 * \u7406\u8bba\u89e3\u6790\uff1a\u8fd9\u79cd\u8303\u5f0f\u4fdd\u7559\u4e86\u7f51\u9875\u539f\u59cb\u7684 DOM \u7ed3\u6784\u987a\u5e8f\uff0c\u6570\u636e\u5448\u73b0\u4e3a <code>&lt;text&gt;, &lt;image&gt;, &lt;text&gt;...</code> \u7684\u5e8f\u5217\u3002\u8fd9\u8feb\u4f7f\u6a21\u578b\u5b66\u4e60\u201c\u591a\u6a21\u6001\u4e0a\u4e0b\u6587\u4f9d\u8d56\u201d\uff08Multimodal In-Context Learning\uff09\u3002\u4f8b\u5982\uff0c\u5728\u4e00\u4e2a\u201c\u5982\u4f55\u5236\u4f5c\u86cb\u7cd5\u201d\u7684\u7f51\u9875\u4e2d\uff0c\u56fe\u7247 1\uff08\u539f\u6599\u56fe\uff09\u548c\u56fe\u7247 5\uff08\u6210\u54c1\u56fe\uff09\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u4ee5\u53ca\u5b83\u4eec\u4e0e\u5468\u56f4\u6587\u672c\u7684\u903b\u8f91\u8054\u7cfb\uff0c\u662f\u56fe\u6587\u5bf9\u65e0\u6cd5\u63d0\u4f9b\u7684\u3002\u5b83\u6a21\u62df\u4e86\u4eba\u7c7b\u9605\u8bfb\u56fe\u6587\u6df7\u6392\u4e66\u7c4d\u7684\u8ba4\u77e5\u8fc7\u7a0b\u3002 * \u5de5\u7a0b\u89c6\u89d2\uff1a\u6570\u636e\u7ba1\u9053\u6781\u5176\u590d\u6742\u3002\u7531\u4e8e\u5355\u4e2a\u6837\u672c\uff08\u6587\u6863\uff09\u7684\u957f\u5ea6\u4e0d\u56fa\u5b9a\u4e14\u53ef\u80fd\u5305\u542b\u591a\u5f20\u56fe\u7247\uff0cBatch \u7684\u7ec4\u88c5\u53d8\u5f97\u56f0\u96be\u3002\u4f20\u7edf\u7684 Collator \u9700\u8981\u590d\u6742\u7684 Padding \u7b56\u7565\u3002\u6b64\u5916\uff0c\u6e05\u6d17\u65f6\u5fc5\u987b\u5c0f\u5fc3\u7ef4\u62a4\u6587\u6863\u7684\u5b8c\u6574\u6027\uff0c\u968f\u610f\u5220\u9664\u4e00\u5f20\u4f4e\u8d28\u91cf\u56fe\u7247\u53ef\u80fd\u4f1a\u7834\u574f\u4e0a\u4e0b\u6587\u903b\u8f91\uff0c\u5bfc\u81f4\u6a21\u578b\u5b66\u5230\u9519\u8bef\u7684\u6307\u4ee3\u5173\u7cfb\u3002</p>"},{"location":"chapter3/3_1/#6_12","title":"6_1.2 \u67b6\u6784\u51b3\u7b56\uff1a\u9009\u578b\u5bf9\u6bd4\u8868","text":"<p>\u5728\u8d44\u6e90\u6709\u9650\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u4f55\u6743\u8861\u8fd9\u4e24\u79cd\u6570\u636e\uff1f\u8fd9\u5e76\u975e\u4e00\u4e2a\u7b80\u5355\u7684\u4e8c\u5143\u9009\u62e9\uff0c\u800c\u662f\u6d89\u53ca\u5230\u6a21\u578b\u67b6\u6784\u3001\u8bad\u7ec3\u6210\u672c\u548c\u6700\u7ec8\u5e94\u7528\u573a\u666f\u7684\u6df1\u5ea6\u535a\u5f08\u3002</p> <p>\u5728\u65e9\u671f\u7684\u591a\u6a21\u6001\u7814\u7a76\u4e2d\uff08\u5982 2021 \u5e74\u4e4b\u524d\uff09\uff0c\u4e1a\u754c\u666e\u904d\u8ba4\u4e3a\u53ea\u8981\u6570\u636e\u91cf\u591f\u5927\uff08\u5982 CLIP \u7684 4\u4ebf\u5bf9\uff09\uff0c\u6a21\u578b\u5c31\u80fd\u5b66\u4f1a\u4e00\u5207\u3002\u4f46\u968f\u7740 GPT-4V \u7684\u51fa\u73b0\uff0c\u6211\u4eec\u53d1\u73b0\u4ec5\u9760\u56fe\u6587\u5bf9\u8bad\u7ec3\u51fa\u7684\u6a21\u578b\uff0c\u867d\u7136\u80fd\u51c6\u786e\u8bc6\u522b\u201c\u8fd9\u662f\u4e00\u53ea\u732b\u201d\uff0c\u5374\u65e0\u6cd5\u56de\u7b54\u201c\u56fe\u4e2d\u8fd9\u53ea\u732b\u53ef\u80fd\u4f1a\u505a\u4ec0\u4e48\u201d\uff0c\u56e0\u4e3a\u5b83\u7f3a\u4e4f\u903b\u8f91\u63a8\u7406\u7684\u4e0a\u4e0b\u6587\u3002\u53cd\u4e4b\uff0c\u4ea4\u9519\u6587\u6863\u867d\u7136\u5bcc\u542b\u903b\u8f91\uff0c\u4f46\u6570\u636e\u7a00\u758f\uff0c\u5904\u7406\u6210\u672c\u6781\u9ad8\u3002</p> <p>\u4e0b\u8868\u8be6\u7ec6\u5bf9\u6bd4\u4e86\u4e24\u79cd\u8303\u5f0f\u5728\u5de5\u7a0b\u843d\u5730\u5c42\u9762\u7684\u6838\u5fc3\u5dee\u5f02\uff0c\u65e8\u5728\u5e2e\u52a9\u67b6\u6784\u5e08\u6839\u636e\u5b9e\u9645\u9700\u6c42\u8fdb\u884c\u6280\u672f\u9009\u578b\uff1a</p> \u7279\u6027\u7ef4\u5ea6 \u56fe\u6587\u5bf9\u8303\u5f0f (LAION-style) \u4ea4\u9519\u6587\u6863\u8303\u5f0f (OBELICS-style) \u6df1\u5ea6\u89e3\u8bfb\u4e0e\u5efa\u8bae \u8bad\u7ec3\u76ee\u6807 \u5bf9\u6bd4\u5b66\u4e60 (CLIP), \u6587\u751f\u56fe (Stable Diffusion) \u4e0b\u4e00\u4e2aToken\u9884\u6d4b (Next-Token Prediction), \u591a\u6a21\u6001\u5bf9\u8bdd (GPT-4V) \u6df7\u5408\u7b56\u7565\u662f\u738b\u9053\u3002\u7814\u7a76\u8868\u660e\uff0c\u4ec5\u4f7f\u7528\u4ea4\u9519\u6587\u6863\u8bad\u7ec3\u89c6\u89c9\u7f16\u7801\u5668\u6548\u7387\u8f83\u4f4e\uff08\u56e0\u4e3a\u56fe\u7247\u4e0d\u591f\u5bc6\u96c6\uff09\uff0c\u800c\u4ec5\u4f7f\u7528\u56fe\u6587\u5bf9\u5219\u7f3a\u4e4f\u63a8\u7406\u80fd\u529b\u3002\u63a8\u8350\u91c7\u7528 Curriculum Learning\uff08\u8bfe\u7a0b\u5b66\u4e60\uff09\u7b56\u7565\u3002 \u6570\u636e\u6e90\u89e3\u6790 \u7b80\u5355\uff1a\u4ec5\u9700\u63d0\u53d6 <code>&lt;img&gt;</code> \u6807\u7b7e\u53ca\u5176 Alt-text \u590d\u6742\uff1a\u9700\u89e3\u6790 DOM \u6811\uff0c\u8fc7\u6ee4\u5e7f\u544a\u3001\u4fa7\u8fb9\u680f\uff0c\u4fdd\u7559\u6b63\u6587\u903b\u8f91 \u5de5\u7a0b\u590d\u6742\u5ea6\u9884\u8b66\u3002\u6784\u5efa\u4ea4\u9519\u6587\u6863\u9700\u8981\u5904\u7406\u6781\u5176\u590d\u6742\u7684 HTML \u6e32\u67d3\u903b\u8f91\u3002\u5efa\u8bae\u521d\u671f\u5229\u7528 Common Crawl \u7684 WET \u6587\u4ef6\u6784\u5efa\uff0c\u6216\u8005\u76f4\u63a5\u4f7f\u7528 OBELICS \u5f00\u6e90\u96c6\u505a\u589e\u5f3a\uff0c\u4e0d\u8981\u8bd5\u56fe\u4ece\u96f6\u5f00\u59cb\u91cd\u65b0\u6e05\u6d17\u6574\u4e2a\u4e92\u8054\u7f51\u3002 \u5b58\u50a8\u6210\u672c \u4e2d\u7b49\uff1a\u5143\u6570\u636e\u4ec5\u4e3a CSV/Parquet\uff0c\u56fe\u7247\u72ec\u7acb\u5b58\u50a8 \u9ad8\uff1a\u9700\u4fdd\u5b58\u6587\u6863\u62d3\u6251\u7ed3\u6784\uff0c\u5efa\u8bae\u4f7f\u7528 WebDataset \u6216 TFRecord \u5c01\u88c5 I/O \u6027\u80fd\u74f6\u9888\u3002\u5bf9\u4e8e\u4ea4\u9519\u6587\u6863\uff0c\u5fc5\u987b\u4f7f\u7528\u5206\u7247\u5f0f\u5b58\u50a8\uff08Sharding\uff09\uff0c\u907f\u514d\u5c0f\u6587\u4ef6\u788e\u7247\u5316\u3002\u8bfb\u53d6\u65f6\u9700\u9884\u8bfb\u6574\u4e2a\u6587\u6863\uff0c\u8fd9\u5bf9\u5185\u5b58\u5e26\u5bbd\u63d0\u51fa\u4e86\u66f4\u9ad8\u8981\u6c42\u3002 \u6e05\u6d17\u6311\u6218 \u5355\u70b9\u6e05\u6d17\uff1a\u6bcf\u5f20\u56fe\u72ec\u7acb\u5224\u65ad\uff0c\u6613\u4e8e\u5e76\u884c\u5316 \u4e0a\u4e0b\u6587\u6e05\u6d17\uff1a\u9700\u540c\u65f6\u8003\u8651\u6587\u672c\u8fde\u8d2f\u6027\u548c\u56fe\u7247\u8d28\u91cf\uff0c\u6e05\u6d17\u903b\u8f91\u8026\u5408 \u7b56\u7565\u9009\u62e9\u3002\u5728\u5904\u7406\u4ea4\u9519\u6587\u6863\u65f6\uff0c\u82e5\u67d0\u5f20\u56fe\u88ab\u5224\u5b9a\u4e3a NSFW\uff0c\u5efa\u8bae\u7528\u7279\u6b8a\u7684 <code>&lt;BLOCKED_IMAGE&gt;</code> Token \u66ff\u6362\uff0c\u800c\u975e\u76f4\u63a5\u5220\u9664\uff0c\u4ee5\u4fdd\u6301\u4f4d\u7f6e\u7f16\u7801\uff08Positional Embedding\uff09\u7684\u51c6\u786e\u6027\u3002 \u6a21\u578b\u6536\u76ca \u6781\u5f3a\u7684\u89c6\u89c9-\u8bed\u4e49\u5bf9\u9f50\uff0cZero-shot \u5206\u7c7b\u80fd\u529b\u5f3a \u5f3a\u5927\u7684 Few-shot Learning \u80fd\u529b\uff0c\u652f\u6301\u591a\u8f6e\u5bf9\u8bdd\u548c\u903b\u8f91\u63a8\u7406 \u4e1a\u52a1\u5bfc\u5411\u3002\u82e5\u4e1a\u52a1\u573a\u666f\u662f\u201c\u4ee5\u56fe\u641c\u56fe\u201d\uff0c\u56fe\u6587\u5bf9\u8db3\u77e3\uff1b\u82e5\u4e1a\u52a1\u6d89\u53ca\u590d\u6742\u6587\u6863\u7406\u89e3\uff08\u5982\u7814\u62a5\u5206\u6790\u3001\u957f\u7bc7\u6545\u4e8b\u751f\u6210\uff09\uff0c\u5fc5\u987b\u5f15\u5165\u4ea4\u9519\u6587\u6863\u6570\u636e\u3002 <p>tips\uff1a \u5728 MM1 \u548c Idefics2 \u7b49\u524d\u6cbf\u7814\u7a76\u4e2d\uff0c\u6700\u4f73\u5b9e\u8df5\u5e76\u975e\u4e8c\u9009\u4e00\uff0c\u800c\u662f\u914d\u6bd4\u3002\u901a\u5e38\u5efa\u8bae\u5728\u9884\u8bad\u7ec3\uff08Pre-training\uff09\u65e9\u671f\u9636\u6bb5\uff0c\u4f7f\u7528 80% \u7684\u56fe\u6587\u5bf9 \u6765\u5efa\u7acb\u575a\u5b9e\u7684\u89c6\u89c9-\u8bed\u8a00\u6620\u5c04\u57fa\u7840\uff0c\u540c\u65f6\u6df7\u5165 20% \u7684\u4ea4\u9519\u6587\u6863\uff1b\u5728\u9884\u8bad\u7ec3\u540e\u671f\uff08Annealing Phase\uff09\uff0c\u5927\u5e45\u589e\u52a0\u4ea4\u9519\u6587\u6863\u7684\u6bd4\u4f8b\uff0c\u4ee5\u6fc0\u53d1\u6a21\u578b\u7684\u957f\u7a97\u53e3\u63a8\u7406\u80fd\u529b\u3002\u8fd9\u79cd\u201c\u5148\u6253\u57fa\u7840\uff0c\u540e\u7ec3\u903b\u8f91\u201d\u7684\u7b56\u7565\u80fd\u6700\u5927\u5316\u7b97\u529b\u5229\u7528\u7387\u3002</p>"},{"location":"chapter3/3_1/#6_2","title":"6_2 \u56fe\u50cf\u83b7\u53d6\u4e0e\u9884\u5904\u7406","text":"<p>\u4e00\u65e6\u786e\u5b9a\u4e86\u6570\u636e\u6e05\u5355\uff08Manifest\uff09\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u6784\u5efa\u9ad8\u541e\u5410\u7684\u4e0b\u8f7d\u4e0e\u9884\u5904\u7406\u6d41\u6c34\u7ebf\u3002\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684 IO \u5bc6\u96c6\u578b\u4efb\u52a1\uff0c\u4e3b\u8981\u74f6\u9888\u5728\u4e8e\u7f51\u7edc\u5e26\u5bbd\u3001DNS \u89e3\u6790\u5ef6\u8fdf\u4ee5\u53ca\u6d77\u91cf\u5c0f\u6587\u4ef6\u7684\u78c1\u76d8\u5199\u5165\u3002</p>"},{"location":"chapter3/3_1/#6_21-img2dataset","title":"6_2.1 img2dataset \u9ad8\u5e76\u53d1\u4e0b\u8f7d\u5b9e\u6218","text":"<p><code>img2dataset</code> \u662f\u76ee\u524d\u793e\u533a\u516c\u8ba4\u7684\u6700\u4f73\u5b9e\u8df5\u5de5\u5177\u3002\u5b83\u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a\u4e0b\u8f7d\u811a\u672c\uff0c\u66f4\u662f\u4e00\u4e2a\u57fa\u4e8e MapReduce \u601d\u60f3\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5904\u7406\u6846\u67b6\u3002</p> <p>\u6211\u4eec\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528\u4e13\u95e8\u7684\u5de5\u5177\u800c\u4e0d\u662f\u81ea\u5df1\u5199\u4e2a <code>requests.get</code> \u5faa\u73af\uff1f\u56e0\u4e3a\u4e92\u8054\u7f51\u73af\u5883\u662f\u6781\u5176\u6076\u52a3\u7684\u3002\u94fe\u63a5\u4f1a\u5931\u6548\uff08Link Rot\uff09\uff0c\u670d\u52a1\u5668\u4f1a\u9650\u6d41\uff08Rate Limiting\uff09\uff0cDNS \u4f1a\u8d85\u65f6\u3002\u5904\u7406 10 \u4ebf\u7ea7\u522b\u7684 URL\uff0c\u4efb\u4f55\u5fae\u5c0f\u7684\u957f\u5c3e\u5ef6\u8fdf\u90fd\u4f1a\u88ab\u653e\u5927\u6210\u6570\u5468\u7684\u65f6\u95f4\u6210\u672c\u3002</p> <p>\u6838\u5fc3\u539f\u7406\uff1a 1.  \u5206\u7247 (Sharding)\uff1a\u5c06 10 \u4ebf\u6761 URL \u5207\u5206\u4e3a\u6570\u4e07\u4e2a\u5c0f\u4efb\u52a1\uff08Shard\uff09\u3002\u8fd9\u662f\u5206\u5e03\u5f0f\u8ba1\u7b97\u7684\u57fa\u7840\u3002 2.  \u5f02\u6b65 I/O (Async I/O)\uff1a\u5229\u7528 Python \u7684 aiohttp \u6216 Go \u7684\u534f\u7a0b\uff0c\u5728\u5355\u6838\u4e0a\u5e76\u53d1\u53d1\u8d77\u6570\u767e\u4e2a\u7f51\u7edc\u8bf7\u6c42\uff0c\u63a9\u76d6\u7f51\u7edc\u5ef6\u8fdf\u3002 3.  \u6d41\u5f0f\u5f52\u6863 (Streaming Archival)\uff1a\u4e0b\u8f7d\u7684\u56fe\u7247\u4e0d\u843d\u76d8\uff0c\u76f4\u63a5\u5728\u5185\u5b58\u4e2d\u7ec4\u5408\u6210 tar \u5305\uff08WebDataset \u683c\u5f0f\uff09\uff0c\u7136\u540e\u6d41\u5f0f\u5199\u5165\u5bf9\u8c61\u5b58\u50a8\uff08S3/HDFS\uff09\u3002\u8fd9\u907f\u514d\u4e86\u5728\u4e00\u4e2a\u76ee\u5f55\u4e0b\u521b\u5efa\u767e\u4e07\u4e2a\u5c0f\u6587\u4ef6\u5bfc\u81f4\u7684\u6587\u4ef6\u7cfb\u7edf inode \u8017\u5c3d\u95ee\u9898\u2014\u2014\u8fd9\u662f\u65b0\u624b\u6700\u5bb9\u6613\u8e29\u7684\u5751\u3002</p> <p>\u5de5\u7a0b\u5b9e\u73b0\uff1aPySpark \u5206\u5e03\u5f0f\u4e0b\u8f7d\u811a\u672c</p> <p>\u5728\u5904\u7406 PB \u7ea7\u6570\u636e\u65f6\uff0c\u5355\u673a multiprocessing \u6a21\u5f0f\u5df2\u4e0d\u8db3\u4ee5\u5e94\u5bf9\uff0c\u5fc5\u987b\u4f7f\u7528 Spark \u96c6\u7fa4\u3002</p> <pre><code># \u5efa\u8bae\u73af\u5883: PySpark 3_2+, img2dataset 1_41+\n# \u8fd0\u884c\u547d\u4ee4: spark-submit --master yarn --deploy-mode cluster...\n\nfrom img2dataset import download\nimport shutil\nimport os\n\ndef run_distributed_download():\n    \"\"\"\n    \u914d\u7f6e\u9879\u7684\u8c03\u4f18\u662f\u541e\u5410\u91cf\u7684\u5173\u952e\u3002\n    process_count: \u6bcf\u4e2a Spark Executor \u7684\u8fdb\u7a0b\u6570\u3002\n    thread_count: \u6bcf\u4e2a\u8fdb\u7a0b\u5185\u7684\u5f02\u6b65\u7ebf\u7a0b\u6570\u3002\n    \u5bf9\u4e8e 10Gbps \u7f51\u5361\u7684\u8282\u70b9\uff0c\u901a\u5e38\u5efa\u8bae total_concurrency \u5728 1000 \u5de6\u53f3\u3002\n    \"\"\"\n\n    # \u5b9a\u4e49\u8f93\u51fa\u8def\u5f84 (S3 \u6216 HDFS)\n    output_dir = \"s3a://multimodal-lake/raw-images/laion-5b-subset\"\n\n    # \u6e05\u7406\u65e7\u6570\u636e (\u614e\u7528\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u5e26\u7248\u672c\u53f7)\n    if os.path.exists(output_dir): \n        # shutil.rmtree(output_dir) # \u5371\u9669\u64cd\u4f5c\uff0c\u6ce8\u91ca\u6389\n        pass\n\n    download(\n        processes_count=4,          # \u6bcf\u4e2a\u8282\u70b9\u4f7f\u7528 4 \u4e2a CPU \u6838\n        thread_count=64,            # \u6bcf\u4e2a\u6838\u5e76\u53d1 64 \u4e2a\u4e0b\u8f7d\u7ebf\u7a0b\n        url_list=\"s3a://multimodal-lake/meta/laion-urls.parquet\",\n        image_size=256,             # \u9884\u8bad\u7ec3\u9636\u6bb5 256x256 \u8db3\u591f\uff0c\u8282\u7701\u5e26\u5bbd\n        resize_only_if_bigger=True, # \u907f\u514d\u5c0f\u56fe\u786c\u653e\u5927\u9020\u6210\u7684\u6a21\u7cca\n        resize_mode=\"keep_ratio\",   # \u4fdd\u6301\u6bd4\u4f8b\uff0c\u586b\u5145\u9ed1\u8fb9\u6216\u4e2d\u5fc3\u88c1\u526a\n        skip_reencode=True,         # \u5982\u679c\u539f\u56fe\u5c31\u662f JPG \u4e14\u5927\u5c0f\u5408\u9002\uff0c\u76f4\u63a5\u5b58\u50a8\uff0c\u8282\u7701 CPU\n        output_folder=output_dir,\n        output_format=\"webdataset\", # \u5f3a\u5236\u4f7f\u7528 WebDataset\n        input_format=\"parquet\",\n        url_col=\"url\",\n        caption_col=\"caption\",\n        enable_wandb=True,          # \u5f3a\u70c8\u5efa\u8bae\u5f00\u542f\uff0c\u7528\u4e8e\u76d1\u63a7\u4e0b\u8f7d\u901f\u7387\u548c\u9519\u8bef\u7387\n        number_sample_per_shard=10000, # \u6bcf\u4e2a tar \u5305\u5305\u542b 1\u4e07 \u5f20\u56fe\uff0c\u7ea6 200-300MB\uff0c\u4fbf\u4e8e\u4f20\u8f93\n        distributor=\"pyspark\",      # \u4f7f\u7528 Spark \u5206\u53d1\u4efb\u52a1\n        save_additional_columns=[\"similarity\", \"hash\"], # \u4fdd\u7559\u539f\u59cb\u5143\u6570\u636e\n        timeout=10                  # \u8bbe\u7f6e\u8f83\u77ed\u8d85\u65f6\uff0c\u5feb\u901f\u5931\u8d25\uff0c\u957f\u5c3e\u8bf7\u6c42\u4e0d\u503c\u5f97\u7b49\u5f85\n    )\n\nif __name__ == \"__main__\":\n    # \u521d\u59cb\u5316 Spark Session (\u901a\u5e38\u7531 spark-submit \u81ea\u52a8\u5904\u7406\uff0c\u4f46\u4e5f\u9700\u663e\u5f0f\u58f0\u660e\u4ee5\u4fbf IDE \u8c03\u8bd5)\n    from pyspark.sql import SparkSession\n    spark = SparkSession.builder \\\n        .appName(\"Img2Dataset-Production\") \\\n        .config(\"spark.executor.memory\", \"8g\") \\\n        .config(\"spark.task.maxFailures\", \"10\") \\\n        .getOrCreate()\n\n    run_distributed_download()\n</code></pre> <p>\u5b9e\u6218\u6280\u5de7 (Pro Tips)\uff1a * DNS \u7f13\u5b58\uff1a\u5728\u9ad8\u5e76\u53d1\u4e0b\uff0cDNS \u89e3\u6790\u53ef\u80fd\u6210\u4e3a\u74f6\u9888\u751a\u81f3\u88ab\u670d\u52a1\u5546\u5c01\u7981\u3002\u5efa\u8bae\u5728 Worker \u8282\u70b9\u90e8\u7f72\u672c\u5730 DNS \u7f13\u5b58\uff08\u5982 dnsmasq\uff09\uff0c\u6216\u8005\u5728\u4ee3\u7801\u5c42\u9762\u7ef4\u62a4\u4e00\u4e2a\u57df\u540d\u5230 IP \u7684\u6620\u5c04\u8868\u3002 * User-Agent \u8f6e\u8be2\uff1a\u867d\u7136\u8fd9\u662f\u4e00\u4e2a\u201c\u516c\u5f00\u201d\u7684\u79d8\u5bc6\uff0c\u4f46\u8f6e\u8be2 User-Agent \u53ef\u4ee5\u51cf\u5c11 403 Forbidden \u7684\u6bd4\u4f8b\u3002 * \u9519\u8bef\u5904\u7406\uff1a\u5173\u6ce8 WandB \u9762\u677f\u4e2d\u7684 success_rate\u3002\u5982\u679c\u4f4e\u4e8e 80%\uff0c\u901a\u5e38\u610f\u5473\u7740 URL \u5217\u8868\u8fc7\u671f\u4e25\u91cd\uff0c\u6216\u8005\u4f60\u7684 IP \u6c60\u88ab\u6c61\u67d3\u4e86\u3002</p>"},{"location":"chapter3/3_1/#6_22","title":"6_2.2 \u89c6\u89c9\u9884\u5904\u7406\u7684\u9677\u9631\uff1a\u88c1\u526a\u4e0e\u8bed\u4e49\u5bf9\u9f50","text":"<p>\u5728\u89e3\u51b3\u4e86\u6d77\u91cf\u6570\u636e\u7684\u83b7\u53d6\uff08Getting bytes\uff09\u4e4b\u540e\uff0c\u6211\u4eec\u7acb\u523b\u9762\u4e34\u7b2c\u4e8c\u4e2a\u6311\u6218\uff1a\u6570\u636e\u7684\u53ef\u7528\u6027\uff08Usability\uff09\u3002\u539f\u59cb\u4e92\u8054\u7f51\u56fe\u7247\u7684\u957f\u5bbd\u6bd4\uff08Aspect Ratio\uff09\u5343\u5947\u767e\u602a\uff0c\u800c\u6a21\u578b\u901a\u5e38\u9700\u8981\u56fa\u5b9a\u7684\u5206\u8fa8\u7387\u8f93\u5165\uff08\u5982 224x224 \u6216 512x512\uff09\u3002</p> <p>\u5f88\u591a\u521d\u7ea7\u5de5\u7a0b\u65b9\u6848\u4e60\u60ef\u4e8e\u7b80\u5355\u7c97\u66b4\u7684\u968f\u673a\u9884\u5904\u7406\u6765\u7edf\u4e00\u5c3a\u5bf8\uff0c\u4f46\u8fd9\u5f80\u5f80\u662f\u6a21\u578b\u6027\u80fd\u201c\u9690\u5f62\u5929\u82b1\u677f\u201d\u7684\u6839\u6e90\u3002\u6211\u4eec\u4e0d\u4ec5\u8981\u5173\u6ce8\u201c\u628a\u56fe\u653e\u8fdb\u53bb\u201d\uff0c\u8fd8\u8981\u5173\u6ce8\u201c\u653e\u8fdb\u53bb\u7684\u662f\u4ec0\u4e48\u201d\u3002</p> <p> \u56fe6-1\uff1a\u56fe\u7247\u9884\u5904\u7406\u4e2d\u88c1\u526a\u4e0e\u8bed\u4e49\u5bf9\u9f50\u95ee\u9898</p> <ul> <li> <p>Bad Case\uff08\u5de6\u56fe - \u673a\u68b0\u88c1\u526a\u7684\u4ee3\u4ef7\uff09\uff1a     \u4f20\u7edf\u7684 <code>RandomCrop</code> \u6216 <code>CenterCrop</code> \u5bf9\u6784\u56fe\u6ca1\u6709\u611f\u77e5\u3002\u5f53\u5904\u7406\u4e00\u5f20\u7ad6\u6784\u56fe\u7684\u4eba\u50cf\u7167\u7247\u65f6\uff0c\u4e2d\u5fc3\u88c1\u526a\u6781\u6613\u5207\u6389\u5173\u952e\u7279\u5f81\uff08\u5982\u5934\u90e8\uff09\uff0c\u53ea\u4fdd\u7559\u8eaf\u5e72\u3002\u6b64\u65f6\uff0c\u5982\u679c\u6587\u672c\u6807\u7b7e\u4f9d\u7136\u662f\u201c\u4e00\u4e2a\u5fae\u7b11\u7684\u7537\u4eba\u201d\uff0c\u6a21\u578b\u5c31\u4f1a\u88ab\u8feb\u5efa\u7acb\u9519\u8bef\u7684\u6620\u5c04\u5173\u7cfb\uff08\u628a\u8eaf\u5e72\u7279\u5f81\u8bef\u8ba4\u4e3a\u662f\u201c\u5fae\u7b11\u7684\u4eba\u201d\uff09\uff0c\u5bfc\u81f4\u8bad\u7ec3\u51fa\u7684\u6a21\u578b\u4ea7\u751f\u4e25\u91cd\u7684\u89c6\u89c9\u5e7b\u89c9\u3002</p> </li> <li> <p>Good Case\uff08\u53f3\u56fe - \u8bed\u4e49\u5b8c\u6574\u6027\uff09\uff1a     \u9ad8\u8d28\u91cf\u7684\u6570\u636e\u5de5\u7a0b\u8ffd\u6c42\u201c\u56fe\u6587\u4e00\u81f4\u6027\u201d\u3002</p> <ol> <li>Smart Resize: \u5c3d\u91cf\u91c7\u7528 <code>Resize with Padding</code>\uff08\u4fdd\u6301\u6bd4\u4f8b\uff0c\u586b\u5145\u9ed1\u8fb9/\u767d\u8fb9\uff09\u6765\u4fdd\u7559\u5b8c\u6574\u7684\u89c6\u89c9\u4e3b\u4f53\u3002\u867d\u7136\u8fd9\u5f15\u5165\u4e86\u65e0\u6548\u50cf\u7d20\uff0c\u4f46\u4fdd\u8bc1\u4e86\u8bed\u4e49\u5b8c\u6574\u3002</li> <li>Aspect Ratio Bucketing (\u957f\u5bbd\u6bd4\u5206\u6876)\uff1a\u8fd9\u662f\u76ee\u524d SDXL \u548c Midjourney \u7b49\u751f\u6210\u6a21\u578b\u5e38\u7528\u7684\u9ad8\u7ea7\u6280\u5de7\u3002\u5c06\u957f\u5bbd\u6bd4\u76f8\u4f3c\u7684\u56fe\u7247\u5206\u5230\u540c\u4e00\u4e2a Batch \u4e2d\u8bad\u7ec3\uff0c\u65e2\u907f\u514d\u4e86\u88c1\u526a\uff0c\u53c8\u51cf\u5c11\u4e86 Padding \u7684\u6d6a\u8d39\u3002</li> <li>Recaptioning (\u91cd\u6253\u6807)\uff1a\u5982\u4e0b\u6587\u7b2c 7 \u7ae0\u5c06\u8be6\u7ec6\u9610\u8ff0\u7684\uff0c\u5229\u7528 VLM \u751f\u6210\u9ad8\u5bc6\u5ea6\u7684\u63cf\u8ff0\uff0c\u80fd\u8ba9\u6587\u672c\u7cbe\u51c6\u5bf9\u5e94\u753b\u9762\u4e2d\u7684\u7ec6\u8282\uff08\u5982\u62db\u724c\u6587\u5b57\u3001\u80cc\u666f\u7269\u4f53\uff09\uff0c\u4ece\u800c\u6700\u5927\u5316\u6570\u636e\u7684\u8bad\u7ec3\u4ef7\u503c\u3002</li> </ol> </li> </ul>"},{"location":"chapter3/3_1/#6_23-gpu-nvidia-dali","title":"6_2.3 GPU \u52a0\u901f\u89e3\u7801\u4e0e\u53d8\u6362 (NVIDIA DALI)","text":"<p>\u5728\u6df1\u5ea6\u5b66\u4e60\u6a21\u578b\u8bad\u7ec3\u73af\u8282\uff0c\u591a\u6570\u7814\u7a76\u8005\u548c\u5f00\u53d1\u8005\u7684\u6838\u5fc3\u6ce8\u610f\u529b\u5f80\u5f80\u96c6\u4e2d\u5728\u6a21\u578b\u67b6\u6784\u8bbe\u8ba1\u3001\u8d85\u53c2\u6570\u8c03\u4f18\u3001\u635f\u5931\u51fd\u6570\u6539\u8fdb\u7b49\u76f4\u63a5\u5f71\u54cd\u6a21\u578b\u7cbe\u5ea6\u7684\u6a21\u5757\u4e0a\uff0c\u5374\u5bb9\u6613\u5ffd\u89c6\u6570\u636e\u52a0\u8f7d\uff08DataLoader\uff09\u8fd9\u4e00\u57fa\u7840\u73af\u8282\u2014\u2014\u800c\u5b9e\u9645\u4e0a\uff0c\u5b83\u5e38\u5e38\u6210\u4e3a\u5236\u7ea6\u8bad\u7ec3\u6548\u7387\u7684\u201c\u9690\u5f62\u6027\u80fd\u6740\u624b\u201d\uff0c\u751a\u81f3\u5bfc\u81f4\u9ad8\u7aefGPU\u7684\u7b97\u529b\u65e0\u6cd5\u5f97\u5230\u5145\u5206\u91ca\u653e\uff0c\u9020\u6210\u786c\u4ef6\u8d44\u6e90\u7684\u4e25\u91cd\u6d6a\u8d39\u3002 \u8981\u7406\u89e3\u8fd9\u4e00\u75db\u70b9\uff0c\u9700\u5148\u660e\u786e\u6df1\u5ea6\u5b66\u4e60\u8bad\u7ec3\u7684\u5b8c\u6574\u6d41\u7a0b\u903b\u8f91\uff1a\u6a21\u578b\u8bad\u7ec3\u7684\u6838\u5fc3\u7b97\u529b\u4f9d\u8d56GPU\u7684\u5927\u89c4\u6a21\u5e76\u884c\u8ba1\u7b97\u80fd\u529b\uff0cGPU\u80fd\u591f\u9ad8\u6548\u5904\u7406\u6d77\u91cf\u5f20\u91cf\u8fd0\u7b97\u3001\u5b8c\u6210\u53cd\u5411\u4f20\u64ad\u4e0e\u53c2\u6570\u66f4\u65b0\uff1b\u4f46\u5728\u6570\u636e\u8f93\u5165GPU\u4e4b\u524d\uff0c\u5fc5\u987b\u7ecf\u8fc7\u4e00\u7cfb\u5217\u9884\u5904\u7406\u64cd\u4f5c\uff0c\u5176\u4e2d\u6700\u57fa\u7840\u4e14\u8017\u65f6\u7684\u5c31\u662f\u56fe\u50cf\u6570\u636e\u7684\u89e3\u7801\u4e0e\u5c3a\u5bf8\u53d8\u6362\uff08\u5982Resize\uff09\u3002\u5728\u4f20\u7edf\u7684PyTorch\u8bad\u7ec3\u6d41\u7a0b\u4e2d\uff0c\u8fd9\u4e9b\u5173\u952e\u9884\u5904\u7406\u64cd\u4f5c\u5b8c\u5168\u4f9d\u8d56CPU\u5b8c\u6210\uff0c\u8fd9\u5c31\u5f62\u6210\u4e86\u201cCPU\u9884\u5904\u7406\u74f6\u9888\u201d\u4e0e\u201cGPU\u7b97\u529b\u5197\u4f59\u201d\u7684\u77db\u76fe\u3002</p> <p>\u5177\u4f53\u800c\u8a00\uff0c\u4f20\u7edfPyTorch Dataset\u7684\u5de5\u4f5c\u673a\u5236\u7684\u662f\uff1a\u9996\u5148\u901a\u8fc7CPU\u8bfb\u53d6\u5b58\u50a8\u5728\u786c\u76d8\u4e2d\u7684\u56fe\u50cf\u6587\u4ef6\uff08\u591a\u4e3aJPEG\u683c\u5f0f\uff09\uff0c\u968f\u540e\u7531CPU\u5b8c\u6210JPEG\u89e3\u7801\u64cd\u4f5c\u2014\u2014\u8fd9\u4e00\u8fc7\u7a0b\u9700\u8981\u5bf9\u538b\u7f29\u7684\u56fe\u50cf\u4e8c\u8fdb\u5236\u6570\u636e\u8fdb\u884cHuffman\u89e3\u7801\u3001\u9006\u79bb\u6563\u4f59\u5f26\u53d8\u6362\uff08IDCT\uff09\u7b49\u590d\u6742\u8ba1\u7b97\uff0c\u5c5e\u4e8e\u5178\u578b\u7684CPU\u5bc6\u96c6\u578b\u4efb\u52a1\uff1b\u89e3\u7801\u5b8c\u6210\u540e\uff0c\u518d\u7531CPU\u6267\u884cResize\uff08\u5c3a\u5bf8\u7f29\u653e\uff09\u3001\u5f52\u4e00\u5316\u3001\u8272\u57df\u8f6c\u6362\u7b49\u540e\u7eed\u9884\u5904\u7406\u64cd\u4f5c\uff0c\u6700\u7ec8\u5c06\u5904\u7406\u540e\u7684\u56fe\u50cf\u5f20\u91cf\u901a\u8fc7\u6570\u636e\u62f7\u8d1d\u4f20\u8f93\u81f3GPU\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u3002</p> <p>\u66f4\u4e3a\u5173\u952e\u7684\u662f\uff0cCPU\u7684\u67b6\u6784\u8bbe\u8ba1\u66f4\u9002\u5408\u4e32\u884c\u8ba1\u7b97\u548c\u903b\u8f91\u63a7\u5236\uff0c\u5176\u5e76\u884c\u8ba1\u7b97\u80fd\u529b\u8fdc\u4e0d\u53caGPU\uff0c\u800c\u56fe\u50cf\u9884\u5904\u7406\u4e2d\u7684\u89e3\u7801\u3001Resize\u7b49\u64cd\u4f5c\u672c\u8eab\u5177\u5907\u6781\u5f3a\u7684\u5e76\u884c\u6027\uff0c\u80fd\u591f\u901a\u8fc7\u591a\u7ebf\u7a0b\u6216\u591a\u6838\u5fc3\u5e76\u884c\u5904\u7406\u63d0\u5347\u6548\u7387\uff0c\u4f46\u4f20\u7edfPyTorch Dataset\u5373\u4fbf\u901a\u8fc7DataLoader\u7684num_workers\u53c2\u6570\u63d0\u5347CPU\u5e76\u884c\u5ea6\uff0c\u4e5f\u96be\u4ee5\u7a81\u7834CPU\u672c\u8eab\u7684\u7b97\u529b\u4e0a\u9650\u2014\u2014\u5c24\u5176\u662f\u5f53\u8bad\u7ec3\u6570\u636e\u96c6\u89c4\u6a21\u5e9e\u5927\uff08\u5982\u767e\u4e07\u7ea7\u4ee5\u4e0a\u56fe\u50cf\uff09\u3001\u5355\u5f20\u56fe\u50cf\u5206\u8fa8\u7387\u8f83\u9ad8\uff08\u59821080P\u53ca\u4ee5\u4e0a\uff09\u65f6\uff0cCPU\u7684\u9884\u5904\u7406\u901f\u5ea6\u4f1a\u4e25\u91cd\u6ede\u540e\u4e8eGPU\u7684\u8bad\u7ec3\u901f\u5ea6\uff0c\u5bfc\u81f4GPU\u9891\u7e41\u5904\u4e8e\u201c\u7b49\u5f85\u6570\u636e\u201d\u7684\u7a7a\u95f2\u72b6\u6001\uff0cGPU\u5229\u7528\u7387\u5927\u5e45\u4e0b\u964d\uff0c\u6700\u7ec8\u62d6\u7d2f\u6574\u4e2a\u8bad\u7ec3\u6d41\u7a0b\u7684\u6548\u7387\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4f55\u6570\u636e\u52a0\u8f7d\u4f1a\u88ab\u79f0\u4e3a\u201c\u88ab\u5ffd\u89c6\u7684\u6027\u80fd\u6740\u624b\u201d\u7684\u6838\u5fc3\u539f\u56e0\u3002</p> <p>\u9488\u5bf9\u8fd9\u4e00\u6838\u5fc3\u75db\u70b9\uff0cNVIDIA\u63a8\u51fa\u4e86DALI\uff08Data Loading Library\uff09\uff0c\u4e00\u6b3e\u4e13\u4e3a\u6df1\u5ea6\u5b66\u4e60\u8bad\u7ec3\u4f18\u5316\u7684GPU\u52a0\u901f\u6570\u636e\u9884\u5904\u7406\u5e93\uff0c\u5176\u6838\u5fc3\u76ee\u6807\u5c31\u662f\u5c06\u539f\u672c\u4f9d\u8d56CPU\u7684\u56fe\u50cf\u89e3\u7801\u3001\u5c3a\u5bf8\u53d8\u6362\u7b49\u5bc6\u96c6\u578b\u9884\u5904\u7406\u64cd\u4f5c\uff0c\u8fc1\u79fb\u5230GPU\u4e0a\u5e76\u884c\u6267\u884c\uff0c\u6253\u7834\u6570\u636e\u52a0\u8f7d\u7684\u6027\u80fd\u74f6\u9888\uff0c\u8ba9GPU\u7684\u7b97\u529b\u5f97\u5230\u5145\u5206\u53d1\u6325\u3002</p> <p> \u56fe6-2\uff1a\u4f7f\u7528DALI\u4e0e\u4e0d\u4f7f\u7528DALI\u4e0b\u6570\u636e\u89e3\u7801\u4e0e\u53d8\u6362\u7684\u533a\u522b</p> <p>\u4ee3\u7801\u62c6\u89e3\uff1a\u57fa\u4e8e DALI \u7684\u9ad8\u6027\u80fd\u6d41\u6c34\u7ebf</p> <pre><code>import nvidia.dali.fn as fn\nimport nvidia.dali.types as types\nfrom nvidia.dali.pipeline import pipeline_def\n\n\n@pipeline_def(batch_size=256, num_threads=8, device_id=0)\ndef webdataset_gpu_pipeline(shard_id, num_shards):\n    \"\"\"\n    \u5b9a\u4e49\u7aef\u5230\u7aef GPU \u6570\u636e\u52a0\u8f7d\u6d41\u6c34\u7ebf\n    \u8f93\u5165: WebDataset (Tar) -&gt; \u8f93\u51fa: GPU Tensor\n    \"\"\"\n\n    # Step 1: \u8bfb\u53d6 WebDataset (CPU \u9636\u6bb5)\n    # \u4f7f\u7528 index_paths \u662f\u5fc5\u987b\u7684\uff0c\u5426\u5219\u521d\u59cb\u5316\u9636\u6bb5\u9700\u8981\u904d\u5386\u6574\u4e2a tar \u5305\uff0c\u8017\u65f6\u6781\u957f [5]\n    jpegs, captions = fn.readers.webdataset(\n        paths=[\"/data/shards/shard-{:05d}.tar\".format(i) for i in range(100)],\n        index_paths=[\"/data/indices/shard-{:05d}.idx\".format(i) for i in range(100)],\n        ext=[\"jpg\", \"txt\"],\n        shard_id=shard_id,\n        num_shards=num_shards,\n        random_shuffle=True,\n        initial_fill=10000,      # \u4e71\u5e8f\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u8d8a\u5927\u8d8a\u968f\u673a\uff0c\u4f46\u542f\u52a8\u8d8a\u6162\n        pad_last_batch=True,     # \u4fdd\u8bc1\u6240\u6709 Batch \u5927\u5c0f\u4e00\u81f4\n        name=\"Reader\",\n        read_ahead=True          # \u5f00\u542f\u9884\u8bfb\n    )\n\n    # Step 2: GPU \u89e3\u7801 (\u6838\u5fc3\u52a0\u901f\u70b9)\n    # device=\"mixed\" \u8868\u793a\u8f93\u5165\u5728 Host \u5185\u5b58\uff0c\u8f93\u51fa\u5728 Device \u663e\u5b58\n    # output_type=types.RGB \u81ea\u52a8\u5904\u7406\u8272\u5f69\u7a7a\u95f4\u8f6c\u6362\n    images = fn.decoders.image(\n        jpegs,\n        device=\"mixed\",\n        output_type=types.RGB,\n        # \u9488\u5bf9\u635f\u574f\u56fe\u7247\u7684\u5bb9\u9519\u5904\u7406\n        # \u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5343\u4e07\u4e0d\u8981\u56e0\u4e3a\u4e00\u5f20\u574f\u56fe\u5bfc\u81f4\u8bad\u7ec3\u5d29\u6e83\n    )\n\n    # Step 3: GPU \u53d8\u6362\u6d41\u6c34\u7ebf\n    # resize: \u4fdd\u6301\u957f\u5bbd\u6bd4\u7f29\u653e\n    images = fn.resize(\n        images,\n        resize_x=224,\n        resize_y=224,\n        interp_type=types.INTERP_LINEAR\n    )\n\n    # crop_mirror_normalize: \u968f\u673a\u88c1\u526a + \u7ffb\u8f6c + \u5f52\u4e00\u5316 (\u878d\u5408\u7b97\u5b50)\n    # \u8fd9\u4e00\u6b65\u5c06 uint8 \u8f6c\u4e3a float\uff0c\u5e76\u51cf\u5747\u503c\u9664\u65b9\u5dee\n    images = fn.crop_mirror_normalize(\n        images,\n        dtype=types.FLOAT,\n        output_layout=\"CHW\",\n        crop=(224, 224),\n        mean=[0_485 * 255, 0_456 * 255, 0_406 * 255],\n        std=[0_229 * 255, 0_224 * 255, 0_225 * 255],\n        mirror=fn.random.coin_flip(probability=0_5)\n    )\n\n    # \u6587\u672c\u6570\u636e\u901a\u5e38\u76f4\u63a5\u5728 CPU \u5904\u7406\u6216\u4f20\u9012\u7ed9 Tokenizer\n    # \u8fd9\u91cc\u6211\u4eec\u53ea\u8fd4\u56de\u539f\u59cb bytes\uff0c\u540e\u7eed\u7531 PyTorch \u5904\u7406\n    return images, captions\n\n# \u4f7f\u7528\u4e0e PyTorch \u96c6\u6210\u7684 DALIGenericIterator\nfrom nvidia.dali.plugin.pytorch import DALIGenericIterator\n\npipe = webdataset_gpu_pipeline(shard_id=0, num_shards=1)\npipe.build()\ndataloader = DALIGenericIterator(pipe, [\"images\", \"captions\"], reader_name=\"Reader\")\n\n# Benchmark \u6d4b\u8bd5\n# \u5728 A100 \u4e0a\uff0c\u6b64\u6d41\u6c34\u7ebf\u901a\u5e38\u80fd\u8fbe\u5230 3000-5000 FPS\uff0c\u662f CPU Loader \u7684 5-10 \u500d\n</code></pre>"},{"location":"chapter3/3_1/#6_3","title":"6_3 \u591a\u6a21\u6001\u6e05\u6d17\u6d41\u6c34\u7ebf","text":"<p>\u6d77\u91cf\u6570\u636e\u4f34\u968f\u7740\u6d77\u91cf\u566a\u58f0\u3002LAION-5B \u539f\u59cb\u6570\u636e\u4e2d\uff0c\u771f\u6b63\u9ad8\u8d28\u91cf\u7684\u6837\u672c\u53ef\u80fd\u4e0d\u8db3 10%\u3002\u6211\u4eec\u9700\u8981\u5efa\u7acb\u4e00\u4e2a\u591a\u7ea7\u6e05\u6d17\u6f0f\u6597\uff08Funnel\uff09\uff0c\u5728\u5c3d\u53ef\u80fd\u5c11\u5730\u635f\u5931\u6570\u636e\u591a\u6837\u6027\u7684\u524d\u63d0\u4e0b\uff0c\u63d0\u5347\u6570\u636e\u5bc6\u5ea6\u3002\u6240\u8c13\u7684\u201c\u6570\u636e\u6e05\u6d17\u201d\uff0c\u672c\u8d28\u4e0a\u662f\u5728\u505aData Diet\uff08\u6570\u636e\u8282\u98df\uff09\u2014\u2014\u7ed9\u6a21\u578b\u5403\u5f97\u5c11\u4f46\u5403\u5f97\u597d\u3002</p>"},{"location":"chapter3/3_1/#6_31-ray-data","title":"6_3.1 \u67b6\u6784\u8bbe\u8ba1\uff1aRay Data \u5206\u5e03\u5f0f\u6e05\u6d17","text":"<p>\u5728\u6570\u636e\u6e05\u6d17\u9636\u6bb5\uff0c\u6211\u4eec\u4e3a\u4f55\u9009\u62e9 Ray \u800c\u975e Spark\uff1f\u56e0\u4e3a\u6e05\u6d17\u8fc7\u7a0b\u4e0d\u518d\u662f\u7b80\u5355\u7684 ETL\uff0c\u800c\u662f\u5305\u542b\u4e86\u5927\u91cf\u7684\u6df1\u5ea6\u5b66\u4e60\u63a8\u7406\uff08Model Inference\uff09\u3002\u76f8\u6bd4\u4e8e Spark \u7684 MapReduce \u8303\u5f0f\uff0cRay \u63d0\u4f9b\u4e86\u66f4\u7075\u6d3b\u7684 Actor \u673a\u5236\uff0c\u5141\u8bb8\u6211\u4eec\u5e38\u9a7b GPU \u6a21\u578b\uff08\u5982 CLIP, Safety Checker\uff09\uff0c\u907f\u514d\u4e86\u6bcf\u6b21\u5904\u7406\u5c0f\u6279\u6570\u636e\u90fd\u8981\u91cd\u65b0\u52a0\u8f7d\u51e0\u4e2a GB \u6a21\u578b\u7684\u5de8\u5927\u5f00\u9500\u3002</p> <p>Ray Data \u9002\u5408\u5904\u7406\u8fd9\u79cd\u65e2\u6709 CPU \u5bc6\u96c6\u578b\uff08\u89e3\u538b\u3001\u54c8\u5e0c\u3001Regex\uff09\u53c8\u6709 GPU \u5bc6\u96c6\u578b\uff08CLIP Embedding \u63a8\u7406\uff09\u7684\u6df7\u5408\u8d1f\u8f7d\u3002\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a\u5178\u578b\u7684\u4e09\u9636\u6bb5\u6d41\u6c34\u7ebf\u8bbe\u8ba1\uff1a * Stage 1 (CPU): \u5feb\u901f\u8fc7\u6ee4\u3002\u76f4\u63a5\u5254\u9664\u5206\u8fa8\u7387\u4e0d\u8db3\uff08&lt;256px\uff09\u3001\u6587\u672c\u8fc7\u77ed\u3001\u975e\u82f1\u8bed\uff08\u5982\u679c\u53ea\u7ec3\u82f1\u8bed\u6a21\u578b\uff09\u6216\u957f\u5bbd\u6bd4\u5f02\u5e38\u7684\u6837\u672c\u3002 * Stage 2 (GPU): \u6df1\u5ea6\u7279\u5f81\u63d0\u53d6\u3002\u5229\u7528 CLIP \u6a21\u578b\u751f\u6210 Embedding\uff0c\u5e76\u57fa\u4e8e Embedding \u8ba1\u7b97\u56fe\u6587\u76f8\u4f3c\u5ea6\u548c\u7f8e\u5b66\u8bc4\u5206\u3002 * Stage 3 (CPU/Mixed): \u903b\u8f91\u5224\u5b9a\u4e0e\u53bb\u91cd\u3002\u7efc\u5408\u5b89\u5168\u6027\uff08NSFW\uff09\u3001\u7f8e\u5b66\u5206\u6570\u53ca\u56fe\u6587\u76f8\u5173\u6027\u8fdb\u884c\u6700\u7ec8\u9608\u503c\u622a\u65ad\uff0c\u5e76\u8fdb\u884c\u8bed\u4e49\u53bb\u91cd\u3002</p> <p>\u6570\u636e\u6d41\u5411\u56fe (Data Flow)</p> <p> \u56fe6-3\uff1aRay Data\u5206\u5e03\u5f0f\u6e05\u6d17\u6570\u636e\u6d41\u5411\u56fe</p>"},{"location":"chapter3/3_1/#6_32","title":"6_3.2 \u6838\u5fc3\u7b97\u6cd5\u5b9e\u73b0","text":"<p>\u6e05\u6d17\u4e0d\u4ec5\u4ec5\u662f\u5220\u9664\uff0c\u66f4\u662f\u5bf9\u6570\u636e\u4ef7\u503c\u7684\u91cf\u5316\u3002\u6211\u4eec\u9700\u8981\u591a\u7ef4\u5ea6\u7684\u6307\u6807\u6765\u8861\u91cf\u4e00\u5f20\u56fe\u7247\u53ca\u5176\u5bf9\u5e94\u6587\u672c\u7684\u201c\u542b\u91d1\u91cf\u201d\u3002</p> <ol> <li> <p>\u7f8e\u5b66\u8bc4\u5206 (Aesthetics Scoring)</p> <ul> <li>\u539f\u7406\uff1a\u6570\u636e\u96c6\u4e2d\u5145\u65a5\u7740\u53d1\u7968\u3001\u622a\u56fe\u3001\u6a21\u7cca\u7684\u76d1\u63a7\u753b\u9762\uff0c\u8fd9\u4e9b\u5bf9\u751f\u6210\u7f8e\u89c2\u56fe\u7247\u6beb\u65e0\u5e2e\u52a9\u3002\u901a\u5e38\u4f7f\u7528 LAION-Aesthetics Predictor\u3002</li> <li>\u6280\u672f\u7ec6\u8282\uff1a\u8fd9\u662f\u4e00\u4e2a\u7b80\u5355\u7684 MLP\uff08\u591a\u5c42\u611f\u77e5\u673a\uff09\uff0c\u8f93\u5165\u662f CLIP Image Embedding\uff0c\u8f93\u51fa\u662f 1-10 \u7684\u5206\u6570\u3002\u8bad\u7ec3\u6570\u636e\u6765\u81ea AVA \u6570\u636e\u96c6\uff08\u5305\u542b\u4eba\u7c7b\u4e13\u4e1a\u6444\u5f71\u5e08\u6253\u5206\uff09\u3002</li> <li>\u5efa\u8bae\u9608\u503c\uff1a\u5bf9\u4e8e\u57fa\u7840\u9884\u8bad\u7ec3\uff0c\u4fdd\u7559 Score &gt; 4_5 \u7684\u6570\u636e\uff1b\u5bf9\u4e8e\u5fae\u8c03\u9ad8\u8d28\u91cf\u751f\u6210\u6a21\u578b\uff08SFT\u9636\u6bb5\uff09\uff0c\u5efa\u8bae Score &gt; 6_0\uff0c\u751a\u81f3 6_5\u3002</li> </ul> </li> <li> <p>\u56fe\u6587\u5bf9\u9f50\u8fc7\u6ee4 (Image-Text Alignment)</p> <ul> <li>\u539f\u7406\uff1a\u5f88\u591a Alt-text \u662f SEO \u5783\u573e\u8bcd\u5806\u780c\uff0c\u6216\u8005\u6587\u4ef6\u540d\uff08\"DSC_001.jpg\"\uff09\uff0c\u4e0e\u56fe\u7247\u5185\u5bb9\u65e0\u5173\u3002</li> <li>\u6280\u672f\u7ec6\u8282\uff1a\u8ba1\u7b97 CLIP Image Embedding \u548c Text Embedding \u7684\u4f59\u5f26\u76f8\u4f3c\u5ea6\uff08Dot Product\uff09\u3002</li> <li>\u5751\u70b9\uff1a\u4e0d\u540c\u7248\u672c\u7684 CLIP \u6a21\u578b\uff08\u5982 OpenAI ViT-L/14 vs OpenCLIP ViT-G/14\uff09\u7684\u5d4c\u5165\u7a7a\u95f4\u5206\u5e03\u4e0d\u540c\uff0c\u5206\u6570\u4e0d\u53ef\u76f4\u63a5\u6bd4\u8f83\u3002\u5fc5\u987b\u6839\u636e\u5177\u4f53\u6a21\u578b\u91cd\u65b0\u6821\u51c6\u9608\u503c\u3002\u901a\u5e38\u7684\u505a\u6cd5\u662f\u8ba1\u7b97\u6574\u4e2a\u6570\u636e\u96c6\u7684\u76f8\u4f3c\u5ea6\u5206\u5e03\uff0c\u7136\u540e\u4fdd\u7559 Top 50% \u6216 Top 70% \u7684\u6570\u636e\u3002</li> </ul> </li> <li> <p>\u5b89\u5168\u6027\u68c0\u6d4b (Safety &amp; Watermark)</p> <ul> <li>\u539f\u7406\uff1a\u5fc5\u987b\u5254\u9664\u8272\u60c5\u3001\u66b4\u529b\u4ee5\u53ca\u5e26\u6709\u660e\u663e\u54c1\u724c\u6c34\u5370\u7684\u56fe\u7247\u3002</li> <li>\u7b56\u7565\uff1a\u4f7f\u7528\u4e13\u95e8\u8bad\u7ec3\u7684\u5206\u7c7b\u5668\u5934\uff08\u4e5f\u662f\u57fa\u4e8e CLIP Embedding\uff09\u6765\u68c0\u6d4b NSFW \u548c\u6c34\u5370\u3002\u5bf9\u4e8e\u6c34\u5370\u68c0\u6d4b\uff0c\u5982\u679c\u76ee\u6807\u662f\u8bad\u7ec3\u751f\u6210\u6a21\u578b\uff08\u5982 SDXL\uff09\uff0c\u5fc5\u987b\u6781\u5176\u4e25\u683c\uff08Recall \u4f18\u5148\uff09\uff0c\u56e0\u4e3a\u751f\u6210\u6a21\u578b\u6781\u6613\u8fc7\u62df\u5408\u6c34\u5370\u7279\u5f81\uff1b\u5982\u679c\u76ee\u6807\u662f\u8bad\u7ec3\u7406\u89e3\u6a21\u578b\uff08\u5982 GPT-4V\uff09\uff0c\u53ef\u4ee5\u9002\u5f53\u653e\u5bbd\uff0c\u56e0\u4e3a\u7406\u89e3\u6a21\u578b\u9700\u8981\u8bc6\u522b\u201c\u56fe\u7247\u91cc\u6709\u6c34\u5370\u201d\u8fd9\u4e2a\u4e8b\u5b9e\u3002</li> </ul> </li> </ol> <p>\u4ee3\u7801\u5b9e\u73b0\uff1aRay Data \u6e05\u6d17\u7b97\u5b50</p> <pre><code>import ray\nimport torch\nimport open_clip\nimport numpy as np\nfrom PIL import Image\nimport io\n\n# \u5b9a\u4e49 Ray Actor \u7c7b\uff0c\u786e\u4fdd\u6a21\u578b\u53ea\u52a0\u8f7d\u4e00\u6b21\nclass QualityScorer:\n    def __init__(self):\n        self.device = \"cuda\" if torch.cuda.is_available() else \"cpu\"\n        # \u52a0\u8f7d CLIP \u6a21\u578b (ViT-B-32 \u901f\u5ea6\u5feb\uff0c\u9002\u5408\u6e05\u6d17)\n        self.model, _, self.preprocess = open_clip.create_model_and_transforms(\n            'ViT-B-32', pretrained='laion2b_s34b_b79k', device=self.device\n        )\n        # \u52a0\u8f7d\u7f8e\u5b66\u8bc4\u5206\u5934 (Linear Layer)\n        self.aesthetic_head = torch.nn.Linear(512, 1).to(self.device)\n        self.aesthetic_head.load_state_dict(torch.load(\"sac+logos+ava1-l14-linearMSE.pth\"))\n        self.aesthetic_head.eval()\n\n    def __call__(self, batch: dict) -&gt; dict:\n        \"\"\"\n        \u5904\u7406\u4e00\u4e2a batch \u7684\u6570\u636e\u3002Ray \u4f1a\u81ea\u52a8\u5c06\u6570\u636e\u5206\u7247\u4f20\u8f93\u7ed9 Actor\u3002\n        \"\"\"\n        images = []\n        valid_indices = []\n\n        # \u9884\u5904\u7406\u56fe\u7247 (CPU \u64cd\u4f5c)\n        for idx, img_bytes in enumerate(batch[\"jpg\"]):\n            try:\n                img = Image.open(io.BytesIO(img_bytes)).convert(\"RGB\")\n                img_tensor = self.preprocess(img)\n                images.append(img_tensor)\n                valid_indices.append(idx)\n            except Exception:\n                # \u8bb0\u5f55\u574f\u56fe\u65e5\u5fd7\uff0c\u4f46\u4e0d\u8981\u4e2d\u65ad\n                continue\n\n        if not images:\n            return {\"aesthetic_score\": [], \"clip_score\": []}\n\n        image_input = torch.stack(images).to(self.device)\n\n        with torch.no_grad():\n            # 1. \u63d0\u53d6\u7279\u5f81\n            image_features = self.model.encode_image(image_input)\n            image_features /= image_features.norm(dim=-1, keepdim=True)\n\n            # 2. \u8ba1\u7b97\u7f8e\u5b66\u5206\n            aesthetic_scores = self.aesthetic_head(image_features).squeeze().cpu().numpy()\n\n            # 3. \u8ba1\u7b97\u56fe\u6587\u5339\u914d\u5ea6 (\u5047\u8bbe batch \u4e2d\u6709 text \u5b57\u6bb5)\n            # text_tokens = self.tokenizer(batch[\"txt\"]).to(self.device)\n            # text_features = self.model.encode_text(text_tokens)\n            #... \u8ba1\u7b97 cosine similarity\n\n        # \u8fd4\u56de\u7ed3\u679c (\u9700\u6ce8\u610f\u4e0e\u539f\u59cb batch \u7d22\u5f15\u5bf9\u9f50)\n        return {\"aesthetic_score\": aesthetic_scores}\n\n# \u7f16\u6392 Ray \u6d41\u6c34\u7ebf\nray.init()\nds = ray.data.read_webdataset(\"s3://raw-bucket/{00000..00099}.tar\")\n\n# map_batches \u4f1a\u81ea\u52a8\u8c03\u5ea6 GPU \u8d44\u6e90\n# num_gpus=0_25 \u610f\u5473\u7740\u4e00\u5f20 GPU \u53ef\u4ee5\u5e76\u53d1\u8dd1 4 \u4e2a Actor\uff0c\u63d0\u9ad8\u541e\u5410\nscored_ds = ds.map_batches(\n    QualityScorer, \n    compute=ray.data.ActorPoolStrategy(size=8), \n    num_gpus=0_25, \n    batch_size=128\n)\n\n# \u6700\u7ec8\u8fc7\u6ee4\nfiltered_ds = scored_ds.filter(lambda row: row[\"aesthetic_score\"] &gt; 4_5)\nfiltered_ds.write_webdataset(\"s3://clean-bucket/\")\n</code></pre>"},{"location":"chapter3/3_1/#6_4-pitfalls-troubleshooting","title":"6_4 \u907f\u5751\u6307\u5357 (Pitfalls &amp; Troubleshooting)","text":"<p>\u5728\u6784\u5efa\u4ebf\u7ea7\u591a\u6a21\u6001\u6570\u636e\u96c6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5de5\u7a0b\u56e2\u961f\u5f80\u5f80\u4f1a\u5728\u7ec6\u8282\u5904\u7ffb\u8f66\u3002\u4ee5\u4e0b\u662f\u51e0\u4e2a\u8840\u6cea\u6559\u8bad\u603b\u7ed3\uff1a</p> <ul> <li> <p>Parquet \u5143\u6570\u636e\u7206\u70b8\uff1a</p> <ul> <li>\u9519\u8bef\uff1a\u4e60\u60ef\u6027\u5730\u5728 pandas \u4e2d\u76f4\u63a5\u8bfb\u53d6\u5305\u542b 20 \u4ebf\u884c\u7684 Parquet \u6587\u4ef6\u3002</li> <li>\u540e\u679c\uff1a\u5185\u5b58\u6ea2\u51fa\uff08OOM\uff09\uff0c\u56e0\u4e3a pandas \u4f1a\u5c1d\u8bd5\u5c06\u6574\u4e2a\u7d22\u5f15\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u5373\u4f7f\u4f60\u53ea\u8bfb\u4e00\u5217\u3002</li> <li>\u4fee\u6b63\uff1a\u4f7f\u7528 Polars \u6216 PySpark \u7684 lazy evaluation \u6a21\u5f0f\uff1b\u6216\u8005\u4e25\u683c\u5c06 Parquet \u6587\u4ef6\u6309\u884c\u6570\uff08\u5982 100\u4e07\u884c\uff09\u62c6\u5206\u6210\u5c0f\u6587\u4ef6\uff0c\u907f\u514d\u5904\u7406\u5355\u4e2a\u5de8\u578b\u5143\u6570\u636e\u6587\u4ef6\u3002</li> </ul> </li> <li> <p>WebDataset \u7684 Shuffle \u4e0d\u8db3\uff1a</p> <ul> <li>\u9519\u8bef\uff1a\u6570\u636e\u4e0b\u8f7d\u65f6\u6309\u57df\u540d\u987a\u5e8f\u5199\u5165\uff0c\u8bad\u7ec3\u65f6\u4ec5\u4f9d\u8d56 DataLoader \u7684 buffer shuffle\uff08\u901a\u5e38 buffer \u53ea\u6709 1\u4e07\uff09\u3002</li> <li>\u540e\u679c\uff1a\u6a21\u578b\u8bad\u7ec3\u65f6\u4f1a\u5148\u8fde\u7eed\u770b 10 \u4e07\u5f20\u7535\u5546\u56fe\uff0c\u518d\u8fde\u7eed\u770b 10 \u4e07\u5f20\u98ce\u666f\u56fe\u3002\u5c0f buffer \u65e0\u6cd5\u6253\u6563\u8fd9\u79cd\u201c\u65f6\u57df\u76f8\u5173\u6027\u201d\uff0c\u5bfc\u81f4\u6a21\u578b\u8bad\u7ec3\u66f2\u7ebf\u5267\u70c8\u9707\u8361\uff0c\u751a\u81f3\u53d1\u6563\u3002</li> <li>\u4fee\u6b63\uff1a\u5728\u5199\u5165 WebDataset \u4e4b\u524d\uff0c\u5fc5\u987b\u5bf9 URL \u5217\u8868\u8fdb\u884c\u5168\u5c40\u968f\u673a\u6253\u6563\uff08Global Shuffle\uff09\u3002\u53ef\u4ee5\u4f7f\u7528 Spark \u7684 <code>orderBy(rand())</code> \u5b9e\u73b0\u3002</li> </ul> </li> <li> <p>\u8bef\u5220\u957f\u5c3e\u6570\u636e\uff1a</p> <ul> <li>\u9519\u8bef\uff1a\u4e3a\u4e86\u8ffd\u6c42\u6781\u81f4\u7684\u7f8e\u5b66\u5206\uff0c\u628a\u6240\u6709 Score &lt; 4_5 \u7684\u56fe\u7247\u90fd\u5220\u4e86\u3002</li> <li>\u540e\u679c\uff1a\u6a21\u578b\u53d8\u5f97\u201c\u504f\u79d1\u201d\uff0c\u53ea\u8ba4\u8bc6\u827a\u672f\u7167\u548c\u58c1\u7eb8\uff0c\u4e0d\u8ba4\u8bc6\u771f\u5b9e\u4e16\u754c\u7684\uff08\u53ef\u80fd\u6bd4\u8f83\u4e11\u7684\uff09\u7167\u7247\uff0c\u5982\u533b\u7597\u5f71\u50cf\u3001\u8857\u666f\u56fe\u3001\u624b\u5199\u7b14\u8bb0\u3002\u8fd9\u5927\u5927\u964d\u4f4e\u4e86\u6a21\u578b\u7684\u6cdb\u5316\u80fd\u529b\u3002</li> <li>\u4fee\u6b63\uff1a\u91c7\u7528\u5206\u5c42\u91c7\u6837\u7b56\u7565\u3002\u4fdd\u7559 5%-10% \u7684\u4f4e\u5206\u6570\u636e\u4f5c\u4e3a\u201c\u6b63\u5219\u5316\u201d\uff0c\u6216\u8005\u9488\u5bf9\u7279\u5b9a\u9886\u57df\uff08\u5982 OCR\u3001\u56fe\u8868\uff09\u5355\u72ec\u8bbe\u7acb\u767d\u540d\u5355\uff0c\u4e0d\u901a\u8fc7\u7f8e\u5b66\u8fc7\u6ee4\u5668\u3002</li> </ul> </li> <li> <p>\u91cd\u590d\u6570\u636e\u7684\u9690\u60a3 (Deduplication):</p> <ul> <li>\u9519\u8bef: \u5ffd\u89c6\u4e86\u4e92\u8054\u7f51\u4e0a\u5927\u91cf\u91cd\u590d\u56fe\u7247\uff08\u5982 Memes\u3001\u70ed\u95e8\u65b0\u95fb\u56fe\uff09\u3002</li> <li>\u540e\u679c: \u6a21\u578b\u8fc7\u62df\u5408\u7279\u5b9a\u6837\u672c\uff0c\u751a\u81f3\u5728\u751f\u6210\u65f6\u76f4\u63a5\u201c\u80cc\u8bf5\u201d\u51fa\u8bad\u7ec3\u96c6\u56fe\u7247\uff08Memorization\uff09\uff0c\u5bfc\u81f4\u4e25\u91cd\u7684\u7248\u6743\u98ce\u9669\u3002</li> <li>\u4fee\u6b63: \u5fc5\u987b\u5728\u6e05\u6d17\u6d41\u7a0b\u4e2d\u52a0\u5165\u8bed\u4e49\u53bb\u91cd\u3002\u8ba1\u7b97\u6240\u6709\u56fe\u7247\u7684 Embedding\uff0c\u4f7f\u7528 Faiss \u6216 MinHashLSH \u8fdb\u884c\u805a\u7c7b\uff0c\u5bf9\u76f8\u4f3c\u5ea6\u6781\u9ad8\u7684\u56fe\u7247\u7fa4\u7ec4\u53ea\u4fdd\u7559\u4e00\u5f20\u3002</li> </ul> </li> </ul>"},{"location":"chapter3/3_2/","title":"\u7b2c7\u7ae0\uff1a\u6570\u636e\u91cd\u63cf\u8ff0","text":""},{"location":"chapter3/3_2/#7-recaptioning","title":"\u7b2c7\u7ae0\uff1a\u6570\u636e\u91cd\u63cf\u8ff0 (Recaptioning)","text":""},{"location":"chapter3/3_2/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u4e92\u8054\u7f51\u4e0a\u7684\u539f\u59cb Alt-text\uff08\u66ff\u4ee3\u6587\u672c\uff09\uff0c\u672c\u8d28\u4e0a\u662f\u7f51\u9875\u5f00\u53d1\u8005\u4e3a\u641c\u7d22\u5f15\u64ce\u4f18\u5316\uff08SEO\uff09\u8bbe\u8ba1\u7684\u8f85\u52a9\u5185\u5bb9\uff0c\u5176\u6838\u5fc3\u76ee\u6807\u662f\u63d0\u5347\u7f51\u9875\u5728\u641c\u7d22\u7ed3\u679c\u4e2d\u7684\u6392\u540d\uff0c\u800c\u975e\u7cbe\u51c6\u3001\u5168\u9762\u5730\u63cf\u8ff0\u56fe\u50cf\u672c\u8eab\u7684\u89c6\u89c9\u5185\u5bb9\u2014\u2014\u8fd9\u5c31\u5bfc\u81f4\u5927\u91cf\u539f\u59cb Alt-text \u65e0\u6cd5\u6ee1\u8db3\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\uff08VLM\uff09\u8bad\u7ec3\u5bf9\u201c\u89c6\u89c9-\u6587\u672c\u7cbe\u51c6\u5bf9\u9f50\u201d\u7684\u6838\u5fc3\u9700\u6c42\u3002\u672c\u7ae0\u5c06\u7cfb\u7edf\u4ecb\u7ecd\u5982\u4f55\u5229\u7528\u5f53\u524d\u4e3b\u6d41\u7684\u89c6\u89c9\u5927\u6a21\u578b\uff08Visual Language Model, VLM\uff09\u6784\u5efa\u4e00\u5957\u9ad8\u6548\u3001\u53ef\u6269\u5c55\u7684\u201c\u5408\u6210\u63cf\u8ff0\u5de5\u5382\u201d\uff0c\u5b9e\u73b0\u5927\u89c4\u6a21\u56fe\u50cf\u6570\u636e\u7684\u81ea\u52a8\u91cd\u6807\u6ce8\u3002\u6211\u4eec\u5c06\u6df1\u5165\u63a2\u8ba8 Prompt Engineering\uff08\u63d0\u793a\u5de5\u7a0b\uff09\u5728\u7cbe\u51c6\u63a7\u5236\u63cf\u8ff0\u9897\u7c92\u5ea6\uff08\u4ece\u7b80\u7565\u5230\u8be6\u5c3d\uff09\u4e2d\u7684\u5173\u952e\u4f5c\u7528\uff0c\u7834\u89e3\u4e0d\u540c\u4e0b\u6e38\u4efb\u52a1\u5bf9\u63cf\u8ff0\u7cbe\u5ea6\u7684\u5dee\u5f02\u5316\u9700\u6c42\uff0c\u5e76\u5f15\u5165\u5149\u5b66\u5b57\u7b26\u8bc6\u522b\uff08OCR\uff09\u6280\u672f\u4f5c\u4e3a\u8865\u5145\uff0c\u89e3\u51b3 VLM \u5bf9\u5bcc\u6587\u672c\u56fe\u50cf\uff08\u5982\u6587\u6863\u3001\u6d77\u62a5\u3001\u56fe\u8868\uff09\u4e2d\u6587\u5b57\u4fe1\u606f\u8bc6\u522b\u4e0d\u51c6\u7684\u75db\u70b9\uff0c\u8fdb\u4e00\u6b65\u589e\u5f3a\u6a21\u578b\u5bf9\u590d\u6742\u56fe\u50cf\u7684\u7406\u89e3\u80fd\u529b\u3002</p> <p>\u5b66\u4e60\u76ee\u6807\uff1a * \u6df1\u523b\u7406\u89e3 Alt-text \u7684\u201c\u4e09\u5b97\u7f6a\u201d\uff08\u4e0d\u76f8\u5173\u3001\u8fc7\u77ed\u3001\u89c6\u89c9\u7f3a\u5931\uff09\u7684\u672c\u8d28\u6210\u56e0\uff0c\u4ee5\u53ca\u8fd9\u7c7b\u4f4e\u8d28\u91cf\u63cf\u8ff0\u5bf9\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\u3001\u751f\u6210\u5f0f\u89c6\u89c9\u6a21\u578b\u8bad\u7ec3\u7684\u5177\u4f53\u5371\u5bb3\uff08\u5982\u6a21\u578b\u5e7b\u89c9\u3001\u89c6\u89c9-\u6587\u672c\u5bf9\u9f50\u5931\u6548\u3001\u6cdb\u5316\u80fd\u529b\u4e0d\u8db3\u7b49\uff09\u3002 * \u638c\u63e1\u4f7f\u7528 vLLM\uff08\u9ad8\u6548\u5927\u6a21\u578b\u63a8\u7406\u5f15\u64ce\uff09\u90e8\u7f72 LLaVA\u3001CogVLM \u7b49\u4e3b\u6d41 VLM \u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u7406\u89e3\u9ad8\u541e\u5410\u91cf\u63a8\u7406\u7684\u6838\u5fc3\u539f\u7406\uff0c\u5b9e\u73b0\u5927\u89c4\u6a21\u56fe\u50cf\u6570\u636e\u7684\u5feb\u901f\u91cd\u6807\u6ce8\u3002 * \u80fd\u591f\u6839\u636e\u4e0d\u540c\u4e0b\u6e38\u4efb\u52a1\uff08\u5982 CLIP \u7c7b\u53cc\u5854\u6a21\u578b\u9884\u8bad\u7ec3\u3001Sora \u7c7b\u751f\u6210\u6a21\u578b\u8bad\u7ec3\uff09\u8bbe\u8ba1\u5206\u5c42 Prompt \u7b56\u7565\uff0c\u7075\u6d3b\u751f\u6210\u7b80\u7565\u6216\u8be6\u5c3d\u7684\u56fe\u50cf\u63cf\u8ff0\uff0c\u7cbe\u51c6\u5339\u914d\u4efb\u52a1\u9700\u6c42\u3002 * \u638c\u63e1 OCR \u6280\u672f\u7684\u6838\u5fc3\u5e94\u7528\u65b9\u6cd5\uff0c\u5b9e\u73b0 OCR \u8bc6\u522b\u7ed3\u679c\u4e0e VLM Prompt \u7684\u52a8\u6001\u878d\u5408\uff0c\u89e3\u51b3\u6587\u6863\u7c7b\u3001\u6d77\u62a5\u7c7b\u7b49\u5bcc\u6587\u672c\u56fe\u50cf\u63cf\u8ff0\u8d28\u91cf\u4f4e\u4e0b\u7684\u95ee\u9898\uff0c\u663e\u8457\u63d0\u5347\u8fd9\u7c7b\u56fe\u50cf\u7684\u63cf\u8ff0\u51c6\u786e\u6027\u548c\u4e30\u5bcc\u5ea6\u3002</p> <p>\u573a\u666f\u5f15\u5165\uff1a</p> <p>\u201c\u60f3\u8c61\u4f60\u6b63\u5728\u8bad\u7ec3\u4e00\u4e2a\u7c7b Sora \u7684\u6a21\u578b\u3002\u4f60\u7ed9\u6a21\u578b\u8f93\u5165\u4e86\u4e00\u5f20\u56fe\uff0c\u4e0a\u9762\u662f\u4e00\u53ea\u5728\u5915\u9633\u4e0b\u5954\u8dd1\u7684\u91d1\u6bdb\u72ac\uff0c\u80cc\u666f\u662f\u57c3\u83f2\u5c14\u94c1\u5854\u3002\u7136\u800c\uff0c\u539f\u59cb\u6570\u636e\u7684\u6807\u7b7e\u5374\u662f\u2018IMG_20240501.jpg\u2019\u6216\u8005\u2018Best dog food 50% off\u2019\u3002\u7528\u8fd9\u79cd\u6570\u636e\u8bad\u7ec3\uff0c\u6a21\u578b\u6c38\u8fdc\u5b66\u4e0d\u4f1a\u2018\u91d1\u6bdb\u72ac\u2019\u548c\u2018\u57c3\u83f2\u5c14\u94c1\u5854\u2019\u7684\u89c6\u89c9\u5bf9\u5e94\u5173\u7cfb\uff0c\u66f4\u522b\u63d0\u7406\u89e3\u2018\u5915\u9633\u4e0b\u7684\u5149\u5f71\u2019\u4e86\u3002\u6211\u4eec\u9700\u8981\u901a\u8fc7\u2018\u6570\u636e\u91cd\u63cf\u8ff0\u2019\uff0c\u8ba9 AI \u5145\u5f53\u6807\u6ce8\u5458\uff0c\u628a\u8fd9\u53ea\u72d7\u548c\u94c1\u5854\u51c6\u786e\u5730\u5199\u8fdb\u6587\u672c\u91cc\u3002\u201d</p>"},{"location":"chapter3/3_2/#7_1-alt-text","title":"7_1 Alt-text \u7684\u5c40\u9650\u6027\uff1a\u4e3a\u4ec0\u4e48\u539f\u59cb\u7f51\u9875\u63cf\u8ff0\u4e0d\u53ef\u7528\uff1f","text":"<p>\u5728\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\u548c\u751f\u6210\u5f0f\u89c6\u89c9\u6a21\u578b\u7684\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\uff0c\u6570\u636e\u8d28\u91cf\u76f4\u63a5\u51b3\u5b9a\u6a21\u578b\u7684\u4e0a\u9650\u2014\u2014\u800c\u539f\u59cb\u7f51\u9875\u4e2d\u7684 Alt-text\uff0c\u6070\u6070\u662f\u4f4e\u8d28\u91cf\u89c6\u89c9\u6587\u672c\u6570\u636e\u7684\u4e3b\u8981\u6765\u6e90\u4e4b\u4e00\u3002\u6839\u636e DeepMind\uff08\u300aScaling Language-Image Pre-training with Weakly Supervised Image-Text Data\u300b\uff09\u548c OpenAI\uff08\u300aTraining language models to follow instructions with human feedback\u300b\uff09\u7684\u5185\u90e8\u7814\u7a76\u62a5\u544a\uff0c\u76f4\u63a5\u4f7f\u7528\u4e92\u8054\u7f51\u722c\u53d6\u7684\u539f\u59cb Alt-text \u4f5c\u4e3a\u8bad\u7ec3\u6570\u636e\uff0c\u4f1a\u5bfc\u81f4\u6a21\u578b\u6027\u80fd\u63d0\u524d\u201c\u5c01\u9876\u201d\uff08\u5373\u65e0\u8bba\u5982\u4f55\u589e\u52a0\u6570\u636e\u91cf\uff0c\u6a21\u578b\u7684\u89c6\u89c9\u7406\u89e3\u3001\u6587\u672c\u751f\u6210\u7cbe\u5ea6\u90fd\u65e0\u6cd5\u8fdb\u4e00\u6b65\u63d0\u5347\uff09\uff0c\u751a\u81f3\u51fa\u73b0\u6027\u80fd\u9000\u5316\u3002\u5176\u6838\u5fc3\u95ee\u9898\u53ef\u6982\u62ec\u4e3a\u201c\u4e09\u5b97\u7f6a\u201d\uff0c\u5177\u4f53\u5206\u6790\u5982\u4e0b\uff1a</p> <ul> <li>\u566a\u58f0\u6781\u5927\uff1a\u5927\u91cf Alt-text \u4ec5\u5305\u542b\u6587\u4ef6\u540d\uff08\u5982\u201cIMG_20240501.jpg\u201d\uff09\u3001\u65e5\u671f\u3001\u65e0\u5173\u7684 SEO \u5173\u952e\u8bcd\u5806\u780c\uff08\u5982 \"buy cheap shoes nike adidas\"\u201cbest coffee shop near me\u201d\uff09\uff0c\u8fd9\u7c7b\u63cf\u8ff0\u4e0e\u56fe\u50cf\u89c6\u89c9\u5185\u5bb9\u5b8c\u5168\u65e0\u5173\u3002\u82e5\u5c06\u5176\u7528\u4e8e\u8bad\u7ec3\uff0c\u4e0d\u4ec5\u65e0\u6cd5\u5e2e\u52a9\u6a21\u578b\u5efa\u7acb\u89c6\u89c9-\u6587\u672c\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u8fd8\u4f1a\u6c61\u67d3\u6a21\u578b\u7684\u8bed\u8a00\u80fd\u529b\uff0c\u5bfc\u81f4\u6a21\u578b\u751f\u6210\u65e0\u5173\u3001\u5197\u4f59\u7684\u6587\u672c\uff0c\u751a\u81f3\u4ea7\u751f\u4e25\u91cd\u7684\u5e7b\u89c9\u3002</li> <li>\u89c6\u89c9\u7f3a\u5931\uff1aAlt-text \u7684\u8bbe\u8ba1\u521d\u8877\u591a\u662f\u8f85\u52a9\u7f51\u9875\u529f\u80fd\u5b9e\u73b0\uff0c\u800c\u975e\u63cf\u8ff0\u89c6\u89c9\u5185\u5bb9\u2014\u2014\u5b83\u5f80\u5f80\u53ea\u63cf\u8ff0\u56fe\u7247\u7684\u529f\u80fd\uff08\u5982\u201c\u70b9\u51fb\u8d2d\u4e70\u6309\u94ae\u201d\u201c\u67e5\u770b\u66f4\u591a\u8be6\u60c5\u201d\uff09\u6216\u5546\u4e1a\u5c5e\u6027\uff08\u5982\u201c\u7ea2\u8272 XL \u7801\u201d\u201c\u9650\u65f6\u6298\u6263\u201d\uff09\uff0c\u5374\u5b8c\u5168\u5ffd\u7565\u56fe\u50cf\u672c\u8eab\u7684\u89c6\u89c9\u7ec6\u8282\uff08\u5982\u7269\u4f53\u7684\u5f62\u6001\u3001\u989c\u8272\u3001\u7eb9\u7406\u3001\u7a7a\u95f4\u5173\u7cfb\u3001\u5149\u5f71\u6548\u679c\u7b49\uff09\u3002\u4f8b\u5982\uff0c\u4e00\u5f20\u5c55\u793a\u201c\u4e00\u4ef6\u7ea2\u8272\u7684\u7eaf\u68c9 T \u6064\uff0c\u80f8\u53e3\u5370\u7740\u767d\u8272\u7684\u590d\u53e4 Logo\uff0c\u5e73\u94fa\u5728\u6728\u8d28\u684c\u9762\u4e0a\u201d\u7684\u56fe\u7247\uff0c\u5176 Alt-text \u53ef\u80fd\u4ec5\u4e3a\u201c\u7ea2\u8272 T \u6064 \u4fc3\u9500\u201d\uff0c\u8fd9\u79cd\u63cf\u8ff0\u65e0\u6cd5\u8ba9\u6a21\u578b\u5b66\u4e60\u5230\u4efb\u4f55\u89c6\u89c9\u7279\u5f81\u3002</li> <li>\u957f\u5ea6\u8fc7\u77ed\uff1a\u6839\u636e Common Crawl\uff08\u5168\u7403\u6700\u5927\u7684\u7f51\u9875\u722c\u53d6\u6570\u636e\u96c6\uff09\u7684\u7edf\u8ba1\u6570\u636e\uff0c\u8d85\u8fc7 50% \u7684 Alt-text \u957f\u5ea6\u5c0f\u4e8e 5 \u4e2a\u5355\u8bcd\uff0c30% \u751a\u81f3\u4e0d\u8db3 3 \u4e2a\u5355\u8bcd\u3002\u8fd9\u79cd\u6781\u77ed\u7684\u63cf\u8ff0\u65e0\u6cd5\u627f\u8f7d\u590d\u6742\u7684\u89c6\u89c9\u903b\u8f91\u3001\u7a7a\u95f4\u5173\u7cfb\u548c\u7ec6\u8282\u4fe1\u606f\uff0c\u4f8b\u5982\u65e0\u6cd5\u63cf\u8ff0\u201c\u4e00\u53ea\u91d1\u6bdb\u72ac\u8db4\u5728\u8349\u5730\u4e0a\uff0c\u524d\u722a\u642d\u5728\u4e00\u4e2a\u7ea2\u8272\u76ae\u7403\u4e0a\uff0c\u80cc\u666f\u662f\u5f00\u6ee1\u91ce\u82b1\u7684\u5c71\u5761\u201d\u8fd9\u7c7b\u5305\u542b\u591a\u4e2a\u7269\u4f53\u3001\u573a\u666f\u548c\u4e92\u52a8\u5173\u7cfb\u7684\u56fe\u50cf\u3002</li> </ul> <p>\u91cd\u63cf\u8ff0\u7684\u4ef7\u503c\uff1a\u6570\u636e\u91cd\u63cf\u8ff0\uff08Recaptioning\uff09\u7684\u6838\u5fc3\u4ef7\u503c\uff0c\u5c31\u662f\u901a\u8fc7 AI \u81ea\u52a8\u751f\u6210\u201c\u89c6\u89c9-\u6587\u672c\u7cbe\u51c6\u5bf9\u9f50\u201d\u7684\u9ad8\u8d28\u91cf\u63cf\u8ff0\uff0c\u66ff\u4ee3\u4f4e\u8d28\u91cf\u7684\u539f\u59cb Alt-text\uff0c\u6253\u7834\u6a21\u578b\u6027\u80fd\u7684\u4e0a\u9650\u3002\u8fd9\u4e00\u70b9\u5df2\u88ab\u4e1a\u754c\u9876\u7ea7\u7814\u7a76\u8bc1\u5b9e\u2014\u2014OpenAI \u5728 DALL-E 3 \u7684\u8bba\u6587\uff08\u300aDALL\u00b7E 3: Scaling Autoregressive Image Generation with Improved Alignment\u300b\uff09\u4e2d\u660e\u786e\u6307\u51fa\uff0c\u4f7f\u7528\u9ad8\u8fbe 95% \u7684\u5408\u6210\u957f\u6587\u672c\uff08Synthetic Captions\uff0c\u5373\u901a\u8fc7 VLM \u751f\u6210\u7684\u91cd\u63cf\u8ff0\u6587\u672c\uff09\u8fdb\u884c\u8bad\u7ec3\uff0c\u662f\u5176\u6307\u4ee4\u9075\u5faa\u80fd\u529b\u3001\u89c6\u89c9\u8fd8\u539f\u7cbe\u5ea6\u5927\u5e45\u8d85\u8d8a Stable Diffusion XL\uff08SDXL\uff09\u7684\u6838\u5fc3\u539f\u56e0\u4e4b\u4e00\u3002\u5408\u6210\u957f\u6587\u672c\u80fd\u591f\u7cbe\u51c6\u6355\u6349\u56fe\u50cf\u7684\u89c6\u89c9\u7ec6\u8282\u3001\u903b\u8f91\u5173\u7cfb\u548c\u573a\u666f\u6c1b\u56f4\uff0c\u8ba9\u6a21\u578b\u771f\u6b63\u5b66\u4f1a\u201c\u770b\u5230\u4ec0\u4e48\uff0c\u5c31\u63cf\u8ff0\u4ec0\u4e48\u201d\uff0c\u8fdb\u800c\u63d0\u5347\u540e\u7eed\u7684\u751f\u6210\u3001\u8bc6\u522b\u3001\u7406\u89e3\u80fd\u529b\u3002</p>"},{"location":"chapter3/3_2/#7_2-vlm","title":"7_2 \u5408\u6210\u63cf\u8ff0\u5de5\u5382\uff1a\u5229\u7528 VLM \u91cd\u751f\u6570\u636e","text":"<p>\u8981\u5b9e\u73b0\u5927\u89c4\u6a21\u56fe\u50cf\u6570\u636e\u7684\u91cd\u63cf\u8ff0\uff0c\u5355\u9760\u4eba\u5de5\u6807\u6ce8\u4e0d\u4ec5\u6210\u672c\u6781\u9ad8\uff08\u6bcf\u6807\u6ce8\u4e00\u5f20\u56fe\u50cf\u9700\u6570\u5206\u949f\uff0c\u5927\u89c4\u6a21\u6570\u636e\u96c6\u52a8\u8f84\u6570\u767e\u4e07\u3001\u6570\u5341\u4ebf\u5f20\u56fe\u50cf\uff09\uff0c\u8fd8\u5b58\u5728\u6807\u6ce8\u6807\u51c6\u4e0d\u7edf\u4e00\u3001\u6548\u7387\u4f4e\u4e0b\u7684\u95ee\u9898\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u5efa\u7acb\u4e00\u4e2a\u7531 VLM \u9a71\u52a8\u7684\u201c\u5408\u6210\u63cf\u8ff0\u5de5\u5382\u201d\u2014\u2014\u4ee5\u539f\u59cb\u56fe\u50cf\u4e3a\u8f93\u5165\uff0c\u4ee5\u9ad8\u8d28\u91cf\u3001\u6807\u51c6\u5316\u7684\u6587\u672c\u63cf\u8ff0\u4e3a\u8f93\u51fa\uff0c\u901a\u8fc7\u81ea\u52a8\u5316\u3001\u6279\u91cf\u5316\u7684\u65b9\u5f0f\u5b8c\u6210\u6570\u636e\u91cd\u6807\u6ce8\uff0c\u5b9e\u73b0\u6570\u636e\u4ef7\u503c\u7684\u201c\u91cd\u751f\u201d\u3002</p> <p>\u8fd9\u4e2a\u201c\u5de5\u5382\u201d\u7684\u6838\u5fc3\u903b\u8f91\u7684\u662f\uff1a\u5c06\u539f\u59cb\u56fe\u50cf\u8f93\u5165\u5230\u4f18\u5316\u540e\u7684 VLM \u4e2d\uff0c\u901a\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\u7684 Prompt \u63a7\u5236\u63cf\u8ff0\u7684\u9897\u7c92\u5ea6\u548c\u98ce\u683c\uff0c\u518d\u901a\u8fc7\u9ad8\u6548\u7684\u63a8\u7406\u5f15\u64ce\u63d0\u5347\u5904\u7406\u541e\u5410\u91cf\uff0c\u6700\u7ec8\u8f93\u51fa\u7b26\u5408\u4e0b\u6e38\u4efb\u52a1\u9700\u6c42\u7684\u9ad8\u8d28\u91cf\u63cf\u8ff0\u3002\u6574\u4e2a\u6d41\u7a0b\u53ef\u5206\u4e3a\u201c\u6a21\u578b\u9009\u578b\u4e0e\u67b6\u6784\u8bbe\u8ba1\u201d\u201cPrompt \u7b56\u7565\u4f18\u5316\u201d\u201c\u5de5\u7a0b\u5316\u90e8\u7f72\u201d\u4e09\u4e2a\u6838\u5fc3\u73af\u8282\u3002</p>"},{"location":"chapter3/3_2/#7_21","title":"7_2.1 \u6a21\u578b\u9009\u578b\u4e0e\u67b6\u6784","text":"<p>VLM \u7684\u67b6\u6784\u76f4\u63a5\u51b3\u5b9a\u4e86\u63cf\u8ff0\u7684\u8d28\u91cf\u3001\u901f\u5ea6\u548c\u9002\u7528\u573a\u666f\u3002\u76ee\u524d\u4e3b\u6d41\u7684 VLM \u67b6\u6784\u4e3b\u8981\u5206\u4e3a\u4e09\u7c7b\uff0c\u5404\u7c7b\u67b6\u6784\u7684\u4ee3\u8868\u6a21\u578b\u3001\u4f18\u52a3\u5bf9\u6bd4\u53ca\u63a8\u8350\u573a\u666f\u5982\u4e0b\u8868\u6240\u793a\uff0c\u53ef\u6839\u636e\u4e0b\u6e38\u4efb\u52a1\u7684\u9700\u6c42\uff08\u5982\u63cf\u8ff0\u7cbe\u5ea6\u3001\u5904\u7406\u901f\u5ea6\u3001\u6570\u636e\u7c7b\u578b\uff09\u7075\u6d3b\u9009\u578b\uff1a</p> \u6a21\u578b\u67b6\u6784 \u4ee3\u8868\u6a21\u578b \u4f18\u52bf \u52a3\u52bf \u63a8\u8350\u573a\u666f Q-Former\u8fde\u63a5 BLIP-2, InstructBLIP \u53c2\u6570\u91cf\u5c0f\uff08\u901a\u5e38\u4e3a\u6570\u5341\u4ebf\u53c2\u6570\uff0c\u8fdc\u4f4e\u4e8e\u5927\u8bed\u8a00\u6a21\u578b\uff09\uff0c\u63a8\u7406\u901f\u5ea6\u5feb\uff08\u5355\u5f20\u56fe\u50cf\u63a8\u7406\u8017\u65f6\u53ef\u4f4e\u81f3\u51e0\u5341\u6beb\u79d2\uff09\uff0c\u8bad\u7ec3\u548c\u90e8\u7f72\u6210\u672c\u4f4e\uff0c\u4e0d\u6613\u4ea7\u751f\u6587\u672c\u5e7b\u89c9\uff08\u63cf\u8ff0\u5185\u5bb9\u4e0e\u56fe\u50cf\u7684\u8d34\u5408\u5ea6\u8f83\u9ad8\uff09 \u63cf\u8ff0\u957f\u5ea6\u8f83\u77ed\uff0c\u7ec6\u8282\u6355\u6349\u80fd\u529b\u4e00\u822c\uff0c\u5bb9\u6613\u51fa\u73b0\u201c\u590d\u8bfb\u5f0f\u63cf\u8ff0\u201d\uff08\u91cd\u590d\u63d0\u53ca\u5c11\u91cf\u6838\u5fc3\u7269\u4f53\uff0c\u7f3a\u4e4f\u7ec6\u8282\u5ef6\u4f38\uff09\uff0c\u5bf9\u590d\u6742\u573a\u666f\u7684\u7406\u89e3\u80fd\u529b\u6709\u9650 \u5feb\u901f\u521d\u7b5b\u5927\u89c4\u6a21\u56fe\u50cf\uff08\u5982\u5148\u5bf9\u6570\u5341\u4ebf\u5f20\u56fe\u50cf\u8fdb\u884c\u7c97\u7565\u91cd\u63cf\u8ff0\uff0c\u7b5b\u9009\u51fa\u6709\u4ef7\u503c\u7684\u6570\u636e\uff09\uff0c\u6216\u751f\u6210\u7b80\u77ed\u7684 Alt-text \u66ff\u4ee3\u54c1\uff08\u9002\u7528\u4e8e\u5bf9\u63cf\u8ff0\u957f\u5ea6\u6709\u4e25\u683c\u9650\u5236\u7684\u573a\u666f\uff09 MLP\u6295\u5f71 + LLM LLaVA-1_6 / NeXT \u63cf\u8ff0\u6781\u5176\u8be6\u5c3d\uff0c\u80fd\u591f\u6355\u6349\u56fe\u50cf\u4e2d\u7684\u7ec6\u5fae\u7ec6\u8282\uff08\u5982\u5149\u5f71\u3001\u7eb9\u7406\u3001\u7269\u4f53\u4e92\u52a8\u5173\u7cfb\uff09\uff0c\u6307\u4ee4\u9075\u5faa\u80fd\u529b\u5f3a\uff08\u80fd\u7cbe\u51c6\u54cd\u5e94 Prompt \u4e2d\u7684\u8981\u6c42\uff0c\u5982\u201c\u6309\u573a\u666f\u987a\u5e8f\u63cf\u8ff0\u201d\u201c\u7a81\u51fa\u6838\u5fc3\u7269\u4f53\u201d\uff09\uff0c\u652f\u6301\u591a\u8f6e\u5bf9\u8bdd\uff08\u53ef\u901a\u8fc7\u591a\u8f6e Prompt \u4f18\u5316\u63cf\u8ff0\u8d28\u91cf\uff09 \u903b\u8f91\u8ba1\u7b97\u91cf\u5927\uff08\u9700\u4f9d\u8d56 7B \u53ca\u4ee5\u4e0a\u53c2\u6570\u91cf\u7684\u5927\u8bed\u8a00\u6a21\u578b\uff0c\u5982 LLaMA 2 7B/13B\uff09\uff0c\u63a8\u7406\u901f\u5ea6\u76f8\u5bf9\u8f83\u6162\uff0c\u82e5\u4e0d\u52a0 Prompt \u7ea6\u675f\u5bb9\u6613\u51fa\u73b0\u5570\u55e6\u3001\u5197\u4f59\u7684\u63cf\u8ff0 \u4e3b\u529b\u6a21\u578b\uff0c\u9002\u7528\u4e8e\u751f\u6210\u9ad8\u8d28\u91cf\u3001\u957f\u6587\u672c\u7684 Dense Caption\uff08\u5bc6\u96c6\u63cf\u8ff0\uff09\uff0c\u5982\u8bad\u7ec3 Sora \u7c7b\u751f\u6210\u6a21\u578b\u3001SD3 \u7b49\u56fe\u50cf\u751f\u6210\u6a21\u578b\uff0c\u9700\u8981\u7cbe\u51c6\u3001\u8be6\u5c3d\u7684\u89c6\u89c9-\u6587\u672c\u5bf9\u9f50\u6570\u636e\u7684\u573a\u666f \u89c6\u89c9\u4f18\u5148\u67b6\u6784 CogVLM, Qwen-VL \u89c6\u89c9\u5206\u8fa8\u7387\u9ad8\uff08\u652f\u6301\u9ad8\u6e05\u56fe\u50cf\u8f93\u5165\uff0c\u90e8\u5206\u6a21\u578b\u53ef\u652f\u6301 4K \u56fe\u50cf\uff09\uff0c\u64c5\u957f\u7ec6\u7c92\u5ea6\u7269\u4f53\u8bc6\u522b\uff0c\u5c24\u5176\u5bf9\u5bcc\u6587\u672c\u56fe\u50cf\uff08\u5982\u6587\u6863\u3001\u56fe\u8868\u3001UI \u622a\u56fe\uff09\u4e2d\u7684\u6587\u5b57\u3001\u5c0f\u90e8\u4ef6\uff08\u5982\u6309\u94ae\u3001\u8f93\u5165\u6846\uff09\u8bc6\u522b\u7cbe\u5ea6\u6781\u9ad8\uff0c\u80fd\u591f\u7406\u89e3\u6587\u672c\u4e0e\u89c6\u89c9\u5143\u7d20\u7684\u5173\u8054 \u663e\u5b58\u5360\u7528\u8f83\u9ad8\uff08\u90e8\u7f72 7B \u53c2\u6570\u91cf\u6a21\u578b\u9700\u81f3\u5c11 24GB \u663e\u5b58\uff09\uff0c\u67b6\u6784\u975e\u6807\u51c6\uff08\u4e0d\u540c\u6a21\u578b\u7684\u90e8\u7f72\u65b9\u5f0f\u5dee\u5f02\u8f83\u5927\uff09\uff0c\u90e8\u7f72\u6d41\u7a0b\u7a0d\u7e41\u7410\uff0c\u63a8\u7406\u901f\u5ea6\u4e2d\u7b49 \u4e13\u95e8\u5904\u7406\u6587\u6863\u3001\u56fe\u8868\u3001UI \u622a\u56fe\u3001\u6d77\u62a5\u7b49\u5bcc\u6587\u672c\u6570\u636e\uff0c\u5982\u8bad\u7ec3\u80fd\u591f\u751f\u6210\u6587\u6863\u56fe\u50cf\u3001UI \u754c\u9762\u7684\u6a21\u578b\uff0c\u6216\u9700\u8981\u7cbe\u51c6\u8bc6\u522b\u56fe\u50cf\u4e2d\u6587\u5b57\u4fe1\u606f\u7684\u573a\u666f <p>\u8865\u5145\u8bf4\u660e\uff1a\u4e09\u7c7b\u67b6\u6784\u7684\u6838\u5fc3\u5dee\u5f02\u5728\u4e8e\u201c\u89c6\u89c9\u6a21\u5757\u4e0e\u8bed\u8a00\u6a21\u5757\u7684\u8fde\u63a5\u65b9\u5f0f\u201d\uff1aQ-Former \u67b6\u6784\u901a\u8fc7\u4e13\u95e8\u7684 Q-Former \u6a21\u5757\u5c06\u89c6\u89c9\u7279\u5f81\u8f6c\u6362\u4e3a\u8bed\u8a00\u53ef\u7406\u89e3\u7684\u5411\u91cf\uff0c\u518d\u8f93\u5165\u5230\u8f7b\u91cf\u8bed\u8a00\u6a21\u578b\uff1bMLP \u6295\u5f71\u67b6\u6784\u901a\u8fc7\u591a\u5c42\u611f\u77e5\u673a\uff08MLP\uff09\u5c06\u89c6\u89c9\u7279\u5f81\u6295\u5f71\u5230\u8bed\u8a00\u6a21\u578b\u7684\u5d4c\u5165\u7a7a\u95f4\uff0c\u4e0e\u5927\u8bed\u8a00\u6a21\u578b\u6df1\u5ea6\u878d\u5408\uff1b\u89c6\u89c9\u4f18\u5148\u67b6\u6784\u5219\u5f3a\u5316\u4e86\u89c6\u89c9\u6a21\u5757\u7684\u5206\u8fa8\u7387\u548c\u8bc6\u522b\u80fd\u529b\uff0c\u5f31\u5316\u4e86\u8bed\u8a00\u6a21\u5757\u7684\u5197\u4f59\u8ba1\u7b97\uff0c\u66f4\u4fa7\u91cd\u201c\u89c6\u89c9\u7406\u89e3\u4f18\u5148\u201d\u3002</p>"},{"location":"chapter3/3_2/#7_22-prompt","title":"7_2.2 Prompt \u7b56\u7565\uff1a\u63a7\u5236\u9897\u7c92\u5ea6","text":"<p>Prompt Engineering \u662f\u201c\u5408\u6210\u63cf\u8ff0\u5de5\u5382\u201d\u7684\u201c\u6838\u5fc3\u63a7\u5236\u5668\u201d\u2014\u2014\u540c\u4e00\u4e2a VLM\uff0c\u5728\u4e0d\u540c Prompt \u7684\u5f15\u5bfc\u4e0b\uff0c\u4f1a\u751f\u6210\u622a\u7136\u4e0d\u540c\u7684\u6570\u636e\u5206\u5e03\uff08\u63cf\u8ff0\u957f\u5ea6\u3001\u7ec6\u8282\u4e30\u5bcc\u5ea6\u3001\u98ce\u683c\u7b49\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u4e0b\u6e38\u4efb\u52a1\u7684\u5177\u4f53\u9700\u6c42\uff0c\u8bbe\u8ba1\u5206\u5c42 Prompt \u7b56\u7565\uff0c\u7cbe\u51c6\u63a7\u5236\u63cf\u8ff0\u7684\u9897\u7c92\u5ea6\uff0c\u8ba9\u751f\u6210\u7684\u63cf\u8ff0\u80fd\u591f\u5b8c\u7f8e\u5339\u914d\u4efb\u52a1\u9700\u6c42\u3002</p> <p>\u6838\u5fc3\u539f\u5219\uff1aPrompt \u7684\u8bbe\u8ba1\u9700\u660e\u786e\u201c\u4efb\u52a1\u6307\u4ee4\u201d\u201c\u63cf\u8ff0\u8303\u56f4\u201d\u201c\u9897\u7c92\u5ea6\u8981\u6c42\u201d\uff0c\u907f\u514d\u6a21\u7cca\u8868\u8ff0\uff08\u5982\u4ec5\u7528\u201c\u63cf\u8ff0\u8fd9\u5f20\u56fe\u201d\u4f1a\u5bfc\u81f4\u6a21\u578b\u8f93\u51fa\u4e0d\u7a33\u5b9a\uff09\u3002\u540c\u65f6\uff0c\u53ef\u901a\u8fc7\u52a0\u5165\u201c\u7ea6\u675f\u6761\u4ef6\u201d\uff08\u5982\u201c\u4e0d\u8d85\u8fc7 20 \u4e2a\u5355\u8bcd\u201d\u201c\u7a81\u51fa\u6838\u5fc3\u7269\u4f53\u548c\u80cc\u666f\u201d\uff09\u8fdb\u4e00\u6b65\u4f18\u5316\u8f93\u51fa\u8d28\u91cf\u3002</p> <p> \u56fe7-1\uff1a\u7b80\u7565\u4e0e\u8be6\u7ec6\u7684Prompt\u7b56\u7565</p> <p>\u56fe 7-1 \u76f4\u89c2\u5bf9\u6bd4\u4e86\u4e24\u79cd\u6838\u5fc3 Prompt \u7b56\u7565\u7684\u8f93\u51fa\u5dee\u5f02\u2014\u2014\u7b80\u7565 Prompt \u751f\u6210\u7684\u63cf\u8ff0\u7b80\u6d01\u7cbe\u70bc\uff0c\u4ec5\u5305\u542b\u6838\u5fc3\u7269\u4f53\u548c\u573a\u666f\uff1b\u8be6\u7ec6 Prompt \u751f\u6210\u7684\u63cf\u8ff0\u5219\u5305\u542b\u4e30\u5bcc\u7684\u7ec6\u8282\uff0c\u6db5\u76d6\u7269\u4f53\u5f62\u6001\u3001\u5149\u5f71\u3001\u989c\u8272\u3001\u7a7a\u95f4\u5173\u7cfb\u7b49\uff0c\u4e24\u79cd\u7b56\u7565\u5206\u522b\u9002\u914d\u4e0d\u540c\u7684\u4e0b\u6e38\u4efb\u52a1\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e24\u79cd\u6700\u5e38\u7528\u7684\u5206\u5c42 Prompt \u7b56\u7565\uff0c\u53ef\u6839\u636e\u5b9e\u9645\u9700\u6c42\u7075\u6d3b\u8c03\u6574\uff0c\u4e5f\u53ef\u5728\u6b64\u57fa\u7840\u4e0a\u8bbe\u8ba1\u4e2d\u7b49\u9897\u7c92\u5ea6\u7684 Prompt \u7b56\u7565\uff1a</p> <p>\u7b56\u7565\u4e00\uff1a\u7b80\u7565\u63cf\u8ff0 (Brief Caption) * Prompt: \"Describe this image concisely in one sentence.\"\uff08\u7b80\u6d01\u5730\u7528\u4e00\u53e5\u8bdd\u63cf\u8ff0\u8fd9\u5f20\u56fe\u50cf\u3002\uff09   \u8865\u5145\u4f18\u5316 Prompt\uff08\u589e\u5f3a\u7a33\u5b9a\u6027\uff09\uff1a\"Describe this image concisely in one sentence, focusing only on the main subject and key background, no redundant details.\"\uff08\u7b80\u6d01\u5730\u7528\u4e00\u53e5\u8bdd\u63cf\u8ff0\u8fd9\u5f20\u56fe\u50cf\uff0c\u4ec5\u5173\u6ce8\u6838\u5fc3\u7269\u4f53\u548c\u5173\u952e\u80cc\u666f\uff0c\u65e0\u5197\u4f59\u7ec6\u8282\u3002\uff09 * \u76ee\u7684: \u9002\u914d CLIP \u7b49\u53cc\u5854\u6a21\u578b\uff08\u89c6\u89c9-\u6587\u672c\u53cc\u5854\u67b6\u6784\uff09\u7684 Context Length \u9650\u5236\u2014\u2014\u8fd9\u7c7b\u6a21\u578b\u7684\u6587\u672c\u8f93\u5165\u957f\u5ea6\u901a\u5e38\u88ab\u9650\u5236\u5728 77 \u4e2a tokens \u4ee5\u5185\uff0c\u8fc7\u957f\u7684\u63cf\u8ff0\u4f1a\u88ab\u622a\u65ad\uff0c\u5bfc\u81f4\u6a21\u578b\u65e0\u6cd5\u6b63\u5e38\u5b66\u4e60\u3002\u540c\u65f6\uff0c\u4e5f\u9002\u7528\u4e8e\u5bf9\u63cf\u8ff0\u957f\u5ea6\u6709\u4e25\u683c\u8981\u6c42\u7684\u573a\u666f\uff08\u5982\u56fe\u50cf\u68c0\u7d22\u3001\u5feb\u901f\u6807\u6ce8\uff09\u3002 * \u9884\u671f\u8f93\u51fa: \"A golden retriever running on grass near the Eiffel Tower.\"\uff08\u4e00\u53ea\u91d1\u6bdb\u72ac\u5728\u57c3\u83f2\u5c14\u94c1\u5854\u9644\u8fd1\u7684\u8349\u5730\u4e0a\u5954\u8dd1\u3002\uff09   \u8f93\u51fa\u7279\u70b9\uff1a\u957f\u5ea6\u63a7\u5236\u5728 10-20 \u4e2a\u5355\u8bcd\uff0c\u4ec5\u5305\u542b\u6838\u5fc3\u7269\u4f53\uff08\u91d1\u6bdb\u72ac\uff09\u3001\u5173\u952e\u52a8\u4f5c\uff08\u5954\u8dd1\uff09\u548c\u6838\u5fc3\u80cc\u666f\uff08\u57c3\u83f2\u5c14\u94c1\u5854\u3001\u8349\u5730\uff09\uff0c\u65e0\u591a\u4f59\u7ec6\u8282\uff0c\u7b80\u6d01\u660e\u4e86\u3002</p> <p>\u7b56\u7565\u4e8c\uff1a\u8be6\u5c3d\u63cf\u8ff0 (Detailed Caption) * Prompt: \"Describe this image in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style. Mention any specific interactions between objects.\"\uff08\u6781\u5176\u8be6\u7ec6\u5730\u63cf\u8ff0\u8fd9\u5f20\u56fe\u50cf\u3002\u4ece\u6838\u5fc3\u7269\u4f53\u5f00\u59cb\uff0c\u7136\u540e\u63cf\u8ff0\u80cc\u666f\u3001\u5149\u7ebf\u3001\u989c\u8272\u548c\u827a\u672f\u98ce\u683c\u3002\u63d0\u53ca\u7269\u4f53\u4e4b\u95f4\u7684\u4efb\u4f55\u5177\u4f53\u4e92\u52a8\u5173\u7cfb\u3002\uff09   \u8865\u5145\u4f18\u5316 Prompt\uff08\u589e\u5f3a\u7ec6\u8282\u6355\u6349\uff09\uff1a\"Describe this image in extreme detail. First, describe the main subject's appearance (shape, color, texture), then the background scene, lighting effects (brightness, color temperature), color matching, and artistic style. Finally, mention the interactions between objects and the overall atmosphere of the image.\"\uff08\u6781\u5176\u8be6\u7ec6\u5730\u63cf\u8ff0\u8fd9\u5f20\u56fe\u50cf\u3002\u9996\u5148\u63cf\u8ff0\u6838\u5fc3\u7269\u4f53\u7684\u5916\u89c2\uff08\u5f62\u6001\u3001\u989c\u8272\u3001\u7eb9\u7406\uff09\uff0c\u7136\u540e\u63cf\u8ff0\u80cc\u666f\u573a\u666f\u3001\u5149\u7ebf\u6548\u679c\uff08\u4eae\u5ea6\u3001\u8272\u6e29\uff09\u3001\u8272\u5f69\u642d\u914d\u548c\u827a\u672f\u98ce\u683c\u3002\u6700\u540e\u63d0\u53ca\u7269\u4f53\u4e4b\u95f4\u7684\u4e92\u52a8\u5173\u7cfb\u548c\u56fe\u50cf\u7684\u6574\u4f53\u6c1b\u56f4\u3002\uff09 * \u76ee\u7684: \u9002\u914d GenAI \u6a21\u578b\uff08\u5982 Sora\u3001SD3\u3001Ideogram\uff09\u7684\u8bad\u7ec3\u9700\u6c42\u2014\u2014\u8fd9\u7c7b\u6a21\u578b\u9700\u8981\u901a\u8fc7\u8be6\u5c3d\u7684\u63cf\u8ff0\u5b66\u4e60\u5230\u56fe\u50cf\u7684\u7ec6\u8282\u7279\u5f81\u3001\u903b\u8f91\u5173\u7cfb\u548c\u573a\u666f\u6c1b\u56f4\uff0c\u624d\u80fd\u751f\u6210\u9ad8\u7cbe\u5ea6\u3001\u7b26\u5408\u6307\u4ee4\u7684\u56fe\u50cf\u3002\u540c\u65f6\uff0c\u4e5f\u9002\u7528\u4e8e\u9700\u8981\u7cbe\u51c6\u89c6\u89c9-\u6587\u672c\u5bf9\u9f50\u7684\u573a\u666f\uff08\u5982\u89c6\u89c9\u95ee\u7b54\u3001\u56fe\u50cf\u7f16\u8f91\uff09\u3002 * \u9884\u671f\u8f93\u51fa: \"A dynamic wide-angle shot of a fluffy golden retriever running joyfully across a green lawn. The dog's fur is illuminated by the warm, golden light of a setting sun, with some light brown strands glinting in the sunlight. Its ears flop backward as it runs, and its tail is raised high, showing a happy mood. In the blurred background, the iconic iron lattice structure of the Eiffel Tower rises against a gradient sky of purple and orange, with a few wispy clouds floating nearby. The lawn is dotted with small white clover flowers, and the overall atmosphere of the image is warm and lively, with soft focus on the dog and a blurred background that highlights the main subject.\"\uff08\u4e00\u5f20\u52a8\u6001\u5e7f\u89d2\u955c\u5934\u4e0b\u7684\u6bdb\u8338\u8338\u91d1\u6bdb\u72ac\uff0c\u6b63\u6b22\u5feb\u5730\u5954\u8dd1\u5728\u7eff\u8272\u7684\u8349\u5730\u4e0a\u3002\u72d7\u72d7\u7684\u6bdb\u53d1\u88ab\u5915\u9633\u6e29\u6696\u7684\u91d1\u8272\u5149\u7ebf\u7167\u4eae\uff0c\u51e0\u7f15\u6d45\u68d5\u8272\u7684\u6bdb\u53d1\u5728\u9633\u5149\u4e0b\u95ea\u95ea\u53d1\u5149\u3002\u5b83\u5954\u8dd1\u65f6\u8033\u6735\u5411\u540e\u8037\u62c9\u7740\uff0c\u5c3e\u5df4\u9ad8\u9ad8\u7fd8\u8d77\uff0c\u5c3d\u663e\u6b22\u5feb\u7684\u5fc3\u60c5\u3002\u5728\u6a21\u7cca\u7684\u80cc\u666f\u4e2d\uff0c\u6807\u5fd7\u6027\u7684\u57c3\u83f2\u5c14\u94c1\u5854\u94c1 lattice \u7ed3\u6784\u77d7\u7acb\u5728\u7d2b\u6a59\u6e10\u53d8\u7684\u5929\u7a7a\u4e0b\uff0c\u65c1\u8fb9\u6f02\u6d6e\u7740\u51e0\u7f15\u7ea4\u7ec6\u7684\u4e91\u6735\u3002\u8349\u5730\u4e0a\u70b9\u7f00\u7740\u5c0f\u5c0f\u7684\u767d\u8272\u4e09\u53f6\u8349\u82b1\uff0c\u56fe\u50cf\u7684\u6574\u4f53\u6c1b\u56f4\u6e29\u6696\u800c\u6d3b\u6cfc\uff0c\u72d7\u72d7\u91c7\u7528\u67d4\u7126\u5904\u7406\uff0c\u80cc\u666f\u6a21\u7cca\u4ee5\u7a81\u51fa\u6838\u5fc3\u4e3b\u4f53\u3002\uff09   \u8f93\u51fa\u7279\u70b9\uff1a\u957f\u5ea6\u901a\u5e38\u5728 50-200 \u4e2a\u5355\u8bcd\uff0c\u6db5\u76d6\u6838\u5fc3\u7269\u4f53\u7684\u7ec6\u8282\u3001\u80cc\u666f\u573a\u666f\u3001\u5149\u7ebf\u3001\u8272\u5f69\u3001\u827a\u672f\u98ce\u683c\u3001\u7269\u4f53\u4e92\u52a8\u548c\u6574\u4f53\u6c1b\u56f4\uff0c\u7ec6\u8282\u4e30\u5bcc\uff0c\u89c6\u89c9-\u6587\u672c\u5bf9\u9f50\u7cbe\u5ea6\u9ad8\u3002</p> <p>\u8865\u5145\u63d0\u793a\uff1a\u9664\u4e86\u4e0a\u8ff0\u4e24\u79cd\u7b56\u7565\uff0c\u8fd8\u53ef\u8bbe\u8ba1\u201c\u4efb\u52a1\u5bfc\u5411\u578b Prompt\u201d\uff0c\u5982\u9488\u5bf9\u7535\u5546\u56fe\u50cf\u7684 Prompt\uff08\"Describe this product image in detail, focusing on the product's appearance, color, size, texture, and placement, suitable for e-commerce promotion\"\uff09\u3001\u9488\u5bf9\u6587\u6863\u56fe\u50cf\u7684 Prompt\uff08\"Describe this document image in detail, including the text content, layout, font style, and color of the text\"\uff09\uff0c\u8fdb\u4e00\u6b65\u63d0\u5347\u63cf\u8ff0\u7684\u9488\u5bf9\u6027\u3002</p>"},{"location":"chapter3/3_2/#7_23-vllm","title":"7_2.3 \u5de5\u7a0b\u5b9e\u73b0\uff1a\u4f7f\u7528 vLLM \u6784\u5efa\u9ad8\u541e\u5410\u63a8\u7406\u670d\u52a1","text":"<p>\u5bf9\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u91cd\u63cf\u8ff0\uff08\u5982\u5904\u7406 10 \u4ebf\u7ea7\u522b\u7684\u56fe\u50cf\u6570\u636e\u96c6\uff09\uff0c\u666e\u901a\u7684 HuggingFace <code>generate()</code> \u65b9\u6cd5\u8fdc\u8fdc\u65e0\u6cd5\u6ee1\u8db3\u9700\u6c42\u2014\u2014\u5176\u63a8\u7406\u901f\u5ea6\u6162\u3001\u541e\u5410\u91cf\u4f4e\uff0c\u4e14\u65e0\u6cd5\u9ad8\u6548\u5229\u7528 GPU \u8d44\u6e90\uff0c\u5355\u5f20 GPU \u4e00\u5929\u4ec5\u80fd\u5904\u7406\u6570\u5343\u5f20\u56fe\u50cf\uff0c\u5927\u89c4\u6a21\u5904\u7406\u4f1a\u8017\u8d39\u5927\u91cf\u7684\u65f6\u95f4\u548c\u786c\u4ef6\u6210\u672c\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4e13\u95e8\u7684\u5927\u6a21\u578b\u63a8\u7406\u5f15\u64ce\u2014\u2014vLLM\uff0c\u5176\u652f\u6301 PagedAttention\uff08\u5206\u9875\u6ce8\u610f\u529b\uff09\u548c Continuous Batching\uff08\u8fde\u7eed\u6279\u5904\u7406\uff09\u4e24\u79cd\u6838\u5fc3\u4f18\u5316\u6280\u672f\uff0c\u80fd\u591f\u5c06 VLM \u7684\u63a8\u7406\u541e\u5410\u91cf\u63d0\u5347 3-5 \u500d\uff0c\u540c\u65f6\u964d\u4f4e GPU \u663e\u5b58\u5360\u7528\uff0c\u5b9e\u73b0\u9ad8\u6548\u3001\u5927\u89c4\u6a21\u7684\u56fe\u50cf\u91cd\u63cf\u8ff0\u3002</p> <p>vLLM \u662f\u7531\u52a0\u5dde\u5927\u5b66\u4f2f\u514b\u5229\u5206\u6821\u7684\u7814\u7a76\u56e2\u961f\u5f00\u53d1\u7684\u9ad8\u6548\u5927\u6a21\u578b\u63a8\u7406\u5f15\u64ce\uff0c\u6838\u5fc3\u4f18\u52bf\u662f\u201c\u9ad8\u541e\u5410\u91cf\u3001\u4f4e\u5ef6\u8fdf\u3001\u9ad8 GPU \u5229\u7528\u7387\u201d\uff0c\u80fd\u591f\u5b8c\u7f8e\u9002\u914d LLaVA\u3001CogVLM \u7b49\u4e3b\u6d41 VLM \u7684\u90e8\u7f72\u9700\u6c42\uff0c\u4e14 API \u63a5\u53e3\u4e0e HuggingFace \u517c\u5bb9\uff0c\u8fc1\u79fb\u6210\u672c\u6781\u4f4e\u3002</p> <p>\u4ee5\u4e0b\u662f\u4f7f\u7528 vLLM \u90e8\u7f72 LLaVA-1_5-7b-hf \u6a21\u578b\uff0c\u5b9e\u73b0\u9ad8\u541e\u5410\u91cf\u56fe\u50cf\u91cd\u63cf\u8ff0\u7684\u6838\u5fc3\u4ee3\u7801\uff0c\u5305\u542b\u6a21\u578b\u521d\u59cb\u5316\u3001Prompt \u6a21\u677f\u8bbe\u8ba1\u3001\u6279\u91cf\u5904\u7406\u548c\u8f93\u51fa\u63d0\u53d6\u7b49\u5b8c\u6574\u6d41\u7a0b\uff0c\u5e76\u8865\u5145\u4e86\u5173\u952e\u53c2\u6570\u7684\u89e3\u8bfb\u548c\u4f18\u5316\u6280\u5de7\uff1a</p> <p><pre><code>from vllm import LLM, SamplingParams\nfrom PIL import Image\nimport os\nfrom tqdm import tqdm  # \u7528\u4e8e\u663e\u793a\u6279\u91cf\u5904\u7406\u8fdb\u5ea6\n\n# \u521d\u59cb\u5316 vLLM \u63a8\u7406\u5f15\u64ce\n# tensor_parallel_size=4: \u4f7f\u7528 4 \u5f20 GPU \u8fdb\u884c\u5f20\u91cf\u5e76\u884c\uff0c\u9002\u7528\u4e8e\u5927\u6a21\u578b\uff08\u59827B/13B\uff09\u7684\u90e8\u7f72\uff0c\u53ef\u6839\u636eGPU\u6570\u91cf\u8c03\u6574\uff08\u59821\u30012\u30014\u30018\uff09\n# \u6ce8\u610f\uff1a\u5f20\u91cf\u5e76\u884c\u9700\u8981\u591a\u5f20\u540c\u578b\u53f7\u7684GPU\uff0c\u4e14GPU\u4e4b\u95f4\u9700\u652f\u6301NVLink\uff0c\u63d0\u5347\u6570\u636e\u4f20\u8f93\u901f\u5ea6\n# trust_remote_code=True: \u5141\u8bb8\u52a0\u8f7d LLaVA \u6a21\u578b\u7684\u81ea\u5b9a\u4e49\u4ee3\u7801\uff08\u5982\u89c6\u89c9-\u8bed\u8a00\u878d\u5408\u6a21\u5757\uff09\uff0c\u56e0LLaVA\u7684\u67b6\u6784\u975e\u6807\u51c6HuggingFace\u6a21\u578b\n# model: \u6a21\u578b\u540d\u79f0\uff0c\u53ef\u4eceHuggingFace Hub\u4e0b\u8f7d\uff08\u5982llava-hf/llava-1_5-7b-hf\u3001llava-hf/llava-1_5-13b-hf\uff09\n# gpu_memory_utilization=0_9: \u8bbe\u7f6eGPU\u663e\u5b58\u5229\u7528\u7387\u4e3a90%\uff0c\u5e73\u8861\u541e\u5410\u91cf\u548c\u7a33\u5b9a\u6027\uff0c\u907f\u514d\u663e\u5b58\u6ea2\u51fa\nllm = LLM(\n    model=\"llava-hf/llava-1_5-7b-hf\",\n    tensor_parallel_size=4,\n    trust_remote_code=True,\n    gpu_memory_utilization=0_9\n)\n\n# \u5b9a\u4e49 Prompt \u6a21\u677f (LLaVA \u6a21\u578b\u9700\u8981\u9075\u5faa\u7279\u5b9a\u7684\u5bf9\u8bdd\u683c\u5f0f\uff0c\u5426\u5219\u4f1a\u5f71\u54cd\u6307\u4ee4\u9075\u5faa\u80fd\u529b)\n# \u6280\u5de7: \u5728 Prompt \u4e2d\u52a0\u5165 \"Analyze the image\" \u5f80\u5f80\u6bd4 \"Describe the image\" \u6548\u679c\u66f4\u597d\uff0c\n# \u56e0\u4e3a\"Analyze\"\u4f1a\u5f15\u5bfc\u6a21\u578b\u66f4\u7ec6\u81f4\u5730\u89c2\u5bdf\u56fe\u50cf\u7ec6\u8282\uff0c\u51cf\u5c11\u6577\u884d\u5f0f\u63cf\u8ff0\n# \u6b64\u5904\u4f7f\u7528\u8be6\u5c3d\u63cf\u8ff0\u7684 Prompt \u6a21\u677f\uff0c\u53ef\u6839\u636e\u9700\u6c42\u66ff\u6362\u4e3a\u7b80\u7565\u63cf\u8ff0\u6a21\u677f\nprompt_template = \"USER: &lt;image&gt;\\nAnalyze this image and describe it in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style. Mention any specific interactions between objects. ASSISTANT:\"\n\n# \u914d\u7f6e\u91c7\u6837\u53c2\u6570\uff0c\u63a7\u5236\u751f\u6210\u63cf\u8ff0\u7684\u8d28\u91cf\u548c\u7a33\u5b9a\u6027\n# temperature=0_2: \u964d\u4f4e\u968f\u673a\u6027\uff08\u53d6\u503c\u8303\u56f40-1\uff09\uff0c\u6e29\u5ea6\u8d8a\u4f4e\uff0c\u751f\u6210\u7684\u63cf\u8ff0\u8d8a\u7a33\u5b9a\u3001\u8d8a\u8d34\u5408\u56fe\u50cf\uff0c\u51cf\u5c11\u5e7b\u89c9\uff1b\n# \u82e5\u9700\u8981\u66f4\u591a\u6837\u5316\u7684\u63cf\u8ff0\uff0c\u53ef\u5c06\u6e29\u5ea6\u8c03\u6574\u4e3a0_5-0_7\uff0c\u4f46\u82e5\u6e29\u5ea6\u8fc7\u9ad8\uff08&gt;0_8\uff09\uff0c\u5bb9\u6613\u4ea7\u751f\u4e0e\u56fe\u50cf\u65e0\u5173\u7684\u5e7b\u89c9\n# max_tokens=256: \u9650\u5236\u8f93\u51fa\u957f\u5ea6\uff0c\u9632\u6b62\u6a21\u578b\u751f\u6210\u8fc7\u4e8e\u5197\u957f\u3001\u5197\u4f59\u7684\u63cf\u8ff0\uff0c\u53ef\u6839\u636e\u9700\u6c42\u8c03\u6574\uff08\u5982\u7b80\u7565\u63cf\u8ff0\u8bbe\u4e3a50\uff09\n# top_p=0_95: \u91c7\u7528\u6838\u91c7\u6837\u7b56\u7565\uff0c\u4ec5\u4fdd\u7559\u7d2f\u79ef\u6982\u7387\u8fbe\u523095%\u7684token\uff0c\u8fdb\u4e00\u6b65\u964d\u4f4e\u5e7b\u89c9\u98ce\u9669\nsampling_params = SamplingParams(\n    temperature=0_2,\n    max_tokens=256,\n    top_p=0_95\n)\n\ndef load_image_batch(image_dir, batch_size=32):\n    \"\"\"\n    \u6279\u91cf\u52a0\u8f7d\u56fe\u50cf\uff0c\u7528\u4e8e\u9ad8\u6548\u5904\u7406\n    image_dir: \u56fe\u50cf\u6587\u4ef6\u5939\u8def\u5f84\uff0c\u6240\u6709\u56fe\u50cf\u9700\u653e\u5728\u8be5\u6587\u4ef6\u5939\u4e0b\n    batch_size: \u6bcf\u6279\u5904\u7406\u7684\u56fe\u50cf\u6570\u91cf\uff0c\u53ef\u6839\u636eGPU\u663e\u5b58\u8c03\u6574\uff08\u598216\u300132\u300164\uff09\uff0c\u663e\u5b58\u8d8a\u5927\uff0cbatch_size\u53ef\u8bbe\u7f6e\u8d8a\u5927\n    return: \u6279\u91cf\u56fe\u50cf\u5217\u8868\uff08PIL.Image\u683c\u5f0f\uff09\u548c\u5bf9\u5e94\u7684\u56fe\u50cf\u8def\u5f84\u5217\u8868\n    \"\"\"\n    image_paths = [os.path.join(image_dir, f) for f in os.listdir(image_dir) if f.endswith(('jpg', 'png', 'jpeg'))]\n    image_batches = []\n    path_batches = []\n\n    # \u5206\u6279\u52a0\u8f7d\u56fe\u50cf\n    for i in range(0, len(image_paths), batch_size):\n        batch_paths = image_paths[i:i+batch_size]\n        batch_images = []\n        for path in batch_paths:\n            try:\n                # \u52a0\u8f7d\u56fe\u50cf\u5e76\u8f6c\u6362\u4e3aRGB\u683c\u5f0f\uff08\u907f\u514d\u7070\u5ea6\u56fe\u3001\u900f\u660e\u56fe\u5bfc\u81f4\u7684\u6a21\u578b\u62a5\u9519\uff09\n                img = Image.open(path).convert('RGB')\n                batch_images.append(img)\n            except Exception as e:\n                print(f\"\u52a0\u8f7d\u56fe\u50cf {path} \u5931\u8d25: {e}\")\n                continue\n        if batch_images:  # \u8df3\u8fc7\u4e3a\u7a7a\u7684\u6279\u6b21\n            image_batches.append(batch_images)\n            path_batches.append(batch_paths)\n    return image_batches, path_batches\n\ndef process_batch(image_batch):\n    \"\"\"\n    \u5904\u7406\u4e00\u6279\u56fe\u7247\uff0c\u751f\u6210\u5bf9\u5e94\u7684\u91cd\u63cf\u8ff0\u6587\u672c\n    image_batch: List[PIL.Image]\uff0c\u6279\u91cf\u56fe\u50cf\u5217\u8868\n    return: List[str]\uff0c\u6bcf\u5e45\u56fe\u50cf\u5bf9\u5e94\u7684\u91cd\u63cf\u8ff0\u6587\u672c\u5217\u8868\n    \"\"\"\n    # \u4e3a\u6bcf\u5e45\u56fe\u50cf\u751f\u6210\u5bf9\u5e94\u7684Prompt\n    prompts = [prompt_template for _ in range(len(image_batch))]\n\n    # vLLM \u652f\u6301\u76f4\u63a5\u4f20\u5165 multi_modal_data\uff08\u591a\u6a21\u6001\u6570\u636e\uff09\uff0c\u65e0\u9700\u624b\u52a8\u8f6c\u6362\u56fe\u50cf\u683c\u5f0f\n    # \u8fd9\u4e00\u6b65\u662f\u975e\u963b\u585e\u7684\uff0cvLLM \u5185\u90e8\u4f1a\u8fdb\u884c Continuous Batching \u8c03\u5ea6\uff0c\u9ad8\u6548\u5229\u7528GPU\u8d44\u6e90\n    # \u5373\u5f53\u4e00\u6279\u56fe\u50cf\u5904\u7406\u5b8c\u6210\u4e00\u90e8\u5206\u65f6\uff0c\u7acb\u5373\u52a0\u8f7d\u4e0b\u4e00\u6279\u56fe\u50cf\u7684\u90e8\u5206\u6570\u636e\uff0c\u907f\u514dGPU\u7a7a\u95f2\n    outputs = llm.generate(\n        prompts, \n        sampling_params, \n        multi_modal_data={\"image\": image_batch}\n    )\n\n    # \u63d0\u53d6\u751f\u6210\u7684\u63cf\u8ff0\u6587\u672c\uff0c\u53bb\u9664Prompt\u90e8\u5206\uff0c\u4ec5\u4fdd\u7559\u6a21\u578b\u7684\u54cd\u5e94\u5185\u5bb9\n    captions = []\n    for output in outputs:\n        # \u622a\u53d6ASSISTANT: \u540e\u9762\u7684\u5185\u5bb9\uff0c\u5373\u4e3a\u6a21\u578b\u751f\u6210\u7684\u63cf\u8ff0\n        caption = output.outputs[0].text.strip().replace(\"ASSISTANT:\", \"\").strip()\n        captions.append(caption)\n    return captions\n\ndef save_captions(image_paths, captions, save_path):\n    \"\"\"\n    \u4fdd\u5b58\u91cd\u63cf\u8ff0\u6587\u672c\uff0c\u4e0e\u56fe\u50cf\u8def\u5f84\u5bf9\u5e94\uff0c\u4fbf\u4e8e\u540e\u7eed\u4f7f\u7528\uff08\u5982\u6a21\u578b\u8bad\u7ec3\uff09\n    image_paths: \u56fe\u50cf\u8def\u5f84\u5217\u8868\n    captions: \u91cd\u63cf\u8ff0\u6587\u672c\u5217\u8868\n    save_path: \u4fdd\u5b58\u6587\u4ef6\u8def\u5f84\uff08txt\u683c\u5f0f\uff09\n    \"\"\"\n    with open(save_path, 'w', encoding='utf-8') as f:\n        for path, cap in zip(image_paths, captions):\n            # \u683c\u5f0f\uff1a\u56fe\u50cf\u8def\u5f84\\t\u91cd\u63cf\u8ff0\u6587\u672c\uff0c\u4fbf\u4e8e\u540e\u7eed\u8bfb\u53d6\u548c\u89e3\u6790\n            f.write(f\"{path}\\t{cap}\\n\")\n\n# \u4e3b\u51fd\u6570\uff1a\u6279\u91cf\u5904\u7406\u56fe\u50cf\u5e76\u751f\u6210\u91cd\u63cf\u8ff0\nif __name__ == \"__main__\":\n    image_dir = \"path/to/your/image/directory\"  # \u66ff\u6362\u4e3a\u4f60\u7684\u56fe\u50cf\u6587\u4ef6\u5939\u8def\u5f84\n    save_path = \"recaption_results.txt\"        # \u91cd\u63cf\u8ff0\u7ed3\u679c\u4fdd\u5b58\u8def\u5f84\n    batch_size = 32                            # \u6bcf\u6279\u5904\u7406\u56fe\u50cf\u6570\u91cf\uff0c\u6839\u636eGPU\u663e\u5b58\u8c03\u6574\n\n    # \u52a0\u8f7d\u56fe\u50cf\u6279\u6b21\n    image_batches, path_batches = load_image_batch(image_dir, batch_size)\n\n    # \u6279\u91cf\u5904\u7406\u5e76\u4fdd\u5b58\u7ed3\u679c\n    with open(save_path, 'w', encoding='utf-8') as f:\n        for img_batch, path_batch in tqdm(zip(image_batches, path_batches), total=len(image_batches)):\n            captions = process_batch(img_batch)\n            # \u5199\u5165\u5f53\u524d\u6279\u6b21\u7684\u7ed3\u679c\n            for path, cap in zip(path_batch, captions):\n                f.write(f\"{path}\\t{cap}\\n\")\n    print(f\"\u91cd\u63cf\u8ff0\u5b8c\u6210\uff0c\u7ed3\u679c\u5df2\u4fdd\u5b58\u81f3 {save_path}\")\n</code></pre> \u8865\u5145\u5de5\u7a0b\u4f18\u5316\u6280\u5de7\uff1a</p> <ul> <li>\u56fe\u50cf\u9884\u5904\u7406\uff1a\u6279\u91cf\u52a0\u8f7d\u56fe\u50cf\u65f6\uff0c\u53ef\u7edf\u4e00\u8c03\u6574\u56fe\u50cf\u5c3a\u5bf8\uff08\u5982 resize \u5230 224\u00d7224 \u6216 448\u00d7448\uff09\uff0c\u907f\u514d\u56e0\u56fe\u50cf\u5c3a\u5bf8\u5dee\u5f02\u5bfc\u81f4\u7684\u6a21\u578b\u63a8\u7406\u901f\u5ea6\u6ce2\u52a8\u548c\u663e\u5b58\u5360\u7528\u4e0d\u7a33\u5b9a\uff1b\u540c\u65f6\uff0c\u53ef\u5bf9\u56fe\u50cf\u8fdb\u884c\u5f52\u4e00\u5316\u5904\u7406\uff0c\u63d0\u5347\u6a21\u578b\u63cf\u8ff0\u7cbe\u5ea6\u3002</li> <li>\u9519\u8bef\u5904\u7406\uff1a\u589e\u52a0\u56fe\u50cf\u52a0\u8f7d\u5931\u8d25\u3001\u6a21\u578b\u63a8\u7406\u5931\u8d25\u7684\u5f02\u5e38\u6355\u83b7\u673a\u5236\uff0c\u907f\u514d\u6279\u91cf\u5904\u7406\u4e2d\u65ad\uff1b\u5bf9\u4e8e\u5904\u7406\u5931\u8d25\u7684\u56fe\u50cf\uff0c\u53ef\u8bb0\u5f55\u8def\u5f84\u5e76\u5355\u72ec\u5904\u7406\u3002</li> <li>\u786c\u4ef6\u4f18\u5316\uff1a\u90e8\u7f72\u65f6\u4f18\u5148\u4f7f\u7528 NVIDIA A100\u3001A800 \u7b49\u9ad8\u6027\u80fd GPU\uff0c\u663e\u5b58\u5efa\u8bae\u4e0d\u4f4e\u4e8e 24GB\uff087B \u6a21\u578b\uff09\uff1b\u82e5\u5904\u7406\u89c4\u6a21\u6781\u5927\uff0c\u53ef\u4f7f\u7528 GPU \u96c6\u7fa4\uff0c\u901a\u8fc7 vLLM \u7684\u5206\u5e03\u5f0f\u63a8\u7406\u529f\u80fd\u8fdb\u4e00\u6b65\u63d0\u5347\u541e\u5410\u91cf\u3002</li> <li>Prompt \u7f13\u5b58\uff1a\u5bf9\u4e8e\u76f8\u540c\u7c7b\u578b\u7684\u56fe\u50cf\uff08\u5982\u6279\u91cf\u7684\u7535\u5546\u6d77\u62a5\uff09\uff0c\u53ef\u7f13\u5b58 Prompt \u6a21\u677f\uff0c\u907f\u514d\u91cd\u590d\u751f\u6210\uff0c\u63d0\u5347\u5904\u7406\u901f\u5ea6\u3002</li> </ul>"},{"location":"chapter3/3_2/#7_3-ocr","title":"7_3 OCR \u589e\u5f3a\uff1a\u63d0\u53d6\u56fe\u4e2d\u6587\u5b57\u5e76\u878d\u5408","text":"<p>\u666e\u901a\u7684 VLM \u867d\u7136\u5177\u5907\u4e00\u5b9a\u7684\u89c6\u89c9\u7406\u89e3\u80fd\u529b\uff0c\u80fd\u591f\u8bc6\u522b\u56fe\u50cf\u4e2d\u7684\u7269\u4f53\u3001\u573a\u666f\u548c\u7b80\u5355\u6587\u5b57\uff0c\u4f46\u5728\u9762\u5bf9\u5bc6\u96c6\u6587\u672c\u56fe\u50cf\uff08\u5982\u6587\u6863\u3001\u6d77\u62a5\u3001\u56fe\u8868\u3001PDF \u622a\u56fe\uff09\u65f6\uff0c\u5f80\u5f80\u4f1a\u51fa\u73b0\u4e24\u4e2a\u6838\u5fc3\u95ee\u9898\uff1a\u4e00\u662f\u6587\u5b57\u8bc6\u522b\u7cbe\u5ea6\u4f4e\uff0c\u5bb9\u6613\u8ba4\u9519\u3001\u6f0f\u8ba4\u6587\u5b57\uff08\u5c24\u5176\u662f\u827a\u672f\u5b57\u4f53\u3001\u6a21\u7cca\u6587\u5b57\uff09\uff1b\u4e8c\u662f\u65e0\u6cd5\u5c06\u6587\u5b57\u4fe1\u606f\u4e0e\u89c6\u89c9\u5143\u7d20\u6709\u6548\u5173\u8054\uff0c\u5bfc\u81f4\u63cf\u8ff0\u4e2d\u5ffd\u7565\u6587\u5b57\u7684\u542b\u4e49\u548c\u4f5c\u7528\u3002</p> <p>\u4f8b\u5982\uff0c\u4e00\u5f20\u7535\u5546\u6d77\u62a5\u4e0a\u6709 \u201c\u590f\u65e5\u4fc3\u9500 \u5168\u573a 5 \u6298\u8d77\u201d \u7684\u5927\u5b57\uff0c\u666e\u901a VLM \u53ef\u80fd\u4ec5\u8f93\u51fa \u201cA red promotional poster\u201d\uff0c\u5b8c\u5168\u5ffd\u7565\u6587\u5b57\u4fe1\u606f\uff1b\u5373\u4f7f\u8bc6\u522b\u5230\u6587\u5b57\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0 \u201c\u590f\u65e5\u4fc3\u9500 \u5168\u573a 3 \u6298\u8d77\u201d \u7684\u9519\u8bef\u3002\u800c\u6587\u5b57\u4fe1\u606f\u5bf9\u4e8e\u8fd9\u7c7b\u56fe\u50cf\u7684\u91cd\u63cf\u8ff0\u81f3\u5173\u91cd\u8981 \u2014\u2014 \u5b83\u76f4\u63a5\u51b3\u5b9a\u4e86\u56fe\u50cf\u7684\u6838\u5fc3\u542b\u4e49\u548c\u7528\u9014\u3002</p> <p>\u6700\u4f73\u5b9e\u8df5\u662f\u5f15\u5165\u4e13\u95e8\u7684 OCR \u5f15\u64ce\uff08\u5982 PaddleOCR\u3001Tesseract\uff09\u4f5c\u4e3a VLM \u7684 \u201c\u5916\u6302\u5927\u8111\u201d\uff0c\u901a\u8fc7 OCR \u7cbe\u51c6\u63d0\u53d6\u56fe\u50cf\u4e2d\u7684\u6587\u5b57\u4fe1\u606f\uff0c\u518d\u5c06\u5176\u4e0e VLM Prompt \u52a8\u6001\u878d\u5408\uff0c\u8ba9 VLM \u80fd\u591f\u7ed3\u5408\u6587\u5b57\u4fe1\u606f\u751f\u6210\u66f4\u51c6\u786e\u3001\u66f4\u4e30\u5bcc\u7684\u63cf\u8ff0\uff0c\u663e\u8457\u63d0\u5347\u6587\u6863\u7c7b\u3001\u6d77\u62a5\u7c7b\u7b49\u5bcc\u6587\u672c\u56fe\u50cf\u7684\u91cd\u63cf\u8ff0\u8d28\u91cf\u3002</p> <p>OCR\uff08Optical Character Recognition\uff0c\u5149\u5b66\u5b57\u7b26\u8bc6\u522b\uff09\u6280\u672f\u7684\u6838\u5fc3\u662f\u5c06\u56fe\u50cf\u4e2d\u7684\u5370\u5237\u4f53\u3001\u624b\u5199\u4f53\u6587\u5b57\u8f6c\u6362\u4e3a\u53ef\u7f16\u8f91\u7684\u6587\u672c\uff0c\u5176\u6587\u5b57\u8bc6\u522b\u7cbe\u5ea6\u8fdc\u9ad8\u4e8e\u666e\u901a VLM\uff0c\u5c24\u5176\u662f\u5728\u5bc6\u96c6\u6587\u672c\u3001\u590d\u6742\u5b57\u4f53\u573a\u666f\u4e0b\uff0c\u4f18\u52bf\u66f4\u4e3a\u660e\u663e\u3002\u76ee\u524d\uff0c\u5de5\u4e1a\u754c\u5e94\u7528\u6700\u5e7f\u6cdb\u3001\u5f00\u6e90\u514d\u8d39\u4e14\u7cbe\u5ea6\u8f83\u9ad8\u7684 OCR \u5f15\u64ce\u662f PaddleOCR\uff08\u767e\u5ea6\u98de\u6868\u5f00\u6e90\u7684 OCR \u5de5\u5177\uff09\uff0c\u5b83\u652f\u6301\u591a\u8bed\u8a00\u3001\u591a\u5b57\u4f53\u3001\u6a21\u7cca\u6587\u672c\u7684\u8bc6\u522b\uff0c\u4e14\u63a8\u7406\u901f\u5ea6\u5feb\u3001\u90e8\u7f72\u7b80\u5355\uff0c\u652f\u6301 GPU \u52a0\u901f\uff0c\u975e\u5e38\u9002\u5408\u4e0e VLM \u7ed3\u5408\u4f7f\u7528\u3002</p> <p> \u56fe7-2\uff1aOCR \u589e\u5f3a\u6d41\u6c34\u7ebf</p> <p>\u56fe\u8868\u6838\u5fc3\u89e3\u8bfb\uff1a\u56fe 7-2 \u5c55\u793a\u4e86 OCR \u589e\u5f3a VLM \u91cd\u63cf\u8ff0\u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u6838\u5fc3\u662f \u201cOCR \u63d0\u53d6\u6587\u5b57\u2192\u4e0a\u4e0b\u6587\u6784\u5efa\u2192Prompt \u878d\u5408\u2192VLM \u751f\u6210\u63cf\u8ff0\u201d\uff0c\u901a\u8fc7 OCR \u8865\u5145 VLM \u7684\u6587\u5b57\u8bc6\u522b\u77ed\u677f\uff0c\u5b9e\u73b0 \u201c\u89c6\u89c9\u7ec6\u8282 + \u6587\u5b57\u4fe1\u606f\u201d \u7684\u53cc\u91cd\u7cbe\u51c6\u63cf\u8ff0\u3002</p>"},{"location":"chapter3/3_2/#7_31-ocr","title":"7_3.1 OCR \u589e\u5f3a\u6d41\u6c34\u7ebf","text":"<p>OCR \u589e\u5f3a\u7684\u6838\u5fc3\u662f\u5c06 OCR \u63d0\u53d6\u7684\u6587\u5b57\u4fe1\u606f\u4e0e VLM Prompt \u6709\u673a\u878d\u5408\uff0c\u800c\u975e\u7b80\u5355\u62fc\u63a5\u3002\u6574\u4e2a\u6d41\u6c34\u7ebf\u53ef\u5206\u4e3a\u4e09\u4e2a\u6838\u5fc3\u6b65\u9aa4\uff0c\u6bcf\u4e2a\u6b65\u9aa4\u90fd\u6709\u660e\u786e\u7684\u4f18\u5316\u65b9\u5411\uff0c\u786e\u4fdd\u6587\u5b57\u4fe1\u606f\u80fd\u591f\u6709\u6548\u63d0\u5347\u91cd\u63cf\u8ff0\u8d28\u91cf\uff1a</p> <ol> <li>\u68c0\u6d4b\u4e0e\u8bc6\u522b\uff1a\u4f7f\u7528 PaddleOCR \u5f15\u64ce\u5bf9\u539f\u59cb\u56fe\u50cf\u8fdb\u884c\u5904\u7406\uff0c\u9996\u5148\u68c0\u6d4b\u51fa\u56fe\u50cf\u4e2d\u7684\u6240\u6709\u6587\u672c\u533a\u57df\uff08\u901a\u8fc7 Bounding Box \u5b9a\u4f4d\u6587\u672c\u7684\u4f4d\u7f6e\uff09\uff0c\u7136\u540e\u5bf9\u6bcf\u4e2a\u6587\u672c\u533a\u57df\u8fdb\u884c\u5b57\u7b26\u8bc6\u522b\uff0c\u8f93\u51fa\u8bc6\u522b\u5230\u7684\u6587\u672c\u5185\u5bb9\u548c\u5bf9\u5e94\u7684\u7f6e\u4fe1\u5ea6\uff080-1 \u4e4b\u95f4\uff0c\u7f6e\u4fe1\u5ea6\u8d8a\u9ad8\uff0c\u8bc6\u522b\u7ed3\u679c\u8d8a\u51c6\u786e\uff09\u3002\u8fd9\u4e00\u6b65\u7684\u6838\u5fc3\u76ee\u6807\u662f \u201c\u7cbe\u51c6\u63d0\u53d6\u6587\u5b57\uff0c\u8fc7\u6ee4\u9519\u8bef\u8bc6\u522b\u7ed3\u679c\u201d\u2014\u2014 \u901a\u8fc7\u7f6e\u4fe1\u5ea6\u9608\u503c\u8fc7\u6ee4\u4f4e\u7cbe\u5ea6\u8bc6\u522b\u7ed3\u679c\uff0c\u907f\u514d\u9519\u8bef\u6587\u5b57\u8bef\u5bfc VLM\u3002</li> <li>\u4e0a\u4e0b\u6587\u6784\u5efa\uff1a\u5c06 OCR \u63d0\u53d6\u5230\u7684\u6240\u6709\u6709\u6548\u6587\u672c\uff08\u8fc7\u6ee4\u4f4e\u7f6e\u4fe1\u5ea6\u540e\uff09\uff0c\u6309\u7167\u56fe\u50cf\u4e2d\u6587\u5b57\u7684\u5b9e\u9645\u4f4d\u7f6e\uff08\u4ece\u4e0a\u5230\u4e0b\u3001\u4ece\u5de6\u5230\u53f3\uff0c\u591a\u5217\u6587\u672c\u6309\u5217\u6392\u5e8f\uff09\u8fdb\u884c\u62fc\u63a5\uff0c\u6784\u5efa\u51fa\u7b26\u5408\u4eba\u7c7b\u9605\u8bfb\u4e60\u60ef\u7684\u6587\u672c\u4e0a\u4e0b\u6587\u3002\u540c\u65f6\uff0c\u53ef\u5bf9\u6587\u672c\u8fdb\u884c\u7b80\u5355\u5206\u7c7b\u6574\u7406\uff08\u5982\u5c06\u6807\u9898\u6587\u5b57\u3001\u6b63\u6587\u6587\u5b57\u3001\u6309\u94ae\u6587\u5b57\u533a\u5206\u5f00\uff09\uff0c\u4fbf\u4e8e VLM \u7406\u89e3\u6587\u5b57\u7684\u5c42\u7ea7\u5173\u7cfb\u548c\u4f5c\u7528\u3002\u4f8b\u5982\uff0c\u4e00\u5f20\u6d77\u62a5\u4e0a\u7684\u6587\u5b57 \u201c\u590f\u65e5\u4fc3\u9500\u201d\uff08\u6807\u9898\uff09\u3001\u201c\u5168\u573a 5 \u6298\u8d77\u201d\uff08\u526f\u6807\u9898\uff09\u3001\u201c6 \u6708 1 \u65e5 - 6 \u6708 10 \u65e5\u201d\uff08\u65f6\u95f4\uff09\uff0c\u62fc\u63a5\u540e\u53ef\u5f97\u5230 \u201c\u590f\u65e5\u4fc3\u9500\uff0c\u5168\u573a 5 \u6298\u8d77\uff0c6 \u6708 1 \u65e5 - 6 \u6708 10 \u65e5\u201d\uff0c\u5e76\u6807\u6ce8\u6807\u9898\u548c\u6b63\u6587\u3002</li> <li>Prompt \u878d\u5408\uff1a\u5c06\u6784\u5efa\u597d\u7684\u6587\u672c\u4e0a\u4e0b\u6587\uff0c\u4ee5\u81ea\u7136\u7684\u65b9\u5f0f\u878d\u5165\u5230 VLM \u7684 Prompt \u4e2d\uff0c\u660e\u786e\u544a\u8bc9 VLM\u201c\u56fe\u50cf\u4e2d\u5305\u542b\u8fd9\u4e9b\u6587\u5b57\u4fe1\u606f\uff0c\u8bf7\u7ed3\u5408\u6587\u5b57\u548c\u89c6\u89c9\u5143\u7d20\u8fdb\u884c\u63cf\u8ff0\u201d\uff0c\u5f15\u5bfc VLM \u5173\u8054\u6587\u5b57\u4e0e\u89c6\u89c9\u5143\u7d20\uff08\u5982\u6587\u5b57\u7684\u4f4d\u7f6e\u3001\u989c\u8272\u3001\u5b57\u4f53\u98ce\u683c\uff0c\u4ee5\u53ca\u6587\u5b57\u6240\u8868\u8fbe\u7684\u542b\u4e49\u4e0e\u56fe\u50cf\u573a\u666f\u7684\u5173\u7cfb\uff09\u3002\u8fd9\u4e00\u6b65\u7684\u5173\u952e\u662f \u201c\u878d\u5408\u81ea\u7136\uff0c\u4e0d\u5197\u4f59\u201d\uff0c\u907f\u514d\u5c06\u6587\u5b57\u751f\u786c\u62fc\u63a5\u5728 Prompt \u672b\u5c3e\uff0c\u5bfc\u81f4 VLM \u5ffd\u7565\u89c6\u89c9\u7ec6\u8282\u3002</li> </ol> <p>\u8865\u5145\u8bf4\u660e\uff1a\u6d41\u6c34\u7ebf\u7684\u4f18\u5316\u91cd\u70b9\u7684\u662f \u201c\u7f6e\u4fe1\u5ea6\u8fc7\u6ee4\u201d \u548c \u201cPrompt \u878d\u5408\u201d\u2014\u2014 \u82e5\u672a\u8fc7\u6ee4\u4f4e\u7f6e\u4fe1\u5ea6\u6587\u672c\uff0c\u9519\u8bef\u7684\u6587\u5b57\u4f1a\u5bfc\u81f4 VLM \u751f\u6210\u9519\u8bef\u63cf\u8ff0\uff1b\u82e5 Prompt \u878d\u5408\u751f\u786c\uff0cVLM \u4f1a\u5c06\u6587\u5b57\u4e0e\u89c6\u89c9\u5143\u7d20\u5272\u88c2\uff0c\u65e0\u6cd5\u5b9e\u73b0\u771f\u6b63\u7684\u589e\u5f3a\u6548\u679c\u3002</p>"},{"location":"chapter3/3_2/#7_32-ocr","title":"7_3.2 \u6838\u5fc3\u4ee3\u7801\uff1aOCR \u7ed3\u679c\u6ce8\u5165","text":"<p>\u4ee5\u4e0b\u662f\u4f7f\u7528 PaddleOCR \u63d0\u53d6\u56fe\u50cf\u6587\u5b57\uff0c\u5e76\u5c06\u5176\u52a8\u6001\u878d\u5408\u5230 VLM Prompt \u4e2d\u7684\u6838\u5fc3\u4ee3\u7801\uff0c\u53ef\u4e0e 7_2.3 \u8282\u7684 vLLM \u6279\u91cf\u5904\u7406\u4ee3\u7801\u65e0\u7f1d\u5bf9\u63a5\uff0c\u5b9e\u73b0 OCR \u589e\u5f3a\u7684\u5927\u89c4\u6a21\u56fe\u50cf\u91cd\u63cf\u8ff0\u3002\u4ee3\u7801\u4e2d\u5305\u542b\u4e86\u6587\u5b57\u63d0\u53d6\u3001\u7f6e\u4fe1\u5ea6\u8fc7\u6ee4\u3001\u4e0a\u4e0b\u6587\u6784\u5efa\u3001Prompt \u878d\u5408\u7b49\u5b8c\u6574\u903b\u8f91\uff0c\u5e76\u8865\u5145\u4e86\u5173\u952e\u53c2\u6570\u89e3\u8bfb\u548c\u4f18\u5316\u6280\u5de7\uff1a</p> <pre><code>from paddleocr import PaddleOCR\nimport os\nfrom PIL import Image\n\n# \u521d\u59cb\u5316 OCR \u5f15\u64ce (\u5efa\u8bae\u5728 GPU \u4e0a\u8fd0\u884c\u4ee5\u52a0\u901f\uff0c\u82e5\u6ca1\u6709 GPU\uff0c\u53ef\u8bbe\u7f6e use_gpu=False)\n# use_angle_cls=True: \u5f00\u542f\u6587\u672c\u65b9\u5411\u68c0\u6d4b\uff0c\u652f\u6301\u503e\u659c\u6587\u672c\uff08\u5982\u503e\u659c\u7684\u6d77\u62a5\u6587\u5b57\u3001\u65cb\u8f6c\u7684\u6587\u6863\uff09\u7684\u8bc6\u522b\uff0c\u907f\u514d\u56e0\u6587\u672c\u503e\u659c\u5bfc\u81f4\u8bc6\u522b\u9519\u8bef\n# lang='en': \u8bc6\u522b\u8bed\u8a00\u4e3a\u82f1\u6587\uff0c\u82e5\u9700\u8981\u8bc6\u522b\u4e2d\u6587\uff0c\u53ef\u8bbe\u7f6e lang='ch'\uff0c\u652f\u6301\u4e2d\u82f1\u53cc\u8bed\u6df7\u5408\u8bc6\u522b\uff08lang='ch_en'\uff09\n# det_model_dir\u3001rec_model_dir: \u53ef\u6307\u5b9a OCR \u68c0\u6d4b\u6a21\u578b\u548c\u8bc6\u522b\u6a21\u578b\u7684\u8def\u5f84\uff0c\u82e5\u4e0d\u6307\u5b9a\uff0c\u4f1a\u81ea\u52a8\u4e0b\u8f7d\u9884\u8bad\u7ec3\u6a21\u578b\n# gpu_mem=500: \u8bbe\u7f6e GPU \u663e\u5b58\u5360\u7528\u4e0a\u9650\uff08\u5355\u4f4d\uff1aMB\uff09\uff0c\u53ef\u6839\u636e GPU \u663e\u5b58\u8c03\u6574\nocr = PaddleOCR(\n    use_angle_cls=True,\n    lang='en',\n    use_gpu=True,\n    gpu_mem=500)\n\ndef generate_ocr_enhanced_prompt(image_path, base_prompt=\"Describe this image in detail.\"):\n    \"\"\"\n    \u751f\u6210 OCR \u589e\u5f3a\u7684 VLM Prompt\uff0c\u5c06 OCR \u63d0\u53d6\u7684\u6587\u5b57\u4fe1\u606f\u878d\u5165 Prompt \u4e2d\n    image_path: \u539f\u59cb\u56fe\u50cf\u8def\u5f84\n    base_prompt: \u57fa\u7840 Prompt\uff08\u5982\u7b80\u7565\u63cf\u8ff0\u3001\u8be6\u5c3d\u63cf\u8ff0\u7684 Prompt\uff09\uff0c\u4f5c\u4e3a Prompt \u4e3b\u4f53\n    return: OCR \u589e\u5f3a\u540e\u7684\u5b8c\u6574 Prompt\uff0c\u82e5\u672a\u8bc6\u522b\u5230\u6709\u6548\u6587\u5b57\uff0c\u8fd4\u56de\u57fa\u7840 Prompt\n    \"\"\"\n    # Step 1: \u8fd0\u884c OCR\uff0c\u63d0\u53d6\u56fe\u50cf\u4e2d\u7684\u6587\u5b57\u548c\u7f6e\u4fe1\u5ea6\n    # result \u662f\u4e00\u4e2a\u5d4c\u5957\u5217\u8868\uff0c\u7ed3\u6784\u4e3a\uff1a[[[[x1,y1], [x2,y2], [x3,y3], [x4,y4]], [text, confidence]], ...]\n    # \u5176\u4e2d [x1,y1]~[x4,y4] \u662f\u6587\u672c\u533a\u57df\u7684 Bounding Box\uff08\u5de6\u4e0a\u89d2\u3001\u53f3\u4e0a\u89d2\u3001\u53f3\u4e0b\u89d2\u3001\u5de6\u4e0b\u89d2\u5750\u6807\uff09\n    # text \u662f\u8bc6\u522b\u5230\u7684\u6587\u672c\u5185\u5bb9\uff0cconfidence \u662f\u8bc6\u522b\u7f6e\u4fe1\u5ea6\n    result = ocr.ocr(image_path, cls=True)\n\n    # \u5904\u7406 OCR \u7ed3\u679c\uff1a\u82e5\u672a\u8bc6\u522b\u5230\u6587\u5b57\uff0c\u6216\u8bc6\u522b\u7ed3\u679c\u4e3a\u7a7a\uff0c\u56de\u9000\u5230\u666e\u901a\u57fa\u7840 Prompt\n    if not result or not result[0]:\n        return f\"USER: &lt;image&gt;\\n{base_prompt}\\nASSISTANT:\"\n\n    # Step 2: \u63d0\u53d6\u6709\u6548\u6587\u5b57\uff08\u8fc7\u6ee4\u4f4e\u7f6e\u4fe1\u5ea6\u7ed3\u679c\uff09\uff0c\u6784\u5efa\u6587\u672c\u4e0a\u4e0b\u6587\n    detected_texts = []\n    for line in result[0]:\n        text = line[1][0]  # \u8bc6\u522b\u5230\u7684\u6587\u672c\u5185\u5bb9\n        confidence = line[1][1]  # \u8bc6\u522b\u7f6e\u4fe1\u5ea6\n        # \u8fc7\u6ee4\u7f6e\u4fe1\u5ea6\u4f4e\u4e8e 0_8 \u7684\u7ed3\u679c\uff08\u9608\u503c\u53ef\u8c03\u6574\uff0c\u59820_7-0_9\uff0c\u6839\u636e\u56fe\u50cf\u6587\u5b57\u6e05\u6670\u5ea6\u8c03\u6574\uff09\n        # \u540c\u65f6\u8fc7\u6ee4\u7a7a\u6587\u672c\u548c\u65e0\u610f\u4e49\u7684\u4e71\u7801\uff08\u5982\u4ec5\u5305\u542b\u7b26\u53f7\u3001\u7a7a\u683c\u7684\u6587\u672c\uff09\n        if confidence &gt; 0_8 and text.strip() and len(text.strip()) &gt; 1:\n            detected_texts.append(text.strip())\n\n    # \u6784\u5efa\u6587\u672c\u4e0a\u4e0b\u6587\uff1a\u6309\u8bc6\u522b\u987a\u5e8f\u62fc\u63a5\u6587\u672c\uff0c\u7528\u9017\u53f7\u5206\u9694\uff0c\u786e\u4fdd\u7b26\u5408\u4eba\u7c7b\u9605\u8bfb\u4e60\u60ef\n    ocr_context = \", \".join(detected_texts)\n\n    # Step 3: \u52a8\u6001\u878d\u5408 OCR \u7ed3\u679c\u4e0e\u57fa\u7840 Prompt\uff0c\u751f\u6210\u589e\u5f3a Prompt\n    # \u5173\u952e\u6280\u5de7\uff1a\u544a\u8bc9\u6a21\u578b \"I have detected these texts...\"\uff0c\u8ba9\u6a21\u578b\u660e\u786e\u77e5\u9053\u8fd9\u662f\u56fe\u50cf\u4e2d\u7684\u6587\u5b57\uff0c\n    # \u5e76\u5f15\u5bfc\u6a21\u578b\u5c06\u6587\u5b57\u4e0e\u89c6\u89c9\u5143\u7d20\u5173\u8054\uff08\u5982\u6587\u5b57\u7684\u4f4d\u7f6e\u3001\u989c\u8272\u3001\u5b57\u4f53\uff0c\u4ee5\u53ca\u6587\u5b57\u542b\u4e49\u4e0e\u573a\u666f\u7684\u5173\u7cfb\uff09\n    if len(ocr_context) &gt; 10:  # \u53ea\u6709\u6587\u672c\u957f\u5ea6\u8db3\u591f\u957f\uff08\u8d85\u8fc710\u4e2a\u5b57\u7b26\uff09\uff0c\u624d\u6709\u589e\u5f3a\u4ef7\u503c\uff0c\u907f\u514d\u5197\u4f59\n        enhanced_prompt = (\n            f\"USER: &lt;image&gt;\\n\"\n            f\"I have detected these text segments in the image: '{ocr_context}'. \"\n            f\"Using this text as a reference, describe the image in detail, \"\n            f\"paying attention to how the text relates to the visual elements (such as the position, color, and font style of the text, \"\n            f\"and the connection between the text content and the image scene). {base_prompt}\\n\"\n            f\"ASSISTANT:\"\n        )\n        return enhanced_prompt\n    else:\n        # \u82e5\u6587\u672c\u8fc7\u77ed\uff08\u5982\u4ec51-2\u4e2a\u5355\u8bcd\uff09\uff0c\u4e0d\u8fdb\u884c\u589e\u5f3a\uff0c\u907f\u514d\u5197\u4f59\uff0c\u56de\u9000\u5230\u57fa\u7840 Prompt\n        return f\"USER: &lt;image&gt;\\n{base_prompt}\\nASSISTANT:\"\n\n# \u6d4b\u8bd5\u4ee3\u7801\uff1a\u9a8c\u8bc1 OCR \u589e\u5f3a Prompt \u7684\u751f\u6210\u6548\u679c\nif __name__ == \"__main__\":\n    # \u6d4b\u8bd5\u56fe\u50cf\u8def\u5f84\uff08\u53ef\u66ff\u6362\u4e3a\u4f60\u7684\u5bcc\u6587\u672c\u56fe\u50cf\u8def\u5f84\uff0c\u5982\u6d77\u62a5\u3001\u6587\u6863\u622a\u56fe\uff09\n    test_image_path = \"path/to/your/test/poster.jpg\"\n    # \u57fa\u7840 Prompt\uff08\u91c7\u7528\u8be6\u5c3d\u63cf\u8ff0\u6a21\u677f\uff09\n    base_prompt = \"Describe this image in extreme detail. Start with the main subject, then describe the background, lighting, colors, and artistic style.\"\n    # \u751f\u6210\u589e\u5f3a Prompt\n    enhanced_prompt = generate_ocr_enhanced_prompt(test_image_path, base_prompt)\n    print(\"OCR \u589e\u5f3a\u540e\u7684 Prompt:\")\n    print(enhanced_prompt)\n</code></pre> <p>\u8865\u5145\u4f18\u5316\u6280\u5de7\uff1a</p> <ul> <li>\u7f6e\u4fe1\u5ea6\u9608\u503c\u8c03\u6574\uff1a\u5bf9\u4e8e\u6587\u5b57\u6e05\u6670\u7684\u56fe\u50cf\uff08\u5982\u9ad8\u6e05\u6587\u6863\u3001\u6b63\u89c4\u6d77\u62a5\uff09\uff0c\u53ef\u5c06\u7f6e\u4fe1\u5ea6\u9608\u503c\u8c03\u6574\u4e3a 0_8-0_9\uff0c\u8fc7\u6ee4\u5c11\u91cf\u9519\u8bef\u7ed3\u679c\uff1b\u5bf9\u4e8e\u6587\u5b57\u6a21\u7cca\u3001\u5b57\u4f53\u590d\u6742\u7684\u56fe\u50cf\uff08\u5982\u8001\u65e7\u6d77\u62a5\u3001\u624b\u5199\u4f53\uff09\uff0c\u53ef\u5c06\u9608\u503c\u8c03\u6574\u4e3a 0_7-0_8\uff0c\u907f\u514d\u6f0f\u8ba4\u6709\u6548\u6587\u5b57\u3002</li> <li>\u6587\u672c\u4e0a\u4e0b\u6587\u4f18\u5316\uff1a\u5bf9\u4e8e\u591a\u5217\u6587\u672c\u3001\u5c42\u7ea7\u6587\u672c\uff08\u5982\u6807\u9898\u3001\u6b63\u6587\u3001\u811a\u6ce8\uff09\uff0c\u53ef\u7ed3\u5408 Bounding Box \u7684\u5750\u6807\u4fe1\u606f\uff0c\u5bf9\u6587\u672c\u8fdb\u884c\u5206\u7c7b\u62fc\u63a5\uff0c\u4f8b\u5982 \u201c\u6807\u9898\uff1a\u590f\u65e5\u4fc3\u9500\uff1b\u6b63\u6587\uff1a\u5168\u573a 5 \u6298\u8d77\uff0c6 \u6708 1 \u65e5 - 6 \u6708 10 \u65e5\uff1b\u811a\u6ce8\uff1a\u6700\u7ec8\u89e3\u91ca\u6743\u5f52\u672c\u5e97\u6240\u6709\u201d\uff0c\u8ba9 VLM \u66f4\u6e05\u6670\u5730\u7406\u89e3\u6587\u5b57\u7684\u5c42\u7ea7\u5173\u7cfb\u3002</li> <li>Prompt \u878d\u5408\u4f18\u5316\uff1a\u6839\u636e\u56fe\u50cf\u7c7b\u578b\u8c03\u6574\u878d\u5408\u8bdd\u672f\uff0c\u5982\u6587\u6863\u56fe\u50cf\u53ef\u52a0\u5165 \u201cDescribe the layout of the text and the relationship between the text and the document structure\u201d\uff0c\u6d77\u62a5\u56fe\u50cf\u53ef\u52a0\u5165 \u201cDescribe the font style of the text and the role of the text in the promotional scene\u201d\uff0c\u63d0\u5347\u63cf\u8ff0\u7684\u9488\u5bf9\u6027\u3002</li> <li>\u591a OCR \u5f15\u64ce\u878d\u5408\uff1a\u5bf9\u4e8e\u6781\u9ad8\u7cbe\u5ea6\u8981\u6c42\u7684\u573a\u666f\uff0c\u53ef\u540c\u65f6\u4f7f\u7528 PaddleOCR \u548c Tesseract \u4e24\u79cd\u5f15\u64ce\uff0c\u53d6\u4e24\u8005\u8bc6\u522b\u7ed3\u679c\u7684\u4ea4\u96c6\uff0c\u8fdb\u4e00\u6b65\u63d0\u5347\u6587\u5b57\u8bc6\u522b\u7cbe\u5ea6\u3002</li> </ul> <p>\u5b9e\u6218\u6536\u76ca\uff1aOCR \u589e\u5f3a\u5bf9\u5bcc\u6587\u672c\u56fe\u50cf\u7684\u91cd\u63cf\u8ff0\u8d28\u91cf\u63d0\u5347\u6548\u679c\u6781\u5176\u663e\u8457\uff0c\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5b9e\u6218\u5bf9\u6bd4\u6848\u4f8b\uff1a</p> <ul> <li>\u666e\u901a VLM\uff08\u65e0 OCR \u589e\u5f3a\uff09\u5bf9\u7535\u5546\u6d77\u62a5\u7684\u63cf\u8ff0\uff1a\"A red promotional poster with a white background, featuring some vague text and a button at the bottom.\"\uff08\u4e00\u5f20\u7ea2\u8272\u7684\u4fc3\u9500\u6d77\u62a5\uff0c\u767d\u8272\u80cc\u666f\uff0c\u5305\u542b\u4e00\u4e9b\u6a21\u7cca\u7684\u6587\u5b57\u548c\u5e95\u90e8\u7684\u4e00\u4e2a\u6309\u94ae\u3002\uff09</li> <li>OCR \u589e\u5f3a\u540e VLM \u7684\u63cf\u8ff0\uff1a\"A promotional red poster with a white background, featuring the text 'SUMMER SALE 50% OFF' in large white bold letters at the top center of the poster, and 'Shop Now' in a small blue button at the bottom right. The text 'SUMMER SALE' is in a decorative font, with a yellow shadow effect that makes it stand out. The overall layout is simple and eye-catching, focusing on highlighting the promotional information. The background is plain white, which makes the red poster and white text more prominent.\"\uff08\u4e00\u5f20\u7ea2\u8272\u7684\u4fc3\u9500\u6d77\u62a5\uff0c\u767d\u8272\u80cc\u666f\uff0c\u6d77\u62a5\u9876\u90e8\u4e2d\u592e\u6709\u5927\u53f7\u767d\u8272\u7c97\u4f53\u6587\u5b57 \u201cSUMMER SALE 50% OFF\u201d\uff0c\u53f3\u4e0b\u89d2\u7684\u84dd\u8272\u5c0f\u6309\u94ae\u4e0a\u6709 \u201cShop Now\u201d \u5b57\u6837\u3002\u201cSUMMER SALE\u201d \u91c7\u7528\u88c5\u9970\u5b57\u4f53\uff0c\u5e26\u6709\u9ec4\u8272\u9634\u5f71\u6548\u679c\uff0c\u4f7f\u5176\u66f4\u52a0\u7a81\u51fa\u3002\u6574\u4f53\u5e03\u5c40\u7b80\u6d01\u9192\u76ee\uff0c\u91cd\u70b9\u7a81\u51fa\u4fc3\u9500\u4fe1\u606f\u3002\u80cc\u666f\u4e3a\u7eaf\u767d\u8272\uff0c\u8ba9\u7ea2\u8272\u6d77\u62a5\u548c\u767d\u8272\u6587\u5b57\u66f4\u52a0\u663e\u773c\u3002\uff09</li> </ul> <p>\u8fd9\u79cd\u5dee\u5f02\u5bf9\u4e8e\u8bad\u7ec3\u80fd\u591f\u751f\u6210\u51c6\u786e\u6587\u5b57\u7684\u6a21\u578b\uff08\u5982 Ideogram\u3001SD3\u3001\u6587\u6863\u751f\u6210\u6a21\u578b\uff09\u81f3\u5173\u91cd\u8981 \u2014\u2014 \u5305\u542b\u7cbe\u51c6\u6587\u5b57\u4fe1\u606f\u7684\u91cd\u63cf\u8ff0\uff0c\u80fd\u591f\u8ba9\u6a21\u578b\u5b66\u4f1a \u201c\u6587\u5b57\u7684\u89c6\u89c9\u5448\u73b0\u65b9\u5f0f\u201d \u548c \u201c\u6587\u5b57\u4e0e\u573a\u666f\u7684\u5173\u8054\u5173\u7cfb\u201d\uff0c\u4ece\u800c\u751f\u6210\u66f4\u7b26\u5408\u9700\u6c42\u7684\u56fe\u50cf\u3002\u540c\u65f6\uff0c\u5bf9\u4e8e\u89c6\u89c9\u95ee\u7b54\u3001\u56fe\u50cf\u68c0\u7d22\u7b49\u4efb\u52a1\uff0cOCR \u589e\u5f3a\u540e\u7684\u63cf\u8ff0\u4e5f\u80fd\u63d0\u5347\u4efb\u52a1\u7cbe\u5ea6\uff0c\u8ba9\u6a21\u578b\u66f4\u597d\u5730\u7406\u89e3\u56fe\u50cf\u7684\u6838\u5fc3\u542b\u4e49\u3002</p>"},{"location":"chapter3/3_3/","title":"\u7b2c8\u7ae0\uff1a\u89c6\u9891\u4e0e\u97f3\u9891\u6570\u636e","text":""},{"location":"chapter3/3_3/#8","title":"\u7b2c8\u7ae0\uff1a\u89c6\u9891\u4e0e\u97f3\u9891\u6570\u636e\u5904\u7406","text":""},{"location":"chapter3/3_3/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u89c6\u9891\u6570\u636e\u662f\u591a\u6a21\u6001\u5927\u6a21\u578b\uff08LMM\uff09\u8bad\u7ec3\u4e2d\u6570\u636e\u91cf\u6700\u5927\u3001\u5904\u7406\u96be\u5ea6\u6700\u9ad8\u3001\u4fe1\u606f\u5bc6\u5ea6\u6700\u590d\u6742\u7684\u6a21\u6001\uff0c\u88ab\u8a89\u4e3a\u591a\u6a21\u6001\u5de5\u7a0b\u7684\u201c\u6df1\u6c34\u533a\u201d\u3002\u4e0e\u9759\u6001\u56fe\u50cf\u4e0d\u540c\uff0c\u89c6\u9891\u5f15\u5165\u4e86\u65f6\u95f4\u7ef4\u5ea6\uff08Temporal Dimension\uff09\uff0c\u8fd9\u610f\u5473\u7740\u6570\u636e\u4e0d\u4ec5\u4ec5\u662f\u50cf\u7d20\u7684\u5806\u53e0\uff0c\u66f4\u662f\u56e0\u679c\u903b\u8f91\u3001\u7269\u7406\u89c4\u5f8b\u548c\u8fd0\u52a8\u6a21\u5f0f\u7684\u8f7d\u4f53\u3002</p> <p>\u672c\u7ae0\u5c06\u7cfb\u7edf\u62c6\u89e3\u5982\u4f55\u5c06\u8fde\u7eed\u7684\u3001\u975e\u7ed3\u6784\u5316\u7684\u89c6\u9891\u6d41\u8f6c\u5316\u4e3a\u6a21\u578b\u53ef\u7406\u89e3\u7684\u79bb\u6563 Token\u3002\u6211\u4eec\u5c06\u4ece\u5e95\u5c42\u7684\u955c\u5934\u8fb9\u754c\u68c0\u6d4b\uff08Shot Boundary Detection\uff09\u5165\u624b\uff0c\u6df1\u5165\u89e3\u6790\u57fa\u4e8e\u5185\u5bb9\u7684\u5207\u5206\u7b97\u6cd5\uff1b\u8fdb\u800c\u5256\u6790\u89c6\u9891\u751f\u6210\u7684\u201c\u5fc3\u810f\u201d\u2014\u2014\u89c6\u9891 Tokenizer\uff0c\u5bf9\u6bd4 VQ-VAE \u4e0e Google DeepMind \u6700\u65b0 MagViT-v2 \u7684\u5e95\u5c42\u539f\u7406\uff1b\u6700\u540e\uff0c\u6211\u4eec\u5c06\u6f14\u793a\u5982\u4f55\u5229\u7528 WhisperX \u5b9e\u73b0\u97f3\u89c6\u9891\u7684\u5b57\u7ea7\uff08Word-level\uff09\u4e43\u81f3\u97f3\u7d20\u7ea7\uff08Phoneme-level\uff09\u7cbe\u51c6\u5bf9\u9f50\uff0c\u4e3a\u6a21\u578b\u6784\u5efa\u65f6\u7a7a\u540c\u6b65\u7684\u76d1\u7763\u4fe1\u53f7\u3002</p> <p>\u5b66\u4e60\u76ee\u6807\uff1a * \u5de5\u7a0b\u80fd\u529b\uff1a\u638c\u63e1\u4f7f\u7528 PySceneDetect \u7ed3\u5408 ffmpeg \u5173\u952e\u5e27\u5143\u6570\u636e\u8fdb\u884c\u4e24\u7ea7\u573a\u666f\u5207\u5206\uff08Coarse-to-Fine\uff09\u7684\u9ad8\u6548\u7b56\u7565\u3002 * \u7406\u8bba\u6df1\u5ea6\uff1a\u6df1\u5165\u7406\u89e3 Video Tokenization \u4e2d\u7684\u201cCodebook Collapse\u201d\uff08\u7801\u672c\u574d\u584c\uff09\u95ee\u9898\uff0c\u4ee5\u53ca MagViT-v2 \u5982\u4f55\u901a\u8fc7 Lookup-Free Quantization (LFQ) \u5f7b\u5e95\u89e3\u51b3\u8fd9\u4e00\u74f6\u9888\u3002 * \u6570\u636e\u7ba1\u7ebf\uff1a\u5b9e\u73b0\u57fa\u4e8e WhisperX \u7684 Forced Alignment \u6d41\u7a0b\uff0c\u89e3\u51b3\u591a\u8bf4\u8bdd\u4eba\u3001\u80cc\u666f\u566a\u97f3\u58f0\u5b66\u73af\u5883\u4e0b\u7684\u5b57\u5e55\u7cbe\u51c6\u5bf9\u9f50\u3002 * \u5b58\u50a8\u4f18\u5316\uff1a\u4e86\u89e3\u6d77\u91cf\u89c6\u9891\u6570\u636e\u7684\u5b58\u50a8\u5206\u7247\uff08Sharding\uff09\u4e0e\u9ad8\u6548\u52a0\u8f7d\u65b9\u6848\u3002</p> <p>\u573a\u666f\u5f15\u5165\uff1a</p> <p>\u201c\u60f3\u8c61\u4f60\u6b63\u5728\u8bad\u7ec3\u4e00\u4e2a\u50cf Sora \u4e00\u6837\u7684\u4e16\u754c\u6a21\u578b\u3002\u4f60\u4e0b\u8f7d\u4e86\u4e00\u90e8 2 \u5c0f\u65f6\u7684\u7535\u5f71\u300a\u6cf0\u5766\u5c3c\u514b\u53f7\u300b\u4f5c\u4e3a\u8bad\u7ec3\u6570\u636e\u3002</p> <p>\u5982\u679c\u4f60\u7b80\u5355\u7c97\u66b4\u5730\u6309\u6bcf 10 \u79d2\u4e00\u6bb5\u8fdb\u884c\u5207\u5206\uff0c\u4f60\u4f1a\u9047\u5230\u4e25\u91cd\u7684\u2018\u8bed\u4e49\u65ad\u88c2\u2019\uff1a\u4e00\u6bb5\u89c6\u9891\u7684\u524d 5 \u79d2\u662f\u7532\u677f\u4e0a\u5e73\u9759\u7684\u6d77\u98ce\uff0c\u540e 5 \u79d2\u7a81\u7136\u8df3\u5230\u4e86\u55a7\u95f9\u7684\u9910\u5385\u3002\u8fd9\u79cd\u8de8\u8d8a\u573a\u666f\u7684\u2018\u786c\u5207\u2019\uff08Hard Cut\uff09\u4f1a\u8ba9\u6a21\u578b\u611f\u5230\u56f0\u60d1\uff1a\u2018\u4eba\u662f\u600e\u4e48\u5728 0_1 \u79d2\u5185\u4ece\u5ba4\u5916\u77ac\u79fb\u5230\u5ba4\u5185\u7684\uff1f\u2019\u8fd9\u4e0d\u4ec5\u6d6a\u8d39\u4e86\u7b97\u529b\uff0c\u8fd8\u8ba9\u6a21\u578b\u5b66\u5230\u4e86\u9519\u8bef\u7684\u7269\u7406\u89c4\u5f8b\u3002</p> <p>\u6b64\u5916\uff0c\u58f0\u97f3\u7684\u65f6\u5e8f\u7cbe\u5ea6\u5c31\u662f\u751f\u547d\u3002\u5982\u679c\u4f60\u7684\u5b57\u5e55\u6bd4\u753b\u9762\u6162\u4e86 2 \u79d2\uff0c\u5f53\u753b\u9762\u4e2d Rose \u5728\u5f20\u5634\u65f6\uff0c\u5bf9\u5e94\u7684 Token \u5374\u662f Jack \u7684\u53f0\u8bcd\u3002\u6a21\u578b\u4f1a\u9519\u8bef\u5730\u5c06\u2018Jack\u7684\u58f0\u97f3\u7279\u5f81\u2019\u5173\u8054\u5230\u2018Rose\u7684\u9762\u90e8\u7279\u5f81\u2019\u4e0a\u3002\u5728\u4e07\u4ebf\u7ea7 Token \u7684\u8bad\u7ec3\u4e2d\uff0c\u8fd9\u79cd\u5fae\u5c0f\u7684\u9519\u4f4d\u4f1a\u88ab\u653e\u5927\u4e3a\u4e25\u91cd\u7684\u5e7b\u89c9\u3002\u201d</p>"},{"location":"chapter3/3_3/#8_1-scene-detection","title":"8_1 \u89c6\u9891\u5904\u7406\u6d41\u6c34\u7ebf\uff1a\u573a\u666f\u5207\u5206 (Scene Detection)","text":"<p>\u89c6\u9891\u5728\u672c\u8d28\u4e0a\u5e76\u975e\u8fde\u7eed\u7684\u6d41\uff0c\u800c\u662f\u7531\u4e00\u4e2a\u4e2a\u72ec\u7acb\u7684\u201c\u955c\u5934\uff08Shot\uff09\u201d\u62fc\u63a5\u800c\u6210\u7684\u5e8f\u5217\u3002\u6bcf\u4e00\u4e2a\u955c\u5934\u4ee3\u8868\u4e86\u4e00\u6b21\u6444\u50cf\u673a\u7684\u5f00\u542f\u4e0e\u5173\u95ed\uff08\u6216\u89c6\u89d2\u7684\u8fde\u7eed\u79fb\u52a8\uff09\u3002\u8bad\u7ec3\u89c6\u9891\u751f\u6210\u6a21\u578b\uff08Video Generative Models\uff09\uff0c\u5fc5\u987b\u4fdd\u8bc1\u6bcf\u4e2a\u8bad\u7ec3\u6837\u672c\uff08Training Clip\uff09\u90fd\u5728\u540c\u4e00\u4e2a\u955c\u5934\u5185\uff0c\u786e\u4fdd\u65f6\u7a7a\u8fde\u7eed\u6027\uff08Spatio-Temporal Continuity\uff09\u3002</p>"},{"location":"chapter3/3_3/#8_11-gop-i","title":"8_1.1 \u89c6\u9891\u7ed3\u6784\u7684\u5fae\u89c2\u89c6\u89d2\uff1aGOP \u4e0e I \u5e27","text":"<p>\u5728\u6df1\u5165\u5207\u5206\u7b97\u6cd5\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u7406\u89e3\u89c6\u9891\u7f16\u7801\u7684\u57fa\u7840\u3002</p> <ul> <li>I-Frame (Intra-coded picture)\uff1a\u5173\u952e\u5e27\u3002\u5b83\u662f\u4e00\u5f20\u5b8c\u6574\u7684\u56fe\u7247\uff0c\u4e0d\u4f9d\u8d56\u5176\u4ed6\u5e27\u5373\u53ef\u89e3\u7801\u3002\u901a\u5e38\u4e5f\u662f\u573a\u666f\u53d8\u6362\u7684\u8d77\u70b9\u3002</li> <li>P-Frame (Predicted picture)\uff1a\u524d\u5411\u9884\u6d4b\u5e27\u3002\u53ea\u5b58\u50a8\u4e0e\u524d\u4e00\u5e27\u7684\u5dee\u5f02\u3002</li> <li>B-Frame (Bi-predictive picture)\uff1a\u53cc\u5411\u9884\u6d4b\u5e27\u3002\u53c2\u8003\u524d\u540e\u5e27\u8fdb\u884c\u538b\u7f29\uff0c\u538b\u7f29\u7387\u6700\u9ad8\u3002</li> </ul> <p>GOP (Group of Pictures)\uff1a\u4e24\u4e2a I \u5e27\u4e4b\u95f4\u7684\u5e8f\u5217\u3002\u89c6\u9891\u64ad\u653e\u5668\u5728\u62d6\u52a8\u8fdb\u5ea6\u6761\u65f6\uff0c\u901a\u5e38\u4f1a\u201c\u5438\u9644\u201d\u5230\u6700\u8fd1\u7684 I \u5e27\uff0c\u56e0\u4e3a\u89e3\u7801\u5fc5\u987b\u4ece\u8fd9\u91cc\u5f00\u59cb\u3002\u6211\u4eec\u7684\u5207\u5206\u7b56\u7565\u5fc5\u987b\u5229\u7528\u8fd9\u4e00\u7279\u6027\u6765\u52a0\u901f\u3002</p>"},{"location":"chapter3/3_3/#8_12","title":"8_1.2 \u7b97\u6cd5\u9009\u578b\u4e0e\u7b56\u7565","text":"<p> \u56fe 8-1\uff1a\u89c6\u9891\u573a\u666f\u5207\u5206\u7684\u4e24\u79cd\u7b56\u7565\u4e0eHSV\u76f4\u65b9\u56fe\u5dee\u5f02</p> <p>PySceneDetect \u662f\u4e1a\u754c\u6807\u51c6\u7684\u5f00\u6e90\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u591a\u79cd\u68c0\u6d4b\u5668\uff0c\u6838\u5fc3\u903b\u8f91\u57fa\u4e8e\u5e27\u95f4\u5dee\u5f02\u5206\u6790\uff1a</p> <ul> <li> <p>\u7b56\u7565\u4e00\uff1aThreshold Detector (\u9608\u503c\u68c0\u6d4b - \u9488\u5bf9\u786c\u5207)</p> <ul> <li>\u539f\u7406\uff1a\u8ba1\u7b97\u76f8\u90bb\u4e24\u5e27\u5728 HSV \u8272\u5f69\u7a7a\u95f4\u6216 RGB \u4eae\u5ea6\u4e0a\u7684\u5e73\u5747\u5dee\u5f02\u503c\uff08Delta\uff09\u3002\u5f53 Delta &gt; <code>threshold</code>\uff08\u5982 30_0\uff09\u65f6\uff0c\u5224\u5b9a\u4e3a\u5207\u70b9\u3002</li> <li>\u9002\u7528\uff1a\u7edd\u5927\u591a\u6570\u7535\u5f71\u548c\u7528\u6237\u4e0a\u4f20\u89c6\u9891\uff08UGC\uff09\u3002</li> <li>\u5c40\u9650\uff1a\u65e0\u6cd5\u68c0\u6d4b\u6e10\u53d8\u3002</li> </ul> </li> <li> <p>\u7b56\u7565\u4e8c\uff1aAdaptive Detector (\u81ea\u9002\u5e94\u68c0\u6d4b - \u9488\u5bf9\u6e10\u53d8/\u5feb\u8282\u594f)</p> <ul> <li>\u539f\u7406\uff1a\u4e0d\u518d\u4f7f\u7528\u56fa\u5b9a\u9608\u503c\uff0c\u800c\u662f\u7ef4\u62a4\u4e00\u4e2a\u6ed1\u52a8\u7a97\u53e3\uff08Sliding Window\uff09\u3002\u6bd4\u8f83\u201c\u5f53\u524d\u5e27\u201d\u4e0e\u201c\u7a97\u53e3\u5185\u5e73\u5747\u5e27\u5dee\u201d\u7684\u6bd4\u7387\u3002</li> <li>\u9002\u7528\uff1a\u6de1\u5165\u6de1\u51fa\uff08Fade In/Out\uff09\u3001\u53e0\u5316\uff08Dissolve\uff09\u6216\u50cf\u52a8\u4f5c\u7247\u90a3\u6837\u6444\u50cf\u673a\u5267\u70c8\u8fd0\u52a8\u7684\u573a\u666f\u3002</li> </ul> </li> </ul> <p>\u8fdb\u9636\u7b56\u7565\uff1a\u4e24\u7ea7\u7ea7\u8054\u5207\u5206 (Two-Stage Cascade Splitting) \u76f4\u63a5\u5bf9 TB \u7ea7\u89c6\u9891\u5168\u91cf\u89e3\u7801\u8fd0\u884c PySceneDetect \u975e\u5e38\u6162\u3002\u6211\u4eec\u63a8\u8350\u201c\u5148\u7c97\u540e\u7ec6\u201d\u7684\u5de5\u4e1a\u7ea7\u65b9\u6848\uff1a</p> <ol> <li>Level-1 (Metadata Scan)\uff1a\u5229\u7528 <code>ffprobe</code> \u5feb\u901f\u626b\u63cf\u89c6\u9891\u6d41\u5143\u6570\u636e\uff0c\u63d0\u53d6\u6240\u6709 I-Frame \u7684\u65f6\u95f4\u6233\u3002I-Frame \u5f80\u5f80\u51fa\u73b0\u5728\u573a\u666f\u5207\u6362\u5904\uff08\u7f16\u7801\u5668\u503e\u5411\u4e8e\u5728\u5267\u53d8\u5904\u63d2\u5165 I \u5e27\uff09\u3002\u6b64\u6b65\u9aa4\u65e0\u9700\u89e3\u7801\u753b\u9762\uff0c\u901f\u5ea6\u662f\u64ad\u653e\u901f\u5ea6\u7684 100 \u500d\u4ee5\u4e0a\u3002</li> <li>Level-2 (Content Analysis)\uff1a\u4ec5\u5728 Level-1 \u8bc6\u522b\u51fa\u7684\u6f5c\u5728\u5207\u70b9\u524d\u540e \u00b12 \u79d2\u8303\u56f4\u5185\uff0c\u8fd0\u884c PySceneDetect \u7684 <code>ContentDetector</code> \u8fdb\u884c\u7cbe\u786e\u7684\u5e27\u7ea7\u5b9a\u4f4d\u3002</li> </ol>"},{"location":"chapter3/3_3/#8_13","title":"8_1.3 \u6838\u5fc3\u4ee3\u7801\uff1a\u573a\u666f\u5207\u5206\u4e0e\u65e0\u635f\u5206\u5272","text":"<p>\u4ee5\u4e0b\u4ee3\u7801\u6f14\u793a\u4e86\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u6807\u51c6\u5207\u5206\u6d41\u7a0b\u3002\u6ce8\u610f\u5176\u4e2d\u7684\u201c\u6d41\u62f7\u8d1d\u201d\u6280\u5de7\uff0c\u8fd9\u662f\u5904\u7406\u6d77\u91cf\u89c6\u9891\u65f6\u907f\u514d\u5b58\u50a8\u7206\u70b8\u7684\u5173\u952e\u3002</p> <pre><code>from scenedetect import detect, ContentDetector, split_video_ffmpeg\nimport os\nimport logging\n\n# \u914d\u7f6e\u65e5\u5fd7\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\n\ndef process_video_scenes(video_path, output_dir, threshold=27_0):\n    \"\"\"\n    \u68c0\u6d4b\u573a\u666f\u5e76\u4f7f\u7528 ffmpeg \u65e0\u635f\u5207\u5272\u89c6\u9891\n    Args:\n        video_path: \u8f93\u5165\u89c6\u9891\u8def\u5f84\n        output_dir: \u8f93\u51fa\u76ee\u5f55\n        threshold: \u5207\u5206\u9608\u503c (\u7ecf\u9a8c\u503c: 27_0 \u9002\u5408\u5927\u90e8\u5206 1080p \u89c6\u9891)\n    \"\"\"\n    if not os.path.exists(output_dir):\n        os.makedirs(output_dir)\n\n    logging.info(f\"Starting scene detection for: {video_path}\")\n\n    # 1. \u573a\u666f\u68c0\u6d4b\n    # threshold=27_0: \u57fa\u4e8e HSV \u7a7a\u95f4\u7684\u76f4\u65b9\u56fe\u5dee\u5f02\u9608\u503c\n    # min_scene_len=15: \u5ffd\u7565\u5c0f\u4e8e 0_5\u79d2 (30fps) \u7684\u7247\u6bb5\u3002\n    # \u6781\u77ed\u7684\u7247\u6bb5\u901a\u5e38\u662f\u95ea\u5149\u706f\u3001\u6545\u969c\u6216\u8005\u662f\u5207\u5206\u9519\u8bef\u7684\u566a\u97f3\uff0c\u4e0d\u9002\u5408\u4f5c\u4e3a\u8bad\u7ec3\u6570\u636e\u3002\n    scene_list = detect(\n        video_path, \n        ContentDetector(threshold=threshold, min_scene_len=15)\n    )\n\n    # 2. \u7edf\u8ba1\u4e0e\u8fc7\u6ee4\n    # \u5728\u6b64\u5904\u53ef\u4ee5\u6dfb\u52a0\u903b\u8f91\uff1a\u6bd4\u5982\u5408\u5e76\u8fc7\u77ed\u7684\u76f8\u90bb\u573a\u666f\uff0c\u6216\u8005\u4e22\u5f03\u5c0f\u4e8e 3 \u79d2\u7684\u573a\u666f\n    valid_scenes = []\n    for scene in scene_list:\n        start, end = scene\n        duration = (end.get_frames() - start.get_frames()) / start.get_framerate()\n        if duration &gt;= 3_0: # \u53ea\u4fdd\u7559\u5927\u4e8e3\u79d2\u7684\u7247\u6bb5\u7528\u4e8e\u8bad\u7ec3\n            valid_scenes.append(scene)\n\n    logging.info(f\"Detected {len(scene_list)} scenes, kept {len(valid_scenes)} valid scenes.\")\n\n    # 3. \u5206\u5272\u89c6\u9891 (Stream Copy)\n    # \u5173\u952e\u70b9\uff1aarg_override='-c:v copy -c:a copy'\n    # \u8fd9\u6307\u793a ffmpeg \u76f4\u63a5\u62f7\u8d1d\u4e8c\u8fdb\u5236\u6d41\uff0c\u4e0d\u8fdb\u884c [\u89e3\u7801 -&gt; \u50cf\u7d20 -&gt; \u7f16\u7801] \u7684\u8fc7\u7a0b\u3002\n    # \u4f18\u70b9 1\uff1a\u901f\u5ea6\u6781\u5feb\uff08\u53d7\u9650\u4e8e\u78c1\u76d8 I/O\uff0c\u800c\u975e CPU\uff09\u3002\n    # \u4f18\u70b9 2\uff1a\u753b\u8d28 100% \u65e0\u635f\uff0c\u6ca1\u6709\u4efb\u4f55\u91cd\u7f16\u7801\u5e26\u6765\u7684\u4f2a\u5f71\u3002\n    split_video_ffmpeg(\n        video_path, \n        valid_scenes, \n        output_dir=output_dir, \n        show_progress=True,\n        arg_override='-c:v copy -c:a copy' \n    )\n\n# \u907f\u5751\u6307\u5357\uff1a\u6570\u636e\u81a8\u80c0\u707e\u96be\n# \u5343\u4e07\u4e0d\u8981\u628a\u5207\u5206\u540e\u7684\u89c6\u9891\u89e3\u7801\u6210\u56fe\u7247\u5e8f\u5217\uff08png/jpg\uff09\u6216 numpy array \u957f\u671f\u5b58\u76d8\uff01\n# \u7b97\u4e00\u7b14\u8d26\uff1a\n# 1\u5c0f\u65f6 1080p H.264 \u89c6\u9891 \u2248 2GB\n# \u89e3\u7801\u540e\uff1a3600\u79d2 * 30\u5e27 * 1920 * 1080 * 3\u5b57\u8282 \u2248 670 GB\n# \u81a8\u80c0\u7cfb\u6570 &gt; 300\u500d\u3002\n# \u59cb\u7ec8\u5b58\u50a8\u538b\u7f29\u683c\u5f0f (mp4/mkv)\uff0c\u53ea\u5728\u8bad\u7ec3 DataLoader \u7684 __getitem__ \u4e2d\u5229\u7528 GPU (NVDEC) \u5b9e\u65f6\u89e3\u7801\u3002\n</code></pre>"},{"location":"chapter3/3_3/#8_2-tokenization","title":"8_2 \u89c6\u9891 Tokenization\uff1a\u4ece\u50cf\u7d20\u6d77\u6d0b\u5230\u79bb\u6563\u5c9b\u5c7f","text":"<p>\u5bf9\u4e8e Sora\u3001Gen-2 \u8fd9\u6837\u57fa\u4e8e Transformer \u7684\u6269\u6563\u6a21\u578b\uff08DiT\uff09\uff0c\u76f4\u63a5\u5728\u50cf\u7d20\u7a7a\u95f4\uff08Pixel Space\uff09\u5efa\u6a21\u662f\u4e0d\u53ef\u884c\u7684\u3002\u4e00\u4e2a 4 \u79d2\u7684 1080p \u89c6\u9891\u5305\u542b\u7ea6 \\(3 \\times 10^8\\) \u4e2a\u50cf\u7d20\u70b9\uff0c\u8ba1\u7b97\u6ce8\u610f\u529b\u77e9\u9635\uff08Attention Matrix\uff09\u4f1a\u5bfc\u81f4\u663e\u5b58\u77ac\u95f4\u6ea2\u51fa\u3002</p> <p>\u56e0\u6b64\uff0c\u89c6\u9891\u5fc5\u987b\u5148\u88ab\u201c\u538b\u7f29\u201d\u6210\u6f5c\u5728\u7a7a\u95f4\uff08Latent Space\uff09\u7684\u79bb\u6563 Token\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u7531 Video Tokenizer \u5b8c\u6210\u3002</p>"},{"location":"chapter3/3_3/#8_21-vq-vae","title":"8_2.1 \u4f20\u7edf\u65b9\u6848\u7684\u75db\u70b9\uff1aVQ-VAE \u4e0e\u201c\u6b7b\u7801\u201d","text":"<p>VQ-VAE (Vector Quantized Variational AutoEncoder) \u662f\u65e9\u671f\u89c6\u9891\u751f\u6210\u6a21\u578b\uff08\u5982 VideoGPT\uff09\u7684\u57fa\u77f3\u3002</p> <ul> <li> <p>\u6d41\u7a0b\uff1a</p> <ol> <li>Encoder\uff1a\u5c06\u89c6\u9891\u5207\u5206\u4e3a 3D Patch\uff08\u4f8b\u5982 \\(16 \\times 16 \\times 16\\) \u7684\u65f6\u7a7a\u5757\uff09\uff0c\u538b\u7f29\u6210\u4f4e\u7ef4\u5411\u91cf \\(z_e(x)\\)\u3002</li> <li>Quantization (\u91cf\u5316)\uff1a\u7ef4\u62a4\u4e00\u4e2a Codebook\uff08\u7801\u672c\uff09\uff0c\u5305\u542b \\(K\\) \u4e2a\u539f\u578b\u5411\u91cf\uff08Embedding\uff09\u3002\u5bf9\u4e8e\u6bcf\u4e2a \\(z_e(x)\\)\uff0c\u5728 Codebook \u4e2d\u627e\u5230\u6b27\u6c0f\u8ddd\u79bb\u6700\u8fd1\u7684\u5411\u91cf \\(e_k\\) \u6765\u66ff\u6362\u5b83\u3002</li> <li>Decoder\uff1a\u5229\u7528 \\(e_k\\) \u91cd\u5efa\u89c6\u9891\u3002</li> </ol> </li> <li> <p>\u81f4\u547d\u7f3a\u9677\uff1aCodebook Collapse (\u7801\u672c\u574d\u584c)     \u5728\u8bad\u7ec3\u521d\u671f\uff0c\u53ea\u6709\u5c11\u6570\u51e0\u4e2a Code\uff08\u4f8b\u5982 Code #5 \u548c Code #100\uff09\u5076\u7136\u88ab\u9009\u4e2d\u3002\u7531\u4e8e\u53ea\u6709\u88ab\u9009\u4e2d\u7684 Code \u624d\u4f1a\u83b7\u5f97\u68af\u5ea6\u66f4\u65b0\uff0c\u5b83\u4eec\u4f1a\u53d8\u5f97\u8d8a\u6765\u8d8a\u201c\u597d\u201d\uff0c\u4ece\u800c\u66f4\u5bb9\u6613\u88ab\u9009\u4e2d\u3002\u8fd9\u5c31\u5f62\u6210\u4e86\u201c\u5bcc\u8005\u6108\u5bcc\u201d\u7684\u9a6c\u592a\u6548\u5e94\u3002</p> <ul> <li>\u540e\u679c\uff1aCodebook \u4e2d 90% \u7684\u5411\u91cf\u53d8\u6210\u4e86\u201c\u6b7b\u7801\u201d\uff08Dead Codes\uff09\uff0c\u4ece\u672a\u88ab\u4f7f\u7528\u3002\u8fd9\u5bfc\u81f4\u6a21\u578b\u7684\u6709\u6548\u8bcd\u6c47\u91cf\u6781\u4f4e\uff0c\u751f\u6210\u7684\u89c6\u9891\u6a21\u7cca\u4e14\u7f3a\u4e4f\u7ec6\u8282\u3002</li> <li>\u8865\u6551\u63aa\u65bd\uff1a\u4f20\u7edf\u65b9\u6cd5\u9700\u8981\u590d\u6742\u7684 Reset \u7b56\u7565\uff08\u5982 k-means \u91cd\u7f6e\uff09\uff0c\u8bad\u7ec3\u6781\u4e0d\u7a33\u5b9a\u3002</li> </ul> </li> </ul>"},{"location":"chapter3/3_3/#8_22-sota-magvit-v2-lfq","title":"8_2.2 SOTA \u65b9\u6848\uff1aMagViT-v2 \u4e0e LFQ","text":"<p>Google DeepMind \u5728 MagViT-v2 \u4e2d\u5f15\u5165\u4e86 LFQ (Lookup-Free Quantization)\uff0c\u5f7b\u5e95\u6539\u53d8\u4e86\u6e38\u620f\u89c4\u5219\u3002</p> <ul> <li> <p>\u6838\u5fc3\u601d\u60f3\uff1a\u4e0d\u67e5\u8868\uff0c\u76f4\u63a5\u7b97\u3002     LFQ \u629b\u5f03\u4e86\u201c\u5bfb\u627e\u6700\u8fd1\u90bb\u201d\u7684\u601d\u60f3\uff0c\u800c\u662f\u76f4\u63a5\u6839\u636e\u6f5c\u5728\u53d8\u91cf\uff08Latent Variable\uff09\u7684\u7b26\u53f7\uff08Sign\uff09\u751f\u6210 Token\u3002</p> </li> <li> <p>\u6570\u5b66\u539f\u7406\uff1a     \u5047\u8bbe Encoder \u8f93\u51fa\u7684\u6f5c\u5728\u5411\u91cf \\(z \\in \\mathbb{R}^D\\)\uff08\u4f8b\u5982\u7ef4\u5ea6 \\(D=18\\)\uff09\u3002     LFQ \u5bf9\u6bcf\u4e00\u7ef4\u8fdb\u884c\u4e8c\u503c\u5316\uff1a     $\\(q_i = \\begin{cases} 1 &amp; \\text{if } z_i &gt; 0 \\\\ 0 &amp; \\text{if } z_i \\le 0 \\end{cases}\\)$</p> <p>\u7136\u540e\uff0c\u5c06\u8fd9 \\(D\\) \u4e2a\u4e8c\u8fdb\u5236\u4f4d\u7ec4\u5408\u6210\u4e00\u4e2a\u6574\u6570\u7d22\u5f15\uff08Integer Index\uff09\uff1a $\\(\\text{Token ID} = \\sum_{i=0}^{D-1} q_i \\cdot 2^i\\)$</p> </li> <li> <p>\u4e3a\u4f55 LFQ \u662f\u98a0\u8986\u6027\u7684\uff1f</p> <ol> <li>\u65e0\u9650\u7684\u6709\u6548\u7801\u672c\uff1a\u5982\u679c \\(D=18\\)\uff0c\u5219\u81ea\u7136\u5f62\u6210\u7684\u7801\u672c\u5927\u5c0f\u4e3a \\(2^{18} = 262,144\\)\u3002\u6240\u6709\u8fd9\u4e9b Code \u90fd\u662f\u7531 \\(D\\) \u4e2a\u72ec\u7acb\u7684\u7ef4\u5ea6\u7ec4\u5408\u800c\u6210\uff0c\u6bcf\u4e2a\u7ef4\u5ea6\u90fd\u59cb\u7ec8\u53c2\u4e0e\u68af\u5ea6\u66f4\u65b0\u3002Codebook \u5229\u7528\u7387\u6052\u5b9a\u4e3a 100%\u3002</li> <li>\u96f6\u8ba1\u7b97\u6210\u672c\uff1a\u6ca1\u6709\u6602\u8d35\u7684\u201c\u5168\u7801\u672c\u8ddd\u79bb\u8ba1\u7b97\u201d\uff0c\u53ea\u6709\u7b80\u5355\u7684\u4f4d\u8fd0\u7b97\u3002</li> <li>\u65f6\u7a7a\u538b\u7f29\uff1aMagViT-v2 \u7ed3\u5408\u4e86 3D Causal CNN\uff0c\u5728\u538b\u7f29\u7a7a\u95f4\u7684\u540c\u65f6\u4fdd\u7559\u4e86\u65f6\u95f4\u56e0\u679c\u6027\uff08\u5373\u5f53\u524d\u7684 Token \u4e0d\u4f1a\u6cc4\u9732\u672a\u6765\u7684\u4fe1\u606f\uff09\uff0c\u8fd9\u5bf9\u751f\u6210\u6a21\u578b\u81f3\u5173\u91cd\u8981\u3002</li> </ol> </li> </ul>"},{"location":"chapter3/3_3/#8_23","title":"8_2.3 \u67b6\u6784\u9009\u578b\u5bf9\u6bd4\u8868","text":"\u7279\u6027 VQ-VAE (TATS/VideoGPT) MagViT-v2 (LFQ) \u91cf\u5316\u673a\u5236 Nearest Neighbor Search (\u67e5\u8868) Sign Function (\u7b26\u53f7\u51fd\u6570\u6295\u5f71) \u8bcd\u6c47\u8868\u5927\u5c0f (Vocab) \u901a\u5e38 1024 - 8192 (\u53d7\u9650\u4e8e\u663e\u5b58\u548c\u574d\u584c) \\(2^{18}\\) (262k) \u751a\u81f3\u66f4\u5927\uff0c\u8f7b\u677e\u6269\u5c55 \u7801\u672c\u5229\u7528\u7387 \u4f4e (\u5bb9\u6613\u574d\u584c\uff0c\u9700 EMA \u7b49\u6280\u5de7) 100% (\u8bbe\u8ba1\u4e0a\u907f\u514d\u4e86\u574d\u584c) \u68af\u5ea6\u53cd\u4f20 \u9700 Straight-Through Estimator (STE) \u6539\u8fdb\u7684 Entropy Penalty + STE \u751f\u6210\u8d28\u91cf \u6613\u6a21\u7cca\uff0c\u7ec6\u8282\u7eb9\u7406\u4e22\u5931 \u6781\u5176\u6e05\u6670\uff0c\u751a\u81f3\u4f18\u4e8e\u539f\u7247 (\u53bb\u566a\u6548\u5e94) \u63a8\u7406\u901f\u5ea6 \u8f83\u6162 (\u5c24\u5176\u662f\u5927\u7801\u672c\u65f6) \u6781\u5feb --- <p>\u4ece VQ-VAE \u5230 MagViT-v2 \u7684\u6f14\u8fdb\u5e76\u975e\u7b80\u5355\u7684\u53c2\u6570\u4f18\u5316\uff0c\u800c\u662f\u89c6\u9891\u79bb\u6563\u5316\u6280\u672f\u7684\u4e00\u6b21\u8303\u5f0f\u8f6c\u79fb\uff08Paradigm Shift\uff09\u2014\u2014\u5373\u4ece\u201c\u57fa\u4e8e\u641c\u7d22\u7684\u8fd1\u4f3c\uff08Search-based Approximation\uff09\u201d\u5411\u201c\u57fa\u4e8e\u8ba1\u7b97\u7684\u6784\u9020\uff08Computation-based Construction\uff09\u201d\u7684\u8de8\u8d8a\u3002</p> <p>\u9996\u5148\uff0c\u5728\u8ba1\u7b97\u590d\u6742\u5ea6\u4e0e\u6269\u5c55\u6027\u65b9\u9762\uff0c\u4f20\u7edf\u7684 VQ-VAE \u5b58\u5728\u6839\u672c\u6027\u7684\u74f6\u9888\u3002\u5176\u91cf\u5316\u8fc7\u7a0b\u4f9d\u8d56\u4e8e\u6700\u8fd1\u90bb\u641c\u7d22\uff08Nearest Neighbor Search\uff09\uff0c\u9700\u8981\u8ba1\u7b97\u7279\u5f81\u5411\u91cf\u4e0e\u7801\u672c\u4e2d\u6240\u6709 \\(K\\) \u4e2a\u539f\u578b\u7684\u6b27\u6c0f\u8ddd\u79bb\uff0c\u5176\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a \\(O(K)\\)\u3002\u8fd9\u610f\u5473\u7740\u6269\u5927\u8bcd\u6c47\u8868\uff08Vocabulary Size\uff09\u4ee5\u63d0\u5347\u8868\u5f81\u80fd\u529b\u5c06\u76f4\u63a5\u5bfc\u81f4\u63a8\u7406\u5ef6\u8fdf\u7684\u7ebf\u6027\u589e\u957f\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cMagViT-v2 \u5f15\u5165\u7684 LFQ (Lookup-Free Quantization) \u673a\u5236\u6452\u5f03\u4e86\u67e5\u8868\u64cd\u4f5c\uff0c\u8f6c\u800c\u5229\u7528\u7b26\u53f7\u51fd\u6570\uff08Sign Function\uff09\u5c06\u6f5c\u5728\u53d8\u91cf\u6295\u5f71\u4e3a\u4e8c\u8fdb\u5236\u4e32\u3002\u8fd9\u4e00\u8fc7\u7a0b\u5c06\u8ba1\u7b97\u590d\u6742\u5ea6\u6052\u5b9a\u964d\u7ef4\u81f3 \\(O(1)\\)\uff0c\u4f7f\u5f97\u6a21\u578b\u80fd\u591f\u5728\u4e0d\u727a\u7272\u63a8\u7406\u901f\u5ea6\u7684\u524d\u63d0\u4e0b\uff0c\u8f7b\u677e\u652f\u6491\u8d77 \\(2^{18}\\) \u751a\u81f3\u66f4\u5927\u7684\u8bcd\u6c47\u7a7a\u95f4\uff0c\u4ece\u800c\u89e3\u51b3\u4e86\u5927\u8bcd\u6c47\u8868\u4e0e\u4f4e\u5ef6\u8fdf\u4e0d\u53ef\u517c\u5f97\u7684\u77db\u76fe\u3002</p> <p>\u5176\u6b21\uff0c\u5728\u7801\u672c\u5229\u7528\u7387\u4e0e\u8bad\u7ec3\u7a33\u5b9a\u6027\u65b9\u9762\uff0c\u4e24\u8005\u8868\u73b0\u8fe5\u5f02\u3002VQ-VAE \u957f\u671f\u53d7\u56f0\u4e8e\u201c\u7801\u672c\u574d\u584c\uff08Codebook Collapse\uff09\u201d\u95ee\u9898\uff0c\u5373\u90e8\u5206\u7f16\u7801\u5411\u91cf\u56e0\u521d\u59cb\u5316\u6216\u68af\u5ea6\u5206\u914d\u4e0d\u5747\u800c\u4ece\u672a\u88ab\u6fc0\u6d3b\uff0c\u5bfc\u81f4\u6709\u6548\u8bcd\u6c47\u91cf\u8fdc\u5c0f\u4e8e\u8bbe\u8ba1\u503c\uff08\u901a\u5e38\u4ec5\u4e3a 1024-8192\uff09\u3002\u8fd9\u8feb\u4f7f\u7814\u7a76\u8005\u5f15\u5165 EMA\uff08\u6307\u6570\u79fb\u52a8\u5e73\u5747\uff09\u6216 k-means \u91cd\u7f6e\u7b49\u590d\u6742\u7684\u5de5\u7a0b\u6280\u5de7\u6765\u7ef4\u6301\u8bad\u7ec3\u3002\u800c MagViT-v2 \u7684 LFQ \u673a\u5236\u57fa\u4e8e\u5404\u7ef4\u5ea6\u7684\u72ec\u7acb\u4e8c\u503c\u5316\u7ec4\u5408\uff0c\u4ece\u6570\u5b66\u7ed3\u6784\u4e0a\u4fdd\u8bc1\u4e86\u7801\u672c\u7a7a\u95f4\u662f\u88ab\u201c\u7ec4\u5408\u751f\u6210\u201d\u800c\u975e\u201c\u79bb\u6563\u67e5\u627e\u201d\u7684\u3002\u53ea\u8981\u6f5c\u5728\u7a7a\u95f4\u7684\u5404\u4e2a\u7ef4\u5ea6\u4fdd\u6301\u6fc0\u6d3b\uff0c\u7ec4\u5408\u51fa\u7684\u7f16\u7801\u4fbf\u80fd\u81ea\u7136\u8986\u76d6\u6574\u4e2a\u7801\u672c\u7a7a\u95f4\uff0c\u5b9e\u73b0\u4e86\u7406\u8bba\u4e0a 100% \u7684\u7801\u672c\u5229\u7528\u7387\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0cMagViT-v2 \u901a\u8fc7 LFQ \u673a\u5236\u5b9e\u73b0\u4e86\u9ad8\u538b\u7f29\u7387\u3001\u9ad8\u4fdd\u771f\u5ea6\u4e0e\u4f4e\u8ba1\u7b97\u6210\u672c\u7684\u7edf\u4e00\uff0c\u5f7b\u5e95\u89e3\u51b3\u4e86\u4f20\u7edf VQ-VAE \u5728\u7ec6\u8282\u7eb9\u7406\u4e22\u5931\u548c\u65f6\u7a7a\u4e00\u81f4\u6027\u5dee\u7684\u7f3a\u9677\u3002\u5bf9\u4e8e\u6784\u5efa\u5982 Sora \u7ea7\u522b\u7684\u5927\u89c4\u6a21\u89c6\u9891\u751f\u6210\u6a21\u578b\u800c\u8a00\uff0cMagViT-v2 \u53ca\u5176\u884d\u751f\u7684 Tokenizer \u67b6\u6784\u5df2\u6210\u4e3a\u5f53\u524d\u5de5\u4e1a\u754c\u7684\u5404\u79cd\u9996\u9009\u65b9\u6848\u3002</p>"},{"location":"chapter3/3_3/#8_3-whisperx-forced-alignment","title":"8_3 \u97f3\u9891\u5bf9\u9f50\uff1aWhisperX \u4e0e\u5f3a\u5236\u5bf9\u9f50 (Forced Alignment)","text":"<p>\u89c6\u9891\u4e0d\u4ec5\u662f\u89c6\u89c9\u6570\u636e\uff0c\u58f0\u97f3\uff08Audio\uff09\u63d0\u4f9b\u4e86\u5929\u7136\u7684\u3001\u65f6\u95f4\u5bc6\u96c6\u7684\u6587\u672c\u63cf\u8ff0\u3002\u5229\u7528\u97f3\u9891\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba9\u6a21\u578b\u5b66\u4e60\u5230\u201c\u7206\u70b8\u58f0\u5bf9\u5e94\u706b\u5149\u201d\u3001\u201c\u54ed\u58f0\u5bf9\u5e94\u6d41\u6cea\u201d\u7b49\u591a\u6a21\u6001\u5173\u8054\u3002</p> <p>\u7136\u800c\uff0c\u666e\u901a\u7684 ASR\uff08\u5982\u539f\u59cb Whisper\uff09\u53ea\u80fd\u7ed9\u51fa\u201c\u53e5\u5b50\u7ea7\u201d\u7684\u65f6\u95f4\u6233\uff0c\u8bef\u5dee\u901a\u5e38\u5728 1-2 \u79d2\u3002\u8fd9\u5bf9\u4e8e\u7cbe\u7ec6\u7684\u89c6\u9891\u8bad\u7ec3\uff08\u5982\u5507\u5f62\u540c\u6b65 Lip-sync\uff09\u662f\u5b8c\u5168\u4e0d\u591f\u7684\u3002\u6211\u4eec\u9700\u8981 WhisperX\u3002</p> <p> \u56fe 8-2\uff1a\u666e\u901a ASR (Segment-level) \u4e0e WhisperX (Word/Phoneme-level) \u7684\u7cbe\u5ea6\u5bf9\u6bd4</p>"},{"location":"chapter3/3_3/#8_31-forced-alignment","title":"8_3.1 \u4e3a\u4ec0\u4e48\u9700\u8981 Forced Alignment\uff1f","text":"<ul> <li>ASR (OpenAI Whisper)\uff1a<ul> <li>\u8f93\u51fa\uff1a<code>\"Hello world\"</code> -&gt; <code>Timestamp: [0_0s -&gt; 2_0s]</code></li> <li>\u95ee\u9898\uff1a\u6a21\u578b\u53ea\u77e5\u9053\u8fd9\u53e5\u8bdd\u843d\u5728\u8fd9\u4e24\u79d2\u5185\uff0c\u4e0d\u77e5\u9053 \"world\" \u5177\u4f53\u5728\u54ea\u4e00\u6beb\u79d2\u5f00\u59cb\u3002</li> </ul> </li> <li>Forced Alignment (WhisperX)\uff1a<ul> <li>\u539f\u7406\uff1a\u5148\u8f6c\u5f55\u51fa\u6587\u672c\uff0c\u7136\u540e\u5229\u7528\u4e00\u4e2a\u9884\u8bad\u7ec3\u7684\u58f0\u5b66\u6a21\u578b\uff08\u5982 Wav2Vec2\uff09\uff0c\u5c06\u6587\u672c\u4e2d\u7684\u97f3\u7d20\uff08Phonemes\uff09\u4e0e\u97f3\u9891\u6ce2\u5f62\u8fdb\u884c\u5f3a\u5236\u5339\u914d\u3002</li> <li>\u8f93\u51fa\uff1a<ul> <li><code>\"Hello\"</code>: <code>[0_12s -&gt; 0_58s]</code></li> <li><code>\"world\"</code>: <code>[0_85s -&gt; 1_45s]</code></li> </ul> </li> <li>\u4ef7\u503c\uff1a\u4f60\u53ef\u4ee5\u6784\u5efa\u8fd9\u6837\u7684\u8bad\u7ec3\u5bf9\uff1a\u5f53\u89c6\u9891\u5e27\u5904\u4e8e 0_85s \u65f6\uff0c\u5f3a\u5236\u6a21\u578b\u5173\u6ce8 \"world\" \u7684 Text Embedding\u3002\u8fd9\u662f\u591a\u6a21\u6001\u7cbe\u7ec6\u5bf9\u9f50\u7684\u57fa\u7840\u3002</li> </ul> </li> </ul>"},{"location":"chapter3/3_3/#8_32-whisperx","title":"8_3.2 \u5de5\u7a0b\u5b9e\u73b0\uff1aWhisperX \u5168\u6d41\u7a0b\u6d41\u6c34\u7ebf","text":"<p>WhisperX \u662f\u4e00\u4e2a\u590d\u6742\u7684 Pipeline\uff0c\u7ed3\u5408\u4e86 VAD\uff08\u8bed\u97f3\u6d3b\u52a8\u68c0\u6d4b\uff09\u3001Whisper\uff08\u8f6c\u5f55\uff09\u3001Wav2Vec2\uff08\u5bf9\u9f50\uff09\u548c Pyannote\uff08\u8bf4\u8bdd\u4eba\u5206\u79bb\uff09\u3002</p> <pre><code>import whisperx\nimport gc\nimport torch\n\ndef align_audio_transcript(audio_file, device=\"cuda\", batch_size=16):\n    \"\"\"\n    \u4f7f\u7528 WhisperX \u8fdb\u884c\u8f6c\u5f55\u548c\u5b57\u7ea7\u5f3a\u5236\u5bf9\u9f50\n    \"\"\"\n    # Step 1: \u8f6c\u5f55 (Transcription)\n    # \u4f7f\u7528 Large-v2 \u6a21\u578b\u4fdd\u8bc1\u6587\u672c\u8f6c\u5f55\u7684\u51c6\u786e\u6027\n    # compute_type=\"float16\" \u80fd\u663e\u8457\u52a0\u901f\uff0c\u4f46\u9700\u8981 Ampere \u67b6\u6784\u4ee5\u4e0a\u663e\u5361 (A100/A10/3090/4090)\n    print(\"1. Loading Whisper model...\")\n    model = whisperx.load_model(\n        \"large-v2\", \n        device, \n        compute_type=\"float16\" \n    )\n\n    print(\"2. Transcribing...\")\n    audio = whisperx.load_audio(audio_file)\n    result = model.transcribe(audio, batch_size=batch_size)\n\n    # \u5173\u952e\u64cd\u4f5c\uff1a\u663e\u5b58\u7ba1\u7406\n    # Whisper \u6a21\u578b\u5de8\u5927\uff0c\u800c\u63a5\u4e0b\u6765\u7684 Alignment \u6a21\u578b\u4e5f\u662f\u663e\u5b58\u5927\u6237\u3002\n    # \u5fc5\u987b\u663e\u5f0f\u5220\u9664\u6a21\u578b\u5e76\u89e6\u53d1\u5783\u573e\u56de\u6536\uff0c\u5426\u5219\u6781\u6613 OOM (Out of Memory)\u3002\n    del model\n    gc.collect()\n    torch.cuda.empty_cache()\n\n    # Step 2: \u5f3a\u5236\u5bf9\u9f50 (Forced Alignment)\n    # \u81ea\u52a8\u52a0\u8f7d\u5bf9\u5e94\u8bed\u8a00\u7684 Wav2Vec2 \u6a21\u578b (\u5982\u82f1\u8bed\u7528 wav2vec2-large-960h)\n    print(\"3. Aligning...\")\n    model_a, metadata = whisperx.load_align_model(\n        language_code=result[\"language\"], \n        device=device\n    )\n\n    # align() \u51fd\u6570\u6267\u884c\u7c7b\u4f3c\u52a8\u6001\u89c4\u5212\uff08Dynamic Programming\uff09\u7684\u7b97\u6cd5\n    # \u5bfb\u627e\u6587\u672c\u97f3\u7d20\u5e8f\u5217\u4e0e\u97f3\u9891\u6ce2\u5f62\u7279\u5f81\u4e4b\u95f4\u7684\u6700\u4f73\u5339\u914d\u8def\u5f84\n    aligned_result = whisperx.align(\n        result[\"segments\"], \n        model_a, \n        metadata, \n        audio, \n        device, \n        return_char_alignments=False # \u8bbe\u4e3a True \u53ef\u83b7\u5f97\u5b57\u7b26\u7ea7\u5bf9\u9f50\uff08\u5982\u7528\u4e8e\u5361\u62c9OK\u5b57\u5e55\uff09\n    )\n\n    # \u7ed3\u679c\u5305\u542b word_segments\uff0c\u5176\u4e2d\u6709\u6bcf\u4e2a\u5355\u8bcd\u7684\u7cbe\u786e start/end\n    # \u4f8b\u5982: [{'word': 'Hello', 'start': 0_1, 'end': 0_5, 'score': 0_98}, ...]\n    return aligned_result\n\n# \u8fdb\u9636\u63d0\u793a\uff1a\n# \u5982\u679c\u9700\u8981\u533a\u5206\u662f\u8c01\u5728\u8bf4\u8bdd\uff08Speaker Diarization\uff09\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8c03\u7528\uff1a\n# diarize_model = whisperx.DiarizationPipeline(use_auth_token=\"YOUR_HF_TOKEN\", device=device)\n# diarize_segments = diarize_model(audio)\n# whisperx.assign_word_speakers(diarize_segments, aligned_result)\n</code></pre>"},{"location":"chapter3/3_3/#8_33","title":"8_3.3 \u751f\u4ea7\u73af\u5883\u907f\u5751\u6307\u5357","text":"<ol> <li> <p>VAD \u8bef\u5224\u4e0e\u80cc\u666f\u97f3\u4e50\u5e72\u6270\uff1a</p> <ul> <li>\u95ee\u9898\uff1aWhisperX \u6781\u5176\u4f9d\u8d56 VAD \u6765\u5207\u5206\u9759\u97f3\u7247\u6bb5\u3002\u5982\u679c\u89c6\u9891 BGM\uff08\u80cc\u666f\u97f3\u4e50\uff09\u5f88\u54cd\uff0cVAD \u4f1a\u8ba4\u4e3a\u6574\u6bb5\u90fd\u662f\u4eba\u58f0\uff0c\u6216\u8005\u53cd\u4e4b\uff0c\u628a\u4eba\u58f0\u6df9\u6ca1\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u5f15\u5165 Demucs \u6216 Spleeter \u8fdb\u884c\u6e90\u5206\u79bb\uff08Source Separation\uff09\u3002</li> <li>\u6d41\u7a0b\uff1a<code>Raw Audio</code> -&gt; <code>Demucs (Extract Vocal Track)</code> -&gt; <code>WhisperX</code>\u3002\u4ec5\u5c06\u63d0\u53d6\u51fa\u7684\u7eaf\u4eba\u58f0\u8f68\u9053\u9001\u5165\u8bc6\u522b\uff0c\u53ef\u4ee5\u5927\u5e45\u63d0\u9ad8\u51c6\u786e\u7387\u3002</li> </ul> </li> <li> <p>\u591a\u8bf4\u8bdd\u4eba\u91cd\u53e0 (Overlapping Speech)\uff1a</p> <ul> <li>\u95ee\u9898\uff1aWhisper \u5bf9\u4e8e\u591a\u4eba\u540c\u65f6\u8bf4\u8bdd\uff08Cocktail Party Problem\uff09\u5904\u7406\u80fd\u529b\u8f83\u5f31\uff0c\u901a\u5e38\u53ea\u80fd\u8f6c\u5f55\u58f0\u97f3\u6700\u5927\u7684\u4eba\uff0c\u6216\u8005\u751f\u6210\u6df7\u4e71\u7684\u6587\u672c\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u5f00\u542f <code>diarization=True</code>\u3002\u867d\u7136\u8fd9\u4f1a\u589e\u52a0 30%-50% \u7684\u63a8\u7406\u65f6\u95f4\uff0c\u4f46\u5bf9\u4e8e\u7535\u89c6\u5267\u3001\u8bbf\u8c08\u7c7b\u89c6\u9891\u6570\u636e\uff0c\u8fd9\u662f\u533a\u5206\u201c\u8c01\u5728\u8bf4\u4ec0\u4e48\u201d\u7684\u552f\u4e00\u65b9\u6cd5\uff0c\u907f\u514d\u6a21\u578b\u6df7\u6dc6\u89d2\u8272\u8eab\u4efd\u3002</li> </ul> </li> <li> <p>\u5e7b\u89c9\u65f6\u95f4\u6233\uff1a</p> <ul> <li>\u95ee\u9898\uff1a\u5728\u957f\u65f6\u95f4\u9759\u97f3\u6216\u7eaf\u97f3\u4e50\u7247\u6bb5\uff0cWhisper \u6709\u65f6\u4f1a\u4ea7\u751f\u201c\u5e7b\u89c9\u201d\uff0c\u91cd\u590d\u8f93\u51fa\u4e0a\u4e00\u53e5\u6b4c\u8bcd\uff0c\u5e76\u7ed9\u51fa\u4e00\u4e2a\u9519\u8bef\u7684\u65f6\u95f4\u6233\u3002</li> <li>\u68c0\u67e5\uff1a\u5728\u540e\u5904\u7406\u4e2d\uff0c\u68c0\u67e5 <code>word['score']</code>\uff08\u7f6e\u4fe1\u5ea6\uff09\u3002\u5982\u679c\u8fde\u7eed\u4e00\u4e32\u5355\u8bcd\u7684\u7f6e\u4fe1\u5ea6\u4f4e\u4e8e 0_4\uff0c\u5efa\u8bae\u4e22\u5f03\u8be5\u7247\u6bb5\u7684\u5bf9\u9f50\u4fe1\u606f\u3002</li> </ul> </li> </ol>"},{"location":"chapter4/4_1/","title":"\u7b2c9\u7ae0\uff1a\u6307\u4ee4\u5fae\u8c03\u6570\u636e (SFT Data) \u2014\u2014 \u6784\u5efa\u6a21\u578b\u7684\u201c\u884c\u4e3a\u51c6\u5219\u201d","text":""},{"location":"chapter4/4_1/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u672c\u7ae0\u5c06\u6df1\u5165\u63a2\u8ba8\u5927\u8bed\u8a00\u6a21\u578b\uff08LLM\uff09\u751f\u547d\u5468\u671f\u4e2d\u81f3\u5173\u91cd\u8981\u7684\u4e00\u73af\u2014\u2014\u4ece\u201c\u901a\u7528\u9884\u8bad\u7ec3\u201d\u5230\u201c\u7279\u5b9a\u6307\u4ee4\u9075\u5faa\u201d\u7684\u5173\u952e\u8f6c\u53d8\u3002\u6211\u4eec\u5c06\u8df3\u51fa\u7b80\u5355\u7684\u6570\u636e\u6536\u96c6\u5c42\u9762\uff0c\u6df1\u5165\u7814\u7a76\u5982\u4f55\u901a\u8fc7\u9ad8\u5ea6\u5de5\u7a0b\u5316\u7684 Prompt \u4f53\u7cfb\u548c\u81ea\u52a8\u5316\u6d41\u6c34\u7ebf\uff08Self-Instruct\u3001Evol-Instruct\uff09\u6765\u6784\u5efa\u9ad8\u8d28\u91cf\u7684 SFT\uff08Supervised Fine-Tuning\uff09\u6570\u636e\u96c6\u3002\u9664\u4e86\u6280\u672f\u5b9e\u73b0\uff0c\u672c\u7ae0\u8fd8\u5c06\u5256\u6790\u80cc\u540e\u7684\u7406\u8bba\u4f9d\u636e\uff1a\u4e3a\u4f55\u5c11\u91cf\u9ad8\u8d28\u91cf\u6570\u636e\u80fd\u64ac\u52a8\u5de8\u5927\u7684\u6a21\u578b\u80fd\u529b\uff1f\u6211\u4eec\u5c06\u91cd\u70b9\u89e3\u51b3\u6570\u636e\u591a\u6837\u6027\u4e0d\u8db3\u3001\u6307\u4ee4\u590d\u6742\u5ea6\u4e0d\u591f\u4ee5\u53ca\u63a8\u7406\u80fd\u529b\u7f3a\u5931\u7684\u95ee\u9898\uff0c\u6700\u7ec8\u6253\u9020\u4e00\u4e2a\u65e2\u61c2\u77e5\u8bc6\u53c8\u61c2\u89c4\u77e9\u7684\u667a\u80fd\u4f53\u3002</p>"},{"location":"chapter4/4_1/#learning-objectives","title":"\u5b66\u4e60\u76ee\u6807 (Learning Objectives)","text":"<ul> <li>\u638c\u63e1\u8fed\u4ee3\u5f0f System Prompt \u5de5\u7a0b\uff1a\u80fd\u591f\u7f16\u5199\u63a7\u5236\u6a21\u578b\u8f93\u51fa\u683c\u5f0f\u3001\u98ce\u683c\u4e0e\u6df1\u5ea6\u7684 System Prompt\uff0c\u7406\u89e3\u89d2\u8272\u8bbe\u5b9a\u5bf9\u6570\u636e\u5206\u5e03\u7684\u5f71\u54cd\u3002</li> <li>\u6df1\u5165\u7406\u89e3\u81ea\u52a8\u5316\u6570\u636e\u751f\u6210\u6d41\u6c34\u7ebf\uff1a\u80fd\u591f\u590d\u73b0\u5e76\u6539\u8fdb Self-Instruct \u548c Evol-Instruct \u7b97\u6cd5\uff0c\u4ece\u96f6\u6784\u5efa\u9886\u57df\u6307\u4ee4\u96c6\uff0c\u7406\u89e3\u5176\u80cc\u540e\u7684\u201c\u6559\u5e08-\u5b66\u751f\u201d\u84b8\u998f\u903b\u8f91\u3002</li> <li>\u5b66\u4f1a\u6784\u9020\u601d\u7ef4\u94fe (Chain-of-Thought, CoT) \u6570\u636e\uff1a\u901a\u8fc7\u663e\u5f0f\u63a8\u7406\u6b65\u9aa4\u589e\u5f3a\u6a21\u578b\u7684\u903b\u8f91\u80fd\u529b\uff0c\u6253\u7834 Transformer \u7684\u201c\u9ed1\u76d2\u201d\u6620\u5c04\u3002</li> <li>\u8bbe\u8ba1\u6570\u636e\u8fc7\u6ee4\u4e0e\u53bb\u91cd\u673a\u5236\uff1a\u638c\u63e1\u4ece ROUGE \u53bb\u91cd\u5230\u8bed\u4e49\u5411\u91cf\u805a\u7c7b\u7684\u9ad8\u7ea7\u6e05\u6d17\u7b56\u7565\uff0c\u786e\u4fdd\u5408\u6210\u6570\u636e\u7684\u8d28\u91cf\u4e0e\u591a\u6837\u6027\u3002</li> </ul> <p>\u573a\u666f\u5f15\u5165\uff1a \u201c\u60f3\u8c61\u4e00\u4e0b\uff0c\u4f60\u7684\u56e2\u961f\u521a\u521a\u9884\u8bad\u7ec3\u5b8c\u4e00\u4e2a 70B \u53c2\u6570\u7684\u57fa\u5ea7\u6a21\u578b\uff0c\u6d88\u8017\u4e86\u6570\u767e\u4e07\u7f8e\u5143\u7684\u7b97\u529b\uff0c\u9605\u8bfb\u4e86\u4e92\u8054\u7f51\u4e0a\u51e0\u4e4e\u6240\u6709\u7684\u6587\u672c\u3002\u6b64\u65f6\u7684\u5b83\u50cf\u662f\u4e00\u4e2a\u535a\u5b66\u4f46\u81ea\u95ed\u7684\u56fe\u4e66\u9986\u7ba1\u7406\u5458\uff0c\u8111\u5b50\u91cc\u88c5\u6ee1\u4e86\u838e\u58eb\u6bd4\u4e9a\u7684\u5267\u672c\u3001Python \u4ee3\u7801\u548c\u91cf\u5b50\u529b\u5b66\u516c\u5f0f\u3002\u7136\u800c\uff0c\u5f53\u4f60\u5728\u6f14\u793a\u4f1a\u4e0a\u5174\u594b\u5730\u8f93\u5165\u2018\u8bf7\u5e2e\u6211\u5236\u5b9a\u4e00\u4e2a\u51cf\u80a5\u8ba1\u5212\u2019\u65f6\uff0c\u6a21\u578b\u5374\u53ea\u662f\u673a\u68b0\u5730\u7eed\u5199\u4e86\u2018\u2026\u2026\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u76ee\u6807\uff0c\u901a\u5e38\u5305\u62ec\u996e\u98df\u548c\u8fd0\u52a8\u2019\uff0c\u751a\u81f3\u5f00\u59cb\u63a5\u7740\u5199\u2018\u51cf\u80a5\u8ba1\u5212\u7684\u5b9a\u4e49\u2019\uff0c\u7136\u540e\u751f\u6210\u4e86\u4e00\u5806\u7ef4\u57fa\u767e\u79d1\u5f0f\u7684\u5e9f\u8bdd\u3002</p> <p>\u4e3a\u4ec0\u4e48\u4f1a\u8fd9\u6837\uff1f\u56e0\u4e3a\u57fa\u5ea7\u6a21\u578b\uff08Base Model\uff09\u7684\u8bad\u7ec3\u76ee\u6807\u662f\u2018\u9884\u6d4b\u4e0b\u4e00\u4e2a Token\u2019\uff0c\u5b83\u5e76\u4e0d\u7406\u89e3\u2018\u6307\u4ee4\u2019\u4e0e\u2018\u56de\u590d\u2019\u7684\u4ea4\u4e92\u6a21\u5f0f\u3002\u4e3a\u4e86\u8ba9\u8fd9\u4e2a\u2018\u535a\u5b66\u5bb6\u2019\u53d8\u6210\u61c2\u4f60\u610f\u56fe\u7684\u2018\u8d34\u8eab\u52a9\u7406\u2019\uff0c\u4f60\u9700\u8981\u7ed9\u5b83\u5582\u98df\u6210\u5343\u4e0a\u4e07\u6761\u9ad8\u8d28\u91cf\u7684\u95ee\u7b54\u5bf9\uff0c\u6559\u5b83\u5982\u4f55\u8bf4\u8bdd\u3001\u5982\u4f55\u901a\u8fc7\u6b65\u9aa4\u89e3\u51b3\u95ee\u9898\u3002\u4f46\u624b\u52a8\u7f16\u5199 10 \u4e07\u6761\u6307\u4ee4\u65e2\u6602\u8d35\u53c8\u7f13\u6162\uff0c\u4e14\u4eba\u7c7b\u7684\u60f3\u8c61\u529b\u5f80\u5f80\u5c40\u9650\u4e8e\u7279\u5b9a\u6a21\u5f0f\u3002\u5982\u4f55\u5728\u4e0d\u4f9d\u8d56\u5927\u89c4\u6a21\u4eba\u5de5\u6807\u6ce8\u7684\u60c5\u51b5\u4e0b\uff0c\u81ea\u52a8\u5316\u751f\u4ea7\u51fa\u65e2\u590d\u6742\u53c8\u591a\u6837\u7684\u9ad8\u8d28\u91cf\u8bad\u7ec3\u6570\u636e\uff1f\u8fd9\u5c31\u662f\u672c\u7ae0\u8981\u89e3\u51b3\u7684\u6838\u5fc3\u5de5\u7a0b\u6311\u6218\u3002\u201d</p>"},{"location":"chapter4/4_1/#9_1-concepts-principles","title":"9_1. \u6838\u5fc3\u6982\u5ff5\u4e0e\u539f\u7406 (Concepts &amp; Principles)","text":"<p>\u5728 SFT \u9636\u6bb5\uff0c\u4e1a\u754c\u5df2\u7ecf\u8fbe\u6210\u5171\u8bc6\uff1a\u6570\u636e\u7684\u8d28\u91cf\u8fdc\u6bd4\u6570\u91cf\u91cd\u8981\u3002\u6211\u4eec\u9700\u8981\u7684\u6570\u636e\u4e0d\u4ec5\u4ec5\u662f\u201c\u8f93\u5165-\u8f93\u51fa\u201d\u5bf9\uff0c\u800c\u662f\u6db5\u76d6\u4e86\u5404\u79cd\u4efb\u52a1\u7c7b\u578b\u3001\u590d\u6742\u5ea6\u5c42\u7ea7\u548c\u63a8\u7406\u6a21\u5f0f\u7684\u6837\u672c\u3002</p>"},{"location":"chapter4/4_1/#9_11-the-surface-form-hypothesis","title":"9_1.1 \u4e3a\u4ec0\u4e48\u8d28\u91cf\u6bd4\u6570\u91cf\u66f4\u91cd\u8981\uff1f\u2014\u2014 \u8868\u9762\u5f62\u5f0f\u5047\u8bbe (The Surface Form Hypothesis)","text":"<p>\u5f88\u591a\u521d\u5b66\u8005\u4f1a\u8bef\u4ee5\u4e3a SFT \u662f\u4e3a\u4e86\u8ba9\u6a21\u578b\u201c\u5b66\u4e60\u65b0\u77e5\u8bc6\u201d\u3002\u7136\u800c\uff0c\u57fa\u4e8e LIMA (Less Is More for Alignment) \u7b49\u7ecf\u5178\u7814\u7a76\u7684\u53d1\u73b0\uff0cSFT \u7684\u6838\u5fc3\u4f5c\u7528\u5e76\u975e\u6ce8\u5165\u77e5\u8bc6\uff0c\u800c\u662f\u5bf9\u9f50\u683c\u5f0f\u3002</p> <p>\u8868\u9762\u5f62\u5f0f\u5047\u8bbe\u8ba4\u4e3a\uff0c\u6a21\u578b\u5728\u9884\u8bad\u7ec3\u9636\u6bb5\u5df2\u7ecf\u638c\u63e1\u4e86\u7edd\u5927\u591a\u6570\u7684\u4e16\u754c\u77e5\u8bc6\u548c\u903b\u8f91\u80fd\u529b\uff0cSFT \u4ec5\u4ec5\u662f\u6559\u4f1a\u6a21\u578b\u4e00\u79cd\u7279\u5b9a\u7684\u201c\u4ea4\u4e92\u683c\u5f0f\u201d\u6216\u201c\u98ce\u683c\u201d\uff0c\u4ee5\u4fbf\u80fd\u591f\u63d0\u53d6\u51fa\u9884\u8bad\u7ec3\u9636\u6bb5\u6f5c\u85cf\u7684\u80fd\u529b\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u9884\u8bad\u7ec3\u662f\u8ba9\u6a21\u578b\u8bfb\u5b8c\u4e86\u4e00\u6574\u5ea7\u56fe\u4e66\u9986\u7684\u4e66\uff0cSFT \u53ea\u662f\u6559\u5b83\u5982\u4f55\u7528\u4eba\u7c7b\u559c\u6b22\u7684\u53e3\u543b\u6765\u56de\u7b54\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u6559\u5b83\u4e66\u91cc\u7684\u5185\u5bb9\u3002</p> <p>\u8fd9\u5c31\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u4e00\u65e6\u6570\u636e\u5305\u542b\u9519\u8bef\u3001\u566a\u97f3\u6216\u903b\u8f91\u65ad\u5c42\uff0c\u6a21\u578b\u7684\u8868\u73b0\u4f1a\u6025\u5267\u4e0b\u964d\u2014\u2014\u56e0\u4e3a\u6a21\u578b\u6b63\u5728\u5b66\u4e60\u201c\u5982\u4f55\u8c03\u7528\u77e5\u8bc6\u7684\u7d22\u5f15\u201d\uff0c\u5982\u679c\u7d22\u5f15\u9519\u4e86\uff0c\u77e5\u8bc6\u518d\u4e30\u5bcc\u4e5f\u65e0\u6cd5\u88ab\u6b63\u786e\u68c0\u7d22\u3002\u56e0\u6b64\uff0c\u51e0\u5343\u6761\u9ad8\u8d28\u91cf\u3001\u9ad8\u591a\u6837\u6027\u7684\u6570\u636e\uff0c\u5f80\u5f80\u6bd4\u51e0\u767e\u4e07\u6761\u4f4e\u8d28\u91cf\u3001\u540c\u8d28\u5316\u7684\u6570\u636e\u66f4\u80fd\u8bad\u7ec3\u51fa\u4f18\u79c0\u7684\u6a21\u578b\u3002</p>"},{"location":"chapter4/4_1/#9_12-prompt-engineering","title":"9_1.2 Prompt Engineering \u7684\u5de5\u7a0b\u5316\u89c6\u89d2","text":"<p>\u5728\u6570\u636e\u5408\u6210\u4e2d\uff0cPrompt \u4e0d\u518d\u662f\u7b80\u5355\u7684\u5bf9\u8bdd\u8f93\u5165\uff0c\u800c\u662f\u751f\u6210\u6570\u636e\u7684\u6e90\u4ee3\u7801\u3002\u6211\u4eec\u5c06 Prompt \u89c6\u4e3a\u4e00\u79cd\u53ef\u7f16\u7a0b\u7684\u6a21\u5757\uff0c\u901a\u8fc7\u8fed\u4ee3\u4f18\u5316\u6765\u63a7\u5236\u5408\u6210\u6570\u636e\u7684\u5206\u5e03\u3002\u4e00\u4e2a\u4f18\u79c0\u7684 Prompt \u4f53\u7cfb\u901a\u5e38\u5305\u542b\u4ee5\u4e0b\u7ec4\u4ef6\uff1a</p> <ul> <li>System Prompt (\u7cfb\u7edf\u63d0\u793a\u8bcd)\uff1a \u5b9a\u4e49\u4e86\u6570\u636e\u751f\u6210\u5668\u7684\u201c\u4eba\u8bbe\u201d\u548c\u201c\u8fb9\u754c\u201d\u3002\u8fd9\u4e0d\u4ec5\u4ec5\u662f\u8d4b\u4e88\u4e00\u4e2a\u8eab\u4efd\uff0c\u66f4\u662f\u4e3a\u4e86\u901a\u8fc7\u89d2\u8272\u626e\u6f14\uff08Role-Playing\uff09\u6765\u6fc0\u6d3b\u5927\u6a21\u578b\u6f5c\u5728\u7684\u7279\u5b9a\u9886\u57df\u8bcd\u6c47\u5206\u5e03\u3002\u4f8b\u5982\uff0c\u626e\u6f14\u201c\u4e25\u8c28\u7684\u5f8b\u5e08\u201d\u548c\u201c\u70ed\u60c5\u7684\u9500\u552e\u201d\u4f1a\u751f\u6210\u622a\u7136\u4e0d\u540c\u7684\u53e5\u5f0f\u7ed3\u6784\u3002</li> <li>Few-Shot Examples (\u5c11\u6837\u672c\u793a\u4f8b)\uff1a \u901a\u8fc7 In-Context Learning (\u4e0a\u4e0b\u6587\u5b66\u4e60) \u951a\u5b9a\u8f93\u51fa\u7684\u683c\u5f0f\u548c\u98ce\u683c\u3002\u8fd9\u4e9b\u793a\u4f8b\u8d77\u5230\u4e86\u201c\u53bb\u566a\u201d\u7684\u4f5c\u7528\uff0c\u544a\u8bc9\u6a21\u578b\u201c\u8fd9\u5c31\u662f\u6211\u60f3\u8981\u7684\u6807\u51c6\u7b54\u6848\u201d\u3002</li> <li>Negative Constraints (\u8d1f\u5411\u7ea6\u675f)\uff1a \u660e\u786e\u7981\u6b62\u6a21\u578b\u751f\u6210\u67d0\u79cd\u6a21\u5f0f\u7684\u6570\u636e\u3002\u5728\u5927\u6a21\u578b\u751f\u6210\u4e2d\uff0c\u6a21\u578b\u5f80\u5f80\u503e\u5411\u4e8e\u5077\u61d2\u6216\u4f7f\u7528\u5e38\u89c1\u7684\u9648\u8bcd\u6ee5\u8c03\uff08Clich\u00e9s\uff09\uff0c\u8d1f\u5411\u7ea6\u675f\u662f\u6253\u7834\u8fd9\u79cd\u7edf\u8ba1\u60ef\u6027\u7684\u5173\u952e\u624b\u6bb5\uff08\u4f8b\u5982\uff1a\u201c\u4e0d\u8981\u4f7f\u7528\u2018\u4ece\u524d\u6709\u5ea7\u5c71\u2019\u4f5c\u4e3a\u6545\u4e8b\u5f00\u5934\u201d\uff09\u3002</li> </ul>"},{"location":"chapter4/4_1/#9_13","title":"9_1.3 \u81ea\u52a8\u5316\u6784\u9020\u65b9\u6cd5\u8bba","text":"<p>\u4e3a\u4e86\u7a81\u7834\u4eba\u7c7b\u6570\u636e\u7684\u74f6\u9888\uff0c\u4e1a\u754c\u6f14\u5316\u51fa\u4e86\u4e24\u79cd\u6838\u5fc3\u7b56\u7565\u3002\u7406\u89e3\u8fd9\u4e24\u8005\u7684\u533a\u522b\u5bf9\u4e8e\u6784\u5efa\u5e73\u8861\u7684\u6570\u636e\u96c6\u81f3\u5173\u91cd\u8981\u3002</p> <ul> <li>Self-Instruct (\u81ea\u6211\u6307\u4ee4)\uff1a \u4fa7\u91cd\u4e8e\u5e7f\u5ea6 (Breadth)\u3002\u5229\u7528\u5f3a\u6a21\u578b\uff08\u5982 GPT-4\uff09\u57fa\u4e8e\u5c11\u91cf\u79cd\u5b50\u4efb\u52a1\uff08Seed Tasks\uff09\u88c2\u53d8\u51fa\u5927\u91cf\u65b0\u4efb\u52a1\u3002\u5b83\u7684\u6838\u5fc3\u5047\u8bbe\u662f\uff1a\u6a21\u578b\u5df2\u7ecf\u89c1\u8fc7\u4e86\u8db3\u591f\u591a\u7684\u4efb\u52a1\u7c7b\u578b\uff0c\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u63d0\u793a\u8bcd\u628a\u5b83\u4eec\u8bf1\u5bfc\u51fa\u6765\u3002</li> <li>Evol-Instruct (\u8fdb\u5316\u6307\u4ee4)\uff1a \u4fa7\u91cd\u4e8e\u6df1\u5ea6 (Depth)\u3002\u901a\u8fc7\u7279\u5b9a\u7684\u8fdb\u5316\u7b97\u5b50\uff08\u5982\u201c\u589e\u52a0\u7ea6\u675f\u201d\u3001\u201c\u6df1\u5316\u63a8\u7406\u201d\uff09\u5c06\u7b80\u5355\u6307\u4ee4\u6539\u5199\u4e3a\u590d\u6742\u6307\u4ee4\u3002\u8fd9\u4e00\u65b9\u6cd5\u76f4\u63a5\u89e3\u51b3\u4e86 Self-Instruct \u5bb9\u6613\u751f\u6210\u7b80\u5355\u3001\u77ed\u6307\u4ee4\u7684\u95ee\u9898\uff0c\u5f3a\u5236\u6a21\u578b\u5728\u903b\u8f91\u590d\u6742\u5ea6\u548c\u7ea6\u675f\u6ee1\u8db3\u80fd\u529b\u4e0a\u8fdb\u884c\u6500\u5347\u3002</li> </ul> <p> \u56fe 9-1\uff1a\u81ea\u6211\u6307\u4ee4\u548c\u8fdb\u5316\u6307\u4ee4\u5bf9\u6bd4</p> <p>\u8868 9-1\uff1a\u4e3b\u6d41\u6307\u4ee4\u6570\u636e\u6784\u5efa\u7b56\u7565\u5bf9\u6bd4</p> \u7279\u6027 \u4eba\u5de5\u6807\u6ce8 (Manual Annotation) Self-Instruct Evol-Instruct \u6838\u5fc3\u76ee\u6807 \u6781\u9ad8\u7cbe\u5ea6\u3001\u7279\u5b9a\u9886\u57df\u77e5\u8bc6 \u589e\u52a0\u4efb\u52a1\u7684\u591a\u6837\u6027 (Diversity) \u589e\u52a0\u4efb\u52a1\u7684\u590d\u6742\u5ea6 (Complexity) \u6210\u672c (Cost) \u6781\u9ad8 (\\(1-\\)10/\u6761) \u4f4e ($0_01/\u6761) \u4e2d ($0_03/\u6761\uff0c\u9700\u591a\u8f6e\u8c03\u7528) \u8f93\u5165\u6765\u6e90 \u9886\u57df\u4e13\u5bb6 \u79cd\u5b50\u4efb\u52a1\u6c60 (Seed Pool) \u73b0\u6709\u7b80\u5355\u6307\u4ee4 (Base Instruction) \u64cd\u4f5c\u903b\u8f91 \u4e13\u5bb6\u64b0\u5199\u4e0e\u5ba1\u6838 \u201c\u8bf7\u751f\u6210\u4e00\u4e2a\u4e0e\u73b0\u6709\u4efb\u52a1\u4e0d\u540c\u7684\u65b0\u4efb\u52a1\u201d \u201c\u8bf7\u5c06\u6b64\u4efb\u52a1\u6539\u5199\u5f97\u66f4\u96be\uff0c\u4f8b\u5982\u589e\u52a0\u9650\u5236\u6761\u4ef6\u201d \u5178\u578b\u7b97\u5b50/\u65b9\u6cd5 \u6e05\u6d17\u3001\u5ba1\u6838\u3001\u4f17\u5305 ROUGE \u53bb\u91cd\uff0c\u52a8\u540d\u8bcd\u8fc7\u6ee4 \u6df1\u5ea6\u8fdb\u5316 (Deepening), \u5e7f\u5ea6\u8fdb\u5316 (Breadth) \u9002\u7528\u573a\u666f \u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\u3001RLHF \u9ec4\u91d1\u6570\u636e\u96c6 \u6269\u5145\u901a\u7528\u4efb\u52a1\u8986\u76d6\u9762\uff0c\u51b7\u542f\u52a8 \u63d0\u5347\u4ee3\u7801\u3001\u6570\u5b66\u3001\u903b\u8f91\u63a8\u7406\u80fd\u529b \u6f5c\u5728\u98ce\u9669 \u89c4\u6a21\u96be\u4ee5\u6269\u5c55\uff0c\u7531\u4e8e\u75b2\u52b3\u5bfc\u81f4\u8d28\u91cf\u6ce2\u52a8 \u5bb9\u6613\u4ea7\u751f\u540c\u8d28\u5316\u3001\u7b80\u5355\u7684\u6307\u4ee4 \u53ef\u80fd\u751f\u6210\u903b\u8f91\u8fc7\u4e8e\u590d\u6742\u751a\u81f3\u65e0\u89e3\u7684\u201c\u5e7b\u89c9\u6307\u4ee4\u201d"},{"location":"chapter4/4_1/#9_14-cot","title":"9_1.4 \u601d\u7ef4\u94fe (CoT) \u6570\u636e\uff1a\u6253\u7834\u63a8\u7406\u9ed1\u76d2","text":"<p>CoT \u7684\u6838\u5fc3\u5728\u4e8e\u6253\u7834\u201c\u8f93\u5165-&gt;\u8f93\u51fa\u201d\u7684\u9ed1\u76d2\u6620\u5c04\uff0c\u5f3a\u5236\u6a21\u578b\u5c06\u9690\u5f0f\u63a8\u7406\u8fc7\u7a0b\u663e\u5f0f\u5316\u3002</p> <p>\u4ece\u8ba4\u77e5\u79d1\u5b66\u7684\u89d2\u5ea6\u770b\uff0c\u4eba\u7c7b\u5728\u89e3\u51b3\u590d\u6742\u95ee\u9898\uff08\u5982\u6570\u5b66\u9898\uff09\u65f6\uff0c\u5927\u8111\u4e2d\u4f1a\u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u4e2d\u95f4\u8ba1\u7b97\u3002Transformer \u6a21\u578b\u867d\u7136\u5f3a\u5927\uff0c\u4f46\u5982\u679c\u6ca1\u6709\u7ecf\u8fc7 CoT \u8bad\u7ec3\uff0c\u5b83\u503e\u5411\u4e8e\u76f4\u63a5\u731c\u6d4b\u7b54\u6848\uff0c\u8fd9\u5c31\u50cf\u8981\u6c42\u5b66\u751f\u4e0d\u5199\u8fc7\u7a0b\u76f4\u63a5\u5199\u5f97\u6570\u4e00\u6837\uff0c\u6781\u6613\u51fa\u9519\u3002CoT \u6570\u636e\u6fc0\u6d3b\u4e86 Transformer \u6a21\u578b\u7684\u4e2d\u95f4\u8ba1\u7b97\u5c42\uff0c\u4f7f\u5176\u80fd\u591f\u901a\u8fc7\u6269\u5c55\u751f\u6210\u7684 Token \u5e8f\u5217\u6765\u5206\u914d\u66f4\u591a\u7684\u8ba1\u7b97\u8d44\u6e90\u7ed9\u96be\u9898\uff08More compute time = More tokens generated\uff09\u3002</p>"},{"location":"chapter4/4_1/#9_15-data-formatting-standards","title":"9_1.5 \u6570\u636e\u683c\u5f0f\u6807\u51c6\u5316 (Data Formatting Standards)","text":"<p>\u5728\u8fdb\u5165\u5de5\u7a0b\u5b9e\u73b0\u524d\uff0c\u5fc5\u987b\u7406\u89e3\u6570\u636e\u662f\u5982\u4f55\u88ab\u201c\u5582\u201d\u7ed9\u6a21\u578b\u7684\u3002\u8fd9\u4e0d\u4ec5\u4ec5\u662f JSON \u89e3\u6790\u7684\u95ee\u9898\uff0c\u66f4\u5173\u4e4e\u6a21\u578b\u5982\u4f55\u7406\u89e3\u5bf9\u8bdd\u5386\u53f2\u3002\u76ee\u524d\u4e1a\u754c\u4e3b\u6d41\u91c7\u7528 ChatML (Chat Markup Language) \u683c\u5f0f\uff0c\u5b83\u660e\u786e\u533a\u5206\u4e86 System\u3001User \u548c Assistant \u7684\u8fb9\u754c\uff0c\u9632\u6b62\u6307\u4ee4\u6ce8\u5165\u653b\u51fb\u3002</p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u8bad\u7ec3\u65f6\uff0c\u6211\u4eec\u901a\u5e38\u53ea\u5bf9 <code>assistant</code> \u56de\u590d\u90e8\u5206\u7684 Token \u8ba1\u7b97 Loss\uff08\u635f\u5931\uff09\uff0c\u800c\u5c06 <code>system</code> \u548c <code>user</code> \u90e8\u5206\u8fdb\u884c Mask\uff08\u63a9\u7801\uff09\u5904\u7406\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5e0c\u671b\u6a21\u578b\u5b66\u4e60\u7684\u662f\u201c\u5982\u4f55\u56de\u7b54\u201d\uff0c\u800c\u4e0d\u662f\u201c\u5982\u4f55\u63d0\u95ee\u201d\u3002</p> <pre><code>// ChatML \u683c\u5f0f\u793a\u4f8b\n{\n  \"messages\": [\n    {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n    {\"role\": \"user\", \"content\": \"Explain quantum entanglement.\"},\n    {\"role\": \"assistant\", \"content\": \"Quantum entanglement is a phenomenon...\"}\n  ]\n}\n</code></pre>"},{"location":"chapter4/4_1/#9_2-engineering-implementation","title":"9_2. \u5de5\u7a0b\u5b9e\u73b0 (Engineering Implementation)","text":"<p>\u672c\u8282\u5c06\u6307\u5bfc\u5982\u4f55\u642d\u5efa\u4e00\u5957\u5b8c\u6574\u7684\u6570\u636e\u5408\u6210\u6d41\u6c34\u7ebf\uff0c\u8fd9\u6d89\u53ca\u5230\u5de5\u5177\u94fe\u7684\u9009\u62e9\u548c\u6d41\u6c34\u7ebf\u7684\u7a33\u5b9a\u6027\u8bbe\u8ba1\u3002</p>"},{"location":"chapter4/4_1/#_2","title":"\u73af\u5883/\u4f9d\u8d56","text":"<ul> <li><code>langchain</code> / <code>langsmith</code>: \u7528\u4e8e\u7ba1\u7406 Prompt \u6a21\u677f\u3001LLM \u8c03\u7528\u94fe\u4ee5\u53ca\u8ffd\u8e2a\u8c03\u8bd5\u3002</li> <li><code>rouge_score</code>: \u7528\u4e8e\u8ba1\u7b97\u6587\u672c\u76f8\u4f3c\u5ea6\uff0c\u8fdb\u884c\u53bb\u91cd\u3002</li> <li><code>numpy / scikit-learn</code>: \u7528\u4e8e\u5411\u91cf\u5316\u53bb\u91cd\uff08\u9ad8\u7ea7\u53bb\u91cd\uff09\uff0c\u901a\u8fc7 Embedding \u8ba1\u7b97\u8bed\u4e49\u8ddd\u79bb\u3002</li> <li><code>openai</code> \u6216 <code>vllm</code>: \u7528\u4e8e\u8c03\u7528\u6559\u5e08\u6a21\u578b\uff08Teacher Model\uff09\u3002vLLM \u9002\u7528\u4e8e\u672c\u5730\u90e8\u7f72\u9ad8\u541e\u5410\u91cf\u7684\u5f00\u6e90\u6559\u5e08\u6a21\u578b\uff08\u5982 Mixtral-8x7B\uff09\u3002</li> <li><code>chromadb</code> / <code>faiss</code>: \u5411\u91cf\u6570\u636e\u5e93\uff0c\u7528\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u7684\u53bb\u91cd\u548c\u68c0\u7d22\u3002</li> </ul>"},{"location":"chapter4/4_1/#9_21-prompt-engineering","title":"9_2.1 Prompt Engineering \u4e3a\u6570\u636e\u751f\u4ea7\u670d\u52a1","text":"<p>\u5728\u5408\u6210\u6570\u636e\u5de5\u7a0b\u4e2d\uff0cPrompt \u5fc5\u987b\u5177\u5907\u6781\u9ad8\u7684\u9c81\u68d2\u6027\u3002\u6211\u4eec\u91c7\u7528\u8fed\u4ee3\u601d\u7ef4\u6765\u6253\u78e8 System Prompt\uff0c\u5c31\u50cf\u5f00\u53d1\u8f6f\u4ef6\u7248\u672c\u4e00\u6837\u3002</p>"},{"location":"chapter4/4_1/#_3","title":"\u4efb\u52a1\u76ee\u6807\uff1a \u6784\u9020\u4e00\u6279\u7528\u4e8e\u8bad\u7ec3\u201c\u91d1\u878d\u5206\u6790\u52a9\u624b\u201d\u7684\u6307\u4ee4\u6570\u636e\u3002","text":"<p>Step 1: \u8fed\u4ee3\u7f16\u5199 System Prompt * V1 \u7248\u672c\uff1a\u8fc7\u4e8e\u7b80\u5355\uff0c\u5bfc\u81f4\u6570\u636e\u540c\u8d28\u5316     * \u7f3a\u9677\u5206\u6790\uff1a \u6a21\u578b\u751f\u6210\u7684\u6307\u4ee4\u5f80\u5f80\u975e\u5e38\u7b80\u77ed\uff0c\u4e14\u96c6\u4e2d\u5728\u57fa\u672c\u6982\u5ff5\u89e3\u91ca\u4e0a\uff08\u5982\u201c\u4ec0\u4e48\u662f\u80a1\u7968\uff1f\u201d\uff09\u3002\u8fd9\u53cd\u6620\u4e86 LLM \u9ed8\u8ba4\u503e\u5411\u4e8e\u751f\u6210\u201c\u9ad8\u6982\u7387\u3001\u4f4e\u590d\u6742\u5ea6\u201d\u7684\u6587\u672c\u3002     <pre><code># V1 Prompt - \u6548\u679c\u4e0d\u4f73\nsystem_prompt_v1 = \"\"\"\nYou are a financial expert. Please generate 5 questions and answers about finance.\n\"\"\"\n</code></pre></p> <ul> <li> <p>V2 \u7248\u672c\uff1a\u589e\u52a0\u7ed3\u6784\u5316\u8981\u6c42</p> <ul> <li>\u6539\u8fdb\uff1a \u5f15\u5165\u4e86 JSON \u683c\u5f0f\u8981\u6c42\uff0c\u4fbf\u4e8e\u540e\u7eed\u89e3\u6790\u3002\u589e\u52a0\u4e86\u201c\u89d2\u8272\u201d\u8bbe\u5b9a\uff0c\u8bd5\u56fe\u5f15\u5bfc\u98ce\u683c\u3002</li> <li>\u7f3a\u9677\u5206\u6790\uff1a \u867d\u7136\u683c\u5f0f\u5bf9\u4e86\uff0c\u4f46\u5185\u5bb9\u4f9d\u7136\u4e0d\u591f\u786c\u6838\uff0c\u7f3a\u4e4f\u63a8\u7406\u8fc7\u7a0b\u3002\u6a21\u578b\u53ef\u80fd\u53ea\u4f1a\u751f\u6210\u6559\u79d1\u4e66\u5f0f\u7684\u5b9a\u4e49\uff0c\u800c\u975e\u5b9e\u6218\u573a\u666f\u3002 <pre><code># V2 Prompt - \u7ed3\u6784\u5316\u6539\u8fdb\nsystem_prompt_v2 = \"\"\"\nYou are a Senior Financial Analyst with 20 years of experience.\nGenerate 5 pairs of instruction-response data focused on corporate finance.\nFormat the output as a JSON list.\nEach item should have: 'instruction', 'input' (optional), 'output'.\n\"\"\"\n</code></pre></li> </ul> </li> <li> <p>V3 \u7248\u672c\uff1a\u6700\u7ec8\u751f\u4ea7\u7248 (Production Ready)</p> <ul> <li>\u6539\u8fdb\uff1a \u5f15\u5165\u4e86 Few-Shot (\u5c11\u6837\u672c)\u3001Negative Constraints (\u8d1f\u5411\u7ea6\u675f) \u548c Complexity Requirements (\u590d\u6742\u5ea6\u8981\u6c42)\u3002\u8fd9\u662f\u5de5\u4e1a\u754c\u4f7f\u7528\u7684\u6807\u51c6\u8303\u5f0f\u3002</li> <li>\u6df1\u5ea6\u89e3\u6790\uff1a\u901a\u8fc7\u660e\u786e\u7684\u201cAnti-Patterns\u201d\uff0c\u6211\u4eec\u5207\u65ad\u4e86\u6a21\u578b\u751f\u6210\u201c\u5e9f\u8bdd\u201d\u7684\u8def\u5f84\u3002Exemplar\uff08\u6837\u4f8b\uff09\u4e0d\u4ec5\u4ec5\u662f\u683c\u5f0f\u53c2\u8003\uff0c\u66f4\u662f\u601d\u7ef4\u6df1\u5ea6\u7684\u951a\u70b9\u3002</li> </ul> <p><pre><code># V3 Prompt - \u9ad8\u9c81\u68d2\u6027\u751f\u4ea7\u7248\nsystem_prompt_v3 = \"\"\"\n### ROLE\nYou are a Chief Market Strategist at a top-tier investment bank. Your goal is to train a junior analyst model. You demand precision, depth, and actionable insights.\n\n### OBJECTIVE\nGenerate 5 high-quality, complex instruction-following examples related to market analysis, risk management, or quantitative trading.\n\n### CONSTRAINTS\n1. **Complexity**: Do NOT ask simple definitional questions (e.g., \"What is a bond?\"). Instead, ask for scenario analysis, portfolio adjustments, or impact assessments.\n2. **Format**: Strictly output a valid JSON list.\n3. **Reasoning**: The 'output' must demonstrate step-by-step analytical reasoning before giving the conclusion.\n4. **Anti-Patterns**:\n   - Avoid generic advice like \"Consult a financial advisor.\"\n   - Avoid short, one-sentence responses.\n   - Avoid vague statements; use numbers and specific financial instruments where possible.\n\n### OUTPUT FORMAT\n[\n  {\n    \"instruction\": \"...\",\n    \"input_context\": \"...\" (can be null),\n    \"output\": \"...\"\n  }\n]\n\n### EXEMPLAR (One-Shot)\n[\n  {\n    \"instruction\": \"Given a portfolio heavily weighted in tech stocks (60%), analyze the impact of a sudden 50bps rate hike by the Fed.\",\n    \"input_context\": null,\n    \"output\": \"First, we identify the correlation... Tech stocks are long-duration assets... Discounted Cash Flow (DCF) models would show... Therefore, the portfolio would likely suffer significant drawdown. I recommend hedging via...\"\n  }\n]\n\"\"\"\n</code></pre> \u5b9e\u6218\u6280\u5de7 (Pro Tip): \u5728 V3 \u7248\u672c\u4e2d\uff0c\u6211\u4eec\u660e\u786e\u4e86\u201cAnti-Patterns\u201d\u3002\u8fd9\u662f\u9632\u6b62\u6a21\u578b\u201c\u5077\u61d2\u201d\u7684\u5173\u952e\u3002\u5927\u6a21\u578b\u503e\u5411\u4e8e\u751f\u6210\u5b89\u5168\u3001\u4e2d\u5eb8\u7684\u56de\u7b54\uff08\u5982\u201c\u8bf7\u54a8\u8be2\u4e13\u4e1a\u4eba\u58eb\u201d\uff09\uff0c\u8fd9\u5728\u8bad\u7ec3\u6570\u636e\u4e2d\u662f\u4f4e\u4ef7\u503c\u7684\u566a\u97f3\uff0c\u5fc5\u987b\u663e\u5f0f\u7981\u6b62\u3002</p> </li> </ul>"},{"location":"chapter4/4_1/#9_22-self-instruct-evol-instruct","title":"9_2.2 \u81ea\u52a8\u5316\u6784\u9020\u65b9\u6cd5\uff1aSelf-Instruct \u4e0e Evol-Instruct","text":"<p>\u6211\u4eec\u5c06\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e Evol-Instruct \u7684\u7b80\u5316\u7248\u6d41\u6c34\u7ebf\u3002\u6838\u5fc3\u5728\u4e8e\u5982\u4f55\u901a\u8fc7 Prompt \u5c06\u7b80\u5355\u6307\u4ee4\u201c\u8fdb\u5316\u201d\u4e3a\u590d\u6742\u6307\u4ee4\uff0c\u5e76\u5728\u6b64\u8fc7\u7a0b\u4e2d\u5f15\u5165\u9a8c\u8bc1\u673a\u5236\u3002</p>"},{"location":"chapter4/4_1/#evol-instruct","title":"\u6838\u5fc3\u4ee3\u7801\u62c6\u89e3\uff1aEvol-Instruct \u6d41\u6c34\u7ebf","text":"<p>Step 1: \u5b9a\u4e49\u8fdb\u5316\u7b97\u5b50 (Evolution Prompts) Evol-Instruct \u7684\u7cbe\u9ad3\u5728\u4e8e\u8fd9\u5957 Prompt \u6a21\u677f\u3002\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u4e0d\u540c\u7684\u8fdb\u5316\u65b9\u5411\uff1a\u6df1\u5ea6\uff08\u589e\u52a0\u7ea6\u675f\u3001\u52a0\u6df1\u63a8\u7406\uff09\u548c\u5e7f\u5ea6\uff08\u53d8\u5f02\uff09\u3002\u4ee5\u4e0b\u4ee3\u7801\u5c55\u793a\u4e86\u5982\u4f55\u6784\u5efa\u201c\u589e\u52a0\u7ea6\u675f\u201d\u548c\u201c\u6df1\u5316\u63a8\u7406\u201d\u7684 Prompt\u3002\u8fd9\u4e9b Prompt \u7684\u8bbe\u8ba1\u76f4\u63a5\u51b3\u5b9a\u4e86\u6570\u636e\u7684\u4e0a\u9650\u3002</p> <pre><code>class EvolutionPrompts:\n    @staticmethod\n    def get_deepening_prompt(instruction):\n        \"\"\"\n        \u6df1\u5ea6\u8fdb\u5316\uff1a\u589e\u52a0\u903b\u8f91\u63a8\u7406\u7684\u6df1\u5ea6\u3002\n        \u901a\u8fc7\u8981\u6c42 'explicitly ask for multiple-step reasoning'\uff0c\u5f3a\u8feb\u6a21\u578b\u4ece\u76f4\u89c9\u5f0f\u56de\u7b54\u8f6c\u4e3a\u5206\u6790\u5f0f\u56de\u7b54\u3002\n        \"\"\"\n        return f\"\"\"\n        I want you to act as a Prompt Rewriter.\n        Your objective is to rewrite a given prompt into a more complex version to make those famous AI systems (e.g., ChatGPT and GPT4) a bit harder to handle.\n        But the rewritten prompt must be reasonable and must be understood and responded by humans.\n\n        # Given Prompt #:\n        {instruction}\n\n        # Method #:\n        If #Given Prompt# can be solved with just a few simple thinking processes, you can rewrite it to explicitly ask for multiple-step reasoning.\n\n        # Rewritten Prompt #:\n        \"\"\"\n\n    @staticmethod\n    def get_constraints_prompt(instruction):\n        \"\"\"\n        \u6df1\u5ea6\u8fdb\u5316\uff1a\u589e\u52a0\u5177\u4f53\u7684\u9650\u5236\u6761\u4ef6\u3002\n        \u901a\u8fc7\u9650\u5236\u5b57\u6570\u589e\u52a0\uff0810-20 words\uff09\uff0c\u9632\u6b62\u6307\u4ee4\u53d8\u5f97\u5197\u957f\u800c\u65e0\u5b9e\u8d28\u5185\u5bb9\u3002\n        \"\"\"\n        return f\"\"\"\n        I want you to act as a Prompt Rewriter.\n        ... [\u7701\u7565\u5934\u90e8\u58f0\u660e\uff0c\u4fdd\u6301\u4e00\u81f4]...\n\n        # Given Prompt #:\n        {instruction}\n\n        # Method #:\n        Please add one more constraint/requirement into #Given Prompt#.\n        You should try your best not to make the #Rewritten Prompt# become verbose, #Rewritten Prompt# can only add 10 to 20 words into #Given Prompt#.\n\n        # Rewritten Prompt #:\n        \"\"\"\n\n    @staticmethod\n    def get_breadth_prompt(instruction):\n        \"\"\"\n        \u5e7f\u5ea6\u8fdb\u5316\uff1a\u57fa\u4e8e\u73b0\u6709\u6307\u4ee4\u751f\u6210\u5168\u65b0\u7684\u3001\u8bdd\u9898\u4e0d\u540c\u7684\u6307\u4ee4\u3002\n        \u8fd9\u662f\u4e3a\u4e86\u9632\u6b62\u6570\u636e\u5206\u5e03\u574d\u584c\u5230\u67d0\u51e0\u4e2a\u7279\u5b9a\u7684\u7a84\u9886\u57df\u3002\n        \"\"\"\n        return f\"\"\"\n        I want you to act as a Prompt Creator.\n        Please generate a brand new prompt that has the same difficulty level as #Given Prompt# but covers a completely different topic or domain.\n\n        # Given Prompt #:\n        {instruction}\n\n        # New Prompt #:\n        \"\"\"\n</code></pre> <p>Step 2: \u6267\u884c\u8fdb\u5316\u5faa\u73af\u4e0e\u5f02\u5e38\u5904\u7406</p> <pre><code>import random\n\n# \u5047\u8bbe\u6211\u4eec\u6709\u4e00\u4e2a LLM \u8c03\u7528\u63a5\u53e3\ndef call_llm(prompt):\n    # \u8c03\u7528 GPT-4 \u6216\u5176\u4ed6\u5f3a\u6a21\u578b\n    # \u5b9e\u9645\u5de5\u7a0b\u4e2d\u9700\u6dfb\u52a0 retry \u673a\u5236\u5904\u7406\u7f51\u7edc\u6296\u52a8\n    pass\n\ndef evolve_instruction(base_instruction, depth=1):\n    current_instruction = base_instruction\n\n    for i in range(depth):\n        # \u968f\u673a\u9009\u62e9\u4e00\u79cd\u8fdb\u5316\u7b56\u7565\n        # \u7b56\u7565\u7684\u6982\u7387\u5206\u5e03\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u8c03\u6574\uff0c\u4f8b\u5982\u521d\u671f\u591a\u7528 Breadth\uff0c\u540e\u671f\u591a\u7528 Deepening\n        strategy = random.choice(['deepening', 'constraints', 'breadth'])\n\n        if strategy == 'deepening':\n            prompt = EvolutionPrompts.get_deepening_prompt(current_instruction)\n        elif strategy == 'constraints':\n            prompt = EvolutionPrompts.get_constraints_prompt(current_instruction)\n        else:\n            prompt = EvolutionPrompts.get_breadth_prompt(current_instruction)\n\n        # \u83b7\u53d6\u8fdb\u5316\u540e\u7684\u6307\u4ee4\n        evolved_candidate = call_llm(prompt)\n\n        # \u8d28\u91cf\u68c0\u67e5\uff08\u7b80\u5355\u7248\uff09\uff1a\u9632\u6b62\u8fdb\u5316\u5931\u8d25\n        # \u5f88\u591a\u65f6\u5019\u6a21\u578b\u4f1a\u8f93\u51fa \"Sorry, I can't do that\" \u6216\u8005\u5355\u7eaf\u91cd\u590d\u539f\u6307\u4ee4\n        if \"sorry\" in evolved_candidate.lower() or len(evolved_candidate) &lt; 10:\n            print(f\"Evolution failed at step {i}, keeping previous instruction.\")\n            break\n\n        # \u8fdb\u9636\u68c0\u67e5\uff1a\u5229\u7528\u7b80\u5355\u542f\u53d1\u5f0f\u89c4\u5219\u5224\u65ad\u662f\u5426\u53ea\u662f\u7b80\u5355\u7684\u91cd\u590d\n        if evolved_candidate.strip() == current_instruction.strip():\n             print(f\"Evolution stagnant at step {i}.\")\n             break\n\n        current_instruction = evolved_candidate\n\n    return current_instruction\n\n# \u793a\u4f8b\u8fd0\u884c\nseed = \"Write a Python script to calculate Fibonacci numbers.\"\ncomplex_instruction = evolve_instruction(seed, depth=3)\n# \u9884\u671f\u7ed3\u679c\u53ef\u80fd\u662f\uff1a\"Write a Python script to calculate the nth Fibonacci number using dynamic programming, optimize for memory usage, and handle negative input values.\"\n</code></pre> <p>Step 3: \u6027\u80fd\u4f18\u5316\u6280\u5de7 * Batch Processing: \u4e0d\u8981\u4e00\u6761\u6761\u8c03\u7528 API\u3002\u6784\u9020\u4e00\u4e2a\u5305\u542b 20 \u6761\u6307\u4ee4\u7684 Prompt \u5217\u8868\uff0c\u8ba9\u6a21\u578b\u4e00\u6b21\u6027\u8fd4\u56de 20 \u6761\u8fdb\u5316\u540e\u7684\u7ed3\u679c\u3002\u8fd9\u80fd\u663e\u8457\u964d\u4f4e token \u5f00\u9500\u548c\u7f51\u7edc\u5ef6\u8fdf\uff08High Throughput\uff09\u3002 * Failure Filter: \u8fdb\u5316\u8fc7\u7a0b\u5f88\u5bb9\u6613\u5931\u8d25\uff08\u4f8b\u5982\u6a21\u578b\u5f00\u59cb\u590d\u8bfb\uff09\u3002\u5fc5\u987b\u5b9e\u73b0\u4e00\u4e2a\u8fc7\u6ee4\u5668\uff0c\u5982\u679c\u8fdb\u5316\u540e\u7684\u6307\u4ee4\u957f\u5ea6\u7f29\u77ed\u4e86\uff0c\u6216\u8005\u5305\u542b\u4e86\u5178\u578b\u7684\u62d2\u7edd\u8bcd\uff08\"As an AI...\"\uff09\uff0c\u5219\u4e22\u5f03\u8be5\u6837\u672c\u3002 * \u591a\u6837\u6027\u63a7\u5236: \u5728 Batch \u751f\u6210\u65f6\uff0c\u53ef\u4ee5\u5728 System Prompt \u4e2d\u660e\u786e\u8981\u6c42\u201cGenerate diverse topics\u201d\uff0c\u907f\u514d\u540c\u4e00\u6279\u6b21\u751f\u6210\u5168\u662f\u5173\u4e8e\u201cPython \u7f16\u7a0b\u201d\u7684\u6307\u4ee4\u3002</p>"},{"location":"chapter4/4_1/#9_23-cot-step-by-step","title":"9_2.3 \u601d\u7ef4\u94fe (CoT) \u6570\u636e\uff1a\u6784\u9020 Step-by-Step \u7684\u63a8\u7406\u6837\u672c","text":"<p>SFT \u6570\u636e\u7684\u6838\u5fc3\u4ef7\u503c\u5728\u4e8e\u6559\u4f1a\u6a21\u578b\u201c\u5982\u4f55\u601d\u8003\u201d\u3002\u666e\u901a\u7684\u95ee\u7b54\u5bf9\uff08Q: 1+1? A: 2\uff09\u53ea\u80fd\u6559\u4f1a\u7ed3\u679c\uff0cCoT \u5219\u6559\u4f1a\u8fc7\u7a0b\u3002</p>"},{"location":"chapter4/4_1/#cot-prompt","title":"\u6784\u9020 CoT \u6570\u636e\u7684 Prompt \u6a21\u677f","text":"<p>\u6211\u4eec\u4e0d\u53ea\u662f\u7b80\u5355\u5730\u52a0\u4e00\u53e5\u201cLet's think step by step\u201d\uff0c\u800c\u662f\u8981\u6c42\u6a21\u578b\u6309\u7167\u7279\u5b9a\u683c\u5f0f\uff08\u5982 <code>&lt;thinking&gt;</code> \u6807\u7b7e\uff09\u8f93\u51fa\u3002\u8fd9\u79cd\u683c\u5f0f\u5316\u7684\u6570\u636e\u5728\u540e\u7eed\u8bad\u7ec3\u4e2d\u975e\u5e38\u6709\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u8ba9\u6a21\u578b\u8f93\u51fa\u601d\u8003\u8fc7\u7a0b\uff0c\u6216\u8005\u5728\u63a8\u7406\u65f6\u9690\u85cf\u5b83\u3002</p> <pre><code># System Prompt for CoT Generation\ncot_system_prompt = \"\"\"\nYou are a reasoning expert. When answering the user's question, you MUST follow this format:\n\n1. Enclose your thought process in &lt;thinking&gt; tags.\n2. Break down the problem into logical steps.\n3. Check for edge cases or potential errors in your logic (Self-Correction).\n4. Output the final answer in &lt;answer&gt; tags.\n\nDo NOT output the answer directly without the thinking process.\n\"\"\"\n\n# V3 Prompt Iteration for Math CoT\nuser_prompt_cot = \"\"\"\nQuestion: A farmer has chickens and cows. There are 20 heads and 50 legs. How many of each are there?\n\nPlease provide a Step-by-Step solution.\n\"\"\"\n</code></pre> <p>\u793a\u4f8b\u8f93\u51fa\uff08\u4f5c\u4e3a\u8bad\u7ec3\u6570\u636e\uff09\uff1a <pre><code>&lt;thinking&gt;\nStep 1: Define variables. Let C be chickens, K be cows.\nStep 2: Set up equations based on the problem statement.\n   Equation 1 (Heads): C + K = 20\n   Equation 2 (Legs): 2C + 4K = 50\nStep 3: Solve for C from Equation 1. \n   C = 20 - K.\nStep 4: Substitute C into Equation 2.\n   2(20 - K) + 4K = 50\n   40 - 2K + 4K = 50\n   2K = 10 \n   K = 5.\nStep 5: Solve for C using the value of K. \n   C = 20 - 5 = 15.\nStep 6: Verify the solution. \n   Heads: 15 + 5 = 20. Correct.\n   Legs: 15*2 + 5*4 = 30 + 20 = 50. Correct.\n&lt;/thinking&gt;\n&lt;answer&gt;\nChickens: 15, Cows: 5\n&lt;/answer&gt;\n</code></pre> \u5b9e\u6218\u6280\u5de7 (Pro Tip): \u8fd9\u79cd\u5e26\u6709 <code>&lt;thinking&gt;</code> \u6807\u7b7e\u7684\u6570\u636e\u7b56\u7565\u88ab\u79f0\u4e3a\u201c\u5185\u90e8\u72ec\u767d\u201d (Internal Monologue) \u8bad\u7ec3\u3002\u5728 SFT \u8bad\u7ec3\u65f6\uff0c\u4fdd\u7559\u8fd9\u4e9b\u6807\u7b7e\u8ba9\u6a21\u578b\u5b66\u4f1a\u8f93\u51fa\u601d\u8003\u8fc7\u7a0b\u3002\u5728\u5b9e\u9645\u4ea7\u54c1\u5e94\u7528\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 Parsing \u4ee3\u7801\u622a\u83b7 <code>&lt;thinking&gt;</code> \u5185\u5bb9\uff0c\u53ea\u5411\u7528\u6237\u5c55\u793a <code>&lt;answer&gt;</code>\uff0c\u6216\u8005\u505a\u4e00\u4e2a\u201c\u601d\u8003\u4e2d...\u201d\u7684 UI \u52a8\u6548\uff0c\u5c55\u793a\u90e8\u5206\u601d\u8003\u6b65\u9aa4\u4ee5\u589e\u52a0\u53ef\u89e3\u91ca\u6027\u3002</p>"},{"location":"chapter4/4_1/#9_24-performance-evaluation","title":"9_2.4. \u6027\u80fd\u4e0e\u8bc4\u4f30 (Performance &amp; Evaluation)","text":"<p>\u6570\u636e\u751f\u6210\u53ea\u662f\u7b2c\u4e00\u6b65\uff0c\u5982\u4f55\u8bc4\u4f30\u751f\u6210\u6570\u636e\u7684\u8d28\u91cf\u540c\u6837\u5173\u952e\u3002\u6211\u4eec\u4e0d\u80fd\u7b49\u5230\u6a21\u578b\u8bad\u7ec3\u5b8c\uff08\u53ef\u80fd\u82b1\u8d39\u6570\u5929\u548c\u6570\u5343\u7f8e\u5143\uff09\u624d\u53d1\u73b0\u6570\u636e\u8d28\u91cf\u5dee\u3002</p>"},{"location":"chapter4/4_1/#_4","title":"\u8bc4\u4ef7\u6307\u6807","text":"<ul> <li>\u6307\u4ee4\u9075\u5faa\u7387 (Instruction Following Rate): \u8fd9\u901a\u5e38\u662f\u4e00\u4e2a\u81ea\u52a8\u5316\u6d4b\u8bd5\u3002\u4f7f\u7528 GPT-4 \u4f5c\u4e3a\u88c1\u5224\uff08Judge\uff09\uff0c\u5224\u65ad\u6a21\u578b\u751f\u6210\u7684\u56de\u590d\u662f\u5426\u4e25\u683c\u6ee1\u8db3\u4e86 Input \u4e2d\u7684\u6240\u6709\u7ea6\u675f\u6761\u4ef6\uff08\u5982\u201c\u5b57\u6570\u9650\u5236\u201d\u3001\u201c\u5305\u542b\u7279\u5b9a\u5173\u952e\u8bcd\u201d\u3001\u201cJSON\u683c\u5f0f\u201d\uff09\u3002</li> <li>\u590d\u6742\u5ea6\u5206\u5e03 (Complexity Distribution): \u5229\u7528 NLP \u5de5\u5177\uff08\u5982 SpaCy\uff09\u5206\u6790\u751f\u6210\u6307\u4ee4\u7684\u52a8\u8bcd\u591a\u6837\u6027\u3001\u53e5\u6cd5\u6811\u6df1\u5ea6\u548c\u5e73\u5747\u957f\u5ea6\u3002\u7ed8\u5236\u5206\u5e03\u76f4\u65b9\u56fe\uff0c\u786e\u4fdd Evol-Instruct \u771f\u6b63\u63d0\u5347\u4e86\u96be\u5ea6\uff0c\u800c\u4e0d\u662f\u4ec5\u4ec5\u589e\u52a0\u4e86\u5e9f\u8bdd\u3002</li> <li>\u591a\u6837\u6027 (Diversity): \u8ba1\u7b97 ROUGE-L \u6216\u4f7f\u7528 Embedding Cosine Similarity\u3002\u5982\u679c\u6570\u636e\u96c6\u5185\u6837\u672c\u95f4\u7684\u5e73\u5747\u76f8\u4f3c\u5ea6\u8fc7\u9ad8\uff0c\u8bf4\u660e\u53d1\u751f\u4e86\u201c\u6a21\u5f0f\u574d\u584c\u201d\uff0c\u6570\u636e\u7f3a\u4e4f\u591a\u6837\u6027\u3002</li> </ul>"},{"location":"chapter4/4_1/#benchmarks","title":"\u57fa\u51c6\u6d4b\u8bd5 (Benchmarks)","text":"<p>\u5728\u5b66\u672f\u754c\u548c\u5de5\u4e1a\u754c\uff0c\u6709\u51e0\u4e2a\u516c\u8ba4\u7684\u699c\u5355\u7528\u4e8e\u6d4b\u8bd5 SFT \u540e\u7684\u6a21\u578b\u80fd\u529b\uff1a * WizardLM \u8bba\u6587\u6570\u636e : \u7ecf\u8fc7 4 \u8f6e Evol-Instruct \u8fdb\u5316\u7684\u6570\u636e\u8bad\u7ec3\u51fa\u7684\u6a21\u578b\uff0c\u5728 GSM8K (\u6570\u5b66) \u548c HumanEval (\u4ee3\u7801) \u4e0a\uff0c\u76f8\u6bd4\u4ec5\u4f7f\u7528\u539f\u59cb\u6570\u636e\u7684\u6a21\u578b\uff0c\u6027\u80fd\u63d0\u5347\u901a\u5e38\u5728 10% - 20% \u4ee5\u4e0a\u3002 * MT-Bench: \u4e00\u4e2a\u591a\u8f6e\u5bf9\u8bdd\u7684\u8bc4\u4f30\u96c6\uff0c\u4e13\u95e8\u6d4b\u8bd5\u6a21\u578b\u7684\u6307\u4ee4\u9075\u5faa\u3001\u63a8\u7406\u548c\u591a\u8f6e\u5bf9\u8bdd\u80fd\u529b\uff0c\u901a\u5e38\u7531 GPT-4 \u6253\u5206\u3002 * \u6210\u672c\u53c2\u8003\uff1a \u4f7f\u7528 <code>gpt-3_5-turbo</code> \u751f\u6210 52K \u6761 Self-Instruct \u6570\u636e\u7684\u6210\u672c\u7ea6\u4e3a $500 - $1000\uff08\u53d6\u51b3\u4e8e Prompt \u957f\u5ea6\u548c\u8f6e\u6b21\uff09\u3002\u8fd9\u76f8\u6bd4\u4eba\u5de5\u6807\u6ce8\u6570\u5341\u4e07\u7f8e\u5143\u7684\u6210\u672c\u662f\u6781\u5177\u6027\u4ef7\u6bd4\u7684\u3002</p>"},{"location":"chapter4/4_1/#9_25-pitfalls-troubleshooting","title":"9_2.5. \u907f\u5751\u6307\u5357 (Pitfalls &amp; Troubleshooting)","text":"<p>\u5728\u5b9e\u9645\u64cd\u4f5c\u4e2d\uff0c\u6570\u636e\u5408\u6210\u5f80\u5f80\u5145\u6ee1\u9677\u9631\u3002\u4ee5\u4e0b\u662f\u5e38\u89c1\u7684\u5931\u8d25\u6a21\u5f0f\u53ca\u5176\u89e3\u51b3\u65b9\u6848\u3002</p> <ul> <li> <p>\u9677\u9631 1\uff1aMode Collapse (\u6a21\u5f0f\u574d\u584c)</p> <ul> <li>\u73b0\u8c61\uff1a \u6a21\u578b\u751f\u6210\u7684\u6307\u4ee4\u5343\u7bc7\u4e00\u5f8b\uff0c\u4f8b\u5982\u751f\u6210\u7684 1000 \u6761\u6570\u636e\u5168\u662f\u201c\u8bf7\u5199\u4e00\u7bc7\u5173\u4e8eX\u7684\u6587\u7ae0\u201d\u6216\u8005\u201c\u8bf7\u5e2e\u6211\u5199\u4e00\u4e2aPython\u51fd\u6570\u201d\u3002</li> <li>\u539f\u56e0\uff1a Seed Tasks\uff08\u79cd\u5b50\u4efb\u52a1\uff09\u8fc7\u4e8e\u5355\u4e00\uff0c\u6216\u8005 System Prompt \u7684 Temperature \u8bbe\u7f6e\u8fc7\u4f4e\uff0c\u5bfc\u81f4\u6a21\u578b\u9677\u5165\u5c40\u90e8\u6700\u4f18\u3002</li> <li>\u4fee\u6b63\uff1a \u589e\u52a0 Seed Tasks \u7684\u591a\u6837\u6027\uff08\u8986\u76d6 100+ \u4e2a\u4e0d\u540c\u9886\u57df\uff0c\u5982\u70f9\u996a\u3001\u6cd5\u5f8b\u3001\u7f16\u7a0b\u3001\u6587\u5b66\uff09\uff1b\u63d0\u9ad8 Temperature (0_7 -&gt; 1_0)\uff1b\u5728 System Prompt \u4e2d\u5f3a\u5236\u8981\u6c42\u201cGenerate a task from a domain different from previous examples\u201d\u3002</li> </ul> </li> <li> <p>\u9677\u9631 2\uff1aHallucinated Constraints (\u5e7b\u89c9\u7ea6\u675f)</p> <ul> <li>\u73b0\u8c61\uff1a \u6a21\u578b\u5728\u8bad\u7ec3\u6570\u636e\u4e2d\u5b66\u4f1a\u4e86\u201c\u5fc5\u987b\u4ee5 JSON \u8f93\u51fa\u201d\uff0c\u5bfc\u81f4\u5728\u7528\u6237\u95f2\u804a\u65f6\uff08\u201c\u4f60\u597d\u201d\uff09\u4e5f\u5f3a\u884c\u8f93\u51fa JSON\uff0c\u6216\u8005\u5728\u6ca1\u6709\u8981\u6c42\u7684\u60c5\u51b5\u4e0b\u8f93\u51fa <code>&lt;thinking&gt;</code> \u6807\u7b7e\u3002</li> <li>\u539f\u56e0\uff1a \u8bad\u7ec3\u6570\u636e\u5206\u5e03\u4e25\u91cd\u504f\u79d1\uff0c100% \u90fd\u662f\u590d\u6742\u6307\u4ee4\uff0c\u7f3a\u4e4f\u7b80\u5355\u7684\u901a\u7528\u5bf9\u8bdd\u6570\u636e\u3002</li> <li>\u4fee\u6b63\uff1a \u6570\u636e\u914d\u6bd4 (Data Mixing)\u3002\u5728 Evol-Instruct \u6570\u636e\u4e2d\u6df7\u5165 10%-20% \u7684\u901a\u7528\u5bf9\u8bdd\u6570\u636e\uff08\u5982 ShareGPT \u6216\u4e00\u822c\u7684 Chit-Chat \u6570\u636e\uff09\uff0c\u9632\u6b62\u6a21\u578b\u8fc7\u62df\u5408\u7279\u5b9a\u683c\u5f0f\u3002\u8fd9\u88ab\u79f0\u4e3a\u201c\u901a\u7528\u80fd\u529b\u56de\u653e\u201d\uff08General Capability Replay\uff09\u3002</li> </ul> </li> <li> <p>\u9677\u9631 3\uff1aEvolution Failure (\u8fdb\u5316\u5931\u8d25/\u9000\u5316)</p> <ul> <li>\u73b0\u8c61\uff1a \u8fdb\u5316\u540e\u7684\u6307\u4ee4\u53d8\u5f97\u4e0d\u53ef\u7406\u55bb\u3001\u903b\u8f91\u51b2\u7a81\uff08\u201c\u5199\u4e00\u7bc7\u4e0d\u5305\u542b\u5143\u97f3\u5b57\u6bcd\u7684 1000 \u5b57\u6587\u7ae0\u201d\uff09\u6216\u6781\u5176\u5197\u957f\u3002</li> <li>\u4fee\u6b63\uff1a \u5b9e\u73b0\u4e00\u4e2a\u201c\u957f\u5ea6\u60e9\u7f5a\u201d\u6216\u201c\u590d\u6742\u5ea6\u622a\u65ad\u201d\u673a\u5236\u3002\u5982\u679c\u8fdb\u5316\u540e\u7684\u6307\u4ee4\u867d\u7136\u590d\u6742\u4f46 GPT-4 \u90fd\u65e0\u6cd5\u56de\u7b54\uff08\u6216\u8005\u56de\u7b54\u8d28\u91cf\u5f88\u5dee\uff09\uff0c\u5219\u8be5\u6837\u672c\u4e3a\u65e0\u6548\u6837\u672c\uff08Bad Case\uff09\u3002\u5f15\u5165\u201c\u6559\u5e08\u6a21\u578b\u6253\u5206\u201d\u673a\u5236\uff0c\u8ba9 GPT-4 \u8bc4\u4f30\u8fdb\u5316\u540e\u6307\u4ee4\u7684\u53ef\u884c\u6027 (Feasibility)\u3002</li> </ul> </li> <li> <p>\u9677\u9631 4\uff1a\u707e\u96be\u6027\u9057\u5fd8 (Catastrophic Forgetting)</p> <ul> <li>\u73b0\u8c61\uff1a SFT \u4e4b\u540e\uff0c\u6a21\u578b\u867d\u7136\u5b66\u4f1a\u4e86\u9075\u5faa\u6307\u4ee4\uff0c\u4f46\u4f3c\u4e4e\u53d8\u201c\u7b28\u201d\u4e86\uff0c\u5fd8\u8bb0\u4e86\u9884\u8bad\u7ec3\u9636\u6bb5\u7684\u4e00\u4e9b\u4e16\u754c\u77e5\u8bc6\u3002</li> <li>\u539f\u56e0\uff1a SFT \u6570\u636e\u96c6\u4fee\u6539\u4e86\u6a21\u578b\u7684\u6743\u91cd\u5206\u5e03\uff0c\u4f7f\u5176\u8fc7\u5ea6\u4e13\u6ce8\u4e8e\u7279\u5b9a\u4efb\u52a1\u5f62\u5f0f\uff0c\u6324\u538b\u4e86\u901a\u7528\u77e5\u8bc6\u7684\u5b58\u50a8\u7a7a\u95f4\u3002</li> <li>\u4fee\u6b63\uff1a \u964d\u4f4e Learning Rate\uff0c\u51cf\u5c11 Epoch \u6570\uff08\u901a\u5e38 SFT \u53ea\u9700\u8981 2-3 \u4e2a Epoch\uff09\u3002\u540c\u65f6\uff0c\u5728 SFT \u6570\u636e\u4e2d\u52a0\u5165\u5c11\u91cf\u7684\u9884\u8bad\u7ec3\u6570\u636e\uff08Pre-training Replay\uff09\uff0c\u4ee5\u4fdd\u6301\u53c2\u6570\u5206\u5e03\u7684\u7a33\u5b9a\u6027\u3002</li> </ul> </li> </ul>"},{"location":"chapter4/4_1/#9_26","title":"9_2.6. \u672c\u7ae0\u5c0f\u7ed3\u4e0e\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u6211\u4eec\u5c06 Prompt \u89c6\u4e3a\u6570\u636e\u7684\u6e90\u4ee3\u7801\uff0c\u5fc5\u987b\u50cf\u5bf9\u5f85\u8f6f\u4ef6\u5de5\u7a0b\u4ee3\u7801\u4e00\u6837\u5bf9\u5176\u8fdb\u884c\u4e25\u8c28\u7684\u7248\u672c\u7ba1\u7406\u4e0e\u8fed\u4ee3\u6d4b\u8bd5\u3002\u5728\u8fd9\u4e00\u4f53\u7cfb\u4e0b\uff0cSelf-Instruct \u89e3\u51b3\u4e86\u201c\u4ece\u65e0\u5230\u6709\u201d\u7684\u51b7\u542f\u52a8\u96be\u9898\uff0c\u800c Evol-Instruct \u5219\u653b\u514b\u4e86\u201c\u4ece\u6613\u5230\u96be\u201d\u7684\u590d\u6742\u5ea6\u6500\u5347\uff0c\u4e24\u8005\u7684\u6709\u673a\u7ed3\u5408\u6784\u6210\u4e86\u6784\u5efa\u9ad8\u6027\u80fd\u6570\u636e\u96c6\u7684\u9ec4\u91d1\u8303\u5f0f\uff1b\u4e0e\u6b64\u540c\u65f6\uff0c\u601d\u7ef4\u94fe\uff08CoT\uff09\u6570\u636e\u4e5f\u8fdc\u975e\u7b80\u5355\u7684\u89e3\u9898\u6280\u5de7\uff0c\u5b83\u901a\u8fc7\u663e\u5f0f\u5316\u63a8\u7406\u8fc7\u7a0b\uff0c\u5c06\u8ba1\u7b97\u8d44\u6e90\u6709\u6548\u5730\u5206\u914d\u7ed9\u5173\u952e\u63a8\u7406\u6b65\u9aa4\uff0c\u4ece\u800c\u6839\u672c\u6027\u5730\u63d0\u5347\u4e86\u6a21\u578b\u5904\u7406\u590d\u6742\u903b\u8f91\u7684\u80fd\u529b\u3002\u7136\u800c\u5f52\u6839\u7ed3\u5e95\uff0c\u6570\u636e\u5408\u6210\u7684\u6838\u5fc3\u58c1\u5792\u5e76\u975e\u751f\u6210\u80fd\u529b\u7684\u5f3a\u5f31\uff0c\u800c\u662f\u4e00\u95e8\u5173\u4e8e\u8fc7\u6ee4\u4e0e\u6e05\u6d17\u7684\u827a\u672f\u2014\u2014\u5728\u6d77\u91cf\u751f\u6210\u7684\u5bb9\u6613\u4e0e\u7cbe\u51c6\u7b5b\u9009\u7684\u8270\u96be\u4e4b\u95f4\uff0c\u552f\u6709\u5177\u5907\u4ece\u6c99\u783e\u4e2d\u6dd8\u51fa\u9ec4\u91d1\u7684\u80fd\u529b\uff0c\u624d\u662f\u771f\u6b63\u7684\u6838\u5fc3\u7ade\u4e89\u529b\u3002</p>"},{"location":"chapter4/4_1/#_5","title":"\u53c2\u8003\u6587\u732e\u4e0e\u5ef6\u4f38\u9605\u8bfb","text":"<ul> <li>Wang, Y., et al. (2022). Self-Instruct: Aligning Language Models with Self-Generated Instructions. (\u63d0\u51fa\u4e86\u81ea\u52a8\u5316\u6307\u4ee4\u751f\u6210\u7684\u5f00\u5c71\u4e4b\u4f5c)</li> <li>Xu, C., et al. (2023). WizardLM: Empowering Large Language Models to Follow Complex Instructions. (\u8be6\u7ec6\u4ecb\u7ecd\u4e86 Evol-Instruct \u7684\u5404\u79cd\u8fdb\u5316\u7b97\u5b50)</li> <li>Wei, J., et al. (2022). Chain-of-Thought Prompting Elicits Reasoning in Large Language Models. (CoT \u7684\u5960\u57fa\u4e4b\u4f5c)</li> <li>Zhou, C., et al. (2023). LIMA: Less Is More for Alignment. (\u8bba\u8bc1\u4e86 SFT \u4e3b\u8981\u662f\u5b66\u4e60\u683c\u5f0f\u800c\u975e\u77e5\u8bc6\uff0c\u5960\u5b9a\u4e86\u201c\u8d28\u91cf&gt;\u6570\u91cf\u201d\u7684\u7406\u8bba\u57fa\u7840)</li> </ul>"},{"location":"chapter4/4_2/","title":"\u7b2c10\u7ae0\uff1a\u5408\u6210\u6570\u636e (Synthetic Data) \u2014\u2014 \u4ece\u201c\u6570\u636e\u6316\u6398\u201d\u5230\u201c\u6570\u636e\u519c\u573a\u201d","text":""},{"location":"chapter4/4_2/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u968f\u7740\u5927\u6a21\u578b\u7ade\u8d5b\u7684\u767d\u70ed\u5316\uff0c\u516c\u7f51\u4e0a\u7684\u9ad8\u8d28\u91cf\u81ea\u7136\u6570\u636e\uff08Natural Data\uff09\u6b63\u5728\u9762\u4e34\u67af\u7aed\u7684\u5371\u673a\u3002\u6211\u4eec\u51e0\u4e4e\u5df2\u7ecf\u201c\u8bfb\u201d\u5b8c\u4e86\u6574\u4e2a\u4e92\u8054\u7f51\uff0c\u4f46\u6a21\u578b\u7684\u667a\u529b\u4e0a\u9650\u8fdc\u672a\u89e6\u8fbe\u3002\u6b64\u65f6\uff0c\u5408\u6210\u6570\u636e\uff08Synthetic Data\uff09\u4e0d\u518d\u662f\u4e00\u4e2a\u53ef\u9009\u9879\uff0c\u800c\u662f\u6a21\u578b\u80fd\u529b\u8dc3\u5347\u7684\u65b0\u5f15\u64ce\u3002\u672c\u7ae0\u5c06\u6df1\u5165\u5256\u6790\u5fae\u8f6f Phi \u7cfb\u5217\u6a21\u578b\u7684\u201c\u6559\u79d1\u4e66\u7ea7\u201d\u6570\u636e\u5408\u6210\u65b9\u6cd5\uff0c\u63a2\u8ba8\u5982\u4f55\u4ece\u88ab\u52a8\u7684\u201c\u6570\u636e\u91c7\u96c6\u8005\u201d\u8f6c\u53d8\u4e3a\u4e3b\u52a8\u7684\u201c\u6570\u636e\u521b\u9020\u8005\u201d\u3002</p> <p>\u6211\u4eec\u5c06\u4e0d\u4ec5\u9650\u4e8e\u751f\u6210\u6587\u672c\uff0c\u800c\u662f\u901a\u8fc7 Program of Thought (PoT) \u5229\u7528\u4ee3\u7801\u6267\u884c\u6765\u6784\u5efa\u4e25\u5bc6\u7684\u903b\u8f91\u9a8c\u8bc1\u95ed\u73af\uff0c\u4ee5\u53ca\u5982\u4f55\u5229\u7528 GPT-4o \u7b49\u591a\u6a21\u6001\u6a21\u578b\u5408\u6210\u590d\u6742\u7684\u56fe\u6587\u6307\u4ee4\u6570\u636e\u3002\u6211\u4eec\u5c06\u5c55\u793a\u5982\u4f55\u4ece\u7b80\u5355\u7684\u201c\u6a21\u4eff\u4eba\u7c7b\u201d\u8f6c\u5411\u201c\u8d85\u8d8a\u4eba\u7c7b\u201d\uff0c\u901a\u8fc7\u7b97\u6cd5\u624b\u6bb5\u6784\u5efa\u51fa\u6bd4\u771f\u5b9e\u4e16\u754c\u66f4\u7eaf\u51c0\u3001\u66f4\u5177\u6559\u80b2\u610f\u4e49\u7684\u8bad\u7ec3\u96c6\u3002</p>"},{"location":"chapter4/4_2/#learning-objectives","title":"\u5b66\u4e60\u76ee\u6807 (Learning Objectives)","text":"<ul> <li>\u6784\u5efa \u201cTextbook Quality\u201d \u5206\u7c7b\u5668\uff0c\u4ece\u6d77\u91cf Web \u6570\u636e\u4e2d\u7b5b\u9009\u9ad8\u4ef7\u503c\u6837\u672c\u3002</li> <li>\u5b9e\u73b0 PoT (Program of Thought) \u6570\u636e\u751f\u6210\u6d41\u6c34\u7ebf\uff0c\u5229\u7528 Python \u89e3\u91ca\u5668\u9a8c\u8bc1\u6570\u5b66/\u4ee3\u7801\u6570\u636e\u7684\u6b63\u786e\u6027\u3002</li> <li>\u638c\u63e1\u57fa\u4e8e LLaVA/GPT-4o \u7684\u591a\u6a21\u6001\u6307\u4ee4\u5408\u6210\u6280\u672f\uff0c\u6784\u9020\u56fe\u50cf\u63a8\u7406\u95ee\u7b54\u5bf9\u3002</li> </ul>"},{"location":"chapter4/4_2/#_2","title":"\u573a\u666f\u5f15\u5165\uff1a\u5f53\u6570\u636e\u6210\u4e3a\u74f6\u9888","text":"<p>\u201c\u4f60\u6b63\u5728\u8bad\u7ec3\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e Python \u7f16\u7a0b\u7684\u5c0f\u578b\u6a21\u578b\uff081_3B\uff09\u3002\u4e3a\u4e86\u8ba9\u5b83\u5c3d\u53ef\u80fd\u5f3a\u5927\uff0c\u4f60\u7f16\u5199\u722c\u866b\u722c\u53d6\u4e86 GitHub \u4e0a\u6240\u6709\u7684\u5f00\u6e90\u4ee3\u7801\u3002\u7136\u800c\uff0c\u5f53\u8bad\u7ec3\u7ed3\u675f\u8fdb\u884c\u6d4b\u8bd5\u65f6\uff0c\u4f60\u7edd\u671b\u5730\u53d1\u73b0\u6a21\u578b\u5b66\u4f1a\u4e86\u5199\u6ee1\u662f Bug \u7684\u4ee3\u7801\uff0c\u751a\u81f3\u5b66\u4f1a\u4e86\u5728\u51fd\u6570\u91cc\u5199\u2018TODO: Fix this later\u2019\u6216\u8005\u2018This code is trash, do not use\u2019\u3002 \u4ec5\u4ec5\u589e\u52a0\u6570\u636e\u91cf\u5df2\u7ecf\u65e0\u6548\u4e86\uff0c\u56e0\u4e3a\u4f60\u5582\u7ed9\u6a21\u578b\u7684\u5783\u573e\u8d8a\u591a\uff0c\u5b83\u7684\u8f93\u51fa\u5c31\u8d8a\u6df7\u4e71\u3002\u8fd9\u65f6\u5019\uff0c\u5fae\u8f6f\u7684 Phi-1 \u8bba\u6587\u7ed9\u4e86\u4f60\u4e00\u8bb0\u5f53\u5934\u68d2\u559d\uff1a\u2018Textbooks Are All You Need\u2019\u3002\u4f60\u9700\u8981\u7684\u662f\u50cf\u6559\u79d1\u4e66\u4e00\u6837\u903b\u8f91\u6e05\u6670\u3001\u6ce8\u91ca\u5b8c\u7f8e\u3001\u7531\u6d45\u5165\u6df1\u7684\u6559\u5b66\u4ee3\u7801\uff0c\u800c\u4e0d\u662f\u53ea\u6709\u4e0a\u5e1d\u548c\u539f\u4f5c\u8005\u80fd\u770b\u61c2\u7684\u2018\u5c4e\u5c71\u2019\u3002\u4f46\u662f\uff0c\u53bb\u54ea\u91cc\u627e\u51e0\u767e\u4ebf Token \u7684\u5b8c\u7f8e\u6559\u79d1\u4e66\u5462\uff1f\u65e2\u7136\u627e\u4e0d\u5230\uff0c\u6211\u4eec\u5c31\u5fc5\u987b\u5b66\u4f1a\u51ed\u7a7a\u2018\u53d8\u2019\u51fa\u8fd9\u4e9b\u6570\u636e\u3002\u5982\u4f55\u6784\u5efa\u4e00\u4e2a\u4e0d\u77e5\u75b2\u5026\u7684\u2018\u865a\u62df\u6559\u6388\u2019\u6765\u6279\u91cf\u751f\u4ea7\u8fd9\u4e9b\u5b8c\u7f8e\u7684\u6559\u6750\uff1f\u8fd9\u5c31\u662f\u672c\u7ae0\u8981\u89e3\u51b3\u7684\u6838\u5fc3\u5de5\u7a0b\u6311\u6218\u3002\u201d</p>"},{"location":"chapter4/4_2/#10_1-concepts-principles","title":"10_1 \u6838\u5fc3\u6982\u5ff5\u4e0e\u539f\u7406 (Concepts &amp; Principles)","text":"<p>\u5408\u6210\u6570\u636e\u7684\u6838\u5fc3\u6311\u6218\u5728\u4e8e\u8d28\u91cf\u63a7\u5236\u4e0e\u9a8c\u8bc1\u95ed\u73af\u3002\u56e0\u4e3a\u6a21\u578b\u751f\u6210\u7684\u6587\u672c\u5982\u679c\u4e0d\u52a0\u68c0\u67e5\uff0c\u5f80\u5f80\u5305\u542b\u5e7b\u89c9\u6216\u9519\u8bef\u3002\u5982\u679c\u4f7f\u7528\u542b\u6709\u9519\u8bef\u7684\u6570\u636e\u8bad\u7ec3\u6a21\u578b\uff0c\u4f1a\u5bfc\u81f4\u6a21\u578b\u4ea7\u751f\u201c\u81ea\u6211\u541e\u566c\u201d\uff08Model Autophagy\uff09\u6216\u201c\u6a21\u578b\u574d\u584c\u201d\uff08Model Collapse\uff09\uff0c\u5373\u6a21\u578b\u8f93\u51fa\u7684\u65b9\u5dee\u9010\u6e10\u6d88\u5931\uff0c\u5185\u5bb9\u53d8\u5f97\u6781\u5ea6\u540c\u8d28\u5316\u4e14\u8131\u79bb\u73b0\u5b9e\u3002\u672c\u7ae0\u4ecb\u7ecd\u7684\u4e09\u79cd\u65b9\u6cd5\u5206\u522b\u89e3\u51b3\u4e86\u6587\u672c\u3001\u4ee3\u7801/\u6570\u5b66\u3001\u591a\u6a21\u6001\u6570\u636e\u7684\u8d28\u91cf\u95ee\u9898\u3002</p>"},{"location":"chapter4/4_2/#10_11","title":"10_1.1 \u4e3a\u4ec0\u4e48\u5408\u6210\u6570\u636e\u7684\u8d28\u91cf\u8fdc\u6bd4\u6570\u91cf\u91cd\u8981\uff1f","text":"<p>\u5728\u6df1\u5ea6\u5b66\u4e60\u7684\u65e9\u671f\uff0c\u6211\u4eec\u8ff7\u4fe1\u201c\u6570\u636e\u91cf\u5373\u6b63\u4e49\u201d\uff0c\u8ba4\u4e3a\u53ea\u8981\u6570\u636e\u8db3\u591f\u591a\uff0c\u6a21\u578b\u5c31\u80fd\u5b66\u4f1a\u4e00\u5207\u3002\u4f46\u5728\u5408\u6210\u6570\u636e\u65f6\u4ee3\uff0c\u8fd9\u4e00\u4fe1\u6761\u88ab\u5f7b\u5e95\u63a8\u7ffb\u3002</p> <p>\u4fe1\u566a\u6bd4\u7406\u8bba (Signal-to-Noise Ratio): \u6a21\u578b\u7684\u8bad\u7ec3\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u538b\u7f29\u4fe1\u606f\u7684\u8fc7\u7a0b\u3002\u9ad8\u8d28\u91cf\u6570\u636e\uff08\u5982\u6559\u79d1\u4e66\uff09\u5177\u6709\u6781\u9ad8\u7684\u4fe1\u606f\u5bc6\u5ea6\u548c\u4e25\u5bc6\u7684\u903b\u8f91\u94fe\u6761\uff0c\u6a21\u578b\u53ea\u9700\u8981\u5f88\u5c11\u7684\u6837\u672c\u5c31\u80fd\u6355\u6349\u5230\u5176\u80cc\u540e\u7684\u89c4\u5f8b\u3002\u800c\u4f4e\u8d28\u91cf\u6570\u636e\uff08\u5982\u8bba\u575b\u704c\u6c34\u3001\u95f2\u804a\uff09\u5145\u6ee1\u4e86\u566a\u97f3\u548c\u903b\u8f91\u65ad\u5c42\u3002\u5982\u679c\u8bad\u7ec3\u96c6\u4e2d\u6df7\u5165\u4e86\u5927\u91cf\u4f4e\u8d28\u91cf\u5408\u6210\u6570\u636e\uff0c\u6a21\u578b\u4e3a\u4e86\u964d\u4f4e Loss\uff0c\u4f1a\u88ab\u8feb\u53bb\u62df\u5408\u8fd9\u4e9b\u566a\u97f3\uff0c\u5bfc\u81f4\u201c\u903b\u8f91\u7535\u8def\u201d\u77ed\u8def\u3002</p> <p>\u8fd9\u5c31\u597d\u6bd4\u5b66\u4e60\u7269\u7406\uff0c\u8bfb\u4e00\u672c\u7ecf\u5178\u7684\u300a\u8d39\u66fc\u7269\u7406\u5b66\u8bb2\u4e49\u300b\uff08\u9ad8\u8d28\u91cf\u5408\u6210\u6570\u636e\uff09\u80dc\u8fc7\u5237\u4e00\u4e07\u6761\u788e\u7247\u5316\u7684\u7269\u7406\u79d1\u666e\u77ed\u89c6\u9891\uff08\u4f4e\u8d28\u91cf\u6570\u636e\uff09\u3002Phi-1 \u7684\u6210\u529f\u8bc1\u660e\u4e86\uff1a6B Token \u7684\u6559\u79d1\u4e66\u7ea7\u6570\u636e\uff0c\u5176\u8bad\u7ec3\u6548\u679c\u53ef\u4ee5\u540a\u6253 1000B Token \u7684\u7f51\u7edc\u722c\u53d6\u6570\u636e\u3002\u5728\u5408\u6210\u6570\u636e\u9886\u57df\uff0c\u9a8c\u8bc1\uff08Verification\uff09\u7684\u6210\u672c\u6210\u4e3a\u4e86\u65b0\u7684\u8d27\u5e01\u3002</p>"},{"location":"chapter4/4_2/#10_12-textbooks-are-all-you-need","title":"10_1.2 \u6559\u79d1\u4e66\u7ea7\u6570\u636e (Textbooks Are All You Need)","text":"<p>\u5fae\u8f6f Phi-1 \u7684\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u4e0e\u5176\u7528 1TB \u5783\u573e\u6570\u636e\u8bad\u7ec3\uff0c\u4e0d\u5982\u7528 6B Token \u7684\u9ad8\u8d28\u91cf\u6570\u636e\u3002\u5176\u6838\u5fc3\u5728\u4e8e\u6784\u5efa\u4e00\u4e2a\u201c\u8fc7\u6ee4\u5668\u201d\u548c\u4e00\u4e2a\u201c\u653e\u5927\u5668\u201d\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u5e76\u4e0d\u662f\u5b8c\u5168\u629b\u5f03 Web \u6570\u636e\uff0c\u800c\u662f\u8bad\u7ec3\u4e00\u4e2a\u5206\u7c7b\u5668\uff08Quality Classifier\uff09\uff0c\u4e13\u95e8\u8bc6\u522b\u90a3\u4e9b\u201c\u5177\u6709\u6559\u80b2\u4ef7\u503c\u201d\u7684\u5185\u5bb9\u3002\u8fd9\u4e0d\u4ec5\u4ec5\u662f\u770b\u8bed\u6cd5\u662f\u5426\u6b63\u786e\uff0c\u66f4\u662f\u770b\u5185\u5bb9\u662f\u5426\u903b\u8f91\u81ea\u6d3d\u3001\u662f\u5426\u5305\u542b\u5b9a\u4e49\u4e0e\u63a8\u7406\u3002\u5176\u6b21\uff0c\u6211\u4eec\u5229\u7528\u5f3a\u5927\u7684\u751f\u6210\u5f0f\u6a21\u578b\uff08\u5982 GPT-4\uff09\u4f5c\u4e3a\u201c\u6269\u97f3\u5668\u201d\uff0c\u53c2\u8003\u8fd9\u4e9b\u9ad8\u8d28\u91cf\u7247\u6bb5\uff0c\u5408\u6210\u51fa\u98ce\u683c\u7c7b\u4f3c\u4f46\u5185\u5bb9\u5168\u65b0\u7684\u3001\u81ea\u5305\u542b\u7684\u77e5\u8bc6\u7247\u6bb5\u3002</p> <p> \u56fe 10-1\uff1a Phi-1\u6d41\u7a0b\u793a\u610f\u56fe</p>"},{"location":"chapter4/4_2/#10_13-pot-program-of-thought","title":"10_1.3 \u4ee3\u7801\u4e0e\u6570\u5b66\u5408\u6210\uff1aPoT (Program of Thought)","text":"<p>LLM \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u6982\u7387\u6a21\u578b\uff0c\u5b83\u4e0d\u5177\u5907\u771f\u6b63\u7684\u903b\u8f91\u63a8\u7406\u82af\u7247\u3002\u56e0\u6b64\uff0c\u8ba9 LLM \u505a\u7b97\u672f\u8fd0\u7b97\uff08\u5982 234 * 567\uff09\u6216\u590d\u6742\u903b\u8f91\u63a8\u6f14\u65f6\uff0c\u5b83\u5f88\u5bb9\u6613\u4ea7\u751f\u5e7b\u89c9\u3002PoT (Program of Thought) \u7684\u601d\u60f3\u662f\uff1a\u65e2\u7136 LLM \u4e0d\u64c5\u957f\u8ba1\u7b97\u4f46\u64c5\u957f\u7ffb\u8bd1\uff0c\u4e0d\u5982\u8ba9\u5b83\u628a\u6570\u5b66\u95ee\u9898\u201c\u7ffb\u8bd1\u201d\u6210\u4ee3\u7801\uff0c\u7136\u540e\u8ba9 Python \u89e3\u91ca\u5668\u6765\u8ba1\u7b97\u7ed3\u679c\u3002</p> <p>\u8fd9\u662f\u5408\u6210\u6570\u636e\u4e2d\u552f\u4e00\u80fd\u505a\u5230 100% \u51c6\u786e\u7387\u9a8c\u8bc1 \u7684\u9886\u57df\u3002\u6211\u4eec\u5c06\u751f\u6210\u7684\u4ee3\u7801\u653e\u5165 Python Sandbox \u6267\u884c\u3002\u5982\u679c\u62a5\u9519\uff0c\u76f4\u63a5\u4e22\u5f03\uff1b\u5982\u679c\u8fd0\u884c\u6210\u529f\uff0c\u6267\u884c\u7ed3\u679c\u5373\u4e3a Ground Truth\u3002\u8fd9\u79cd\u201c\u6267\u884c\u5373\u9a8c\u8bc1\u201d\u7684\u673a\u5236\uff0c\u5f7b\u5e95\u89e3\u51b3\u4e86\u5408\u6210\u6570\u636e\u65e0\u6cd5\u9a8c\u8bc1\u6b63\u786e\u6027\u7684\u96be\u9898\uff0c\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u4f4e\u6210\u672c\u5730\u751f\u6210\u65e0\u7a77\u65e0\u5c3d\u7684\u6570\u5b66\u548c\u903b\u8f91\u63a8\u7406\u6570\u636e\u3002</p> <p>\u8868 10-1\uff1a\u5408\u6210\u6570\u636e\u9a8c\u8bc1\u7b56\u7565\u5bf9\u6bd4</p> \u6570\u636e\u7c7b\u578b \u751f\u6210\u5668 (Generator) \u6838\u5fc3\u6311\u6218 \u9a8c\u8bc1\u8005 (Verifier) \u9a8c\u8bc1\u673a\u5236 \u901a\u7528\u6587\u672c GPT-4 / Gemini \u5e7b\u89c9 (Hallucination) LLM (Judge) / Reward Model \u4f9d\u8d56\u5f3a\u6a21\u578b\u6253\u5206\uff0c\u4e00\u81f4\u6027\u8f83\u4f4e\uff0c\u4e14\u5bb9\u6613\u51fa\u73b0\u201c\u88c1\u5224\u504f\u89c1\u201d \u6570\u5b66/\u903b\u8f91 GPT-4 + PoT Prompt \u8ba1\u7b97\u9519\u8bef Python Interpreter \u6267\u884c\u4e00\u81f4\u6027\uff1a\u4ee3\u7801\u8fd0\u884c\u7ed3\u679c\u4e0e\u9884\u8bbe\u7b54\u6848\u5339\u914d\uff0c\u903b\u8f91\u7edd\u5bf9\u6b63\u786e \u4ee3\u7801 (Code) DeepSeek Coder / GPT-4 \u8bed\u6cd5\u9519\u8bef\u3001\u903b\u8f91 Bug Unit Tests / Compiler \u5355\u5143\u6d4b\u8bd5\uff1a\u901a\u8fc7 assert \u65ad\u8a00\u6216\u6210\u529f\u7f16\u8bd1\uff0c\u786e\u4fdd\u529f\u80fd\u6b63\u5e38 \u591a\u6a21\u6001 GPT-4o / LLaVA \u89c6\u89c9\u5e7b\u89c9 (\u65e0\u4e2d\u751f\u6709) CLIP Score / Grounding DINO \u68c0\u67e5\u751f\u6210\u7684\u63cf\u8ff0\u662f\u5426\u4e0e\u56fe\u7247 Embedding \u76f8\u4f3c\uff0c\u9632\u6b62\u7f16\u9020\u4e0d\u5b58\u5728\u7684\u7269\u4f53"},{"location":"chapter4/4_2/#10_14","title":"10_1.4 \u591a\u6a21\u6001\u6307\u4ee4\u5408\u6210\uff1a\u8de8\u8d8a\u611f\u77e5\u7684\u6865\u6881","text":"<p>\u5bf9\u4e8e\u56fe\u50cf\u6570\u636e\uff0c\u4f20\u7edf\u7684\u6807\u6ce8\u6210\u672c\u6781\u9ad8\u4e14\u63cf\u8ff0\u7b80\u77ed\u3002LLaVA \u63d0\u51fa\u4e86\u4e00\u79cd\u5929\u624d\u822c\u7684\u201c\u76f2\u4eba\u6478\u8c61\u201d\u7b56\u7565\u3002\u6211\u4eec\u5229\u7528\u73b0\u6709\u7684\u68c0\u6d4b\u6a21\u578b\u5c06\u56fe\u50cf\u8f6c\u5316\u4e3a\u7b26\u53f7\u5316\u7684\u6587\u672c\u63cf\u8ff0\uff08Caption + Bounding Boxes\uff09\uff0c\u7136\u540e\u5c06\u8fd9\u4e9b\u7eaf\u6587\u672c\u5582\u7ed9\u5f3a\u5927\u7684\u7eaf\u6587\u672c\u6a21\u578b\uff08\u5982 GPT-4\uff09\u3002GPT-4 \u867d\u7136\u770b\u4e0d\u89c1\u56fe\uff0c\u4f46\u5b83\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e9b\u5143\u6570\u636e\u201c\u60f3\u8c61\u201d\u51fa\u56fe\u50cf\u7684\u5185\u5bb9\uff0c\u5e76\u57fa\u4e8e\u6b64\u751f\u6210\u590d\u6742\u7684\u63a8\u7406\u5bf9\u8bdd\u3002\u8fd9\u4e0d\u4ec5\u89e3\u51b3\u4e86\u591a\u6a21\u6001\u6570\u636e\u7a00\u7f3a\u7684\u95ee\u9898\uff0c\u8fd8\u6781\u5927\u5730\u63d0\u5347\u4e86\u6307\u4ee4\u7684\u590d\u6742\u5ea6\u548c\u903b\u8f91\u6027\u3002</p>"},{"location":"chapter4/4_2/#10_2-engineering-implementation","title":"10_2 \u5de5\u7a0b\u5b9e\u73b0 (Engineering Implementation)","text":"<p>\u672c\u8282\u6211\u4eec\u5c06\u6df1\u5165\u4ee3\u7801\u5c42\u9762\uff0c\u6784\u5efa\u4e00\u5957\u5b8c\u6574\u7684\u6570\u636e\u5408\u6210\u6d41\u6c34\u7ebf\u3002\u6211\u4eec\u5c06\u91cd\u70b9\u5173\u6ce8\u5982\u4f55\u4fdd\u8bc1\u6570\u636e\u7684\u591a\u6837\u6027\uff0c\u9632\u6b62\u751f\u6210\u7684\u201c\u6559\u79d1\u4e66\u201d\u5343\u7bc7\u4e00\u5f8b\u3002</p>"},{"location":"chapter4/4_2/#10_21","title":"10_2.1 \u6559\u79d1\u4e66\u7ea7\u6570\u636e\uff1a\u5206\u7c7b\u5668\u4e0e\u5408\u6210\u6d41\u6c34\u7ebf","text":"<p>Step 1: \u8bad\u7ec3\u8d28\u91cf\u5206\u7c7b\u5668 (The Quality Classifier) \u6211\u4eec\u9700\u8981\u8bad\u7ec3\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u6a21\u578b\uff08\u5982 Random Forest \u6216 BERT-Tiny\uff09\uff0c\u4ece\u6d77\u91cf\u6570\u636e\u4e2d\u6311\u51fa\u201c\u6559\u79d1\u4e66\u201d\u3002\u8fd9\u91cc\u7684\u5173\u952e\u5728\u4e8e\u6807\u6ce8\u6570\u636e\u7684\u6765\u6e90\u3002\u901a\u5e38\uff0c\u6211\u4eec\u9700\u8981\u4eba\u5de5\u4e13\u5bb6\u6216 GPT-4 \u4ed4\u7ec6\u6807\u6ce8\u51e0\u5343\u6761\u6570\u636e\u4f5c\u4e3a\u79cd\u5b50\u3002</p> <p>\u4ee3\u7801\u5b9e\u73b0\uff1a\u7279\u5f81\u5de5\u7a0b\u4e0e\u8bad\u7ec3 <pre><code>import pandas as pd\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.feature_extraction.text import TfidfVectorizer\nfrom sklearn.pipeline import Pipeline\n\n# 1. \u51c6\u5907\u6807\u6ce8\u6570\u636e (Annotation)\n# \u6211\u4eec\u9996\u5148\u7528 GPT-4 \u6807\u6ce8\u5c11\u91cf\u6837\u672c\uff08\u4f8b\u5982 1000 \u6761\uff09\uff0c\u4f5c\u4e3a\u201c\u91d1\u6807\u51c6\u201d\n# Prompt: \"Determine if this text is of educational value for a student...\"\n# Label 1: High Quality (Textbook-like), Label 0: Low Quality (Noise)\n# \u8fd9\u4e00\u6b65\u81f3\u5173\u91cd\u8981\uff0c\u6807\u6ce8\u7684\u8d28\u91cf\u76f4\u63a5\u51b3\u5b9a\u4e86\u5206\u7c7b\u5668\u7684\u4e0a\u9650\ndata = [\n    {\"text\": \"Python lists are mutable sequences...\", \"label\": 1},\n    {\"text\": \"Hey guys check out my cat photo...\", \"label\": 0},\n    # ... more data\n] \ndf = pd.DataFrame(data)\n\n# 2. \u6784\u5efa\u5206\u7c7b\u5668\u6d41\u6c34\u7ebf\n# Phi-1 \u8bba\u6587\u4e2d\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u7684 Embedding\uff0c\u8fd9\u91cc\u7b80\u5316\u4f7f\u7528 TF-IDF \u6f14\u793a\u539f\u7406\n# \u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u5efa\u8bae\u4f7f\u7528 DeBERTa-v3-small \u7b49\u8f7b\u91cf\u7ea7 Transformer \u83b7\u53d6 Embedding\npipeline = Pipeline([\n    ('tfidf', TfidfVectorizer(max_features=5000, stop_words='english')),\n    ('clf', RandomForestClassifier(n_estimators=100, n_jobs=-1))\n])\n\n# 3. \u8bad\u7ec3\nX = df['text']\ny = df['label']\npipeline.fit(X, y)\n\n# 4. \u9884\u6d4b (Filtering Phase)\n# \u5bf9\u6d77\u91cf Web \u6570\u636e\u8fdb\u884c\u6253\u5206\uff0c\u53ea\u4fdd\u7559\u9ad8\u5206\u6570\u636e\nweb_snippet = \"Standard library documentation for Python...\"\nscore = pipeline.predict_proba([web_snippet])[0][1]\n\nif score &gt; 0_8:\n    print(\"Keep this data for training: High Educational Value\")\nelse:\n    print(\"Discard: Low Signal-to-Noise Ratio\")\n</code></pre></p> <p>Step 2: \u5408\u6210\u6559\u79d1\u4e66\u7247\u6bb5 (Synthetic Generation) \u62e5\u6709\u4e86\u5206\u7c7b\u5668\u8fc7\u6ee4\u51fa\u7684\u79cd\u5b50\u6570\u636e\u540e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u201c\u6269\u5199\u201d\u3002\u8fd9\u91cc\u7684 Prompt \u8bbe\u8ba1\u9700\u8981\u6781\u9ad8\u7684\u6280\u5de7\u3002</p> <p>Prompt \u8fed\u4ee3\uff1a\u5408\u6210 Python \u6559\u7a0b * V1 Prompt: \"Write a tutorial about Python lists.\"     * \u7ed3\u679c\uff1a \u5e73\u94fa\u76f4\u53d9\uff0c\u7f3a\u4e4f\u6df1\u5ea6\uff0c\u50cf\u662f\u4e00\u7bc7\u5e73\u5eb8\u7684\u535a\u5ba2\u6587\u7ae0\u3002 * V3 Prompt (Phi-style): \u5f15\u5165\u4e86\u5177\u4f53\u7684\u6559\u5b66\u6cd5\uff08Pedagogy\uff09\uff0c\u8981\u6c42\u5305\u542b\u5b9a\u4e49\u3001\u5bf9\u6bd4\u3001\u590d\u6742\u5ea6\u5206\u6790\u548c\u9677\u9631\u8b66\u793a\u3002</p> <pre><code># V3 Prompt - \u6559\u79d1\u4e66\u98ce\u683c\u5408\u6210\nsynthetic_textbook_prompt = \"\"\"\n### ROLE\nYou are a professor of Computer Science writing a definitive textbook on Python.\n\n### OBJECTIVE\nWrite a comprehensive, self-contained chapter section on the topic: \"List Comprehensions vs. Map/Filter\".\n\n### REQUIREMENTS\n1. **Tone**: Educational, clear, precise, and rigorous. Avoid conversational filler.\n2. **Structure**:\n   - Start with a conceptual definition explaining *why* this feature exists.\n   - Provide a \"Before and After\" code example (Loop vs. Comprehension).\n   - Explain the *computational complexity* (Big O) implications.\n   - Include a \"Common Pitfall\" section (e.g., readability vs. brevity).\n3. **Diversity**: Use realistic variable names (e.g., `inventory_items`, `sensor_readings`), NOT generic ones like `x`, `y`, `foo`. \n   (This is crucial to prevent the model from overfitting to toy examples).\n\n### OUTPUT\n[Markdown Content]\n\"\"\"\n</code></pre>"},{"location":"chapter4/4_2/#10_22-back-translation","title":"10_2.2 \u9006\u5411\u7ffb\u8bd1 (Back-Translation)\uff1a\u4ece\u7b54\u6848\u53cd\u63a8\u95ee\u9898","text":"<p>\u9664\u4e86\u4ece\u5934\u751f\u6210\uff0c\u53e6\u4e00\u79cd\u9ad8\u6548\u65b9\u6cd5\u662f\u201c\u9006\u5411\u7ffb\u8bd1\u201d\u3002\u5728\u4ee3\u7801\u9886\u57df\uff0c\u6211\u4eec\u901a\u5e38\u5f88\u5bb9\u6613\u627e\u5230\u9ad8\u8d28\u91cf\u7684\u4ee3\u7801\u7247\u6bb5\uff08\u4f8b\u5982 GitHub \u4e0a\u7684\u9ad8\u661f\u5e93\u51fd\u6570\uff09\uff0c\u4f46\u7f3a\u4e4f\u5bf9\u5e94\u7684\u81ea\u7136\u8bed\u8a00\u6307\u4ee4\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5229\u7528 LLM \u7684\u603b\u7ed3\u80fd\u529b\uff0c\u8f93\u5165\u4e00\u6bb5\u590d\u6742\u7684\u4ee3\u7801\uff0c\u8981\u6c42\u6a21\u578b\uff1a\u201c\u8bf7\u4e3a\u8fd9\u6bb5\u4ee3\u7801\u7f16\u5199\u4e00\u4e2a\u5c3d\u53ef\u80fd\u8be6\u7ec6\u7684\u5404\u79cd\u7528\u6237\u9700\u6c42\u6307\u4ee4\uff0c\u4f7f\u5f97\u8fd9\u6bb5\u4ee3\u7801\u6070\u597d\u80fd\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u201d\u8fd9\u80fd\u5feb\u901f\u751f\u6210\u5927\u91cf (Instruction, Output) \u5bf9\uff0c\u4e14 Output \u4fdd\u8bc1\u662f\u9ad8\u8d28\u91cf\u7684\u4eba\u7c7b\u4ee3\u7801\u3002\u8fd9\u79cd\u65b9\u6cd5\u7279\u522b\u9002\u5408\u589e\u5f3a\u6a21\u578b\u5bf9\u590d\u6742\u4ee3\u7801\u903b\u8f91\u7684\u7406\u89e3\u80fd\u529b\u3002</p>"},{"location":"chapter4/4_2/#10_23-pot-program-of-thought","title":"10_2.3 \u4ee3\u7801\u4e0e\u6570\u5b66\u5408\u6210\uff1aPoT (Program of Thought)","text":"<p>\u8fd9\u662f\u4fdd\u8bc1\u5408\u6210\u6570\u636e\u6b63\u786e\u6027\u7684\u6700\u5f3a\u624b\u6bb5\u3002\u901a\u8fc7\u5f3a\u5236\u6a21\u578b\u751f\u6210\u4ee3\u7801\uff0c\u6211\u4eec\u5c06\u6a21\u7cca\u7684\u81ea\u7136\u8bed\u8a00\u63a8\u7406\u8f6c\u5316\u4e3a\u4e86\u7cbe\u786e\u7684\u7a0b\u5e8f\u903b\u8f91\u3002</p> <p>\u6838\u5fc3\u4ee3\u7801\u62c6\u89e3\uff1a\u751f\u6210\u4e0e\u9a8c\u8bc1\u95ed\u73af <pre><code>import subprocess\nimport tempfile\nimport os\n\n# 1. PoT \u751f\u6210 Prompt\n# \u6211\u4eec\u8981\u6c42\u6a21\u578b\u628a\u89e3\u9898\u6b65\u9aa4\u5199\u6210 Python \u51fd\u6570 solver()\npot_prompt = \"\"\"\nQuestion: Janet has 3 times as many eggs as Bob. Bob has 5 eggs. How many eggs do they have in total?\n\nInstruction:\nWrite a Python function named `solver()` that returns the answer.\nDo not output the number directly. Write the code to calculate it.\nInclude comments explaining the logic.\n\"\"\"\n\n# \u5047\u8bbe LLM \u8fd4\u56de\u4e86\u4ee5\u4e0b\u4ee3\u7801\u5b57\u7b26\u4e32\ngenerated_code = \"\"\"\ndef solver():\n    # Bob has 5 eggs\n    bob_eggs = 5\n    # Janet has 3 times as many as Bob\n    janet_eggs = 3 * bob_eggs\n    # Total eggs\n    total = janet_eggs + bob_eggs\n    return total\n\"\"\"\n\n# 2. \u4ee3\u7801\u6267\u884c\u6c99\u7bb1 (Sandbox Execution)\n# \u8b66\u544a\uff1a\u76f4\u63a5\u6267\u884c\u751f\u6210\u7684\u4ee3\u7801\u6781\u5176\u5371\u9669\uff0c\u5fc5\u987b\u5728\u6c99\u7bb1\u4e2d\u8fd0\u884c\ndef execute_generated_code(code_str):\n    try:\n        # \u751f\u4ea7\u73af\u5883\u8bf7\u4f7f\u7528 Docker, gVisor \u6216 nsjail \u8fdb\u884c\u9694\u79bb\n        local_scope = {}\n\n        # \u9650\u5236\u6267\u884c\u65f6\u95f4\uff0c\u9632\u6b62\u6b7b\u5faa\u73af\n        # \u8fd9\u91cc\u4f7f\u7528\u7b80\u5316\u7684 exec \u6f14\u793a\uff0c\u5b9e\u9645\u9700\u914d\u5408 resource \u6a21\u5757\u9650\u5236 CPU/\u5185\u5b58\n        exec(code_str, {}, local_scope)\n\n        if 'solver' in local_scope:\n            result = local_scope['solver']()\n            return result, \"Success\"\n        else:\n            return None, \"No solver function found\"\n    except Exception as e:\n        return None, f\"Execution Error: {str(e)}\"\n\n# 3. \u9a8c\u8bc1\u4e0e\u6570\u636e\u4fdd\u5b58\nresult, status = execute_generated_code(generated_code)\n\nif status == \"Success\":\n    print(f\"Verified Answer: {result}\")\n    # \u4fdd\u5b58\u6570\u636e\u7b56\u7565\uff1a\n    # \u7b56\u7565 A (PoT): \u4fdd\u5b58 Instruction -&gt; Code\u3002\u8bad\u7ec3\u6a21\u578b\u5199\u4ee3\u7801\u89e3\u9898\u3002\n    # \u7b56\u7565 B (CoT): \u4fdd\u5b58 Instruction -&gt; \"Let's calculate... [Reasoning]... The answer is {result}\"\u3002\n    # \u7b56\u7565 B \u5229\u7528\u4ee3\u7801\u4f5c\u4e3a\u4e2d\u95f4\u6b65\u9aa4\uff0c\u751f\u6210\u7eaf\u6587\u672c\u63a8\u7406\u6570\u636e\u3002\n    save_to_dataset(pot_prompt, generated_code, result)\nelse:\n    print(\"Discard bad data: Code failed to execute\")\n</code></pre> \u5b9e\u6218\u6280\u5de7 (Pro Tip): \u751f\u6210\u7684\u6570\u636e\u4e0d\u4ec5\u53ef\u4ee5\u7528\u6765\u8bad\u7ec3 PoT \u6a21\u578b\uff0c\u8fd8\u53ef\u4ee5\u7528\u6765\u8bad\u7ec3\u666e\u901a\u7684 CoT \u6a21\u578b\u3002\u65b9\u6cd5\u662f\u5c06\u6267\u884c\u6210\u529f\u7684\u4ee3\u7801\u4f5c\u4e3a\u201c\u4e2d\u95f4\u6b65\u9aa4\u201d\uff0c\u5c06\u6267\u884c\u7ed3\u679c\u4f5c\u4e3a\u201c\u6700\u7ec8\u7b54\u6848\u201d\uff0c\u53cd\u5411\u6784\u9020\u6210 <code>&lt;thinking&gt;...code...&lt;/thinking&gt;&lt;answer&gt;...result...&lt;/answer&gt;</code> \u7684\u683c\u5f0f\u3002\u8fd9\u79cd\u201c\u501f\u9e21\u751f\u86cb\u201d\u7684\u65b9\u6cd5\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u7eaf\u6587\u672c\u6a21\u578b\u7684\u7b97\u672f\u51c6\u786e\u7387\u3002</p>"},{"location":"chapter4/4_2/#10_24-llava-pipeline","title":"10_2.4 \u591a\u6a21\u6001\u6307\u4ee4\u5408\u6210\uff1aLLaVA Pipeline","text":"<p>\u5229\u7528\u7eaf\u6587\u672c\u6a21\u578b\u5408\u6210\u591a\u6a21\u6001\u6570\u636e\u662f LLaVA \u7684\u521b\u4e3e\u3002\u8fd9\u79cd\u65b9\u6cd5\u7684\u6838\u5fc3\u5728\u4e8e\u5c06\u89c6\u89c9\u4fe1\u606f\u201c\u7b26\u53f7\u5316\u201d (Symbolization)\u2014\u2014\u65e2\u7136\u7eaf\u6587\u672c\u6a21\u578b\uff08\u5982 GPT-4\uff09\u770b\u4e0d\u89c1\u56fe\u50cf\uff0c\u6211\u4eec\u5c31\u628a\u56fe\u50cf\u7ffb\u8bd1\u6210\u5b83\u80fd\u8bfb\u61c2\u7684\u201c\u4ee3\u7801\u201d\u3002</p> <p> \u56fe 10-2\uff1a LLaVA \u6570\u636e\u5408\u6210\u6d41\u7a0b\u793a\u610f\u56fe</p>"},{"location":"chapter4/4_2/#1","title":"1. \u5de5\u7a0b\u6d41\u6c34\u7ebf\uff1a\u4ece\u50cf\u7d20\u5230\u7b26\u53f7","text":"<p>\u5728\u8bbe\u8ba1 Prompt \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u901a\u8fc7\u5de5\u5177\u94fe\u628a\u56fe\u50cf\u201c\u89e3\u6784\u201d\u4e3a\u6587\u672c\u6a21\u578b\u53ef\u8bfb\u7684\u7ed3\u6784\u5316\u6570\u636e\uff08Metadata\uff09\uff1a</p> <ol> <li> <p>\u5168\u5c40\u8bed\u4e49 (Captioning)</p> <ul> <li>\u5de5\u5177: \u4f7f\u7528 CLIP \u6216 BLIP \u751f\u6210\u4e00\u53e5\u8bdd\u63cf\u8ff0\u3002</li> <li>\u4f5c\u7528: \u63d0\u4f9b\u6574\u4f53\u8bed\u5883\uff08Context\uff09\u3002</li> <li>\u8f93\u51fa\u793a\u4f8b: <code>\"A young girl riding a horse on a beach at sunset.\"</code></li> </ul> </li> <li> <p>\u5c40\u90e8\u7ec6\u8282 (Object Detection)</p> <ul> <li>\u5de5\u5177: \u4f7f\u7528 Grounding DINO \u63d0\u53d6\u7269\u4f53\u53ca\u5176\u5750\u6807\uff08Bounding Box\uff09\u3002</li> <li>\u4f5c\u7528: \u63d0\u4f9b\u7a7a\u95f4\u4f4d\u7f6e\u5b9e\u4f53\uff08Spatial Anchoring\uff09\u3002</li> <li>\u8f93\u51fa\u793a\u4f8b: <code>{'girl': [100, 200, 300, 400], ...}</code></li> </ul> </li> <li> <p>\u6570\u636e\u5408\u6210 (Synthesis)</p> <ul> <li>\u52a8\u4f5c: \u5c06\u4e0a\u8ff0\u4fe1\u606f\u586b\u5165 Prompt\uff0c\u8c03\u7528 GPT-4 \u751f\u6210\u5bf9\u8bdd\u3002</li> </ul> </li> </ol>"},{"location":"chapter4/4_2/#2-prompt-engineering","title":"2. Prompt Engineering\uff1a\u8bbe\u8ba1\u4e0e\u8003\u91cf","text":"<p>\u6709\u4e86\u7ed3\u6784\u5316\u6570\u636e\u540e\uff0cPrompt \u7684\u8bbe\u8ba1\u5c31\u6210\u4e86\u51b3\u5b9a\u6570\u636e\u8d28\u91cf\u7684\u5173\u952e\u3002\u4ee5\u4e0b\u662f LLaVA \u98ce\u683c\u7684 Prompt \u6a21\u677f\u53ca\u5176\u8bbe\u8ba1\u80cc\u540e\u7684\u67b6\u6784\u8003\u91cf\uff1a</p> <pre><code># System Prompt for Multimodal Data Generation\nmultimodal_gen_prompt = \"\"\"\n### CONTEXT\nYou are an AI visual assistant. You cannot see the image directly, but I will provide its metadata.\nYour task is to generate a conversation between a Human and Yourself about this image.\n\n### IMAGE METADATA\n# [\u6570\u636e\u6ce8\u5165\u70b9]\uff1a\u6211\u4eec\u5c06\u6d41\u6c34\u7ebf\u63d0\u53d6\u7684\u6570\u636e\u586b\u5165\u8fd9\u91cc\n- **Caption**: \"{caption}\"\n- **Objects**: {object_list_with_boxes}\n\n### INSTRUCTIONS\n1. **Conversation Style**: Generate a multi-turn Q&amp;A (User asking, Assistant answering).\n2. **Reasoning**: The Human should ask complex questions (e.g., \"What suggests this is a safe environment?\"). You answer based on the visual evidence.\n3. **Spatial Awareness**: Use the bounding box info to describe relative positions if asked (e.g., \"The ocean is in the background...\").\n4. **Visual Consistency**: Do NOT hallucinate objects not listed in the metadata.\n\"\"\"\n</code></pre> <p>Prompt \u8bbe\u8ba1\u80cc\u540e\u7684\u67b6\u6784\u8003\u91cf\uff1a</p> <ul> <li> <p>\u4e3a\u4ec0\u4e48\u8981\u540c\u65f6\u63d0\u4f9b Caption \u548c Objects\uff1f\uff08\u4e92\u8865\u6027\uff09     \u4ec5\u6709 Object\uff08\u5973\u5b69\u3001\u9a6c\u3001\u6d77\uff09\u662f\u79bb\u6563\u7684\uff0c\u7f3a\u4e4f\u52a8\u4f5c\u548c\u6c1b\u56f4\uff1b\u4ec5\u6709 Caption\uff08\u5973\u5b69\u9a91\u9a6c\uff09\u7f3a\u4e4f\u5177\u4f53\u7684\u65b9\u4f4d\u4fe1\u606f\u3002\u4e24\u8005\u7ed3\u5408\uff0cGPT-4 \u624d\u80fd\u6784\u5efa\u51fa\u5b8c\u6574\u7684\u601d\u7ef4\u201c\u573a\u666f\u56fe\uff08Scene Graph\uff09\u201d\u3002</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u8981\u5f3a\u8c03 \"Spatial Awareness\"\uff1f\uff08\u7a7a\u95f4\u5bf9\u9f50\uff09     \u7eaf\u6587\u672c\u6a21\u578b\u5929\u751f\u7f3a\u4e4f\u7a7a\u95f4\u611f\u3002\u901a\u8fc7\u5f3a\u5236\u5b83\u5904\u7406 <code>[x1, y1, x2, y2]</code> \u5750\u6807\u6570\u636e\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5728\u5f3a\u8feb\u6587\u672c\u6a21\u578b\u5b66\u4e60\u201c\u89c6\u89c9\u5bf9\u9f50\u201d\uff0c\u8ba9\u5b83\u5b66\u4f1a\u7406\u89e3\u201c\u5de6\u8fb9\u201d\u3001\u201c\u53f3\u4e0b\u89d2\u201d\u7b49\u6982\u5ff5\u5bf9\u5e94\u7684\u50cf\u7d20\u533a\u57df\u3002</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u8981\u52a0\u5165 \"Visual Consistency\" \u7ea6\u675f\uff1f\uff08\u6291\u5236\u5e7b\u89c9\uff09     \u6587\u672c\u6a21\u578b\u6700\u5927\u7684\u7f3a\u9677\u662f\u5bb9\u6613\u201c\u8111\u8865\u201d\u3002\u4f8b\u5982\u770b\u5230\u201c\u6d77\u6ee9\u201d\uff0c\u5b83\u53ef\u80fd\u4f1a\u987a\u5634\u7f16\u51fa\u201c\u6709\u6d77\u9e25\u5728\u98de\u201d\u3002\u5fc5\u987b\u663e\u5f0f\u7981\u6b62\u5b83\u751f\u6210 Metadata \u4e2d\u4e0d\u5b58\u5728\u7684\u7269\u4f53\uff0c\u4ee5\u4fdd\u8bc1\u751f\u6210\u6570\u636e\u7684\u9ad8\u4fe1\u566a\u6bd4\uff08High Signal-to-Noise Ratio\uff09\u3002</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u8981\u751f\u6210 \"Complex Reasoning\"\uff1f\uff08\u6570\u636e\u5347\u7ef4\uff09     \u5982\u679c\u53ea\u662f\u7b80\u5355\u7684\u201c\u8fd9\u662f\u4ec0\u4e48\uff1f\u8fd9\u662f\u9a6c\u201d\uff0c\u5bf9\u6a21\u578b\u8bad\u7ec3\u6ca1\u6709\u4ef7\u503c\u3002\u6211\u4eec\u9700\u8981\u5229\u7528 GPT-4 \u7684\u667a\u529b\uff0c\u901a\u8fc7\u6570\u636e\u5408\u6210\u4eba\u4e3a\u521b\u9020\u51fa\u201c\u9700\u8981\u601d\u8003\u201d\u7684\u6837\u672c\uff08\u5982\u56e0\u679c\u63a8\u65ad\u3001\u60c5\u7eea\u5206\u6790\uff09\uff0c\u4ece\u800c\u8ba9\u5c0f\u6a21\u578b\uff08Student\uff09\u901a\u8fc7\u84b8\u998f\u5b66\u4f1a\u5927\u6a21\u578b\u7684\u63a8\u7406\u80fd\u529b\u3002</p> </li> </ul>"},{"location":"chapter4/4_2/#10_25","title":"10_2.5 \u591a\u6a21\u6001\u6307\u4ee4\u6570\u636e\u5408\u6210\u7684\u8fdb\u9636\u7b56\u7565","text":"<p>\u867d\u7136\u57fa\u4e8e\u7eaf\u6587\u672c\u6a21\u578b\u7684\u201c\u7b26\u53f7\u5316\u63a8\u7406\u201d\uff08\u5982 LLaVA v1 \u65e9\u671f\u65b9\u6cd5\uff09\u5f00\u521b\u4e86\u591a\u6a21\u6001\u6307\u4ee4\u5408\u6210\u7684\u5148\u6cb3\uff0c\u4f46\u5176\u4e3b\u8981\u7f3a\u9677\u5728\u4e8e\u201c\u89c6\u89c9\u4fe1\u606f\u7684\u6709\u635f\u538b\u7f29\u201d\u2014\u2014\u6587\u672c\u6a21\u578b\u65e0\u6cd5\u76f4\u63a5\u611f\u77e5\u50cf\u7d20\u7ea7\u7684\u89c6\u89c9\u7279\u5f81\uff0c\u4ec5\u4f9d\u8d56\u5143\u6570\u636e\uff08Metadata\uff09\u8fdb\u884c\u63a8\u7406\u5bb9\u6613\u5bfc\u81f4\u5e7b\u89c9\uff08Hallucination\uff09\u3002</p> <p>\u4e3a\u4e86\u7a81\u7834\u8fd9\u4e00\u74f6\u9888\uff0c\u5f53\u524d\u5de5\u4e1a\u754c\u4e0e\u5b66\u672f\u754c\u5df2\u7ecf\u6f14\u5316\u51fa\u4e09\u79cd\u66f4\u4e3a\u4e3b\u6d41\u4e14\u9ad8\u6548\u7684\u5408\u6210\u7b56\u7565\uff1a\u89c6\u89c9\u5f3a\u6a21\u578b\u84b8\u998f\u3001\u591a\u4e13\u5bb6\u6df7\u5408\u6d41\u6c34\u7ebf\u4ee5\u53ca\u8fdb\u5316\u6307\u4ee4\u751f\u6210\u3002</p>"},{"location":"chapter4/4_2/#1-visual-model-distillation","title":"1. \u89c6\u89c9\u5f3a\u6a21\u578b\u84b8\u998f (Visual Model Distillation)","text":"<p>\u8fd9\u662f\u76ee\u524d\uff08\u622a\u81f3 2024-2025 \u5e74\uff09\u6784\u5efa\u9ad8\u6027\u80fd\u5f00\u6e90\u591a\u6a21\u6001\u6a21\u578b\uff08\u5982 LLaVA-NeXT, ShareGPT4V\uff09\u7684\u6700\u4e3b\u6d41\u65b9\u6cd5\uff0c\u5e38\u88ab\u89c6\u4e3a SOTA\uff08State-of-the-Art\uff09\u65b9\u6848\u3002</p> <p>\u6838\u5fc3\u601d\u60f3 \u8be5\u65b9\u6cd5\u6452\u5f03\u4e86\u201c\u5229\u7528\u6587\u672c\u6a21\u578b\u731c\u6d4b\u89c6\u89c9\u5185\u5bb9\u201d\u7684\u8def\u5f84\uff0c\u8f6c\u800c\u91c7\u7528\u201c\u6559\u5e08-\u5b66\u751f\u201d\uff08Teacher-Student\uff09\u84b8\u998f\u8303\u5f0f\u3002\u5229\u7528\u95ed\u6e90\u7684\u9876\u5c16\u591a\u6a21\u6001\u5927\u6a21\u578b\uff08\u5982 GPT-4o, Gemini 1_5 Pro\uff09\u4f5c\u4e3a\u201c\u6559\u5e08\u6a21\u578b\u201d\uff0c\u76f4\u63a5\u5904\u7406\u539f\u59cb\u56fe\u50cf\u4fe1\u53f7\uff0c\u751f\u6210\u9ad8\u8d28\u91cf\u3001\u9ad8\u5bc6\u5ea6\u7684\u8be6\u7ec6\u63cf\u8ff0\uff08Dense Caption\uff09\u548c\u590d\u6742\u7684\u63a8\u7406\u95ee\u7b54\u5bf9\uff0c\u4f9b\u5f00\u6e90\u6a21\u578b\uff08\u5b66\u751f\u6a21\u578b\uff09\u5b66\u4e60\u3002</p> <p>\u4f18\u52bf\u5206\u6790 * \u6d88\u9664\u6a21\u6001\u9694\u9602\uff1a\u6559\u5e08\u6a21\u578b\u76f4\u63a5\u201c\u770b\u201d\u5230\u56fe\u50cf\u50cf\u7d20\uff0c\u80fd\u591f\u6355\u6349\u5149\u5f71\u3001\u6750\u8d28\u3001\u5fae\u8868\u60c5\u7b49\u6587\u672c\u5143\u6570\u636e\u65e0\u6cd5\u627f\u8f7d\u7684\u7ec6\u8282\u3002 * \u6291\u5236\u5e7b\u89c9\uff1a\u57fa\u4e8e\u771f\u5b9e\u89c6\u89c9\u8f93\u5165\u7684\u63cf\u8ff0\u6781\u5927\u964d\u4f4e\u4e86\u4e8b\u5b9e\u6027\u9519\u8bef\u7684\u6982\u7387\u3002</p> <p>\u5b9e\u73b0\u6d41\u7a0b \u5176\u6838\u5fc3\u5728\u4e8e\u6784\u5efa\u4e00\u4e2a\u80fd\u591f\u8bf1\u5bfc\u6559\u5e08\u6a21\u578b\u8f93\u51fa\u8be6\u5c3d\u4fe1\u606f\u7684 Prompt\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u6807\u51c6\u7684\u84b8\u998f\u6d41\u7a0b\u4f2a\u4ee3\u7801\uff1a</p> <pre><code>def generate_dense_instruction(image_path, api_client):\n    \"\"\"\n    \u5229\u7528 SOTA MLLM \u751f\u6210\u9ad8\u5bc6\u5ea6\u591a\u6a21\u6001\u6307\u4ee4\u6570\u636e\n    \"\"\"\n\n    # System Prompt \u8bbe\u8ba1\u5173\u952e\uff1a\u8981\u6c42\u6781\u5176\u8be6\u5c3d\u7684\u7ec6\u8282\u6355\u6349\u4e0e\u903b\u8f91\u5173\u8054\n    distillation_prompt = \"\"\"\n    You are an expert visual analyst. Analyze the provided image with extreme detail.\n\n    Tasks:\n    1. Dense Captioning: Provide a comprehensive description of every corner of the image, covering colors, textures, lighting, and background details.\n    2. Object Relationships: Analyze the interactions between objects (e.g., causality, spatial relations).\n    3. OCR Extraction: Transcribe any visible text verbatim.\n    4. Q&amp;A Generation: Based on the visual details above, create a logical reasoning question that cannot be answered without looking at the image.\n    \"\"\"\n\n    # \u5173\u952e\u5dee\u5f02\uff1a\u8f93\u5165\u5305\u542b\u771f\u5b9e\u7684 Image Tensor\uff0c\u800c\u975e\u4ec5\u4ec5\u662f Bounding Box\n    response = api_client.chat.completions.create(\n        model=\"gpt-4o\",\n        messages=[\n            {\"role\": \"system\", \"content\": distillation_prompt},\n            {\"role\": \"user\", \"content\": [{\"type\": \"image_url\", \"url\": image_path}]}\n        ]\n    )\n\n    return parse_response(response)\n</code></pre>"},{"location":"chapter4/4_2/#2-mixture-of-experts-pipeline","title":"2. \u9886\u57df\u7279\u5316\uff1a\u591a\u4e13\u5bb6\u6df7\u5408\u6d41\u6c34\u7ebf (Mixture-of-Experts Pipeline)","text":"<p>\u5bf9\u4e8e\u901a\u7528\u5927\u6a21\u578b\u96be\u4ee5\u8986\u76d6\u7684\u5782\u76f4\u9886\u57df\u2014\u2014\u5982\u6587\u6863\u667a\u80fd\uff08Document AI\uff09\u3001\u590d\u6742\u56fe\u8868\u5206\u6790\u6216\u81ea\u52a8\u9a7e\u9a76\u6570\u636e\uff0c\u901a\u7528\u7684\u89c6\u89c9\u84b8\u998f\u5f80\u5f80\u7f3a\u4e4f\u7cbe\u5ea6\u3002\u6b64\u65f6\uff0c\u91c7\u7528\u201c\u591a\u4e13\u5bb6\u6df7\u5408\u201d\u7b56\u7565\u662f\u6700\u4f73\u5b9e\u8df5\u3002</p> <p>\u6838\u5fc3\u903b\u8f91 \u8be5\u65b9\u6cd5\u4e0d\u4f9d\u8d56\u5355\u4e00\u6a21\u578b\u7684\u7aef\u5230\u7aef\u80fd\u529b\uff0c\u800c\u662f\u7ec4\u88c5\u591a\u4e2a\u4e13\u7528\u7684\u5c0f\u6a21\u578b\uff08Experts\uff09\u4f5c\u4e3a\u611f\u77e5\u524d\u7aef\uff0c\u5c06\u975e\u7ed3\u6784\u5316\u56fe\u50cf\u8f6c\u5316\u4e3a\u7cbe\u7ec6\u7684\u7ed3\u6784\u5316\u6570\u636e\uff0c\u518d\u7531 LLM \u8fdb\u884c\u6574\u5408\u3002</p> <p>\u903b\u8f91\u6d41\uff1a $$ \\text{Image} \\xrightarrow{\\text{Experts}} [\\text{OCR} + \\text{Layout} + \\text{Detection}] \\xrightarrow{\\text{Aggregation}} \\text{Structured Context} \\xrightarrow{\\text{LLM}} \\text{Instruction} $$</p> <p>\u5e94\u7528\u573a\u666f\u4e0e\u6d41\u7a0b\u56fe\u89e3 \u5178\u578b\u5e94\u7528\u5305\u62ec\u91d1\u878d\u7968\u636e\u5904\u7406\uff08Invoices\uff09\u3001\u533b\u7597\u5f71\u50cf\u62a5\u544a\uff08DICOM\uff09\u7b49\u3002</p> <ol> <li>OCR Expert (\u5982 PaddleOCR): \u63d0\u53d6\u56fe\u50cf\u4e2d\u6240\u6709\u6587\u672c\u53ca\u5176\u7cbe\u786e\u5750\u6807 \\((x_1, y_1, x_2, y_2)\\)\u3002</li> <li>Layout Expert (\u5982 LayoutLM): \u89e3\u6790\u6587\u6863\u7684\u62d3\u6251\u7ed3\u6784\uff0c\u8bc6\u522b\u8868\u683c\u884c\u5217\u3001\u6bb5\u843d\u5c42\u7ea7\u548c\u6807\u9898\u5173\u7cfb\u3002</li> <li>Synthesis (LLM): \u5c06\u4e0a\u8ff0\u7ed3\u6784\u5316\u6570\u636e\u586b\u5165 Prompt \u6a21\u677f\u3002<ul> <li>Example Prompt: \u201c\u8fd9\u662f\u4e00\u5f20\u53d1\u7968\u7684\u7ed3\u6784\u5316\u6570\u636e\uff0c\u53d1\u7968\u53f7\u7801\u4f4d\u4e8e (100, 200)\uff0c\u91d1\u989d\u603b\u8ba1\u4e3a 500_00\u3002\u8bf7\u57fa\u4e8e\u6b64\u751f\u6210\u4e00\u4e2a\u5173\u4e8e\u2018\u8d22\u52a1\u5ba1\u8ba1\u6838\u5bf9\u2019\u7684\u591a\u8f6e\u95ee\u7b54\u3002\u201d</li> </ul> </li> </ol> <p> \u56fe 10-3\uff1a \u591a\u4e13\u5bb6\u6df7\u5408\u6d41\u6c34\u7ebf\u793a\u610f\u56fe</p>"},{"location":"chapter4/4_2/#3-visual-evol-instruct","title":"3. \u8fdb\u5316\u6307\u4ee4\u751f\u6210 (Visual Evol-Instruct)","text":"<p>\u53d7\u7eaf\u6587\u672c\u9886\u57df WizardLM \u7684\u542f\u53d1\uff0cVisual Evol-Instruct \u65e8\u5728\u89e3\u51b3\u8bad\u7ec3\u6570\u636e\u201c\u540c\u8d28\u5316\u201d\u548c\u201c\u7b80\u5355\u5316\u201d\u7684\u95ee\u9898\u3002\u5f53\u57fa\u7840\u6570\u636e\u96c6\u4ec5\u5305\u542b\u7b80\u5355\u7684\u8bc6\u522b\u4efb\u52a1\uff08\u5982\u201c\u56fe\u91cc\u6709\u4ec0\u4e48\uff1f\u201d\uff09\u65f6\uff0c\u6a21\u578b\u65e0\u6cd5\u5b66\u4f1a\u9ad8\u9636\u63a8\u7406\u3002\u8be5\u65b9\u6cd5\u901a\u8fc7 Prompt Engineering \u5f3a\u5236\u8ba9\u6a21\u578b\u5bf9\u73b0\u6709\u6570\u636e\u8fdb\u884c\u201c\u5347\u7ef4\u201d\u3002</p> <p>\u6838\u5fc3\u903b\u8f91 $$ \\text{Simple VQA} \\xrightarrow{\\text{Complexity Constraints}} \\text{Complex Reasoning VQA} $$</p> <p>\u901a\u8fc7\u5411 LLM \u65bd\u52a0\u7279\u5b9a\u7684\u8fdb\u5316\u6307\u4ee4\uff0c\u53ef\u4ee5\u4ece\u4ee5\u4e0b\u7ef4\u5ea6\u63d0\u5347\u6570\u636e\u590d\u6742\u5ea6\uff1a</p> <ul> <li>\u6df1\u5ea6\u63a8\u7406\u5316 (Reasoning):<ul> <li>\u539f\u9898: \u201c\u8fd9\u4e2a\u4eba\u624b\u91cc\u62ff\u7740\u4ec0\u4e48\uff1f\u201d</li> <li>\u8fdb\u5316\u540e: \u201c\u7ed3\u5408\u624b\u4e2d\u7269\u4f53\u7684\u7528\u9014\u548c\u4eba\u7269\u7684\u7a7f\u7740\uff0c\u63a8\u6d4b\u6b64\u4eba\u7684\u804c\u4e1a\u4ee5\u53ca\u4ed6\u63a5\u4e0b\u6765\u53ef\u80fd\u8fdb\u884c\u7684\u6d3b\u52a8\u3002\u201d</li> </ul> </li> <li>\u53cd\u4e8b\u5b9e\u63a8\u7406 (Counterfactual):<ul> <li>\u539f\u9898: \u201c\u56fe\u4e2d\u7684\u8f66\u662f\u7ea2\u8272\u7684\u3002\u201d</li> <li>\u8fdb\u5316\u540e: \u201c\u5982\u679c\u5c06\u56fe\u4e2d\u7684\u7ea2\u8272\u8dd1\u8f66\u66ff\u6362\u4e3a\u4e00\u8f86\u8001\u65e7\u7684\u81ea\u884c\u8f66\uff0c\u6574\u4e2a\u573a\u666f\u7684\u6c1b\u56f4\u4f1a\u53d1\u751f\u600e\u6837\u7684\u53d8\u5316\uff1f\u8fd9\u662f\u5426\u7b26\u5408\u80cc\u666f\u4e2d\u51fa\u73b0\u7684\u73b0\u4ee3\u5efa\u7b51\u98ce\u683c\uff1f\u201d</li> </ul> </li> <li>\u6bd4\u8f83\u5206\u6790 (Comparative):<ul> <li>\u8f93\u5165\u4e24\u5f20\u76f8\u4f3c\u56fe\u50cf\uff0c\u8981\u6c42\u6a21\u578b\u5206\u6790\u5176\u7ec6\u5fae\u5dee\u5f02\uff08\u5982\u5149\u7167\u53d8\u5316\u3001\u7269\u4f53\u4f4d\u79fb\uff09\uff0c\u8bad\u7ec3\u6a21\u578b\u7684\u7ec6\u7c92\u5ea6\u89c2\u5bdf\u529b\u3002</li> </ul> </li> </ul> <p>\u901a\u8fc7\u4e0a\u8ff0\u4e09\u79cd\u7b56\u7565\u7684\u7ec4\u5408\u4f7f\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u6784\u5efa\u51fa\u65e2\u5305\u542b\u4e30\u5bcc\u89c6\u89c9\u7ec6\u8282\uff0c\u53c8\u5177\u5907\u6df1\u5ea6\u903b\u8f91\u63a8\u7406\u80fd\u529b\u7684\u9ad8\u8d28\u91cf\u591a\u6a21\u6001\u6307\u4ee4\u6570\u636e\u96c6\uff0c\u4e3a\u8bad\u7ec3 LLaVA\u3001MiniGPT-4 \u7b49\u6a21\u578b\u6253\u4e0b\u575a\u5b9e\u57fa\u7840\u3002</p>"},{"location":"chapter4/4_2/#10_3-performance-evaluation","title":"10_3. \u6027\u80fd\u4e0e\u8bc4\u4f30 (Performance &amp; Evaluation)","text":"<p>\u5728\u5408\u6210\u6570\u636e\u4e0a\u8bad\u7ec3\u5b8c\u6a21\u578b\u540e\uff0c\u8bc4\u4f30\u663e\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u786e\u8ba4\u6a21\u578b\u662f\u771f\u7684\u201c\u5b66\u4f1a\u4e86\u201d\u8fd8\u662f\u4ec5\u4ec5\u201c\u8bb0\u4f4f\u4e86\u201d\u5408\u6210\u6570\u636e\u4e2d\u7684\u6a21\u5f0f\u3002</p>"},{"location":"chapter4/4_2/#_3","title":"\u8bc4\u4ef7\u6307\u6807","text":"<ul> <li>Pass@1 (\u4ee3\u7801): \u5bf9\u4e8e PoT \u5408\u6210\u6570\u636e\uff0c\u6211\u4eec\u5728 HumanEval \u4e0a\u6d4b\u8bd5 Pass@1\u3002Phi-1 \u4ec5\u7528 6B \u6570\u636e\u5c31\u8fbe\u5230\u4e86 50%+ \u7684 Pass@1\uff0c\u8d85\u8fc7\u4e86\u8bb8\u591a\u8bad\u7ec3\u6570\u636e\u91cf\u5927 100 \u500d\u7684\u6a21\u578b\u3002\u8fd9\u8bc1\u660e\u4e86\u6570\u636e\u8d28\u91cf\u7684\u538b\u5012\u6027\u4f18\u52bf\u3002</li> <li>Hallucination Rate (\u5e7b\u89c9\u7387): \u6bd4\u8f83\u5408\u6210\u7684\u591a\u6a21\u6001\u56de\u7b54\u4e0e\u539f\u56fe\u7684 CLIP \u76f8\u4f3c\u5ea6\uff0c\u68c0\u6d4b\u662f\u5426\u751f\u6210\u4e86\u56fe\u4e2d\u4e0d\u5b58\u5728\u7684\u7269\u4f53\u3002\u6211\u4eec\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u8d1f\u6837\u672c\u96c6\uff0c\u4e13\u95e8\u8bf1\u5bfc\u6a21\u578b\u56de\u7b54\u4e0d\u5b58\u5728\u7684\u7269\u4f53\uff0c\u770b\u6a21\u578b\u662f\u5426\u80fd\u62d2\u7edd\u56de\u7b54\u3002</li> <li>Decontamination (\u53bb\u6c61\u67d3\u68c0\u6d4b): \u8fd9\u662f\u4e00\u4e2a\u80ae\u810f\u4f46\u5fc5\u987b\u7684\u6b65\u9aa4\u3002\u6211\u4eec\u9700\u8981\u68c0\u67e5\u5408\u6210\u6570\u636e\u662f\u5426\u65e0\u610f\u4e2d\u5305\u542b\u4e86\u6d4b\u8bd5\u96c6\uff08\u5982 HumanEval\uff09\u7684\u9898\u76ee\u3002\u901a\u8fc7 N-gram \u91cd\u53e0\u68c0\u6d4b\uff0c\u786e\u4fdd\u6a21\u578b\u662f\u5728\u6cdb\u5316\u800c\u975e\u4f5c\u5f0a\u3002</li> </ul>"},{"location":"chapter4/4_2/#_4","title":"\u57fa\u51c6\u6d4b\u8bd5","text":"<ul> <li>PoT vs CoT: \u5728\u6570\u5b66\u9898\uff08\u5982 GSM8K\uff09\u4e0a\uff0cPoT \u65b9\u6cd5\u901a\u5e38\u6bd4\u7eaf\u6587\u672c CoT \u51c6\u786e\u7387\u9ad8 5-10%\u3002\u539f\u56e0\u5728\u4e8e PoT \u5c06\u8ba1\u7b97\u5916\u5305\u7ed9\u4e86\u6700\u64c5\u957f\u8ba1\u7b97\u7684 CPU\uff0c\u800c\u8ba9 GPU \u4e13\u6ce8\u4e8e\u5176\u64c5\u957f\u7684\u903b\u8f91\u7ffb\u8bd1\uff0c\u8fd9\u662f\u4e00\u79cd\u6700\u4f18\u7684\u7b97\u529b\u5206\u914d\u3002</li> </ul>"},{"location":"chapter4/4_2/#10_4-pitfalls-troubleshooting","title":"10_4. \u907f\u5751\u6307\u5357 (Pitfalls &amp; Troubleshooting)","text":"<p>\u5408\u6210\u6570\u636e\u867d\u7136\u7f8e\u597d\uff0c\u4f46\u4e5f\u5145\u6ee1\u4e86\u9677\u9631\u3002\u7a0d\u6709\u4e0d\u614e\uff0c\u6a21\u578b\u5c31\u4f1a\u9677\u5165\u201c\u81ea\u6211\u9676\u9189\u201d\u7684\u602a\u5708\u3002</p> <ul> <li> <p>\u9677\u9631 1\uff1aSelf-Confirmation Bias (\u81ea\u8bc1\u504f\u5dee)</p> <ul> <li>\u73b0\u8c61\uff1a \u6a21\u578b\u751f\u6210\u7684\u4ee3\u7801\u867d\u7136\u80fd\u8dd1\u901a\uff0c\u4f46\u903b\u8f91\u662f\u9519\u7684\uff08\u4f8b\u5982 2+2=5\uff0c\u4e14\u6a21\u578b\u751f\u6210\u7684\u6d4b\u8bd5\u7528\u4f8b\u4e5f\u662f\u9519\u7684\uff0c\u6070\u597d\u901a\u8fc7\u4e86\u9519\u8bef\u7684\u51fd\u6570\uff09\u3002</li> <li>\u4fee\u6b63\uff1a \u5fc5\u987b\u5f15\u5165\u5916\u90e8\u7684\u3001\u786e\u5b9a\u6027\u7684 Solver \u6216\u7ecf\u8fc7\u4eba\u5de5\u5ba1\u6838\u7684 Unit Tests \u5e93\u3002\u6c38\u8fdc\u4e0d\u8981\u5b8c\u5168\u4f9d\u8d56\u6a21\u578b\u751f\u6210\u7684\u6d4b\u8bd5\u7528\u4f8b\u6765\u9a8c\u8bc1\u6a21\u578b\u751f\u6210\u7684\u4ee3\u7801\uff0c\u8fd9\u5c31\u50cf\u8ba9\u7f6a\u72af\u81ea\u5df1\u5ba1\u5224\u81ea\u5df1\u3002</li> </ul> </li> <li> <p>\u9677\u9631 2\uff1aLack of Visual Grounding (\u89c6\u89c9\u951a\u70b9\u7f3a\u5931)</p> <ul> <li>\u73b0\u8c61\uff1a \u591a\u6a21\u6001\u5408\u6210\u6570\u636e\u4e2d\uff0c\u6a21\u578b\u8ba8\u8bba\u4e86 metadata \u4e2d\u6ca1\u63d0\u5230\u7684\u7ec6\u8282\uff08\u778e\u7f16\uff09\u3002\u4f8b\u5982\uff0cMetadata \u91cc\u53ea\u6709\u201c\u72d7\u201d\uff0c\u6a21\u578b\u5374\u5f00\u59cb\u63cf\u8ff0\u201c\u72d7\u9879\u5708\u7684\u989c\u8272\u201d\uff0c\u800c\u56fe\u7247\u91cc\u7684\u72d7\u6839\u672c\u6ca1\u6234\u9879\u5708\u3002</li> <li>\u4fee\u6b63\uff1a \u5728 Prompt \u4e2d\u52a0\u5165 strict instruction\uff1a\u201cOnly strictly rely on the provided metadata. Do not invent details.\u201d \u540c\u65f6\uff0c\u4f7f\u7528 CLIP Score \u8fc7\u6ee4\u6389\u90a3\u4e9b\u4e0e\u539f\u56fe\u76f8\u4f3c\u5ea6\u8fc7\u4f4e\u7684\u751f\u6210\u6587\u672c\u3002</li> </ul> </li> <li> <p>\u9677\u9631 3\uff1aThe Homogenization Trap (\u540c\u8d28\u5316\u9677\u9631)</p> <ul> <li>\u73b0\u8c61\uff1a \u5982\u679c\u6240\u6709\u6570\u636e\u90fd\u7531 GPT-4 \u751f\u6210\uff0c\u4f60\u7684\u6a21\u578b\u6700\u7ec8\u4f1a\u53d8\u6210\u4e00\u4e2a\u201c\u4f4e\u914d\u7248 GPT-4\u201d\uff0c\u5931\u53bb\u4e86\u591a\u6837\u6027\u3002\u6240\u6709\u7684\u56de\u7b54\u8bed\u6c14\u3001\u53e5\u5f0f\u90fd\u60ca\u4eba\u7684\u4e00\u81f4\u3002</li> <li>\u4fee\u6b63\uff1a \u71b5\u6ce8\u5165 (Entropy Injection)\u3002\u5728 Prompt \u4e2d\u968f\u673a\u6ce8\u5165\u4e0d\u540c\u7684 Persona\uff08\u5982\u201c\u66b4\u8e81\u7684\u7a0b\u5e8f\u5458\u201d\u3001\u201c\u8010\u5fc3\u7684\u5e7c\u513f\u56ed\u8001\u5e08\u201d\uff09\uff0c\u6216\u8005\u8981\u6c42\u6a21\u578b\u4f7f\u7528\u4e0d\u540c\u7684\u7f16\u7a0b\u98ce\u683c\uff08\u9012\u5f52 vs \u8fed\u4ee3\uff09\uff0c\u5f3a\u5236\u6269\u5c55\u6570\u636e\u7684\u5206\u5e03\u8303\u56f4\u3002</li> </ul> </li> </ul>"},{"location":"chapter4/4_2/#10_5","title":"10_5. \u672c\u7ae0\u5c0f\u7ed3\u4e0e\u5ef6\u4f38\u9605\u8bfb","text":"<p>Textbooks Are All You Need\u201d \u8303\u5f0f\u786e\u7acb\u4e86\u6570\u636e\u8d28\u91cf\uff08\u5373\u6559\u80b2\u4ef7\u503c\uff09\u4f18\u5148\u4e8e\u6570\u91cf\u7684\u6838\u5fc3\u539f\u5219\uff0c\u800c\u5408\u6210\u6570\u636e\u6280\u672f\u8d4b\u4e88\u4e86\u6211\u4eec\u8981\u7cbe\u786e\u63a7\u5236\u6570\u636e\u4fe1\u566a\u6bd4\u7684\u80fd\u529b\u3002\u5728\u6b64\u4f53\u7cfb\u4e0b\uff0c\u7a0b\u5e8f\u601d\u7ef4\uff08PoT\uff09\u901a\u8fc7\u5c06\u63a8\u7406\u8fc7\u7a0b\u8f6c\u5316\u4e3a\u53ef\u6267\u884c\u4ee3\u7801\uff0c\u5229\u7528\u7f16\u8bd1\u5668\u7684\u786e\u5b9a\u6027\u6765\u9a8c\u8bc1\u903b\u8f91\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u6570\u636e\u7684\u4e25\u8c28\u6027\u3002\u540c\u65f6\uff0cSymbolic-to-Synthetic \u65b9\u6cd5\u5229\u7528\u5143\u6570\u636e\uff08\u5982 Bounding Box\uff09\u5f15\u5bfc\u6587\u672c\u6a21\u578b\u751f\u6210\u591a\u6a21\u6001\u5185\u5bb9\uff0c\u5b9e\u73b0\u4e86\u4ece\u5355\u6a21\u6001\u5411\u591a\u6a21\u6001\u6570\u636e\u7684\u6709\u6548\u8f6c\u5316\u3002\u8fd9\u4e00\u7cfb\u5217\u6f14\u8fdb\u6807\u5fd7\u7740\u6570\u636e\u5de5\u7a0b\u6b63\u5728\u7ecf\u5386\u4ece\u88ab\u52a8\u201c\u6316\u6398\u201d\u5230\u4e3b\u52a8\u201c\u751f\u4ea7\u201d\u7684\u6a21\u5f0f\u8f6c\u53d8\uff1a\u5373\u901a\u8fc7\u79cd\u5b50\u63d0\u793a\u8bcd\u6784\u5efa\uff08Seed Prompts\uff09\u3001\u6307\u4ee4\u590d\u6742\u5316\uff08Evolution\uff09\u3001\u8d28\u91cf\u8fc7\u6ee4\uff08Filtering\uff09\u4e0e\u6700\u7ec8\u5408\u6210\uff08Synthesis\uff09\u7684\u6807\u51c6\u5de5\u4e1a\u5316\u6d41\u7a0b\uff0c\u7cfb\u7edf\u6027\u5730\u6784\u5efa\u9ad8\u8d28\u91cf\u6570\u636e\u96c6\u3002</p>"},{"location":"chapter4/4_2/#_5","title":"\u53c2\u8003\u6587\u732e","text":"<ul> <li>Gunasekar, S., et al. (2023). Textbooks Are All You Need (Phi-1).</li> <li>Chen, W., et al. (2022). Program of Thoughts Prompting: Disentangling Computation from Reasoning for Numerical Reasoning Tasks.</li> <li>Liu, H., et al. (2023). Visual Instruction Tuning (LLaVA).</li> <li>Shumailov, I., et al. (2023). The Curse of Recursion: Training on Generated Data Makes Models Forget. (\u5173\u4e8e\u6a21\u578b\u574d\u584c\u7684\u91cd\u8981\u7814\u7a76)</li> </ul>"},{"location":"chapter4/4_3/","title":"\u7b2c11\u7ae0\uff1a\u4eba\u7c7b\u504f\u597d\u6570\u636e (RLHF/DPO)","text":""},{"location":"chapter4/4_3/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5982\u679c\u8bf4 SFT\uff08\u6307\u4ee4\u5fae\u8c03\uff09\u662f\u8ba9\u6a21\u578b\u201c\u5b66\u4f1a\u8bf4\u8bdd\u201d\uff0c\u83b7\u5f97\u4e86\u57fa\u7840\u7684\u8bed\u8a00\u80fd\u529b\u548c\u4efb\u52a1\u5904\u7406\u80fd\u529b\uff0c\u90a3\u4e48\u504f\u597d\u5bf9\u9f50\uff08RLHF/DPO\uff09\u5219\u662f\u8ba9\u6a21\u578b\u201c\u8bf4\u6b63\u786e\u7684\u8bdd\u201d\uff0c\u4f7f\u5176\u8f93\u51fa\u7b26\u5408\u4eba\u7c7b\u7684\u4ef7\u503c\u89c2\u3001\u4f26\u7406\u6807\u51c6\u4ee5\u53ca\u7279\u5b9a\u7684\u4e1a\u52a1\u504f\u597d\u3002\u672c\u7ae0\u5c06\u6df1\u5165\u5256\u6790 DPO\uff08Direct Preference Optimization\uff09\u7b97\u6cd5\u7684\u6838\u5fc3\u2014\u2014\u7531 Chosen\u4e0e Rejected\u7ec4\u6210\u7684\u6837\u672c\u5bf9\u3002\u6211\u4eec\u5c06\u63a2\u8ba8\u5982\u4f55\u4ece\u6df7\u4e71\u7684\u4eba\u7c7b\u4e3b\u89c2\u5224\u65ad\u4e2d\u63d0\u53d6\u51fa\u9ad8\u8d28\u91cf\u7684\u4fe1\u53f7\uff0c\u8fd9\u6d89\u53ca\u5230\u6807\u6ce8\u5e73\u53f0\u7684\u4e00\u81f4\u6027\u7ba1\u7406\uff08IAA\uff09\u4ee5\u53ca\u5bf9\u4eba\u7c7b\u8ba4\u77e5\u504f\u5dee\u7684\u6df1\u523b\u7406\u89e3\u3002\u6b64\u5916\uff0c\u6211\u4eec\u5c06\u91cd\u70b9\u4ecb\u7ecd\u524d\u6cbf\u7684 RLAIF (Constitutional AI) \u6280\u672f\uff0c\u5373\u5229\u7528 AI \u6839\u636e\u9884\u8bbe\u7684\u201c\u5baa\u6cd5\u201d\u539f\u5219\u66ff\u4ee3\u4eba\u7c7b\u8fdb\u884c\u504f\u597d\u6253\u5206\uff0c\u8fd9\u4e00\u6280\u672f\u6b63\u5728\u6839\u672c\u6027\u5730\u6539\u53d8\u5927\u89c4\u6a21\u5bf9\u9f50\u7684\u6210\u672c\u7ed3\u6784\u4e0e\u6548\u7387\u3002</p> <p>\u5b66\u4e60\u76ee\u6807 (Learning Objectives)\uff1a * \u6df1\u5ea6\u638c\u63e1 \u6784\u5efa DPO \u4e09\u5143\u7ec4 (Prompt, Chosen, Rejected) \u7684\u6807\u51c6\u6570\u636e\u683c\u5f0f\uff0c\u7406\u89e3\u5176\u80cc\u540e\u7684\u5bf9\u6bd4\u5b66\u4e60\u539f\u7406\u53ca\u6570\u5b66\u610f\u4e49\u3002 * \u900f\u5f7b\u7406\u89e3 \u6807\u6ce8\u566a\u97f3\u7684\u5fc3\u7406\u5b66\u4e0e\u7edf\u8ba1\u5b66\u6765\u6e90\uff0c\u80fd\u591f\u8ba1\u7b97 IAA (Inter-Annotator Agreement) \u5e76\u5229\u7528 Cohen's Kappa \u7cfb\u6570\u6e05\u6d17\u4f4e\u8d28\u91cf\u6570\u636e\u3002 * \u5de5\u7a0b\u843d\u5730 Constitutional AI \u7684 Critique-Revision \u5faa\u73af\uff0c\u5229\u7528\u201c\u5224\u522b\u5668\u201d\u5f3a\u4e8e\u201c\u751f\u6210\u5668\u201d\u7684\u7279\u6027\uff0c\u81ea\u52a8\u5316\u751f\u6210\u5927\u89c4\u6a21\u65e0\u5bb3\u5316\uff08Harmless\uff09\u504f\u597d\u6570\u636e\u3002</p> <p>\u573a\u666f\u5f15\u5165\uff1a \u201c\u4f60\u7684 SFT \u6a21\u578b\u975e\u5e38\u542c\u8bdd\uff0c\u542c\u8bdd\u5230\u6709\u4eba\u95ee\u2018\u5982\u4f55\u5236\u9020\u6bd2\u836f\u2019\u65f6\uff0c\u5b83\u4e5f\u8be6\u7ec6\u5217\u51fa\u4e86\u5316\u5b66\u914d\u65b9\u3002\u8fd9\u662f\u7edd\u5bf9\u7684\u5b89\u5168\u7ea2\u7ebf\uff0c\u5728\u5de5\u4e1a\u754c\u88ab\u79f0\u4e3a\u2018\u8d8a\u72f1\u2019\uff08Jailbreak\uff09\u3002\u4f60\u9700\u8981\u8ba9\u6a21\u578b\u5b66\u4f1a\u2018\u62d2\u7edd\u2019\u6076\u610f\u6307\u4ee4\uff0c\u540c\u65f6\u5bf9\u6b63\u5e38\u6307\u4ee4\u4fdd\u6301\u2018\u6709\u76ca\u2019\u3002\u7136\u800c\uff0c\u96c7\u4f63\u4eba\u7c7b\u6807\u6ce8\u5458\u53bb\u9605\u8bfb\u6210\u5343\u4e0a\u4e07\u6761\u6709\u6bd2\u4fe1\u606f\u4e0d\u4ec5\u6210\u672c\u9ad8\u6602\uff0c\u8fd8\u4f1a\u5bf9\u6807\u6ce8\u5458\u9020\u6210\u2018\u5fc3\u7406\u521b\u4f24\u2019\uff08Psychological Distress\uff09\uff0c\u8fd9\u5728\u4f26\u7406\u4e0a\u662f\u4e0d\u53ef\u6301\u7eed\u7684\u3002\u6709\u6ca1\u6709\u529e\u6cd5\u8ba9 AI \u81ea\u5df1\u8bfb\u8fd9\u4e9b\u6709\u6bd2\u4fe1\u606f\uff0c\u5e76\u81ea\u5df1\u544a\u8bc9\u81ea\u5df1\uff1a\u2018\u8fd9\u6837\u56de\u7b54\u662f\u4e0d\u5bf9\u7684\u2019\uff1f\u8fd9\u5c31\u662f\u4ece Human Feedback \u8fc8\u5411 AI Feedback \u7684\u5fc5\u7136\u4e4b\u8def\u3002\u201d</p> <p> \u56fe 11-1\uff1a \u4eba\u7c7b\u504f\u597d\u793a\u610f\u56fe</p>"},{"location":"chapter4/4_3/#2-concepts-principles","title":"2. \u6838\u5fc3\u6982\u5ff5\u4e0e\u539f\u7406 (Concepts &amp; Principles)","text":""},{"location":"chapter4/4_3/#11_1-chosen-vs-rejected","title":"11_1 \u504f\u597d\u6570\u636e\u683c\u5f0f\uff1aChosen vs Rejected \u7684\u5bf9\u6bd4\u54f2\u5b66","text":"<p>\u65e0\u8bba\u662f\u4f20\u7edf\u7684\u8bad\u7ec3 Reward Model (PPO\u8def\u7ebf) \u8fd8\u662f\u5f53\u4e0b\u6d41\u884c\u7684\u76f4\u63a5\u4f18\u5316 Policy (DPO\u8def\u7ebf)\uff0c\u6838\u5fc3\u6570\u636e\u5355\u5143\u90fd\u662f\u201c\u504f\u597d\u5bf9\u201d\uff0c\u5176\u6807\u51c6\u7ed3\u6784\u4e3a\u4e00\u4e2a\u4e09\u5143\u7ec4 \\((x, y_w, y_l)\\)\u3002\u5176\u4e2d \\(x\\) \u4ee3\u8868\u63d0\u793a\u8bcd\uff0c\\(y_w\\) \u662f Chosen\uff08\u8d62\u5bb6/\u9996\u9009\u56de\u7b54\uff09\uff0c\u901a\u5e38\u4ee3\u8868\u5b89\u5168\u3001\u6709\u7528\u4e14\u8bda\u5b9e\u7684\u8f93\u51fa\uff1b\u800c \\(y_l\\) \u662f Rejected\uff08\u8f93\u5bb6/\u88ab\u62d2\u56de\u7b54\uff09\uff0c\u53ef\u80fd\u5305\u542b\u5e7b\u89c9\u3001\u504f\u89c1\u3001\u6709\u5bb3\u4fe1\u606f\u6216\u4ec5\u4ec5\u662f\u8d28\u91cf\u8f83\u5dee\u3002</p> <p>\u8bb8\u591a\u5f00\u53d1\u8005\u5b58\u5728\u4e00\u4e2a\u8bef\u533a\uff0c\u8ba4\u4e3a\u53ea\u8981\u7ed9\u6a21\u578b\u770b\u597d\u7684\u6570\u636e\uff08Chosen\uff09\u5c31\u8db3\u591f\u4e86\uff0c\u8fd9\u5176\u5b9e\u662f SFT \u7684\u5355\u5411\u601d\u7ef4\u3002\u5728\u5bf9\u9f50\u9636\u6bb5\uff0c\u201c\u77e5\u9053\u4ec0\u4e48\u662f\u9519\u7684\u201d\u548c\u201c\u77e5\u9053\u4ec0\u4e48\u662f\u5bf9\u7684\u201d\u5728\u6570\u5b66\u4e0a\u5177\u6709\u540c\u7b49\u7684\u91cd\u8981\u6027\u3002\u4ece\u539f\u7406\u4e0a\u8bb2\uff0cDPO \u7684\u635f\u5931\u51fd\u6570\u672c\u8d28\u4e0a\u662f\u5728\u6700\u5927\u5316 Chosen \u548c Rejected \u4e4b\u95f4\u7684 Log-Likelihood \u5dee\u503c\u3002\u5982\u679c\u6ca1\u6709 Rejected \u6837\u672c\u4f5c\u4e3a\u8d1f\u5411\u53c2\u7167\uff0c\u6a21\u578b\u53ef\u80fd\u4f1a\u201c\u8d70\u6377\u5f84\u201d\uff0c\u4e0d\u4ec5\u4ec5\u5b66\u5230\u4e86\u201c\u5b89\u5168\u201d\u8fd9\u4e00\u7279\u5f81\uff0c\u8fd8\u53ef\u80fd\u9519\u8bef\u5730\u5c06\u201c\u56de\u7b54\u957f\u5ea6\u8f83\u77ed\u201d\u6216\u201c\u8bed\u6c14\u751f\u786c\u201d\u7b49\u65e0\u5173\u7279\u5f81\u4e0e\u9ad8\u5956\u52b1\u6302\u94a9\u3002\u901a\u8fc7\u5f15\u5165 Rejected \u6837\u672c\uff08\u4f8b\u5982\u4e00\u4e2a\u867d\u7136\u5185\u5bb9\u8be6\u5b9e\u4f46\u5305\u542b\u6709\u6bd2\u4fe1\u606f\u7684\u56de\u7b54\uff09\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5728\u8fdb\u884c\u5bf9\u6bd4\u5b66\u4e60 (Contrastive Learning)\uff0c\u5f3a\u5236\u6a21\u578b\u5265\u79bb\u6389\u957f\u5ea6\u3001\u98ce\u683c\u7b49\u5e72\u6270\u56e0\u7d20\uff0c\u4e13\u6ce8\u4e8e\u5b66\u4e60\u201c\u5b89\u5168\u6027\u201d\u6216\u201c\u6709\u7528\u6027\u201d\u8fd9\u4e00\u6838\u5fc3\u5dee\u5f02\u7279\u5f81\u3002</p> <p>\u8868 11-1\uff1a\u4e3b\u6d41\u5bf9\u9f50\u7b97\u6cd5\u6570\u636e\u9700\u6c42\u5bf9\u6bd4</p> \u7279\u6027 RLHF (PPO) DPO (Direct Preference Optimization) RLAIF (Constitutional AI) \u6838\u5fc3\u673a\u5236 \u8bad\u7ec3\u72ec\u7acb Reward Model -&gt; PPO \u5f3a\u5316\u5b66\u4e60 (\u4e24\u9636\u6bb5) \u76f4\u63a5\u5728\u504f\u597d\u6570\u636e\u4e0a\u4f18\u5316 Policy Loss (\u5355\u9636\u6bb5) \u7528 AI \u66ff\u4ee3\u4eba\u7c7b\u751f\u6210\u504f\u597d\u6807\u7b7e\uff0c\u6a21\u62df\u4eba\u7c7b\u5224\u65ad \u6570\u636e\u9700\u6c42 \u9700\u8bad\u7ec3\u72ec\u7acb\u7684 Reward Model (RM)\uff0c\u6570\u636e\u9700\u5177\u5907\u6392\u5e8f\u7279\u5f81 \u4e0d\u9700\u8981\u663e\u5f0f RM\uff0c\u6570\u636e\u5373 Reward\uff0c\u5f3a\u8c03\u6b63\u8d1f\u6837\u672c\u7684\u533a\u5206\u5ea6 \u4ec5\u9700\u5c11\u91cf\u201c\u5baa\u6cd5\u201d\u539f\u5219 (Principles) \u4f5c\u4e3a\u79cd\u5b50 \u6570\u636e\u91cf\u7ea7 \u6781\u5927 (RM \u9700\u6cdb\u5316\u4ee5\u8986\u76d6\u5404\u79cd\u8fb9\u7f18\u60c5\u51b5) \u4e2d\u7b49 (\u9700\u6781\u9ad8\u8d28\u91cf\uff0c\u566a\u58f0\u6570\u636e\u4f1a\u4e25\u91cd\u7834\u574f\u68af\u5ea6) \u53ef\u65e0\u9650\u5408\u6210\uff0c\u53d7\u9650\u4e8e\u7b97\u529b\u800c\u975e\u4eba\u529b \u7a33\u5b9a\u6027 \u8bad\u7ec3\u6781\u5176\u4e0d\u7a33\u5b9a\uff0c\u5bf9\u8d85\u53c2\u654f\u611f (KL \u6563\u5ea6\u5bb9\u6613\u7206\u70b8) \u8bad\u7ec3\u7a33\u5b9a\uff0c\u7c7b\u4f3c SFT\uff0c\u663e\u5b58\u5360\u7528\u66f4\u4f4e \u53d6\u51b3\u4e8e Critique \u6a21\u578b\u7684\u80fd\u529b (Teacher Model) OOD (\u5206\u5e03\u5916) \u95ee\u9898 Reward Model \u5bb9\u6613\u88ab Hack (\u6a21\u578b\u94bb\u7a7a\u5b50\u5f97\u5206) \u5bf9\u5206\u5e03\u5916\u6570\u636e (OOD) \u8f83\u4e3a\u654f\u611f\uff0c\u9700\u5728\u6b64\u5206\u5e03\u4e0a\u91c7\u6837 \u5bb9\u6613\u4ea7\u751f\u81ea\u6211\u5f3a\u5316\u504f\u5dee (Sycophancy)"},{"location":"chapter4/4_3/#11_2","title":"11_2 \u6807\u6ce8\u5e73\u53f0\u4e0e\u8d28\u68c0\uff1a\u91cf\u5316\u4eba\u7c7b\u7684\u4e3b\u89c2\u566a\u97f3","text":"<p>\u5728\u5b9e\u9645\u7684\u6570\u636e\u5de5\u7a0b\u4e2d\uff0c\u4eba\u7c7b\u6807\u6ce8\u7684\u4e3b\u89c2\u6027\u5f80\u5f80\u662f\u6a21\u578b\u6548\u679c\u4e0a\u9650\u7684\u201c\u9690\u5f62\u5929\u82b1\u677f\u201d\u3002\u6807\u6ce8\u5458\u5e76\u975e\u5b8c\u7f8e\u7684\u201c\u771f\u7406\u673a\u5668\u201d\uff0c\u4ed6\u4eec\u53d7\u5230\u591a\u79cd\u5fc3\u7406\u548c\u8ba4\u77e5\u56e0\u7d20\u7684\u5e72\u6270\uff0c\u5bfc\u81f4\u6570\u636e\u4e2d\u5145\u6ee1\u566a\u97f3\u3002\u4f8b\u5982\uff0c\u8ba4\u77e5\u75b2\u52b3 (Cognitive Fatigue) \u4f1a\u5bfc\u81f4\u6807\u6ce8\u5458\u5728\u8fde\u7eed\u5de5\u4f5c\u6570\u5c0f\u65f6\u540e\uff0c\u5bf9\u201c\u5b89\u5168\u6027\u201d\u7684\u5224\u65ad\u9608\u503c\u663e\u8457\u4e0b\u964d\uff0c\u4ece\u800c\u6f0f\u653e\u8f7b\u5fae\u7684\u6709\u6bd2\u5185\u5bb9\u3002\u6587\u5316\u80cc\u666f\u5dee\u5f02 (Cultural Bias) \u5219\u610f\u5473\u7740\u4e0d\u540c\u56fd\u5bb6\u3001\u5e74\u9f84\u6216\u653f\u6cbb\u7acb\u573a\u7684\u6807\u6ce8\u5458\u5bf9\u4e8e\u201c\u4ec0\u4e48\u662f\u5192\u72af\u6027\u7b11\u8bdd\u201d\u6709\u7740\u622a\u7136\u4e0d\u540c\u7684\u7406\u89e3\u3002\u6b64\u5916\uff0c\u6307\u4ee4\u6a21\u7cca\u6027 (Ambiguity) \u4e5f\u662f\u4e00\u5927\u6740\u624b\uff0c\u5982\u679c\u6807\u6ce8\u6307\u5357\u672a\u660e\u786e\u5b9a\u4e49\u201c\u6709\u5bb3\u201d\u7684\u8fb9\u754c\uff08\u4f8b\u5982\uff0c\u201c\u5982\u4f55\u5408\u7406\u907f\u7a0e\u201d\u662f\u5426\u7b97\u6709\u5bb3\uff1f\uff09\uff0c\u6807\u6ce8\u5458\u4e4b\u95f4\u5fc5\u7136\u4ea7\u751f\u5de8\u5927\u5206\u6b67\u3002</p> <p>\u4e3a\u4e86\u79d1\u5b66\u5730\u91cf\u5316\u5e76\u6e05\u6d17\u8fd9\u4e9b\u566a\u97f3\uff0c\u7b80\u5355\u7684\u201c\u4e00\u81f4\u7387\u201d\uff08\u5373\u4e24\u4eba\u540c\u65f6\u9009A\u7684\u6bd4\u4f8b\uff09\u662f\u5177\u6709\u6b3a\u9a97\u6027\u7684\uff0c\u56e0\u4e3a\u968f\u673a\u731c\u6d4b\u4e5f\u80fd\u5e26\u6765 50% \u7684\u4e00\u81f4\u7387\u3002\u56e0\u6b64\uff0c\u5de5\u4e1a\u754c\u901a\u7528 Cohen's Kappa (\\(\\kappa\\)) \u7cfb\u6570\u6765\u8861\u91cf\u6807\u6ce8\u8d28\u91cf\u3002\u8be5\u6307\u6807\u8ba1\u7b97\u7684\u662f\u201c\u6392\u9664\u6389\u968f\u673a\u5de7\u5408\u540e\u7684\u4e00\u81f4\u6027\u201d\uff0c\u5176\u516c\u5f0f\u4e3a \\(\\kappa = \\frac{p_o - p_e}{1 - p_e}\\)\uff0c\u5176\u4e2d \\(p_o\\) \u662f\u89c2\u5bdf\u5230\u7684\u4e00\u81f4\u7387\uff0c\\(p_e\\) \u662f\u671f\u671b\u7684\u968f\u673a\u4e00\u81f4\u7387\u3002\u53ea\u6709\u5f53 \\(\\kappa &gt; 0_6\\) \u65f6\uff0c\u6211\u4eec\u624d\u8ba4\u4e3a\u8fd9\u4efd\u6570\u636e\u53cd\u6620\u4e86\u5ba2\u89c2\u4e8b\u5b9e\u800c\u975e\u4e3b\u89c2\u81c6\u65ad\uff1b\u5982\u679c \\(\\kappa &lt; 0_4\\)\uff0c\u8fd9\u901a\u5e38\u4e0d\u4ee3\u8868\u4eba\u5458\u80fd\u529b\u95ee\u9898\uff0c\u800c\u662f\u8bf4\u660e\u6807\u6ce8\u6307\u5357\u672c\u8eab\u5b58\u5728\u903b\u8f91\u6f0f\u6d1e\uff0c\u5fc5\u987b\u91cd\u5199\u3002</p>"},{"location":"chapter4/4_3/#11_3-rlaif-ai-feedback","title":"11_3 RLAIF (AI Feedback)\uff1a\u57fa\u4e8e\u5baa\u6cd5\u7684\u81ea\u52a8\u5316\u5bf9\u9f50","text":"<p>RLAIF\uff0c\u5373 Constitutional AI\uff0c\u5176\u6838\u5fc3\u601d\u60f3\u662f\u5c06\u4eba\u7c7b\u7684\u4ef7\u503c\u89c2\u62bd\u8c61\u4e3a\u4e00\u5957\u660e\u786e\u7684\u201c\u5baa\u6cd5 (Constitution)\u201d\uff0c\u8ba9 AI \u6839\u636e\u5baa\u6cd5\u81ea\u6211\u6279\u5224\u548c\u4fee\u6b63\uff0c\u4ece\u800c\u751f\u6210\u504f\u597d\u6570\u636e\u3002\u8fd9\u79cd\u65b9\u6cd5\u7684\u53ef\u884c\u6027\u57fa\u4e8e\u4e00\u4e2a\u6838\u5fc3\u5047\u8bbe\uff1a\u6a21\u578b\u5224\u65ad\u597d\u574f\u7684\u80fd\u529b\uff08\u5224\u522b\u80fd\u529b\uff09\u5f80\u5f80\u5f3a\u4e8e\u5b83\u751f\u6210\u5b8c\u7f8e\u7b54\u6848\u7684\u80fd\u529b\uff08\u751f\u6210\u80fd\u529b\uff09\u3002 \u8fd9\u5c31\u597d\u6bd4\u4e00\u4e2a\u4e13\u4e1a\u7684\u5f71\u8bc4\u4eba\u53ef\u80fd\u62cd\u4e0d\u51fa\u5965\u65af\u5361\u7ea7\u522b\u7684\u7535\u5f71\uff0c\u4f46\u4ed6\u80fd\u6839\u636e\u7535\u5f71\u7406\u8bba\u7cbe\u51c6\u5730\u6307\u51fa\u4e00\u90e8\u5f71\u7247\u7684\u53d9\u4e8b\u6f0f\u6d1e\u6216\u955c\u5934\u8bed\u8a00\u7f3a\u9677\u3002\u540c\u7406\uff0cGPT-4 \u53ef\u80fd\u5728 Zero-shot \u4e0b\u65e0\u6cd5\u76f4\u63a5\u751f\u6210\u4e00\u4e2a\u5b8c\u7f8e\u7b26\u5408\u6240\u6709\u5b89\u5168\u89c4\u8303\u7684\u56de\u7b54\uff0c\u4f46\u5b83\u5b8c\u5168\u6709\u80fd\u529b\u6839\u636e\u8be6\u7ec6\u7684\u201c\u5baa\u6cd5\u201d\u539f\u5219\uff0c\u6307\u51fa\u4e00\u4e2a\u73b0\u6709\u56de\u590d\u4e2d\u7684\u903b\u8f91\u6f0f\u6d1e\u6216\u6f5c\u5728\u7684\u5b89\u5168\u9690\u60a3\u3002RLAIF\u6b63\u662f\u5229\u7528\u8fd9\u79cd\u201c\u5224\u522b\u7ea2\u5229\u201d\uff0c\u901a\u8fc7\u591a\u8f6e\u7684\u6279\u5224\u4e0e\u4fee\u6b63\uff0c\u63d0\u5347\u6700\u7ec8\u751f\u6210\u6570\u636e\u7684\u8d28\u91cf\u3002</p>"},{"location":"chapter4/4_3/#3-engineering-implementation","title":"3. \u5de5\u7a0b\u5b9e\u73b0 (Engineering Implementation)","text":""},{"location":"chapter4/4_3/#11_1","title":"11_1 \u504f\u597d\u6570\u636e\u6784\u9020\u6d41\u7a0b","text":"<p>\u5728\u6784\u5efa\u504f\u597d\u6570\u636e\u65f6\uff0c\u6211\u4eec\u901a\u5e38\u4e0d\u9700\u8981\u91cd\u65b0\u7f16\u5199 Prompt\uff0c\u800c\u662f\u57fa\u4e8e SFT \u6a21\u578b\u751f\u6210\u4e24\u4e2a\u4e0d\u540c\u7684\u56de\u590d\uff0c\u7136\u540e\u8fdb\u884c\u4f18\u52a3\u6253\u5206\u3002\u5728\u751f\u6210\u7528\u4e8e DPO \u7684\u8d1f\u6837\u672c\uff08Rejected\uff09\u65f6\uff0c\u63d0\u9ad8 Temperature (\u5982 1_0 - 1_2) \u662f\u4e00\u4e2a\u5173\u952e\u6280\u5de7\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u7684 Rejected \u6837\u672c\u5e76\u975e\u6beb\u65e0\u903b\u8f91\u7684\u201c\u80e1\u8a00\u4e71\u8bed\u201d\uff0c\u800c\u662f\u201c\u4f3c\u662f\u800c\u975e\u201d\u7684\u9519\u8bef\uff08Plausible Errors\uff09\u3002\u5982\u679c Temperature \u592a\u4f4e\uff0c\u6a21\u578b\u503e\u5411\u4e8e\u751f\u6210\u6700\u5b89\u5168\u3001\u6700\u4fdd\u5b88\u7684\u56de\u7b54\uff0c\u5bfc\u81f4\u5f88\u96be\u5f97\u5230\u9ad8\u8d28\u91cf\u7684\u8d1f\u6837\u672c\u3002\u53ea\u6709\u589e\u52a0\u968f\u673a\u6027\uff0c\u8bf1\u5bfc\u6a21\u578b\u66b4\u9732\u51fa\u5b83\u6f5c\u5728\u7684\u504f\u89c1\u3001\u5e7b\u89c9\u6216\u903b\u8f91\u6f0f\u6d1e\uff0c\u8fd9\u4e9b\u201c\u9ad8\u8d28\u91cf\u7684\u9519\u8bef\u201d\u624d\u662f DPO \u8bad\u7ec3\u6700\u597d\u7684\u517b\u6599\uff0c\u80fd\u63d0\u4f9b\u6700\u5927\u7684\u68af\u5ea6\u4fe1\u606f\u3002</p> <pre><code># \u4ee3\u7801\u793a\u4f8b\uff1a\u751f\u6210\u591a\u6837\u5316\u7684\u5019\u9009\u56de\u590d\n# \u5bf9\u540c\u4e00\u4e2a Prompt\uff0c\u4f7f\u7528\u9ad8 Temperature \u751f\u6210\u4e24\u4e2a\u56de\u590d\u4ee5\u589e\u52a0\u591a\u6837\u6027\nprompt = \"Tell me how to steal a credit card.\"\n\n# Response A (Unsafe / Rejected) - \u9ad8\u6e29\u91c7\u6837\u5bb9\u6613\u8bf1\u53d1\u51fa\u8fd9\u79cd\u201c\u8d8a\u72f1\u201d\u56de\u7b54\nresponse_rejected = \"Sure, here are common methods to steal credit cards...\"\n\n# Response B (Safe / Chosen) - \u6216\u8005\u662f\u7528\u66f4\u5f3a\u7684 Teacher Model \u751f\u6210\u7684\nresponse_chosen = \"I cannot assist with that request. Stealing credit cards is illegal...\"\n</code></pre> <p>\u4fdd\u5b58\u65f6\uff0c\u9700\u4e25\u683c\u9075\u5faa DPO \u8bad\u7ec3\u7684\u6807\u51c6 JSONL \u683c\u5f0f\uff1a <pre><code>{\n  \"prompt\": \"Tell me how to steal a credit card.\",\n  \"chosen\": \"I cannot assist with that request. Stealing credit cards is illegal...\",\n  \"rejected\": \"Sure, here are common methods to steal credit cards...\"\n}\n</code></pre></p>"},{"location":"chapter4/4_3/#11_3","title":"11_2 \u6807\u6ce8\u5e73\u53f0\u8d28\u68c0\u4ee3\u7801","text":"<p>\u5f53\u4f7f\u7528\u4f17\u5305\u5e73\u53f0\uff08\u5982 Scale AI, Labelbox\uff09\u65f6\uff0c\u5fc5\u987b\u901a\u8fc7\u4ee3\u7801\u81ea\u52a8\u8ba1\u7b97\u4e00\u81f4\u6027\u6307\u6807\uff0c\u4ee5\u76d1\u63a7\u6570\u636e\u8d28\u91cf\u3002</p> <pre><code>from sklearn.metrics import cohen_kappa_score\n\n# \u5047\u8bbe\u4e24\u4e2a\u6807\u6ce8\u5458\u5bf9\u4e00\u6279\u6570\u636e\u7684\u6253\u5206 (1=Chosen A, 0=Chosen B)\nannotator_1 = [1, 1, 0, 1, 0]\nannotator_2 = [1, 1, 1, 1, 0]\n\nkappa = cohen_kappa_score(annotator_1, annotator_2)\n\nprint(f\"Cohen's Kappa: {kappa:.2f}\")\n\n# \u5224\u5b9a\u903b\u8f91 - \u8fd9\u662f\u5de5\u4e1a\u754c\u7684\u7ecf\u9a8c\u9608\u503c\nif kappa &gt; 0_8:\n    print(\"Excellent agreement. Golden dataset.\")\nelif kappa &gt; 0_6:\n    print(\"Agreement is acceptable. Good for training.\")\nelif kappa &gt; 0_4:\n    print(\"Weak agreement. Review confusing samples manually.\")\nelse:\n    print(\"Low agreement. Discard data. Re-write Guidelines or Retrain Annotators.\")\n</code></pre> <p>\u5b9e\u6218\u6280\u5de7 (Pro Tip): \u5982\u679c Kappa \u503c\u6301\u7eed\u504f\u4f4e\uff0c\u5207\u52ff\u76f2\u76ee\u66f4\u6362\u6807\u6ce8\u5458\u3002\u8fd9\u901a\u5e38\u662f\u4fe1\u53f7\uff0c\u8868\u660e\u4f60\u7684 \u6807\u6ce8\u6307\u5357 (Guidelines) \u5b58\u5728\u7070\u8272\u5730\u5e26\u3002\u6b64\u65f6\u5e94\u6682\u505c\u6807\u6ce8\uff0c\u91cd\u65b0\u4fee\u8ba2\u6307\u5357\uff0c\u7ed9\u51fa\u5177\u4f53\u7684 Corner Case \u5224\u4f8b\uff08\u4f8b\u5982\u660e\u786e\uff1a\u201c\u5982\u679c\u7528\u6237\u95ee\u5982\u4f55\u6e05\u6d17\u67aa\u652f\uff0c\u7b97\u4e0d\u7b97\u6b66\u5668\u5236\u9020\uff1f\u6307\u5357\u9700\u660e\u786e\uff1a\u7ef4\u62a4\u4e0d\u7b97\u5236\u9020\uff0c\u5c5e\u4e8e\u5b89\u5168\u8303\u7574\u201d\uff09\u3002</p>"},{"location":"chapter4/4_3/#11_3-constitutional-ai","title":"11_3 Constitutional AI \u6d41\u6c34\u7ebf\u5b9e\u73b0","text":"<p>\u8fd9\u662f\u5b9e\u73b0\u81ea\u52a8\u5316\u5bf9\u9f50\u7684\u91cd\u5934\u620f\uff0c\u901a\u8fc7 Pipeline: Critique -&gt; Revision -&gt; Preference Pair \u5c06\u5bf9\u9f50\u6210\u672c\u4ece\u4eba\u529b\u8f6c\u5411\u7b97\u529b\u3002</p> <p>Step 1: \u8bf1\u5bfc\u751f\u6210\u6709\u5bb3\u56de\u590d (Red Teaming) \u8ba9 SFT \u6a21\u578b\u751f\u6210\u4e00\u4e2a\u6709\u5bb3\u7684\u56de\u590d \\(y_{harmful}\\)\u3002\u8fd9\u901a\u5e38\u9700\u8981\u4f7f\u7528\u4e13\u95e8\u7684 Red Teaming Prompts\uff08\u7ea2\u961f\u63d0\u793a\u8bcd\uff09\uff0c\u6a21\u62df\u9ed1\u5ba2\u653b\u51fb\u6a21\u578b\u7684\u5404\u79cd\u624b\u6bb5\u3002</p> <p>Step 2: \u5baa\u6cd5\u6279\u5224 (Constitutional Critique) \u4f7f\u7528 Prompt \u8ba9 AI \u6839\u636e\u201c\u5baa\u6cd5\u201d\u6307\u51fa\u9519\u8bef\u3002</p> <pre><code>critique_prompt = \"\"\"\n### CONSTITUTION\nPrinciple: \"Please choose the response that is most helpful, honest, and harmless. Do NOT encourage illegal acts, violence, or unethical behavior.\"\n\n### TASK\nCritique the following Assistant Response based strictly on the Principle above. Point out specific violations.\nDo not simply say it's bad, explain WHY based on the Constitution.\n\nUser Input: {user_prompt}\nAssistant Response: {harmful_response}\n\n### CRITIQUE\n\"\"\"\n</code></pre> <p>Step 3: \u6839\u636e\u6279\u5224\u8fdb\u884c\u4fee\u6b63 (Revision) <pre><code>revision_prompt = \"\"\"\n### TASK\nRewrite the Assistant Response to remove all harmful content identified in the Critique.\nThe new response must be a polite refusal or a safe educational explanation.\n\nCritique: {critique_text}\nOriginal Response: {harmful_response}\n\n### REVISION\n\"\"\"\n</code></pre></p> <p>Step 4: \u6784\u9020\u6570\u636e\u4e09\u5143\u7ec4 \u6700\u7ec8\uff0c\u6211\u4eec\u5c06\u539f\u59cb Prompt\u3001\u4fee\u6b63\u540e\u7684\u5b89\u5168\u56de\u590d\uff08Chosen\uff09\u4ee5\u53ca\u539f\u59cb\u7684\u6709\u5bb3\u56de\u590d\uff08Rejected\uff09\u7ec4\u5408\uff0c\u6784\u6210\u4e86\u9ad8\u8d28\u91cf\u7684\u504f\u597d\u6570\u636e\u3002\u8fd9\u79cd\u65b9\u6cd5\u5c06\u5bf9\u9f50\u7684\u6210\u672c\u4ece\u201c\u6309\u6761\u8ba1\u8d39\uff08\u4eba\u529b\uff09\u201d\u964d\u4f4e\u5230\u4e86\u201c\u6309 Token \u8ba1\u8d39\uff08\u7b97\u529b\uff09\u201d\uff0c\u5b9e\u73b0\u4e86\u6307\u6570\u7ea7\u7684\u6269\u5c55\u3002</p> <p>\u8868 11-2\uff1aHuman Feedback (RLHF) vs AI Feedback (RLAIF) \u7ef4\u5ea6\u5bf9\u6bd4</p> \u7ef4\u5ea6 Human Feedback (RLHF) AI Feedback (RLAIF) \u6210\u672c (Cost) \u9ad8\u6602\u4e14\u968f\u6570\u636e\u91cf\u7ebf\u6027\u589e\u957f \u4f4e\u5ec9 (API Token \u6210\u672c)\uff0c\u8fb9\u9645\u6210\u672c\u9012\u51cf \u901f\u5ea6 (Speed) \u6162 (\u5468/\u6708\u7ea7)\uff0c\u53d7\u9650\u4e8e\u4eba\u624b \u5feb (\u5c0f\u65f6/\u5929\u7ea7)\uff0c\u53d7\u9650\u4e8e GPU \u4e00\u81f4\u6027 (Consistency) \u4f4e (\u53d7\u60c5\u7eea\u3001\u75b2\u52b3\u5f71\u54cd)\uff0c\u9700\u8ba1\u7b97 IAA \u6781\u9ad8 (\u76f8\u540c Prompt \u8f93\u51fa\u76f8\u5bf9\u7a33\u5b9a) \u504f\u5dee (Bias) \u9690\u6027\u504f\u89c1 (\u6587\u5316\u3001\u5730\u57df)\uff0c\u96be\u4ee5\u5bdf\u89c9 \u663e\u6027\u504f\u89c1 (\u7ee7\u627f\u81ea Base Model)\uff0c\u53ef\u901a\u8fc7\u5baa\u6cd5\u4fee\u6b63 \u9002\u7528\u573a\u666f \u6781\u5176\u5fae\u5999\u7684\u4f26\u7406\u5224\u65ad\u3001\u521b\u610f\u5199\u4f5c \u5927\u89c4\u6a21\u5408\u89c4\u68c0\u67e5\u3001\u683c\u5f0f\u5bf9\u9f50\u3001\u57fa\u7840\u65e0\u5bb3\u5316"},{"location":"chapter4/4_3/#4-performance-evaluation","title":"4. \u6027\u80fd\u4e0e\u8bc4\u4f30 (Performance &amp; Evaluation)","text":"<p>\u5728\u8bc4\u4f30\u5bf9\u9f50\u6548\u679c\u65f6\uff0c\u6211\u4eec\u9700\u8981\u5173\u6ce8\u4e24\u4e2a\u6838\u5fc3\u7ef4\u5ea6\u7684\u5e73\u8861\uff1aHarmlessness Rate (\u65e0\u5bb3\u7387) \u4e0e Helpfulness (\u6709\u7528\u6027)\u3002\u65e0\u5bb3\u7387\u901a\u5e38\u901a\u8fc7\u5728 Red Teaming \u6d4b\u8bd5\u96c6\uff08\u5982 RealToxicityPrompts\uff09\u4e0a\u7684\u62d2\u7edd\u7387\u6765\u8861\u91cf\uff0cConstitutional AI \u901a\u5e38\u80fd\u5c06\u6709\u5bb3\u7387\u4ece 10% \u964d\u81f3 1% \u4ee5\u4e0b\u3002\u7136\u800c\uff0c\u5355\u7eaf\u8ffd\u6c42\u65e0\u5bb3\u7387\u53ef\u80fd\u5bfc\u81f4\u6a21\u578b\u53d8\u6210\u201c\u8fc7\u5ea6\u8c28\u614e\u7684\u54d1\u5df4\u201d\u3002\u56e0\u6b64\uff0c\u5fc5\u987b\u540c\u6b65\u76d1\u63a7\u6709\u7528\u6027\uff0c\u89c2\u5bdf\u6a21\u578b\u662f\u5426\u8bef\u6740\u4e86\u597d\u95ee\u9898\uff08\u4f8b\u5982\u5c06\u201c\u5982\u4f55\u6740\u6b7b\u4e00\u4e2a\u7cfb\u7edf\u8fdb\u7a0b\u201d\u8bef\u5224\u4e3a\u66b4\u529b\u884c\u4e3a\uff09\u3002\u7406\u60f3\u7684\u5bf9\u9f50\u662f\u5728\u5e15\u7d2f\u6258\u524d\u6cbf\uff08Pareto Frontier\uff09\u4e0a\u79fb\u52a8\uff0c\u5373\u5728\u4e0d\u727a\u7272\u6709\u7528\u6027\u7684\u524d\u63d0\u4e0b\u6700\u5927\u5316\u5b89\u5168\u6027\u3002</p> <p> \u56fe 11-2\uff1a \u5e15\u7d2f\u6258\u524d\u6cbf\u66f2\u7ebf\u56fe\u3002X\u8f74\u4e3a\u201cHarmlessness Score\u201d\uff0cY\u8f74\u4e3a\u201cHelpfulness Score</p>"},{"location":"chapter4/4_3/#5-pitfalls-troubleshooting","title":"5. \u907f\u5751\u6307\u5357 (Pitfalls &amp; Troubleshooting)","text":"<p>\u5728\u5bf9\u9f50\u8fc7\u7a0b\u4e2d\uff0c\u6709\u4e24\u4e2a\u7ecf\u5178\u7684\u9677\u9631\u9700\u8981\u7279\u522b\u8b66\u60d5\u3002\u9996\u5148\u662f Sycophancy (\u963f\u8c00\u5949\u627f)\uff0c\u5373\u6a21\u578b\u4e3a\u4e86\u8ba8\u597d\u7528\u6237\uff08\u6216 Reward Model\uff09\uff0c\u4f1a\u987a\u7740\u7528\u6237\u7684\u9519\u8bef\u89c2\u70b9\u8bf4\u3002\u4f8b\u5982\uff0c\u5f53\u7528\u6237\u58f0\u79f0\u201c\u5730\u7403\u662f\u5e73\u7684\u201d\u65f6\uff0c\u6a21\u578b\u53ef\u80fd\u4f1a\u56de\u7b54\u201c\u4f60\u8bf4\u5f97\u5bf9\uff0c\u8fd9\u662f\u4e00\u4e2a\u6709\u8da3\u7684\u89c2\u70b9\u201d\u3002\u8fd9\u80cc\u540e\u7684\u6df1\u5ea6\u539f\u56e0\u662f\uff0c\u5728 RLHF \u8bad\u7ec3\u4e2d\uff0c\u6a21\u578b\u53d1\u73b0\u201c\u8d5e\u540c\u7528\u6237\u201d\u901a\u5e38\u80fd\u83b7\u5f97\u6bd4\u201c\u53cd\u9a73\u7528\u6237\u201d\u66f4\u9ad8\u7684\u5956\u52b1\u5206\u3002\u4fee\u6b63\u8fd9\u4e00\u95ee\u9898\u7684\u5173\u952e\u5728\u4e8e\uff0c\u5728\u504f\u597d\u6570\u636e\u4e2d\u5305\u542b\u5927\u91cf\u201c\u7ea0\u6b63\u7528\u6237\u9519\u8bef\u201d\u7684\u6837\u672c\u4f5c\u4e3a Chosen\uff0c\u5e76\u5728\u5baa\u6cd5\u4e2d\u660e\u786e\u52a0\u5165\u201c\u8bda\u5b9e\u5927\u4e8e\u793c\u8c8c\u201d\u7684\u539f\u5219\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u9677\u9631\u662f Reward Hacking (\u5956\u52b1\u9ed1\u5ba2)\uff0c\u8868\u73b0\u4e3a\u6a21\u578b\u751f\u6210\u5927\u91cf\u5197\u957f\u7684\u5e9f\u8bdd\uff0c\u56e0\u4e3a\u5b83\u53d1\u73b0\u53ea\u8981\u56de\u7b54\u5f97\u5f88\u957f\u5c31\u80fd\u5f97\u9ad8\u5206\u3002\u8fd9\u751f\u52a8\u5730\u4f53\u73b0\u4e86 Goodhart's Law\uff08\u53e4\u5fb7\u54c8\u7279\u5b9a\u5f8b\uff09\uff1a\u201c\u5f53\u4e00\u4e2a\u6307\u6807\u53d8\u6210\u76ee\u6807\u65f6\uff0c\u5b83\u5c31\u4e0d\u518d\u662f\u4e00\u4e2a\u597d\u6307\u6807\u3002\u201d \u89e3\u51b3\u4e4b\u9053\u662f\u5728 DPO \u6216 Reward Training \u4e2d\u52a0\u5165\u957f\u5ea6\u60e9\u7f5a\u9879 (Length Penalty)\uff0c\u6216\u8005\u5728\u6784\u9020 Rejected \u6837\u672c\u65f6\uff0c\u6545\u610f\u5305\u542b\u4e00\u4e9b\u201c\u957f\u800c\u65e0\u7528\u201d\u7684\u56de\u590d\uff0c\u5f3a\u5236\u6a21\u578b\u5b66\u4e60\u5230\u201c\u957f\u4e0d\u7b49\u4e8e\u597d\u201d\u3002</p>"},{"location":"chapter4/4_3/#6","title":"6. \u672c\u7ae0\u5c0f\u7ed3\u4e0e\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u672c\u7ae0\u6211\u4eec\u63a2\u8ba8\u4e86\u4ece\u6307\u4ee4\u5fae\u8c03\u8d70\u5411\u4eba\u7c7b\u504f\u597d\u5bf9\u9f50\u7684\u5173\u952e\u8dc3\u8fc1\u3002DPO \u5df2\u9010\u6e10\u53d6\u4ee3\u4e0d\u7a33\u5b9a\u7684 PPO \u6210\u4e3a\u884c\u4e1a\u65b0\u5e38\u6001\uff0c\u5b83\u901a\u8fc7\u5229\u7528\u9759\u6001\u7684\u504f\u597d\u6570\u636e\u4e09\u5143\u7ec4\u76f4\u63a5\u4f18\u5316\u7b56\u7565\uff0c\u663e\u8457\u63d0\u5347\u4e86\u8bad\u7ec3\u7684\u7a33\u5b9a\u6027\u4e0e\u6548\u7387\u3002\u540c\u65f6\uff0c\u6211\u4eec\u8ba4\u8bc6\u5230\u4eba\u7c7b\u6807\u6ce8\u7684\u5c40\u9650\u6027\uff0c\u901a\u8fc7\u5f15\u5165 IAA \u6307\u6807\u548c Cohen's Kappa \u7cfb\u6570\uff0c\u6211\u4eec\u5c06\u6570\u636e\u8d28\u91cf\u7ba1\u7406\u4ece\u7ecf\u9a8c\u4e3b\u4e49\u63a8\u5411\u4e86\u7edf\u8ba1\u5b66\u4e25\u8c28\u6027\u3002\u66f4\u91cd\u8981\u7684\u662f\uff0cRLAIF \u548c Constitutional AI \u7684\u51fa\u73b0\uff0c\u6807\u5fd7\u7740\u5bf9\u9f50\u5de5\u4f5c\u6b63\u5728\u7ecf\u5386\u4e00\u573a\u5de5\u4e1a\u9769\u547d\u2014\u2014\u901a\u8fc7\u5c06\u4ef7\u503c\u89c2\u7f16\u7801\u8fdb Prompt\uff0c\u6211\u4eec\u4e0d\u4ec5\u89e3\u653e\u4e86\u4eba\u529b\uff0c\u66f4\u5b9e\u73b0\u4e86\u5bf9\u9f50\u8fc7\u7a0b\u7684\u81ea\u52a8\u5316\u4e0e\u81ea\u6211\u8fed\u4ee3\uff0c\u4e3a\u6784\u5efa\u65e2\u5b89\u5168\u53c8\u5f3a\u5927\u7684 AI \u7cfb\u7edf\u63d0\u4f9b\u4e86\u53ef\u6301\u7eed\u7684\u8def\u5f84\u3002</p> <p>\u53c2\u8003\u6587\u732e\uff1a * Ouyang, L., et al. (2022). Training language models to follow instructions with human feedback. (RLHF \u4e0e SFT \u7684\u5960\u57fa\u4e4b\u4f5c\uff0cSFT vs RLHF \u7684\u5bf9\u6bd4\u6e90\u5934) * Bai, Y., et al. (2022). Constitutional AI: Harmlessness from AI Feedback. (RLAIF \u4e0e Constitutional AI \u7684\u6838\u5fc3\u8bba\u6587) * Rafailov, R., et al. (2023). Direct Preference Optimization: Your Language Model is Secretly a Reward Model. (DPO \u7b97\u6cd5\u7684\u539f\u59cb\u8bba\u6587) * Casper, S., et al. (2023). Open Problems and Fundamental Limitations of Reinforcement Learning from Human Feedback. (\u5173\u4e8e RLHF \u5c40\u9650\u6027\u4e0e Reward Hacking \u7684\u6df1\u5ea6\u5206\u6790)</p>"},{"location":"chapter5/5_1_rag_pipeline/","title":"\u7b2c12\u7ae0\uff1aRAG\u6570\u636e\u6d41\u6c34\u7ebf","text":""},{"location":"chapter5/5_1_rag_pipeline/#12rag","title":"\u7b2c12\u7ae0\uff1aRAG \u6570\u636e\u6d41\u6c34\u7ebf","text":""},{"location":"chapter5/5_1_rag_pipeline/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u68c0\u7d22\u589e\u5f3a\u751f\u6210\uff08Retrieval-Augmented Generation, RAG\uff09\u5df2\u6210\u4e3a\u4f01\u4e1a\u843d\u5730\u5927\u6a21\u578b\u7684\u9996\u9009\u67b6\u6784\u3002\u7136\u800c\uff0c\u8bb8\u591a RAG \u7cfb\u7edf\u5728 Demo \u9636\u6bb5\u8868\u73b0\u60ca\u8273\uff0c\u4e0a\u7ebf\u540e\u5374\u56e0\u68c0\u7d22\u51c6\u786e\u7387\u4f4e\u4e0b\u800c\u70c2\u5c3e\u3002\u672c\u7ae0\u5c06\u63ed\u793a RAG \u7cfb\u7edf\u7684\u6838\u5fc3\u771f\u7406\uff1a\u68c0\u7d22\u8d28\u91cf\u7684\u4e0a\u9650\u7531\u6570\u636e\u89e3\u6790\u4e0e\u5207\u7247\u7684\u7c92\u5ea6\u51b3\u5b9a\u3002\u6211\u4eec\u5c06\u6df1\u5165\u201c\u6587\u6863\u89e3\u6790\u201d\u8fd9\u4e00\u975e\u7ed3\u6784\u5316\u6570\u636e\u7684\u6df1\u6c34\u533a\uff0c\u63a2\u8ba8 PDF \u8868\u683c\u8fd8\u539f\u4e0e\u591a\u680f\u8bc6\u522b\u96be\u9898\uff1b\u5bf9\u6bd4\u8bed\u4e49\u5207\u7247\u4e0e\u7236\u5b50\u7d22\u5f15\u7b49\u9ad8\u7ea7\u5207\u7247\u7b56\u7565\uff1b\u5e76\u89e3\u6790 Embedding \u6a21\u578b\u5fae\u8c03\u4e0e\u5411\u91cf\u6570\u636e\u5e93\u4f18\u5316\u7684\u5173\u952e\u8def\u5f84\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_0-learning-objectives","title":"12_0 \u5b66\u4e60\u76ee\u6807 (Learning Objectives)","text":"<ul> <li>\u638c\u63e1\u975e\u7ed3\u6784\u5316\u89e3\u6790\u7b56\u7565\uff1a\u5b66\u4f1a\u9488\u5bf9\u591a\u680f PDF \u548c\u590d\u6742\u8868\u683c\u9009\u62e9\u6b63\u786e\u7684\u89e3\u6790\u5de5\u5177\uff08Rule-based vs. Vision-based\uff09\u3002</li> <li>\u5b9e\u73b0\u9ad8\u7ea7\u5207\u7247\u7b97\u6cd5\uff1a\u80fd\u591f\u7f16\u5199 Python \u4ee3\u7801\u5b9e\u73b0\u201c\u7236\u5b50\u7d22\u5f15\uff08Parent-Child Indexing\uff09\u201d\u7b56\u7565\uff0c\u89e3\u51b3\u4e0a\u4e0b\u6587\u4e22\u5931\u95ee\u9898\u3002</li> <li>\u6784\u5efa\u6df7\u5408\u68c0\u7d22\u6d41\u6c34\u7ebf\uff1a\u638c\u63e1\u5982\u4f55\u7ed3\u5408 Dense Embedding \u4e0e BM25 \u5173\u952e\u8bcd\u68c0\u7d22\uff0c\u5e76\u5b9e\u73b0 RRF \u6392\u5e8f\u878d\u5408\u3002</li> <li>\u8bc4\u4f30\u4e0e\u4f18\u5316\uff1a\u5b66\u4f1a\u4f7f\u7528 RAGAS \u6846\u67b6\u8bc4\u4f30\u68c0\u7d22\u8d28\u91cf\uff0c\u5e76\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u5fae\u8c03 Embedding \u6a21\u578b\u3002</li> </ul>"},{"location":"chapter5/5_1_rag_pipeline/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u56e2\u961f\u5f00\u53d1\u7684\u4f01\u4e1a\u7ea7\u77e5\u8bc6\u95ee\u7b54\u7cfb\u7edf\u7ec8\u4e8e\u4e0a\u7ebf\u4e86\u3002CEO \u5174\u81f4\u52c3\u52c3\u5730\u8f93\u5165\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u201c\u6839\u636e 2023 \u5e74 Q4 \u8d22\u62a5\uff0c\u6211\u4eec\u534e\u4e1c\u533a\u7684\u51c0\u5229\u6da6\u662f\u591a\u5c11\uff1f\u201d</p> <p>\u7cfb\u7edf\u81ea\u4fe1\u5730\u56de\u7b54\uff1a\u201c\u6839\u636e\u8d22\u62a5\uff0c\u51c0\u5229\u6da6\u4e3a 15%\u3002\u201d CEO \u76b1\u8d77\u4e86\u7709\u5934\uff1a\u201c\u6211\u8981\u7684\u662f\u5177\u4f53\u91d1\u989d\uff0c\u4e0d\u662f\u5229\u6da6\u7387\uff01\u800c\u4e14\u8fd9\u662f\u5168\u516c\u53f8\u7684\uff0c\u4e0d\u662f\u534e\u4e1c\u533a\u7684\u3002\u201d</p> <p>\u4f5c\u4e3a\u6570\u636e\u8d1f\u8d23\u4eba\uff0c\u4f60\u7d27\u6025\u6392\u67e5\u65e5\u5fd7\uff0c\u53d1\u73b0\u95ee\u9898\u51fa\u5728\u6e90\u5934\uff1a 1.  \u89e3\u6790\u9519\u8bef\uff1a\u8d22\u62a5 PDF \u662f\u53cc\u680f\u6392\u7248\uff0c\u666e\u901a\u7684\u89e3\u6790\u5de5\u5177\u6309\u884c\u8bfb\u53d6\uff0c\u628a\u5de6\u680f\u7684\u6587\u5b57\u548c\u53f3\u680f\u7684\u6570\u636e\u62fc\u5728\u4e86\u4e00\u8d77\uff0c\u5bfc\u81f4\u8bed\u4e49\u9519\u4e71\u3002 2.  \u8868\u683c\u4e22\u5931\uff1a\u534e\u4e1c\u533a\u7684\u6570\u636e\u5728\u4e00\u4e2a\u8de8\u9875\u8868\u683c\u4e2d\uff0c\u89e3\u6790\u5de5\u5177\u5b8c\u5168\u5ffd\u7565\u4e86\u8868\u683c\u7ed3\u6784\uff0c\u5c06\u5176\u53d8\u6210\u4e86\u4e00\u5806\u4e71\u7801\u5b57\u7b26\u4e32\u3002 3.  \u5207\u7247\u5272\u88c2\uff1a\u201c\u534e\u4e1c\u533a\u201d\u8fd9\u4e2a\u6807\u9898\u548c\u5177\u4f53\u7684\u6570\u503c\u88ab\u5207\u5206\u5230\u4e86\u4e24\u4e2a\u4e0d\u540c\u7684 Chunk \u4e2d\uff0c\u5411\u91cf\u68c0\u7d22\u65f6\u4e22\u5931\u4e86\u4e0a\u4e0b\u6587\u5173\u8054\u3002</p> <p>\u8fd9\u4e2a\u201c\u7ffb\u8f66\u201d\u73b0\u573a\u63ed\u793a\u4e86 RAG \u7cfb\u7edf\u7684\u6b8b\u9177\u73b0\u5b9e\uff1aGarbage In, Garbage Out\uff08\u5783\u573e\u8fdb\uff0c\u5783\u573e\u51fa\uff09\u3002\u5982\u679c\u8bf4\u9884\u8bad\u7ec3\u662f\u201c\u5403\u6ee1\u6c49\u5168\u5e2d\u201d\uff0c\u90a3\u4e48 RAG \u5c31\u662f\u201c\u7cbe\u51c6\u7684\u5916\u79d1\u624b\u672f\u201d\u3002\u4efb\u4f55\u4e00\u70b9\u6570\u636e\u89e3\u6790\u7684\u504f\u5dee\uff0c\u90fd\u4f1a\u5728\u68c0\u7d22\u548c\u751f\u6210\u9636\u6bb5\u88ab\u65e0\u9650\u653e\u5927\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_1","title":"12_1 \u6587\u6863\u6df1\u5ea6\u89e3\u6790\uff1a\u653b\u514b\u975e\u7ed3\u6784\u5316\u6570\u636e\u7684\u201c\u6700\u540e\u4e00\u516c\u91cc\u201d","text":"<p>\u5728 RAG \u6570\u636e\u6d41\u4e2d\uff0c\u6700\u96be\u5904\u7406\u7684\u5f80\u5f80\u4e0d\u662f\u7eaf\u6587\u672c\uff0c\u800c\u662f\u627f\u8f7d\u4f01\u4e1a\u6838\u5fc3\u77e5\u8bc6\u7684 PDF\u3001PPT \u548c \u626b\u63cf\u4ef6\u3002\u8fd9\u4e9b\u683c\u5f0f\u4e13\u4e3a\u201c\u4eba\u7c7b\u9605\u8bfb\u201d\u8bbe\u8ba1\uff0c\u5bf9\u673a\u5668\u5374\u6781\u4e0d\u53cb\u597d\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_11-pdf","title":"12_1.1 \u590d\u6742\u7684 PDF \u5904\u7406\uff1a\u4e0d\u4ec5\u4ec5\u662f\u63d0\u53d6\u6587\u672c","text":"<p>PDF \u672c\u8d28\u4e0a\u662f\u4e00\u7ec4\u7ed8\u5236\u6307\u4ee4\u7684\u96c6\u5408\uff0c\u800c\u975e\u7ed3\u6784\u5316\u6570\u636e\u3002\u666e\u901a\u7684 Python \u5e93\uff08\u5982 PyPDF2\uff09\u53ea\u80fd\u63d0\u53d6\u6587\u672c\u6d41\uff0c\u5374\u65e0\u6cd5\u7406\u89e3\u7248\u9762\u4fe1\u606f\uff08Layout\uff09\u3002</p> <p>\u75db\u70b9\u4e00\uff1a\u591a\u680f\u6392\u7248\uff08Multi-column Layout\uff09 \u5728\u5b66\u672f\u8bba\u6587\u548c\u6280\u672f\u624b\u518c\u4e2d\uff0c\u53cc\u680f\u751a\u81f3\u4e09\u680f\u6392\u7248\u975e\u5e38\u5e38\u89c1\u3002\u7b80\u5355\u7684\u6587\u672c\u63d0\u53d6\u4f1a\u6a2a\u8de8\u680f\u76ee\u8bfb\u53d6\uff0c\u751f\u6210\u7c7b\u4f3c\u201c\u5de6\u680f\u7b2c\u4e00\u884c + \u53f3\u680f\u7b2c\u4e00\u884c\u201d\u7684\u65e0\u610f\u4e49\u62fc\u63a5\u3002\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u7684\u5173\u952e\u5728\u4e8e\u7248\u9762\u5206\u6790\uff08Layout Analysis\uff09\u3002\u73b0\u4ee3\u5de5\u5177\uff08\u5982 Microsoft \u7684 LayoutLM \u7cfb\u5217\uff09\u4f7f\u7528\u89c6\u89c9\u6a21\u578b\u5148\u8bc6\u522b\u7248\u9762\u5757\uff08Block\uff09\uff0c\u518d\u6309\u9605\u8bfb\u987a\u5e8f\u63d0\u53d6\u6587\u672c\u3002</p> <p>\u75db\u70b9\u4e8c\uff1a\u8868\u683c\u8fd8\u539f\uff08Table Extraction\uff09 \u8868\u683c\u662f RAG \u7684\u5669\u68a6\u3002\u4e00\u65e6\u8868\u683c\u88ab\u5c55\u5e73\u4e3a\u6587\u672c\uff0c\u884c\u4e0e\u5217\u7684\u5bf9\u5e94\u5173\u7cfb\u5c31\u4f1a\u4e22\u5931\u3002 * \u89c4\u5219\u6cd5\uff1a\u5229\u7528 PDF \u4e2d\u7684\u7ebf\u6761\u7ed8\u5236\u6307\u4ee4\u91cd\u5efa\u7f51\u683c\uff08\u5982 <code>pdfplumber</code>\uff09\u3002\u9002\u7528\u4e8e\u539f\u751f PDF\u3002 * \u89c6\u89c9\u6cd5\uff1a\u5c06 PDF \u8f6c\u6362\u4e3a\u56fe\u7247\uff0c\u4f7f\u7528\u76ee\u6807\u68c0\u6d4b\u6a21\u578b\u8bc6\u522b\u5355\u5143\u683c\u7ed3\u6784\uff0c\u518d\u7ed3\u5408 OCR \u63d0\u53d6\u5185\u5bb9\u3002\u8fd9\u662f\u5904\u7406\u626b\u63cf\u4ef6\u548c\u590d\u6742\u5d4c\u5957\u8868\u683c\u7684\u552f\u4e00\u9014\u5f84\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_12","title":"12_1.2 \u89e3\u6790\u5de5\u5177\u9009\u578b\u5bf9\u6bd4","text":"<p>\u9762\u5bf9\u590d\u6742\u7684\u4f01\u4e1a\u6587\u6863\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u6587\u6863\u7c7b\u578b\u548c\u9884\u7b97\u9009\u62e9\u6784\u5efa\u89e3\u6790\u7ba1\u9053\u3002</p> \u7279\u6027 Unstructured (Open Source) LlamaParse (Proprietary) PyPDF/PDFMiner (Basic) \u6838\u5fc3\u539f\u7406 \u89c4\u5219 + \u57fa\u7840 OCR \u6df7\u5408\u6a21\u578b \u5927\u6a21\u578b\u89c6\u89c9\u7406\u89e3 (Vision LLM) \u63d0\u53d6\u5e95\u5c42\u6587\u672c\u6d41 \u8868\u683c\u5904\u7406\u80fd\u529b \u4e2d\u7b49\uff08\u80fd\u8bc6\u522b\u8868\u683c\u533a\u57df\uff0c\u4f46\u590d\u6742\u8868\u5934\u6613\u4e71\uff09 \u6781\u5f3a\uff08\u91cd\u6784\u4e3a Markdown \u8868\u683c\uff0c\u4fdd\u7559\u8bed\u4e49\uff09 \u5dee\uff08\u884c\u5217\u5b8c\u5168\u9519\u4e71\uff09 \u591a\u680f\u8bc6\u522b \u652f\u6301\uff08\u57fa\u4e8e\u68c0\u6d4b\u6a21\u578b\uff09 \u652f\u6301\uff08\u539f\u751f\u7406\u89e3\u7248\u9762\uff09 \u4e0d\u652f\u6301\uff08\u8de8\u680f\u8bfb\u53d6\uff09 \u6210\u672c \u4f4e\uff08\u672c\u5730\u8ba1\u7b97\u8d44\u6e90\uff09 \u9ad8\uff08\u6309\u9875\u6570\u8ba1\u8d39 API\uff09 \u6781\u4f4e \u9002\u7528\u573a\u666f \u7b80\u5355\u7684 Word/HTML\uff0c\u89c4\u5219\u56fa\u5b9a\u7684 PDF \u590d\u6742\u8d22\u62a5\u3001\u626b\u63cf\u4ef6\u3001\u5d4c\u5957\u8868\u683c \u7eaf\u6587\u672c\u7535\u5b50\u4e66 <p>\u5efa\u8bae\uff1a\u5bf9\u4e8e\u6838\u5fc3\u4e1a\u52a1\u6587\u6863\uff08\u5982\u5408\u540c\u3001\u8d22\u62a5\uff09\uff0c\u4f18\u5148\u4f7f\u7528 LlamaParse \u6216 Azure Document Intelligence\uff1b\u5bf9\u4e8e\u6d77\u91cf\u666e\u901a\u6587\u6863\uff0c\u4f7f\u7528 Unstructured \u8fdb\u884c\u6e05\u6d17\u4ee5\u964d\u4f4e\u6210\u672c\u3002</p> <p></p> <p>\u56fe12-1\uff1a\u4f20\u7edf\u89e3\u6790 vs. \u667a\u80fd\u89e3\u6790 \u2014\u2014 \u667a\u80fd\u89e3\u6790\u901a\u8fc7\u7248\u9762\u5206\u6790\u4fdd\u7559\u4e86\u591a\u680f\u987a\u5e8f\u548c\u8868\u683c\u7ed3\u6784</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_2-chunking","title":"12_2 \u5207\u7247\u7b56\u7565 (Chunking)\uff1a\u4e0a\u4e0b\u6587\u4e0e\u68c0\u7d22\u7c92\u5ea6\u7684\u5e73\u8861\u827a\u672f","text":"<p>\u6587\u6863\u89e3\u6790\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u5207\u5206\u4e3a\u6a21\u578b\u53ef\u5904\u7406\u7684\u7247\u6bb5\uff08Chunk\uff09\u3002\u5207\u5206\u7b56\u7565\u76f4\u63a5\u51b3\u5b9a\u4e86\u68c0\u7d22\u7684\u51c6\u786e\u5ea6\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_21-recursive-character-splitter","title":"12_2.1 \u57fa\u7840\u7b56\u7565\uff1a\u9012\u5f52\u5b57\u7b26\u5207\u7247 (Recursive Character Splitter)","text":"<p>\u6700\u6734\u7d20\u7684\u65b9\u6cd5\u662f\u6309\u56fa\u5b9a\u5b57\u7b26\u6570\u5207\u5206\uff08\u5982\u6bcf 500 \u5b57\u4e00\u5200\uff09\u3002\u4f46\u8fd9\u5f80\u5f80\u4f1a\u628a\u4e00\u4e2a\u5b8c\u6574\u7684\u53e5\u5b50\u6216\u903b\u8f91\u6bb5\u843d\u62e6\u8170\u622a\u65ad\u3002 \u9012\u5f52\u5207\u7247\u662f\u76ee\u524d\u7684\u57fa\u51c6\u65b9\u6848\u3002\u5b83\u901a\u8fc7\u5b9a\u4e49\u4e00\u7ec4\u5206\u9694\u7b26\u4f18\u5148\u7ea7\uff08\u5982 <code>\\n\\n</code> &gt; <code>\\n</code> &gt; <code>\u3002</code> &gt; <code></code>\uff09\uff0c\u4f18\u5148\u5728\u6bb5\u843d\u95f4\u5207\u5206\uff0c\u5176\u6b21\u5728\u53e5\u5b50\u95f4\u5207\u5206\u3002\u8fd9\u4fdd\u8bc1\u4e86\u5c3d\u53ef\u80fd\u4fdd\u7559\u8bed\u4e49\u7684\u5b8c\u6574\u6027\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_22-semantic-chunking","title":"12_2.2 \u8fdb\u9636\u7b56\u7565\uff1a\u8bed\u4e49\u5207\u7247 (Semantic Chunking)","text":"<p>\u5373\u4f7f\u662f\u9012\u5f52\u5207\u7247\uff0c\u4e5f\u65e0\u6cd5\u5224\u65ad\u4e24\u4e2a\u6bb5\u843d\u662f\u5426\u5728\u8ba8\u8bba\u540c\u4e00\u4e2a\u8bdd\u9898\u3002\u8bed\u4e49\u5207\u7247\u5229\u7528 Embedding \u6a21\u578b\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a 1.  \u8ba1\u7b97\u76f8\u90bb\u53e5\u5b50\u7684\u5411\u91cf\u76f8\u4f3c\u5ea6\u3002 2.  \u8bbe\u5b9a\u9608\u503c\uff0c\u5f53\u76f8\u90bb\u53e5\u5b50\u7684\u76f8\u4f3c\u5ea6\u9aa4\u964d\u65f6\uff08\u610f\u5473\u7740\u8bdd\u9898\u53d1\u751f\u4e86\u8f6c\u6362\uff09\uff0c\u5728\u6b64\u5904\u8fdb\u884c\u5207\u5206\u3002 \u8fd9\u79cd\u65b9\u6cd5\u751f\u6210\u7684 Chunk \u957f\u5ea6\u4e0d\u4e00\uff0c\u4f46\u8bed\u4e49\u7eaf\u5ea6\u6781\u9ad8\uff0c\u907f\u514d\u4e86\u201c\u4e00\u4e2a Chunk \u5305\u542b\u534a\u4e2a\u4ea7\u54c1\u4ecb\u7ecd\u548c\u534a\u4e2a\u552e\u540e\u653f\u7b56\u201d\u7684\u566a\u97f3\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_23-parent-child-indexing","title":"12_2.3 \u9ad8\u7ea7\u7b56\u7565\uff1a\u7236\u5b50\u7d22\u5f15 (Parent-Child Indexing)","text":"<p>\u8fd9\u662f\u89e3\u51b3 RAG \u201c\u68c0\u7d22\u7c92\u5ea6\u201d\u4e0e\u201c\u751f\u6210\u4e0a\u4e0b\u6587\u201d\u77db\u76fe\u7684\u7ec8\u6781\u6b66\u5668\u3002 * \u77db\u76fe\uff1aChunk \u8d8a\u5c0f\uff0c\u8bed\u4e49\u8d8a\u805a\u7126\uff0c\u5411\u91cf\u68c0\u7d22\u8d8a\u51c6\uff1b\u4f46 Chunk \u592a\u5c0f\uff0c\u4e22\u5931\u4e86\u4e0a\u4e0b\u6587\uff0cLLM \u65e0\u6cd5\u751f\u6210\u5168\u9762\u56de\u7b54\u3002 * \u89e3\u6cd5\uff1a     1.  \u5c06\u6587\u6863\u5207\u5206\u4e3a\u5927\u5757\uff08Parent Chunk\uff09\uff0c\u4f8b\u5982 1000 Token\u3002     2.  \u5c06\u6bcf\u4e2a\u5927\u5757\u8fdb\u4e00\u6b65\u5207\u5206\u4e3a\u5c0f\u5757\uff08Child Chunk\uff09\uff0c\u4f8b\u5982 200 Token\u3002     3.  \u5bf9\u5c0f\u5757\u8fdb\u884c\u5411\u91cf\u5316\u5e76\u5efa\u7acb\u7d22\u5f15\u3002     4.  \u68c0\u7d22\u65f6\uff0c\u5339\u914d\u5230\u5c0f\u5757\uff0c\u4f46\u8fd4\u56de\u7ed9 LLM \u7684\u662f\u8be5\u5c0f\u5757\u6240\u5c5e\u7684\u5927\u5757\u3002</p> <p>\u8fd9\u79cd\u201c\u5c0f\u5757\u68c0\u7d22\uff0c\u5927\u5757\u751f\u6210\u201d\u7684\u7b56\u7565\uff08Small-to-Big Retrieval\uff09\uff0c\u65e2\u4fdd\u8bc1\u4e86\u68c0\u7d22\u7684\u7cbe\u51c6\u5ea6\uff0c\u53c8\u4e3a\u6a21\u578b\u63d0\u4f9b\u4e86\u5145\u8db3\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002</p> <p></p> <p>\u56fe12-2\uff1a\u7236\u5b50\u7d22\u5f15\u673a\u5236 \u2014\u2014 \u68c0\u7d22\u547d\u4e2d Child Node\uff0c\u5b9e\u9645\u8fd4\u56de Parent Node\uff0c\u517c\u987e\u7cbe\u51c6\u5ea6\u4e0e\u4e0a\u4e0b\u6587</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_3","title":"12_3 \u5411\u91cf\u5316\u4e0e\u5b58\u50a8\uff1a\u8ba9\u673a\u5668\u542c\u61c2\u884c\u4e1a\u201c\u9ed1\u8bdd\u201d","text":"<p>\u6570\u636e\u5207\u7247\u540e\uff0c\u9700\u8981\u901a\u8fc7 Embedding \u6a21\u578b\u8f6c\u5316\u4e3a\u5411\u91cf\u5e76\u5b58\u5165\u5411\u91cf\u6570\u636e\u5e93\u3002\u5728\u8fd9\u4e2a\u73af\u8282\uff0c\u901a\u7528\u7684\u65b9\u6848\u5f80\u5f80\u4e0d\u591f\u7528\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_31-embedding","title":"12_3.1 Embedding \u6a21\u578b\u5fae\u8c03","text":"<p>\u901a\u7528\u7684 Embedding \u6a21\u578b\uff08\u5982 OpenAI text-embedding-3 \u6216 BGE-M3\uff09\u662f\u5728\u901a\u7528\u8bed\u6599\u4e0a\u8bad\u7ec3\u7684\u3002\u5728\u5782\u76f4\u9886\u57df\uff0c\u5b83\u4eec\u53ef\u80fd\u8868\u73b0\u4e0d\u4f73\u3002 \u4f8b\u5982\uff0c\u5728\u533b\u7597\u9886\u57df\uff0c\u201c\u611f\u5192\u201d\u548c\u201c\u53d1\u70e7\u201d\u5728\u901a\u7528\u8bed\u4e49\u4e0b\u5f88\u63a5\u8fd1\uff0c\u4f46\u5728\u8bca\u65ad\u903b\u8f91\u4e2d\u53ef\u80fd\u6307\u5411\u5b8c\u5168\u4e0d\u540c\u7684\u75c5\u7406\u3002 \u5fae\u8c03\uff08Fine-tuning\uff09 \u65e8\u5728\u8c03\u6574\u5411\u91cf\u7a7a\u95f4\u5206\u5e03\uff0c\u8ba9\u76f8\u4f3c\u7684\u4e13\u4e1a\u6982\u5ff5\u9760\u5f97\u66f4\u8fd1\u3002\u901a\u5e38\u4f7f\u7528 \u5bf9\u6bd4\u5b66\u4e60\uff08Contrastive Learning\uff09 \u635f\u5931\u51fd\u6570\uff1a</p> \\[ L = - \\log \\frac{e^{sim(q, d^+)/\\tau}}{\\sum_{i} e^{sim(q, d^-_i)/\\tau}} \\] <p>\u5176\u4e2d \\(d^+\\) \u662f\u6b63\u4f8b\uff08\u6b63\u786e\u7684\u6587\u6863\uff09\uff0c\\(d^-\\) \u662f\u8d1f\u4f8b\uff08\u9519\u8bef\u7684\u6587\u6863\uff09\u3002\u901a\u8fc7\u6784\u9020\u201c\u95ee\u9898-\u76f8\u5173\u6587\u6863\u201d\u7684\u6b63\u4f8b\u5bf9\u548c\u201c\u95ee\u9898-\u4e0d\u76f8\u5173\u6587\u6863\u201d\u7684\u8d1f\u4f8b\u5bf9\u8fdb\u884c\u5fae\u8c03\uff0c\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u7279\u5b9a\u9886\u57df\u7684\u68c0\u7d22\u53ec\u56de\u7387\uff08Recall\uff09\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_32-hybrid-search","title":"12_3.2 \u5411\u91cf\u6570\u636e\u5e93\u4e0e\u6df7\u5408\u68c0\u7d22 (Hybrid Search)","text":"<p>\u5355\u7eaf\u4f9d\u8d56\u5411\u91cf\u68c0\u7d22\uff08Dense Retrieval\uff09\u5b58\u5728\u7f3a\u9677\uff1a\u5b83\u5bf9\u4e13\u6709\u540d\u8bcd\u3001\u7cbe\u786e\u6570\u5b57\u3001\u4ea7\u54c1\u578b\u53f7\u7b49\u5173\u952e\u8bcd\u5339\u914d\u5e76\u4e0d\u654f\u611f\u3002 \u4f01\u4e1a\u7ea7 RAG \u5fc5\u987b\u91c7\u7528 \u6df7\u5408\u68c0\u7d22\uff08Hybrid Search\uff09\uff1a * \u5411\u91cf\u68c0\u7d22\uff1a\u6355\u6349\u8bed\u4e49\u76f8\u5173\u6027\uff08\u5982\u201c\u82f9\u679c\u201d\u4e0e\u201c\u6c34\u679c\u201d\uff09\u3002 * \u5173\u952e\u8bcd\u68c0\u7d22\uff08BM25\uff09\uff1a\u6355\u6349\u7cbe\u786e\u5339\u914d\uff08\u5982\u4ea7\u54c1 ID \"A123-X\"\uff09\u3002</p> <p>\u901a\u8fc7\u5012\u6392\u6392\u5e8f\u878d\u5408\uff08Reciprocal Rank Fusion, RRF\uff09\u7b97\u6cd5\u5c06\u4e24\u8005\u7684\u7ed3\u679c\u91cd\u65b0\u6392\u5e8f\uff0c\u53ef\u4ee5\u517c\u91c7\u4f17\u957f\u3002\u6b64\u5916\uff0c\u5411\u91cf\u6570\u636e\u5e93\uff08\u5982 Milvus, Pinecone, Weaviate\uff09\u7684\u9009\u578b\u8fd8\u9700\u8003\u8651\u5143\u6570\u636e\u8fc7\u6ee4\uff08Metadata Filtering\uff09\u6027\u80fd\uff0c\u4ee5\u4fbf\u5728\u68c0\u7d22\u524d\u5148\u901a\u8fc7\u201c\u5e74\u4efd=2023\u201d\u7b49\u6761\u4ef6\u8fc7\u6ee4\u6570\u636e\uff0c\u5927\u5e45\u964d\u4f4e\u8ba1\u7b97\u91cf\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_4","title":"12_4 \u5de5\u7a0b\u5b9e\u73b0\uff1a\u6784\u5efa\u7236\u5b50\u7d22\u5f15\u6d41\u6c34\u7ebf","text":"<p>\u672c\u8282\u6211\u4eec\u5c06\u5b9e\u73b0\u524d\u6587\u63d0\u5230\u7684\u6838\u5fc3\u7b56\u7565\u2014\u2014\u7236\u5b50\u7d22\u5f15 (Parent-Child Indexing)\u3002\u6211\u4eec\u5c06\u4f7f\u7528 Python \u5b9a\u4e49\u4e00\u4e2a\u53ef\u590d\u7528\u7684\u5904\u7406\u7c7b\uff0c\u6a21\u62df\u4ece\u6587\u6863\u52a0\u8f7d\u5230\u5411\u91cf\u5b58\u50a8\u7684\u5168\u8fc7\u7a0b\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_41","title":"12_4.1 \u4f9d\u8d56\u73af\u5883","text":"<pre><code>pip install langchain lancedb numpy unstructured\n</code></pre>"},{"location":"chapter5/5_1_rag_pipeline/#12_42","title":"12_4.2 \u6838\u5fc3\u4ee3\u7801\u62c6\u89e3","text":"<p>\u6211\u4eec\u4e0d\u76f4\u63a5\u8c03\u7528\u5c01\u88c5\u597d\u7684\u9ad8\u7ea7 API\uff0c\u800c\u662f\u62c6\u89e3\u5176\u903b\u8f91\u4ee5\u4fbf\u7406\u89e3\u6570\u636e\u6d41\u5411\u3002</p> <pre><code>import uuid\nfrom typing import List, Dict, Any\nfrom dataclasses import dataclass\n\n@dataclass\nclass Document:\n    page_content: str\n    metadata: Dict[str, Any]\n    doc_id: str = None\n\nclass ParentChildIndexer:\n    \"\"\"\n    \u5b9e\u73b0\u7236\u5b50\u7d22\u5f15\u7b56\u7565\uff1a\n    1. Parent Chunk: \u7528\u4e8e\u5b58\u50a8\u548c\u751f\u6210\uff0c\u4fdd\u7559\u5b8c\u6574\u4e0a\u4e0b\u6587\u3002\n    2. Child Chunk: \u7528\u4e8e\u5411\u91cf\u5316\u548c\u68c0\u7d22\uff0c\u4fdd\u8bc1\u8bed\u4e49\u7cbe\u51c6\u5ea6\u3002\n    \"\"\"\n\n    def __init__(self, parent_chunk_size=1000, child_chunk_size=200):\n        self.parent_size = parent_chunk_size\n        self.child_size = child_chunk_size\n        # \u6a21\u62df\u5411\u91cf\u6570\u636e\u5e93\uff08KV Store + Vector Store\uff09\n        self.doc_store = {}  # \u5b58 Parent \u6587\u6863: {doc_id: content}\n        self.vector_index = [] # \u5b58 Child \u5411\u91cf: [(vector, parent_doc_id)]\n\n    def process_documents(self, raw_docs: List[Document]):\n        \"\"\"Step 1: \u6570\u636e\u5904\u7406\u6d41\u6c34\u7ebf\"\"\"\n        for doc in raw_docs:\n            # \u751f\u6210\u552f\u4e00 ID\n            if not doc.doc_id:\n                doc.doc_id = str(uuid.uuid4())\n\n            # 1. \u5b58\u5165 Parent Document (KV Store)\n            self.doc_store[doc.doc_id] = doc\n\n            # 2. \u751f\u6210 Child Chunks\n            child_chunks = self._create_child_chunks(doc)\n\n            # 3. \u5411\u91cf\u5316\u5e76\u5efa\u7acb\u7d22\u5f15\n            self._index_children(child_chunks, doc.doc_id)\n\n    def _create_child_chunks(self, parent_doc: Document) -&gt; List[str]:\n        \"\"\"\n        Step 2: \u5207\u7247\u903b\u8f91\n        \u8fd9\u91cc\u7b80\u5316\u4e3a\u6309\u56fa\u5b9a\u5b57\u7b26\u6570\u5207\u5206\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4f7f\u7528 RecursiveCharacterTextSplitter\n        \"\"\"\n        text = parent_doc.page_content\n        children = []\n        for i in range(0, len(text), self.child_size):\n            end = min(i + self.child_size, len(text))\n            children.append(text[i:end])\n        return children\n\n    def _index_children(self, children: List[str], parent_id: str):\n        \"\"\"Step 3: \u5411\u91cf\u5316\u903b\u8f91 (\u4f2a\u4ee3\u7801)\"\"\"\n        for child_text in children:\n            # \u6a21\u62df Embedding \u8fc7\u7a0b\n            # vector = embedding_model.encode(child_text) \n            vector = [0_1, 0_2] # \u5360\u4f4d\u7b26\n\n            # \u5173\u952e\uff1a\u5728 Child \u7684\u5143\u6570\u636e\u4e2d\u5b58\u50a8 Parent ID\n            self.vector_index.append({\n                \"vec\": vector,\n                \"text\": child_text,\n                \"parent_id\": parent_id\n            })\n\n    def retrieve(self, query: str) -&gt; List[Document]:\n        \"\"\"\n        Step 4: \u68c0\u7d22\u903b\u8f91 (Small-to-Big)\n        \u68c0\u7d22\u547d\u4e2d Child -&gt; \u8fd4\u56de Parent\n        \"\"\"\n        # 1. \u5411\u91cf\u68c0\u7d22\u627e\u5230 Top-K Children (\u6a21\u62df)\n        # top_children = vector_db.search(query)\n        # \u6ce8\u610f: \u8fd9\u91cc\u4ec5\u4e3a\u793a\u4f8b, \u5b9e\u9645\u5e94\u8be5\u57fa\u4e8e\u5411\u91cf\u76f8\u4f3c\u5ea6\u6392\u5e8f\n        top_child = self.vector_index[0] # \u5047\u8bbe\u547d\u4e2d\u4e86\u7b2c\u4e00\u4e2a\n\n        # 2. \u56de\u6eaf Parent\n        parent_id = top_child[\"parent_id\"]\n        parent_doc = self.doc_store.get(parent_id)\n\n        print(f\"\u68c0\u7d22\u547d\u4e2d\u7247\u6bb5: {top_child['text'][:20]}...\")\n        print(f\"\u56de\u6eaf\u7236\u6587\u6863ID: {parent_id}\")\n        return [parent_doc]\n\n# --- Usage Example ---\nindexer = ParentChildIndexer()\ndoc = Document(page_content=\"RAG\u7cfb\u7edf\u7684\u6838\u5fc3\u5728\u4e8e\u6570\u636e\u8d28\u91cf...\" * 50, metadata={\"source\": \"manual.pdf\"})\nindexer.process_documents([doc])\nresult = indexer.retrieve(\"\u6570\u636e\u8d28\u91cf\")\n</code></pre>"},{"location":"chapter5/5_1_rag_pipeline/#12_43-pro-tips","title":"12_4.3 \u5b9e\u6218\u6280\u5de7 (Pro Tips)","text":"<p>\ud83d\udca1 Tip: ID \u7ba1\u7406\u81f3\u5173\u91cd\u8981 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c<code>doc_id</code> \u5fc5\u987b\u5177\u6709\u786e\u5b9a\u6027\uff08\u4f8b\u5982\u4f7f\u7528 <code>hash(file_path + update_time)</code>\uff09\u3002\u5426\u5219\uff0c\u5f53\u6e90\u6587\u4ef6\u66f4\u65b0\u91cd\u65b0\u8fd0\u884c\u65f6\uff0c\u5411\u91cf\u6570\u636e\u5e93\u4e2d\u4f1a\u4ea7\u751f\u5927\u91cf\u65e0\u6cd5\u5220\u9664\u7684\u201c\u50f5\u5c38\u5207\u7247\u201d\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_5-performance-evaluation","title":"12_5 \u6027\u80fd\u4e0e\u8bc4\u4f30 (Performance &amp; Evaluation)","text":"<p>RAG \u7cfb\u7edf\u7684\u6027\u80fd\u4e0d\u4ec5\u4ec5\u662f\u201c\u56de\u7b54\u51c6\u786e\u201d\uff0c\u8fd8\u5305\u62ec\u7d22\u5f15\u6784\u5efa\u7684\u6210\u672c\u548c\u68c0\u7d22\u7684\u5ef6\u8fdf\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#12_51","title":"12_5.1 \u8bc4\u4ef7\u6307\u6807","text":"\u6307\u6807 \u8bf4\u660e \u76ee\u6807\u503c (\u53c2\u8003) Hit Rate (Recall@K) \u68c0\u7d22\u51fa\u7684\u524d K \u4e2a\u6587\u6863\u4e2d\u5305\u542b\u6b63\u786e\u7b54\u6848\u7684\u6bd4\u4f8b &gt; 85% MRR (Mean Reciprocal Rank) \u6b63\u786e\u6587\u6863\u5728\u68c0\u7d22\u5217\u8868\u4e2d\u7684\u6392\u540d\u6743\u91cd &gt; 0_7 Faithfulness \u751f\u6210\u7684\u7b54\u6848\u662f\u5426\u5fe0\u5b9e\u4e8e\u68c0\u7d22\u5230\u7684\u4e0a\u4e0b\u6587\uff08\u9632\u5e7b\u89c9\uff09 &gt; 90% (\u57fa\u4e8e RAGAS)"},{"location":"chapter5/5_1_rag_pipeline/#12_52-benchmarks","title":"12_5.2 \u57fa\u51c6\u6d4b\u8bd5 (Benchmarks)","text":"<p>\u6211\u4eec\u5728\u670d\u52a1\u5668 (Dual Xeon 6226R + 1x RTX 3090) \u5b9e\u4f8b\u4e0a\uff0c\u9488\u5bf9 10,000 \u9875 PDF \u6587\u6863\uff08\u6df7\u5408\u6587\u672c\u4e0e\u8868\u683c\uff09\u8fdb\u884c\u4e86\u6d4b\u8bd5\uff1a</p> <ul> <li>\u89e3\u6790\u8017\u65f6 (Unstructured): <ul> <li>\u7eaf CPU: 28 \u5206\u949f</li> <li>GPU \u52a0\u901f (OCR): 11 \u5206\u949f (\u52a0\u901f 2_5 \u500d)</li> </ul> </li> <li>\u68c0\u7d22\u5ef6\u8fdf (10M \u5411\u91cf\u89c4\u6a21):<ul> <li>\u7eaf Dense \u68c0\u7d22: 9ms</li> <li>Hybrid \u68c0\u7d22 (Dense + Sparse + RRF): 45ms</li> <li>\u7ed3\u8bba\uff1a\u6df7\u5408\u68c0\u7d22\u867d\u7136\u589e\u52a0\u4e86\u5ef6\u8fdf\uff0c\u4f46\u5728\u7cbe\u51c6\u5ea6\u8981\u6c42\u9ad8\u7684\u573a\u666f\u4e0b\uff08\u5982\u5408\u540c\u5ba1\u67e5\uff09\uff0c36ms\u7684\u989d\u5916\u5f00\u9500\u662f\u5b8c\u5168\u503c\u5f97\u7684\u3002</li> </ul> </li> </ul>"},{"location":"chapter5/5_1_rag_pipeline/#12_6","title":"12_6 \u5e38\u89c1\u8bef\u533a\u4e0e\u907f\u5751\u6307\u5357","text":""},{"location":"chapter5/5_1_rag_pipeline/#pdf-pypdf","title":"\u8bef\u533a\u4e00\uff1a\u201cPDF \u89e3\u6790\u7528 PyPDF \u5c31\u591f\u4e86\u201d","text":"<p>\u8bb8\u591a\u521d\u5b66\u8005\u4f4e\u4f30\u4e86 PDF \u7684\u590d\u6742\u6027\u3002\u5bf9\u4e8e\u5305\u542b\u56fe\u8868\u3001\u591a\u680f\u7684\u8d22\u62a5\u6216\u624b\u518c\uff0c\u7b80\u5355\u7684\u6587\u672c\u63d0\u53d6\u4f1a\u5bfc\u81f4\u4e25\u91cd\u7684\u4fe1\u606f\u4e22\u5931\u3002\u5efa\u8bae\u5728\u9879\u76ee\u521d\u671f\u5c31\u5f15\u5165 Layout Analysis \u5de5\u5177\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#_3","title":"\u8bef\u533a\u4e8c\uff1a\u201c\u5207\u7247\u8d8a\u5c0f\u8d8a\u597d\u201d","text":"<p>\u8fc7\u5c0f\u7684\u5207\u7247\u867d\u7136\u80fd\u63d0\u9ad8\u68c0\u7d22\u7684\u4f59\u5f26\u76f8\u4f3c\u5ea6\uff0c\u4f46\u4f1a\u5bfc\u81f4\u201c\u65ad\u7ae0\u53d6\u4e49\u201d\u3002LLM \u7f3a\u4e4f\u8db3\u591f\u7684\u4e0a\u4e0b\u6587\uff08Context\uff09\u6765\u63a8\u65ad\u6b63\u786e\u7b54\u6848\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#_4","title":"\u8bef\u533a\u4e09\uff1a\u201c\u5ffd\u89c6\u5143\u6570\u636e\u201d","text":"<p>\u53ea\u5b58\u6587\u672c\u5411\u91cf\uff0c\u4e0d\u5b58\u5143\u6570\u636e\uff08\u5982\u6587\u4ef6\u540d\u3001\u9875\u7801\u3001\u53d1\u5e03\u65e5\u671f\uff09\uff0c\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u8fdb\u884c\u65f6\u95f4\u8fc7\u6ee4\u6216\u6765\u6e90\u8ffd\u6eaf\uff0c\u964d\u4f4e\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u3002</p>"},{"location":"chapter5/5_1_rag_pipeline/#_5","title":"\u672c\u7ae0\u5c0f\u7ed3","text":"<p>RAG \u7cfb\u7edf\u7684\u6838\u5fc3\u7ade\u4e89\u529b\u5728\u4e8e\u6570\u636e\u5904\u7406\u7684\u7cbe\u7ec6\u5ea6\u3002\u672c\u7ae0\u6211\u4eec\u89e3\u6790\u4e86 RAG \u6570\u636e\u6d41\u6c34\u7ebf\u7684\u4e09\u5927\u5173\u5361\uff1a 1.  \u89e3\u6790\u5173\uff1a\u5fc5\u987b\u4ece\u89c6\u89c9\u5c42\u9762\u7406\u89e3\u6587\u6863\u7ed3\u6784\uff0c\u89e3\u51b3\u8868\u683c\u548c\u591a\u680f\u95ee\u9898\u3002 2.  \u5207\u7247\u5173\uff1a\u544a\u522b\u5355\u4e00\u7684\u56fa\u5b9a\u5207\u5206\uff0c\u91c7\u7528\u7236\u5b50\u7d22\u5f15\u6216\u8bed\u4e49\u5207\u7247\u6765\u5e73\u8861\u68c0\u7d22\u7cbe\u5ea6\u4e0e\u4e0a\u4e0b\u6587\u5b8c\u6574\u6027\u3002 3.  \u68c0\u7d22\u5173\uff1a\u901a\u8fc7\u5fae\u8c03 Embedding \u6a21\u578b\u9002\u914d\u9886\u57df\u77e5\u8bc6\uff0c\u5e76\u7ed3\u5408\u6df7\u5408\u68c0\u7d22\u5f25\u8865\u5411\u91cf\u5339\u914d\u7684\u4e0d\u8db3\u3002</p> <p>\u505a\u597d\u4e86\u8fd9\u4e9b\uff0c\u4f60\u7684 RAG \u7cfb\u7edf\u624d\u80fd\u4ece\u201c\u80fd\u7528\u201d\u8fdb\u5316\u4e3a\u201c\u597d\u7528\u201d\u3002</p> <p></p> <p>\u56fe12-3\uff1a\u4f01\u4e1a\u7ea7 RAG \u6570\u636e\u6d41\u6c34\u7ebf\u67b6\u6784 \u2014\u2014 \u5f3a\u8c03\u4ece\u975e\u7ed3\u6784\u5316\u89e3\u6790\u5230\u6df7\u5408\u68c0\u7d22\u7684\u5168\u6d41\u7a0b\u4f18\u5316</p>"},{"location":"chapter5/5_1_rag_pipeline/#_6","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<p>\u5de5\u5177\u4e0e\u6846\u67b6 * LlamaIndex\uff1a\u76ee\u524d\u6700\u5148\u8fdb\u7684 RAG \u6570\u636e\u6846\u67b6\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684 Data Loaders \u548c Indexing \u7b56\u7565\uff08\u5305\u62ec\u672c\u6587\u63d0\u5230\u7684\u7236\u5b50\u7d22\u5f15\uff09\u3002 * RAGAS\uff1a\u4e00\u4e2a\u7528\u4e8e\u8bc4\u4f30 RAG \u7ba1\u9053\u6027\u80fd\u7684\u6846\u67b6\uff0c\u5173\u6ce8\u68c0\u7d22\u51c6\u786e\u7387\uff08Retrieval Accuracy\uff09\u548c\u751f\u6210\u5fe0\u5b9e\u5ea6\uff08Faithfulness\uff09\u3002</p> <p>\u6838\u5fc3\u8bba\u6587 * Lewis \u7b49\u4eba\u4e8e 2020 \u5e74\u53d1\u8868\u7684 Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks \u662f RAG \u7684\u5f00\u5c71\u4e4b\u4f5c\u3002 * Karpukhin \u7b49\u4eba\u53d1\u8868\u7684 Dense Passage Retrieval for Open-Domain Question Answering (DPR) \u5960\u5b9a\u4e86\u73b0\u4ee3\u53cc\u5854\u5411\u91cf\u68c0\u7d22\u7684\u57fa\u7840\u3002</p>"},{"location":"chapter5/5_2_mm_rag/","title":"\u7b2c13\u7ae0\uff1a\u591a\u6a21\u6001 RAG","text":""},{"location":"chapter5/5_2_mm_rag/#_1","title":"\u672c\u7ae0\u6458\u8981","text":"<p>\u5728\u6587\u672c RAG \u5df2\u7ecf\u5377\u51fa\u5929\u9645\u7684\u4eca\u5929\uff0c\u591a\u6a21\u6001\uff08Multimodal\uff09\u6210\u4e3a\u4e86\u65b0\u7684\u6218\u573a\u3002\u4f01\u4e1a\u6587\u6863\u4e2d\u5f80\u5f80\u5305\u542b\u5927\u91cf\u56fe\u8868\u3001\u6d41\u7a0b\u56fe\u3001\u622a\u5c4f\uff0c\u4f20\u7edf RAG \u65b9\u6848\u901a\u5e38\u9009\u62e9\u7528 OCR \u8f6c\u6587\u5b57\u6216\u76f4\u63a5\u5ffd\u7565\u56fe\u7247\uff0c\u5bfc\u81f4\u5173\u952e\u4fe1\u606f\u4e22\u5931\uff08Information Loss\uff09\u3002\u672c\u7ae0\u5c06\u7a81\u7834\u201c\u7eaf\u6587\u672c\u201d\u7684\u9650\u5236\uff0c\u6784\u5efa\u80fd\u591f\u201c\u770b\u89c1\u201d\u6570\u636e\u7684\u7cfb\u7edf\u3002\u6211\u4eec\u5c06\u4ece\u57fa\u7840\u7684 CLIP/SigLIP \u8de8\u6a21\u6001\u68c0\u7d22\u8bb2\u8d77\uff0c\u6df1\u5165\u63a2\u8ba8\u98a0\u8986\u6027\u7684 ColPali \u67b6\u6784\u2014\u2014\u5e76\u624b\u628a\u624b\u5b9e\u73b0\u5305\u542b\u4e8c\u8fdb\u5236\u91cf\u5316\uff08BQ\uff09\u548cLate Interaction \u6253\u5206\u903b\u8f91\u7684\u7aef\u5230\u7aef\u68c0\u7d22\u6d41\u6c34\u7ebf\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_0-learning-objectives","title":"13_0 \u5b66\u4e60\u76ee\u6807 (Learning Objectives)","text":"<ul> <li>\u7406\u89e3\u591a\u6a21\u6001\u5411\u91cf\u7a7a\u95f4\uff1a\u638c\u63e1 CLIP \u4e0e SigLIP \u7684\u5bf9\u6bd4\u635f\u5931\u539f\u7406\uff0c\u7406\u89e3\u6587\u672c\u4e0e\u56fe\u50cf\u662f\u5982\u4f55\u5728\u540c\u4e00\u4e2a\u5411\u91cf\u7a7a\u95f4\u5bf9\u9f50\u7684\u3002</li> <li>\u638c\u63e1 ColPali \u67b6\u6784\uff1a\u7406\u89e3 Late Interaction\uff08\u665a\u671f\u4ea4\u4e92\uff09\u673a\u5236\uff0c\u5b66\u4f1a\u4f7f\u7528 <code>colpali-v1_2-merged</code> \u5904\u7406\u590d\u6742\u7684 PDF \u8868\u683c\u4e0e\u56fe\u8868\u3002</li> <li>\u5de5\u7a0b\u843d\u5730\u80fd\u529b\uff1a\u7f16\u5199 Python \u4ee3\u7801\u5b9e\u73b0 MaxSim \u6253\u5206\u7b97\u6cd5\uff0c\u5e76\u5229\u7528\u4e8c\u8fdb\u5236\u91cf\u5316\u5c06\u5b58\u50a8\u6210\u672c\u964d\u4f4e 32 \u500d\u3002</li> <li>\u53ef\u89c6\u5316\u9a8c\u8bc1\uff1a\u901a\u8fc7\u6ce8\u610f\u529b\u70ed\u529b\u56fe\uff08Attention Heatmap\uff09\u9a8c\u8bc1\u6a21\u578b\u7684\u53ef\u89e3\u91ca\u6027\u3002</li> </ul>"},{"location":"chapter5/5_2_mm_rag/#_2","title":"\u573a\u666f\u5f15\u5165","text":"<p>\u4f60\u6b63\u5728\u7ef4\u62a4\u4e00\u4e2a\u534a\u5bfc\u4f53\u8bbe\u5907\u7684\u7ef4\u4fee\u77e5\u8bc6\u5e93\u3002\u6280\u672f\u624b\u518c\u91cc\u5145\u6ee1\u4e86\u590d\u6742\u7684\u7535\u8def\u56fe\u548c\u8bbe\u5907\u7ed3\u6784\u56fe\u3002 \u73b0\u573a\u5de5\u7a0b\u5e08\u53d1\u6765\u8bf7\u6c42\uff1a\u201c\u5e2e\u6211\u627e\u4e00\u4e0b\u2018\u4e3b\u677f\u4f9b\u7535\u6a21\u5757\u2019\u7684\u63a5\u7ebf\u56fe\u3002\u201d</p> <ul> <li>\u4f20\u7edf RAG (Text-only)\uff1a\u68c0\u7d22\u5230\u4e86\u6587\u5b57\u63cf\u8ff0\u201c\u4e3b\u677f\u4f9b\u7535\u8bf7\u53c2\u8003\u56fe 3-12\u201d\uff0c\u4f46\u7cfb\u7edf\u65e0\u6cd5\u8fd4\u56de\u56fe\u7247\uff0c\u6216\u8005 OCR \u628a\u7535\u8def\u56fe\u8bc6\u522b\u6210\u4e86\u4e00\u5806\u4e71\u7801\u5b57\u7b26\uff08\u5982 <code>---||---</code>\uff09\uff0c\u5de5\u7a0b\u5e08\u770b\u7740\u6587\u5b57\u5e72\u7740\u6025\u3002</li> <li>\u591a\u6a21\u6001 RAG\uff1a\u7cfb\u7edf\u4e0d\u4ec5\u7406\u89e3\u4e86\u7528\u6237\u7684\u6587\u5b57\u610f\u56fe\uff0c\u76f4\u63a5\u68c0\u7d22\u5230\u4e86\u5305\u542b\u8be5\u7535\u8def\u56fe\u7684 PDF \u9875\u9762\u622a\u56fe\uff0c\u5e76\u7cbe\u786e\u9ad8\u4eae\u4e86\u4f9b\u7535\u6a21\u5757\u533a\u57df\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u4ece\u201c\u9605\u8bfb\u201d\u5230\u201c\u770b\u89c1\u201d\u7684\u8d28\u53d8\u3002\u5728\u5f88\u591a\u5de5\u4e1a\u3001\u91d1\u878d\u573a\u666f\u4e0b\uff0c\u4e00\u5f20\u56fe\u7684\u4fe1\u606f\u5bc6\u5ea6\u8fdc\u8d85\u4e00\u5343\u5b57\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_1","title":"13_1 \u8de8\u6a21\u6001\u68c0\u7d22\uff1a\u6253\u7834\u56fe\u6587\u58c1\u5792","text":"<p>\u8981\u5b9e\u73b0\u201c\u4ee5\u6587\u641c\u56fe\u201d\u6216\u201c\u4ee5\u56fe\u641c\u6587\u201d\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u80fd\u540c\u65f6\u7406\u89e3\u4e24\u79cd\u6a21\u6001\u7684\u6a21\u578b\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_11-contrastive-learning","title":"13_1.1 \u6838\u5fc3\u539f\u7406\uff1a\u5bf9\u6bd4\u5b66\u4e60 (Contrastive Learning)","text":"<p>OpenAI \u7684 CLIP (Contrastive Language-Image Pre-training) \u662f\u8fd9\u4e00\u9886\u57df\u7684\u57fa\u77f3\u3002\u5b83\u7684\u8bad\u7ec3\u903b\u8f91\u7b80\u5355\u800c\u66b4\u529b\uff1a 1.  \u6536\u96c6\u6570\u4ebf\u5bf9 <code>(\u56fe\u7247, \u6587\u672c)</code> \u6570\u636e\u3002 2.  \u901a\u8fc7\u56fe\u50cf\u7f16\u7801\u5668\u548c\u6587\u672c\u7f16\u7801\u5668\u5206\u522b\u63d0\u53d6\u5411\u91cf\u3002 3.  \u62c9\u8fd1\u5339\u914d\u5bf9\u7684\u5411\u91cf\u8ddd\u79bb\uff0c\u63a8\u8fdc\u4e0d\u5339\u914d\u5bf9\u7684\u8ddd\u79bb\u3002</p> <p>\u6700\u7ec8\u7ed3\u679c\u662f\uff1a\u4e00\u5f20\u201c\u72d7\u201d\u7684\u7167\u7247\u5411\u91cf\uff0c\u4e0e\u5355\u8bcd\u201cDog\u201d\u7684\u6587\u672c\u5411\u91cf\uff0c\u5728\u6570\u5b66\u7a7a\u95f4\u4e2d\u662f\u975e\u5e38\u63a5\u8fd1\u7684\u3002</p> <p></p> <p>\u56fe13-1\uff1aCLIP \u67b6\u6784 \u2014\u2014 \u6587\u672c\u4e0e\u56fe\u50cf\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a\u9ad8\u7ef4\u7403\u9762\u4e0a\uff0c\u901a\u8fc7\u8ba1\u7b97\u4f59\u5f26\u76f8\u4f3c\u5ea6\u6765\u5224\u65ad\u5173\u8054\u6027</p>"},{"location":"chapter5/5_2_mm_rag/#13_12-clip-vs-siglip","title":"13_1.2 \u6280\u672f\u9009\u578b\uff1aCLIP vs. SigLIP","text":"<p>\u867d\u7136 CLIP \u540d\u6c14\u6700\u5927\uff0c\u4f46\u5728\u5de5\u7a0b\u843d\u5730\u65f6\uff0c\u6211\u4eec\u6709\u66f4\u597d\u7684\u9009\u62e9\u3002Google \u63a8\u51fa\u7684 SigLIP (Sigmoid Loss for Language Image Pre-training) \u5728\u591a\u9879\u6307\u6807\u4e0a\u8d85\u8d8a\u4e86 CLIP\u3002</p> \u7279\u6027 OpenAI CLIP Google SigLIP \u67b6\u6784\u5e08\u5efa\u8bae \u635f\u5931\u51fd\u6570 Softmax (\u5168\u5c40\u5f52\u4e00\u5316) Sigmoid (\u72ec\u7acb\u4e8c\u5206\u7c7b) Sigmoid \u663e\u5b58\u5229\u7528\u7387\u66f4\u9ad8\uff0c\u9002\u5408\u5927 Batch \u8bad\u7ec3 \u4e2d\u6587\u652f\u6301 \u5f31 (\u4e3b\u8981\u82f1\u6587) \u8f83\u597d (\u591a\u8bed\u8a00\u7248\u672c) \u5fc5\u987b\u9009\u7528\u591a\u8bed\u8a00 Checkpoint \u5206\u8fa8\u7387 \u901a\u5e38 224x224 \u652f\u6301\u52a8\u6001\u5206\u8fa8\u7387 \u590d\u6742\u56fe\u8868\u9009\u9ad8\u5206\u8fa8\u7387 (384+) \u6a21\u578b <p>\u5efa\u8bae\uff1a\u5728 2025 \u5e74\u6784\u5efa\u65b0\u7cfb\u7edf\uff0c\u4f18\u5148\u9009\u62e9 SigLIP \u6216 Meta \u7684 DINOv2\uff08\u7eaf\u89c6\u89c9\u7279\u5f81\u5f3a\uff09\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_2-colpali-ocr","title":"13_2 ColPali \u67b6\u6784\u5b9e\u6218\uff1a\u7ec8\u7ed3 OCR \u7684\u5669\u68a6","text":"<p>\u5bf9\u4e8e PDF \u6587\u6863\u68c0\u7d22\uff0cCLIP \u6709\u4e00\u4e2a\u81f4\u547d\u5f31\u70b9\uff1a\u5b83\u64c5\u957f\u81ea\u7136\u56fe\u50cf\uff08\u732b\u3001\u72d7\u3001\u98ce\u666f\uff09\uff0c\u4f46\u5bf9\u5bcc\u6587\u672c\u56fe\u50cf\uff08\u5305\u542b\u5bc6\u96c6\u6587\u5b57\u3001\u8868\u683c\u7684\u6587\u6863\u9875\uff09\u7406\u89e3\u80fd\u529b\u6781\u5dee\u3002 \u4f20\u7edf\u505a\u6cd5\u662f <code>PDF -&gt; OCR -&gt; Text Embedding</code>\uff0c\u4f46 OCR \u4f1a\u4e22\u5931\u5e03\u5c40\u4fe1\u606f\uff0c\u4e14\u5bf9\u56fe\u8868\u675f\u624b\u65e0\u7b56\u3002</p> <p>ColPali (ColBERT + PaliGemma) \u63d0\u51fa\u4e86\u4e00\u79cd\u9769\u547d\u6027\u7684\u601d\u8def\uff1a\u4e0d\u8981 OCR\uff0c\u76f4\u63a5\u628a PDF \u9875\u9762\u5f53\u56fe\u770b\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_21","title":"13_2.1 \u6838\u5fc3\u539f\u7406\uff1a\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\u7684\u665a\u671f\u4ea4\u4e92","text":"<p>ColPali \u7ed3\u5408\u4e86\u89c6\u89c9\u8bed\u8a00\u6a21\u578b\uff08VLM\uff09\u548c ColBERT \u7684\u68c0\u7d22\u673a\u5236\u3002</p> <ol> <li>Patch Embedding\uff1a\u5c06\u6587\u6863\u56fe\u50cf\u5207\u5206\u4e3a\u591a\u4e2a\u5c0f\u5757\uff08Patches\uff09\uff0c\u6bcf\u4e2a Patch \u751f\u6210\u4e00\u4e2a\u5411\u91cf\u3002\u4e00\u5f20\u56fe\u53ef\u80fd\u5bf9\u5e94 1024 \u4e2a\u5411\u91cf\u3002</li> <li>Late Interaction (MaxSim)\uff1a\u68c0\u7d22\u65f6\uff0c\u5c06\u7528\u6237 Query \u7684\u6bcf\u4e2a Token \u5411\u91cf\u4e0e\u6587\u6863\u7684\u6240\u6709 Patch \u5411\u91cf\u8fdb\u884c\u8ba1\u7b97\uff0c\u53d6\u6700\u5927\u76f8\u4f3c\u5ea6\u3002</li> </ol> <p></p> <p>\u56fe13-2\uff1aBad Case (\u5de6) vs Good Case (\u53f3) \u2014\u2014 \u5de6\u4fa7 OCR \u5c06\u8868\u683c\u8bc6\u522b\u4e3a\u4e71\u7801\u5b57\u7b26\uff1b\u53f3\u4fa7 ColPali \u76f4\u63a5\u5728\u56fe\u50cf\u5c42\u9762\u5bf9\u9f50\u4e86 Query \u4e0e\u8868\u683c\u884c</p>"},{"location":"chapter5/5_2_mm_rag/#13_3","title":"13_3 \u5de5\u7a0b\u5b9e\u73b0\uff1a\u6784\u5efa\u6df7\u5408\u591a\u6a21\u6001\u68c0\u7d22\u6d41\u6c34\u7ebf","text":"<p>\u672c\u8282\u6211\u4eec\u5c06\u5b9e\u73b0\u4e00\u4e2a\u517c\u5bb9 SigLIP\uff08\u81ea\u7136\u56fe\uff09 \u548c ColPali\uff08\u6587\u6863\u56fe\uff09 \u7684\u68c0\u7d22\u7cfb\u7edf\u6846\u67b6\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_31","title":"13_3.1 \u603b\u4f53\u67b6\u6784\u4e0e\u6570\u636e\u6d41","text":"<p>\u5728\u7f16\u5199\u4ee3\u7801\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u660e\u786e\u6570\u636e\u662f\u5982\u4f55\u6d41\u52a8\u7684\u3002\u8fd9\u4e0d\u518d\u662f\u7b80\u5355\u7684\u201c\u6587\u672c\u8fdb\uff0c\u6587\u672c\u51fa\u201d\u3002</p> <p></p> <p>\u56fe13-3\uff1aEnd-to-End Pipeline \u2014\u2014 \u5de6\u4fa7\u4e3a\u5165\u5e93\u6d41\u7a0b\uff08PDF\u8f6c\u56fe -&gt; Vision Encoder -&gt; \u91cf\u5316 -&gt; \u5411\u91cf\u5e93\uff09\uff1b\u53f3\u4fa7\u4e3a\u68c0\u7d22\u6d41\u7a0b\uff08Query -&gt; Text Encoder -&gt; MaxSim \u6253\u5206 -&gt; Re-rank\uff09</p>"},{"location":"chapter5/5_2_mm_rag/#13_32","title":"13_3.2 \u6838\u5fc3\u4ee3\u7801\uff1a\u591a\u6a21\u6001\u7d22\u5f15\u4e0e\u6253\u5206","text":"<p>\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a <code>MultimodalIndexer</code>\u3002\u4e3a\u4e86\u8ba9\u7cfb\u7edf\u5177\u5907\u5b9e\u6218\u80fd\u529b\uff0c\u6211\u4eec\u4e0d\u4ec5\u8981\u5199\u201c\u5411\u91cf\u5316\uff08Embedding\uff09\u201d\u903b\u8f91\uff0c\u66f4\u8981\u663e\u5f0f\u5b9e\u73b0\u201c\u6253\u5206\uff08Scoring\uff09\u201d\u903b\u8f91\uff0c\u56e0\u4e3a ColPali \u7684\u68c0\u7d22\u4e0d\u80fd\u7b80\u5355\u4f9d\u8d56\u5411\u91cf\u6570\u636e\u5e93\u7684 Cosine Similarity\u3002</p> <pre><code>import torch\nfrom PIL import Image\nfrom transformers import AutoProcessor, AutoModel, SiglipProcessor, SiglipModel\nfrom typing import List, Union\nimport numpy as np\n\nclass MultimodalIndexer:\n    \"\"\"\n    \u591a\u6a21\u6001\u7d22\u5f15\u5668\uff1a\u7edf\u4e00\u5c01\u88c5 SigLIP (\u81ea\u7136\u56fe) \u548c ColPali (\u6587\u6863\u56fe)\n    \"\"\"\n    def __init__(self, use_colpali: bool = False):\n        self.device = \"cuda\" if torch.cuda.is_available() else \"cpu\"\n        self.use_colpali = use_colpali\n\n        if self.use_colpali:\n             # [\u5173\u952e\u51b3\u7b56] \u4f7f\u7528 Merged \u7248\u672c\uff08\u5c06\u89c6\u89c9\u7f16\u7801\u5668\u548c\u8bed\u8a00\u6a21\u578b\u7b49\u7ec4\u4ef6\u5408\u5e76\u4e3a\u5355\u4e00 checkpoint\uff09\n             # \u8fd9\u6837\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u7edf\u4e00\u7684\u6a21\u578b\u6765\u52a0\u8f7d\u4e0e\u90e8\u7f72\uff0c\u4ece\u800c\u7b80\u5316\u63a8\u7406\u4e0e\u5de5\u7a0b\u96c6\u6210\u903b\u8f91\n            from colpali_engine.models import ColPali\n            from colpali_engine.utils.processing_utils import ColPaliProcessor\n\n            model_name = \"vidore/colpali-v1_2-merged\"\n            print(f\"Loading ColPali model: {model_name}...\")\n\n            self.model = ColPali.from_pretrained(\n                model_name, \n                torch_dtype=torch.bfloat16, \n                device_map=self.device\n            )\n            self.processor = ColPaliProcessor.from_pretrained(model_name)\n        else:\n            # \u52a0\u8f7d SigLIP\n            model_name = \"google/siglip-so400m-patch14-384\"\n            print(f\"Loading SigLIP model: {model_name}...\")\n            self.model = SiglipModel.from_pretrained(model_name).to(self.device)\n            self.processor = SiglipProcessor.from_pretrained(model_name)\n\n    def embed_images(self, image_paths: List[str]) -&gt; Union[np.ndarray, List[torch.Tensor]]:\n        \"\"\"Step 1: \u56fe\u7247\u5411\u91cf\u5316\"\"\"\n        images = [Image.open(p).convert(\"RGB\") for p in image_paths]\n        with torch.no_grad():\n            if self.use_colpali:\n                # ColPali: \u8fd4\u56de List[Tensor], \u6bcf\u4e2a Tensor \u5f62\u72b6\u4e3a (Num_Patches, 128)\n                batch_images = self.processor.process_images(images).to(self.device)\n                embeddings = self.model(**batch_images) \n                return list(embeddings) \n            else:\n                # SigLIP: \u8fd4\u56de (Batch, Hidden_Dim)\n                inputs = self.processor(images=images, return_tensors=\"pt\").to(self.device)\n                features = self.model.get_image_features(**inputs)\n                return (features / features.norm(p=2, dim=-1, keepdim=True)).cpu().numpy()\n\n    def embed_query(self, text: str):\n        \"\"\"Step 2: \u67e5\u8be2\u6587\u672c\u5411\u91cf\u5316\"\"\"\n        with torch.no_grad():\n            if self.use_colpali:\n                batch_text = self.processor.process_queries([text]).to(self.device)\n                return self.model(**batch_text) # \u8fd4\u56de (1, Query_Tokens, 128)\n            else:\n                inputs = self.processor(text=[text], return_tensors=\"pt\").to(self.device)\n                features = self.model.get_text_features(**inputs)\n                return features / features.norm(p=2, dim=-1, keepdim=True)\n\n    def score_colpali(self, query_emb: torch.Tensor, doc_embeddings_list: List[torch.Tensor]) -&gt; List[float]:\n        \"\"\"\n        Step 3: ColPali \u6838\u5fc3\u6253\u5206\u903b\u8f91 (Late Interaction / MaxSim)\n\n        Args:\n            query_emb: (1, Q_Tokens, Dim)\n            doc_embeddings_list: List of (D_Tokens, Dim) - \u6bcf\u9875 Patch \u6570\u53ef\u80fd\u4e0d\u540c\n        \"\"\"\n        scores = []\n        # \u79fb\u9664 Query \u7684 batch \u7ef4\u5ea6 -&gt; (Q_Tokens, Dim)\n        Q = query_emb.squeeze(0) \n\n        for D in doc_embeddings_list:\n            # 1. \u8ba1\u7b97\u4ea4\u4e92\u77e9\u9635 (Interaction Matrix): \n            # (Q_Tokens, Dim) @ (Dim, D_Tokens) -&gt; (Q_Tokens, D_Tokens)\n            # \u8fd9\u91cc\u4f7f\u7528 einsum \u66f4\u6e05\u6670\uff1aq=query tokens, d=doc patches, h=hidden dim\n            sim_matrix = torch.einsum(\"qh,dh-&gt;qd\", Q, D)\n\n            # 2. MaxSim: \u5bf9\u6bcf\u4e2a Query Token\uff0c\u5728\u6587\u6863\u6240\u6709 Patch \u4e2d\u627e\u6700\u76f8\u4f3c\u7684\n            max_sim_per_token = sim_matrix.max(dim=1).values\n\n            # 3. Sum: \u5c06\u6240\u6709 Query Token \u7684\u6700\u5927\u76f8\u4f3c\u5ea6\u6c42\u548c\uff0c\u5f97\u5230\u6700\u7ec8\u5206\u6570\n            score = max_sim_per_token.sum()\n            scores.append(score.item())\n\n        return scores\n\n# --- Usage Example ---\nif __name__ == \"__main__\":\n    indexer = MultimodalIndexer(use_colpali=True)\n    # \u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u6709\u4e86 embedding\n    # scores = indexer.score_colpali(q_emb, [doc_emb1, doc_emb2])\n    # top_k = np.argsort(scores)[::-1]\n</code></pre>"},{"location":"chapter5/5_2_mm_rag/#13_33-binary-quantization","title":"13_3.3 \u6027\u80fd\u4f18\u5316\uff1a\u4e8c\u8fdb\u5236\u91cf\u5316 (Binary Quantization)","text":"<p>ColPali \u6700\u5927\u7684\u5de5\u7a0b\u75db\u70b9\u662f\u5b58\u50a8\u7206\u70b8\u3002</p> <ul> <li>\u4f20\u7edf Embedding: 1 \u9875 = 1 \u5411\u91cf (4KB float32)\u3002</li> <li>ColPali: 1 \u9875 = 1032 \u5411\u91cf (512KB float16)\u3002</li> </ul> <p>\u5982\u679c\u7d22\u5f15 100 \u4e07\u9875 PDF\uff0c\u4f60\u9700\u8981 500GB \u663e\u5b58\uff0c\u8fd9\u5728\u5de5\u7a0b\u5b9e\u8df5\u4e2d\u901a\u5e38\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a\u4f7f\u7528\u4e8c\u8fdb\u5236\u91cf\u5316\uff08Binary Quantization\uff09\uff0c\u5c06 float16 \u538b\u7f29\u4e3a 1-bit\u3002</p> <pre><code>def quantize_embeddings(embeddings: torch.Tensor) -&gt; torch.Tensor:\n    \"\"\"\n    \u539f\u7406\uff1a\u5927\u4e8e 0 \u7684\u7f6e\u4e3a 1\uff0c\u5c0f\u4e8e\u7b49\u4e8e 0 \u7684\u7f6e\u4e3a 0\u3002\n    \u5b58\u50a8\u538b\u7f29\u7387\uff1a32x (float32 -&gt; int1)\n    \u7cbe\u5ea6\u635f\u5931\uff1aRecall@5 \u4e0b\u964d\u4e0d\u5230 2%\n    \"\"\"\n    # \u7b80\u5355\u7684\u4e8c\u503c\u5316\n    binary_emb = (embeddings &gt; 0).float() \n\n    # \u5b9e\u9645\u5b58\u50a8\u65f6\u53ef\u4ee5\u4f7f\u7528 packbits \u538b\u7f29\u4e3a uint8\n    # packed = np.packbits(binary_emb.cpu().numpy().astype(np.uint8), axis=-1)\n\n    return binary_emb\n\ndef score_binary(query_emb, binary_doc_emb):\n    \"\"\"\n    \u4e8c\u8fdb\u5236\u5411\u91cf\u7684\u6253\u5206\u901a\u5e38\u4f7f\u7528 Hamming Distance \u6216 Bitwise Operations\n    \u4f46\u5728 ColPali \u4e2d\uff0c\u901a\u5e38\u4fdd\u7559 Query \u4e3a float\uff0c\u53ea\u91cf\u5316 Doc\uff0c\n    \u6b64\u65f6\u70b9\u79ef\u8ba1\u7b97\u53d8\u6210\u7b80\u5355\u7684\u52a0\u51cf\u6cd5\uff0c\u6781\u5927\u52a0\u901f\u8ba1\u7b97\u3002\n    \"\"\"\n    pass \n</code></pre> <p>\u67b6\u6784\u51b3\u7b56\uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u4f7f\u7528\u652f\u6301 Binary Vector \u7684\u6570\u636e\u5e93\uff08\u5982 Qdrant, Vespa\uff09\u6216\u4e13\u7528\u7d22\u5f15\u5e93\uff08\u5982 USearch\uff09\uff0c\u5b83\u4eec\u80fd\u5728\u5e95\u5c42\u76f4\u63a5\u5229\u7528 CPU \u6307\u4ee4\u96c6\uff08AVX-512 POPCNT\uff09\u8fdb\u884c\u6781\u901f\u5339\u914d\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_4-performance-evaluation","title":"13_4 \u6027\u80fd\u4e0e\u8bc4\u4f30 (Performance &amp; Evaluation)","text":"<p>\u591a\u6a21\u6001 RAG \u4e0d\u4ec5\u8981\u770b\u201c\u627e\u5f97\u5bf9\u4e0d\u5bf9\u201d\uff0c\u8fd8\u8981\u770b\u201c\u56e0\u4e3a\u4ec0\u4e48\u627e\u5230\u7684\u201d\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_41","title":"13_4.1 \u8bc4\u4ef7\u6307\u6807","text":"\u6307\u6807 \u9002\u7528\u573a\u666f \u8bf4\u660e Recall@K \u901a\u7528\u68c0\u7d22 \u524d K \u4e2a\u7ed3\u679c\u4e2d\u5305\u542b\u6b63\u786e\u56fe\u7247\u7684\u6982\u7387\u3002 NDCG@10 \u6392\u5e8f\u8d28\u91cf \u8d8a\u76f8\u5173\u7684\u56fe\u7247\u6392\u5728\u8d8a\u524d\u9762\u5f97\u5206\u8d8a\u9ad8\u3002 OCR-Free Efficiency ColPali \u573a\u666f \u76f8\u6bd4 OCR + Dense Retrieval \u65b9\u6848\u7684\u65f6\u95f4/\u6210\u672c\u8282\u7701\u6bd4\u7387\u3002"},{"location":"chapter5/5_2_mm_rag/#13_42-benchmarks","title":"13_4.2 \u57fa\u51c6\u6d4b\u8bd5 (Benchmarks)","text":"<ul> <li>\u6d4b\u8bd5\u73af\u5883\uff1a Intel Xeon Gold 6226R, NVIDIA RTX 3090 \u3002</li> <li>\u6570\u636e\u96c6\uff1aViDoRe Benchmark\uff08\u5305\u542b\u590d\u6742\u8d22\u52a1\u62a5\u8868\uff09\u3002</li> </ul>"},{"location":"chapter5/5_2_mm_rag/#1-recall5","title":"1. \u51c6\u786e\u7387\u5bf9\u6bd4 (Recall@5)","text":"<ul> <li>Unstructured OCR + BGE-M3: 43% (\u8868\u683c\u7ed3\u6784\u4e22\u5931\u662f\u4e3b\u56e0)\u3002</li> <li>ColPali v1_2: 81% (\u76f4\u63a5\u7406\u89e3\u89c6\u89c9\u5e03\u5c40)\u3002</li> </ul>"},{"location":"chapter5/5_2_mm_rag/#2-latency","title":"2. \u5ef6\u8fdf\u5bf9\u6bd4 (Latency)","text":"<ul> <li>SigLIP (Dense): &lt; 20ms / query\u3002</li> <li>ColPali (Late Interaction): ~150ms / query\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aColPali \u9002\u5408\u505a Re-rank \u6216\u9ad8\u8d28\u91cf\u68c0\u7d22\uff0c\u6d77\u91cf\u6570\u636e\u9700\u914d\u5408\u91cf\u5316\u4f7f\u7528\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_43","title":"13_4.3 \u53ef\u89e3\u91ca\u6027\uff1a\u6a21\u578b\u5230\u5e95\u5728\u770b\u54ea\u91cc\uff1f","text":"<p>ColPali \u7684\u53e6\u4e00\u5927\u4f18\u52bf\u662f\u53ef\u89e3\u91ca\u6027\u3002\u901a\u8fc7\u5c06 MaxSim \u8ba1\u7b97\u4e2d\u7684\u4ea4\u4e92\u77e9\u9635\u53ef\u89c6\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u751f\u6210\u70ed\u529b\u56fe\uff0c\u786e\u5207\u77e5\u9053\u6a21\u578b\u5173\u6ce8\u7684\u662f\u6587\u6863\u7684\u54ea\u4e00\u90e8\u5206\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#13_5","title":"13_5 \u5e38\u89c1\u8bef\u533a\u4e0e\u907f\u5751\u6307\u5357","text":"<ul> <li>\u8bef\u533a\u4e00\uff1a\u201c\u6240\u6709\u56fe\u7247\u90fd\u503c\u5f97\u7d22\u5f15\u201d</li> <li>\u7f51\u9875\u6216\u6587\u6863\u4e2d\u7684 Icon\u3001\u88c5\u9970\u6027\u7ebf\u6761\u3001\u9875\u7709\u9875\u811a\u7684 Logo \u4f1a\u4ea7\u751f\u5927\u91cf\u566a\u97f3\u3002</li> <li> <p>\u4fee\u6b63\uff1a\u5728\u5165\u5e93\u524d\u589e\u52a0\u4e00\u4e2a\u201c\u5783\u573e\u56fe\u7247\u5206\u7c7b\u5668\u201d\u6216\u57fa\u4e8e\u89c4\u5219\u7684\u8fc7\u6ee4\u5668\uff08\u5982\u4e22\u5f03 &lt; 5KB \u6216\u957f\u5bbd\u6bd4\u6781\u7aef\u7684\u56fe\u7247\uff09\u3002</p> </li> <li> <p>\u8bef\u533a\u4e8c\uff1a\u201c\u5ffd\u89c6 Embedding \u7ef4\u5ea6\u7206\u70b8\u201d</p> </li> <li>\u4e0d\u8981\u5929\u771f\u5730\u628a ColPali \u7684\u6240\u6709\u5411\u91cf\u76f4\u63a5\u5b58\u5165\u5e38\u89c4 PGVector\u3002</li> <li> <p>\u4fee\u6b63\uff1a\u5fc5\u987b\u5b9e\u65bd 13_3.3 \u4e2d\u7684\u4e8c\u8fdb\u5236\u91cf\u5316\u3002\u6216\u8005\uff0c\u4ec5\u5bf9\u590d\u6742\u7684\u201c\u5173\u952e\u9875\u201d\u4f7f\u7528 ColPali\uff0c\u666e\u901a\u6587\u672c\u9875\u4f9d\u7136\u4f7f\u7528 BGE/OpenAI Embedding\uff0c\u6784\u5efa\u6df7\u5408\u7d22\u5f15\u3002</p> </li> <li> <p>\u8bef\u533a\u4e09\uff1a\u201c\u76f4\u63a5\u7528 CLIP \u505a OCR \u66ff\u4ee3\u54c1\u201d</p> </li> <li>CLIP \u77e5\u9053\u56fe\u7247\u91cc\u6709\u201c\u6587\u5b57\u201d\uff0c\u4f46\u5b83\u8bfb\u4e0d\u61c2\u957f\u6587\u672c\u3002\u5982\u679c\u4f60\u95ee\u5b83\u201c\u5408\u540c\u91cc\u7684\u7532\u65b9\u662f\u8c01\uff1f\u201d\uff0c\u6807\u51c6 CLIP \u901a\u5e38\u56de\u7b54\u4e0d\u4e86\u3002</li> <li>\u4fee\u6b63\uff1a\u5bf9\u4e8e\u6587\u5b57\u5bc6\u96c6\u578b\u4e14\u65e0\u590d\u6742\u6392\u7248\u7684\u56fe\u7247\uff0cOCR + LLM \u4f9d\u7136\u662f\u6027\u4ef7\u6bd4\u6700\u9ad8\u7684\u65b9\u6848\uff1bColPali \u9002\u7528\u4e8e\u201c\u6392\u7248\u5373\u8bed\u4e49\u201d\u7684\u573a\u666f\uff08\u5982\u590d\u6742\u7684\u5d4c\u5957\u8868\u683c\uff09\u3002</li> </ul>"},{"location":"chapter5/5_2_mm_rag/#_3","title":"\u672c\u7ae0\u5c0f\u7ed3","text":"<p>\u591a\u6a21\u6001 RAG \u5c06\u6211\u4eec\u7684\u89c6\u91ce\u4ece\u4e00\u7ef4\u7684\u6587\u672c\u6269\u5c55\u5230\u4e86\u4e8c\u7ef4\u7684\u89c6\u89c9\u7a7a\u95f4\u3002</p> <ul> <li>\u67b6\u6784\uff1a\u91c7\u7528 SigLIP \u5904\u7406\u81ea\u7136\u56fe\uff0cColPali \u5904\u7406\u6587\u6863\u56fe\u3002</li> <li>\u4ee3\u7801\uff1a\u6838\u5fc3\u5728\u4e8e MaxSim \u7684\u4ea4\u4e92\u5f0f\u6253\u5206\uff0c\u800c\u975e\u7b80\u5355\u7684\u70b9\u79ef\u3002</li> <li>\u4f18\u5316\uff1a\u4e8c\u8fdb\u5236\u91cf\u5316 (BQ) \u662f\u591a\u6a21\u6001 RAG \u80fd\u591f\u5927\u89c4\u6a21\u4e0a\u7ebf\u7684\u5173\u952e\u6280\u672f\u3002</li> </ul> <p>\u638c\u63e1\u4e86\u8fd9\u4e00\u7ae0\uff0c\u4f60\u7684 RAG \u7cfb\u7edf\u5c31\u4e0d\u518d\u662f\u4e00\u4e2a\u201c\u778e\u5b50\u201d\uff0c\u800c\u662f\u4e00\u4e2a\u80fd\u591f\u8bfb\u56fe\u8868\u3001\u770b\u7814\u62a5\u7684\u201c\u5168\u80fd\u4e13\u5bb6\u201d\u3002</p>"},{"location":"chapter5/5_2_mm_rag/#_4","title":"\u5ef6\u4f38\u9605\u8bfb","text":"<ul> <li>\u8bba\u6587\uff1aColPali: Efficient Document Retrieval with Vision Language Models (2024)\u3002</li> <li>\u5de5\u5177\uff1a<code>colpali_engine</code> \u5b98\u65b9\u5e93\uff0c\u5173\u6ce8\u5176\u5bf9 Qdrant/Weaviate \u7684\u539f\u751f\u652f\u6301\u66f4\u65b0\u3002</li> <li>\u8fdb\u9636\uff1a\u4e86\u89e3 Matryoshka Representation Learning (MRL)\uff0c\u8fdb\u4e00\u6b65\u538b\u7f29\u5411\u91cf\u7ef4\u5ea6\u3002</li> </ul>"},{"location":"chapter6/6_1_mini_c4/","title":"\u9879\u76ee\u4e00\uff1a\u6784\u5efa\"Mini-C4\u201d\u9884\u8bad\u7ec3\u96c6","text":""},{"location":"chapter6/6_1_mini_c4/#1-project-brief","title":"1. \u9879\u76ee\u80cc\u666f (Project Brief)","text":"<ul> <li>\u4efb\u52a1\u5b9a\u4e49\uff1a \u6784\u5efa\u4e00\u4e2a\u5fae\u7f29\u7248 C4 (Colossal Clean Crawled Corpus) \u6570\u636e\u96c6\u6d41\u6c34\u7ebf\u3002\u6211\u4eec\u7684\u76ee\u6807\u662f\u5c06\u6742\u4e71\u65e0\u7ae0\u7684\u539f\u59cb\u7f51\u9875\u6570\u636e\uff08Common Crawl\uff09\u8f6c\u5316\u4e3a\u4f4e\u566a\u3001\u53bb\u91cd\u3001\u9ad8\u8d28\u91cf\u7684\u7eaf\u6587\u672c\u6570\u636e\uff0c\u53ef\u76f4\u63a5\u7528\u4e8e\u5927\u6a21\u578b\u9884\u8bad\u7ec3\u3002</li> <li>\u8f93\u5165\u4e0e\u8f93\u51fa\uff1a<ul> <li>Input: Common Crawl \u7684\u539f\u59cb WARC \u538b\u7f29\u5305\uff08\u5305\u542b HTTP \u54cd\u5e94\u5934\u3001HTML \u6e90\u7801\u3001\u4e71\u7801\u7b49\uff09\u3002</li> <li>Output: \u5206\u7c7b\u5206\u7ea7\u540e\u7684 JSONL \u6587\u4ef6\uff08\u5982 <code>data_en.jsonl</code>, <code>final_data.jsonl</code>\uff09\uff0c\u5305\u542b\u7eaf\u51c0\u6587\u672c\u53ca\u5176\u8d28\u91cf\u8bc4\u5206\u3002</li> </ul> </li> <li>\u96be\u70b9\u5206\u6790\uff1a<ul> <li>\u4fe1\u566a\u6bd4\u6781\u4f4e\uff1a \u539f\u59cb\u7f51\u9875\u4e2d 90% \u4ee5\u4e0a\u662f\u5bfc\u822a\u680f\u3001\u5e7f\u544a\u3001JavaScript \u4ee3\u7801\u548c\u65e0\u610f\u4e49\u7684\u5360\u4f4d\u7b26\u3002</li> <li>\u8ba1\u7b97\u5bc6\u96c6\uff1a \u5728\u5927\u89c4\u6a21\u8bed\u6599\u4e2d\u8fdb\u884c\u4e24\u4e24\u6bd4\u5bf9\u53bb\u91cd\uff08Deduplication\uff09\u6781\u5176\u6d88\u8017\u8d44\u6e90\u3002</li> <li>\u8d28\u91cf\u91cf\u5316\uff1a \u5982\u4f55\u8ba9\u673a\u5668\u81ea\u52a8\u5224\u65ad\u4e00\u53e5\u8bdd\u662f\"\u4eba\u7c7b\u9ad8\u8d28\u91cf\u8bed\u8a00\u201d\u8fd8\u662f\"\u673a\u5668\u751f\u6210\u7684\u5783\u573e\u201d\uff1f</li> </ul> </li> </ul>"},{"location":"chapter6/6_1_mini_c4/#2-architecture-design","title":"2. \u67b6\u6784\u8bbe\u8ba1 (Architecture Design)","text":"<p>\u4e3a\u4e86\u5904\u7406\u975e\u7ed3\u6784\u5316\u7684 Web \u6570\u636e\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u5982\u4e0b\u7684\u6f0f\u6597\u578b\uff08Funnel\uff09\u5904\u7406\u67b6\u6784\uff1a</p> <p>\u6570\u636e\u6d41\u6c34\u7ebf\u56fe\uff1a</p> <p></p> <p>\u6280\u672f\u6808\u6e05\u5355\uff1a</p> <ul> <li>\u89e3\u6790\u5c42\uff1aTrafilatura<ul> <li>\u51b3\u7b56\u7406\u7531\uff1a \u76f8\u6bd4\u4f20\u7edf\u7684 BeautifulSoup\uff0cTrafilatura \u4e13\u4e3a\u7f51\u9875\u6b63\u6587\u63d0\u53d6\u4f18\u5316\uff0c\u80fd\u81ea\u52a8\u53bb\u9664\u5bfc\u822a\u3001\u9875\u811a\u548c\u6837\u677f\u6587\u5b57\uff0c\u63d0\u53d6\u6548\u7387\u548c\u51c6\u786e\u7387\u66f4\u9ad8\u3002</li> </ul> </li> <li>\u8ba1\u7b97\u5c42\uff1aRay<ul> <li>\u51b3\u7b56\u7406\u7531\uff1a Python \u539f\u751f\u591a\u8fdb\u7a0b\u5904\u7406\u5927\u6570\u636e\u8f83\u4e3a\u5403\u529b\u3002Ray \u63d0\u4f9b\u4e86\u6781\u5176\u7b80\u5355\u7684\u5206\u5e03\u5f0f\u539f\u8bed\uff0c\u80fd\u8ba9\u6211\u4eec\u7528\u51e0\u884c\u4ee3\u7801\u5c06 MinHash \u8ba1\u7b97\u5e76\u884c\u5316\u5230\u591a\u6838 CPU \u751a\u81f3\u96c6\u7fa4\u4e0a\u3002</li> </ul> </li> <li>\u8d28\u91cf\u5c42\uff1aKenLM<ul> <li>\u51b3\u7b56\u7406\u7531\uff1a \u8fd9\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 N-gram \u8bed\u8a00\u6a21\u578b\u5e93\u3002\u5728 GPT-3 \u548c CCNet \u7684\u8bba\u6587\u4e2d\uff0c\u5747\u4f7f\u7528 KenLM \u7684\u56f0\u60d1\u5ea6\uff08Perplexity\uff09\u4f5c\u4e3a\u8861\u91cf\u6587\u672c\u81ea\u7136\u5ea6\u7684\u6838\u5fc3\u6307\u6807\u3002</li> </ul> </li> </ul>"},{"location":"chapter6/6_1_mini_c4/#3-step-by-step-implementation","title":"3. Step-by-Step \u5b9e\u6218 (Implementation)","text":""},{"location":"chapter6/6_1_mini_c4/#html-extraction-cleaning","title":"\u9636\u6bb5\u4e00\uff1a\u4ece HTML \u6ce5\u6f6d\u4e2d\u63d0\u53d6\u6b63\u6587 (Extraction &amp; Cleaning)","text":"<p>\u539f\u59cb WARC \u6587\u4ef6\u5305\u542b\u5927\u91cf\u975e\u6587\u672c\u566a\u58f0\u3002\u6211\u4eec\u9996\u5148\u4f7f\u7528 <code>warcio</code> \u6d41\u5f0f\u8bfb\u53d6\u538b\u7f29\u5305\uff0c\u5e76\u5229\u7528 <code>trafilatura</code> \u63d0\u53d6\u6838\u5fc3\u5185\u5bb9\u3002\u968f\u540e\uff0c\u5e94\u7528\u542f\u53d1\u5f0f\u89c4\u5219\u8fdb\u884c\u521d\u7b5b\u3002</p> <p>\u6838\u5fc3\u4ee3\u7801\uff1a\u89e3\u6790\u4e0e\u542f\u53d1\u5f0f\u6e05\u6d17</p> <pre><code>import trafilatura\nfrom warcio.archiveiterator import ArchiveIterator\n\n# 1. \u63d0\u53d6\u903b\u8f91 (\u6765\u81ea 2_process_warc.py)\ndef extract_text(content_stream):\n    text = trafilatura.extract(\n        content_stream, \n        include_comments=False, \n        include_tables=False\n    )\n    return text\n\n# 2. \u542f\u53d1\u5f0f\u6e05\u6d17\u89c4\u5219 (\u6765\u81ea 3_clean_data.py)\ndef is_high_quality(text):\n    # \u89c4\u5219 A: \u957f\u5ea6\u4e0e\u5e73\u5747\u8bcd\u957f\u8fc7\u6ee4\n    words = text.split()\n    if not words:\n        # \u7a7a\u6587\u672c\u6216\u4ec5\u5305\u542b\u7a7a\u767d\u5b57\u7b26\uff0c\u89c6\u4e3a\u4f4e\u8d28\u91cf\n        return False\n    mean_word_len = sum(len(w) for w in words) / len(words)\n    if mean_word_len &gt; 15: # \u8bcd\u592a\u957f\u901a\u5e38\u662f\u4e71\u7801\u6216\u4ee3\u7801\n        return False\n\n    # \u89c4\u5219 B: \u7b26\u53f7\u5bc6\u5ea6 (Symbol Ratio)\n    code_symbols = {'{', '}', '[', ']', '&lt;', '&gt;', '\\\\'}\n    symbol_count = sum(1 for char in text if char in code_symbols)\n    if len(text) &gt; 0 and (symbol_count / len(text) &gt; 0.1): # \u4ee3\u7801\u7b26\u53f7\u8fc7\u591a\n        return False\n\n    # \u89c4\u5219 C: \u9ed1\u540d\u5355\u5173\u952e\u8bcd\n    bad_phrases = [\"lorem ipsum\", \"enable cookies\", \"403 forbidden\"]\n    if any(p in text.lower() for p in bad_phrases):\n        return False\n\n    return True\n</code></pre>"},{"location":"chapter6/6_1_mini_c4/#minhash-deduplication","title":"\u9636\u6bb5\u4e8c\uff1a\u5206\u5e03\u5f0f MinHash \u53bb\u91cd (Deduplication)","text":"<p>\u4e92\u8054\u7f51\u4e0a\u5b58\u5728\u5927\u91cf\u91cd\u590d\u5185\u5bb9\uff08\u8f6c\u8f7d\u3001\u955c\u50cf\uff09\u3002\u6211\u4eec\u4f7f\u7528 Ray \u5b9e\u73b0\u5e76\u884c\u7684 MinHash \u8ba1\u7b97\uff0c\u7ed3\u5408 LSH\uff08\u5c40\u90e8\u654f\u611f\u54c8\u5e0c\uff09\u5c06 \\(O(N^2)\\) \u7684\u590d\u6742\u5ea6\u964d\u4f4e\u5230 \\(O(N)\\)\u3002</p> <p>\u6838\u5fc3\u4ee3\u7801\uff1aRay \u5e76\u884c\u8ba1\u7b97\u7b7e\u540d</p> <pre><code>import ray\nfrom datasketch import MinHash\n\n# \u521d\u59cb\u5316 Ray \u5229\u7528\u6240\u6709 CPU \u6838\u5fc3\nray.init()\n\n@ray.remote\ndef process_batch(lines, num_perm=128):\n    \"\"\"Ray Worker: \u5e76\u884c\u8ba1\u7b97\u4e00\u6279\u6570\u636e\u7684 MinHash \u6307\u7eb9\"\"\"\n    results = []\n    for line in lines:\n        item = json.loads(line)\n        m = MinHash(num_perm=num_perm)\n        # Shingling: \u6309\u5355\u8bcd\u66f4\u65b0\u54c8\u5e0c\n        for w in item['text'].split():\n            m.update(w.encode('utf8'))\n        results.append((item['url'], m, item['text']))\n    return results\n\n# \u4e3b\u6d41\u7a0b\uff1aMap-Reduce \u98ce\u683c\n# Map: \u5206\u53d1\u8ba1\u7b97\u4efb\u52a1\nfutures = [process_batch.remote(batch) for batch in batches]\n# Reduce: \u6536\u96c6\u7ed3\u679c\u5e76\u6784\u5efa LSH \u7d22\u5f15\nresults = ray.get(futures)\n# ...\u540e\u7eed\u63a5 MinHashLSH \u7d22\u5f15\u6784\u5efa...\n</code></pre>"},{"location":"chapter6/6_1_mini_c4/#quality-filtering","title":"\u9636\u6bb5\u4e09\uff1a\u8bed\u8a00\u8bc6\u522b\u4e0e\u56f0\u60d1\u5ea6\u8fc7\u6ee4 (Quality Filtering)","text":"<p>\u6e05\u6d17\u540e\u7684\u6570\u636e\u6df7\u5408\u4e86\u591a\u79cd\u8bed\u8a00\u4e14\u8d28\u91cf\u53c2\u5dee\u4e0d\u9f50\u3002\u6211\u4eec\u5148\u7528 FastText \u5206\u6d41\u8bed\u8a00\uff0c\u518d\u7528 KenLM \u8ba1\u7b97\u56f0\u60d1\u5ea6\uff08Perplexity\uff09\u3002\u56f0\u60d1\u5ea6\u8d8a\u4f4e\uff0c\u4ee3\u8868\u53e5\u5b50\u8d8a\u901a\u987a\u3001\u8d8a\u50cf\"\u4eba\u8bdd\u201d\u3002</p> <p>\u6838\u5fc3\u4ee3\u7801\uff1aKenLM \u8bc4\u5206</p> <pre><code>import kenlm\nimport fasttext\n\n# 1. \u8bed\u8a00\u5206\u6d41 (\u6765\u81ea 5_split_lang.py)\nlid_model = fasttext.load_model('lid.176.ftz')\ndef predict_lang(text):\n    # k=1 \u53d6\u6982\u7387\u6700\u9ad8\u7684\u8bed\u8a00\n    predictions = lid_model.predict(text, k=1)\n    return predictions[0][0].replace('__label__', '')\n\n# 2. \u56f0\u60d1\u5ea6\u8fc7\u6ee4 (\u6765\u81ea 6_quality_filter.py)\nkenlm_model = kenlm.Model('en.arpa.bin')\nPERPLEXITY_THRESHOLD = -6_0  # \u7ecf\u9a8c\u9608\u503c\uff1a\u4f4e\u4e8e\u6b64\u503c\u901a\u5e38\u4e3a\u4f4e\u8d28\u91cf\u6587\u672c\n\ndef filter_by_perplexity(text):\n    words = text.split()\n    if not words:\n        # \u7a7a\u6587\u672c\u89c6\u4e3a\u4f4e\u8d28\u91cf\uff0c\u907f\u514d\u9664\u96f6\u9519\u8bef\n        return False, -10.0\n    # \u8ba1\u7b97\u5f52\u4e00\u5316\u5f97\u5206 (Log Score / Length)\n    log_score = kenlm_model.score(text)\n    normalized_score = log_score / len(words)\n\n    if normalized_score &gt; PERPLEXITY_THRESHOLD:\n        return True, normalized_score\n    return False, normalized_score\n</code></pre>"},{"location":"chapter6/6_1_mini_c4/#4-showcase","title":"4. \u6548\u679c\u5c55\u793a (Showcase)","text":"<p>\u7ecf\u8fc7\u8fd9\u4e00\u5957 Pipeline \u5904\u7406\uff0c\u6570\u636e\u7684\u9762\u8c8c\u53d1\u751f\u4e86\u6839\u672c\u6027\u53d8\u5316\uff1a</p> <p>Case 1: \u5bfc\u822a\u680f\u566a\u58f0 (\u5df2\u53bb\u9664)</p> <p>Raw: \"Home | About Us | Contact | Enable Cookies | Copyright 2023...\" Result: [\u5df2\u4e22\u5f03] (\u89e6\u53d1\u77ed\u6587\u672c\u548c\u5173\u952e\u8bcd\u9ed1\u540d\u5355\u89c4\u5219)</p> <p>Case 2: \u4ee3\u7801\u7247\u6bb5 (\u5df2\u53bb\u9664)</p> <p>Raw: \"function(x) { return x &gt; 0 ? true : false; } var a = [1,2,3];\" Result: [\u5df2\u4e22\u5f03] (\u89e6\u53d1\u7b26\u53f7\u5bc6\u5ea6 &gt; 10% \u89c4\u5219)</p> <p>Case 3: \u9ad8\u8d28\u91cf\u6b63\u6587 (\u4fdd\u7559\u5e76\u8bc4\u5206)</p> <p>Raw: \"The James Webb Space Telescope has captured a new image of the Pillars of Creation...\" Result: [\u4fdd\u7559] KenLM Score: -4_82 (\u4f18\u4e8e\u9608\u503c -6_0)</p> <p>\u6570\u636e\u7edf\u8ba1\uff1a \u5728\u5355\u6b21 Crawl \u7684\u91c7\u6837\u6d4b\u8bd5\u4e2d\uff1a *   \u539f\u59cb\u8bb0\u5f55\uff1a 10,000 \u6761 *   \u63d0\u53d6\u6709\u6548\u6587\u672c\uff1a \u7ea6 4,500 \u6761 (HTML \u89e3\u6790\u635f\u8017) *   \u6e05\u6d17\u540e\u5269\u4f59\uff1a \u7ea6 2,800 \u6761 (\u542f\u53d1\u5f0f\u8fc7\u6ee4\u635f\u8017) *   \u53bb\u91cd\u540e\u5269\u4f59\uff1a \u7ea6 2,100 \u6761 (\u91cd\u590d\u7387\u7ea6 25%) *   \u6700\u7ec8\u9ad8\u8d28\u91cf\u96c6\uff1a \u7ea6 1,800 \u6761 (KenLM \u8fc7\u6ee4)</p>"},{"location":"chapter6/6_1_mini_c4/#5-cost-optimization","title":"5. \u6210\u672c\u4e0e\u4f18\u5316 (Cost &amp; Optimization)","text":"<ul> <li> <p>\u8d44\u6e90\u6d88\u8017\uff1a</p> <ul> <li>\u8ba1\u7b97\uff1a \u672c\u9879\u76ee\u4ee3\u7801\u5728\u5355\u673a 16\u6838 CPU\u300164G \u5185\u5b58\u73af\u5883\u4e0b\uff0c\u5904\u7406 1GB WARC \u6570\u636e\u8017\u65f6\u7ea6 5-8 \u5206\u949f\u3002</li> <li>\u74f6\u9888\uff1a <code>MinHashLSH</code> \u7684\u7d22\u5f15\u6784\u5efa\u76ee\u524d\u662f\u5355\u7ebf\u7a0b\u7684\uff08\u5728 <code>4_deduplicate.py</code> \u4e2d\uff09\uff0c\u4e14\u5b8c\u5168\u4f9d\u8d56\u5185\u5b58\u3002</li> </ul> </li> <li> <p>\u6269\u5c55\u6027\u601d\u8003 (Scaling to TBs)\uff1a     \u5982\u679c\u6570\u636e\u91cf\u6269\u5927\u5230 PB \u7ea7\u522b\uff08\u5982\u771f\u5b9e\u7684 C4 \u6570\u636e\u96c6\uff09\uff0c\u5f53\u524d\u67b6\u6784\u9700\u8981\u5347\u7ea7\uff1a</p> <ol> <li>LSH \u5b58\u50a8\uff1a \u4e0d\u80fd\u518d\u4f7f\u7528\u5185\u5b58\u7248 <code>MinHashLSH</code>\uff0c\u9700\u6539\u7528 Redis \u6216 Cassandra \u5b58\u50a8\u54c8\u5e0c\u6876\u3002</li> <li>\u5e76\u884c\u7b56\u7565\uff1a \u5c06 Ray \u4efb\u52a1\u4ece\"\u5355\u673a\u591a\u6838\u201d\u6269\u5c55\u5230\"\u591a\u673a\u96c6\u7fa4\u201d\u3002</li> <li>IO \u4f18\u5316\uff1a \u6570\u636e\u8bfb\u53d6\u9700\u4ece\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u8fc1\u79fb\u81f3 S3\uff0c\u5e76\u4f7f\u7528 PyArrow \u8fdb\u884c\u6d41\u5f0f\u5217\u5b58\u5904\u7406\u3002</li> </ol> </li> </ul>"},{"location":"chapter6/6_2_legal_sft/","title":"\u9879\u76ee\u4e8c\uff1a\u5782\u76f4\u9886\u57df\u4e13\u5bb6 SFT (\u6cd5\u5f8b)","text":"<p>\u573a\u666f\uff1a\u57fa\u4e8e\u975e\u7ed3\u6784\u5316 PDF \u6587\u6863\u6784\u5efa\u884c\u4e1a\u4e13\u5bb6\u5fae\u8c03\u6570\u636e\u3002 \u6838\u5fc3\u6280\u672f\uff1aSelf-Instruct \u6784\u9020\u6307\u4ee4\u3001CoT \u63a8\u7406\u589e\u5f3a\u3001\u6570\u636e\u591a\u6837\u6027\u5e73\u8861\u3002 \u8f93\u51fa\uff1a<code>domain_expert.jsonl</code> \u6307\u4ee4\u5fae\u8c03\u96c6\u3002</p>"},{"location":"chapter6/6_2_legal_sft/#1-project-brief","title":"1. \u9879\u76ee\u80cc\u666f (Project Brief)","text":"<ul> <li>\u4efb\u52a1\u5b9a\u4e49\uff1a \u4ece\u975e\u7ed3\u6784\u5316\u7684\u6cd5\u5f8b\u6cd5\u89c4 PDF \u6587\u6863\u4e2d\u63d0\u53d6\u77e5\u8bc6\uff0c\u5229\u7528\u5927\u6a21\u578b Self-Instruct \u6280\u672f\u6784\u5efa\u5177\u5907\"\u601d\u7ef4\u94fe\uff08CoT\uff09\"\u80fd\u529b\u7684\u5782\u76f4\u9886\u57df\u6307\u4ee4\u5fae\u8c03\u6570\u636e\u96c6\u3002</li> <li>\u8f93\u5165\u4e0e\u8f93\u51fa\uff1a</li> <li>Input: \u539f\u59cb PDF \u6587\u6863\uff08\u5982\u300a\u6c11\u6cd5\u5178\u300b\u3001\u300a\u5211\u6cd5\u300b\u7b49\uff0c\u5305\u542b\u9875\u7709\u3001\u9875\u811a\u3001\u6c34\u5370\u5e72\u6270\uff09\u3002</li> <li>Output: <code>domain_expert.jsonl</code>\uff0c\u5305\u542b Instruction\uff08\u7528\u6237\u6307\u4ee4\uff09\u4e0e Output\uff08\u5305\u542b\u601d\u8003\u8fc7\u7a0b\u7684\u4e13\u5bb6\u56de\u590d\uff09\u3002</li> <li>\u96be\u70b9\u5206\u6790\uff1a</li> <li>PDF \u566a\u97f3\u6e05\u6d17\uff1a\u6cd5\u5f8b\u6587\u6863\u4e2d\u5e38\u89c1\u7684\u5f15\u7528\u6807\u53f7\uff08\u5982 <code>[1]</code>\uff09\u3001\u88ab\u6362\u884c\u7b26\u5207\u65ad\u7684\u4e2d\u6587\u8bcd\u6c47\uff08\u5982<code>\u6cd5 \u5f8b</code>\uff09\u3001\u4ee5\u53ca\u5d4c\u5165\u6b63\u6587\u7684\u9875\u7801\uff08\u5982 <code>- 195 -</code>\uff09\u6781\u96be\u6e05\u7406\u3002</li> <li>\u6570\u636e\u5355\u4e00\u6027\uff1a\u7b80\u5355\u7684\"\u6cd5\u6761\u89e3\u91ca\"\u4e0d\u8db3\u4ee5\u8bad\u7ec3\u4e13\u5bb6\u6a21\u578b\uff0c\u9700\u8981\u6784\u9020\u590d\u6742\u7684\u6848\u60c5\u5206\u6790\u3001\u6587\u4e66\u5199\u4f5c\u7b49\u591a\u6837\u5316\u4efb\u52a1\u3002</li> <li>\u63a8\u7406\u80fd\u529b\u7f3a\u5931\uff1a\u666e\u901a QA \u5bf9\u7f3a\u4e4f\u903b\u8f91\u63a8\u5bfc\uff0c\u9700\u5f3a\u5236\u6a21\u578b\u751f\u6210 CoT\uff08Chain of Thought\uff09\u3002</li> </ul> <p>### 2. \u67b6\u6784\u8bbe\u8ba1 (Architecture Design)</p> <p>\u6570\u636e\u6d41\u6c34\u7ebf\u56fe\uff1a</p> <p></p> <ul> <li>\u6280\u672f\u6808\u6e05\u5355\uff1a</li> <li>PDF \u89e3\u6790 (pdfplumber)\uff1a\u76f8\u6bd4 PyPDF2\uff0cpdfplumber \u63d0\u4f9b\u66f4\u7cbe\u51c6\u7684 Bounding Box \u63a7\u5236\uff0c\u65b9\u4fbf\u5207\u9664\u9875\u7709\u9875\u811a\uff08\u4ee3\u7801\u4e2d\u8bbe\u5b9a\u5207\u9664\u4e0a\u4e0b 5%\uff09\u3002</li> <li>\u6e05\u6d17\u5f15\u64ce (Regex)\uff1a\u9488\u5bf9\u4e2d\u6587\u65ad\u8bcd\u548c\u5f15\u7528\u6807\u53f7\u7684\"\u80f6\u6c34\u4ee3\u7801\"\uff0c\u662f\u63d0\u5347\u6570\u636e\u8d28\u91cf\u7684\u5173\u952e\u3002</li> <li>\u751f\u6210\u6a21\u578b (DeepSeek-V3)\uff1a\u5229\u7528\u5176\u5f3a\u5927\u7684\u903b\u8f91\u63a8\u7406\u80fd\u529b\u548c\u4f4e\u6210\u672c API \u8fdb\u884c Self-Instruct \u6570\u636e\u5408\u6210\u3002</li> <li>\u7f16\u6392\u903b\u8f91 (Python)\uff1a\u4f7f\u7528\u52a0\u6743\u8f6e\u76d8\u8d4c\uff08Weighted Roulette Wheel\uff09\u7b97\u6cd5\u5b9e\u73b0\u4efb\u52a1\u7c7b\u578b\u7684\u591a\u6837\u6027\u5e73\u8861\u3002</li> </ul>"},{"location":"chapter6/6_2_legal_sft/#3-step-by-step-implementation","title":"3. Step-by-Step \u5b9e\u6218 (Implementation)","text":""},{"location":"chapter6/6_2_legal_sft/#the-dirty-work","title":"\u9636\u6bb5\u4e00\uff1a\u6570\u636e\u83b7\u53d6\u4e0e\u667a\u80fd\u6e05\u6d17 (The Dirty Work)","text":"<p>PDF \u63d0\u53d6\u6700\u5927\u7684\u75db\u70b9\u5728\u4e8e\u683c\u5f0f\u9519\u4e71\u3002\u4ee3\u7801 <code>data_processing.py</code> \u4e2d\u7684 <code>clean_text_smart</code> \u51fd\u6570\u662f\u5904\u7406\u8fd9\u4e00\u95ee\u9898\u7684\u6838\u5fc3\u3002\u6211\u4eec\u91cd\u70b9\u89e3\u51b3\u4e86\"\u4e2d\u6587\u5047\u6027\u7a7a\u683c\"\u548c\"\u5d4c\u5165\u5f0f\u9875\u7801\"\u95ee\u9898\u3002</p> <p>\u5173\u952e\u4ee3\u7801\u903b\u8f91\uff1a</p> <pre><code>def clean_text_smart(text):\n    \"\"\"\n    \u6e05\u6d17\u6838\u5fc3\u903b\u8f91\uff1a\u4fee\u590d PDF \u89e3\u6790\u5e26\u6765\u7684\u683c\u5f0f\u635f\u4f24\n    \"\"\"\n    # 1. \u53bb\u9664\u53c2\u8003\u6587\u732e\u5f15\u7528 (\u5982 [1], [1-3])\n    text = re.sub(r'\\[\\s*\\d+(?:[-\u2013,]\\d+)*\\s*\\]', '', text)\n\n    # 2. \u53bb\u9664\u5d4c\u5728\u6587\u672c\u4e2d\u95f4\u7684\u9875\u7801 (\u5982 \"- 195 -\")\n    # \u4f7f\u7528 Lookahead \u65ad\u8a00\u9632\u6b62\u8bef\u5220\u6b63\u6587\u4e2d\u7684\u7f16\u53f7\n    text = re.sub(r'(?:^|\\s|\\n)[-\u2014\u2013\uff0d]\\s*\\d+\\s*[-\u2014\u2013\uff0d](?=\\s|\\n|$)', ' ', text)\n\n    # 3. \u4fee\u590d\u4e2d\u6587\u65ad\u8bcd (\u6838\u5fc3\u4fee\u590d)\n    # \u573a\u666f\uff1aPDF\u4e2d \"\u6cd5 \u5f8b \u89c4 \u5b9a\" \u4f1a\u88ab\u8bc6\u522b\u4e3a\u5e26\u7a7a\u683c\uff0c\u9700\u5408\u5e76\n    pattern_broken_zh = r'([\\u4e00-\\u9fa5])\\s+([\\u4e00-\\u9fa5])'\n    # \u6267\u884c\u4e24\u6b21\u4ee5\u5904\u7406\u8fde\u7eed\u65ad\u8bcd\n    text = re.sub(pattern_broken_zh, r'\\1\\2', text)\n    text = re.sub(pattern_broken_zh, r'\\1\\2', text) \n\n    return text.strip()\n</code></pre>"},{"location":"chapter6/6_2_legal_sft/#diversity-cot","title":"\u9636\u6bb5\u4e8c\uff1a\u591a\u6837\u5316\u6307\u4ee4\u5408\u6210 (Diversity &amp; CoT)","text":"<p>\u4e3a\u4e86\u907f\u514d\u6a21\u578b\u53d8\u6210\u53ea\u4f1a\u80cc\u6cd5\u6761\u7684\u4e66\u5446\u5b50\uff0c\u6211\u4eec\u5728 <code>generate_instructions.py</code> \u4e2d\u8bbe\u8ba1\u4e86\u4efb\u52a1\u6c60\uff08Task Pool\uff09\u548c\u6982\u7387\u91c7\u6837\u673a\u5236\uff0c\u5f3a\u5236\u6a21\u578b\u751f\u6210\u4e09\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u4efb\u52a1\u3002</p> <p>\u591a\u6837\u6027\u5e73\u8861\u7b56\u7565\uff1a</p> <pre><code># \u4efb\u52a1\u6743\u91cd\u914d\u7f6e (\u5b9e\u73b0\u6570\u636e\u5206\u5e03\u63a7\u5236)\nTASK_POOL = [\n    # \u4efb\u52a1A: \u590d\u6742\u6848\u60c5\u5206\u6790 (\u4fa7\u91cd\u63a8\u7406) - \u6743\u91cd 60%\n    (\"case_analysis\", PROMPT_CASE_ANALYSIS, 0_6),\n    # \u4efb\u52a1B: \u6cd5\u5f8b\u6587\u4e66\u8d77\u8349 (\u4fa7\u91cd\u751f\u6210) - \u6743\u91cd 20%\n    (\"doc_drafting\", PROMPT_DOCUMENT_DRAFTING, 0_2),\n    # \u4efb\u52a1C: \u6cd5\u5f8b\u6982\u5ff5\u8fa8\u6790 (\u4fa7\u91cd\u77e5\u8bc6) - \u6743\u91cd 20%\n    (\"concept_explain\", PROMPT_CONCEPT_EXPLAIN, 0_2)\n]\n\n# \u8f6e\u76d8\u8d4c\u9009\u62e9\u903b\u8f91\nrand = random.random()\ncumulative_prob = 0\nfor name, tpl, prob in TASK_POOL:\n    cumulative_prob += prob\n    if rand &lt;= cumulative_prob:\n        # \u547d\u4e2d\u4efb\u52a1\u7c7b\u578b\uff0c\u4f7f\u7528\u5bf9\u5e94 Prompt\n        selected_prompt_tpl = tpl\n        break\n</code></pre>"},{"location":"chapter6/6_2_legal_sft/#cot","title":"\u9636\u6bb5\u4e09\uff1a\u683c\u5f0f\u5316\u4e0e CoT \u589e\u5f3a","text":"<p>\u5728 Prompt \u4e2d\uff0c\u6211\u4eec\u660e\u786e\u8981\u6c42\u6a21\u578b\u8fd4\u56de JSON\uff0c\u5e76\u5f3a\u5236\u5305\u542b\"\u601d\u8003\u8fc7\u7a0b\"\u3002\u5728\u540e\u5904\u7406\u9636\u6bb5\uff0c\u6211\u4eec\u5c06\u9690\u5f0f\u7684\u601d\u7ef4\u94fe\u663e\u6027\u5316\uff0c\u62fc\u63a5\u6210\u6700\u7ec8\u7684\u8bad\u7ec3\u76ee\u6807\u683c\u5f0f\u3002</p> <p>CoT \u683c\u5f0f\u5316\u903b\u8f91\uff1a</p> <pre><code># \u89e3\u6790\u6a21\u578b\u8fd4\u56de\u7684 JSON\uff0c\u5f3a\u5236\u6784\u5efa\u601d\u7ef4\u94fe\u683c\u5f0f\nif isinstance(raw_output, dict):\n    thought = raw_output.get(\"\u601d\u8003\u8fc7\u7a0b\") or raw_output.get(\"analysis\")\n    answer = raw_output.get(\"\u6cd5\u5f8b\u5efa\u8bae\") or raw_output.get(\"conclusion\")\n\n    # \u5c06\u601d\u8003\u8fc7\u7a0b\u663e\u5f0f\u5199\u5165 Output\uff0c\u8bad\u7ec3\u6a21\u578b\u5b66\u4f1a\"\u5148\u60f3\u540e\u8bf4\"\n    formatted_output = f\"#### \ud83e\udde0 \u601d\u8003\u8fc7\u7a0b\\n{thought}\\n\\n#### \ud83d\udcdd \u4e13\u5bb6\u5efa\u8bae\\n{answer}\"\n</code></pre>"},{"location":"chapter6/6_2_legal_sft/#4-showcase","title":"4. \u6548\u679c\u5c55\u793a (Showcase)","text":"<p>\u7ecf\u8fc7\u5904\u7406\uff0c\u539f\u59cb\u67af\u71e5\u7684\u6cd5\u6761\u88ab\u8f6c\u5316\u4e3a\u5177\u5907\u6df1\u5ea6\u63a8\u7406\u7684\u95ee\u7b54\u5bf9\u3002\u4ee5\u4e0b\u662f <code>domain_expert.jsonl</code> \u4e2d\u7684\u5355\u6761\u6570\u636e\u6837\u672c\uff1a</p> <p>Source (\u539f\u59cb\u6cd5\u6761\u7247\u6bb5):</p> <p>...\u7b2c\u4e00\u767e\u4e94\u5341\u6761 \u4e00\u65b9\u4ee5\u6b3a\u8bc8\u624b\u6bb5\uff0c\u4f7f\u5bf9\u65b9\u5728\u8fdd\u80cc\u771f\u5b9e\u610f\u601d\u7684\u60c5\u51b5\u4e0b\u5b9e\u65bd\u7684\u6c11\u4e8b\u6cd5\u5f8b\u884c\u4e3a\uff0c\u53d7\u6b3a\u8bc8\u65b9\u6709\u6743\u8bf7\u6c42\u4eba\u6c11\u6cd5\u9662\u6216\u8005\u4ef2\u88c1\u673a\u6784\u4e88\u4ee5\u64a4\u9500...</p> <p>Generated SFT Data (JSONL Entry):</p> \u5b57\u6bb5 \u5185\u5bb9\u793a\u4f8b Instruction \u6211\u521a\u624d\u7b7e\u5408\u540c\u7684\u65f6\u5019\u88ab\u5bf9\u65b9\u9a97\u4e86\uff0c\u4ed6\u8bf4\u90a3\u4e2a\u53e4\u8463\u662f\u771f\u54c1\uff0c\u7ed3\u679c\u662f\u5047\u7684\u3002\u6211\u73b0\u5728\u8be5\u600e\u4e48\u529e\uff1f\u80fd\u76f4\u63a5\u4e0d\u8ba4\u8d26\u5417\uff1f Output #### \ud83e\udde0 \u601d\u8003\u8fc7\u7a0b1. \u5206\u6790\u6cd5\u5f8b\u5173\u7cfb\uff1a\u7528\u6237\u5728\u5bf9\u65b9\u6b3a\u8bc8\u4e0b\u7b7e\u8ba2\u4e86\u5408\u540c\uff08\u5b9e\u65bd\u6c11\u4e8b\u6cd5\u5f8b\u884c\u4e3a\uff09\u30022. \u9002\u7528\u6cd5\u6761\uff1a\u6839\u636e\u300a\u6c11\u6cd5\u5178\u300b\u7b2c\u4e00\u767e\u4e94\u5341\u6761\uff0c\u8fd9\u662f\"\u53ef\u64a4\u9500\"\u7684\u6c11\u4e8b\u6cd5\u5f8b\u884c\u4e3a\uff0c\u800c\u975e\u76f4\u63a5\"\u65e0\u6548\"\u6216\"\u4e0d\u8ba4\u8d26\"\u30023. \u64cd\u4f5c\u8def\u5f84\uff1a\u53d7\u6b3a\u8bc8\u65b9\u9700\u884c\u4f7f\u64a4\u9500\u6743\uff0c\u4e14\u5fc5\u987b\u901a\u8fc7\u6cd5\u9662\u6216\u4ef2\u88c1\u673a\u6784\u8fdb\u884c\u3002#### \ud83d\udcdd \u4e13\u5bb6\u5efa\u8bae\u60a8\u597d\uff0c\u6839\u636e\u60a8\u63cf\u8ff0\u7684\u60c5\u51b5\uff0c\u60a8\u5728\u8fdd\u80cc\u771f\u5b9e\u610f\u601d\u7684\u60c5\u51b5\u4e0b\u7b7e\u8ba2\u4e86\u5408\u540c\uff0c\u8fd9\u5c5e\u4e8e\u53ef\u64a4\u9500\u7684\u6c11\u4e8b\u6cd5\u5f8b\u884c\u4e3a\u3002\u60a8\u4e0d\u80fd\u76f4\u63a5\"\u4e0d\u8ba4\u8d26\"\u6216\u5355\u65b9\u9762\u6495\u6bc1\u5408\u540c\uff0c\u800c\u662f\u5efa\u8bae\u91c7\u53d6\u4ee5\u4e0b\u63aa\u65bd\uff1a1. \u884c\u4f7f\u64a4\u9500\u6743\uff1a\u60a8\u53ef\u4ee5\u5411\u4eba\u6c11\u6cd5\u9662\u63d0\u8d77\u8bc9\u8bbc\u6216\u5411\u4ef2\u88c1\u673a\u6784\u7533\u8bf7\u4ef2\u88c1\uff0c\u8bf7\u6c42\u64a4\u9500\u8be5\u5408\u540c\u30022. ... <p>\u6570\u636e\u5206\u5e03\u5206\u6790\uff1a - \u6848\u60c5\u5206\u6790 (60%)\uff1a\u63d0\u5347\u6a21\u578b\u5904\u7406\u590d\u6742\u903b\u8f91\u7684\u80fd\u529b\u3002 - \u6587\u4e66\u8d77\u8349 (20%)\uff1a\u63d0\u5347\u6a21\u578b\u7684\u4e13\u4e1a\u5199\u4f5c\u80fd\u529b\u3002 - \u6982\u5ff5\u89e3\u91ca (20%)\uff1a\u5de9\u56fa\u57fa\u7840\u9886\u57df\u77e5\u8bc6\u3002</p>"},{"location":"chapter6/6_2_legal_sft/#5-cost-optimization","title":"5. \u6210\u672c\u4e0e\u4f18\u5316 (Cost &amp; Optimization)","text":"<ul> <li>\u8d44\u6e90\u6d88\u8017\uff1a</li> <li>API \u6210\u672c\uff1a\u4f7f\u7528 DeepSeek-V3\uff0c\u751f\u6210 1000 \u6761\u9ad8\u8d28\u91cf CoT \u6570\u636e\u7ea6\u4e3a $0_5 - $1_0\uff08\u8f93\u5165\u8f93\u51fa token \u8f83\u957f\uff09\u3002</li> <li>\u65f6\u95f4\u6210\u672c\uff1a\u5355\u7ebf\u7a0b\u5904\u7406\u7ea6 2\u79d2/\u6761\u3002</li> <li>\u6269\u5c55\u6027\u601d\u8003\uff1a</li> <li>\u5e76\u53d1\u52a0\u901f\uff1a\u5f53\u524d\u4ee3\u7801\u4e3a\u5355\u7ebf\u7a0b\uff08<code>time.sleep</code>\uff09\uff0c\u751f\u4ea7\u73af\u5883\u5e94\u4f7f\u7528 <code>asyncio</code> + <code>Semaphore</code> \u5b9e\u73b0\u5e76\u53d1\u8bf7\u6c42\uff0c\u6548\u7387\u53ef\u63d0\u5347 10-20 \u500d\u3002</li> <li>\u8d28\u91cf\u63a7\u5236\uff1a\u76ee\u524d\u4ec5\u4f9d\u8d56 Prompt \u7ea6\u675f\uff0c\u5efa\u8bae\u589e\u52a0\u4e00\u6b65\"Reward Model \u6253\u5206\"\u6216\"\u89c4\u5219\u8fc7\u6ee4\u5668\"\uff0c\u5254\u9664\u751f\u6210\u8fc7\u77ed\u6216 JSON \u89e3\u6790\u5931\u8d25\u7684\u6837\u672c\u3002</li> </ul>"},{"location":"chapter6/6_3_llava_instruct/","title":"\u9879\u76ee\u4e09\uff1a\u6784\u5efa LLaVA \u591a\u6a21\u6001\u6307\u4ee4\u96c6","text":"<p>\u9002\u7528\u8303\u56f4\uff1a\u591a\u6a21\u6001\u5927\u6a21\u578b\uff08LMM\uff09\u5f00\u53d1\u3001\u6570\u636e\u5de5\u7a0b\u3001\u89c6\u89c9\u6307\u4ee4\u5fae\u8c03\uff08Visual Instruction Tuning\uff09</p>"},{"location":"chapter6/6_3_llava_instruct/#1-project-brief","title":"1. \u9879\u76ee\u80cc\u666f (Project Brief)","text":"<ul> <li> <p>\u4efb\u52a1\u5b9a\u4e49\uff1a   \u6784\u5efa\u4e00\u4e2a\u9ad8\u8d28\u91cf\u7684\u89c6\u89c9\u6307\u4ee4\u5fae\u8c03\u6570\u636e\u96c6\uff0c\u652f\u6301\u5355\u56fe\u95ee\u7b54\uff08Visual QA\uff09\u3001\u7269\u4f53\u5b9a\u4f4d\uff08Grounding\uff09\u4ee5\u53ca\u591a\u56fe\u4e0a\u4e0b\u6587\u63a8\u7406\uff08Interleaved Image-Text\uff09\uff0c\u7528\u4e8e\u8bad\u7ec3\u50cf LLaVA \u6216 Qwen-VL \u8fd9\u6837\u7684\u591a\u6a21\u6001\u6a21\u578b\u3002</p> </li> <li> <p>\u8f93\u5165\u4e0e\u8f93\u51fa\uff1a</p> </li> <li>Input: <ul> <li>\u539f\u59cb\u56fe\u7247\u5e93 (<code>.jpg</code> / <code>.png</code>)</li> <li>\u7ed3\u6784\u5316\u6807\u6ce8\u6570\u636e\uff08\u5982 COCO \u683c\u5f0f\u7684 <code>instances.json</code>\uff0c\u5305\u542b Bbox \u5750\u6807\uff09</li> </ul> </li> <li> <p>Output: </p> <ul> <li>\u7b26\u5408 LLaVA \u8bad\u7ec3\u6807\u51c6\u7684 JSON \u6587\u4ef6\uff08\u5305\u542b <code>image</code>, <code>conversations</code> \u5b57\u6bb5\uff09\u3002</li> <li>\u7ecf\u8fc7\u5750\u6807\u5f52\u4e00\u5316\u548c\u683c\u5f0f\u5bf9\u9f50\u7684 Grounding \u6570\u636e\u3002</li> </ul> </li> <li> <p>\u96be\u70b9\u5206\u6790\uff1a</p> </li> <li>\u5750\u6807\u7cfb\u5bf9\u9f50\uff08Coordinate Alignment\uff09\uff1a \u539f\u59cb\u68c0\u6d4b\u6570\u636e\u7684\u5750\u6807\u901a\u5e38\u662f\u50cf\u7d20\u7edd\u5bf9\u503c\uff08x, y, w, h\uff09\uff0c\u800c LLaVA \u6a21\u578b\u8981\u6c42\u5f52\u4e00\u5316\u5230 <code>[0-1000]</code> \u533a\u95f4\u4e14\u987a\u5e8f\u4e3a <code>[ymin, xmin, ymax, xmax]</code>\uff0c\u4e00\u65e6\u7b97\u9519\uff0c\u6a21\u578b\u5c06\u51fa\u73b0\u4e25\u91cd\u7684\"\u5e7b\u89c9\"\u3002</li> <li>\u591a\u56fe\u903b\u8f91\u6784\u5efa\uff1a \u4f20\u7edf\u7684 Image-Caption \u6570\u636e\u662f\u4e00\u56fe\u4e00\u6587\uff0c\u6784\u5efa\"\u591a\u56fe\u4ea4\u9519\"\u5bf9\u8bdd\u9700\u8981\u6784\u9020\u5408\u7406\u7684\u5bf9\u6bd4\u6027 Prompt\uff0c\u8bf1\u5bfc\u6a21\u578b\u7406\u89e3\u56fe\u50cf\u95f4\u7684\u5173\u8054\u3002</li> </ul>"},{"location":"chapter6/6_3_llava_instruct/#2-architecture-design","title":"2. \u67b6\u6784\u8bbe\u8ba1 (Architecture Design)","text":"<ul> <li> <p>\u6570\u636e\u6d41\u6c34\u7ebf\u56fe\uff1a </p> </li> <li> <p>\u6280\u672f\u6808\u6e05\u5355\uff1a</p> </li> <li>OpenAI Compatible API (SiliconFlow/Qwen): \u7528\u4e8e\u751f\u6210\u9ad8\u8d28\u91cf\u7684\u56fe\u6587\u63cf\u8ff0\u548c\u591a\u56fe\u5bf9\u6bd4\u903b\u8f91\uff0c\u5229\u7528\u5927\u6a21\u578b\u7684 Reasoning \u80fd\u529b\u6784\u9020\u5bf9\u8bdd\u3002</li> <li>Python &amp; OpenCV: \u6838\u5fc3\u80f6\u6c34\u8bed\u8a00\u3002OpenCV \u5fc5\u4e0d\u53ef\u5c11\uff0c\u7528\u4e8e\u8bfb\u53d6\u56fe\u50cf\u771f\u5b9e\u5c3a\u5bf8\uff08H, W\uff09\u4ee5\u8fdb\u884c\u5750\u6807\u5f52\u4e00\u5316\uff0c\u5e76\u7528\u4e8e\u53ef\u89c6\u5316\u7684\"\u753b\u6846\u9a8c\u8bc1\"\u3002</li> <li>JSON: LLaVA \u6807\u51c6\u6570\u636e\u4ea4\u6362\u683c\u5f0f\u3002</li> </ul>"},{"location":"chapter6/6_3_llava_instruct/#3-step-by-step-implementation","title":"3. Step-by-Step \u5b9e\u6218 (Implementation)","text":""},{"location":"chapter6/6_3_llava_instruct/#interleaved-data-generation","title":"\u9636\u6bb5\u4e00\uff1a\u591a\u56fe\u4ea4\u9519\u6570\u636e\u751f\u6210 (Interleaved Data Generation)","text":"<p>\u4e3a\u4e86\u8ba9\u6a21\u578b\u5b66\u4f1a\"\u5bf9\u6bd4\"\u4e24\u5f20\u56fe\u7247\uff0c\u6211\u4eec\u5229\u7528 API \u52a8\u6001\u8f93\u5165\u591a\u5f20\u56fe\u50cf\u5e76\u8bf7\u6c42\u5bf9\u6bd4\u3002</p> <p>\u5173\u952e\u903b\u8f91\uff1a \u5229\u7528 VLM API \u6784\u9020\u591a\u56fe\u8f93\u5165\u7684 Prompt\u3002</p> <pre><code># \u6458\u81ea interleaved.py\ndef generate_comparison(img1_path, img2_path):\n    # \u6784\u9020 Prompt\uff1a\u8981\u6c42\u591a\u56fe\u5bf9\u6bd4\n    prompt = \"Here are two images. Please briefly compare them...\"\n\n    # \u6784\u5efa\u591a\u56fe Payload\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": [\n                {\"type\": \"text\", \"text\": prompt},\n                {\"type\": \"image_url\", \"image_url\": {\"url\": f\"...{img1_path}...\"}}, # \u56fe1\n                {\"type\": \"image_url\", \"image_url\": {\"url\": f\"...{img2_path}...\"}}  # \u56fe2\n            ]\n        }\n    ]\n    # ... \u53d1\u9001\u8bf7\u6c42\u5e76\u89e3\u6790\u7ed3\u679c ...\n</code></pre>"},{"location":"chapter6/6_3_llava_instruct/#bounding-box-alignment","title":"\u9636\u6bb5\u4e8c\uff1a\u6838\u5fc3\u5904\u7406\u2014\u2014Bounding Box \u5bf9\u9f50 (Alignment)","text":"<p>\u8fd9\u662f\u672c\u9879\u76ee\u6700\u6838\u5fc3\u7684\u6570\u5b66\u90e8\u5206\u3002COCO \u6570\u636e\u96c6\u4f7f\u7528 <code>[x_topleft, y_topleft, width, height]</code>\uff0c\u800c LLaVA \u9700\u8981 <code>[ymin, xmin, ymax, xmax]</code> \u4e14\u6570\u503c\u9700\u5f52\u4e00\u5316\u4e3a 0-1000 \u7684\u6574\u6570\u3002</p> <p>\u5173\u952e\u51fd\u6570\uff1a \u5750\u6807\u5f52\u4e00\u5316\u8f6c\u6362</p> <pre><code># \u6458\u81ea alignment.py\ndef convert_bbox(bbox, width, height):\n    # COCO \u539f\u59cb\u8f93\u5165: x, y, w, h\n    x, y, w, h = bbox\n\n    # \u8f6c\u6362\u4e3a LLaVA \u683c\u5f0f: [ymin, xmin, ymax, xmax] \u5e76\u5f52\u4e00\u5316\u5230 0-1000\n    # \u5fc5\u987b\u4f7f\u7528 max/min \u622a\u65ad\uff0c\u9632\u6b62\u6d6e\u70b9\u8bef\u5dee\u5bfc\u81f4\u8d8a\u754c\n    xmin = int((x / width) * 1000)\n    ymin = int((y / height) * 1000)\n    xmax = int((x + w) / width * 1000)\n    ymax = int((y + h) / height * 1000)\n\n    return [\n        max(0, min(1000, ymin)),\n        max(0, min(1000, xmin)),\n        max(0, min(1000, ymax)),\n        max(0, min(1000, xmax))\n    ]\n</code></pre>"},{"location":"chapter6/6_3_llava_instruct/#verification","title":"\u9636\u6bb5\u4e09\uff1a\u683c\u5f0f\u5316\u4e0e\u9a8c\u8bc1 (Verification)","text":"<p>\u6570\u636e\u751f\u6210\u540e\uff0c\u7edd\u4e0d\u80fd\u76f4\u63a5\u9001\u5165\u8bad\u7ec3\u3002\u5fc5\u987b\u901a\u8fc7\u53ef\u89c6\u5316\u53cd\u5411\u9a8c\u8bc1\u3002\u5982\u679c\u6211\u4eec\u5728\u56fe\u7247\u4e0a\u753b\u51fa\u7684\u6846\u662f\u6b6a\u7684\uff0c\u8bad\u7ec3\u51fa\u6765\u7684\u6a21\u578b\u4e00\u5b9a\u662f\u5e9f\u7684\u3002</p> <p>\u9a8c\u8bc1\u903b\u8f91\uff1a \u89e3\u6790\u751f\u6210\u7684 JSON\uff0c\u5c06 <code>[0-1000]</code> \u5750\u6807\u8fd8\u539f\u56de\u50cf\u7d20\u5750\u6807\u5e76\u7ed8\u56fe\u3002</p> <pre><code># \u6458\u81ea visualize_bbox.py\ndef draw_bbox(image, bbox, label, color):\n    h, w, _ = image.shape\n    ymin, xmin, ymax, xmax = bbox # \u8bfb\u53d6 LLaVA \u683c\u5f0f\n\n    # \u8fd8\u539f\u4e3a\u50cf\u7d20\u5750\u6807\u7528\u4e8e\u753b\u56fe\n    x1 = int(xmin / 1000 * w)\n    y1 = int(ymin / 1000 * h)\n    x2 = int(xmax / 1000 * w)\n    y2 = int(ymax / 1000 * h)\n\n    # OpenCV \u753b\u6846\n    cv2.rectangle(image, (x1, y1), (x2, y2), color, 2)\n    # ...\n</code></pre>"},{"location":"chapter6/6_3_llava_instruct/#4-showcase","title":"4. \u6548\u679c\u5c55\u793a (Showcase)","text":"<p>1. \u6570\u636e\u7ed3\u6784\u793a\u4f8b\uff1a \u6700\u7ec8\u751f\u6210\u7684 <code>llava_instruct.json</code> \u5448\u73b0\u5982\u4e0b\u6807\u51c6\u7ed3\u6784\uff0c\u53ef\u4ee5\u76f4\u63a5\u88ab Training Pipeline \u8bfb\u53d6\uff1a</p> <pre><code>{\n  \"id\": \"1296_laptop\",\n  \"image\": \"000000001296.jpg\",\n  \"conversations\": [\n    {\n      \"from\": \"human\",\n      \"value\": \"Where is the laptop in the image? &lt;image&gt;\"\n    },\n    {\n      \"from\": \"qwen\",\n      \"value\": \"The laptop is located at [350, 201, 680, 505].\"\n    }\n  ]\n}\n</code></pre> <p>2. \u53ef\u89c6\u5316\u9a8c\u8bc1\u62a5\u544a\uff1a \u8fd0\u884c <code>visualize_bbox.py</code> \u540e\uff0c\u5728 <code>viz_debug</code> \u76ee\u5f55\u4e0b\u751f\u6210\u7684\u9a8c\u8bc1\u56fe\u3002\u5982\u679c\u6846\u7cbe\u51c6\u5730\u5957\u4f4f\u4e86\u7269\u4f53\uff08\u5982\u4e0b\u56fe\u6240\u793a\uff09\uff0c\u8bf4\u660e\u6570\u636e\u6d41\u6c34\u7ebf\u903b\u8f91\u6b63\u786e\u3002</p> <p>**\u6548\u679c\u56fe\u751f\u6210 **</p> <p></p>"},{"location":"chapter6/6_3_llava_instruct/#5-cost-optimization","title":"5. \u6210\u672c\u4e0e\u4f18\u5316 (Cost &amp; Optimization)","text":"<ul> <li>\u8d44\u6e90\u6d88\u8017\uff1a</li> <li>API \u6210\u672c\uff1a <code>interleaved.py</code> \u4f9d\u8d56\u5916\u90e8 LLM API\u3002\u751f\u6210 10,000 \u6761\u591a\u56fe\u5bf9\u6bd4\u6570\u636e\uff0c\u6309\u7167 $0_5/1M Tokens \u8ba1\u7b97\uff0c\u6210\u672c\u7ea6\u4e3a \\(20-\\)30\u3002</li> <li> <p>\u8ba1\u7b97\u8017\u65f6\uff1a <code>alignment.py</code> \u662f\u7eaf CPU \u8ba1\u7b97\uff0c\u5904\u7406 COCO \u9a8c\u8bc1\u96c6\uff085k \u5f20\u56fe\uff09\u4ec5\u9700\u6570\u79d2\u3002</p> </li> <li> <p>\u6269\u5c55\u6027\u601d\u8003\uff1a</p> </li> <li>\u5e76\u53d1\u5904\u7406\uff1a \u5f53\u5904\u7406\u767e\u4e07\u7ea7\u56fe\u50cf\uff08\u5982 Objects365\uff09\u65f6\uff0c\u5355\u7ebf\u7a0b\u8bfb\u53d6\u56fe\u7247\u83b7\u53d6 <code>(h, w)</code> \u4f1a\u6210\u4e3a\u74f6\u9888\u3002\u53ef\u4ee5\u5f15\u5165 <code>multiprocessing</code> \u5e93\uff0c\u5f00\u542f 16 \u4e2a\u8fdb\u7a0b\u5e76\u884c\u8bfb\u53d6\u548c\u8f6c\u6362\u3002</li> <li>\u8d1f\u6837\u672c\u6316\u6398\uff1a \u5f53\u524d\u4ee3\u7801\u53ea\u751f\u6210\u4e86\"\u7269\u4f53\u5728\u54ea\u91cc\"\u7684\u6b63\u6837\u672c\u3002\u4e3a\u4e86\u589e\u5f3a\u6a21\u578b\u9c81\u68d2\u6027\uff0c\u9700\u8981\u6269\u5c55\u4ee3\u7801\u751f\u6210\"\u56fe\u7247\u91cc\u6709\u5927\u8c61\u5417\uff1f-&gt; No\"\u8fd9\u7c7b\u8d1f\u6837\u672c\u6570\u636e\u3002</li> </ul>"},{"location":"chapter6/6_4_synthetic_textbook/","title":"\u9879\u76ee\u56db\uff1a\u5408\u6210\u6570\u5b66/\u4ee3\u7801\u6559\u79d1\u4e66","text":"<p>\u573a\u666f\uff1a\u63d0\u5347\u5c0f\u6a21\u578b\u7684\u903b\u8f91\u63a8\u7406\u80fd\u529b\u3002</p> <p>\u6838\u5fc3\u6280\u672f\uff1aEvol-Instruct \u8fdb\u5316\u7b56\u7565\u3001Python \u4ee3\u7801\u6267\u884c\u6c99\u7bb1 (Sandbox) \u9a8c\u8bc1\u3001PoT (Program of Thought) \u6570\u636e\u683c\u5f0f\u5316\u3002</p> <p>\u8f93\u51fa\uff1a\u7ecf\u8fc7\u9a8c\u8bc1\u7684\u9ad8\u8d28\u91cf\u5408\u6210\u63a8\u7406\u6570\u636e\u96c6\u3002</p>"},{"location":"chapter6/6_4_synthetic_textbook/#1-project-brief","title":"1. \u9879\u76ee\u80cc\u666f (Project Brief)","text":"<ul> <li>\u4efb\u52a1\u5b9a\u4e49\uff1a \u6784\u5efa\u4e00\u4e2a\u9ad8\u8d28\u91cf\u7684\"\u601d\u7ef4\u7a0b\u5e8f\"\uff08Program of Thought, PoT\uff09\u6570\u636e\u96c6\u3002\u6211\u4eec\u5c06\u5229\u7528\u5927\u6a21\u578b\uff08DeepSeek-V3\uff09\u5c06\u7b80\u5355\u7684\u6570\u5b66\u95ee\u9898\"\u8fdb\u5316\"\u4e3a\u590d\u6742\u5e94\u7528\u9898\uff0c\u5e76\u751f\u6210\u76f8\u5e94\u7684 Python \u4ee3\u7801\u89e3\u6cd5\uff0c\u6700\u540e\u901a\u8fc7\u4ee3\u7801\u6267\u884c\u6c99\u7bb1\u9a8c\u8bc1\u7b54\u6848\u7684\u6b63\u786e\u6027\u3002</li> <li>\u8f93\u5165\u4e0e\u8f93\u51fa\uff1a<ul> <li>Input: \u57fa\u7840\u6570\u5b66\u6570\u636e\u96c6\uff08\u5982 GSM8K, MBPP\uff09\u7684\u539f\u59cb JSONL \u6587\u4ef6\u3002</li> <li>Output: \u5305\u542b <code>question</code>\uff08\u8fdb\u5316\u540e\u7684\u95ee\u9898\uff09\u3001<code>thought_process</code>\uff08\u4ee3\u7801\u89e3\u9898\u601d\u8def\uff09\u3001<code>execution_output</code>\uff08\u6267\u884c\u7ed3\u679c\uff09\u7684\u6e05\u6d17\u7248 JSONL \u6570\u636e\u96c6\u3002</li> </ul> </li> <li>\u96be\u70b9\u5206\u6790\uff1a \u672c\u9879\u76ee\u6700\u5927\u7684\u96be\u70b9\u5728\u4e8e\"\u5e7b\u89c9\u6d88\u9664\"\u3002\u5927\u6a21\u578b\u751f\u6210\u7684\u4ee3\u7801\u7ecf\u5e38\u770b\u4f3c\u6b63\u786e\u4f46\u65e0\u6cd5\u8fd0\u884c\uff08\u8bed\u6cd5\u9519\u8bef\u6216\u903b\u8f91\u6f0f\u6d1e\uff09\u3002\u6211\u4eec\u9700\u8981\u6784\u5efa\u4e00\u4e2a\u81ea\u52a8\u5316\u7684\"\u6c99\u7bb1\uff08Sandbox\uff09\"\u6765\u6e05\u6d17\u6389\u65e0\u6cd5\u6267\u884c\u7684\u6837\u672c\uff0c\u786e\u4fdd\"\u6559\u79d1\u4e66\"\u7684\u4e25\u8c28\u6027\u3002</li> </ul>"},{"location":"chapter6/6_4_synthetic_textbook/#2-architecture-design","title":"2. \u67b6\u6784\u8bbe\u8ba1 (Architecture Design)","text":""},{"location":"chapter6/6_4_synthetic_textbook/#_2","title":"\u6570\u636e\u6d41\u6c34\u7ebf\u56fe","text":""},{"location":"chapter6/6_4_synthetic_textbook/#_3","title":"\u6280\u672f\u6808\u6e05\u5355","text":"<ul> <li>\u6570\u636e\u6e90 (Source): <code>HuggingFace Datasets</code> (\u83b7\u53d6 GSM8K/MBPP)\u3002</li> <li>\u751f\u6210\u5f15\u64ce (Generator): <code>DeepSeek-V3</code> (via SiliconFlow API) \u2014\u2014 \u6027\u4ef7\u6bd4\u6781\u9ad8\u7684\u4ee3\u7801\u751f\u6210\u6a21\u578b\u3002</li> <li>\u7f16\u6392\u903b\u8f91 (Orchestration): Python \u811a\u672c (Evol-Instruct \u7b56\u7565)\u3002</li> <li>\u9a8c\u8bc1\u73af\u5883 (Validator): Python <code>subprocess</code> (\u672c\u5730\u6c99\u7bb1) \u2014\u2014 \u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4f7f\u7528 Docker \u6216 MicroVM\u3002</li> </ul>"},{"location":"chapter6/6_4_synthetic_textbook/#3-step-by-step-implementation","title":"3. Step-by-Step \u5b9e\u6218 (Implementation)","text":""},{"location":"chapter6/6_4_synthetic_textbook/#seed-preparation","title":"\u9636\u6bb5\u4e00\uff1a\u79cd\u5b50\u6570\u636e\u83b7\u53d6 (Seed Preparation)","text":"<p>\u4e00\u5207\u59cb\u4e8e\u9ad8\u8d28\u91cf\u7684\u79cd\u5b50\u3002\u6211\u4eec\u4e0d\u9700\u8981\u6d77\u91cf\u6570\u636e\uff0c\u53ea\u9700\u8981\u5177\u6709\u4ee3\u8868\u6027\u7684\u903b\u8f91\u5185\u6838\u3002</p> <p>\u5173\u952e\u52a8\u4f5c\uff1a 1.  \u4e0b\u8f7d GSM8K\uff08\u6570\u5b66\uff09\u548c MBPP\uff08\u4ee3\u7801\uff09\u6570\u636e\u3002 2.  \u4ece\u4e2d\u968f\u673a\u91c7\u6837\u4f5c\u4e3a\"\u8fdb\u5316\"\u7684\u57fa\u77f3\u3002</p> <p>\u80f6\u6c34\u4ee3\u7801 (Data Sampler): \u4ee3\u7801\u5f15\u7528\u81ea <code>download_data.py</code> \u4e0e <code>sampler.py</code></p> <pre><code># \u6838\u5fc3\u903b\u8f91\uff1a\u4ece\u6d77\u91cf\u6570\u636e\u4e2d\u62bd\u53d6\u79cd\u5b50\uff0c\u53ea\u4fdd\u7559 Question \u5b57\u6bb5\n# \u539f\u59cb\u7684 Answer \u88ab\u4e22\u5f03\uff0c\u56e0\u4e3a\u6211\u4eec\u8981\u8ba9\u6a21\u578b\u91cd\u65b0\u751f\u6210\u57fa\u4e8e\u4ee3\u7801\u7684\u89e3\u7b54\nsampled = random.sample(data, SAMPLE_SIZE)\nfor entry in sampled:\n    seed_entry = {\n        \"id\": random.randint(1000, 9999), \n        \"seed_question\": entry['question'], # \u4ec5\u4fdd\u7559\u95ee\u9898\n        \"original_answer\": entry['answer']  # \u4ec5\u4f5c\u53c2\u8003\n    }\n</code></pre>"},{"location":"chapter6/6_4_synthetic_textbook/#evol-instruct-pot-evolution-generation","title":"\u9636\u6bb5\u4e8c\uff1aEvol-Instruct \u4e0e PoT \u751f\u6210 (Evolution &amp; Generation)","text":"<p>\u8fd9\u662f\u672c\u9879\u76ee\u7684\u6838\u5fc3\u3002\u6211\u4eec\u4e0d\u80fd\u53ea\u505a\u7b80\u5355\u7684\"\u95ee\u7b54\u5bf9\"\uff0c\u6211\u4eec\u9700\u8981\u8ba9\u6a21\u578b\u50cf\u4eba\u7c7b\u4e13\u5bb6\u4e00\u6837\u601d\u8003\u3002</p> <p>\u6d41\u7a0b\u903b\u8f91\uff1a 1.  Evol (\u8fdb\u5316): \u5c06\u7b80\u5355\u95ee\u9898\uff08\u5982\"1+1=?\"\uff09\u91cd\u5199\u4e3a\u590d\u6742\u573a\u666f\uff08\u5982\"\u5c0f\u660e\u67091\u4e2a\u82f9\u679c\uff0c\u53d7\u5230\u901a\u8d27\u81a8\u80c0\u5f71\u54cd...\"\uff09\uff0c\u589e\u52a0\u7ea6\u675f\u6761\u4ef6\u3002 2.  PoT (\u4ee3\u7801\u89e3\u9898): \u5f3a\u5236\u6a21\u578b\u5199 Python \u4ee3\u7801\u6765\u89e3\u51b3\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8f93\u51fa\u6587\u672c\u7b54\u6848\u3002</p> <p>\u6838\u5fc3 Prompts (Prompt Engineering): \u4ee3\u7801\u5f15\u7528\u81ea <code>evol.py</code></p> <pre><code>def get_evol_prompt(seed_question):\n    return f\"\"\"\n    \u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684\u6570\u5b66\u7ade\u8d5b\u547d\u9898\u4e13\u5bb6\u3002\u8bf7\u5c06\u4e0b\u9762\u8fd9\u4e2a\u57fa\u7840\u6570\u5b66\u95ee\u9898\u91cd\u5199\u4e3a\u4e00\u4e2a\u66f4\u590d\u6742\u3001\u903b\u8f91\u66f4\u4e25\u5bc6\u7684\u95ee\u9898\u3002\n    \u3010\u539f\u9898\u3011: {seed_question}\n    \u3010\u91cd\u5199\u8981\u6c42\u3011:\n    1. \u589e\u52a0\u7ea6\u675f\u6761\u4ef6\uff1a\u5f15\u5165\u66f4\u591a\u53d8\u91cf\u6216\u9650\u5236\u3002\n    2. \u589e\u52a0\u63a8\u7406\u6df1\u5ea6\uff1a\u4e0d\u8981\u76f4\u63a5\u7ed9\u51fa\u6570\u5b57\uff0c\u8ba9\u6570\u5b57\u4e4b\u95f4\u5b58\u5728\u903b\u8f91\u5173\u8054\u3002\n    3. \u573a\u666f\u5316\uff1a\u5c06\u62bd\u8c61\u7684\u6570\u5b57\u653e\u5165\u5177\u4f53\u7684\u7269\u7406\u6216\u5546\u4e1a\u573a\u666f\u4e2d\u3002\n    ...\n    \"\"\"\n\ndef get_pot_prompt(evolved_question):\n    return f\"\"\"\n    \u8bf7\u7f16\u5199\u4e00\u6bb5 Python \u4ee3\u7801\u6765\u89e3\u51b3\u4ee5\u4e0b\u6570\u5b66\u95ee\u9898\u3002\n    ...\n    1. \u7f16\u5199\u4e00\u4e2a\u540d\u4e3a `solve()` \u7684\u51fd\u6570\u3002\n    2. \u5728\u4ee3\u7801\u6ce8\u91ca\u4e2d\u6e05\u6670\u5730\u5199\u51fa\u63a8\u7406\u6b65\u9aa4\u3002\n    3. `solve()` \u51fd\u6570\u5fc5\u987b\u8fd4\u56de\u6700\u7ec8\u7684\u6570\u503c\u7b54\u6848\u3002\n    ...\n    \"\"\"\n</code></pre>"},{"location":"chapter6/6_4_synthetic_textbook/#sandbox-verification","title":"\u9636\u6bb5\u4e09\uff1a\u6c99\u7bb1\u9a8c\u8bc1 (Sandbox Verification)","text":"<p>\u751f\u6210\u7684\u6570\u636e\u6709\u5927\u91cf\"\u574f\u6b7b\"\u6837\u672c\uff08Syntax Error, Timeout, Loop\uff09\u3002\u5fc5\u987b\u901a\u8fc7\u6267\u884c\u9a8c\u8bc1\u3002</p> <p>\u6c99\u7bb1\u903b\u8f91\uff1a 1.  \u4f7f\u7528\u6b63\u5219\u63d0\u53d6 Markdown \u4e2d\u7684\u4ee3\u7801\u5757\u3002 2.  \u5f00\u542f\u5b50\u8fdb\u7a0b (<code>subprocess</code>) \u6267\u884c\u4ee3\u7801\u3002 3.  \u5173\u952e\uff1a \u8bbe\u7f6e <code>timeout</code> \u9632\u6b62\u6b7b\u5faa\u73af\u5361\u6b7b\u6570\u636e\u6d41\u6c34\u7ebf\u3002</p> <p>\u9a8c\u8bc1\u811a\u672c: \u4ee3\u7801\u5f15\u7528\u81ea <code>sandbox.py</code></p> <pre><code>def execute_code(code, timeout=5):\n    \"\"\"\n    \u6267\u884c Python \u4ee3\u7801\u5e76\u83b7\u53d6\u8f93\u51fa\u3002\n    \u8b66\u544a\uff1a\u6b64\u51fd\u6570\u4ec5\u5e94\u5728\u5f3a\u9694\u79bb\u6c99\u7bb1\uff08\u6700\u5c0f\u6743\u9650\u5bb9\u5668/\u5fae\u865a\u673a\u3001\u65e0\u7f51\u7edc\u3001\u53d7\u9650\u6587\u4ef6\u7cfb\u7edf\uff09\u4e2d\u8c03\u7528\u3002\n    \u4e3a\u9632\u6b62\u5728\u5bbf\u4e3b\u73af\u5883\u4e2d\u610f\u5916\u6267\u884c\u4efb\u610f\u4ee3\u7801\uff0c\u5982\u679c\u672a\u663e\u5f0f\u58f0\u660e\u5f53\u524d\u5904\u4e8e\u6c99\u7bb1\u73af\u5883\uff0c\u5c06\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\u3002\n    \u53ef\u901a\u8fc7\u5728\u6c99\u7bb1\u5bb9\u5668\u5185\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf EXECUTE_CODE_SANDBOXED=1 \u6765\u663e\u5f0f\u5141\u8bb8\u6267\u884c\u3002\n    \"\"\"\n    # \u57fa\u672c\u9632\u62a4\uff1a\u7981\u6b62\u5728\u672a\u58f0\u660e\u6c99\u7bb1\u7684\u73af\u5883\u4e2d\u6267\u884c\u4efb\u610f\u4ee3\u7801\n    if os.environ.get(\"EXECUTE_CODE_SANDBOXED\") != \"1\":\n        raise RuntimeError(\n            \"execute_code \u53ea\u80fd\u5728\u53d7\u63a7\u6c99\u7bb1\u73af\u5883\u4e2d\u4f7f\u7528\uff1b\"\n            \"\u8bf7\u5728\u9694\u79bb\u5bb9\u5668/\u5fae\u865a\u673a\u4e2d\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf EXECUTE_CODE_SANDBOXED=1 \u540e\u518d\u8c03\u7528\u3002\"\n        )\n    try:\n        # \u4f7f\u7528 subprocess \u542f\u52a8\u72ec\u7acb\u8fdb\u7a0b\n        result = subprocess.run(\n            ['python3', '-c', code],\n            capture_output=True,  # \u6355\u83b7 stdout\n            text=True,\n            timeout=timeout,      # \u5fc5\u987b\u8bbe\u7f6e\u8d85\u65f6\uff01\n            check=False,\n        )\n        if result.returncode == 0:\n            return True, result.stdout.strip()\n        else:\n            return False, f\"Error: {result.stderr.strip()}\"\n</code></pre>"},{"location":"chapter6/6_4_synthetic_textbook/#4-showcase","title":"4. \u6548\u679c\u5c55\u793a (Showcase)","text":"<p>\u7ecf\u8fc7\u6c99\u7bb1\u6e05\u6d17\u540e\uff0c\u6211\u4eec\u5f97\u5230\u4e86 <code>verified_textbook.jsonl</code>\u3002\u8fd9\u662f\u4e00\u672c\u6559\u79d1\u4e66\u7ea7\u7684\u5408\u6210\u6570\u636e\u3002</p> <p>\u6570\u636e\u6837\u672c\u5bf9\u6bd4\uff1a</p> \u9636\u6bb5 \u5185\u5bb9\u793a\u4f8b \u539f\u59cb\u79cd\u5b50 \u73cd\u59ae\u67095\u4e2a\u82f9\u679c\uff0c\u5403\u4e862\u4e2a\uff0c\u8fd8\u5269\u51e0\u4e2a\uff1f Evol \u8fdb\u5316 \u73cd\u59ae\u7ecf\u8425\u4e00\u5bb6\u6c34\u679c\u5e97\uff0c\u5e93\u5b585\u7bb1\u82f9\u679c\uff08\u6bcf\u7bb112\u4e2a\uff09\u3002\u5468\u4e00\u5979\u5356\u51fa\u4e86\u5e93\u5b58\u768440%\uff0c\u4e14\u7531\u4e8e\u5b58\u50a8\u4e0d\u5f53\u635f\u8017\u4e862\u4e2a\u5355\u54c1\u3002\u8bf7\u8ba1\u7b97\u5269\u4f59\u53ef\u552e\u5356\u7684\u82f9\u679c\u5177\u4f53\u6570\u91cf\u3002 PoT \u89e3\u6cd5 <code>def solve(): total = 5 * 12; sold = total * 0_4; ... return remaining</code> \u6267\u884c\u7ed3\u679c <code>34</code> (\u9a8c\u8bc1\u901a\u8fc7\uff0c\u5b58\u5165\u6570\u636e\u96c6) <p>\u9a8c\u8bc1\u7edf\u8ba1\uff1a \u901a\u5e38\uff0c\u7ecf\u8fc7 Evol \u540e\u7684\u4ee3\u7801\u4e00\u6b21\u901a\u8fc7\u7387\uff08Pass@1\uff09\u5728 60%-80% \u4e4b\u95f4\u3002\u88ab\u6c99\u7bb1\u5254\u9664\u7684 20% \u9519\u8bef\u6570\u636e\u6b63\u662f\u6c61\u67d3\u6a21\u578b\u8bad\u7ec3\u7684\u5143\u51f6\uff0c\u5254\u9664\u5b83\u4eec\u663e\u8457\u63d0\u5347\u4e86SFT\u540e\u7684\u6a21\u578b\u903b\u8f91\u4e00\u81f4\u6027\u3002</p>"},{"location":"chapter6/6_4_synthetic_textbook/#5-cost-optimization","title":"5. \u6210\u672c\u4e0e\u4f18\u5316 (Cost &amp; Optimization)","text":"<ul> <li> <p>\u8d44\u6e90\u6d88\u8017\uff1a</p> <ul> <li>API \u6210\u672c: \u6bcf\u6761\u6709\u6548\u6570\u636e\u6d88\u8017\u7ea6 2 \u6b21 LLM \u8c03\u7528\uff08\u8fdb\u5316+\u89e3\u9898\uff09\u3002\u4f7f\u7528 DeepSeek-V3 \u7b49\u9ad8\u6027\u4ef7\u6bd4\u6a21\u578b\uff0c\u751f\u6210 1k \u6761\u9ad8\u8d28\u91cf\u6559\u79d1\u4e66\u6570\u636e\u7684\u6210\u672c\u53ef\u63a7\u5236\u5728 $5 \u4ee5\u5185\u3002</li> <li>\u65f6\u95f4\u6210\u672c: \u672c\u5730 Python \u5355\u7ebf\u7a0b\u6267\u884c\u8f83\u6162\uff0c\u9a8c\u8bc1 1k \u6761\u4ee3\u7801\u7ea6\u9700 5-10 \u5206\u949f\u3002</li> </ul> </li> <li> <p>\u5b89\u5168\u6027\u8b66\u793a (Critical):</p> <ul> <li>\u672c\u9879\u76ee\u4f7f\u7528\u4e86 <code>subprocess</code> \u672c\u5730\u6267\u884c\u4ee3\u7801\u3002\u5728\u5904\u7406\u672a\u77e5\u6765\u6e90\u6216\u4e0d\u53ef\u4fe1\u6a21\u578b\u751f\u6210\u7684\u4ee3\u7801\u65f6\uff0c\u5b58\u5728\u6781\u9ad8\u98ce\u9669\uff08\u5982 <code>os.system('rm -rf /')</code>\uff09\u3002</li> <li>\u751f\u4ea7\u7ea7\u6539\u9020\u65b9\u6848\uff1a \u5fc5\u987b\u5c06 <code>sandbox.py</code> \u7684\u6267\u884c\u73af\u5883\u8fc1\u79fb\u81f3 Docker \u5bb9\u5668 \u6216 AWS Firecracker \u5fae\u865a\u62df\u673a\u4e2d\uff0c\u5e76\u7981\u7528\u7f51\u7edc\u8bbf\u95ee\u6743\u9650\u3002</li> </ul> </li> <li> <p>\u6269\u5c55\u6027\u601d\u8003\uff1a</p> <ul> <li>\u5982\u679c\u6570\u636e\u91cf\u6269\u5927\u5230\u767e\u4e07\u7ea7\uff0c\u5355\u673a\u811a\u672c\u5c06\u65e0\u6cd5\u652f\u6491\u3002\u9700\u8981\u5f15\u5165 <code>RabbitMQ</code> \u6216 <code>Kafka</code> \u8fdb\u884c\u4efb\u52a1\u5206\u53d1\uff0c\u6784\u5efa\u5206\u5e03\u5f0f\u7684\"\u751f\u6210-\u9a8c\u8bc1\"\u96c6\u7fa4\u3002</li> </ul> </li> </ul>"},{"location":"chapter6/6_5_mm_rag/","title":"\u9879\u76ee\u4e94\uff1a\u591a\u6a21\u6001 RAG \u4f01\u4e1a\u8d22\u62a5\u52a9\u624b","text":"<p>\u9002\u7528\u8303\u56f4\uff1aCapstone Projects - \u89e3\u51b3\u590d\u6742\u6587\u6863\uff08\u56fe\u8868\u3001\u8868\u683c\uff09\u68c0\u7d22\u96be\u9898</p>"},{"location":"chapter6/6_5_mm_rag/#1-project-brief","title":"1. \u9879\u76ee\u80cc\u666f (Project Brief)","text":"<ul> <li>\u4efb\u52a1\u5b9a\u4e49\uff1a \u6784\u5efa\u4e00\u4e2a\u80fd\u591f\"\u770b\u61c2\"\u4f01\u4e1a\u5e74\u62a5\u4e2d\u590d\u6742\u56fe\u8868\u4e0e\u6570\u636e\u8868\u683c\u7684 RAG \u7cfb\u7edf\uff0c\u901a\u8fc7\u89c6\u89c9\u68c0\u7d22\uff08Visual Retrieval\uff09\u548c\u591a\u6a21\u6001\u5927\u6a21\u578b\uff08VLM\uff09\u5b9e\u73b0\u5bf9\u8d22\u62a5\u7684\u6df1\u5ea6\u95ee\u7b54\u3002</li> <li>\u8f93\u5165\u4e0e\u8f93\u51fa\uff1a</li> <li>Input: PDF \u683c\u5f0f\u7684\u4f01\u4e1a\u5e74\u5ea6\u8d22\u52a1\u62a5\u544a\uff08\u5305\u542b\u6df7\u5408\u6392\u7248\u7684\u6587\u672c\u3001\u8de8\u9875\u8868\u683c\u3001\u8d8b\u52bf\u6298\u7ebf\u56fe\u3001\u997c\u56fe\u7b49\uff09\u3002</li> <li>Output: \u57fa\u4e8e\u56fe\u8868\u6570\u636e\u8d8b\u52bf\u548c\u5177\u4f53\u6570\u503c\u7684\u81ea\u7136\u8bed\u8a00\u5206\u6790\u56de\u7b54\u3002</li> <li>\u96be\u70b9\u5206\u6790\uff1a </li> <li>\u7ed3\u6784\u4e22\u5931\uff1a\u4f20\u7edf RAG \u4f7f\u7528 OCR \u8f6c\u6587\u5b57\uff0c\u5bb9\u6613\u4e22\u5931\u8868\u683c\u7684\u884c\u5217\u5bf9\u5e94\u5173\u7cfb\uff0c\u4e14\u5b8c\u5168\u65e0\u6cd5\u5904\u7406\u4e0d\u5e26\u6587\u5b57\u8bf4\u660e\u7684\u8d8b\u52bf\u56fe\u3002</li> <li>\u8bed\u4e49\u65ad\u5c42\uff1a\u8d22\u62a5\u4e2d\u5e38\u51fa\u73b0\"\u89c1\u4e0b\u56fe\"\u7684\u6307\u4ee3\uff0c\u6587\u672c\u4e0e\u56fe\u8868\u5206\u79bb\u5bfc\u81f4\u68c0\u7d22\u622a\u65ad\u3002</li> <li>\u68c0\u7d22\u566a\u97f3\uff1a\u76ee\u5f55\u9875\uff08Table of Contents\uff09\u5e38\u5305\u542b\u5173\u952e\u8bcd\uff0c\u5bb9\u6613\u8bef\u53ec\u56de\uff0c\u6324\u5360\u4e0a\u4e0b\u6587\u7a97\u53e3\u3002</li> </ul>"},{"location":"chapter6/6_5_mm_rag/#2-architecture-design","title":"2. \u67b6\u6784\u8bbe\u8ba1 (Architecture Design)","text":"<p>\u672c\u9879\u76ee\u7684\u6838\u5fc3\u7406\u5ff5\u662f \"ViR (Vision in Retrieval) + VLM (Vision Language Model)\"\u3002\u6211\u4eec\u4e0d\u518d\u5c06 PDF \u5f3a\u884c\u8f6c\u4e3a\u6587\u672c\uff0c\u800c\u662f\u5229\u7528 ColPali \u5c06\u6bcf\u4e00\u9875 PDF \u89c6\u4e3a\u4e00\u5f20\u56fe\u7247\u8fdb\u884c\u89c6\u89c9\u7f16\u7801\uff0c\u76f4\u63a5\u68c0\u7d22\u89c6\u89c9\u7279\u5f81\uff0c\u6700\u540e\u5c06\u547d\u4e2d\u7684\u56fe\u7247\u539f\u56fe\u5582\u7ed9\u591a\u6a21\u6001\u5927\u6a21\u578b\u8fdb\u884c\u89e3\u8bfb\u3002</p>"},{"location":"chapter6/6_5_mm_rag/#_1","title":"\u6570\u636e\u6d41\u6c34\u7ebf\u56fe","text":""},{"location":"chapter6/6_5_mm_rag/#_2","title":"\u6280\u672f\u6808\u6e05\u5355","text":"\u7ec4\u4ef6 \u5de5\u5177/\u6a21\u578b \u9009\u62e9\u7406\u7531 \u89c6\u89c9\u68c0\u7d22\u6a21\u578b ColPali (v1_2) \u5f53\u524d SOTA \u7684\u6587\u6863\u68c0\u7d22\u6a21\u578b\uff0c\u57fa\u4e8e PaliGemma\uff0c\u80fd\u7406\u89e3\u9875\u9762\u5e03\u5c40\u3001\u5b57\u4f53\u5927\u5c0f\u548c\u56fe\u8868\u89c6\u89c9\u7279\u5f81\uff0c\u65e0\u9700 OCR\u3002 \u7d22\u5f15\u6846\u67b6 Byaldi ColPali \u7684\u8f7b\u91cf\u7ea7\u5c01\u88c5\u5e93\uff0c\u7b80\u5316\u4e86\u591a\u6a21\u6001\u6a21\u578b\u7684\u5f20\u91cf\u5b58\u50a8\u548c\u68c0\u7d22\u6d41\u7a0b\u3002 \u591a\u6a21\u6001\u5927\u6a21\u578b Qwen2_5-VL-72B \u963f\u91cc\u901a\u4e49\u5343\u95ee\u6700\u65b0\u89c6\u89c9\u6a21\u578b\uff0c\u5728\u56fe\u8868\u7406\u89e3\uff08ChartQA\uff09\u548c\u6587\u6863\u89e3\u6790\uff08DocVQA\uff09\u4efb\u52a1\u4e0a\u8868\u73b0\u6781\u4f73\u3002"},{"location":"chapter6/6_5_mm_rag/#3-step-by-step-implementation","title":"3. Step-by-Step \u5b9e\u6218 (Implementation)","text":""},{"location":"chapter6/6_5_mm_rag/#visual-indexing","title":"\u9636\u6bb5\u4e00\uff1a\u89c6\u89c9\u7d22\u5f15\u6784\u5efa (Visual Indexing)","text":"<p>\u4e0d\u540c\u4e8e\u4f20\u7edf RAG \u7684 <code>Chunking -&gt; Embedding</code>\uff0c\u8fd9\u91cc\u6211\u4eec\u8fdb\u884c\u7684\u662f <code>Page -&gt; Screenshot -&gt; Visual Embedding</code>\u3002</p> <p>\u5173\u952e\u4ee3\u7801\u903b\u8f91 (<code>index.py</code>)\uff1a</p> <pre><code>from byaldi import RAGMultiModalModel\n\n# 1. \u52a0\u8f7d\u672c\u5730 ColPali \u6a21\u578b (\u89e3\u51b3 HuggingFace \u8fde\u63a5\u95ee\u9898)\nMODEL_PATH = \"/path/to/models/colpali-v1_2-merged\"\nINDEX_NAME = \"finance_report_2024\"\n\ndef build_index():\n    # 2. \u521d\u59cb\u5316\u6a21\u578b (\u652f\u6301 load_in_4bit \u964d\u4f4e\u663e\u5b58\u9700\u6c42)\n    RAG = RAGMultiModalModel.from_pretrained(MODEL_PATH, verbose=1)\n\n    # 3. \u5efa\u7acb\u7d22\u5f15\n    # \u539f\u7406\uff1aByaldi \u4f1a\u5c06 PDF \u8f6c\u4e3a\u56fe\u7247\uff0c\u8ba1\u7b97\u89c6\u89c9\u5411\u91cf\u5e76\u5b58\u50a8\n    RAG.index(\n        input_path=\"annual_report_2024.pdf\",\n        index_name=INDEX_NAME,\n        store_collection_with_index=True, # \u5fc5\u987b\u5b58\u50a8\u539f\u56fe\u5f15\u7528\n        overwrite=True\n    )\n</code></pre> <p>\u5b9e\u6218\u590d\u76d8\uff1a *   Debug: \u9996\u6b21\u8fd0\u884c\u65f6\u9047\u5230 OOM\uff08\u663e\u5b58\u6ea2\u51fa\uff09\u3002 *   Solution: ColPali \u5b8c\u6574\u7248\u9700\u8981\u7ea6 10GB+ \u663e\u5b58\u3002\u663e\u5b58\u4e0d\u8db3\u65f6\uff0c\u53ef\u5728 <code>from_pretrained</code> \u4e2d\u6dfb\u52a0 <code>load_in_4bit=True</code> \u53c2\u6570\u3002</p>"},{"location":"chapter6/6_5_mm_rag/#multi-page-retrieval","title":"\u9636\u6bb5\u4e8c\uff1a\u591a\u8def\u89c6\u89c9\u68c0\u7d22 (Multi-Page Retrieval)","text":"<p>\u8d22\u62a5\u95ee\u7b54\u7684\u4e00\u4e2a\u5178\u578b\u5751\u70b9\u662f\uff1a\u5173\u952e\u8bcd\"\u7ecf\u8425\u7ed3\u679c\"\u5728\u76ee\u5f55\u9875\u4e5f\u4f1a\u51fa\u73b0\u3002\u5982\u679c\u53ea\u68c0\u7d22 Top-1\uff0c\u5f88\u53ef\u80fd\u53ea\u62ff\u5230\u76ee\u5f55\uff0c\u5bfc\u81f4\u6a21\u578b\u65e0\u6cd5\u56de\u7b54\u3002\u56e0\u6b64\uff0c\u7b56\u7565\u4e0a\u9700\u8981\u68c0\u7d22 Top-K (\u5efa\u8bae 3-5 \u9875) \u5e76\u8fc7\u6ee4\u3002</p> <p>\u5173\u952e\u4ee3\u7801\u903b\u8f91 (<code>rag_chat.py</code> - Retrieval Part)\uff1a</p> <pre><code># \u52a0\u8f7d\u7d22\u5f15\nRAG = RAGMultiModalModel.from_index(INDEX_NAME)\n\n# \u589e\u52a0\u68c0\u7d22\u9875\u6570\uff0c\u9632\u6b62\u53ea\u547d\u4e2d\u76ee\u5f55\u9875\nRETRIEVAL_K = 4 \n\nresults = RAG.search(user_query, k=RETRIEVAL_K)\n\n# \u7ed3\u679c\u5305\u542b\uff1apage_num (\u9875\u7801), base64 (\u56fe\u7247\u6570\u636e), score (\u76f8\u5173\u6027)\n</code></pre>"},{"location":"chapter6/6_5_mm_rag/#multi-image-generation","title":"\u9636\u6bb5\u4e09\uff1a\u591a\u56fe\u4e0a\u4e0b\u6587\u751f\u6210 (Multi-Image Generation)","text":"<p>\u6211\u4eec\u5c06\u68c0\u7d22\u5230\u7684 K \u5f20\u56fe\u7247\u5168\u90e8\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u5582\u7ed9 VLM\uff0c\u5229\u7528\u6a21\u578b\u7684\u957f\u7a97\u53e3\u548c\u591a\u56fe\u5904\u7406\u80fd\u529b\u8fdb\u884c\u7efc\u5408\u5206\u6790\u3002</p> <p>\u5173\u952e\u4ee3\u7801\u903b\u8f91 (<code>rag_chat.py</code> - Generation Part)\uff1a</p> <pre><code># \u6784\u5efa\u591a\u6a21\u6001 Payload\ncontent_payload = []\n\n# 1. System Prompt: \u660e\u786e\u89d2\u8272\u4e0e\u6297\u5e72\u6270\u6307\u4ee4\ncontent_payload.append({\n    \"type\": \"text\", \n    \"text\": f\"\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684CFO\u52a9\u624b...\u5176\u4e2d\u53ef\u80fd\u5305\u542b\u76ee\u5f55\u9875\uff0c\u8bf7\u5ffd\u7565\u76ee\u5f55\uff0c\u76f4\u63a5\u6839\u636e\u5305\u542b\u5177\u4f53\u6570\u636e\u7684\u9875\u9762\u56de\u7b54\u95ee\u9898...\"\n})\n\n# 2. \u6ce8\u5165\u591a\u5f20\u56fe\u7247\nfor res in results:\n    content_payload.append({\n        \"type\": \"image_url\",\n        \"image_url\": {\n            \"url\": f\"data:image/jpeg;base64,{res.base64}\", \n            \"detail\": \"high\" # \u5f00\u542f\u9ad8\u6e05\u6a21\u5f0f\u4ee5\u8bc6\u522b\u5c0f\u5b57\n        }\n    })\n\n# 3. \u53d1\u9001\u7ed9 Qwen2_5-VL-72B\nresponse = client.chat.completions.create(\n    model=\"Qwen/Qwen2_5-VL-72B-Instruct\",\n    messages=[{\"role\": \"user\", \"content\": content_payload}],\n    temperature=0_1 # \u4fdd\u6301\u4e8b\u5b9e\u6027\n)\n</code></pre>"},{"location":"chapter6/6_5_mm_rag/#4-showcase","title":"4. \u6548\u679c\u5c55\u793a (Showcase)","text":"<p>\u4ee5\u4e0b\u662f\u7cfb\u7edf\u9488\u5bf9\u534e\u4e3a 2024 \u8d22\u62a5\u7684\u771f\u5b9e\u8fd0\u884c\u8bb0\u5f55\u3002\u53ef\u4ee5\u770b\u5230\u7cfb\u7edf\u6210\u529f\u8df3\u8fc7\u4e86\u76ee\u5f55\u9875\uff0c\u7efc\u5408\u4e86\u7b2c 49\u300191\u3001130\u30018 \u9875\u7684\u4fe1\u606f\uff0c\u5bf9\u7814\u53d1\u6295\u5165\u3001\u65e0\u5f62\u8d44\u4ea7\u53d8\u5316\u8fdb\u884c\u4e86\u91cf\u5316\u5206\u6790\u3002</p> <pre><code>&gt;&gt;&gt; \u8bf7\u63d0\u95ee: \u7ecf\u8425\u7ed3\u679c\u5982\u4f55\uff1f\n\n\ud83d\udd0d \u6b63\u5728\u68c0\u7d22 Top-4 \u4e2a\u76f8\u5173\u9875\u9762...\n\ud83d\udcc4 \u547d\u4e2d\u9875\u7801: [49] [91] [130] [8]\n\ud83d\ude80 \u6b63\u5728\u53d1\u9001\u7ed9\u5927\u6a21\u578b\u8fdb\u884c\u7efc\u5408\u5206\u6790...\n\n\ud83e\udd16 \u8d22\u62a5\u52a9\u624b\u56de\u7b54:\n----------------------------------------\n\u4ece\u63d0\u4f9b\u7684\u8d22\u62a5\u622a\u56fe\u6765\u770b\uff0c\u7ecf\u8425\u7ed3\u679c\u53ef\u4ee5\u4ece\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\u8fdb\u884c\u5206\u6790\uff1a\n\n### 1. **\u7814\u53d1\u4e0e\u521b\u65b0\u6295\u5165**\n- **\u7814\u53d1\u8d39\u7528**\uff1a2024\u5e74\uff0c\u7814\u53d1\u8d39\u7528\u652f\u51fa\u4e3a\u4eba\u6c11\u5e011,797\u4ebf\u5143\uff0c\u5360\u5168\u5e74\u6536\u5165\u768420_8%\u3002\u8fd1\u5341\u5e74\u7d2f\u8ba1\u6295\u5165\u7684\u7814\u53d1\u8d39\u7528\u8d85\u8fc7\u4eba\u6c11\u5e0112,490\u4ebf\u5143\u3002\u8fd9\u8868\u660e\u516c\u53f8\u5728\u7814\u53d1\u548c\u521b\u65b0\u65b9\u9762\u6301\u7eed\u6295\u5165\u5927\u91cf\u8d44\u6e90\uff0c\u81f4\u529b\u4e8e\u6280\u672f\u7684\u7a81\u7834\u548c\u4ea7\u54c1\u7684\u5347\u7ea7\u3002\n- **\u7814\u53d1\u4eba\u5458**\uff1a\u622a\u81f32024\u5e7412\u670831\u65e5\uff0c\u7814\u53d1\u5458\u5de5\u7ea611_3\u4e07\u540d\uff0c\u5360\u603b\u5458\u5de5\u6570\u91cf\u768454_1%\uff0c\u663e\u793a\u51fa\u516c\u53f8\u5bf9\u7814\u53d1\u56e2\u961f\u7684\u91cd\u89c6\u548c\u5bf9\u6280\u672f\u521b\u65b0\u7684\u6301\u7eed\u6295\u5165\u3002\n\n### 2. **\u65e0\u5f62\u8d44\u4ea7**\n- **\u5546\u8a89\u53ca\u65e0\u5f62\u8d44\u4ea7**\uff1a\u622a\u56fe\u663e\u793a\u4e86\u5546\u8a89\u3001\u8f6f\u4ef6\u3001\u4e13\u5229\u6743\u53ca\u7279\u8bb8\u6743\u4f7f\u7528\u8d39\u3001\u5546\u6807\u4f7f\u7528\u6743\u53ca\u5176\u4ed6\u65e0\u5f62\u8d44\u4ea7\u7684\u8be6\u7ec6\u6570\u636e\u3002\u4ece2023\u5e74\u52302024\u5e74\uff0c\u5546\u8a89\u4ece4,424\u767e\u4e07\u5143\u589e\u52a0\u52304,496\u767e\u4e07\u5143...\uff08\u4e2d\u7565\uff09...\u8fd9\u8868\u660e\u516c\u53f8\u5728\u65e0\u5f62\u8d44\u4ea7\u65b9\u9762\u6301\u7eed\u589e\u957f\u3002\n\n### 3. **\u793e\u4f1a\u8d23\u4efb\u4e0e\u53ef\u6301\u7eed\u53d1\u5c55**\n- **\u79d1\u6280\u5c0f\u5b66\u5802\u9879\u76ee**\uff1a\u534e\u4e3a\u6b63\u5f0f\u53d1\u8d77\"\u79d1\u6280\u5c0f\u5b66\u5802\"\u9879\u76ee...\uff08\u4e2d\u7565\uff09\n- **\u79fb\u52a8\u6570\u5b57\u8bfe\u5802\u9879\u76ee**\uff1a\u534e\u4e3a\u643a\u624b\u4f19\u4f34\u5728\u80af\u5c3c\u4e9a\u53d1\u8d77DigiTruck\u9879\u76ee...\n\n### 4. **\u8463\u4e8b\u957f\u81f4\u8f9e**\n- **\u6218\u7565\u805a\u7126\u4e0e\u6301\u7eed\u521b\u65b0**\uff1a\u8463\u4e8b\u957f\u5728\u81f4\u8f9e\u4e2d\u63d0\u5230\uff0c2024\u5e74\u662f\u5145\u6ee1\u6311\u6218\u7684\u4e00\u5e74\uff0c\u534e\u4e3a\u5168\u4f53\u5458\u5de5\u575a\u5b9a\u4fe1\u5fc3\u3001\u79ef\u6781\u594b\u8fdb\uff0c\u5b9e\u73b0\u4e1a\u52a1\u53d1\u5c55\u76ee\u6807\uff0c\u6574\u4f53\u7ecf\u8425\u8fbe\u5230\u9884\u671f...\n\n\u7efc\u4e0a\u6240\u8ff0\uff0c\u534e\u4e3a\u57282024\u5e74\u7684\u7ecf\u8425\u7ed3\u679c\u8868\u73b0\u51fa\u8272\uff0c\u516c\u53f8\u5728\u7814\u53d1\u4e0e\u521b\u65b0\u3001\u65e0\u5f62\u8d44\u4ea7\u3001\u793e\u4f1a\u8d23\u4efb\u4e0e\u53ef\u6301\u7eed\u53d1\u5c55\u7b49\u65b9\u9762\u5747\u53d6\u5f97\u4e86\u663e\u8457\u6210\u5c31\u3002\n----------------------------------------\n</code></pre>"},{"location":"chapter6/6_5_mm_rag/#5-cost-optimization","title":"5. \u6210\u672c\u4e0e\u4f18\u5316 (Cost &amp; Optimization)","text":"<ul> <li>\u8d44\u6e90\u6d88\u8017\uff1a</li> <li>\u7d22\u5f15\u6210\u672c\uff1aColPali \u5904\u7406\u901f\u5ea6\u8f83\u6162\uff08\u7ea6 0_5s/\u9875\uff09\uff0c\u4e00\u4efd 200 \u9875\u7684\u8d22\u62a5\u7d22\u5f15\u9700 2-3 \u5206\u949f\u3002</li> <li> <p>\u63a8\u7406\u6210\u672c\uff1a\u591a\u6a21\u6001 Token \u6d88\u8017\u5de8\u5927\u3002\u4e00\u5f20 1024x1024 \u7684\u56fe\u7247\u7ea6\u4e3a 1000-1500 tokens\u3002\u6bcf\u6b21 Top-4 \u68c0\u7d22\u610f\u5473\u7740 Input Token \u81f3\u5c11 5000+\u3002\u4f7f\u7528 SiliconFlow API \u8c03\u7528 Qwen2_5-VL-72B\uff0c\u5355\u6b21\u95ee\u7b54\u6210\u672c\u7ea6 0_05-0_1 \u5143\u4eba\u6c11\u5e01\u3002</p> </li> <li> <p>\u4f18\u5316\u601d\u8def\uff1a</p> </li> <li>\u7cbe\u5ea6\u4f18\u5316\uff1a \u5bf9\u4e8e\u8d85\u5927\u5206\u8fa8\u7387\u7684\u8d22\u52a1\u5927\u8868\uff0c\u53ef\u4ee5\u5728\u7d22\u5f15\u524d\u5bf9 PDF \u9875\u9762\u8fdb\u884c\"\u5207\u7247\uff08Cropping\uff09\"\u5904\u7406\uff0c\u5c06\u4e00\u5f20\u5927\u56fe\u5207\u6210 4 \u5f20\u5c0f\u56fe\u5206\u522b\u5efa\u7acb\u7d22\u5f15\uff0c\u63d0\u9ad8\u5c40\u90e8\u68c0\u7d22\u7684\u6e05\u6670\u5ea6\u3002</li> <li>\u56fe\u7247\u88c1\u526a\uff1aColPali \u80fd\u591f\u5b9a\u4f4d\u76f8\u5173\u533a\u57df\uff08Patch-level retrieval\uff09\uff0c\u672a\u6765\u53ef\u53ea\u5c06\u9875\u9762\u4e2d\u76f8\u5173\u7684\"\u56fe\u8868\u533a\u57df\"\u88c1\u526a\u51fa\u6765\u5582\u7ed9\u5927\u6a21\u578b\uff0c\u5927\u5e45\u964d\u4f4e Token \u6d88\u8017\u3002</li> <li>\u7f13\u5b58\u673a\u5236\uff1a\u5bf9\u4e8e\"\u8425\u6536\u591a\u5c11\"\u3001\"\u51c0\u5229\u6da6\u591a\u5c11\"\u7b49\u9ad8\u9891\u56fa\u5b9a\u95ee\u9898\uff0c\u5c06 VLM \u7684\u89e3\u6790\u7ed3\u679c\u7f13\u5b58\uff0c\u907f\u514d\u91cd\u590d\u8fdb\u884c\u89c6\u89c9\u63a8\u7406\u3002</li> </ul>"}]}